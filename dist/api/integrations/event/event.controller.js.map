{"version":3,"sources":["../../../../src/api/integrations/event/event.controller.ts"],"sourcesContent":["import { EventDto } from '@api/integrations/event/event.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { wa } from '@api/types/wa.types';\r\n\r\nexport type EmitData = {\r\n  instanceName: string;\r\n  origin: string;\r\n  event: string;\r\n  data: any;\r\n  serverUrl: string;\r\n  dateTime: string;\r\n  sender: string;\r\n  apiKey?: string;\r\n  local?: boolean;\r\n  integration?: string[];\r\n};\r\n\r\nexport interface EventControllerInterface {\r\n  set(instanceName: string, data: any): Promise<any>;\r\n  get(instanceName: string): Promise<any>;\r\n  emit({ instanceName, origin, event, data, serverUrl, dateTime, sender, apiKey, local }: EmitData): Promise<void>;\r\n}\r\n\r\nexport class EventController {\r\n  public prismaRepository: PrismaRepository;\r\n  protected waMonitor: WAMonitoringService;\r\n  private integrationStatus: boolean;\r\n  private integrationName: string;\r\n\r\n  constructor(\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n    integrationStatus: boolean,\r\n    integrationName: string,\r\n  ) {\r\n    this.prisma = prismaRepository;\r\n    this.monitor = waMonitor;\r\n    this.status = integrationStatus;\r\n    this.name = integrationName;\r\n  }\r\n\r\n  public set prisma(prisma: PrismaRepository) {\r\n    this.prismaRepository = prisma;\r\n  }\r\n\r\n  public get prisma() {\r\n    return this.prismaRepository;\r\n  }\r\n\r\n  public set monitor(waMonitor: WAMonitoringService) {\r\n    this.waMonitor = waMonitor;\r\n  }\r\n\r\n  public get monitor() {\r\n    return this.waMonitor;\r\n  }\r\n\r\n  public set name(name: string) {\r\n    this.integrationName = name;\r\n  }\r\n\r\n  public get name() {\r\n    return this.integrationName;\r\n  }\r\n\r\n  public set status(status: boolean) {\r\n    this.integrationStatus = status;\r\n  }\r\n\r\n  public get status() {\r\n    return this.integrationStatus;\r\n  }\r\n\r\n  public async set(instanceName: string, data: EventDto): Promise<wa.LocalEvent> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    if (!data[this.name]?.enabled) {\r\n      data[this.name].events = [];\r\n    } else {\r\n      if (0 === data[this.name].events.length) {\r\n        data[this.name].events = EventController.events;\r\n      }\r\n    }\r\n\r\n    return this.prisma[this.name].upsert({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n      update: {\r\n        enabled: data[this.name]?.enabled,\r\n        events: data[this.name].events,\r\n      },\r\n      create: {\r\n        enabled: data[this.name]?.enabled,\r\n        events: data[this.name].events,\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async get(instanceName: string): Promise<wa.LocalEvent> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    if (undefined === this.monitor.waInstances[instanceName]) {\r\n      return null;\r\n    }\r\n\r\n    const data = await this.prisma[this.name].findUnique({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n    });\r\n\r\n    if (!data) {\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  public static readonly events = [\r\n    'APPLICATION_STARTUP',\r\n    'QRCODE_UPDATED',\r\n    'MESSAGES_SET',\r\n    'MESSAGES_UPSERT',\r\n    'MESSAGES_EDITED',\r\n    'MESSAGES_UPDATE',\r\n    'MESSAGES_DELETE',\r\n    'SEND_MESSAGE',\r\n    'CONTACTS_SET',\r\n    'CONTACTS_UPSERT',\r\n    'CONTACTS_UPDATE',\r\n    'PRESENCE_UPDATE',\r\n    'CHATS_SET',\r\n    'CHATS_UPSERT',\r\n    'CHATS_UPDATE',\r\n    'CHATS_DELETE',\r\n    'GROUPS_UPSERT',\r\n    'GROUP_UPDATE',\r\n    'GROUP_PARTICIPANTS_UPDATE',\r\n    'CONNECTION_UPDATE',\r\n    'LABELS_EDIT',\r\n    'LABELS_ASSOCIATION',\r\n    'CALL',\r\n    'TYPEBOT_START',\r\n    'TYPEBOT_CHANGE_STATUS',\r\n    'REMOVE_INSTANCE',\r\n    'LOGOUT_INSTANCE',\r\n  ];\r\n}\r\n"],"mappings":"4ZAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,qBAAAE,IAAA,eAAAC,EAAAH,GAwBO,IAAMI,EAAN,MAAMA,CAAgB,CAM3B,YACEC,EACAC,EACAC,EACAC,EACA,CACA,KAAK,OAASH,EACd,KAAK,QAAUC,EACf,KAAK,OAASC,EACd,KAAK,KAAOC,CACd,CAEA,IAAW,OAAOC,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEA,IAAW,QAAQH,EAAgC,CACjD,KAAK,UAAYA,CACnB,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,SACd,CAEA,IAAW,KAAKI,EAAc,CAC5B,KAAK,gBAAkBA,CACzB,CAEA,IAAW,MAAO,CAChB,OAAO,KAAK,eACd,CAEA,IAAW,OAAOC,EAAiB,CACjC,KAAK,kBAAoBA,CAC3B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,iBACd,CAEA,MAAa,IAAIC,EAAsBC,EAAwC,CAC7E,GAAK,KAAK,OAIV,OAAKA,EAAK,KAAK,IAAI,GAAG,QAGVA,EAAK,KAAK,IAAI,EAAE,OAAO,SAA7B,IACFA,EAAK,KAAK,IAAI,EAAE,OAAST,EAAgB,QAH3CS,EAAK,KAAK,IAAI,EAAE,OAAS,CAAC,EAOrB,KAAK,OAAO,KAAK,IAAI,EAAE,OAAO,CACnC,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,EACA,OAAQ,CACN,QAASC,EAAK,KAAK,IAAI,GAAG,QAC1B,OAAQA,EAAK,KAAK,IAAI,EAAE,MAC1B,EACA,OAAQ,CACN,QAASA,EAAK,KAAK,IAAI,GAAG,QAC1B,OAAQA,EAAK,KAAK,IAAI,EAAE,OACxB,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,CACF,CAAC,CACH,CAEA,MAAa,IAAIA,EAA8C,CAC7D,GAAI,CAAC,KAAK,OACR,OAGF,GAAkB,KAAK,QAAQ,YAAYA,CAAY,IAAnD,OACF,OAAO,KAGT,IAAMC,EAAO,MAAM,KAAK,OAAO,KAAK,IAAI,EAAE,WAAW,CACnD,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,CACF,CAAC,EAED,OAAKC,GACI,IAIX,CA+BF,EAlIaT,EAqGY,OAAS,CAC9B,sBACA,iBACA,eACA,kBACA,kBACA,kBACA,kBACA,eACA,eACA,kBACA,kBACA,kBACA,YACA,eACA,eACA,eACA,gBACA,eACA,4BACA,oBACA,cACA,qBACA,OACA,gBACA,wBACA,kBACA,iBACF,EAjIK,IAAMF,EAANE","names":["event_controller_exports","__export","EventController","__toCommonJS","_EventController","prismaRepository","waMonitor","integrationStatus","integrationName","prisma","name","status","instanceName","data"]}