{"version":3,"sources":["../../../../../../src/api/abstract/abstract.router.ts","../../../../../../src/config/logger.config.ts","../../../../../../src/config/env.config.ts","../../../../../../src/cache/localcache.ts","../../../../../../src/cache/rediscache.ts","../../../../../../src/cache/rediscache.client.ts","../../../../../../src/cache/cacheengine.ts","../../../../../../src/config/event.config.ts","../../../../../../src/api/controllers/call.controller.ts","../../../../../../src/api/controllers/chat.controller.ts","../../../../../../src/api/controllers/group.controller.ts","../../../../../../src/api/types/wa.types.ts","../../../../../../src/api/controllers/instance.controller.ts","../../../../../../node_modules/uuid/dist/esm-node/rng.js","../../../../../../node_modules/uuid/dist/esm-node/stringify.js","../../../../../../node_modules/uuid/dist/esm-node/native.js","../../../../../../node_modules/uuid/dist/esm-node/v4.js","../../../../../../src/api/controllers/label.controller.ts","../../../../../../src/utils/makeProxyAgent.ts","../../../../../../src/api/controllers/proxy.controller.ts","../../../../../../src/api/controllers/sendMessage.controller.ts","../../../../../../src/api/controllers/settings.controller.ts","../../../../../../src/api/controllers/template.controller.ts","../../../../../../src/api/integrations/storage/s3/libs/minio.server.ts","../../../../../../src/api/integrations/chatbot/chatwoot/libs/postgres.client.ts","../../../../../../src/api/integrations/chatbot/chatwoot/utils/chatwoot-import-helper.ts","../../../../../../src/api/integrations/chatbot/chatwoot/services/chatwoot.service.ts","../../../../../../src/utils/i18n.ts","../../../../../../src/utils/sendTelemetry.ts","../../../../../../src/api/integrations/chatbot/dify/services/dify.service.ts","../../../../../../src/api/integrations/chatbot/openai/services/openai.service.ts","../../../../../../src/utils/getConversationMessage.ts","../../../../../../src/api/integrations/chatbot/typebot/services/typebot.service.ts","../../../../../../src/api/services/channel.service.ts","../../../../../../src/utils/createJid.ts","../../../../../../src/api/integrations/channel/evolution/evolution.channel.service.ts","../../../../../../src/utils/renderStatus.ts","../../../../../../src/api/integrations/channel/meta/whatsapp.business.service.ts","../../../../../../src/api/dto/chat.dto.ts","../../../../../../src/api/services/cache.service.ts","../../../../../../src/api/integrations/channel/whatsapp/whatsapp.baileys.service.ts","../../../../../../src/utils/onWhatsappCache.ts","../../../../../../src/config/path.config.ts","../../../../../../src/utils/use-multi-file-auth-state-prisma.ts","../../../../../../src/utils/use-multi-file-auth-state-provider-files.ts","../../../../../../src/utils/use-multi-file-auth-state-redis-db.ts","../../../../../../src/api/integrations/channel/whatsapp/voiceCalls/useVoiceCallsBaileys.ts","../../../../../../src/api/integrations/channel/channel.controller.ts","../../../../../../src/api/integrations/channel/evolution/evolution.controller.ts","../../../../../../src/api/integrations/channel/meta/meta.controller.ts","../../../../../../src/api/integrations/channel/whatsapp/baileys.controller.ts","../../../../../../src/utils/advancedOperatorsSearch.ts","../../../../../../src/utils/findBotByTrigger.ts","../../../../../../src/api/integrations/chatbot/chatbot.controller.ts","../../../../../../src/api/integrations/chatbot/chatwoot/controllers/chatwoot.controller.ts","../../../../../../src/api/integrations/chatbot/dify/controllers/dify.controller.ts","../../../../../../src/api/integrations/chatbot/evolutionBot/controllers/evolutionBot.controller.ts","../../../../../../src/api/integrations/chatbot/evolutionBot/services/evolutionBot.service.ts","../../../../../../src/api/integrations/chatbot/flowise/controllers/flowise.controller.ts","../../../../../../src/api/integrations/chatbot/flowise/services/flowise.service.ts","../../../../../../src/api/integrations/chatbot/openai/controllers/openai.controller.ts","../../../../../../src/api/integrations/chatbot/typebot/controllers/typebot.controller.ts","../../../../../../src/api/integrations/event/pusher/pusher.controller.ts","../../../../../../src/api/integrations/event/event.controller.ts","../../../../../../src/api/integrations/event/rabbitmq/rabbitmq.controller.ts","../../../../../../src/api/integrations/event/sqs/sqs.controller.ts","../../../../../../src/api/integrations/event/webhook/webhook.controller.ts","../../../../../../src/api/integrations/event/websocket/websocket.controller.ts","../../../../../../src/api/integrations/event/event.manager.ts","../../../../../../src/api/integrations/storage/s3/controllers/s3.controller.ts","../../../../../../src/api/integrations/storage/s3/services/s3.service.ts","../../../../../../src/api/provider/sessions.ts","../../../../../../src/api/repository/repository.service.ts","../../../../../../src/api/services/monitor.service.ts","../../../../../../src/api/services/proxy.service.ts","../../../../../../src/api/services/settings.service.ts","../../../../../../src/api/services/template.service.ts","../../../../../../src/api/server.module.ts","../../../../../../src/api/guards/auth.guard.ts","../../../../../../src/api/guards/instance.guard.ts","../../../../../../src/api/guards/telemetry.guard.ts","../../../../../../src/api/integrations/channel/channel.router.ts","../../../../../../src/api/integrations/channel/evolution/evolution.router.ts","../../../../../../src/api/integrations/channel/meta/meta.router.ts","../../../../../../src/api/integrations/chatbot/chatwoot/dto/chatwoot.dto.ts","../../../../../../src/api/integrations/event/event.dto.ts","../../../../../../src/api/integrations/integration.dto.ts","../../../../../../src/api/dto/instance.dto.ts","../../../../../../src/validate/instance.schema.ts","../../../../../../src/api/integrations/channel/whatsapp/baileys.router.ts","../../../../../../src/validate/chat.schema.ts","../../../../../../src/validate/group.schema.ts","../../../../../../src/validate/label.schema.ts","../../../../../../src/validate/message.schema.ts","../../../../../../src/validate/proxy.schema.ts","../../../../../../src/validate/settings.schema.ts","../../../../../../src/validate/template.schema.ts","../../../../../../src/api/integrations/chatbot/chatwoot/validate/chatwoot.schema.ts","../../../../../../src/api/integrations/chatbot/dify/validate/dify.schema.ts","../../../../../../src/api/integrations/chatbot/evolutionBot/validate/evolutionBot.schema.ts","../../../../../../src/api/integrations/chatbot/flowise/validate/flowise.schema.ts","../../../../../../src/api/integrations/chatbot/openai/validate/openai.schema.ts","../../../../../../src/api/integrations/chatbot/typebot/validate/typebot.schema.ts","../../../../../../src/api/integrations/event/pusher/pusher.schema.ts","../../../../../../src/api/integrations/event/webhook/webhook.schema.ts","../../../../../../src/api/integrations/event/event.schema.ts","../../../../../../src/api/integrations/chatbot/chatwoot/routes/chatwoot.router.ts","../../../../../../src/api/dto/chatbot.dto.ts","../../../../../../src/api/integrations/chatbot/dify/dto/dify.dto.ts","../../../../../../src/api/integrations/chatbot/dify/routes/dify.router.ts","../../../../../../src/api/integrations/chatbot/openai/dto/openai.dto.ts","../../../../../../src/api/integrations/chatbot/openai/routes/openai.router.ts","../../../../../../src/api/integrations/chatbot/typebot/dto/typebot.dto.ts","../../../../../../src/api/integrations/chatbot/typebot/routes/typebot.router.ts","../../../../../../src/api/integrations/chatbot/chatbot.router.ts","../../../../../../src/api/integrations/chatbot/evolutionBot/routes/evolutionBot.router.ts","../../../../../../src/api/integrations/chatbot/evolutionBot/dto/evolutionBot.dto.ts","../../../../../../src/api/integrations/chatbot/flowise/routes/flowise.router.ts","../../../../../../src/api/integrations/chatbot/flowise/dto/flowise.dto.ts","../../../../../../src/api/integrations/event/pusher/pusher.router.ts","../../../../../../src/api/integrations/event/rabbitmq/rabbitmq.router.ts","../../../../../../src/api/integrations/event/sqs/sqs.router.ts","../../../../../../src/api/integrations/event/webhook/webhook.router.ts","../../../../../../src/api/integrations/event/websocket/websocket.router.ts","../../../../../../src/api/integrations/event/event.router.ts","../../../../../../src/api/integrations/storage/storage.router.ts","../../../../../../src/api/routes/index.router.ts","../../../../../../src/api/dto/call.dto.ts","../../../../../../src/api/routes/call.router.ts","../../../../../../src/api/routes/chat.router.ts","../../../../../../src/api/dto/group.dto.ts","../../../../../../src/api/routes/group.router.ts","../../../../../../src/api/routes/instance.router.ts","../../../../../../src/api/dto/label.dto.ts","../../../../../../src/api/routes/label.router.ts","../../../../../../src/api/dto/proxy.dto.ts","../../../../../../src/api/routes/proxy.router.ts","../../../../../../src/api/dto/sendMessage.dto.ts","../../../../../../src/api/routes/sendMessage.router.ts","../../../../../../src/api/dto/settings.dto.ts","../../../../../../src/api/routes/settings.router.ts","../../../../../../src/api/dto/template.dto.ts","../../../../../../src/api/routes/template.router.ts","../../../../../../src/api/routes/view.router.ts","../../../../../../src/exceptions/400.exception.ts","../../../../../../src/exceptions/401.exception.ts","../../../../../../src/exceptions/403.exception.ts","../../../../../../src/exceptions/404.exception.ts","../../../../../../src/exceptions/500.exception.ts","../../../../../../src/api/integrations/storage/s3/dto/media.dto.ts","../../../../../../src/api/integrations/storage/s3/validate/s3.schema.ts","../../../../../../src/api/integrations/storage/s3/routes/s3.router.ts"],"sourcesContent":["import 'express-async-errors';\r\n\r\nimport { GetParticipant, GroupInvite } from '@api/dto/group.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { Request } from 'express';\r\nimport { JSONSchema7 } from 'json-schema';\r\nimport { validate } from 'jsonschema';\r\n\r\ntype DataValidate<T> = {\r\n  request: Request;\r\n  schema: JSONSchema7;\r\n  ClassRef: any;\r\n  execute: (instance: InstanceDto, data: T) => Promise<any>;\r\n};\r\n\r\nconst logger = new Logger('Validate');\r\n\r\nexport abstract class RouterBroker {\r\n  constructor() {}\r\n  public routerPath(path: string, param = true) {\r\n    let route = '/' + path;\r\n    param ? (route += '/:instanceName') : null;\r\n\r\n    return route;\r\n  }\r\n\r\n  public async dataValidate<T>(args: DataValidate<T>) {\r\n    const { request, schema, ClassRef, execute } = args;\r\n\r\n    const ref = new ClassRef();\r\n    const body = request.body;\r\n    const instance = request.params as unknown as InstanceDto;\r\n\r\n    if (request?.query && Object.keys(request.query).length > 0) {\r\n      Object.assign(instance, request.query);\r\n    }\r\n\r\n    if (request.originalUrl.includes('/instance/create')) {\r\n      Object.assign(instance, body);\r\n    }\r\n\r\n    Object.assign(ref, body);\r\n\r\n    const v = schema ? validate(ref, schema) : { valid: true, errors: [] };\r\n\r\n    if (!v.valid) {\r\n      const message: any[] = v.errors.map(({ stack, schema }) => {\r\n        let message: string;\r\n        if (schema['description']) {\r\n          message = schema['description'];\r\n        } else {\r\n          message = stack.replace('instance.', '');\r\n        }\r\n        return message;\r\n      });\r\n      logger.error(message);\r\n      throw new BadRequestException(message);\r\n    }\r\n\r\n    return await execute(instance, ref);\r\n  }\r\n\r\n  public async groupNoValidate<T>(args: DataValidate<T>) {\r\n    const { request, ClassRef, schema, execute } = args;\r\n\r\n    const instance = request.params as unknown as InstanceDto;\r\n\r\n    const ref = new ClassRef();\r\n\r\n    Object.assign(ref, request.body);\r\n\r\n    const v = validate(ref, schema);\r\n\r\n    if (!v.valid) {\r\n      const message: any[] = v.errors.map(({ property, stack, schema }) => {\r\n        let message: string;\r\n        if (schema['description']) {\r\n          message = schema['description'];\r\n        } else {\r\n          message = stack.replace('instance.', '');\r\n        }\r\n        return {\r\n          property: property.replace('instance.', ''),\r\n          message,\r\n        };\r\n      });\r\n      logger.error([...message]);\r\n      throw new BadRequestException(...message);\r\n    }\r\n\r\n    return await execute(instance, ref);\r\n  }\r\n\r\n  public async groupValidate<T>(args: DataValidate<T>) {\r\n    const { request, ClassRef, schema, execute } = args;\r\n\r\n    const instance = request.params as unknown as InstanceDto;\r\n    const body = request.body;\r\n\r\n    let groupJid = body?.groupJid;\r\n\r\n    if (!groupJid) {\r\n      if (request.query?.groupJid) {\r\n        groupJid = request.query.groupJid;\r\n      } else {\r\n        throw new BadRequestException('The group id needs to be informed in the query', 'ex: \"groupJid=120362@g.us\"');\r\n      }\r\n    }\r\n\r\n    if (!groupJid.endsWith('@g.us')) {\r\n      groupJid = groupJid + '@g.us';\r\n    }\r\n\r\n    Object.assign(body, {\r\n      groupJid: groupJid,\r\n    });\r\n\r\n    const ref = new ClassRef();\r\n\r\n    Object.assign(ref, body);\r\n\r\n    const v = validate(ref, schema);\r\n\r\n    if (!v.valid) {\r\n      const message: any[] = v.errors.map(({ property, stack, schema }) => {\r\n        let message: string;\r\n        if (schema['description']) {\r\n          message = schema['description'];\r\n        } else {\r\n          message = stack.replace('instance.', '');\r\n        }\r\n        return {\r\n          property: property.replace('instance.', ''),\r\n          message,\r\n        };\r\n      });\r\n      logger.error([...message]);\r\n      throw new BadRequestException(...message);\r\n    }\r\n\r\n    return await execute(instance, ref);\r\n  }\r\n\r\n  public async inviteCodeValidate<T>(args: DataValidate<T>) {\r\n    const { request, ClassRef, schema, execute } = args;\r\n\r\n    const inviteCode = request.query as unknown as GroupInvite;\r\n\r\n    if (!inviteCode?.inviteCode) {\r\n      throw new BadRequestException(\r\n        'The group invite code id needs to be informed in the query',\r\n        'ex: \"inviteCode=F1EX5QZxO181L3TMVP31gY\" (Obtained from group join link)',\r\n      );\r\n    }\r\n\r\n    const instance = request.params as unknown as InstanceDto;\r\n    const body = request.body;\r\n\r\n    const ref = new ClassRef();\r\n\r\n    Object.assign(body, inviteCode);\r\n    Object.assign(ref, body);\r\n\r\n    const v = validate(ref, schema);\r\n\r\n    if (!v.valid) {\r\n      const message: any[] = v.errors.map(({ property, stack, schema }) => {\r\n        let message: string;\r\n        if (schema['description']) {\r\n          message = schema['description'];\r\n        } else {\r\n          message = stack.replace('instance.', '');\r\n        }\r\n        return {\r\n          property: property.replace('instance.', ''),\r\n          message,\r\n        };\r\n      });\r\n      logger.error([...message]);\r\n      throw new BadRequestException(...message);\r\n    }\r\n\r\n    return await execute(instance, ref);\r\n  }\r\n\r\n  public async getParticipantsValidate<T>(args: DataValidate<T>) {\r\n    const { request, ClassRef, schema, execute } = args;\r\n\r\n    const getParticipants = request.query as unknown as GetParticipant;\r\n\r\n    if (!getParticipants?.getParticipants) {\r\n      throw new BadRequestException('The getParticipants needs to be informed in the query');\r\n    }\r\n\r\n    const instance = request.params as unknown as InstanceDto;\r\n    const body = request.body;\r\n\r\n    const ref = new ClassRef();\r\n\r\n    Object.assign(body, getParticipants);\r\n    Object.assign(ref, body);\r\n\r\n    const v = validate(ref, schema);\r\n\r\n    if (!v.valid) {\r\n      const message: any[] = v.errors.map(({ property, stack, schema }) => {\r\n        let message: string;\r\n        if (schema['description']) {\r\n          message = schema['description'];\r\n        } else {\r\n          message = stack.replace('instance.', '');\r\n        }\r\n        return {\r\n          property: property.replace('instance.', ''),\r\n          message,\r\n        };\r\n      });\r\n      logger.error([...message]);\r\n      throw new BadRequestException(...message);\r\n    }\r\n\r\n    return await execute(instance, ref);\r\n  }\r\n}\r\n","import dayjs from 'dayjs';\r\nimport fs from 'fs';\r\n\r\nimport { configService, Log } from './env.config';\r\nconst packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));\r\n\r\nconst formatDateLog = (timestamp: number) =>\r\n  dayjs(timestamp)\r\n    .toDate()\r\n    .toString()\r\n    .replace(/\\sGMT.+/, '');\r\n\r\nenum Color {\r\n  LOG = '\\x1b[32m',\r\n  INFO = '\\x1b[34m',\r\n  WARN = '\\x1b[33m',\r\n  ERROR = '\\x1b[31m',\r\n  DEBUG = '\\x1b[36m',\r\n  VERBOSE = '\\x1b[37m',\r\n  DARK = '\\x1b[30m',\r\n}\r\n\r\nenum Command {\r\n  RESET = '\\x1b[0m',\r\n  BRIGHT = '\\x1b[1m',\r\n  UNDERSCORE = '\\x1b[4m',\r\n}\r\n\r\nenum Level {\r\n  LOG = Color.LOG + '%s' + Command.RESET,\r\n  DARK = Color.DARK + '%s' + Command.RESET,\r\n  INFO = Color.INFO + '%s' + Command.RESET,\r\n  WARN = Color.WARN + '%s' + Command.RESET,\r\n  ERROR = Color.ERROR + '%s' + Command.RESET,\r\n  DEBUG = Color.DEBUG + '%s' + Command.RESET,\r\n  VERBOSE = Color.VERBOSE + '%s' + Command.RESET,\r\n}\r\n\r\nenum Type {\r\n  LOG = 'LOG',\r\n  WARN = 'WARN',\r\n  INFO = 'INFO',\r\n  DARK = 'DARK',\r\n  ERROR = 'ERROR',\r\n  DEBUG = 'DEBUG',\r\n  VERBOSE = 'VERBOSE',\r\n}\r\n\r\nenum Background {\r\n  LOG = '\\x1b[42m',\r\n  INFO = '\\x1b[44m',\r\n  WARN = '\\x1b[43m',\r\n  DARK = '\\x1b[40m',\r\n  ERROR = '\\x1b[41m',\r\n  DEBUG = '\\x1b[46m',\r\n  VERBOSE = '\\x1b[47m',\r\n}\r\n\r\nexport class Logger {\r\n  private readonly configService = configService;\r\n  private context: string;\r\n\r\n  constructor(context = 'Logger') {\r\n    this.context = context;\r\n  }\r\n\r\n  private instance = null;\r\n\r\n  public setContext(value: string) {\r\n    this.context = value;\r\n  }\r\n\r\n  public setInstance(value: string) {\r\n    this.instance = value;\r\n  }\r\n\r\n  private console(value: any, type: Type) {\r\n    const types: Type[] = [];\r\n\r\n    this.configService.get<Log>('LOG').LEVEL.forEach((level) => types.push(Type[level]));\r\n\r\n    const typeValue = typeof value;\r\n    if (types.includes(type)) {\r\n      if (configService.get<Log>('LOG').COLOR) {\r\n        console.log(\r\n          /*Command.UNDERSCORE +*/ Command.BRIGHT + Level[type],\r\n          '[Evolution API]',\r\n          Command.BRIGHT + Color[type],\r\n          this.instance ? `[${this.instance}]` : '',\r\n          Command.BRIGHT + Color[type],\r\n          `v${packageJson.version}`,\r\n          Command.BRIGHT + Color[type],\r\n          process.pid.toString(),\r\n          Command.RESET,\r\n          Command.BRIGHT + Color[type],\r\n          '-',\r\n          Command.BRIGHT + Color.VERBOSE,\r\n          `${formatDateLog(Date.now())}  `,\r\n          Command.RESET,\r\n          Color[type] + Background[type] + Command.BRIGHT,\r\n          `${type} ` + Command.RESET,\r\n          Color.WARN + Command.BRIGHT,\r\n          `[${this.context}]` + Command.RESET,\r\n          Color[type] + Command.BRIGHT,\r\n          `[${typeValue}]` + Command.RESET,\r\n          Color[type],\r\n          typeValue !== 'object' ? value : '',\r\n          Command.RESET,\r\n        );\r\n        typeValue === 'object' ? console.log(/*Level.DARK,*/ value, '\\n') : '';\r\n      } else {\r\n        console.log(\r\n          '[Evolution API]',\r\n          this.instance ? `[${this.instance}]` : '',\r\n          process.pid.toString(),\r\n          '-',\r\n          `${formatDateLog(Date.now())}  `,\r\n          `${type} `,\r\n          `[${this.context}]`,\r\n          `[${typeValue}]`,\r\n          value,\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public log(value: any) {\r\n    this.console(value, Type.LOG);\r\n  }\r\n\r\n  public info(value: any) {\r\n    this.console(value, Type.INFO);\r\n  }\r\n\r\n  public warn(value: any) {\r\n    this.console(value, Type.WARN);\r\n  }\r\n\r\n  public error(value: any) {\r\n    this.console(value, Type.ERROR);\r\n  }\r\n\r\n  public verbose(value: any) {\r\n    this.console(value, Type.VERBOSE);\r\n  }\r\n\r\n  public debug(value: any) {\r\n    this.console(value, Type.DEBUG);\r\n  }\r\n\r\n  public dark(value: any) {\r\n    this.console(value, Type.DARK);\r\n  }\r\n}\r\n","import { isBooleanString } from 'class-validator';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\nexport type HttpServer = {\r\n  TYPE: 'http' | 'https';\r\n  PORT: number;\r\n  URL: string;\r\n  DISABLE_DOCS: boolean;\r\n  DISABLE_MANAGER: boolean;\r\n};\r\n\r\nexport type HttpMethods = 'POST' | 'GET' | 'PUT' | 'DELETE';\r\nexport type Cors = {\r\n  ORIGIN: string[];\r\n  METHODS: HttpMethods[];\r\n  CREDENTIALS: boolean;\r\n};\r\n\r\nexport type LogBaileys = 'fatal' | 'error' | 'warn' | 'info' | 'debug' | 'trace';\r\n\r\nexport type LogLevel = 'ERROR' | 'WARN' | 'DEBUG' | 'INFO' | 'LOG' | 'VERBOSE' | 'DARK' | 'WEBHOOKS' | 'WEBSOCKET';\r\n\r\nexport type Log = {\r\n  LEVEL: LogLevel[];\r\n  COLOR: boolean;\r\n  BAILEYS: LogBaileys;\r\n};\r\n\r\nexport type ProviderSession = {\r\n  ENABLED: boolean;\r\n  HOST: string;\r\n  PORT: string;\r\n  PREFIX: string;\r\n};\r\n\r\nexport type SaveData = {\r\n  INSTANCE: boolean;\r\n  HISTORIC: boolean;\r\n  NEW_MESSAGE: boolean;\r\n  MESSAGE_UPDATE: boolean;\r\n  CONTACTS: boolean;\r\n  CHATS: boolean;\r\n  LABELS: boolean;\r\n  IS_ON_WHATSAPP: boolean;\r\n  IS_ON_WHATSAPP_DAYS: number;\r\n};\r\n\r\nexport type DBConnection = {\r\n  URI: string;\r\n  CLIENT_NAME: string;\r\n};\r\nexport type Database = {\r\n  CONNECTION: DBConnection;\r\n  PROVIDER: string;\r\n  SAVE_DATA: SaveData;\r\n  DELETE_DATA: DeleteData;\r\n};\r\n\r\nexport type DeleteData = {\r\n  LOGICAL_MESSAGE_DELETE: boolean;\r\n};\r\nexport type EventsRabbitmq = {\r\n  APPLICATION_STARTUP: boolean;\r\n  INSTANCE_CREATE: boolean;\r\n  INSTANCE_DELETE: boolean;\r\n  QRCODE_UPDATED: boolean;\r\n  MESSAGES_SET: boolean;\r\n  MESSAGES_UPSERT: boolean;\r\n  MESSAGES_EDITED: boolean;\r\n  MESSAGES_UPDATE: boolean;\r\n  MESSAGES_DELETE: boolean;\r\n  SEND_MESSAGE: boolean;\r\n  CONTACTS_SET: boolean;\r\n  CONTACTS_UPDATE: boolean;\r\n  CONTACTS_UPSERT: boolean;\r\n  PRESENCE_UPDATE: boolean;\r\n  CHATS_SET: boolean;\r\n  CHATS_UPDATE: boolean;\r\n  CHATS_DELETE: boolean;\r\n  CHATS_UPSERT: boolean;\r\n  CONNECTION_UPDATE: boolean;\r\n  LABELS_EDIT: boolean;\r\n  LABELS_ASSOCIATION: boolean;\r\n  GROUPS_UPSERT: boolean;\r\n  GROUP_UPDATE: boolean;\r\n  GROUP_PARTICIPANTS_UPDATE: boolean;\r\n  CALL: boolean;\r\n  TYPEBOT_START: boolean;\r\n  TYPEBOT_CHANGE_STATUS: boolean;\r\n};\r\n\r\nexport type Rabbitmq = {\r\n  ENABLED: boolean;\r\n  URI: string;\r\n  EXCHANGE_NAME: string;\r\n  GLOBAL_ENABLED: boolean;\r\n  EVENTS: EventsRabbitmq;\r\n  PREFIX_KEY: string;\r\n};\r\n\r\nexport type Sqs = {\r\n  ENABLED: boolean;\r\n  ACCESS_KEY_ID: string;\r\n  SECRET_ACCESS_KEY: string;\r\n  ACCOUNT_ID: string;\r\n  REGION: string;\r\n};\r\n\r\nexport type Websocket = {\r\n  ENABLED: boolean;\r\n  GLOBAL_EVENTS: boolean;\r\n};\r\n\r\nexport type WaBusiness = {\r\n  TOKEN_WEBHOOK: string;\r\n  URL: string;\r\n  VERSION: string;\r\n  LANGUAGE: string;\r\n};\r\n\r\nexport type EventsWebhook = {\r\n  APPLICATION_STARTUP: boolean;\r\n  INSTANCE_CREATE: boolean;\r\n  INSTANCE_DELETE: boolean;\r\n  QRCODE_UPDATED: boolean;\r\n  MESSAGES_SET: boolean;\r\n  MESSAGES_UPSERT: boolean;\r\n  MESSAGES_EDITED: boolean;\r\n  MESSAGES_UPDATE: boolean;\r\n  MESSAGES_DELETE: boolean;\r\n  SEND_MESSAGE: boolean;\r\n  CONTACTS_SET: boolean;\r\n  CONTACTS_UPDATE: boolean;\r\n  CONTACTS_UPSERT: boolean;\r\n  PRESENCE_UPDATE: boolean;\r\n  CHATS_SET: boolean;\r\n  CHATS_UPDATE: boolean;\r\n  CHATS_DELETE: boolean;\r\n  CHATS_UPSERT: boolean;\r\n  CONNECTION_UPDATE: boolean;\r\n  LABELS_EDIT: boolean;\r\n  LABELS_ASSOCIATION: boolean;\r\n  GROUPS_UPSERT: boolean;\r\n  GROUP_UPDATE: boolean;\r\n  GROUP_PARTICIPANTS_UPDATE: boolean;\r\n  CALL: boolean;\r\n  TYPEBOT_START: boolean;\r\n  TYPEBOT_CHANGE_STATUS: boolean;\r\n  ERRORS: boolean;\r\n  ERRORS_WEBHOOK: string;\r\n};\r\n\r\nexport type EventsPusher = {\r\n  APPLICATION_STARTUP: boolean;\r\n  INSTANCE_CREATE: boolean;\r\n  INSTANCE_DELETE: boolean;\r\n  QRCODE_UPDATED: boolean;\r\n  MESSAGES_SET: boolean;\r\n  MESSAGES_UPSERT: boolean;\r\n  MESSAGES_EDITED: boolean;\r\n  MESSAGES_UPDATE: boolean;\r\n  MESSAGES_DELETE: boolean;\r\n  SEND_MESSAGE: boolean;\r\n  CONTACTS_SET: boolean;\r\n  CONTACTS_UPDATE: boolean;\r\n  CONTACTS_UPSERT: boolean;\r\n  PRESENCE_UPDATE: boolean;\r\n  CHATS_SET: boolean;\r\n  CHATS_UPDATE: boolean;\r\n  CHATS_DELETE: boolean;\r\n  CHATS_UPSERT: boolean;\r\n  CONNECTION_UPDATE: boolean;\r\n  LABELS_EDIT: boolean;\r\n  LABELS_ASSOCIATION: boolean;\r\n  GROUPS_UPSERT: boolean;\r\n  GROUP_UPDATE: boolean;\r\n  GROUP_PARTICIPANTS_UPDATE: boolean;\r\n  CALL: boolean;\r\n  TYPEBOT_START: boolean;\r\n  TYPEBOT_CHANGE_STATUS: boolean;\r\n};\r\n\r\nexport type ApiKey = { KEY: string };\r\n\r\nexport type Auth = {\r\n  API_KEY: ApiKey;\r\n  EXPOSE_IN_FETCH_INSTANCES: boolean;\r\n};\r\n\r\nexport type DelInstance = number | boolean;\r\n\r\nexport type Language = string | 'en';\r\n\r\nexport type GlobalWebhook = {\r\n  URL: string;\r\n  ENABLED: boolean;\r\n  WEBHOOK_BY_EVENTS: boolean;\r\n};\r\n\r\nexport type GlobalPusher = {\r\n  ENABLED: boolean;\r\n  APP_ID: string;\r\n  KEY: string;\r\n  SECRET: string;\r\n  CLUSTER: string;\r\n  USE_TLS: boolean;\r\n};\r\n\r\nexport type CacheConfRedis = {\r\n  ENABLED: boolean;\r\n  URI: string;\r\n  PREFIX_KEY: string;\r\n  TTL: number;\r\n  SAVE_INSTANCES: boolean;\r\n};\r\nexport type CacheConfLocal = {\r\n  ENABLED: boolean;\r\n  TTL: number;\r\n};\r\nexport type SslConf = { PRIVKEY: string; FULLCHAIN: string };\r\nexport type Webhook = { GLOBAL?: GlobalWebhook; EVENTS: EventsWebhook };\r\nexport type Pusher = { ENABLED: boolean; GLOBAL?: GlobalPusher; EVENTS: EventsPusher };\r\nexport type ConfigSessionPhone = { CLIENT: string; NAME: string; VERSION: string };\r\nexport type QrCode = { LIMIT: number; COLOR: string };\r\nexport type Typebot = { ENABLED: boolean; API_VERSION: string; SEND_MEDIA_BASE64: boolean };\r\nexport type Chatwoot = {\r\n  ENABLED: boolean;\r\n  MESSAGE_DELETE: boolean;\r\n  MESSAGE_READ: boolean;\r\n  BOT_CONTACT: boolean;\r\n  IMPORT: {\r\n    DATABASE: {\r\n      CONNECTION: {\r\n        URI: string;\r\n      };\r\n    };\r\n    PLACEHOLDER_MEDIA_MESSAGE: boolean;\r\n  };\r\n};\r\nexport type Openai = { ENABLED: boolean; API_KEY_GLOBAL?: string };\r\nexport type Dify = { ENABLED: boolean };\r\n\r\nexport type S3 = {\r\n  ACCESS_KEY: string;\r\n  SECRET_KEY: string;\r\n  ENDPOINT: string;\r\n  BUCKET_NAME: string;\r\n  ENABLE: boolean;\r\n  PORT?: number;\r\n  USE_SSL?: boolean;\r\n  REGION?: string;\r\n};\r\n\r\nexport type CacheConf = { REDIS: CacheConfRedis; LOCAL: CacheConfLocal };\r\nexport type Production = boolean;\r\n\r\nexport interface Env {\r\n  SERVER: HttpServer;\r\n  CORS: Cors;\r\n  SSL_CONF: SslConf;\r\n  PROVIDER: ProviderSession;\r\n  DATABASE: Database;\r\n  RABBITMQ: Rabbitmq;\r\n  SQS: Sqs;\r\n  WEBSOCKET: Websocket;\r\n  WA_BUSINESS: WaBusiness;\r\n  LOG: Log;\r\n  DEL_INSTANCE: DelInstance;\r\n  DEL_TEMP_INSTANCES: boolean;\r\n  LANGUAGE: Language;\r\n  WEBHOOK: Webhook;\r\n  PUSHER: Pusher;\r\n  CONFIG_SESSION_PHONE: ConfigSessionPhone;\r\n  QRCODE: QrCode;\r\n  TYPEBOT: Typebot;\r\n  CHATWOOT: Chatwoot;\r\n  OPENAI: Openai;\r\n  DIFY: Dify;\r\n  CACHE: CacheConf;\r\n  S3?: S3;\r\n  AUTHENTICATION: Auth;\r\n  PRODUCTION?: Production;\r\n}\r\n\r\nexport type Key = keyof Env;\r\n\r\nexport class ConfigService {\r\n  constructor() {\r\n    this.loadEnv();\r\n  }\r\n\r\n  private env: Env;\r\n\r\n  public get<T = any>(key: Key) {\r\n    return this.env[key] as T;\r\n  }\r\n\r\n  private loadEnv() {\r\n    this.env = this.envProcess();\r\n    this.env.PRODUCTION = process.env?.NODE_ENV === 'PROD';\r\n    if (process.env?.DOCKER_ENV === 'true') {\r\n      this.env.SERVER.TYPE = process.env.SERVER_TYPE as 'http' | 'http';\r\n      this.env.SERVER.PORT = Number.parseInt(process.env.SERVER_PORT) || 8080;\r\n    }\r\n  }\r\n\r\n  private envProcess(): Env {\r\n    return {\r\n      SERVER: {\r\n        TYPE: (process.env.SERVER_TYPE as 'http' | 'https') || 'http',\r\n        PORT: Number.parseInt(process.env.SERVER_PORT) || 8080,\r\n        URL: process.env.SERVER_URL,\r\n        DISABLE_DOCS: process.env?.SERVER_DISABLE_DOCS === 'true',\r\n        DISABLE_MANAGER: process.env?.SERVER_DISABLE_MANAGER === 'true',\r\n      },\r\n      CORS: {\r\n        ORIGIN: process.env.CORS_ORIGIN?.split(',') || ['*'],\r\n        METHODS:\r\n          (process.env.CORS_METHODS?.split(',') as HttpMethods[]) ||\r\n          (['POST', 'GET', 'PUT', 'DELETE'] as HttpMethods[]),\r\n        CREDENTIALS: process.env?.CORS_CREDENTIALS === 'true',\r\n      },\r\n      SSL_CONF: {\r\n        PRIVKEY: process.env?.SSL_CONF_PRIVKEY || '',\r\n        FULLCHAIN: process.env?.SSL_CONF_FULLCHAIN || '',\r\n      },\r\n      PROVIDER: {\r\n        ENABLED: process.env?.PROVIDER_ENABLED === 'true',\r\n        HOST: process.env.PROVIDER_HOST,\r\n        PORT: process.env?.PROVIDER_PORT || '5656',\r\n        PREFIX: process.env?.PROVIDER_PREFIX || 'evolution',\r\n      },\r\n      DATABASE: {\r\n        CONNECTION: {\r\n          URI: process.env.DATABASE_CONNECTION_URI || '',\r\n          CLIENT_NAME: process.env.DATABASE_CONNECTION_CLIENT_NAME || 'evolution',\r\n        },\r\n        PROVIDER: process.env.DATABASE_PROVIDER || 'postgresql',\r\n        SAVE_DATA: {\r\n          INSTANCE: process.env?.DATABASE_SAVE_DATA_INSTANCE === 'true',\r\n          NEW_MESSAGE: process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE === 'true',\r\n          MESSAGE_UPDATE: process.env?.DATABASE_SAVE_MESSAGE_UPDATE === 'true',\r\n          CONTACTS: process.env?.DATABASE_SAVE_DATA_CONTACTS === 'true',\r\n          CHATS: process.env?.DATABASE_SAVE_DATA_CHATS === 'true',\r\n          HISTORIC: process.env?.DATABASE_SAVE_DATA_HISTORIC === 'true',\r\n          LABELS: process.env?.DATABASE_SAVE_DATA_LABELS === 'true',\r\n          IS_ON_WHATSAPP: process.env?.DATABASE_SAVE_IS_ON_WHATSAPP === 'true',\r\n          IS_ON_WHATSAPP_DAYS: Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS ?? '7'),\r\n        },\r\n        DELETE_DATA: {\r\n          LOGICAL_MESSAGE_DELETE: process.env?.DATABASE_DELETE_MESSAGE === 'true',\r\n        },\r\n      },\r\n      RABBITMQ: {\r\n        ENABLED: process.env?.RABBITMQ_ENABLED === 'true',\r\n        GLOBAL_ENABLED: process.env?.RABBITMQ_GLOBAL_ENABLED === 'true',\r\n        PREFIX_KEY: process.env?.RABBITMQ_PREFIX_KEY || 'evolution',\r\n        EXCHANGE_NAME: process.env?.RABBITMQ_EXCHANGE_NAME || 'evolution_exchange',\r\n        URI: process.env.RABBITMQ_URI || '',\r\n        EVENTS: {\r\n          APPLICATION_STARTUP: process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP === 'true',\r\n          INSTANCE_CREATE: process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE === 'true',\r\n          INSTANCE_DELETE: process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE === 'true',\r\n          QRCODE_UPDATED: process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED === 'true',\r\n          MESSAGES_SET: process.env?.RABBITMQ_EVENTS_MESSAGES_SET === 'true',\r\n          MESSAGES_UPSERT: process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT === 'true',\r\n          MESSAGES_EDITED: process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED === 'true',\r\n          MESSAGES_UPDATE: process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE === 'true',\r\n          MESSAGES_DELETE: process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE === 'true',\r\n          SEND_MESSAGE: process.env?.RABBITMQ_EVENTS_SEND_MESSAGE === 'true',\r\n          CONTACTS_SET: process.env?.RABBITMQ_EVENTS_CONTACTS_SET === 'true',\r\n          CONTACTS_UPDATE: process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE === 'true',\r\n          CONTACTS_UPSERT: process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT === 'true',\r\n          PRESENCE_UPDATE: process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE === 'true',\r\n          CHATS_SET: process.env?.RABBITMQ_EVENTS_CHATS_SET === 'true',\r\n          CHATS_UPDATE: process.env?.RABBITMQ_EVENTS_CHATS_UPDATE === 'true',\r\n          CHATS_UPSERT: process.env?.RABBITMQ_EVENTS_CHATS_UPSERT === 'true',\r\n          CHATS_DELETE: process.env?.RABBITMQ_EVENTS_CHATS_DELETE === 'true',\r\n          CONNECTION_UPDATE: process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE === 'true',\r\n          LABELS_EDIT: process.env?.RABBITMQ_EVENTS_LABELS_EDIT === 'true',\r\n          LABELS_ASSOCIATION: process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION === 'true',\r\n          GROUPS_UPSERT: process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT === 'true',\r\n          GROUP_UPDATE: process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE === 'true',\r\n          GROUP_PARTICIPANTS_UPDATE: process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\r\n          CALL: process.env?.RABBITMQ_EVENTS_CALL === 'true',\r\n          TYPEBOT_START: process.env?.RABBITMQ_EVENTS_TYPEBOT_START === 'true',\r\n          TYPEBOT_CHANGE_STATUS: process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\r\n        },\r\n      },\r\n      SQS: {\r\n        ENABLED: process.env?.SQS_ENABLED === 'true',\r\n        ACCESS_KEY_ID: process.env.SQS_ACCESS_KEY_ID || '',\r\n        SECRET_ACCESS_KEY: process.env.SQS_SECRET_ACCESS_KEY || '',\r\n        ACCOUNT_ID: process.env.SQS_ACCOUNT_ID || '',\r\n        REGION: process.env.SQS_REGION || '',\r\n      },\r\n      WEBSOCKET: {\r\n        ENABLED: process.env?.WEBSOCKET_ENABLED === 'true',\r\n        GLOBAL_EVENTS: process.env?.WEBSOCKET_GLOBAL_EVENTS === 'true',\r\n      },\r\n      PUSHER: {\r\n        ENABLED: process.env?.PUSHER_ENABLED === 'true',\r\n        GLOBAL: {\r\n          ENABLED: process.env?.PUSHER_GLOBAL_ENABLED === 'true',\r\n          APP_ID: process.env?.PUSHER_GLOBAL_APP_ID || '',\r\n          KEY: process.env?.PUSHER_GLOBAL_KEY || '',\r\n          SECRET: process.env?.PUSHER_GLOBAL_SECRET || '',\r\n          CLUSTER: process.env?.PUSHER_GLOBAL_CLUSTER || '',\r\n          USE_TLS: process.env?.PUSHER_GLOBAL_USE_TLS === 'true',\r\n        },\r\n        EVENTS: {\r\n          APPLICATION_STARTUP: process.env?.PUSHER_EVENTS_APPLICATION_STARTUP === 'true',\r\n          INSTANCE_CREATE: process.env?.PUSHER_EVENTS_INSTANCE_CREATE === 'true',\r\n          INSTANCE_DELETE: process.env?.PUSHER_EVENTS_INSTANCE_DELETE === 'true',\r\n          QRCODE_UPDATED: process.env?.PUSHER_EVENTS_QRCODE_UPDATED === 'true',\r\n          MESSAGES_SET: process.env?.PUSHER_EVENTS_MESSAGES_SET === 'true',\r\n          MESSAGES_UPSERT: process.env?.PUSHER_EVENTS_MESSAGES_UPSERT === 'true',\r\n          MESSAGES_EDITED: process.env?.PUSHER_EVENTS_MESSAGES_EDITED === 'true',\r\n          MESSAGES_UPDATE: process.env?.PUSHER_EVENTS_MESSAGES_UPDATE === 'true',\r\n          MESSAGES_DELETE: process.env?.PUSHER_EVENTS_MESSAGES_DELETE === 'true',\r\n          SEND_MESSAGE: process.env?.PUSHER_EVENTS_SEND_MESSAGE === 'true',\r\n          CONTACTS_SET: process.env?.PUSHER_EVENTS_CONTACTS_SET === 'true',\r\n          CONTACTS_UPDATE: process.env?.PUSHER_EVENTS_CONTACTS_UPDATE === 'true',\r\n          CONTACTS_UPSERT: process.env?.PUSHER_EVENTS_CONTACTS_UPSERT === 'true',\r\n          PRESENCE_UPDATE: process.env?.PUSHER_EVENTS_PRESENCE_UPDATE === 'true',\r\n          CHATS_SET: process.env?.PUSHER_EVENTS_CHATS_SET === 'true',\r\n          CHATS_UPDATE: process.env?.PUSHER_EVENTS_CHATS_UPDATE === 'true',\r\n          CHATS_UPSERT: process.env?.PUSHER_EVENTS_CHATS_UPSERT === 'true',\r\n          CHATS_DELETE: process.env?.PUSHER_EVENTS_CHATS_DELETE === 'true',\r\n          CONNECTION_UPDATE: process.env?.PUSHER_EVENTS_CONNECTION_UPDATE === 'true',\r\n          LABELS_EDIT: process.env?.PUSHER_EVENTS_LABELS_EDIT === 'true',\r\n          LABELS_ASSOCIATION: process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION === 'true',\r\n          GROUPS_UPSERT: process.env?.PUSHER_EVENTS_GROUPS_UPSERT === 'true',\r\n          GROUP_UPDATE: process.env?.PUSHER_EVENTS_GROUPS_UPDATE === 'true',\r\n          GROUP_PARTICIPANTS_UPDATE: process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\r\n          CALL: process.env?.PUSHER_EVENTS_CALL === 'true',\r\n          TYPEBOT_START: process.env?.PUSHER_EVENTS_TYPEBOT_START === 'true',\r\n          TYPEBOT_CHANGE_STATUS: process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\r\n        },\r\n      },\r\n      WA_BUSINESS: {\r\n        TOKEN_WEBHOOK: process.env.WA_BUSINESS_TOKEN_WEBHOOK || 'evolution',\r\n        URL: process.env.WA_BUSINESS_URL || 'https://graph.facebook.com',\r\n        VERSION: process.env.WA_BUSINESS_VERSION || 'v18.0',\r\n        LANGUAGE: process.env.WA_BUSINESS_LANGUAGE || 'en',\r\n      },\r\n      LOG: {\r\n        LEVEL:\r\n          (process.env?.LOG_LEVEL?.split(',') as LogLevel[]) ||\r\n          (['ERROR', 'WARN', 'DEBUG', 'INFO', 'LOG', 'VERBOSE', 'DARK', 'WEBHOOKS', 'WEBSOCKET'] as LogLevel[]),\r\n        COLOR: process.env?.LOG_COLOR === 'true',\r\n        BAILEYS: (process.env?.LOG_BAILEYS as LogBaileys) || 'error',\r\n      },\r\n      DEL_INSTANCE: isBooleanString(process.env?.DEL_INSTANCE)\r\n        ? process.env.DEL_INSTANCE === 'true'\r\n        : Number.parseInt(process.env.DEL_INSTANCE) || false,\r\n      DEL_TEMP_INSTANCES: isBooleanString(process.env?.DEL_TEMP_INSTANCES)\r\n        ? process.env.DEL_TEMP_INSTANCES === 'true'\r\n        : true,\r\n      LANGUAGE: process.env?.LANGUAGE || 'en',\r\n      WEBHOOK: {\r\n        GLOBAL: {\r\n          URL: process.env?.WEBHOOK_GLOBAL_URL || '',\r\n          ENABLED: process.env?.WEBHOOK_GLOBAL_ENABLED === 'true',\r\n          WEBHOOK_BY_EVENTS: process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS === 'true',\r\n        },\r\n        EVENTS: {\r\n          APPLICATION_STARTUP: process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP === 'true',\r\n          INSTANCE_CREATE: process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE === 'true',\r\n          INSTANCE_DELETE: process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE === 'true',\r\n          QRCODE_UPDATED: process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED === 'true',\r\n          MESSAGES_SET: process.env?.WEBHOOK_EVENTS_MESSAGES_SET === 'true',\r\n          MESSAGES_UPSERT: process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT === 'true',\r\n          MESSAGES_EDITED: process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED === 'true',\r\n          MESSAGES_UPDATE: process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE === 'true',\r\n          MESSAGES_DELETE: process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE === 'true',\r\n          SEND_MESSAGE: process.env?.WEBHOOK_EVENTS_SEND_MESSAGE === 'true',\r\n          CONTACTS_SET: process.env?.WEBHOOK_EVENTS_CONTACTS_SET === 'true',\r\n          CONTACTS_UPDATE: process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE === 'true',\r\n          CONTACTS_UPSERT: process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT === 'true',\r\n          PRESENCE_UPDATE: process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE === 'true',\r\n          CHATS_SET: process.env?.WEBHOOK_EVENTS_CHATS_SET === 'true',\r\n          CHATS_UPDATE: process.env?.WEBHOOK_EVENTS_CHATS_UPDATE === 'true',\r\n          CHATS_UPSERT: process.env?.WEBHOOK_EVENTS_CHATS_UPSERT === 'true',\r\n          CHATS_DELETE: process.env?.WEBHOOK_EVENTS_CHATS_DELETE === 'true',\r\n          CONNECTION_UPDATE: process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE === 'true',\r\n          LABELS_EDIT: process.env?.WEBHOOK_EVENTS_LABELS_EDIT === 'true',\r\n          LABELS_ASSOCIATION: process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION === 'true',\r\n          GROUPS_UPSERT: process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT === 'true',\r\n          GROUP_UPDATE: process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE === 'true',\r\n          GROUP_PARTICIPANTS_UPDATE: process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE === 'true',\r\n          CALL: process.env?.WEBHOOK_EVENTS_CALL === 'true',\r\n          TYPEBOT_START: process.env?.WEBHOOK_EVENTS_TYPEBOT_START === 'true',\r\n          TYPEBOT_CHANGE_STATUS: process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS === 'true',\r\n          ERRORS: process.env?.WEBHOOK_EVENTS_ERRORS === 'true',\r\n          ERRORS_WEBHOOK: process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK || '',\r\n        },\r\n      },\r\n      CONFIG_SESSION_PHONE: {\r\n        CLIENT: process.env?.CONFIG_SESSION_PHONE_CLIENT || 'Evolution API',\r\n        NAME: process.env?.CONFIG_SESSION_PHONE_NAME || 'Chrome',\r\n        VERSION: process.env?.CONFIG_SESSION_PHONE_VERSION || null,\r\n      },\r\n      QRCODE: {\r\n        LIMIT: Number.parseInt(process.env.QRCODE_LIMIT) || 30,\r\n        COLOR: process.env.QRCODE_COLOR || '#198754',\r\n      },\r\n      TYPEBOT: {\r\n        ENABLED: process.env?.TYPEBOT_ENABLED === 'true',\r\n        API_VERSION: process.env?.TYPEBOT_API_VERSION || 'old',\r\n        SEND_MEDIA_BASE64: process.env?.TYPEBOT_SEND_MEDIA_BASE64 === 'true',\r\n      },\r\n      CHATWOOT: {\r\n        ENABLED: process.env?.CHATWOOT_ENABLED === 'true',\r\n        MESSAGE_DELETE: process.env.CHATWOOT_MESSAGE_DELETE === 'true',\r\n        MESSAGE_READ: process.env.CHATWOOT_MESSAGE_READ === 'true',\r\n        BOT_CONTACT: !process.env.CHATWOOT_BOT_CONTACT || process.env.CHATWOOT_BOT_CONTACT === 'true',\r\n        IMPORT: {\r\n          DATABASE: {\r\n            CONNECTION: {\r\n              URI: process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI || '',\r\n            },\r\n          },\r\n          PLACEHOLDER_MEDIA_MESSAGE: process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE === 'true',\r\n        },\r\n      },\r\n      OPENAI: {\r\n        ENABLED: process.env?.OPENAI_ENABLED === 'true',\r\n        API_KEY_GLOBAL: process.env?.OPENAI_API_KEY_GLOBAL || null,\r\n      },\r\n      DIFY: {\r\n        ENABLED: process.env?.DIFY_ENABLED === 'true',\r\n      },\r\n      CACHE: {\r\n        REDIS: {\r\n          ENABLED: process.env?.CACHE_REDIS_ENABLED === 'true',\r\n          URI: process.env?.CACHE_REDIS_URI || '',\r\n          PREFIX_KEY: process.env?.CACHE_REDIS_PREFIX_KEY || 'evolution-cache',\r\n          TTL: Number.parseInt(process.env?.CACHE_REDIS_TTL) || 604800,\r\n          SAVE_INSTANCES: process.env?.CACHE_REDIS_SAVE_INSTANCES === 'true',\r\n        },\r\n        LOCAL: {\r\n          ENABLED: process.env?.CACHE_LOCAL_ENABLED === 'true',\r\n          TTL: Number.parseInt(process.env?.CACHE_REDIS_TTL) || 86400,\r\n        },\r\n      },\r\n      S3: {\r\n        ACCESS_KEY: process.env?.S3_ACCESS_KEY,\r\n        SECRET_KEY: process.env?.S3_SECRET_KEY,\r\n        ENDPOINT: process.env?.S3_ENDPOINT,\r\n        BUCKET_NAME: process.env?.S3_BUCKET,\r\n        ENABLE: process.env?.S3_ENABLED === 'true',\r\n        PORT: Number.parseInt(process.env?.S3_PORT || '9000'),\r\n        USE_SSL: process.env?.S3_USE_SSL === 'true',\r\n        REGION: process.env?.S3_REGION,\r\n      },\r\n      AUTHENTICATION: {\r\n        API_KEY: {\r\n          KEY: process.env.AUTHENTICATION_API_KEY || 'BQYHJGJHJ',\r\n        },\r\n        EXPOSE_IN_FETCH_INSTANCES: process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES === 'true',\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\nexport const configService = new ConfigService();\r\n","import { ICache } from '@api/abstract/abstract.cache';\r\nimport { CacheConf, CacheConfLocal, ConfigService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BufferJSON } from 'baileys';\r\nimport NodeCache from 'node-cache';\r\n\r\nexport class LocalCache implements ICache {\r\n  private readonly logger = new Logger('LocalCache');\r\n  private conf: CacheConfLocal;\r\n  static localCache = new NodeCache();\r\n\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    private readonly module: string,\r\n  ) {\r\n    this.conf = this.configService.get<CacheConf>('CACHE')?.LOCAL;\r\n  }\r\n\r\n  async get(key: string): Promise<any> {\r\n    return LocalCache.localCache.get(this.buildKey(key));\r\n  }\r\n\r\n  async set(key: string, value: any, ttl?: number) {\r\n    return LocalCache.localCache.set(this.buildKey(key), value, ttl || this.conf.TTL);\r\n  }\r\n\r\n  async has(key: string) {\r\n    return LocalCache.localCache.has(this.buildKey(key));\r\n  }\r\n\r\n  async delete(key: string) {\r\n    return LocalCache.localCache.del(this.buildKey(key));\r\n  }\r\n\r\n  async deleteAll(appendCriteria?: string) {\r\n    const keys = await this.keys(appendCriteria);\r\n    if (!keys?.length) {\r\n      return 0;\r\n    }\r\n\r\n    return LocalCache.localCache.del(keys);\r\n  }\r\n\r\n  async keys(appendCriteria?: string) {\r\n    const filter = `${this.buildKey('')}${appendCriteria ? `${appendCriteria}:` : ''}`;\r\n\r\n    return LocalCache.localCache.keys().filter((key) => key.substring(0, filter.length) === filter);\r\n  }\r\n\r\n  buildKey(key: string) {\r\n    return `${this.module}:${key}`;\r\n  }\r\n\r\n  async hGet(key: string, field: string) {\r\n    try {\r\n      const data = LocalCache.localCache.get(this.buildKey(key)) as Object;\r\n\r\n      if (data && field in data) {\r\n        return JSON.parse(data[field], BufferJSON.reviver);\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async hSet(key: string, field: string, value: any) {\r\n    try {\r\n      const json = JSON.stringify(value, BufferJSON.replacer);\r\n\r\n      let hash = LocalCache.localCache.get(this.buildKey(key));\r\n\r\n      if (!hash) {\r\n        hash = {};\r\n      }\r\n\r\n      hash[field] = json;\r\n      LocalCache.localCache.set(this.buildKey(key), hash);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async hDelete(key: string, field: string) {\r\n    try {\r\n      const data = LocalCache.localCache.get(this.buildKey(key)) as Object;\r\n\r\n      if (data && field in data) {\r\n        delete data[field];\r\n        LocalCache.localCache.set(this.buildKey(key), data);\r\n        return 1;\r\n      }\r\n\r\n      return 0;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n}\r\n","import { ICache } from '@api/abstract/abstract.cache';\r\nimport { CacheConf, CacheConfRedis, ConfigService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BufferJSON } from 'baileys';\r\nimport { RedisClientType } from 'redis';\r\n\r\nimport { redisClient } from './rediscache.client';\r\n\r\nexport class RedisCache implements ICache {\r\n  private readonly logger = new Logger('RedisCache');\r\n  private client: RedisClientType;\r\n  private conf: CacheConfRedis;\r\n\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    private readonly module: string,\r\n  ) {\r\n    this.conf = this.configService.get<CacheConf>('CACHE')?.REDIS;\r\n    this.client = redisClient.getConnection();\r\n  }\r\n  async get(key: string): Promise<any> {\r\n    try {\r\n      return JSON.parse(await this.client.get(this.buildKey(key)));\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async hGet(key: string, field: string) {\r\n    try {\r\n      const data = await this.client.hGet(this.buildKey(key), field);\r\n\r\n      if (data) {\r\n        return JSON.parse(data, BufferJSON.reviver);\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async set(key: string, value: any, ttl?: number) {\r\n    try {\r\n      await this.client.setEx(this.buildKey(key), ttl || this.conf?.TTL, JSON.stringify(value));\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async hSet(key: string, field: string, value: any) {\r\n    try {\r\n      const json = JSON.stringify(value, BufferJSON.replacer);\r\n\r\n      await this.client.hSet(this.buildKey(key), field, json);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async has(key: string) {\r\n    try {\r\n      return (await this.client.exists(this.buildKey(key))) > 0;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async delete(key: string) {\r\n    try {\r\n      return await this.client.del(this.buildKey(key));\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async hDelete(key: string, field: string) {\r\n    try {\r\n      return await this.client.hDel(this.buildKey(key), field);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async deleteAll(appendCriteria?: string) {\r\n    try {\r\n      const keys = await this.keys(appendCriteria);\r\n      if (!keys?.length) {\r\n        return 0;\r\n      }\r\n\r\n      return await this.client.del(keys);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async keys(appendCriteria?: string) {\r\n    try {\r\n      const match = `${this.buildKey('')}${appendCriteria ? `${appendCriteria}:` : ''}*`;\r\n      const keys = [];\r\n      for await (const key of this.client.scanIterator({\r\n        MATCH: match,\r\n        COUNT: 100,\r\n      })) {\r\n        keys.push(key);\r\n      }\r\n\r\n      return [...new Set(keys)];\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  buildKey(key: string) {\r\n    return `${this.conf?.PREFIX_KEY}:${this.module}:${key}`;\r\n  }\r\n}\r\n","import { CacheConf, CacheConfRedis, configService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { createClient, RedisClientType } from 'redis';\r\n\r\nclass Redis {\r\n  private logger = new Logger('Redis');\r\n  private client: RedisClientType = null;\r\n  private conf: CacheConfRedis;\r\n  private connected = false;\r\n\r\n  constructor() {\r\n    this.conf = configService.get<CacheConf>('CACHE')?.REDIS;\r\n  }\r\n\r\n  getConnection(): RedisClientType {\r\n    if (this.connected) {\r\n      return this.client;\r\n    } else {\r\n      this.client = createClient({\r\n        url: this.conf.URI,\r\n      });\r\n\r\n      this.client.on('connect', () => {\r\n        this.logger.verbose('redis connecting');\r\n      });\r\n\r\n      this.client.on('ready', () => {\r\n        this.logger.verbose('redis ready');\r\n        this.connected = true;\r\n      });\r\n\r\n      this.client.on('error', () => {\r\n        this.logger.error('redis disconnected');\r\n        this.connected = false;\r\n      });\r\n\r\n      this.client.on('end', () => {\r\n        this.logger.verbose('redis connection ended');\r\n        this.connected = false;\r\n      });\r\n\r\n      try {\r\n        this.client.connect();\r\n        this.connected = true;\r\n      } catch (e) {\r\n        this.connected = false;\r\n        this.logger.error('redis connect exception caught: ' + e);\r\n        return null;\r\n      }\r\n\r\n      return this.client;\r\n    }\r\n  }\r\n}\r\n\r\nexport const redisClient = new Redis();\r\n","import { ICache } from '@api/abstract/abstract.cache';\r\nimport { CacheConf, ConfigService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\n\r\nimport { LocalCache } from './localcache';\r\nimport { RedisCache } from './rediscache';\r\n\r\nconst logger = new Logger('CacheEngine');\r\n\r\nexport class CacheEngine {\r\n  private engine: ICache;\r\n\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    module: string,\r\n  ) {\r\n    const cacheConf = configService.get<CacheConf>('CACHE');\r\n\r\n    if (cacheConf?.REDIS?.ENABLED && cacheConf?.REDIS?.URI !== '') {\r\n      logger.verbose(`RedisCache initialized for ${module}`);\r\n      this.engine = new RedisCache(configService, module);\r\n    } else if (cacheConf?.LOCAL?.ENABLED) {\r\n      logger.verbose(`LocalCache initialized for ${module}`);\r\n      this.engine = new LocalCache(configService, module);\r\n    }\r\n  }\r\n\r\n  public getEngine() {\r\n    return this.engine;\r\n  }\r\n}\r\n","import EventEmitter2 from 'eventemitter2';\r\n\r\nconst maxListeners = parseInt(process.env.EVENT_EMITTER_MAX_LISTENERS, 10) || 50;\r\n\r\nexport const eventEmitter = new EventEmitter2({\r\n  delimiter: '.',\r\n  newListener: false,\r\n  ignoreErrors: false,\r\n  maxListeners: maxListeners,\r\n});\r\n","import { OfferCallDto } from '@api/dto/call.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\n\r\nexport class CallController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async offerCall({ instanceName }: InstanceDto, data: OfferCallDto) {\r\n    return await this.waMonitor.waInstances[instanceName].offerCall(data);\r\n  }\r\n}\r\n","import {\r\n  ArchiveChatDto,\r\n  BlockUserDto,\r\n  DeleteMessage,\r\n  getBase64FromMediaMessageDto,\r\n  MarkChatUnreadDto,\r\n  NumberDto,\r\n  PrivacySettingDto,\r\n  ProfileNameDto,\r\n  ProfilePictureDto,\r\n  ProfileStatusDto,\r\n  ReadMessageDto,\r\n  SendPresenceDto,\r\n  UpdateMessageDto,\r\n  WhatsAppNumberDto,\r\n} from '@api/dto/chat.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { Query } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Contact, Message, MessageUpdate } from '@prisma/client';\r\n\r\nexport class ChatController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async whatsappNumber({ instanceName }: InstanceDto, data: WhatsAppNumberDto) {\r\n    return await this.waMonitor.waInstances[instanceName].whatsappNumber(data);\r\n  }\r\n\r\n  public async readMessage({ instanceName }: InstanceDto, data: ReadMessageDto) {\r\n    return await this.waMonitor.waInstances[instanceName].markMessageAsRead(data);\r\n  }\r\n\r\n  public async archiveChat({ instanceName }: InstanceDto, data: ArchiveChatDto) {\r\n    return await this.waMonitor.waInstances[instanceName].archiveChat(data);\r\n  }\r\n\r\n  public async markChatUnread({ instanceName }: InstanceDto, data: MarkChatUnreadDto) {\r\n    return await this.waMonitor.waInstances[instanceName].markChatUnread(data);\r\n  }\r\n\r\n  public async deleteMessage({ instanceName }: InstanceDto, data: DeleteMessage) {\r\n    return await this.waMonitor.waInstances[instanceName].deleteMessage(data);\r\n  }\r\n\r\n  public async fetchProfilePicture({ instanceName }: InstanceDto, data: NumberDto) {\r\n    return await this.waMonitor.waInstances[instanceName].profilePicture(data.number);\r\n  }\r\n\r\n  public async fetchProfile({ instanceName }: InstanceDto, data: NumberDto) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchProfile(instanceName, data.number);\r\n  }\r\n\r\n  public async fetchContacts({ instanceName }: InstanceDto, query: Query<Contact>) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchContacts(query);\r\n  }\r\n\r\n  public async getBase64FromMediaMessage({ instanceName }: InstanceDto, data: getBase64FromMediaMessageDto) {\r\n    return await this.waMonitor.waInstances[instanceName].getBase64FromMediaMessage(data);\r\n  }\r\n\r\n  public async fetchMessages({ instanceName }: InstanceDto, query: Query<Message>) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchMessages(query);\r\n  }\r\n\r\n  public async fetchStatusMessage({ instanceName }: InstanceDto, query: Query<MessageUpdate>) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchStatusMessage(query);\r\n  }\r\n\r\n  public async fetchChats({ instanceName }: InstanceDto, query: Query<Contact>) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchChats(query);\r\n  }\r\n\r\n  public async sendPresence({ instanceName }: InstanceDto, data: SendPresenceDto) {\r\n    return await this.waMonitor.waInstances[instanceName].sendPresence(data);\r\n  }\r\n\r\n  public async fetchPrivacySettings({ instanceName }: InstanceDto) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchPrivacySettings();\r\n  }\r\n\r\n  public async updatePrivacySettings({ instanceName }: InstanceDto, data: PrivacySettingDto) {\r\n    return await this.waMonitor.waInstances[instanceName].updatePrivacySettings(data);\r\n  }\r\n\r\n  public async fetchBusinessProfile({ instanceName }: InstanceDto, data: ProfilePictureDto) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchBusinessProfile(data.number);\r\n  }\r\n\r\n  public async updateProfileName({ instanceName }: InstanceDto, data: ProfileNameDto) {\r\n    return await this.waMonitor.waInstances[instanceName].updateProfileName(data.name);\r\n  }\r\n\r\n  public async updateProfileStatus({ instanceName }: InstanceDto, data: ProfileStatusDto) {\r\n    return await this.waMonitor.waInstances[instanceName].updateProfileStatus(data.status);\r\n  }\r\n\r\n  public async updateProfilePicture({ instanceName }: InstanceDto, data: ProfilePictureDto) {\r\n    return await this.waMonitor.waInstances[instanceName].updateProfilePicture(data.picture);\r\n  }\r\n\r\n  public async removeProfilePicture({ instanceName }: InstanceDto) {\r\n    return await this.waMonitor.waInstances[instanceName].removeProfilePicture();\r\n  }\r\n\r\n  public async updateMessage({ instanceName }: InstanceDto, data: UpdateMessageDto) {\r\n    return await this.waMonitor.waInstances[instanceName].updateMessage(data);\r\n  }\r\n\r\n  public async blockUser({ instanceName }: InstanceDto, data: BlockUserDto) {\r\n    return await this.waMonitor.waInstances[instanceName].blockUser(data);\r\n  }\r\n}\r\n","import {\r\n  AcceptGroupInvite,\r\n  CreateGroupDto,\r\n  GetParticipant,\r\n  GroupDescriptionDto,\r\n  GroupInvite,\r\n  GroupJid,\r\n  GroupPictureDto,\r\n  GroupSendInvite,\r\n  GroupSubjectDto,\r\n  GroupToggleEphemeralDto,\r\n  GroupUpdateParticipantDto,\r\n  GroupUpdateSettingDto,\r\n} from '@api/dto/group.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\n\r\nexport class GroupController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async createGroup(instance: InstanceDto, create: CreateGroupDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].createGroup(create);\r\n  }\r\n\r\n  public async updateGroupPicture(instance: InstanceDto, update: GroupPictureDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].updateGroupPicture(update);\r\n  }\r\n\r\n  public async updateGroupSubject(instance: InstanceDto, update: GroupSubjectDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].updateGroupSubject(update);\r\n  }\r\n\r\n  public async updateGroupDescription(instance: InstanceDto, update: GroupDescriptionDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].updateGroupDescription(update);\r\n  }\r\n\r\n  public async findGroupInfo(instance: InstanceDto, groupJid: GroupJid) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].findGroup(groupJid);\r\n  }\r\n\r\n  public async fetchAllGroups(instance: InstanceDto, getPaticipants: GetParticipant) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].fetchAllGroups(getPaticipants);\r\n  }\r\n\r\n  public async inviteCode(instance: InstanceDto, groupJid: GroupJid) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].inviteCode(groupJid);\r\n  }\r\n\r\n  public async inviteInfo(instance: InstanceDto, inviteCode: GroupInvite) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].inviteInfo(inviteCode);\r\n  }\r\n\r\n  public async sendInvite(instance: InstanceDto, data: GroupSendInvite) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].sendInvite(data);\r\n  }\r\n\r\n  public async acceptInviteCode(instance: InstanceDto, inviteCode: AcceptGroupInvite) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].acceptInviteCode(inviteCode);\r\n  }\r\n\r\n  public async revokeInviteCode(instance: InstanceDto, groupJid: GroupJid) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].revokeInviteCode(groupJid);\r\n  }\r\n\r\n  public async findParticipants(instance: InstanceDto, groupJid: GroupJid) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].findParticipants(groupJid);\r\n  }\r\n\r\n  public async updateGParticipate(instance: InstanceDto, update: GroupUpdateParticipantDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].updateGParticipant(update);\r\n  }\r\n\r\n  public async updateGSetting(instance: InstanceDto, update: GroupUpdateSettingDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].updateGSetting(update);\r\n  }\r\n\r\n  public async toggleEphemeral(instance: InstanceDto, update: GroupToggleEphemeralDto) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].toggleEphemeral(update);\r\n  }\r\n\r\n  public async leaveGroup(instance: InstanceDto, groupJid: GroupJid) {\r\n    return await this.waMonitor.waInstances[instance.instanceName].leaveGroup(groupJid);\r\n  }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-namespace */\r\nimport { JsonValue } from '@prisma/client/runtime/library';\r\nimport { AuthenticationState, WAConnectionState } from 'baileys';\r\n\r\nexport enum Events {\r\n  APPLICATION_STARTUP = 'application.startup',\r\n  INSTANCE_CREATE = 'instance.create',\r\n  INSTANCE_DELETE = 'instance.delete',\r\n  QRCODE_UPDATED = 'qrcode.updated',\r\n  CONNECTION_UPDATE = 'connection.update',\r\n  STATUS_INSTANCE = 'status.instance',\r\n  MESSAGES_SET = 'messages.set',\r\n  MESSAGES_UPSERT = 'messages.upsert',\r\n  MESSAGES_EDITED = 'messages.edited',\r\n  MESSAGES_UPDATE = 'messages.update',\r\n  MESSAGES_DELETE = 'messages.delete',\r\n  SEND_MESSAGE = 'send.message',\r\n  CONTACTS_SET = 'contacts.set',\r\n  CONTACTS_UPSERT = 'contacts.upsert',\r\n  CONTACTS_UPDATE = 'contacts.update',\r\n  PRESENCE_UPDATE = 'presence.update',\r\n  CHATS_SET = 'chats.set',\r\n  CHATS_UPDATE = 'chats.update',\r\n  CHATS_UPSERT = 'chats.upsert',\r\n  CHATS_DELETE = 'chats.delete',\r\n  GROUPS_UPSERT = 'groups.upsert',\r\n  GROUPS_UPDATE = 'groups.update',\r\n  GROUP_PARTICIPANTS_UPDATE = 'group-participants.update',\r\n  CALL = 'call',\r\n  TYPEBOT_START = 'typebot.start',\r\n  TYPEBOT_CHANGE_STATUS = 'typebot.change-status',\r\n  LABELS_EDIT = 'labels.edit',\r\n  LABELS_ASSOCIATION = 'labels.association',\r\n  CREDS_UPDATE = 'creds.update',\r\n  MESSAGING_HISTORY_SET = 'messaging-history.set',\r\n  REMOVE_INSTANCE = 'remove.instance',\r\n  LOGOUT_INSTANCE = 'logout.instance',\r\n}\r\n\r\nexport declare namespace wa {\r\n  export type QrCode = {\r\n    count?: number;\r\n    pairingCode?: string;\r\n    base64?: string;\r\n    code?: string;\r\n  };\r\n\r\n  export type Instance = {\r\n    id?: string;\r\n    qrcode?: QrCode;\r\n    pairingCode?: string;\r\n    authState?: { state: AuthenticationState; saveCreds: () => void };\r\n    name?: string;\r\n    wuid?: string;\r\n    profileName?: string;\r\n    profilePictureUrl?: string;\r\n    token?: string;\r\n    number?: string;\r\n    integration?: string;\r\n    businessId?: string;\r\n  };\r\n\r\n  export type LocalChatwoot = {\r\n    enabled?: boolean;\r\n    accountId?: string;\r\n    token?: string;\r\n    url?: string;\r\n    nameInbox?: string;\r\n    signMsg?: boolean;\r\n    signDelimiter?: string;\r\n    number?: string;\r\n    reopenConversation?: boolean;\r\n    conversationPending?: boolean;\r\n    mergeBrazilContacts?: boolean;\r\n    importContacts?: boolean;\r\n    importMessages?: boolean;\r\n    daysLimitImportMessages?: number;\r\n  };\r\n\r\n  export type LocalSettings = {\r\n    rejectCall?: boolean;\r\n    msgCall?: string;\r\n    groupsIgnore?: boolean;\r\n    alwaysOnline?: boolean;\r\n    readMessages?: boolean;\r\n    readStatus?: boolean;\r\n    syncFullHistory?: boolean;\r\n    wavoipToken?: string;\r\n  };\r\n\r\n  export type LocalEvent = {\r\n    enabled?: boolean;\r\n    events?: JsonValue;\r\n  };\r\n\r\n  export type LocalWebHook = LocalEvent & {\r\n    url?: string;\r\n    headers?: JsonValue;\r\n    webhookByEvents?: boolean;\r\n    webhookBase64?: boolean;\r\n  };\r\n\r\n  export type LocalPusher = LocalEvent & {\r\n    appId?: string;\r\n    key?: string;\r\n    secret?: string;\r\n    cluster?: string;\r\n    useTLS?: boolean;\r\n  };\r\n\r\n  type Session = {\r\n    remoteJid?: string;\r\n    sessionId?: string;\r\n    createdAt?: number;\r\n  };\r\n\r\n  export type LocalProxy = {\r\n    enabled?: boolean;\r\n    host?: string;\r\n    port?: string;\r\n    protocol?: string;\r\n    username?: string;\r\n    password?: string;\r\n  };\r\n\r\n  export type StateConnection = {\r\n    instance?: string;\r\n    state?: WAConnectionState | 'refused';\r\n    statusReason?: number;\r\n  };\r\n\r\n  export type StatusMessage = 'ERROR' | 'PENDING' | 'SERVER_ACK' | 'DELIVERY_ACK' | 'READ' | 'DELETED' | 'PLAYED';\r\n}\r\n\r\nexport const TypeMediaMessage = [\r\n  'imageMessage',\r\n  'documentMessage',\r\n  'audioMessage',\r\n  'videoMessage',\r\n  'stickerMessage',\r\n  'ptvMessage',\r\n];\r\n\r\nexport const MessageSubtype = [\r\n  'ephemeralMessage',\r\n  'documentWithCaptionMessage',\r\n  'viewOnceMessage',\r\n  'viewOnceMessageV2',\r\n];\r\n\r\nexport const Integration = {\r\n  WHATSAPP_BUSINESS: 'WHATSAPP-BUSINESS',\r\n  WHATSAPP_BAILEYS: 'WHATSAPP-BAILEYS',\r\n  EVOLUTION: 'EVOLUTION',\r\n};\r\n","import { InstanceDto, SetPresenceDto } from '@api/dto/instance.dto';\r\nimport { ChatwootService } from '@api/integrations/chatbot/chatwoot/services/chatwoot.service';\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { channelController, eventManager } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { SettingsService } from '@api/services/settings.service';\r\nimport { Events, Integration, wa } from '@api/types/wa.types';\r\nimport { Auth, Chatwoot, ConfigService, HttpServer, WaBusiness } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException, InternalServerErrorException, UnauthorizedException } from '@exceptions';\r\nimport { delay } from 'baileys';\r\nimport { isArray, isURL } from 'class-validator';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { ProxyController } from './proxy.controller';\r\n\r\nexport class InstanceController {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n    private readonly eventEmitter: EventEmitter2,\r\n    private readonly chatwootService: ChatwootService,\r\n    private readonly settingsService: SettingsService,\r\n    private readonly proxyService: ProxyController,\r\n    private readonly cache: CacheService,\r\n    private readonly chatwootCache: CacheService,\r\n    private readonly baileysCache: CacheService,\r\n    private readonly providerFiles: ProviderFiles,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('InstanceController');\r\n\r\n  public async createInstance(instanceData: InstanceDto) {\r\n    try {\r\n      const instance = channelController.init(instanceData, {\r\n        configService: this.configService,\r\n        eventEmitter: this.eventEmitter,\r\n        prismaRepository: this.prismaRepository,\r\n        cache: this.cache,\r\n        chatwootCache: this.chatwootCache,\r\n        baileysCache: this.baileysCache,\r\n        providerFiles: this.providerFiles,\r\n      });\r\n\r\n      if (!instance) {\r\n        throw new BadRequestException('Invalid integration');\r\n      }\r\n\r\n      const instanceId = v4();\r\n\r\n      instanceData.instanceId = instanceId;\r\n\r\n      let hash: string;\r\n\r\n      if (!instanceData.token) hash = v4().toUpperCase();\r\n      else hash = instanceData.token;\r\n\r\n      await this.waMonitor.saveInstance({\r\n        instanceId,\r\n        integration: instanceData.integration,\r\n        instanceName: instanceData.instanceName,\r\n        ownerJid: instanceData.ownerJid,\r\n        profileName: instanceData.profileName,\r\n        profilePicUrl: instanceData.profilePicUrl,\r\n        hash,\r\n        number: instanceData.number,\r\n        businessId: instanceData.businessId,\r\n        status: instanceData.status,\r\n      });\r\n\r\n      instance.setInstance({\r\n        instanceName: instanceData.instanceName,\r\n        instanceId,\r\n        integration: instanceData.integration,\r\n        token: hash,\r\n        number: instanceData.number,\r\n        businessId: instanceData.businessId,\r\n      });\r\n\r\n      this.waMonitor.waInstances[instance.instanceName] = instance;\r\n      this.waMonitor.delInstanceTime(instance.instanceName);\r\n\r\n      // set events\r\n      await eventManager.setInstance(instance.instanceName, instanceData);\r\n\r\n      instance.sendDataWebhook(Events.INSTANCE_CREATE, {\r\n        instanceName: instanceData.instanceName,\r\n        instanceId: instanceId,\r\n      });\r\n\r\n      if (instanceData.proxyHost && instanceData.proxyPort && instanceData.proxyProtocol) {\r\n        const testProxy = await this.proxyService.testProxy({\r\n          host: instanceData.proxyHost,\r\n          port: instanceData.proxyPort,\r\n          protocol: instanceData.proxyProtocol,\r\n          username: instanceData.proxyUsername,\r\n          password: instanceData.proxyPassword,\r\n        });\r\n        if (!testProxy) {\r\n          throw new BadRequestException('Invalid proxy');\r\n        }\r\n\r\n        await this.proxyService.createProxy(instance, {\r\n          enabled: true,\r\n          host: instanceData.proxyHost,\r\n          port: instanceData.proxyPort,\r\n          protocol: instanceData.proxyProtocol,\r\n          username: instanceData.proxyUsername,\r\n          password: instanceData.proxyPassword,\r\n        });\r\n      }\r\n\r\n      const settings: wa.LocalSettings = {\r\n        rejectCall: instanceData.rejectCall === true,\r\n        msgCall: instanceData.msgCall || '',\r\n        groupsIgnore: instanceData.groupsIgnore === true,\r\n        alwaysOnline: instanceData.alwaysOnline === true,\r\n        readMessages: instanceData.readMessages === true,\r\n        readStatus: instanceData.readStatus === true,\r\n        syncFullHistory: instanceData.syncFullHistory === true,\r\n        wavoipToken: instanceData.wavoipToken || '',\r\n      };\r\n\r\n      await this.settingsService.create(instance, settings);\r\n\r\n      let webhookWaBusiness = null,\r\n        accessTokenWaBusiness = '';\r\n\r\n      if (instanceData.integration === Integration.WHATSAPP_BUSINESS) {\r\n        if (!instanceData.number) {\r\n          throw new BadRequestException('number is required');\r\n        }\r\n        const urlServer = this.configService.get<HttpServer>('SERVER').URL;\r\n        webhookWaBusiness = `${urlServer}/webhook/meta`;\r\n        accessTokenWaBusiness = this.configService.get<WaBusiness>('WA_BUSINESS').TOKEN_WEBHOOK;\r\n      }\r\n\r\n      if (!instanceData.chatwootAccountId || !instanceData.chatwootToken || !instanceData.chatwootUrl) {\r\n        let getQrcode: wa.QrCode;\r\n\r\n        if (instanceData.qrcode && instanceData.integration === Integration.WHATSAPP_BAILEYS) {\r\n          await instance.connectToWhatsapp(instanceData.number);\r\n          await delay(5000);\r\n          getQrcode = instance.qrCode;\r\n        }\r\n\r\n        const result = {\r\n          instance: {\r\n            instanceName: instance.instanceName,\r\n            instanceId: instanceId,\r\n            integration: instanceData.integration,\r\n            webhookWaBusiness,\r\n            accessTokenWaBusiness,\r\n            status: instance.connectionStatus.state,\r\n          },\r\n          hash,\r\n          webhook: {\r\n            webhookUrl: instanceData?.webhook?.url,\r\n            webhookHeaders: instanceData?.webhook?.headers,\r\n            webhookByEvents: instanceData?.webhook?.byEvents,\r\n            webhookBase64: instanceData?.webhook?.base64,\r\n          },\r\n          websocket: {\r\n            enabled: instanceData?.websocket?.enabled,\r\n          },\r\n          rabbitmq: {\r\n            enabled: instanceData?.rabbitmq?.enabled,\r\n          },\r\n          sqs: {\r\n            enabled: instanceData?.sqs?.enabled,\r\n          },\r\n          settings,\r\n          qrcode: getQrcode,\r\n        };\r\n\r\n        return result;\r\n      }\r\n\r\n      if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED)\r\n        throw new BadRequestException('Chatwoot is not enabled');\r\n\r\n      if (!instanceData.chatwootAccountId) {\r\n        throw new BadRequestException('accountId is required');\r\n      }\r\n\r\n      if (!instanceData.chatwootToken) {\r\n        throw new BadRequestException('token is required');\r\n      }\r\n\r\n      if (!instanceData.chatwootUrl) {\r\n        throw new BadRequestException('url is required');\r\n      }\r\n\r\n      if (!isURL(instanceData.chatwootUrl, { require_tld: false })) {\r\n        throw new BadRequestException('Invalid \"url\" property in chatwoot');\r\n      }\r\n\r\n      if (instanceData.chatwootSignMsg !== true && instanceData.chatwootSignMsg !== false) {\r\n        throw new BadRequestException('signMsg is required');\r\n      }\r\n\r\n      if (instanceData.chatwootReopenConversation !== true && instanceData.chatwootReopenConversation !== false) {\r\n        throw new BadRequestException('reopenConversation is required');\r\n      }\r\n\r\n      if (instanceData.chatwootConversationPending !== true && instanceData.chatwootConversationPending !== false) {\r\n        throw new BadRequestException('conversationPending is required');\r\n      }\r\n\r\n      const urlServer = this.configService.get<HttpServer>('SERVER').URL;\r\n\r\n      try {\r\n        this.chatwootService.create(instance, {\r\n          enabled: true,\r\n          accountId: instanceData.chatwootAccountId,\r\n          token: instanceData.chatwootToken,\r\n          url: instanceData.chatwootUrl,\r\n          signMsg: instanceData.chatwootSignMsg || false,\r\n          nameInbox: instanceData.chatwootNameInbox ?? instance.instanceName.split('-cwId-')[0],\r\n          number: instanceData.number,\r\n          reopenConversation: instanceData.chatwootReopenConversation || false,\r\n          conversationPending: instanceData.chatwootConversationPending || false,\r\n          importContacts: instanceData.chatwootImportContacts ?? true,\r\n          mergeBrazilContacts: instanceData.chatwootMergeBrazilContacts ?? false,\r\n          importMessages: instanceData.chatwootImportMessages ?? true,\r\n          daysLimitImportMessages: instanceData.chatwootDaysLimitImportMessages ?? 60,\r\n          organization: instanceData.chatwootOrganization,\r\n          logo: instanceData.chatwootLogo,\r\n          autoCreate: instanceData.chatwootAutoCreate !== false,\r\n        });\r\n      } catch (error) {\r\n        this.logger.log(error);\r\n      }\r\n\r\n      return {\r\n        instance: {\r\n          instanceName: instance.instanceName,\r\n          instanceId: instanceId,\r\n          integration: instanceData.integration,\r\n          webhookWaBusiness,\r\n          accessTokenWaBusiness,\r\n          status: instance.connectionStatus.state,\r\n        },\r\n        hash,\r\n        webhook: {\r\n          webhookUrl: instanceData?.webhook?.url,\r\n          webhookHeaders: instanceData?.webhook?.headers,\r\n          webhookByEvents: instanceData?.webhook?.byEvents,\r\n          webhookBase64: instanceData?.webhook?.base64,\r\n        },\r\n        websocket: {\r\n          enabled: instanceData?.websocket?.enabled,\r\n        },\r\n        rabbitmq: {\r\n          enabled: instanceData?.rabbitmq?.enabled,\r\n        },\r\n        sqs: {\r\n          enabled: instanceData?.sqs?.enabled,\r\n        },\r\n        settings,\r\n        chatwoot: {\r\n          enabled: true,\r\n          accountId: instanceData.chatwootAccountId,\r\n          token: instanceData.chatwootToken,\r\n          url: instanceData.chatwootUrl,\r\n          signMsg: instanceData.chatwootSignMsg || false,\r\n          reopenConversation: instanceData.chatwootReopenConversation || false,\r\n          conversationPending: instanceData.chatwootConversationPending || false,\r\n          mergeBrazilContacts: instanceData.chatwootMergeBrazilContacts ?? false,\r\n          importContacts: instanceData.chatwootImportContacts ?? true,\r\n          importMessages: instanceData.chatwootImportMessages ?? true,\r\n          daysLimitImportMessages: instanceData.chatwootDaysLimitImportMessages || 60,\r\n          number: instanceData.number,\r\n          nameInbox: instanceData.chatwootNameInbox ?? instance.instanceName,\r\n          webhookUrl: `${urlServer}/chatwoot/webhook/${encodeURIComponent(instance.instanceName)}`,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      this.waMonitor.deleteInstance(instanceData.instanceName);\r\n      this.logger.error(isArray(error.message) ? error.message[0] : error.message);\r\n      throw new BadRequestException(isArray(error.message) ? error.message[0] : error.message);\r\n    }\r\n  }\r\n\r\n  public async connectToWhatsapp({ instanceName, number = null }: InstanceDto) {\r\n    try {\r\n      const instance = this.waMonitor.waInstances[instanceName];\r\n      const state = instance?.connectionStatus?.state;\r\n\r\n      if (!state) {\r\n        throw new BadRequestException('The \"' + instanceName + '\" instance does not exist');\r\n      }\r\n\r\n      if (state == 'open') {\r\n        return await this.connectionState({ instanceName });\r\n      }\r\n\r\n      if (state == 'connecting') {\r\n        return instance.qrCode;\r\n      }\r\n\r\n      if (state == 'close') {\r\n        await instance.connectToWhatsapp(number);\r\n\r\n        await delay(2000);\r\n        return instance.qrCode;\r\n      }\r\n\r\n      return {\r\n        instance: {\r\n          instanceName: instanceName,\r\n          status: state,\r\n        },\r\n        qrcode: instance?.qrCode,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return { error: true, message: error.toString() };\r\n    }\r\n  }\r\n\r\n  public async restartInstance({ instanceName }: InstanceDto) {\r\n    try {\r\n      const instance = this.waMonitor.waInstances[instanceName];\r\n      const state = instance?.connectionStatus?.state;\r\n\r\n      if (!state) {\r\n        throw new BadRequestException('The \"' + instanceName + '\" instance does not exist');\r\n      }\r\n\r\n      if (state == 'close') {\r\n        throw new BadRequestException('The \"' + instanceName + '\" instance is not connected');\r\n      } else if (state == 'open') {\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) instance.clearCacheChatwoot();\r\n        this.logger.info('restarting instance' + instanceName);\r\n\r\n        instance.client?.ws?.close();\r\n        instance.client?.end(new Error('restart'));\r\n        return await this.connectToWhatsapp({ instanceName });\r\n      } else if (state == 'connecting') {\r\n        instance.client?.ws?.close();\r\n        instance.client?.end(new Error('restart'));\r\n        return await this.connectToWhatsapp({ instanceName });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return { error: true, message: error.toString() };\r\n    }\r\n  }\r\n\r\n  public async connectionState({ instanceName }: InstanceDto) {\r\n    return {\r\n      instance: {\r\n        instanceName: instanceName,\r\n        state: this.waMonitor.waInstances[instanceName]?.connectionStatus?.state,\r\n      },\r\n    };\r\n  }\r\n\r\n  public async fetchInstances({ instanceName, instanceId, number }: InstanceDto, key: string) {\r\n    const env = this.configService.get<Auth>('AUTHENTICATION').API_KEY;\r\n\r\n    if (env.KEY !== key) {\r\n      const instancesByKey = await this.prismaRepository.instance.findMany({\r\n        where: {\r\n          token: key,\r\n          name: instanceName || undefined,\r\n          id: instanceId || undefined,\r\n        },\r\n      });\r\n\r\n      if (instancesByKey.length > 0) {\r\n        const names = instancesByKey.map((instance) => instance.name);\r\n\r\n        return this.waMonitor.instanceInfo(names);\r\n      } else {\r\n        throw new UnauthorizedException();\r\n      }\r\n    }\r\n\r\n    if (instanceId || number) {\r\n      return this.waMonitor.instanceInfoById(instanceId, number);\r\n    }\r\n\r\n    const instanceNames = instanceName ? [instanceName] : null;\r\n\r\n    return this.waMonitor.instanceInfo(instanceNames);\r\n  }\r\n\r\n  public async setPresence({ instanceName }: InstanceDto, data: SetPresenceDto) {\r\n    return await this.waMonitor.waInstances[instanceName].setPresence(data);\r\n  }\r\n\r\n  public async logout({ instanceName }: InstanceDto) {\r\n    const { instance } = await this.connectionState({ instanceName });\r\n\r\n    if (instance.state === 'close') {\r\n      throw new BadRequestException('The \"' + instanceName + '\" instance is not connected');\r\n    }\r\n\r\n    try {\r\n      this.waMonitor.waInstances[instanceName]?.logoutInstance();\r\n\r\n      return { status: 'SUCCESS', error: false, response: { message: 'Instance logged out' } };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async deleteInstance({ instanceName }: InstanceDto) {\r\n    const { instance } = await this.connectionState({ instanceName });\r\n    try {\r\n      const waInstances = this.waMonitor.waInstances[instanceName];\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) waInstances?.clearCacheChatwoot();\r\n\r\n      if (instance.state === 'connecting' || instance.state === 'open') {\r\n        await this.logout({ instanceName });\r\n      }\r\n\r\n      try {\r\n        waInstances?.sendDataWebhook(Events.INSTANCE_DELETE, {\r\n          instanceName,\r\n          instanceId: waInstances.instanceId,\r\n        });\r\n      } catch (error) {\r\n        this.logger.error(error);\r\n      }\r\n\r\n      this.eventEmitter.emit('remove.instance', instanceName, 'inner');\r\n      return { status: 'SUCCESS', error: false, response: { message: 'Instance deleted' } };\r\n    } catch (error) {\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n}\r\n","import crypto from 'crypto';\nconst rnds8Pool = new Uint8Array(256); // # of random values to pre-allocate\n\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n  if (poolPtr > rnds8Pool.length - 16) {\n    crypto.randomFillSync(rnds8Pool);\n    poolPtr = 0;\n  }\n\n  return rnds8Pool.slice(poolPtr, poolPtr += 16);\n}","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]];\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import crypto from 'crypto';\nexport default {\n  randomUUID: crypto.randomUUID\n};","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { HandleLabelDto } from '@api/dto/label.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\n\r\nexport class LabelController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async fetchLabels({ instanceName }: InstanceDto) {\r\n    return await this.waMonitor.waInstances[instanceName].fetchLabels();\r\n  }\r\n\r\n  public async handleLabel({ instanceName }: InstanceDto, data: HandleLabelDto) {\r\n    return await this.waMonitor.waInstances[instanceName].handleLabel(data);\r\n  }\r\n}\r\n","import { HttpsProxyAgent } from 'https-proxy-agent';\r\n\r\ntype Proxy = {\r\n  host: string;\r\n  password?: string;\r\n  port: string;\r\n  protocol: string;\r\n  username?: string;\r\n};\r\n\r\nexport function makeProxyAgent(proxy: Proxy | string) {\r\n  if (typeof proxy === 'string') {\r\n    return new HttpsProxyAgent(proxy);\r\n  }\r\n\r\n  const { host, password, port, protocol, username } = proxy;\r\n  let proxyUrl = `${protocol}://${host}:${port}`;\r\n\r\n  if (username && password) {\r\n    proxyUrl = `${protocol}://${username}:${password}@${host}:${port}`;\r\n  }\r\n  return new HttpsProxyAgent(proxyUrl);\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProxyDto } from '@api/dto/proxy.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { ProxyService } from '@api/services/proxy.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException, NotFoundException } from '@exceptions';\r\nimport { makeProxyAgent } from '@utils/makeProxyAgent';\r\nimport axios from 'axios';\r\n\r\nconst logger = new Logger('ProxyController');\r\n\r\nexport class ProxyController {\r\n  constructor(\r\n    private readonly proxyService: ProxyService,\r\n    private readonly waMonitor: WAMonitoringService,\r\n  ) {}\r\n\r\n  public async createProxy(instance: InstanceDto, data: ProxyDto) {\r\n    if (!this.waMonitor.waInstances[instance.instanceName]) {\r\n      throw new NotFoundException(`The \"${instance.instanceName}\" instance does not exist`);\r\n    }\r\n\r\n    if (!data?.enabled) {\r\n      data.host = '';\r\n      data.port = '';\r\n      data.protocol = '';\r\n      data.username = '';\r\n      data.password = '';\r\n    }\r\n\r\n    if (data.host) {\r\n      const testProxy = await this.testProxy(data);\r\n      if (!testProxy) {\r\n        throw new BadRequestException('Invalid proxy');\r\n      }\r\n    }\r\n\r\n    return this.proxyService.create(instance, data);\r\n  }\r\n\r\n  public async findProxy(instance: InstanceDto) {\r\n    if (!this.waMonitor.waInstances[instance.instanceName]) {\r\n      throw new NotFoundException(`The \"${instance.instanceName}\" instance does not exist`);\r\n    }\r\n\r\n    return this.proxyService.find(instance);\r\n  }\r\n\r\n  public async testProxy(proxy: ProxyDto) {\r\n    try {\r\n      const serverIp = await axios.get('https://icanhazip.com/');\r\n      const response = await axios.get('https://icanhazip.com/', {\r\n        httpsAgent: makeProxyAgent(proxy),\r\n      });\r\n\r\n      return response?.data !== serverIp?.data;\r\n    } catch (error) {\r\n      if (axios.isAxiosError(error) && error.response?.data) {\r\n        logger.error('testProxy error: ' + error.response.data);\r\n      } else if (axios.isAxiosError(error)) {\r\n        logger.error('testProxy error: ');\r\n      } else {\r\n        logger.error('testProxy error: ');\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport {\r\n  SendAudioDto,\r\n  SendButtonsDto,\r\n  SendContactDto,\r\n  SendListDto,\r\n  SendLocationDto,\r\n  SendMediaDto,\r\n  SendPollDto,\r\n  SendPtvDto,\r\n  SendReactionDto,\r\n  SendStatusDto,\r\n  SendStickerDto,\r\n  SendTemplateDto,\r\n  SendTextDto,\r\n} from '@api/dto/sendMessage.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { isBase64, isURL } from 'class-validator';\r\n\r\nexport class SendMessageController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async sendTemplate({ instanceName }: InstanceDto, data: SendTemplateDto) {\r\n    return await this.waMonitor.waInstances[instanceName].templateMessage(data);\r\n  }\r\n\r\n  public async sendText({ instanceName }: InstanceDto, data: SendTextDto) {\r\n    return await this.waMonitor.waInstances[instanceName].textMessage(data);\r\n  }\r\n\r\n  public async sendMedia({ instanceName }: InstanceDto, data: SendMediaDto, file?: any) {\r\n    if (isBase64(data?.media) && !data?.fileName && data?.mediatype === 'document') {\r\n      throw new BadRequestException('For base64 the file name must be informed.');\r\n    }\r\n\r\n    if (file || isURL(data?.media) || isBase64(data?.media)) {\r\n      return await this.waMonitor.waInstances[instanceName].mediaMessage(data, file);\r\n    }\r\n    throw new BadRequestException('Owned media must be a url or base64');\r\n  }\r\n\r\n  public async sendPtv({ instanceName }: InstanceDto, data: SendPtvDto, file?: any) {\r\n    if (file || isURL(data?.video) || isBase64(data?.video)) {\r\n      return await this.waMonitor.waInstances[instanceName].ptvMessage(data, file);\r\n    }\r\n    throw new BadRequestException('Owned media must be a url or base64');\r\n  }\r\n\r\n  public async sendSticker({ instanceName }: InstanceDto, data: SendStickerDto, file?: any) {\r\n    if (file || isURL(data.sticker) || isBase64(data.sticker)) {\r\n      return await this.waMonitor.waInstances[instanceName].mediaSticker(data, file);\r\n    }\r\n    throw new BadRequestException('Owned media must be a url or base64');\r\n  }\r\n\r\n  public async sendWhatsAppAudio({ instanceName }: InstanceDto, data: SendAudioDto, file?: any) {\r\n    if (file?.buffer || isURL(data.audio) || isBase64(data.audio)) {\r\n      // Si file existe y tiene buffer, o si es una URL o Base64, contina\r\n      return await this.waMonitor.waInstances[instanceName].audioWhatsapp(data, file);\r\n    } else {\r\n      console.error('El archivo no tiene buffer o el audio no es una URL o Base64 vlida');\r\n      throw new BadRequestException('Owned media must be a url, base64, or valid file with buffer');\r\n    }\r\n  }\r\n\r\n  public async sendButtons({ instanceName }: InstanceDto, data: SendButtonsDto) {\r\n    return await this.waMonitor.waInstances[instanceName].buttonMessage(data);\r\n  }\r\n\r\n  public async sendLocation({ instanceName }: InstanceDto, data: SendLocationDto) {\r\n    return await this.waMonitor.waInstances[instanceName].locationMessage(data);\r\n  }\r\n\r\n  public async sendList({ instanceName }: InstanceDto, data: SendListDto) {\r\n    return await this.waMonitor.waInstances[instanceName].listMessage(data);\r\n  }\r\n\r\n  public async sendContact({ instanceName }: InstanceDto, data: SendContactDto) {\r\n    return await this.waMonitor.waInstances[instanceName].contactMessage(data);\r\n  }\r\n\r\n  public async sendReaction({ instanceName }: InstanceDto, data: SendReactionDto) {\r\n    if (!data.reaction.match(/[^()\\w\\s-\"-+]+/)) {\r\n      throw new BadRequestException('\"reaction\" must be an emoji');\r\n    }\r\n    return await this.waMonitor.waInstances[instanceName].reactionMessage(data);\r\n  }\r\n\r\n  public async sendPoll({ instanceName }: InstanceDto, data: SendPollDto) {\r\n    return await this.waMonitor.waInstances[instanceName].pollMessage(data);\r\n  }\r\n\r\n  public async sendStatus({ instanceName }: InstanceDto, data: SendStatusDto, file?: any) {\r\n    return await this.waMonitor.waInstances[instanceName].statusMessage(data, file);\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { SettingsDto } from '@api/dto/settings.dto';\r\nimport { SettingsService } from '@api/services/settings.service';\r\n\r\nexport class SettingsController {\r\n  constructor(private readonly settingsService: SettingsService) {}\r\n\r\n  public async createSettings(instance: InstanceDto, data: SettingsDto) {\r\n    return this.settingsService.create(instance, data);\r\n  }\r\n\r\n  public async findSettings(instance: InstanceDto) {\r\n    const settings = this.settingsService.find(instance);\r\n    return settings;\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { TemplateDto } from '@api/dto/template.dto';\r\nimport { TemplateService } from '@api/services/template.service';\r\n\r\nexport class TemplateController {\r\n  constructor(private readonly templateService: TemplateService) {}\r\n\r\n  public async createTemplate(instance: InstanceDto, data: TemplateDto) {\r\n    return this.templateService.create(instance, data);\r\n  }\r\n\r\n  public async findTemplate(instance: InstanceDto) {\r\n    return this.templateService.find(instance);\r\n  }\r\n}\r\n","import { ConfigService, S3 } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport * as MinIo from 'minio';\r\nimport { join } from 'path';\r\nimport { Readable, Transform } from 'stream';\r\n\r\nconst logger = new Logger('S3 Service');\r\n\r\nconst BUCKET = new ConfigService().get<S3>('S3');\r\n\r\ninterface Metadata extends MinIo.ItemBucketMetadata {\r\n  'Content-Type': string;\r\n}\r\n\r\nconst minioClient = (() => {\r\n  if (BUCKET?.ENABLE) {\r\n    return new MinIo.Client({\r\n      endPoint: BUCKET.ENDPOINT,\r\n      port: BUCKET.PORT,\r\n      useSSL: BUCKET.USE_SSL,\r\n      accessKey: BUCKET.ACCESS_KEY,\r\n      secretKey: BUCKET.SECRET_KEY,\r\n      region: BUCKET.REGION,\r\n    });\r\n  }\r\n})();\r\n\r\nconst bucketName = process.env.S3_BUCKET;\r\n\r\nconst bucketExists = async () => {\r\n  if (minioClient) {\r\n    try {\r\n      const list = await minioClient.listBuckets();\r\n      return list.find((bucket) => bucket.name === bucketName);\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n};\r\n\r\nconst setBucketPolicy = async () => {\r\n  if (minioClient) {\r\n    const policy = {\r\n      Version: '2012-10-17',\r\n      Statement: [\r\n        {\r\n          Effect: 'Allow',\r\n          Principal: '*',\r\n          Action: ['s3:GetObject'],\r\n          Resource: [`arn:aws:s3:::${bucketName}/*`],\r\n        },\r\n      ],\r\n    };\r\n    await minioClient.setBucketPolicy(bucketName, JSON.stringify(policy));\r\n  }\r\n};\r\n\r\nconst createBucket = async () => {\r\n  if (minioClient) {\r\n    try {\r\n      const exists = await bucketExists();\r\n      if (!exists) {\r\n        await minioClient.makeBucket(bucketName);\r\n      }\r\n\r\n      await setBucketPolicy();\r\n\r\n      logger.info(`S3 Bucket ${bucketName} - ON`);\r\n      return true;\r\n    } catch (error) {\r\n      logger.error('S3 ERROR:');\r\n      logger.error(error);\r\n      return false;\r\n    }\r\n  }\r\n};\r\n\r\ncreateBucket();\r\n\r\nconst uploadFile = async (fileName: string, file: Buffer | Transform | Readable, size: number, metadata: Metadata) => {\r\n  if (minioClient) {\r\n    const objectName = join('evolution-api', fileName);\r\n    try {\r\n      metadata['custom-header-application'] = 'evolution-api';\r\n      return await minioClient.putObject(bucketName, objectName, file, size, metadata);\r\n    } catch (error) {\r\n      logger.error(error);\r\n      return error;\r\n    }\r\n  }\r\n};\r\n\r\nconst getObjectUrl = async (fileName: string, expiry?: number) => {\r\n  if (minioClient) {\r\n    try {\r\n      const objectName = join('evolution-api', fileName);\r\n      if (expiry) {\r\n        return await minioClient.presignedGetObject(bucketName, objectName, expiry);\r\n      }\r\n      return await minioClient.presignedGetObject(bucketName, objectName);\r\n    } catch (error) {\r\n      throw new BadRequestException(error?.message);\r\n    }\r\n  }\r\n};\r\n\r\nconst uploadTempFile = async (\r\n  folder: string,\r\n  fileName: string,\r\n  file: Buffer | Transform | Readable,\r\n  size: number,\r\n  metadata: Metadata,\r\n) => {\r\n  if (minioClient) {\r\n    const objectName = join(folder, fileName);\r\n    try {\r\n      metadata['custom-header-application'] = 'evolution-api';\r\n      return await minioClient.putObject(bucketName, objectName, file, size, metadata);\r\n    } catch (error) {\r\n      logger.error(error);\r\n      return error;\r\n    }\r\n  }\r\n};\r\n\r\nconst deleteFile = async (folder: string, fileName: string) => {\r\n  if (minioClient) {\r\n    const objectName = join(folder, fileName);\r\n    try {\r\n      return await minioClient.removeObject(bucketName, objectName);\r\n    } catch (error) {\r\n      logger.error(error);\r\n      return error;\r\n    }\r\n  }\r\n};\r\n\r\nexport { BUCKET, deleteFile, getObjectUrl, uploadFile, uploadTempFile };\r\n","import { Chatwoot, configService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport postgresql from 'pg';\r\n\r\nconst { Pool } = postgresql;\r\n\r\nclass Postgres {\r\n  private logger = new Logger('Postgres');\r\n  private pool;\r\n  private connected = false;\r\n\r\n  getConnection(connectionString: string) {\r\n    if (this.connected) {\r\n      return this.pool;\r\n    } else {\r\n      this.pool = new Pool({\r\n        connectionString,\r\n        ssl: {\r\n          rejectUnauthorized: false,\r\n        },\r\n      });\r\n\r\n      this.pool.on('error', () => {\r\n        this.logger.error('postgres disconnected');\r\n        this.connected = false;\r\n      });\r\n\r\n      try {\r\n        this.connected = true;\r\n      } catch (e) {\r\n        this.connected = false;\r\n        this.logger.error('postgres connect exception caught: ' + e);\r\n        return null;\r\n      }\r\n\r\n      return this.pool;\r\n    }\r\n  }\r\n\r\n  getChatwootConnection() {\r\n    const uri = configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\r\n\r\n    return this.getConnection(uri);\r\n  }\r\n}\r\n\r\nexport const postgresClient = new Postgres();\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { postgresClient } from '@api/integrations/chatbot/chatwoot/libs/postgres.client';\r\nimport { ChatwootService } from '@api/integrations/chatbot/chatwoot/services/chatwoot.service';\r\nimport { Chatwoot, configService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { inbox } from '@figuro/chatwoot-sdk';\r\nimport { Chatwoot as ChatwootModel, Contact, Message } from '@prisma/client';\r\nimport { proto } from 'baileys';\r\n\r\ntype ChatwootUser = {\r\n  user_type: string;\r\n  user_id: number;\r\n};\r\n\r\ntype FksChatwoot = {\r\n  phone_number: string;\r\n  contact_id: string;\r\n  conversation_id: string;\r\n};\r\n\r\ntype firstLastTimestamp = {\r\n  first: number;\r\n  last: number;\r\n};\r\n\r\ntype IWebMessageInfo = Omit<proto.IWebMessageInfo, 'key'> & Partial<Pick<proto.IWebMessageInfo, 'key'>>;\r\n\r\nclass ChatwootImport {\r\n  private logger = new Logger('ChatwootImport');\r\n  private repositoryMessagesCache = new Map<string, Set<string>>();\r\n  private historyMessages = new Map<string, Message[]>();\r\n  private historyContacts = new Map<string, Contact[]>();\r\n\r\n  public getRepositoryMessagesCache(instance: InstanceDto) {\r\n    return this.repositoryMessagesCache.has(instance.instanceName)\r\n      ? this.repositoryMessagesCache.get(instance.instanceName)\r\n      : null;\r\n  }\r\n\r\n  public setRepositoryMessagesCache(instance: InstanceDto, repositoryMessagesCache: Set<string>) {\r\n    this.repositoryMessagesCache.set(instance.instanceName, repositoryMessagesCache);\r\n  }\r\n\r\n  public deleteRepositoryMessagesCache(instance: InstanceDto) {\r\n    this.repositoryMessagesCache.delete(instance.instanceName);\r\n  }\r\n\r\n  public addHistoryMessages(instance: InstanceDto, messagesRaw: Message[]) {\r\n    const actualValue = this.historyMessages.has(instance.instanceName)\r\n      ? this.historyMessages.get(instance.instanceName)\r\n      : [];\r\n    this.historyMessages.set(instance.instanceName, [...actualValue, ...messagesRaw]);\r\n  }\r\n\r\n  public addHistoryContacts(instance: InstanceDto, contactsRaw: Contact[]) {\r\n    const actualValue = this.historyContacts.has(instance.instanceName)\r\n      ? this.historyContacts.get(instance.instanceName)\r\n      : [];\r\n    this.historyContacts.set(instance.instanceName, actualValue.concat(contactsRaw));\r\n  }\r\n\r\n  public deleteHistoryMessages(instance: InstanceDto) {\r\n    this.historyMessages.delete(instance.instanceName);\r\n  }\r\n\r\n  public deleteHistoryContacts(instance: InstanceDto) {\r\n    this.historyContacts.delete(instance.instanceName);\r\n  }\r\n\r\n  public clearAll(instance: InstanceDto) {\r\n    this.deleteRepositoryMessagesCache(instance);\r\n    this.deleteHistoryMessages(instance);\r\n    this.deleteHistoryContacts(instance);\r\n  }\r\n\r\n  public getHistoryMessagesLenght(instance: InstanceDto) {\r\n    return this.historyMessages.get(instance.instanceName)?.length ?? 0;\r\n  }\r\n\r\n  public async importHistoryContacts(instance: InstanceDto, provider: ChatwootDto) {\r\n    try {\r\n      if (this.getHistoryMessagesLenght(instance) > 0) {\r\n        return;\r\n      }\r\n\r\n      const pgClient = postgresClient.getChatwootConnection();\r\n\r\n      let totalContactsImported = 0;\r\n\r\n      const contacts = this.historyContacts.get(instance.instanceName) || [];\r\n      if (contacts.length === 0) {\r\n        return 0;\r\n      }\r\n\r\n      let contactsChunk: Contact[] = this.sliceIntoChunks(contacts, 3000);\r\n      while (contactsChunk.length > 0) {\r\n        const labelSql = `SELECT id FROM labels WHERE title = '${provider.nameInbox}' AND account_id = ${provider.accountId} LIMIT 1`;\r\n\r\n        let labelId = (await pgClient.query(labelSql))?.rows[0]?.id;\r\n\r\n        if (!labelId) {\r\n          // creating label in chatwoot db and getting the id\r\n          const sqlLabel = `INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${provider.nameInbox}', '#34039B', true, ${provider.accountId}, NOW(), NOW()) RETURNING id`;\r\n\r\n          labelId = (await pgClient.query(sqlLabel))?.rows[0]?.id;\r\n        }\r\n\r\n        // inserting contacts in chatwoot db\r\n        let sqlInsert = `INSERT INTO contacts\r\n          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `;\r\n        const bindInsert = [provider.accountId];\r\n\r\n        for (const contact of contactsChunk) {\r\n          bindInsert.push(contact.pushName);\r\n          const bindName = `$${bindInsert.length}`;\r\n\r\n          bindInsert.push(`+${contact.remoteJid.split('@')[0]}`);\r\n          const bindPhoneNumber = `$${bindInsert.length}`;\r\n\r\n          bindInsert.push(contact.remoteJid);\r\n          const bindIdentifier = `$${bindInsert.length}`;\r\n\r\n          sqlInsert += `(${bindName}, ${bindPhoneNumber}, $1, ${bindIdentifier}, NOW(), NOW()),`;\r\n        }\r\n        if (sqlInsert.slice(-1) === ',') {\r\n          sqlInsert = sqlInsert.slice(0, -1);\r\n        }\r\n        sqlInsert += ` ON CONFLICT (identifier, account_id)\r\n                       DO UPDATE SET\r\n                        name = EXCLUDED.name,\r\n                        phone_number = EXCLUDED.phone_number,\r\n                        identifier = EXCLUDED.identifier`;\r\n\r\n        totalContactsImported += (await pgClient.query(sqlInsert, bindInsert))?.rowCount ?? 0;\r\n\r\n        const sqlTags = `SELECT id FROM tags WHERE name = '${provider.nameInbox}' LIMIT 1`;\r\n\r\n        const tagData = (await pgClient.query(sqlTags))?.rows[0];\r\n        let tagId = tagData?.id;\r\n\r\n        const sqlTag = `INSERT INTO tags (name, taggings_count) VALUES ('${provider.nameInbox}', ${totalContactsImported}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${totalContactsImported} RETURNING id`;\r\n\r\n        tagId = (await pgClient.query(sqlTag))?.rows[0]?.id;\r\n\r\n        await pgClient.query(sqlTag);\r\n\r\n        let sqlInsertLabel = `INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES `;\r\n\r\n        contactsChunk.forEach((contact) => {\r\n          const bindTaggableId = `(SELECT id FROM contacts WHERE identifier = '${contact.remoteJid}' AND account_id = ${provider.accountId})`;\r\n          sqlInsertLabel += `($1, $2, ${bindTaggableId}, $3, NOW()),`;\r\n        });\r\n\r\n        if (sqlInsertLabel.slice(-1) === ',') {\r\n          sqlInsertLabel = sqlInsertLabel.slice(0, -1);\r\n        }\r\n\r\n        await pgClient.query(sqlInsertLabel, [tagId, 'Contact', 'labels']);\r\n\r\n        contactsChunk = this.sliceIntoChunks(contacts, 3000);\r\n      }\r\n\r\n      this.deleteHistoryContacts(instance);\r\n\r\n      return totalContactsImported;\r\n    } catch (error) {\r\n      this.logger.error(`Error on import history contacts: ${error.toString()}`);\r\n    }\r\n  }\r\n\r\n  public async getExistingSourceIds(sourceIds: string[]): Promise<Set<string>> {\r\n    try {\r\n      const existingSourceIdsSet = new Set<string>();\r\n\r\n      if (sourceIds.length === 0) {\r\n        return existingSourceIdsSet;\r\n      }\r\n\r\n      const formattedSourceIds = sourceIds.map((sourceId) => `WAID:${sourceId.replace('WAID:', '')}`); // Make sure the sourceId is always formatted as WAID:1234567890\r\n      const query = 'SELECT source_id FROM messages WHERE source_id = ANY($1)';\r\n      const pgClient = postgresClient.getChatwootConnection();\r\n      const result = await pgClient.query(query, [formattedSourceIds]);\r\n\r\n      for (const row of result.rows) {\r\n        existingSourceIdsSet.add(row.source_id);\r\n      }\r\n\r\n      return existingSourceIdsSet;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  public async importHistoryMessages(\r\n    instance: InstanceDto,\r\n    chatwootService: ChatwootService,\r\n    inbox: inbox,\r\n    provider: ChatwootModel,\r\n  ) {\r\n    try {\r\n      const pgClient = postgresClient.getChatwootConnection();\r\n\r\n      const chatwootUser = await this.getChatwootUser(provider);\r\n      if (!chatwootUser) {\r\n        throw new Error('User not found to import messages.');\r\n      }\r\n\r\n      let totalMessagesImported = 0;\r\n\r\n      let messagesOrdered = this.historyMessages.get(instance.instanceName) || [];\r\n      if (messagesOrdered.length === 0) {\r\n        return 0;\r\n      }\r\n\r\n      // ordering messages by number and timestamp asc\r\n      messagesOrdered.sort((a, b) => {\r\n        const aKey = a.key as {\r\n          remoteJid: string;\r\n        };\r\n\r\n        const bKey = b.key as {\r\n          remoteJid: string;\r\n        };\r\n\r\n        const aMessageTimestamp = a.messageTimestamp as any as number;\r\n        const bMessageTimestamp = b.messageTimestamp as any as number;\r\n\r\n        return parseInt(aKey.remoteJid) - parseInt(bKey.remoteJid) || aMessageTimestamp - bMessageTimestamp;\r\n      });\r\n\r\n      const allMessagesMappedByPhoneNumber = this.createMessagesMapByPhoneNumber(messagesOrdered);\r\n      // Map structure: +552199999999 => { first message timestamp from number, last message timestamp from number}\r\n      const phoneNumbersWithTimestamp = new Map<string, firstLastTimestamp>();\r\n      allMessagesMappedByPhoneNumber.forEach((messages: Message[], phoneNumber: string) => {\r\n        phoneNumbersWithTimestamp.set(phoneNumber, {\r\n          first: messages[0]?.messageTimestamp as any as number,\r\n          last: messages[messages.length - 1]?.messageTimestamp as any as number,\r\n        });\r\n      });\r\n\r\n      const existingSourceIds = await this.getExistingSourceIds(messagesOrdered.map((message: any) => message.key.id));\r\n      messagesOrdered = messagesOrdered.filter((message: any) => !existingSourceIds.has(message.key.id));\r\n      // processing messages in batch\r\n      const batchSize = 4000;\r\n      let messagesChunk: Message[] = this.sliceIntoChunks(messagesOrdered, batchSize);\r\n      while (messagesChunk.length > 0) {\r\n        // Map structure: +552199999999 => Message[]\r\n        const messagesByPhoneNumber = this.createMessagesMapByPhoneNumber(messagesChunk);\r\n\r\n        if (messagesByPhoneNumber.size > 0) {\r\n          const fksByNumber = await this.selectOrCreateFksFromChatwoot(\r\n            provider,\r\n            inbox,\r\n            phoneNumbersWithTimestamp,\r\n            messagesByPhoneNumber,\r\n          );\r\n\r\n          // inserting messages in chatwoot db\r\n          let sqlInsertMsg = `INSERT INTO messages\r\n            (content, processed_message_content, account_id, inbox_id, conversation_id, message_type, private, content_type,\r\n            sender_type, sender_id, source_id, created_at, updated_at) VALUES `;\r\n          const bindInsertMsg = [provider.accountId, inbox.id];\r\n\r\n          messagesByPhoneNumber.forEach((messages: any[], phoneNumber: string) => {\r\n            const fksChatwoot = fksByNumber.get(phoneNumber);\r\n\r\n            messages.forEach((message) => {\r\n              if (!message.message) {\r\n                return;\r\n              }\r\n\r\n              if (!fksChatwoot?.conversation_id || !fksChatwoot?.contact_id) {\r\n                return;\r\n              }\r\n\r\n              const contentMessage = this.getContentMessage(chatwootService, message);\r\n              if (!contentMessage) {\r\n                return;\r\n              }\r\n\r\n              bindInsertMsg.push(contentMessage);\r\n              const bindContent = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push(fksChatwoot.conversation_id);\r\n              const bindConversationId = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push(message.key.fromMe ? '1' : '0');\r\n              const bindMessageType = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push(message.key.fromMe ? chatwootUser.user_type : 'Contact');\r\n              const bindSenderType = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push(message.key.fromMe ? chatwootUser.user_id : fksChatwoot.contact_id);\r\n              const bindSenderId = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push('WAID:' + message.key.id);\r\n              const bindSourceId = `$${bindInsertMsg.length}`;\r\n\r\n              bindInsertMsg.push(message.messageTimestamp as number);\r\n              const bindmessageTimestamp = `$${bindInsertMsg.length}`;\r\n\r\n              sqlInsertMsg += `(${bindContent}, ${bindContent}, $1, $2, ${bindConversationId}, ${bindMessageType}, FALSE, 0,\r\n                  ${bindSenderType},${bindSenderId},${bindSourceId}, to_timestamp(${bindmessageTimestamp}), to_timestamp(${bindmessageTimestamp})),`;\r\n            });\r\n          });\r\n          if (bindInsertMsg.length > 2) {\r\n            if (sqlInsertMsg.slice(-1) === ',') {\r\n              sqlInsertMsg = sqlInsertMsg.slice(0, -1);\r\n            }\r\n            totalMessagesImported += (await pgClient.query(sqlInsertMsg, bindInsertMsg))?.rowCount ?? 0;\r\n          }\r\n        }\r\n        messagesChunk = this.sliceIntoChunks(messagesOrdered, batchSize);\r\n      }\r\n\r\n      this.deleteHistoryMessages(instance);\r\n      this.deleteRepositoryMessagesCache(instance);\r\n\r\n      const providerData: ChatwootDto = {\r\n        ...provider,\r\n        ignoreJids: Array.isArray(provider.ignoreJids) ? provider.ignoreJids.map((event) => String(event)) : [],\r\n      };\r\n\r\n      this.importHistoryContacts(instance, providerData);\r\n\r\n      return totalMessagesImported;\r\n    } catch (error) {\r\n      this.logger.error(`Error on import history messages: ${error.toString()}`);\r\n\r\n      this.deleteHistoryMessages(instance);\r\n      this.deleteRepositoryMessagesCache(instance);\r\n    }\r\n  }\r\n\r\n  public async selectOrCreateFksFromChatwoot(\r\n    provider: ChatwootModel,\r\n    inbox: inbox,\r\n    phoneNumbersWithTimestamp: Map<string, firstLastTimestamp>,\r\n    messagesByPhoneNumber: Map<string, Message[]>,\r\n  ): Promise<Map<string, FksChatwoot>> {\r\n    const pgClient = postgresClient.getChatwootConnection();\r\n\r\n    const bindValues = [provider.accountId, inbox.id];\r\n    const phoneNumberBind = Array.from(messagesByPhoneNumber.keys())\r\n      .map((phoneNumber) => {\r\n        const phoneNumberTimestamp = phoneNumbersWithTimestamp.get(phoneNumber);\r\n\r\n        if (phoneNumberTimestamp) {\r\n          bindValues.push(phoneNumber);\r\n          let bindStr = `($${bindValues.length},`;\r\n\r\n          bindValues.push(phoneNumberTimestamp.first);\r\n          bindStr += `$${bindValues.length},`;\r\n\r\n          bindValues.push(phoneNumberTimestamp.last);\r\n          return `${bindStr}$${bindValues.length})`;\r\n        }\r\n      })\r\n      .join(',');\r\n\r\n    // select (or insert when necessary) data from tables contacts, contact_inboxes, conversations from chatwoot db\r\n    const sqlFromChatwoot = `WITH\r\n              phone_number AS (\r\n                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (\r\n                  VALUES \r\n                   ${phoneNumberBind}\r\n                 ) as t (phone_number, created_at, last_activity_at)\r\n              ),\r\n\r\n              only_new_phone_number AS (\r\n                SELECT * FROM phone_number\r\n                WHERE phone_number NOT IN (\r\n                  SELECT phone_number\r\n                  FROM contacts\r\n                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2\r\n                    JOIN conversations con ON con.contact_inbox_id = ci.id \r\n                      AND con.account_id = $1\r\n                      AND con.inbox_id = $2\r\n                      AND con.contact_id = contacts.id\r\n                  WHERE contacts.account_id = $1\r\n                )\r\n              ),\r\n\r\n              new_contact AS (\r\n                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)\r\n                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),\r\n                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)\r\n                FROM only_new_phone_number AS p\r\n                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at\r\n                RETURNING id, phone_number, created_at, updated_at\r\n              ),\r\n\r\n              new_contact_inbox AS (\r\n                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)\r\n                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at\r\n                FROM new_contact \r\n                RETURNING id, contact_id, created_at, updated_at\r\n              ),\r\n\r\n              new_conversation AS (\r\n                INSERT INTO conversations (account_id, inbox_id, status, contact_id,\r\n                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)\r\n                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),\r\n                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at\r\n                FROM new_contact_inbox\r\n                RETURNING id, contact_id\r\n              )\r\n\r\n              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id\r\n              FROM new_conversation \r\n              JOIN new_contact ON new_conversation.contact_id = new_contact.id\r\n\r\n              UNION\r\n\r\n              SELECT p.phone_number, c.id contact_id, con.id conversation_id\r\n                FROM phone_number p\r\n              JOIN contacts c ON c.phone_number = p.phone_number\r\n              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2\r\n              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1\r\n                AND con.inbox_id = $2 AND con.contact_id = c.id`;\r\n\r\n    const fksFromChatwoot = await pgClient.query(sqlFromChatwoot, bindValues);\r\n\r\n    return new Map(fksFromChatwoot.rows.map((item: FksChatwoot) => [item.phone_number, item]));\r\n  }\r\n\r\n  public async getChatwootUser(provider: ChatwootModel): Promise<ChatwootUser> {\r\n    try {\r\n      const pgClient = postgresClient.getChatwootConnection();\r\n\r\n      const sqlUser = `SELECT owner_type AS user_type, owner_id AS user_id\r\n                         FROM access_tokens\r\n                       WHERE token = $1`;\r\n\r\n      return (await pgClient.query(sqlUser, [provider.token]))?.rows[0] || false;\r\n    } catch (error) {\r\n      this.logger.error(`Error on getChatwootUser: ${error.toString()}`);\r\n    }\r\n  }\r\n\r\n  public createMessagesMapByPhoneNumber(messages: Message[]): Map<string, Message[]> {\r\n    return messages.reduce((acc: Map<string, Message[]>, message: Message) => {\r\n      const key = message?.key as {\r\n        remoteJid: string;\r\n      };\r\n      if (!this.isIgnorePhoneNumber(key?.remoteJid)) {\r\n        const phoneNumber = key?.remoteJid?.split('@')[0];\r\n        if (phoneNumber) {\r\n          const phoneNumberPlus = `+${phoneNumber}`;\r\n          const messages = acc.has(phoneNumberPlus) ? acc.get(phoneNumberPlus) : [];\r\n          messages.push(message);\r\n          acc.set(phoneNumberPlus, messages);\r\n        }\r\n      }\r\n\r\n      return acc;\r\n    }, new Map());\r\n  }\r\n\r\n  public async getContactsOrderByRecentConversations(\r\n    inbox: inbox,\r\n    provider: ChatwootModel,\r\n    limit = 50,\r\n  ): Promise<{ id: number; phone_number: string; identifier: string }[]> {\r\n    try {\r\n      const pgClient = postgresClient.getChatwootConnection();\r\n\r\n      const sql = `SELECT contacts.id, contacts.identifier, contacts.phone_number\r\n                     FROM conversations\r\n                   JOIN contacts ON contacts.id = conversations.contact_id\r\n                   WHERE conversations.account_id = $1\r\n                     AND inbox_id = $2\r\n                   ORDER BY conversations.last_activity_at DESC\r\n                   LIMIT $3`;\r\n\r\n      return (await pgClient.query(sql, [provider.accountId, inbox.id, limit]))?.rows;\r\n    } catch (error) {\r\n      this.logger.error(`Error on get recent conversations: ${error.toString()}`);\r\n    }\r\n  }\r\n\r\n  public getContentMessage(chatwootService: ChatwootService, msg: IWebMessageInfo) {\r\n    const contentMessage = chatwootService.getConversationMessage(msg.message);\r\n    if (contentMessage) {\r\n      return contentMessage;\r\n    }\r\n\r\n    if (!configService.get<Chatwoot>('CHATWOOT').IMPORT.PLACEHOLDER_MEDIA_MESSAGE) {\r\n      return '';\r\n    }\r\n\r\n    const types = {\r\n      documentMessage: msg.message.documentMessage,\r\n      documentWithCaptionMessage: msg.message.documentWithCaptionMessage?.message?.documentMessage,\r\n      imageMessage: msg.message.imageMessage,\r\n      videoMessage: msg.message.videoMessage,\r\n      audioMessage: msg.message.audioMessage,\r\n      stickerMessage: msg.message.stickerMessage,\r\n      templateMessage: msg.message.templateMessage?.hydratedTemplate?.hydratedContentText,\r\n    };\r\n    const typeKey = Object.keys(types).find((key) => types[key] !== undefined);\r\n\r\n    switch (typeKey) {\r\n      case 'documentMessage':\r\n        return `_<File: ${msg.message.documentMessage.fileName}${\r\n          msg.message.documentMessage.caption ? ` ${msg.message.documentMessage.caption}` : ''\r\n        }>_`;\r\n\r\n      case 'documentWithCaptionMessage':\r\n        return `_<File: ${msg.message.documentWithCaptionMessage.message.documentMessage.fileName}${\r\n          msg.message.documentWithCaptionMessage.message.documentMessage.caption\r\n            ? ` ${msg.message.documentWithCaptionMessage.message.documentMessage.caption}`\r\n            : ''\r\n        }>_`;\r\n\r\n      case 'templateMessage':\r\n        return msg.message.templateMessage.hydratedTemplate.hydratedTitleText\r\n          ? `*${msg.message.templateMessage.hydratedTemplate.hydratedTitleText}*\\\\n`\r\n          : '' + msg.message.templateMessage.hydratedTemplate.hydratedContentText;\r\n\r\n      case 'imageMessage':\r\n        return '_<Image Message>_';\r\n\r\n      case 'videoMessage':\r\n        return '_<Video Message>_';\r\n\r\n      case 'audioMessage':\r\n        return '_<Audio Message>_';\r\n\r\n      case 'stickerMessage':\r\n        return '_<Sticker Message>_';\r\n\r\n      default:\r\n        return '';\r\n    }\r\n  }\r\n\r\n  public sliceIntoChunks(arr: any[], chunkSize: number) {\r\n    return arr.splice(0, chunkSize);\r\n  }\r\n\r\n  public isGroup(remoteJid: string) {\r\n    return remoteJid.includes('@g.us');\r\n  }\r\n\r\n  public isIgnorePhoneNumber(remoteJid: string) {\r\n    return this.isGroup(remoteJid) || remoteJid === 'status@broadcast' || remoteJid === '0@s.whatsapp.net';\r\n  }\r\n\r\n  public updateMessageSourceID(messageId: string | number, sourceId: string) {\r\n    const pgClient = postgresClient.getChatwootConnection();\r\n\r\n    const sql = `UPDATE messages SET source_id = $1, status = 0, created_at = NOW(), updated_at = NOW() WHERE id = $2;`;\r\n\r\n    return pgClient.query(sql, [`WAID:${sourceId}`, messageId]);\r\n  }\r\n}\r\n\r\nexport const chatwootImport = new ChatwootImport();\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { Options, Quoted, SendAudioDto, SendMediaDto, SendTextDto } from '@api/dto/sendMessage.dto';\r\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { postgresClient } from '@api/integrations/chatbot/chatwoot/libs/postgres.client';\r\nimport { chatwootImport } from '@api/integrations/chatbot/chatwoot/utils/chatwoot-import-helper';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Events } from '@api/types/wa.types';\r\nimport { Chatwoot, ConfigService, Database, HttpServer } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport ChatwootClient, {\r\n  ChatwootAPIConfig,\r\n  contact,\r\n  contact_inboxes,\r\n  conversation,\r\n  conversation_show,\r\n  generic_id,\r\n  inbox,\r\n} from '@figuro/chatwoot-sdk';\r\nimport { request as chatwootRequest } from '@figuro/chatwoot-sdk/dist/core/request';\r\nimport { Chatwoot as ChatwootModel, Contact as ContactModel, Message as MessageModel } from '@prisma/client';\r\nimport i18next from '@utils/i18n';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\nimport { proto } from 'baileys';\r\nimport dayjs from 'dayjs';\r\nimport FormData from 'form-data';\r\nimport Jimp from 'jimp';\r\nimport Long from 'long';\r\nimport mimeTypes from 'mime-types';\r\nimport path from 'path';\r\nimport { Readable } from 'stream';\r\n\r\ninterface ChatwootMessage {\r\n  messageId?: number;\r\n  inboxId?: number;\r\n  conversationId?: number;\r\n  contactInboxSourceId?: string;\r\n  isRead?: boolean;\r\n}\r\n\r\nexport class ChatwootService {\r\n  private readonly logger = new Logger('ChatwootService');\r\n\r\n  private provider: any;\r\n\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n    private readonly cache: CacheService,\r\n  ) {}\r\n\r\n  private pgClient = postgresClient.getChatwootConnection();\r\n\r\n  private async getProvider(instance: InstanceDto): Promise<ChatwootModel | null> {\r\n    const cacheKey = `${instance.instanceName}:getProvider`;\r\n    if (await this.cache.has(cacheKey)) {\r\n      const provider = (await this.cache.get(cacheKey)) as ChatwootModel;\r\n\r\n      return provider;\r\n    }\r\n\r\n    const provider = await this.waMonitor.waInstances[instance.instanceName]?.findChatwoot();\r\n\r\n    if (!provider) {\r\n      this.logger.warn('provider not found');\r\n      return null;\r\n    }\r\n\r\n    this.cache.set(cacheKey, provider);\r\n\r\n    return provider;\r\n  }\r\n\r\n  private async clientCw(instance: InstanceDto) {\r\n    const provider = await this.getProvider(instance);\r\n\r\n    if (!provider) {\r\n      this.logger.error('provider not found');\r\n      return null;\r\n    }\r\n\r\n    this.provider = provider;\r\n\r\n    const client = new ChatwootClient({\r\n      config: this.getClientCwConfig(),\r\n    });\r\n\r\n    return client;\r\n  }\r\n\r\n  public getClientCwConfig(): ChatwootAPIConfig & { nameInbox: string; mergeBrazilContacts: boolean } {\r\n    return {\r\n      basePath: this.provider.url,\r\n      with_credentials: true,\r\n      credentials: 'include',\r\n      token: this.provider.token,\r\n      nameInbox: this.provider.nameInbox,\r\n      mergeBrazilContacts: this.provider.mergeBrazilContacts,\r\n    };\r\n  }\r\n\r\n  public getCache() {\r\n    return this.cache;\r\n  }\r\n\r\n  public async create(instance: InstanceDto, data: ChatwootDto) {\r\n    await this.waMonitor.waInstances[instance.instanceName].setChatwoot(data);\r\n\r\n    if (data.autoCreate) {\r\n      this.logger.log('Auto create chatwoot instance');\r\n      const urlServer = this.configService.get<HttpServer>('SERVER').URL;\r\n\r\n      await this.initInstanceChatwoot(\r\n        instance,\r\n        data.nameInbox ?? instance.instanceName.split('-cwId-')[0],\r\n        `${urlServer}/chatwoot/webhook/${encodeURIComponent(instance.instanceName)}`,\r\n        true,\r\n        data.number,\r\n        data.organization,\r\n        data.logo,\r\n      );\r\n    }\r\n    return data;\r\n  }\r\n\r\n  public async find(instance: InstanceDto): Promise<ChatwootDto> {\r\n    try {\r\n      return await this.waMonitor.waInstances[instance.instanceName].findChatwoot();\r\n    } catch (error) {\r\n      this.logger.error('chatwoot not found');\r\n      return { enabled: null, url: '' };\r\n    }\r\n  }\r\n\r\n  public async getContact(instance: InstanceDto, id: number) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    if (!id) {\r\n      this.logger.warn('id is required');\r\n      return null;\r\n    }\r\n\r\n    const contact = await client.contact.getContactable({\r\n      accountId: this.provider.accountId,\r\n      id,\r\n    });\r\n\r\n    if (!contact) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    return contact;\r\n  }\r\n\r\n  public async initInstanceChatwoot(\r\n    instance: InstanceDto,\r\n    inboxName: string,\r\n    webhookUrl: string,\r\n    qrcode: boolean,\r\n    number: string,\r\n    organization?: string,\r\n    logo?: string,\r\n  ) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    const findInbox: any = await client.inboxes.list({\r\n      accountId: this.provider.accountId,\r\n    });\r\n\r\n    const checkDuplicate = findInbox.payload.map((inbox) => inbox.name).includes(inboxName);\r\n\r\n    let inboxId: number;\r\n\r\n    this.logger.log('Creating chatwoot inbox');\r\n    if (!checkDuplicate) {\r\n      const data = {\r\n        type: 'api',\r\n        webhook_url: webhookUrl,\r\n      };\r\n\r\n      const inbox = await client.inboxes.create({\r\n        accountId: this.provider.accountId,\r\n        data: {\r\n          name: inboxName,\r\n          channel: data as any,\r\n        },\r\n      });\r\n\r\n      if (!inbox) {\r\n        this.logger.warn('inbox not found');\r\n        return null;\r\n      }\r\n\r\n      inboxId = inbox.id;\r\n    } else {\r\n      const inbox = findInbox.payload.find((inbox) => inbox.name === inboxName);\r\n\r\n      if (!inbox) {\r\n        this.logger.warn('inbox not found');\r\n        return null;\r\n      }\r\n\r\n      inboxId = inbox.id;\r\n    }\r\n    this.logger.log(`Inbox created - inboxId: ${inboxId}`);\r\n\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT) {\r\n      this.logger.log('Chatwoot bot contact is disabled');\r\n\r\n      return true;\r\n    }\r\n\r\n    this.logger.log('Creating chatwoot bot contact');\r\n    const contact =\r\n      (await this.findContact(instance, '123456')) ||\r\n      ((await this.createContact(\r\n        instance,\r\n        '123456',\r\n        inboxId,\r\n        false,\r\n        organization ? organization : 'EvolutionAPI',\r\n        logo ? logo : 'https://evolution-api.com/files/evolution-api-favicon.png',\r\n      )) as any);\r\n\r\n    if (!contact) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    const contactId = contact.id || contact.payload.contact.id;\r\n    this.logger.log(`Contact created - contactId: ${contactId}`);\r\n\r\n    if (qrcode) {\r\n      this.logger.log('QR code enabled');\r\n      const data = {\r\n        contact_id: contactId.toString(),\r\n        inbox_id: inboxId.toString(),\r\n      };\r\n\r\n      const conversation = await client.conversations.create({\r\n        accountId: this.provider.accountId,\r\n        data,\r\n      });\r\n\r\n      if (!conversation) {\r\n        this.logger.warn('conversation not found');\r\n        return null;\r\n      }\r\n\r\n      let contentMsg = 'init';\r\n\r\n      if (number) {\r\n        contentMsg = `init:${number}`;\r\n      }\r\n\r\n      const message = await client.messages.create({\r\n        accountId: this.provider.accountId,\r\n        conversationId: conversation.id,\r\n        data: {\r\n          content: contentMsg,\r\n          message_type: 'outgoing',\r\n        },\r\n      });\r\n\r\n      if (!message) {\r\n        this.logger.warn('conversation not found');\r\n        return null;\r\n      }\r\n      this.logger.log('Init message sent');\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public async createContact(\r\n    instance: InstanceDto,\r\n    phoneNumber: string,\r\n    inboxId: number,\r\n    isGroup: boolean,\r\n    name?: string,\r\n    avatar_url?: string,\r\n    jid?: string,\r\n  ) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    let data: any = {};\r\n    if (!isGroup) {\r\n      data = {\r\n        inbox_id: inboxId,\r\n        name: name || phoneNumber,\r\n        identifier: jid,\r\n        avatar_url: avatar_url,\r\n      };\r\n\r\n      if ((jid && jid.includes('@')) || !jid) {\r\n        data['phone_number'] = `+${phoneNumber}`;\r\n      }\r\n    } else {\r\n      data = {\r\n        inbox_id: inboxId,\r\n        name: name || phoneNumber,\r\n        identifier: phoneNumber,\r\n        avatar_url: avatar_url,\r\n      };\r\n    }\r\n\r\n    const contact = await client.contacts.create({\r\n      accountId: this.provider.accountId,\r\n      data,\r\n    });\r\n\r\n    if (!contact) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    const findContact = await this.findContact(instance, phoneNumber);\r\n\r\n    const contactId = findContact?.id;\r\n\r\n    await this.addLabelToContact(this.provider.nameInbox, contactId);\r\n\r\n    return contact;\r\n  }\r\n\r\n  public async updateContact(instance: InstanceDto, id: number, data: any) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    if (!id) {\r\n      this.logger.warn('id is required');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const contact = await client.contacts.update({\r\n        accountId: this.provider.accountId,\r\n        id,\r\n        data,\r\n      });\r\n\r\n      return contact;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  public async addLabelToContact(nameInbox: string, contactId: number) {\r\n    try {\r\n      const uri = this.configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\r\n\r\n      if (!uri) return false;\r\n\r\n      const sqlTags = `SELECT id, taggings_count FROM tags WHERE name = $1 LIMIT 1`;\r\n      const tagData = (await this.pgClient.query(sqlTags, [nameInbox]))?.rows[0];\r\n      let tagId = tagData?.id;\r\n      const taggingsCount = tagData?.taggings_count || 0;\r\n\r\n      const sqlTag = `INSERT INTO tags (name, taggings_count) \r\n                      VALUES ($1, $2) \r\n                      ON CONFLICT (name) \r\n                      DO UPDATE SET taggings_count = tags.taggings_count + 1 \r\n                      RETURNING id`;\r\n\r\n      tagId = (await this.pgClient.query(sqlTag, [nameInbox, taggingsCount + 1]))?.rows[0]?.id;\r\n\r\n      const sqlCheckTagging = `SELECT 1 FROM taggings \r\n                               WHERE tag_id = $1 AND taggable_type = 'Contact' AND taggable_id = $2 AND context = 'labels' LIMIT 1`;\r\n\r\n      const taggingExists = (await this.pgClient.query(sqlCheckTagging, [tagId, contactId]))?.rowCount > 0;\r\n\r\n      if (!taggingExists) {\r\n        const sqlInsertLabel = `INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) \r\n                                VALUES ($1, 'Contact', $2, 'labels', NOW())`;\r\n\r\n        await this.pgClient.query(sqlInsertLabel, [tagId, contactId]);\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public async findContact(instance: InstanceDto, phoneNumber: string) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    let query: any;\r\n    const isGroup = phoneNumber.includes('@g.us');\r\n\r\n    if (!isGroup) {\r\n      query = `+${phoneNumber}`;\r\n    } else {\r\n      query = phoneNumber;\r\n    }\r\n\r\n    let contact: any;\r\n\r\n    if (isGroup) {\r\n      contact = await client.contacts.search({\r\n        accountId: this.provider.accountId,\r\n        q: query,\r\n      });\r\n    } else {\r\n      contact = await chatwootRequest(this.getClientCwConfig(), {\r\n        method: 'POST',\r\n        url: `/api/v1/accounts/${this.provider.accountId}/contacts/filter`,\r\n        body: {\r\n          payload: this.getFilterPayload(query),\r\n        },\r\n      });\r\n    }\r\n\r\n    if (!contact && contact?.payload?.length === 0) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    if (!isGroup) {\r\n      return contact.payload.length > 1 ? this.findContactInContactList(contact.payload, query) : contact.payload[0];\r\n    } else {\r\n      return contact.payload.find((contact) => contact.identifier === query);\r\n    }\r\n  }\r\n\r\n  private async mergeBrazilianContacts(contacts: any[]) {\r\n    try {\r\n      const contact = await chatwootRequest(this.getClientCwConfig(), {\r\n        method: 'POST',\r\n        url: `/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,\r\n        body: {\r\n          base_contact_id: contacts.find((contact) => contact.phone_number.length === 14)?.id,\r\n          mergee_contact_id: contacts.find((contact) => contact.phone_number.length === 13)?.id,\r\n        },\r\n      });\r\n\r\n      return contact;\r\n    } catch {\r\n      this.logger.error('Error merging contacts');\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private findContactInContactList(contacts: any[], query: string) {\r\n    const phoneNumbers = this.getNumbers(query);\r\n    const searchableFields = this.getSearchableFields();\r\n\r\n    // eslint-disable-next-line prettier/prettier\r\n    if (contacts.length === 2 && this.getClientCwConfig().mergeBrazilContacts && query.startsWith('+55')) {\r\n      const contact = this.mergeBrazilianContacts(contacts);\r\n      if (contact) {\r\n        return contact;\r\n      }\r\n    }\r\n\r\n    const phone = phoneNumbers.reduce(\r\n      (savedNumber, number) => (number.length > savedNumber.length ? number : savedNumber),\r\n      '',\r\n    );\r\n\r\n    const contact_with9 = contacts.find((contact) => contact.phone_number === phone);\r\n    if (contact_with9) {\r\n      return contact_with9;\r\n    }\r\n\r\n    for (const contact of contacts) {\r\n      for (const field of searchableFields) {\r\n        if (contact[field] && phoneNumbers.includes(contact[field])) {\r\n          return contact;\r\n        }\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private getNumbers(query: string) {\r\n    const numbers = [];\r\n    numbers.push(query);\r\n\r\n    if (query.startsWith('+55') && query.length === 14) {\r\n      const withoutNine = query.slice(0, 5) + query.slice(6);\r\n      numbers.push(withoutNine);\r\n    } else if (query.startsWith('+55') && query.length === 13) {\r\n      const withNine = query.slice(0, 5) + '9' + query.slice(5);\r\n      numbers.push(withNine);\r\n    }\r\n\r\n    return numbers;\r\n  }\r\n\r\n  private getSearchableFields() {\r\n    return ['phone_number'];\r\n  }\r\n\r\n  private getFilterPayload(query: string) {\r\n    const filterPayload = [];\r\n\r\n    const numbers = this.getNumbers(query);\r\n    const fieldsToSearch = this.getSearchableFields();\r\n\r\n    fieldsToSearch.forEach((field, index1) => {\r\n      numbers.forEach((number, index2) => {\r\n        const queryOperator = fieldsToSearch.length - 1 === index1 && numbers.length - 1 === index2 ? null : 'OR';\r\n        filterPayload.push({\r\n          attribute_key: field,\r\n          filter_operator: 'equal_to',\r\n          values: [number.replace('+', '')],\r\n          query_operator: queryOperator,\r\n        });\r\n      });\r\n    });\r\n\r\n    return filterPayload;\r\n  }\r\n\r\n  public async createConversation(instance: InstanceDto, body: any) {\r\n    try {\r\n      this.logger.verbose('--- Start createConversation ---');\r\n      this.logger.verbose(`Instance: ${JSON.stringify(instance)}`);\r\n\r\n      const client = await this.clientCw(instance);\r\n\r\n      if (!client) {\r\n        this.logger.warn(`Client not found for instance: ${JSON.stringify(instance)}`);\r\n        return null;\r\n      }\r\n\r\n      const cacheKey = `${instance.instanceName}:createConversation-${body.key.remoteJid}`;\r\n      this.logger.verbose(`Cache key: ${cacheKey}`);\r\n\r\n      if (await this.cache.has(cacheKey)) {\r\n        this.logger.verbose(`Cache hit for key: ${cacheKey}`);\r\n        const conversationId = (await this.cache.get(cacheKey)) as number;\r\n        this.logger.verbose(`Cached conversation ID: ${conversationId}`);\r\n        let conversationExists: conversation | boolean;\r\n        try {\r\n          conversationExists = await client.conversations.get({\r\n            accountId: this.provider.accountId,\r\n            conversationId: conversationId,\r\n          });\r\n          this.logger.verbose(`Conversation exists: ${JSON.stringify(conversationExists)}`);\r\n        } catch (error) {\r\n          this.logger.error(`Error getting conversation: ${error}`);\r\n          conversationExists = false;\r\n        }\r\n        if (!conversationExists) {\r\n          this.logger.verbose('Conversation does not exist, re-calling createConversation');\r\n          this.cache.delete(cacheKey);\r\n          return await this.createConversation(instance, body);\r\n        }\r\n\r\n        return conversationId;\r\n      }\r\n\r\n      const isGroup = body.key.remoteJid.includes('@g.us');\r\n      this.logger.verbose(`Is group: ${isGroup}`);\r\n\r\n      const chatId = isGroup ? body.key.remoteJid : body.key.remoteJid.split('@')[0];\r\n      this.logger.verbose(`Chat ID: ${chatId}`);\r\n\r\n      let nameContact: string;\r\n\r\n      nameContact = !body.key.fromMe ? body.pushName : chatId;\r\n      this.logger.verbose(`Name contact: ${nameContact}`);\r\n\r\n      const filterInbox = await this.getInbox(instance);\r\n\r\n      if (!filterInbox) {\r\n        this.logger.warn(`Inbox not found for instance: ${JSON.stringify(instance)}`);\r\n        return null;\r\n      }\r\n\r\n      if (isGroup) {\r\n        this.logger.verbose('Processing group conversation');\r\n        const group = await this.waMonitor.waInstances[instance.instanceName].client.groupMetadata(chatId);\r\n        this.logger.verbose(`Group metadata: ${JSON.stringify(group)}`);\r\n\r\n        nameContact = `${group.subject} (GROUP)`;\r\n\r\n        const picture_url = await this.waMonitor.waInstances[instance.instanceName].profilePicture(\r\n          body.key.participant.split('@')[0],\r\n        );\r\n        this.logger.verbose(`Participant profile picture URL: ${JSON.stringify(picture_url)}`);\r\n\r\n        const findParticipant = await this.findContact(instance, body.key.participant.split('@')[0]);\r\n        this.logger.verbose(`Found participant: ${JSON.stringify(findParticipant)}`);\r\n\r\n        if (findParticipant) {\r\n          if (!findParticipant.name || findParticipant.name === chatId) {\r\n            await this.updateContact(instance, findParticipant.id, {\r\n              name: body.pushName,\r\n              avatar_url: picture_url.profilePictureUrl || null,\r\n            });\r\n          }\r\n        } else {\r\n          await this.createContact(\r\n            instance,\r\n            body.key.participant.split('@')[0],\r\n            filterInbox.id,\r\n            false,\r\n            body.pushName,\r\n            picture_url.profilePictureUrl || null,\r\n            body.key.participant,\r\n          );\r\n        }\r\n      }\r\n\r\n      const picture_url = await this.waMonitor.waInstances[instance.instanceName].profilePicture(chatId);\r\n      this.logger.verbose(`Contact profile picture URL: ${JSON.stringify(picture_url)}`);\r\n\r\n      let contact = await this.findContact(instance, chatId);\r\n      this.logger.verbose(`Found contact: ${JSON.stringify(contact)}`);\r\n\r\n      if (contact) {\r\n        if (!body.key.fromMe) {\r\n          const waProfilePictureFile =\r\n            picture_url?.profilePictureUrl?.split('#')[0].split('?')[0].split('/').pop() || '';\r\n          const chatwootProfilePictureFile = contact?.thumbnail?.split('#')[0].split('?')[0].split('/').pop() || '';\r\n          const pictureNeedsUpdate = waProfilePictureFile !== chatwootProfilePictureFile;\r\n          const nameNeedsUpdate =\r\n            !contact.name ||\r\n            contact.name === chatId ||\r\n            (`+${chatId}`.startsWith('+55')\r\n              ? this.getNumbers(`+${chatId}`).some(\r\n                  (v) => contact.name === v || contact.name === v.substring(3) || contact.name === v.substring(1),\r\n                )\r\n              : false);\r\n\r\n          this.logger.verbose(`Picture needs update: ${pictureNeedsUpdate}`);\r\n          this.logger.verbose(`Name needs update: ${nameNeedsUpdate}`);\r\n\r\n          if (pictureNeedsUpdate || nameNeedsUpdate) {\r\n            contact = await this.updateContact(instance, contact.id, {\r\n              ...(nameNeedsUpdate && { name: nameContact }),\r\n              ...(waProfilePictureFile === '' && { avatar: null }),\r\n              ...(pictureNeedsUpdate && { avatar_url: picture_url?.profilePictureUrl }),\r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        const jid = body.key.remoteJid;\r\n        contact = await this.createContact(\r\n          instance,\r\n          chatId,\r\n          filterInbox.id,\r\n          isGroup,\r\n          nameContact,\r\n          picture_url.profilePictureUrl || null,\r\n          jid,\r\n        );\r\n      }\r\n\r\n      if (!contact) {\r\n        this.logger.warn('Contact not created or found');\r\n        return null;\r\n      }\r\n\r\n      const contactId = contact?.payload?.id || contact?.payload?.contact?.id || contact?.id;\r\n      this.logger.verbose(`Contact ID: ${contactId}`);\r\n\r\n      const contactConversations = (await client.contacts.listConversations({\r\n        accountId: this.provider.accountId,\r\n        id: contactId,\r\n      })) as any;\r\n      this.logger.verbose(`Contact conversations: ${JSON.stringify(contactConversations)}`);\r\n\r\n      if (!contactConversations || !contactConversations.payload) {\r\n        this.logger.error('No conversations found or payload is undefined');\r\n        return null;\r\n      }\r\n\r\n      if (contactConversations.payload.length) {\r\n        let conversation: any;\r\n        if (this.provider.reopenConversation) {\r\n          conversation = contactConversations.payload.find((conversation) => conversation.inbox_id == filterInbox.id);\r\n          this.logger.verbose(`Found conversation in reopenConversation mode: ${JSON.stringify(conversation)}`);\r\n\r\n          if (this.provider.conversationPending && conversation.status !== 'open') {\r\n            if (conversation) {\r\n              await client.conversations.toggleStatus({\r\n                accountId: this.provider.accountId,\r\n                conversationId: conversation.id,\r\n                data: {\r\n                  status: 'pending',\r\n                },\r\n              });\r\n            }\r\n          }\r\n        } else {\r\n          conversation = contactConversations.payload.find(\r\n            (conversation) => conversation.status !== 'resolved' && conversation.inbox_id == filterInbox.id,\r\n          );\r\n          this.logger.verbose(`Found conversation: ${JSON.stringify(conversation)}`);\r\n        }\r\n\r\n        if (conversation) {\r\n          this.logger.verbose(`Returning existing conversation ID: ${conversation.id}`);\r\n          this.cache.set(cacheKey, conversation.id);\r\n          return conversation.id;\r\n        }\r\n      }\r\n\r\n      const data = {\r\n        contact_id: contactId.toString(),\r\n        inbox_id: filterInbox.id.toString(),\r\n      };\r\n\r\n      if (this.provider.conversationPending) {\r\n        data['status'] = 'pending';\r\n      }\r\n\r\n      const conversation = await client.conversations.create({\r\n        accountId: this.provider.accountId,\r\n        data,\r\n      });\r\n\r\n      if (!conversation) {\r\n        this.logger.warn('Conversation not created or found');\r\n        return null;\r\n      }\r\n\r\n      this.logger.verbose(`New conversation created with ID: ${conversation.id}`);\r\n      this.cache.set(cacheKey, conversation.id);\r\n      return conversation.id;\r\n    } catch (error) {\r\n      this.logger.error(`Error in createConversation: ${error}`);\r\n    }\r\n  }\r\n\r\n  public async getInbox(instance: InstanceDto): Promise<inbox | null> {\r\n    const cacheKey = `${instance.instanceName}:getInbox`;\r\n    if (await this.cache.has(cacheKey)) {\r\n      return (await this.cache.get(cacheKey)) as inbox;\r\n    }\r\n\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    const inbox = (await client.inboxes.list({\r\n      accountId: this.provider.accountId,\r\n    })) as any;\r\n\r\n    if (!inbox) {\r\n      this.logger.warn('inbox not found');\r\n      return null;\r\n    }\r\n\r\n    const findByName = inbox.payload.find((inbox) => inbox.name === this.getClientCwConfig().nameInbox);\r\n\r\n    if (!findByName) {\r\n      this.logger.warn('inbox not found');\r\n      return null;\r\n    }\r\n\r\n    this.cache.set(cacheKey, findByName);\r\n    return findByName;\r\n  }\r\n\r\n  public async createMessage(\r\n    instance: InstanceDto,\r\n    conversationId: number,\r\n    content: string,\r\n    messageType: 'incoming' | 'outgoing' | undefined,\r\n    privateMessage?: boolean,\r\n    attachments?: {\r\n      content: unknown;\r\n      encoding: string;\r\n      filename: string;\r\n    }[],\r\n    messageBody?: any,\r\n    sourceId?: string,\r\n    quotedMsg?: MessageModel,\r\n  ) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    const replyToIds = await this.getReplyToIds(messageBody, instance);\r\n\r\n    const sourceReplyId = quotedMsg?.chatwootMessageId || null;\r\n\r\n    const message = await client.messages.create({\r\n      accountId: this.provider.accountId,\r\n      conversationId: conversationId,\r\n      data: {\r\n        content: content,\r\n        message_type: messageType,\r\n        attachments: attachments,\r\n        private: privateMessage || false,\r\n        source_id: sourceId,\r\n        content_attributes: {\r\n          ...replyToIds,\r\n        },\r\n        source_reply_id: sourceReplyId ? sourceReplyId.toString() : null,\r\n      },\r\n    });\r\n\r\n    if (!message) {\r\n      this.logger.warn('message not found');\r\n      return null;\r\n    }\r\n\r\n    return message;\r\n  }\r\n\r\n  public async getOpenConversationByContact(\r\n    instance: InstanceDto,\r\n    inbox: inbox,\r\n    contact: generic_id & contact,\r\n  ): Promise<conversation> {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    const conversations = (await client.contacts.listConversations({\r\n      accountId: this.provider.accountId,\r\n      id: contact.id,\r\n    })) as any;\r\n\r\n    return (\r\n      conversations.payload.find(\r\n        (conversation) => conversation.inbox_id === inbox.id && conversation.status === 'open',\r\n      ) || undefined\r\n    );\r\n  }\r\n\r\n  public async createBotMessage(\r\n    instance: InstanceDto,\r\n    content: string,\r\n    messageType: 'incoming' | 'outgoing' | undefined,\r\n    attachments?: {\r\n      content: unknown;\r\n      encoding: string;\r\n      filename: string;\r\n    }[],\r\n  ) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    const contact = await this.findContact(instance, '123456');\r\n\r\n    if (!contact) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    const filterInbox = await this.getInbox(instance);\r\n\r\n    if (!filterInbox) {\r\n      this.logger.warn('inbox not found');\r\n      return null;\r\n    }\r\n\r\n    const conversation = await this.getOpenConversationByContact(instance, filterInbox, contact);\r\n\r\n    if (!conversation) {\r\n      this.logger.warn('conversation not found');\r\n      return;\r\n    }\r\n\r\n    const message = await client.messages.create({\r\n      accountId: this.provider.accountId,\r\n      conversationId: conversation.id,\r\n      data: {\r\n        content: content,\r\n        message_type: messageType,\r\n        attachments: attachments,\r\n      },\r\n    });\r\n\r\n    if (!message) {\r\n      this.logger.warn('message not found');\r\n      return null;\r\n    }\r\n\r\n    return message;\r\n  }\r\n\r\n  private async sendData(\r\n    conversationId: number,\r\n    fileStream: Readable,\r\n    fileName: string,\r\n    messageType: 'incoming' | 'outgoing' | undefined,\r\n    content?: string,\r\n    instance?: InstanceDto,\r\n    messageBody?: any,\r\n    sourceId?: string,\r\n    quotedMsg?: MessageModel,\r\n  ) {\r\n    if (sourceId && this.isImportHistoryAvailable()) {\r\n      const messageAlreadySaved = await chatwootImport.getExistingSourceIds([sourceId]);\r\n      if (messageAlreadySaved) {\r\n        if (messageAlreadySaved.size > 0) {\r\n          this.logger.warn('Message already saved on chatwoot');\r\n          return null;\r\n        }\r\n      }\r\n    }\r\n    const data = new FormData();\r\n\r\n    if (content) {\r\n      data.append('content', content);\r\n    }\r\n\r\n    data.append('message_type', messageType);\r\n\r\n    data.append('attachments[]', fileStream, { filename: fileName });\r\n\r\n    const sourceReplyId = quotedMsg?.chatwootMessageId || null;\r\n\r\n    if (messageBody && instance) {\r\n      const replyToIds = await this.getReplyToIds(messageBody, instance);\r\n\r\n      if (replyToIds.in_reply_to || replyToIds.in_reply_to_external_id) {\r\n        const content = JSON.stringify({\r\n          ...replyToIds,\r\n        });\r\n        data.append('content_attributes', content);\r\n      }\r\n    }\r\n\r\n    if (sourceReplyId) {\r\n      data.append('source_reply_id', sourceReplyId.toString());\r\n    }\r\n\r\n    if (sourceId) {\r\n      data.append('source_id', sourceId);\r\n    }\r\n\r\n    const config = {\r\n      method: 'post',\r\n      maxBodyLength: Infinity,\r\n      url: `${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${conversationId}/messages`,\r\n      headers: {\r\n        api_access_token: this.provider.token,\r\n        ...data.getHeaders(),\r\n      },\r\n      data: data,\r\n    };\r\n\r\n    try {\r\n      const { data } = await axios.request(config);\r\n\r\n      return data;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public async createBotQr(\r\n    instance: InstanceDto,\r\n    content: string,\r\n    messageType: 'incoming' | 'outgoing' | undefined,\r\n    fileStream?: Readable,\r\n    fileName?: string,\r\n  ) {\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      this.logger.warn('client not found');\r\n      return null;\r\n    }\r\n\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT) {\r\n      this.logger.log('Chatwoot bot contact is disabled');\r\n\r\n      return true;\r\n    }\r\n\r\n    const contact = await this.findContact(instance, '123456');\r\n\r\n    if (!contact) {\r\n      this.logger.warn('contact not found');\r\n      return null;\r\n    }\r\n\r\n    const filterInbox = await this.getInbox(instance);\r\n\r\n    if (!filterInbox) {\r\n      this.logger.warn('inbox not found');\r\n      return null;\r\n    }\r\n\r\n    const conversation = await this.getOpenConversationByContact(instance, filterInbox, contact);\r\n\r\n    if (!conversation) {\r\n      this.logger.warn('conversation not found');\r\n      return;\r\n    }\r\n\r\n    const data = new FormData();\r\n\r\n    if (content) {\r\n      data.append('content', content);\r\n    }\r\n\r\n    data.append('message_type', messageType);\r\n\r\n    if (fileStream && fileName) {\r\n      data.append('attachments[]', fileStream, { filename: fileName });\r\n    }\r\n\r\n    const config = {\r\n      method: 'post',\r\n      maxBodyLength: Infinity,\r\n      url: `${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${conversation.id}/messages`,\r\n      headers: {\r\n        api_access_token: this.provider.token,\r\n        ...data.getHeaders(),\r\n      },\r\n      data: data,\r\n    };\r\n\r\n    try {\r\n      const { data } = await axios.request(config);\r\n\r\n      return data;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public async sendAttachment(waInstance: any, number: string, media: any, caption?: string, options?: Options) {\r\n    try {\r\n      const parsedMedia = path.parse(decodeURIComponent(media));\r\n      let mimeType = mimeTypes.lookup(parsedMedia?.ext) || '';\r\n      let fileName = parsedMedia?.name + parsedMedia?.ext;\r\n\r\n      if (!mimeType) {\r\n        const parts = media.split('/');\r\n        fileName = decodeURIComponent(parts[parts.length - 1]);\r\n\r\n        const response = await axios.get(media, {\r\n          responseType: 'arraybuffer',\r\n        });\r\n        mimeType = response.headers['content-type'];\r\n      }\r\n\r\n      let type = 'document';\r\n\r\n      switch (mimeType.split('/')[0]) {\r\n        case 'image':\r\n          type = 'image';\r\n          break;\r\n        case 'video':\r\n          type = 'video';\r\n          break;\r\n        case 'audio':\r\n          type = 'audio';\r\n          break;\r\n        default:\r\n          type = 'document';\r\n          break;\r\n      }\r\n\r\n      if (type === 'audio') {\r\n        const data: SendAudioDto = {\r\n          number: number,\r\n          audio: media,\r\n          delay: 1200,\r\n          quoted: options?.quoted,\r\n        };\r\n\r\n        sendTelemetry('/message/sendWhatsAppAudio');\r\n\r\n        const messageSent = await waInstance?.audioWhatsapp(data, true);\r\n\r\n        return messageSent;\r\n      }\r\n\r\n      if (type === 'image' && parsedMedia && parsedMedia?.ext === '.gif') {\r\n        type = 'document';\r\n      }\r\n\r\n      const data: SendMediaDto = {\r\n        number: number,\r\n        mediatype: type as any,\r\n        fileName: fileName,\r\n        media: media,\r\n        delay: 1200,\r\n        quoted: options?.quoted,\r\n      };\r\n\r\n      sendTelemetry('/message/sendMedia');\r\n\r\n      if (caption) {\r\n        data.caption = caption;\r\n      }\r\n\r\n      const messageSent = await waInstance?.mediaMessage(data, null, true);\r\n\r\n      return messageSent;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public async onSendMessageError(instance: InstanceDto, conversation: number, error?: any) {\r\n    this.logger.verbose(`onSendMessageError ${JSON.stringify(error)}`);\r\n\r\n    const client = await this.clientCw(instance);\r\n\r\n    if (!client) {\r\n      return;\r\n    }\r\n\r\n    if (error && error?.status === 400 && error?.message[0]?.exists === false) {\r\n      client.messages.create({\r\n        accountId: this.provider.accountId,\r\n        conversationId: conversation,\r\n        data: {\r\n          content: `${i18next.t('cw.message.numbernotinwhatsapp')}`,\r\n          message_type: 'outgoing',\r\n          private: true,\r\n        },\r\n      });\r\n\r\n      return;\r\n    }\r\n\r\n    client.messages.create({\r\n      accountId: this.provider.accountId,\r\n      conversationId: conversation,\r\n      data: {\r\n        content: i18next.t('cw.message.notsent', {\r\n          error: error ? `_${error.toString()}_` : '',\r\n        }),\r\n        message_type: 'outgoing',\r\n        private: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async receiveWebhook(instance: InstanceDto, body: any) {\r\n    try {\r\n      await new Promise((resolve) => setTimeout(resolve, 500));\r\n\r\n      const client = await this.clientCw(instance);\r\n\r\n      if (!client) {\r\n        this.logger.warn('client not found');\r\n        return null;\r\n      }\r\n\r\n      if (\r\n        this.provider.reopenConversation === false &&\r\n        body.event === 'conversation_status_changed' &&\r\n        body.status === 'resolved' &&\r\n        body.meta?.sender?.identifier\r\n      ) {\r\n        const keyToDelete = `${instance.instanceName}:createConversation-${body.meta.sender.identifier}`;\r\n        this.cache.delete(keyToDelete);\r\n      }\r\n\r\n      if (\r\n        !body?.conversation ||\r\n        body.private ||\r\n        (body.event === 'message_updated' && !body.content_attributes?.deleted)\r\n      ) {\r\n        return { message: 'bot' };\r\n      }\r\n\r\n      const chatId =\r\n        body.conversation.meta.sender?.identifier || body.conversation.meta.sender?.phone_number.replace('+', '');\r\n      // Chatwoot to Whatsapp\r\n      const messageReceived = body.content\r\n        ? body.content\r\n            .replaceAll(/(?<!\\*)\\*((?!\\s)([^\\n*]+?)(?<!\\s))\\*(?!\\*)/g, '_$1_') // Substitui * por _\r\n            .replaceAll(/\\*{2}((?!\\s)([^\\n*]+?)(?<!\\s))\\*{2}/g, '*$1*') // Substitui ** por *\r\n            .replaceAll(/~{2}((?!\\s)([^\\n*]+?)(?<!\\s))~{2}/g, '~$1~') // Substitui ~~ por ~\r\n            .replaceAll(/(?<!`)`((?!\\s)([^`*]+?)(?<!\\s))`(?!`)/g, '```$1```') // Substitui ` por ```\r\n        : body.content;\r\n\r\n      const senderName = body?.conversation?.messages[0]?.sender?.available_name || body?.sender?.name;\r\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\r\n\r\n      if (body.event === 'message_updated' && body.content_attributes?.deleted) {\r\n        const message = await this.prismaRepository.message.findFirst({\r\n          where: {\r\n            chatwootMessageId: body.id,\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (message) {\r\n          const key = message.key as {\r\n            id: string;\r\n            remoteJid: string;\r\n            fromMe: boolean;\r\n            participant: string;\r\n          };\r\n\r\n          await waInstance?.client.sendMessage(key.remoteJid, { delete: key });\r\n\r\n          await this.prismaRepository.message.deleteMany({\r\n            where: {\r\n              instanceId: instance.instanceId,\r\n              chatwootMessageId: body.id,\r\n            },\r\n          });\r\n        }\r\n        return { message: 'bot' };\r\n      }\r\n\r\n      const cwBotContact = this.configService.get<Chatwoot>('CHATWOOT').BOT_CONTACT;\r\n\r\n      if (chatId === '123456' && body.message_type === 'outgoing') {\r\n        const command = messageReceived.replace('/', '');\r\n\r\n        if (cwBotContact && (command.includes('init') || command.includes('iniciar'))) {\r\n          const state = waInstance?.connectionStatus?.state;\r\n\r\n          if (state !== 'open') {\r\n            const number = command.split(':')[1];\r\n            await waInstance.connectToWhatsapp(number);\r\n          } else {\r\n            await this.createBotMessage(\r\n              instance,\r\n              i18next.t('cw.inbox.alreadyConnected', {\r\n                inboxName: body.inbox.name,\r\n              }),\r\n              'incoming',\r\n            );\r\n          }\r\n        }\r\n\r\n        if (command === 'clearcache') {\r\n          waInstance.clearCacheChatwoot();\r\n          await this.createBotMessage(\r\n            instance,\r\n            i18next.t('cw.inbox.clearCache', {\r\n              inboxName: body.inbox.name,\r\n            }),\r\n            'incoming',\r\n          );\r\n        }\r\n\r\n        if (command === 'status') {\r\n          const state = waInstance?.connectionStatus?.state;\r\n\r\n          if (!state) {\r\n            await this.createBotMessage(\r\n              instance,\r\n              i18next.t('cw.inbox.notFound', {\r\n                inboxName: body.inbox.name,\r\n              }),\r\n              'incoming',\r\n            );\r\n          }\r\n\r\n          if (state) {\r\n            await this.createBotMessage(\r\n              instance,\r\n              i18next.t('cw.inbox.status', {\r\n                inboxName: body.inbox.name,\r\n                state: state,\r\n              }),\r\n              'incoming',\r\n            );\r\n          }\r\n        }\r\n\r\n        if (cwBotContact && (command === 'disconnect' || command === 'desconectar')) {\r\n          const msgLogout = i18next.t('cw.inbox.disconnect', {\r\n            inboxName: body.inbox.name,\r\n          });\r\n\r\n          await this.createBotMessage(instance, msgLogout, 'incoming');\r\n\r\n          await waInstance?.client?.logout('Log out instance: ' + instance.instanceName);\r\n          await waInstance?.client?.ws?.close();\r\n        }\r\n      }\r\n\r\n      if (body.message_type === 'outgoing' && body?.conversation?.messages?.length && chatId !== '123456') {\r\n        if (body?.conversation?.messages[0]?.source_id?.substring(0, 5) === 'WAID:') {\r\n          return { message: 'bot' };\r\n        }\r\n\r\n        if (!waInstance && body.conversation?.id) {\r\n          this.onSendMessageError(instance, body.conversation?.id, 'Instance not found');\r\n          return { message: 'bot' };\r\n        }\r\n\r\n        let formatText: string;\r\n        if (senderName === null || senderName === undefined) {\r\n          formatText = messageReceived;\r\n        } else {\r\n          const formattedDelimiter = this.provider.signDelimiter\r\n            ? this.provider.signDelimiter.replaceAll('\\\\n', '\\n')\r\n            : '\\n';\r\n          const textToConcat = this.provider.signMsg ? [`*${senderName}:*`] : [];\r\n          textToConcat.push(messageReceived);\r\n\r\n          formatText = textToConcat.join(formattedDelimiter);\r\n        }\r\n\r\n        for (const message of body.conversation.messages) {\r\n          if (message.attachments && message.attachments.length > 0) {\r\n            for (const attachment of message.attachments) {\r\n              if (!messageReceived) {\r\n                formatText = null;\r\n              }\r\n\r\n              const options: Options = {\r\n                quoted: await this.getQuotedMessage(body, instance),\r\n              };\r\n\r\n              const messageSent = await this.sendAttachment(\r\n                waInstance,\r\n                chatId,\r\n                attachment.data_url,\r\n                formatText,\r\n                options,\r\n              );\r\n              if (!messageSent && body.conversation?.id) {\r\n                this.onSendMessageError(instance, body.conversation?.id);\r\n              }\r\n\r\n              await this.updateChatwootMessageId(\r\n                {\r\n                  ...messageSent,\r\n                  owner: instance.instanceName,\r\n                },\r\n                {\r\n                  messageId: body.id,\r\n                  inboxId: body.inbox?.id,\r\n                  conversationId: body.conversation?.id,\r\n                  contactInboxSourceId: body.conversation?.contact_inbox?.source_id,\r\n                },\r\n                instance,\r\n              );\r\n            }\r\n          } else {\r\n            const data: SendTextDto = {\r\n              number: chatId,\r\n              text: formatText,\r\n              delay: 1200,\r\n              quoted: await this.getQuotedMessage(body, instance),\r\n            };\r\n\r\n            sendTelemetry('/message/sendText');\r\n\r\n            let messageSent: any;\r\n            try {\r\n              messageSent = await waInstance?.textMessage(data, true);\r\n              if (!messageSent) {\r\n                throw new Error('Message not sent');\r\n              }\r\n\r\n              if (Long.isLong(messageSent?.messageTimestamp)) {\r\n                messageSent.messageTimestamp = messageSent.messageTimestamp?.toNumber();\r\n              }\r\n\r\n              await this.updateChatwootMessageId(\r\n                {\r\n                  ...messageSent,\r\n                  instanceId: instance.instanceId,\r\n                },\r\n                {\r\n                  messageId: body.id,\r\n                  inboxId: body.inbox?.id,\r\n                  conversationId: body.conversation?.id,\r\n                  contactInboxSourceId: body.conversation?.contact_inbox?.source_id,\r\n                },\r\n                instance,\r\n              );\r\n            } catch (error) {\r\n              if (!messageSent && body.conversation?.id) {\r\n                this.onSendMessageError(instance, body.conversation?.id, error);\r\n              }\r\n              throw error;\r\n            }\r\n          }\r\n        }\r\n\r\n        const chatwootRead = this.configService.get<Chatwoot>('CHATWOOT').MESSAGE_READ;\r\n        if (chatwootRead) {\r\n          const lastMessage = await this.prismaRepository.message.findFirst({\r\n            where: {\r\n              key: {\r\n                path: ['fromMe'],\r\n                equals: false,\r\n              },\r\n              instanceId: instance.instanceId,\r\n            },\r\n          });\r\n          if (lastMessage && !lastMessage.chatwootIsRead) {\r\n            const key = lastMessage.key as {\r\n              id: string;\r\n              fromMe: boolean;\r\n              remoteJid: string;\r\n              participant?: string;\r\n            };\r\n\r\n            waInstance?.markMessageAsRead({\r\n              readMessages: [\r\n                {\r\n                  id: key.id,\r\n                  fromMe: key.fromMe,\r\n                  remoteJid: key.remoteJid,\r\n                },\r\n              ],\r\n            });\r\n            const updateMessage = {\r\n              chatwootMessageId: lastMessage.chatwootMessageId,\r\n              chatwootConversationId: lastMessage.chatwootConversationId,\r\n              chatwootInboxId: lastMessage.chatwootInboxId,\r\n              chatwootContactInboxSourceId: lastMessage.chatwootContactInboxSourceId,\r\n              chatwootIsRead: true,\r\n            };\r\n\r\n            await this.prismaRepository.message.updateMany({\r\n              where: {\r\n                instanceId: instance.instanceId,\r\n                key: {\r\n                  path: ['id'],\r\n                  equals: key.id,\r\n                },\r\n              },\r\n              data: updateMessage,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      if (body.message_type === 'template' && body.event === 'message_created') {\r\n        const data: SendTextDto = {\r\n          number: chatId,\r\n          text: body.content.replace(/\\\\\\r\\n|\\\\\\n|\\n/g, '\\n'),\r\n          delay: 1200,\r\n        };\r\n\r\n        sendTelemetry('/message/sendText');\r\n\r\n        await waInstance?.textMessage(data);\r\n      }\r\n\r\n      return { message: 'bot' };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n\r\n      return { message: 'bot' };\r\n    }\r\n  }\r\n\r\n  private async updateChatwootMessageId(\r\n    message: MessageModel,\r\n    chatwootMessageIds: ChatwootMessage,\r\n    instance: InstanceDto,\r\n  ) {\r\n    const key = message.key as {\r\n      id: string;\r\n      fromMe: boolean;\r\n      remoteJid: string;\r\n      participant?: string;\r\n    };\r\n\r\n    if (!chatwootMessageIds.messageId || !key?.id) {\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.message.updateMany({\r\n      where: {\r\n        key: {\r\n          path: ['id'],\r\n          equals: key.id,\r\n        },\r\n        instanceId: instance.instanceId,\r\n      },\r\n      data: {\r\n        chatwootMessageId: chatwootMessageIds.messageId,\r\n        chatwootConversationId: chatwootMessageIds.conversationId,\r\n        chatwootInboxId: chatwootMessageIds.inboxId,\r\n        chatwootContactInboxSourceId: chatwootMessageIds.contactInboxSourceId,\r\n        chatwootIsRead: chatwootMessageIds.isRead,\r\n      },\r\n    });\r\n\r\n    if (this.isImportHistoryAvailable()) {\r\n      chatwootImport.updateMessageSourceID(chatwootMessageIds.messageId, key.id);\r\n    }\r\n  }\r\n\r\n  private async getMessageByKeyId(instance: InstanceDto, keyId: string): Promise<MessageModel> {\r\n    const messages = await this.prismaRepository.message.findFirst({\r\n      where: {\r\n        key: {\r\n          path: ['id'],\r\n          equals: keyId,\r\n        },\r\n        instanceId: instance.instanceId,\r\n      },\r\n    });\r\n\r\n    return messages || null;\r\n  }\r\n\r\n  private async getReplyToIds(\r\n    msg: any,\r\n    instance: InstanceDto,\r\n  ): Promise<{ in_reply_to: string; in_reply_to_external_id: string }> {\r\n    let inReplyTo = null;\r\n    let inReplyToExternalId = null;\r\n\r\n    if (msg) {\r\n      inReplyToExternalId = msg.message?.extendedTextMessage?.contextInfo?.stanzaId ?? msg.contextInfo?.stanzaId;\r\n      if (inReplyToExternalId) {\r\n        const message = await this.getMessageByKeyId(instance, inReplyToExternalId);\r\n        if (message?.chatwootMessageId) {\r\n          inReplyTo = message.chatwootMessageId;\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      in_reply_to: inReplyTo,\r\n      in_reply_to_external_id: inReplyToExternalId,\r\n    };\r\n  }\r\n\r\n  private async getQuotedMessage(msg: any, instance: InstanceDto): Promise<Quoted> {\r\n    if (msg?.content_attributes?.in_reply_to) {\r\n      const message = await this.prismaRepository.message.findFirst({\r\n        where: {\r\n          chatwootMessageId: msg?.content_attributes?.in_reply_to,\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      const key = message?.key as {\r\n        id: string;\r\n        fromMe: boolean;\r\n        remoteJid: string;\r\n        participant?: string;\r\n      };\r\n\r\n      if (message && key?.id) {\r\n        return {\r\n          key: message.key as proto.IMessageKey,\r\n          message: message.message as proto.IMessage,\r\n        };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private isMediaMessage(message: any) {\r\n    const media = [\r\n      'imageMessage',\r\n      'documentMessage',\r\n      'documentWithCaptionMessage',\r\n      'audioMessage',\r\n      'videoMessage',\r\n      'stickerMessage',\r\n      'viewOnceMessageV2',\r\n    ];\r\n\r\n    const messageKeys = Object.keys(message);\r\n\r\n    const result = messageKeys.some((key) => media.includes(key));\r\n\r\n    return result;\r\n  }\r\n\r\n  private getAdsMessage(msg: any) {\r\n    interface AdsMessage {\r\n      title: string;\r\n      body: string;\r\n      thumbnailUrl: string;\r\n      sourceUrl: string;\r\n    }\r\n\r\n    const adsMessage: AdsMessage | undefined = {\r\n      title: msg.extendedTextMessage?.contextInfo?.externalAdReply?.title || msg.contextInfo?.externalAdReply?.title,\r\n      body: msg.extendedTextMessage?.contextInfo?.externalAdReply?.body || msg.contextInfo?.externalAdReply?.body,\r\n      thumbnailUrl:\r\n        msg.extendedTextMessage?.contextInfo?.externalAdReply?.thumbnailUrl ||\r\n        msg.contextInfo?.externalAdReply?.thumbnailUrl,\r\n      sourceUrl:\r\n        msg.extendedTextMessage?.contextInfo?.externalAdReply?.sourceUrl || msg.contextInfo?.externalAdReply?.sourceUrl,\r\n    };\r\n\r\n    return adsMessage;\r\n  }\r\n\r\n  private getReactionMessage(msg: any) {\r\n    interface ReactionMessage {\r\n      key: {\r\n        id: string;\r\n        fromMe: boolean;\r\n        remoteJid: string;\r\n        participant?: string;\r\n      };\r\n      text: string;\r\n    }\r\n    const reactionMessage: ReactionMessage | undefined = msg?.reactionMessage;\r\n\r\n    return reactionMessage;\r\n  }\r\n\r\n  private getTypeMessage(msg: any) {\r\n    const types = {\r\n      conversation: msg.conversation,\r\n      imageMessage: msg.imageMessage?.caption,\r\n      videoMessage: msg.videoMessage?.caption,\r\n      extendedTextMessage: msg.extendedTextMessage?.text,\r\n      messageContextInfo: msg.messageContextInfo?.stanzaId,\r\n      stickerMessage: undefined,\r\n      documentMessage: msg.documentMessage?.caption,\r\n      documentWithCaptionMessage: msg.documentWithCaptionMessage?.message?.documentMessage?.caption,\r\n      audioMessage: msg.audioMessage?.caption,\r\n      contactMessage: msg.contactMessage?.vcard,\r\n      contactsArrayMessage: msg.contactsArrayMessage,\r\n      locationMessage: msg.locationMessage,\r\n      liveLocationMessage: msg.liveLocationMessage,\r\n      listMessage: msg.listMessage,\r\n      listResponseMessage: msg.listResponseMessage,\r\n      viewOnceMessageV2:\r\n        msg?.message?.viewOnceMessageV2?.message?.imageMessage?.url ||\r\n        msg?.message?.viewOnceMessageV2?.message?.videoMessage?.url ||\r\n        msg?.message?.viewOnceMessageV2?.message?.audioMessage?.url,\r\n    };\r\n\r\n    return types;\r\n  }\r\n\r\n  private getMessageContent(types: any) {\r\n    const typeKey = Object.keys(types).find((key) => types[key] !== undefined);\r\n\r\n    let result = typeKey ? types[typeKey] : undefined;\r\n\r\n    // Remove externalAdReplyBody| in Chatwoot (Already Have)\r\n    if (result && typeof result === 'string' && result.includes('externalAdReplyBody|')) {\r\n      result = result.split('externalAdReplyBody|').filter(Boolean).join('');\r\n    }\r\n\r\n    if (typeKey === 'locationMessage' || typeKey === 'liveLocationMessage') {\r\n      const latitude = result.degreesLatitude;\r\n      const longitude = result.degreesLongitude;\r\n\r\n      const locationName = result?.name;\r\n      const locationAddress = result?.address;\r\n\r\n      const formattedLocation =\r\n        `*${i18next.t('cw.locationMessage.location')}:*\\n\\n` +\r\n        `_${i18next.t('cw.locationMessage.latitude')}:_ ${latitude} \\n` +\r\n        `_${i18next.t('cw.locationMessage.longitude')}:_ ${longitude} \\n` +\r\n        (locationName ? `_${i18next.t('cw.locationMessage.locationName')}:_ ${locationName}\\n` : '') +\r\n        (locationAddress ? `_${i18next.t('cw.locationMessage.locationAddress')}:_ ${locationAddress} \\n` : '') +\r\n        `_${i18next.t('cw.locationMessage.locationUrl')}:_ ` +\r\n        `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;\r\n\r\n      return formattedLocation;\r\n    }\r\n\r\n    if (typeKey === 'contactMessage') {\r\n      const vCardData = result.split('\\n');\r\n      const contactInfo = {};\r\n\r\n      vCardData.forEach((line) => {\r\n        const [key, value] = line.split(':');\r\n        if (key && value) {\r\n          contactInfo[key] = value;\r\n        }\r\n      });\r\n\r\n      let formattedContact =\r\n        `*${i18next.t('cw.contactMessage.contact')}:*\\n\\n` +\r\n        `_${i18next.t('cw.contactMessage.name')}:_ ${contactInfo['FN']}`;\r\n\r\n      let numberCount = 1;\r\n      Object.keys(contactInfo).forEach((key) => {\r\n        if (key.startsWith('item') && key.includes('TEL')) {\r\n          const phoneNumber = contactInfo[key];\r\n          formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\r\n          numberCount++;\r\n        } else if (key.includes('TEL')) {\r\n          const phoneNumber = contactInfo[key];\r\n          formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\r\n          numberCount++;\r\n        }\r\n      });\r\n\r\n      return formattedContact;\r\n    }\r\n\r\n    if (typeKey === 'contactsArrayMessage') {\r\n      const formattedContacts = result.contacts.map((contact) => {\r\n        const vCardData = contact.vcard.split('\\n');\r\n        const contactInfo = {};\r\n\r\n        vCardData.forEach((line) => {\r\n          const [key, value] = line.split(':');\r\n          if (key && value) {\r\n            contactInfo[key] = value;\r\n          }\r\n        });\r\n\r\n        let formattedContact = `*${i18next.t('cw.contactMessage.contact')}:*\\n\\n_${i18next.t(\r\n          'cw.contactMessage.name',\r\n        )}:_ ${contact.displayName}`;\r\n\r\n        let numberCount = 1;\r\n        Object.keys(contactInfo).forEach((key) => {\r\n          if (key.startsWith('item') && key.includes('TEL')) {\r\n            const phoneNumber = contactInfo[key];\r\n            formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\r\n            numberCount++;\r\n          } else if (key.includes('TEL')) {\r\n            const phoneNumber = contactInfo[key];\r\n            formattedContact += `\\n_${i18next.t('cw.contactMessage.number')} (${numberCount}):_ ${phoneNumber}`;\r\n            numberCount++;\r\n          }\r\n        });\r\n\r\n        return formattedContact;\r\n      });\r\n\r\n      const formattedContactsArray = formattedContacts.join('\\n\\n');\r\n\r\n      return formattedContactsArray;\r\n    }\r\n\r\n    if (typeKey === 'listMessage') {\r\n      const listTitle = result?.title || 'Unknown';\r\n      const listDescription = result?.description || 'Unknown';\r\n      const listFooter = result?.footerText || 'Unknown';\r\n\r\n      let formattedList =\r\n        '*List Menu:*\\n\\n' +\r\n        '_Title_: ' +\r\n        listTitle +\r\n        '\\n' +\r\n        '_Description_: ' +\r\n        listDescription +\r\n        '\\n' +\r\n        '_Footer_: ' +\r\n        listFooter;\r\n\r\n      if (result.sections && result.sections.length > 0) {\r\n        result.sections.forEach((section, sectionIndex) => {\r\n          formattedList += '\\n\\n*Section ' + (sectionIndex + 1) + ':* ' + section.title || 'Unknown\\n';\r\n\r\n          if (section.rows && section.rows.length > 0) {\r\n            section.rows.forEach((row, rowIndex) => {\r\n              formattedList += '\\n*Line ' + (rowIndex + 1) + ':*\\n';\r\n              formattedList += '_ Title:_ ' + (row.title || 'Unknown') + '\\n';\r\n              formattedList += '_ Description:_ ' + (row.description || 'Unknown') + '\\n';\r\n              formattedList += '_ ID:_ ' + (row.rowId || 'Unknown') + '\\n';\r\n            });\r\n          } else {\r\n            formattedList += '\\nNo lines found in this section.\\n';\r\n          }\r\n        });\r\n      } else {\r\n        formattedList += '\\nNo sections found.\\n';\r\n      }\r\n\r\n      return formattedList;\r\n    }\r\n\r\n    if (typeKey === 'listResponseMessage') {\r\n      const responseTitle = result?.title || 'Unknown';\r\n      const responseDescription = result?.description || 'Unknown';\r\n      const responseRowId = result?.singleSelectReply?.selectedRowId || 'Unknown';\r\n\r\n      const formattedResponseList =\r\n        '*List Response:*\\n\\n' +\r\n        '_Title_: ' +\r\n        responseTitle +\r\n        '\\n' +\r\n        '_Description_: ' +\r\n        responseDescription +\r\n        '\\n' +\r\n        '_ID_: ' +\r\n        responseRowId;\r\n      return formattedResponseList;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  public getConversationMessage(msg: any) {\r\n    const types = this.getTypeMessage(msg);\r\n\r\n    const messageContent = this.getMessageContent(types);\r\n\r\n    return messageContent;\r\n  }\r\n\r\n  public async eventWhatsapp(event: string, instance: InstanceDto, body: any) {\r\n    try {\r\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\r\n\r\n      if (!waInstance) {\r\n        this.logger.warn('wa instance not found');\r\n        return null;\r\n      }\r\n\r\n      const client = await this.clientCw(instance);\r\n\r\n      if (!client) {\r\n        this.logger.warn('client not found');\r\n        return null;\r\n      }\r\n\r\n      if (this.provider?.ignoreJids && this.provider?.ignoreJids.length > 0) {\r\n        const ignoreJids: any = this.provider?.ignoreJids;\r\n\r\n        let ignoreGroups = false;\r\n        let ignoreContacts = false;\r\n\r\n        if (ignoreJids.includes('@g.us')) {\r\n          ignoreGroups = true;\r\n        }\r\n\r\n        if (ignoreJids.includes('@s.whatsapp.net')) {\r\n          ignoreContacts = true;\r\n        }\r\n\r\n        if (ignoreGroups && body?.key?.remoteJid.endsWith('@g.us')) {\r\n          this.logger.warn('Ignoring message from group: ' + body?.key?.remoteJid);\r\n          return;\r\n        }\r\n\r\n        if (ignoreContacts && body?.key?.remoteJid.endsWith('@s.whatsapp.net')) {\r\n          this.logger.warn('Ignoring message from contact: ' + body?.key?.remoteJid);\r\n          return;\r\n        }\r\n\r\n        if (ignoreJids.includes(body?.key?.remoteJid)) {\r\n          this.logger.warn('Ignoring message from jid: ' + body?.key?.remoteJid);\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (event === 'messages.upsert' || event === 'send.message') {\r\n        if (body.key.remoteJid === 'status@broadcast') {\r\n          return;\r\n        }\r\n\r\n        if (body.message?.ephemeralMessage?.message) {\r\n          body.message = {\r\n            ...body.message?.ephemeralMessage?.message,\r\n          };\r\n        }\r\n\r\n        const originalMessage = await this.getConversationMessage(body.message);\r\n        const bodyMessage = originalMessage\r\n          ? originalMessage\r\n              .replaceAll(/\\*((?!\\s)([^\\n*]+?)(?<!\\s))\\*/g, '**$1**')\r\n              .replaceAll(/_((?!\\s)([^\\n_]+?)(?<!\\s))_/g, '*$1*')\r\n              .replaceAll(/~((?!\\s)([^\\n~]+?)(?<!\\s))~/g, '~~$1~~')\r\n          : originalMessage;\r\n\r\n        if (bodyMessage && bodyMessage.includes('Por favor, classifique esta conversa, http')) {\r\n          return;\r\n        }\r\n\r\n        const quotedId = body.contextInfo?.stanzaId || body.message?.contextInfo?.stanzaId;\r\n\r\n        let quotedMsg = null;\r\n\r\n        if (quotedId)\r\n          quotedMsg = await this.prismaRepository.message.findFirst({\r\n            where: {\r\n              key: {\r\n                path: ['id'],\r\n                equals: quotedId,\r\n              },\r\n              chatwootMessageId: {\r\n                not: null,\r\n              },\r\n            },\r\n          });\r\n\r\n        const isMedia = this.isMediaMessage(body.message);\r\n\r\n        const adsMessage = this.getAdsMessage(body);\r\n\r\n        const reactionMessage = this.getReactionMessage(body.message);\r\n\r\n        if (!bodyMessage && !isMedia && !reactionMessage) {\r\n          this.logger.warn('no body message found');\r\n          return;\r\n        }\r\n\r\n        const getConversation = await this.createConversation(instance, body);\r\n\r\n        if (!getConversation) {\r\n          this.logger.warn('conversation not found');\r\n          return;\r\n        }\r\n\r\n        const messageType = body.key.fromMe ? 'outgoing' : 'incoming';\r\n\r\n        if (isMedia) {\r\n          const downloadBase64 = await waInstance?.getBase64FromMediaMessage({\r\n            message: {\r\n              ...body,\r\n            },\r\n          });\r\n\r\n          let nameFile: string;\r\n          const messageBody = body?.message[body?.messageType];\r\n          const originalFilename =\r\n            messageBody?.fileName || messageBody?.filename || messageBody?.message?.documentMessage?.fileName;\r\n          if (originalFilename) {\r\n            const parsedFile = path.parse(originalFilename);\r\n            if (parsedFile.name && parsedFile.ext) {\r\n              nameFile = `${parsedFile.name}-${Math.floor(Math.random() * (99 - 10 + 1) + 10)}${parsedFile.ext}`;\r\n            }\r\n          }\r\n\r\n          if (!nameFile) {\r\n            nameFile = `${Math.random().toString(36).substring(7)}.${mimeTypes.extension(downloadBase64.mimetype) || ''}`;\r\n          }\r\n\r\n          const fileData = Buffer.from(downloadBase64.base64, 'base64');\r\n\r\n          const fileStream = new Readable();\r\n          fileStream._read = () => {};\r\n          fileStream.push(fileData);\r\n          fileStream.push(null);\r\n\r\n          if (body.key.remoteJid.includes('@g.us')) {\r\n            const participantName = body.pushName;\r\n            const rawPhoneNumber = body.key.participant.split('@')[0];\r\n            const phoneMatch = rawPhoneNumber.match(/^(\\d{2})(\\d{2})(\\d{4})(\\d{4})$/);\r\n\r\n            let formattedPhoneNumber: string;\r\n\r\n            if (phoneMatch) {\r\n              formattedPhoneNumber = `+${phoneMatch[1]} (${phoneMatch[2]}) ${phoneMatch[3]}-${phoneMatch[4]}`;\r\n            } else {\r\n              formattedPhoneNumber = `+${rawPhoneNumber}`;\r\n            }\r\n\r\n            let content: string;\r\n\r\n            if (!body.key.fromMe) {\r\n              content = `**${formattedPhoneNumber} - ${participantName}:**\\n\\n${bodyMessage}`;\r\n            } else {\r\n              content = `${bodyMessage}`;\r\n            }\r\n\r\n            const send = await this.sendData(\r\n              getConversation,\r\n              fileStream,\r\n              nameFile,\r\n              messageType,\r\n              content,\r\n              instance,\r\n              body,\r\n              'WAID:' + body.key.id,\r\n              quotedMsg,\r\n            );\r\n\r\n            if (!send) {\r\n              this.logger.warn('message not sent');\r\n              return;\r\n            }\r\n\r\n            return send;\r\n          } else {\r\n            const send = await this.sendData(\r\n              getConversation,\r\n              fileStream,\r\n              nameFile,\r\n              messageType,\r\n              bodyMessage,\r\n              instance,\r\n              body,\r\n              'WAID:' + body.key.id,\r\n              quotedMsg,\r\n            );\r\n\r\n            if (!send) {\r\n              this.logger.warn('message not sent');\r\n              return;\r\n            }\r\n\r\n            return send;\r\n          }\r\n        }\r\n\r\n        if (reactionMessage) {\r\n          if (reactionMessage.text) {\r\n            const send = await this.createMessage(\r\n              instance,\r\n              getConversation,\r\n              reactionMessage.text,\r\n              messageType,\r\n              false,\r\n              [],\r\n              {\r\n                message: { extendedTextMessage: { contextInfo: { stanzaId: reactionMessage.key.id } } },\r\n              },\r\n              'WAID:' + body.key.id,\r\n              quotedMsg,\r\n            );\r\n            if (!send) {\r\n              this.logger.warn('message not sent');\r\n              return;\r\n            }\r\n          }\r\n\r\n          return;\r\n        }\r\n\r\n        const isAdsMessage = (adsMessage && adsMessage.title) || adsMessage.body || adsMessage.thumbnailUrl;\r\n        if (isAdsMessage) {\r\n          const imgBuffer = await axios.get(adsMessage.thumbnailUrl, { responseType: 'arraybuffer' });\r\n\r\n          const extension = mimeTypes.extension(imgBuffer.headers['content-type']);\r\n          const mimeType = extension && mimeTypes.lookup(extension);\r\n\r\n          if (!mimeType) {\r\n            this.logger.warn('mimetype of Ads message not found');\r\n            return;\r\n          }\r\n\r\n          const random = Math.random().toString(36).substring(7);\r\n          const nameFile = `${random}.${mimeTypes.extension(mimeType)}`;\r\n          const fileData = Buffer.from(imgBuffer.data, 'binary');\r\n\r\n          const img = await Jimp.read(fileData);\r\n          await img.cover(320, 180);\r\n\r\n          const processedBuffer = await img.getBufferAsync(Jimp.MIME_PNG);\r\n\r\n          const fileStream = new Readable();\r\n          fileStream._read = () => {}; // _read is required but you can noop it\r\n          fileStream.push(processedBuffer);\r\n          fileStream.push(null);\r\n\r\n          const truncStr = (str: string, len: number) => {\r\n            if (!str) return '';\r\n\r\n            return str.length > len ? str.substring(0, len) + '...' : str;\r\n          };\r\n\r\n          const title = truncStr(adsMessage.title, 40);\r\n          const description = truncStr(adsMessage?.body, 75);\r\n\r\n          const send = await this.sendData(\r\n            getConversation,\r\n            fileStream,\r\n            nameFile,\r\n            messageType,\r\n            `${bodyMessage}\\n\\n\\n**${title}**\\n${description}\\n${adsMessage.sourceUrl}`,\r\n            instance,\r\n            body,\r\n            'WAID:' + body.key.id,\r\n          );\r\n\r\n          if (!send) {\r\n            this.logger.warn('message not sent');\r\n            return;\r\n          }\r\n\r\n          return send;\r\n        }\r\n\r\n        if (body.key.remoteJid.includes('@g.us')) {\r\n          const participantName = body.pushName;\r\n          const rawPhoneNumber = body.key.participant.split('@')[0];\r\n          const phoneMatch = rawPhoneNumber.match(/^(\\d{2})(\\d{2})(\\d{4})(\\d{4})$/);\r\n\r\n          let formattedPhoneNumber: string;\r\n\r\n          if (phoneMatch) {\r\n            formattedPhoneNumber = `+${phoneMatch[1]} (${phoneMatch[2]}) ${phoneMatch[3]}-${phoneMatch[4]}`;\r\n          } else {\r\n            formattedPhoneNumber = `+${rawPhoneNumber}`;\r\n          }\r\n\r\n          let content: string;\r\n\r\n          if (!body.key.fromMe) {\r\n            content = `**${formattedPhoneNumber} - ${participantName}:**\\n\\n${bodyMessage}`;\r\n          } else {\r\n            content = `${bodyMessage}`;\r\n          }\r\n\r\n          const send = await this.createMessage(\r\n            instance,\r\n            getConversation,\r\n            content,\r\n            messageType,\r\n            false,\r\n            [],\r\n            body,\r\n            'WAID:' + body.key.id,\r\n            quotedMsg,\r\n          );\r\n\r\n          if (!send) {\r\n            this.logger.warn('message not sent');\r\n            return;\r\n          }\r\n\r\n          return send;\r\n        } else {\r\n          const send = await this.createMessage(\r\n            instance,\r\n            getConversation,\r\n            bodyMessage,\r\n            messageType,\r\n            false,\r\n            [],\r\n            body,\r\n            'WAID:' + body.key.id,\r\n            quotedMsg,\r\n          );\r\n\r\n          if (!send) {\r\n            this.logger.warn('message not sent');\r\n            return;\r\n          }\r\n\r\n          return send;\r\n        }\r\n      }\r\n\r\n      if (event === Events.MESSAGES_DELETE) {\r\n        const chatwootDelete = this.configService.get<Chatwoot>('CHATWOOT').MESSAGE_DELETE;\r\n\r\n        if (chatwootDelete === true) {\r\n          if (!body?.key?.id) {\r\n            this.logger.warn('message id not found');\r\n            return;\r\n          }\r\n\r\n          const message = await this.getMessageByKeyId(instance, body.key.id);\r\n\r\n          if (message?.chatwootMessageId && message?.chatwootConversationId) {\r\n            await this.prismaRepository.message.deleteMany({\r\n              where: {\r\n                key: {\r\n                  path: ['id'],\r\n                  equals: body.key.id,\r\n                },\r\n                instanceId: instance.instanceId,\r\n              },\r\n            });\r\n\r\n            return await client.messages.delete({\r\n              accountId: this.provider.accountId,\r\n              conversationId: message.chatwootConversationId,\r\n              messageId: message.chatwootMessageId,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      if (event === 'messages.edit') {\r\n        const editedText = `${\r\n          body?.editedMessage?.conversation || body?.editedMessage?.extendedTextMessage?.text\r\n        }\\n\\n_\\`${i18next.t('cw.message.edited')}.\\`_`;\r\n        const message = await this.getMessageByKeyId(instance, body?.key?.id);\r\n        const key = message.key as {\r\n          id: string;\r\n          fromMe: boolean;\r\n          remoteJid: string;\r\n          participant?: string;\r\n        };\r\n\r\n        const messageType = key?.fromMe ? 'outgoing' : 'incoming';\r\n\r\n        if (message && message.chatwootConversationId) {\r\n          const send = await this.createMessage(\r\n            instance,\r\n            message.chatwootConversationId,\r\n            editedText,\r\n            messageType,\r\n            false,\r\n            [],\r\n            {\r\n              message: { extendedTextMessage: { contextInfo: { stanzaId: key.id } } },\r\n            },\r\n            'WAID:' + body.key.id,\r\n            null,\r\n          );\r\n          if (!send) {\r\n            this.logger.warn('edited message not sent');\r\n            return;\r\n          }\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (event === 'messages.read') {\r\n        if (!body?.key?.id || !body?.key?.remoteJid) {\r\n          this.logger.warn('message id not found');\r\n          return;\r\n        }\r\n\r\n        const message = await this.getMessageByKeyId(instance, body.key.id);\r\n        const conversationId = message?.chatwootConversationId;\r\n        const contactInboxSourceId = message?.chatwootContactInboxSourceId;\r\n\r\n        if (conversationId) {\r\n          let sourceId = contactInboxSourceId;\r\n          const inbox = (await this.getInbox(instance)) as inbox & {\r\n            inbox_identifier?: string;\r\n          };\r\n\r\n          if (!sourceId && inbox) {\r\n            const conversation = (await client.conversations.get({\r\n              accountId: this.provider.accountId,\r\n              conversationId: conversationId,\r\n            })) as conversation_show & {\r\n              last_non_activity_message: { conversation: { contact_inbox: contact_inboxes } };\r\n            };\r\n            sourceId = conversation.last_non_activity_message?.conversation?.contact_inbox?.source_id;\r\n          }\r\n\r\n          if (sourceId && inbox?.inbox_identifier) {\r\n            const url =\r\n              `/public/api/v1/inboxes/${inbox.inbox_identifier}/contacts/${sourceId}` +\r\n              `/conversations/${conversationId}/update_last_seen`;\r\n            chatwootRequest(this.getClientCwConfig(), {\r\n              method: 'POST',\r\n              url: url,\r\n            });\r\n          }\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (event === 'status.instance') {\r\n        const data = body;\r\n        const inbox = await this.getInbox(instance);\r\n\r\n        if (!inbox) {\r\n          this.logger.warn('inbox not found');\r\n          return;\r\n        }\r\n\r\n        const msgStatus = i18next.t('cw.inbox.status', {\r\n          inboxName: inbox.name,\r\n          state: data.status,\r\n        });\r\n\r\n        await this.createBotMessage(instance, msgStatus, 'incoming');\r\n      }\r\n\r\n      if (event === 'connection.update') {\r\n        if (body.status === 'open') {\r\n          // if we have qrcode count then we understand that a new connection was established\r\n          if (this.waMonitor.waInstances[instance.instanceName].qrCode.count > 0) {\r\n            const msgConnection = i18next.t('cw.inbox.connected');\r\n            await this.createBotMessage(instance, msgConnection, 'incoming');\r\n            this.waMonitor.waInstances[instance.instanceName].qrCode.count = 0;\r\n            chatwootImport.clearAll(instance);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (event === 'qrcode.updated') {\r\n        if (body.statusCode === 500) {\r\n          const erroQRcode = ` ${i18next.t('qrlimitreached')}`;\r\n          return await this.createBotMessage(instance, erroQRcode, 'incoming');\r\n        } else {\r\n          const fileData = Buffer.from(body?.qrcode.base64.replace('data:image/png;base64,', ''), 'base64');\r\n\r\n          const fileStream = new Readable();\r\n          fileStream._read = () => {};\r\n          fileStream.push(fileData);\r\n          fileStream.push(null);\r\n\r\n          await this.createBotQr(\r\n            instance,\r\n            i18next.t('qrgeneratedsuccesfully'),\r\n            'incoming',\r\n            fileStream,\r\n            `${instance.instanceName}.png`,\r\n          );\r\n\r\n          let msgQrCode = `${i18next.t('qrgeneratedsuccesfully')}\\n\\n${i18next.t('scanqr')}`;\r\n\r\n          if (body?.qrcode?.pairingCode) {\r\n            msgQrCode =\r\n              msgQrCode +\r\n              `\\n\\n*Pairing Code:* ${body.qrcode.pairingCode.substring(0, 4)}-${body.qrcode.pairingCode.substring(\r\n                4,\r\n                8,\r\n              )}`;\r\n          }\r\n\r\n          await this.createBotMessage(instance, msgQrCode, 'incoming');\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public getNumberFromRemoteJid(remoteJid: string) {\r\n    return remoteJid.replace(/:\\d+/, '').split('@')[0];\r\n  }\r\n\r\n  public startImportHistoryMessages(instance: InstanceDto) {\r\n    if (!this.isImportHistoryAvailable()) {\r\n      return;\r\n    }\r\n\r\n    this.createBotMessage(instance, i18next.t('cw.import.startImport'), 'incoming');\r\n  }\r\n\r\n  public isImportHistoryAvailable() {\r\n    const uri = this.configService.get<Chatwoot>('CHATWOOT').IMPORT.DATABASE.CONNECTION.URI;\r\n\r\n    return uri && uri !== 'postgres://user:password@hostname:port/dbname';\r\n  }\r\n\r\n  public addHistoryMessages(instance: InstanceDto, messagesRaw: MessageModel[]) {\r\n    if (!this.isImportHistoryAvailable()) {\r\n      return;\r\n    }\r\n\r\n    chatwootImport.addHistoryMessages(instance, messagesRaw);\r\n  }\r\n\r\n  public addHistoryContacts(instance: InstanceDto, contactsRaw: ContactModel[]) {\r\n    if (!this.isImportHistoryAvailable()) {\r\n      return;\r\n    }\r\n\r\n    return chatwootImport.addHistoryContacts(instance, contactsRaw);\r\n  }\r\n\r\n  public async importHistoryMessages(instance: InstanceDto) {\r\n    if (!this.isImportHistoryAvailable()) {\r\n      return;\r\n    }\r\n\r\n    this.createBotMessage(instance, i18next.t('cw.import.importingMessages'), 'incoming');\r\n\r\n    const totalMessagesImported = await chatwootImport.importHistoryMessages(\r\n      instance,\r\n      this,\r\n      await this.getInbox(instance),\r\n      this.provider,\r\n    );\r\n    this.updateContactAvatarInRecentConversations(instance);\r\n\r\n    const msg = Number.isInteger(totalMessagesImported)\r\n      ? i18next.t('cw.import.messagesImported', { totalMessagesImported })\r\n      : i18next.t('cw.import.messagesException');\r\n\r\n    this.createBotMessage(instance, msg, 'incoming');\r\n\r\n    return totalMessagesImported;\r\n  }\r\n\r\n  public async updateContactAvatarInRecentConversations(instance: InstanceDto, limitContacts = 100) {\r\n    try {\r\n      if (!this.isImportHistoryAvailable()) {\r\n        return;\r\n      }\r\n\r\n      const client = await this.clientCw(instance);\r\n      if (!client) {\r\n        this.logger.warn('client not found');\r\n        return null;\r\n      }\r\n\r\n      const inbox = await this.getInbox(instance);\r\n      if (!inbox) {\r\n        this.logger.warn('inbox not found');\r\n        return null;\r\n      }\r\n\r\n      const recentContacts = await chatwootImport.getContactsOrderByRecentConversations(\r\n        inbox,\r\n        this.provider,\r\n        limitContacts,\r\n      );\r\n\r\n      const contactIdentifiers = recentContacts\r\n        .map((contact) => contact.identifier)\r\n        .filter((identifier) => identifier !== null);\r\n\r\n      const contactsWithProfilePicture = (\r\n        await this.prismaRepository.contact.findMany({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n            id: {\r\n              in: contactIdentifiers,\r\n            },\r\n            profilePicUrl: {\r\n              not: null,\r\n            },\r\n          },\r\n        })\r\n      ).reduce((acc: Map<string, ContactModel>, contact: ContactModel) => acc.set(contact.id, contact), new Map());\r\n\r\n      recentContacts.forEach(async (contact) => {\r\n        if (contactsWithProfilePicture.has(contact.identifier)) {\r\n          client.contacts.update({\r\n            accountId: this.provider.accountId,\r\n            id: contact.id,\r\n            data: {\r\n              avatar_url: contactsWithProfilePicture.get(contact.identifier).profilePictureUrl || null,\r\n            },\r\n          });\r\n        }\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(`Error on update avatar in recent conversations: ${error.toString()}`);\r\n    }\r\n  }\r\n\r\n  public async syncLostMessages(\r\n    instance: InstanceDto,\r\n    chatwootConfig: ChatwootDto,\r\n    prepareMessage: (message: any) => any,\r\n  ) {\r\n    try {\r\n      if (!this.isImportHistoryAvailable()) {\r\n        return;\r\n      }\r\n      if (!this.configService.get<Database>('DATABASE').SAVE_DATA.MESSAGE_UPDATE) {\r\n        return;\r\n      }\r\n\r\n      const inbox = await this.getInbox(instance);\r\n\r\n      const sqlMessages = `select * from messages m\r\n      where account_id = ${chatwootConfig.accountId}\r\n      and inbox_id = ${inbox.id}\r\n      and created_at >= now() - interval '6h'\r\n      order by created_at desc`;\r\n\r\n      const messagesData = (await this.pgClient.query(sqlMessages))?.rows;\r\n      const ids: string[] = messagesData\r\n        .filter((message) => !!message.source_id)\r\n        .map((message) => message.source_id.replace('WAID:', ''));\r\n\r\n      const savedMessages = await this.prismaRepository.message.findMany({\r\n        where: {\r\n          Instance: { name: instance.instanceName },\r\n          messageTimestamp: { gte: dayjs().subtract(6, 'hours').unix() },\r\n          AND: ids.map((id) => ({ key: { path: ['id'], not: id } })),\r\n        },\r\n      });\r\n\r\n      const filteredMessages = savedMessages.filter(\r\n        (msg: any) => !chatwootImport.isIgnorePhoneNumber(msg.key?.remoteJid),\r\n      );\r\n      const messagesRaw: any[] = [];\r\n      for (const m of filteredMessages) {\r\n        if (!m.message || !m.key || !m.messageTimestamp) {\r\n          continue;\r\n        }\r\n\r\n        if (Long.isLong(m?.messageTimestamp)) {\r\n          m.messageTimestamp = m.messageTimestamp?.toNumber();\r\n        }\r\n\r\n        messagesRaw.push(prepareMessage(m as any));\r\n      }\r\n\r\n      this.addHistoryMessages(\r\n        instance,\r\n        messagesRaw.filter((msg) => !chatwootImport.isIgnorePhoneNumber(msg.key?.remoteJid)),\r\n      );\r\n\r\n      await chatwootImport.importHistoryMessages(instance, this, inbox, this.provider);\r\n      const waInstance = this.waMonitor.waInstances[instance.instanceName];\r\n      waInstance.clearCacheChatwoot();\r\n    } catch (error) {\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { ConfigService, Language } from '@config/env.config';\r\nimport fs from 'fs';\r\nimport i18next from 'i18next';\r\nimport path from 'path';\r\n\r\nconst languages = ['en', 'pt-BR', 'es'];\r\nconst translationsPath = path.join(__dirname, 'translations');\r\nconst configService: ConfigService = new ConfigService();\r\n\r\nconst resources: any = {};\r\n\r\nlanguages.forEach((language) => {\r\n  const languagePath = path.join(translationsPath, `${language}.json`);\r\n  if (fs.existsSync(languagePath)) {\r\n    resources[language] = {\r\n      translation: require(languagePath),\r\n    };\r\n  }\r\n});\r\n\r\ni18next.init({\r\n  resources,\r\n  fallbackLng: 'en',\r\n  lng: configService.get<Language>('LANGUAGE'),\r\n  debug: false,\r\n\r\n  interpolation: {\r\n    escapeValue: false,\r\n  },\r\n});\r\nexport default i18next;\r\n","import axios from 'axios';\r\nimport fs from 'fs';\r\n\r\nconst packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));\r\n\r\nexport interface TelemetryData {\r\n  route: string;\r\n  apiVersion: string;\r\n  timestamp: Date;\r\n}\r\n\r\nexport const sendTelemetry = async (route: string): Promise<void> => {\r\n  const enabled = process.env.TELEMETRY_ENABLED === undefined || process.env.TELEMETRY_ENABLED === 'true';\r\n\r\n  if (!enabled) {\r\n    return;\r\n  }\r\n\r\n  if (route === '/') {\r\n    return;\r\n  }\r\n\r\n  const telemetry: TelemetryData = {\r\n    route,\r\n    apiVersion: `${packageJson.version}`,\r\n    timestamp: new Date(),\r\n  };\r\n\r\n  const url =\r\n    process.env.TELEMETRY_URL && process.env.TELEMETRY_URL !== ''\r\n      ? process.env.TELEMETRY_URL\r\n      : 'https://log.evolution-api.com/telemetry';\r\n\r\n  axios\r\n    .post(url, telemetry)\r\n    .then(() => {})\r\n    .catch(() => {});\r\n};\r\n","/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Integration } from '@api/types/wa.types';\r\nimport { Auth, ConfigService, HttpServer } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Dify, DifySetting, IntegrationSession } from '@prisma/client';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\nimport { Readable } from 'stream';\r\n\r\nexport class DifyService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('DifyService');\r\n\r\n  public async createNewSession(instance: InstanceDto, data: any) {\r\n    try {\r\n      const session = await this.prismaRepository.integrationSession.create({\r\n        data: {\r\n          remoteJid: data.remoteJid,\r\n          pushName: data.pushName,\r\n          sessionId: data.remoteJid,\r\n          status: 'opened',\r\n          awaitUser: false,\r\n          botId: data.botId,\r\n          instanceId: instance.instanceId,\r\n          type: 'dify',\r\n        },\r\n      });\r\n\r\n      return { session };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private isImageMessage(content: string) {\r\n    return content.includes('imageMessage');\r\n  }\r\n\r\n  private isJSON(str: string): boolean {\r\n    try {\r\n      JSON.parse(str);\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async sendMessageToBot(\r\n    instance: any,\r\n    session: IntegrationSession,\r\n    settings: DifySetting,\r\n    dify: Dify,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    content: string,\r\n  ) {\r\n    try {\r\n      let endpoint: string = dify.apiUrl;\r\n\r\n      if (dify.botType === 'chatBot') {\r\n        endpoint += '/chat-messages';\r\n        const payload: any = {\r\n          inputs: {\r\n            remoteJid: remoteJid,\r\n            pushName: pushName,\r\n            instanceName: instance.instanceName,\r\n            serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n            apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n          },\r\n          query: content,\r\n          response_mode: 'blocking',\r\n          conversation_id: session.sessionId === remoteJid ? undefined : session.sessionId,\r\n          user: remoteJid,\r\n        };\r\n\r\n        if (this.isImageMessage(content)) {\r\n          const contentSplit = content.split('|');\r\n\r\n          payload.files = [\r\n            {\r\n              type: 'image',\r\n              transfer_method: 'remote_url',\r\n              url: contentSplit[1].split('?')[0],\r\n            },\r\n          ];\r\n          payload.query = contentSplit[2] || content;\r\n        }\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n          await instance.client.presenceSubscribe(remoteJid);\r\n          await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n        }\r\n\r\n        const response = await axios.post(endpoint, payload, {\r\n          headers: {\r\n            Authorization: `Bearer ${dify.apiKey}`,\r\n          },\r\n        });\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n          await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n        const message = response?.data?.answer;\r\n        const conversationId = response?.data?.conversation_id;\r\n\r\n        await this.sendMessageWhatsApp(instance, remoteJid, message, settings);\r\n\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'opened',\r\n            awaitUser: true,\r\n            sessionId: session.sessionId === remoteJid ? conversationId : session.sessionId,\r\n          },\r\n        });\r\n      }\r\n\r\n      if (dify.botType === 'textGenerator') {\r\n        endpoint += '/completion-messages';\r\n        const payload: any = {\r\n          inputs: {\r\n            query: content,\r\n            pushName: pushName,\r\n            remoteJid: remoteJid,\r\n            instanceName: instance.instanceName,\r\n            serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n            apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n          },\r\n          response_mode: 'blocking',\r\n          conversation_id: session.sessionId === remoteJid ? undefined : session.sessionId,\r\n          user: remoteJid,\r\n        };\r\n\r\n        if (this.isImageMessage(content)) {\r\n          const contentSplit = content.split('|');\r\n\r\n          payload.files = [\r\n            {\r\n              type: 'image',\r\n              transfer_method: 'remote_url',\r\n              url: contentSplit[1].split('?')[0],\r\n            },\r\n          ];\r\n          payload.inputs.query = contentSplit[2] || content;\r\n        }\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n          await instance.client.presenceSubscribe(remoteJid);\r\n          await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n        }\r\n\r\n        const response = await axios.post(endpoint, payload, {\r\n          headers: {\r\n            Authorization: `Bearer ${dify.apiKey}`,\r\n          },\r\n        });\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n          await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n        const message = response?.data?.answer;\r\n        const conversationId = response?.data?.conversation_id;\r\n\r\n        await this.sendMessageWhatsApp(instance, remoteJid, message, settings);\r\n\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'opened',\r\n            awaitUser: true,\r\n            sessionId: session.sessionId === remoteJid ? conversationId : session.sessionId,\r\n          },\r\n        });\r\n      }\r\n\r\n      if (dify.botType === 'agent') {\r\n        endpoint += '/chat-messages';\r\n        const payload: any = {\r\n          inputs: {\r\n            remoteJid: remoteJid,\r\n            pushName: pushName,\r\n            instanceName: instance.instanceName,\r\n            serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n            apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n          },\r\n          query: content,\r\n          response_mode: 'streaming',\r\n          conversation_id: session.sessionId === remoteJid ? undefined : session.sessionId,\r\n          user: remoteJid,\r\n        };\r\n\r\n        if (this.isImageMessage(content)) {\r\n          const contentSplit = content.split('|');\r\n\r\n          payload.files = [\r\n            {\r\n              type: 'image',\r\n              transfer_method: 'remote_url',\r\n              url: contentSplit[1].split('?')[0],\r\n            },\r\n          ];\r\n          payload.query = contentSplit[2] || content;\r\n        }\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n          await instance.client.presenceSubscribe(remoteJid);\r\n          await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n        }\r\n\r\n        const response = await axios.post(endpoint, payload, {\r\n          headers: {\r\n            Authorization: `Bearer ${dify.apiKey}`,\r\n          },\r\n        });\r\n\r\n        let conversationId;\r\n        let answer = '';\r\n\r\n        const data = response.data.replaceAll('data: ', '');\r\n\r\n        const events = data.split('\\n').filter((line) => line.trim() !== '');\r\n\r\n        for (const eventString of events) {\r\n          if (eventString.trim().startsWith('{')) {\r\n            const event = JSON.parse(eventString);\r\n\r\n            if (event?.event === 'agent_message') {\r\n              console.log('event:', event);\r\n              conversationId = conversationId ?? event?.conversation_id;\r\n              answer += event?.answer;\r\n            }\r\n          }\r\n        }\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n          await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n        const message = answer;\r\n\r\n        await this.sendMessageWhatsApp(instance, remoteJid, message, settings);\r\n\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'opened',\r\n            awaitUser: true,\r\n            sessionId: conversationId,\r\n          },\r\n        });\r\n\r\n        return;\r\n      }\r\n\r\n      if (dify.botType === 'workflow') {\r\n        endpoint += '/workflows/run';\r\n        const payload: any = {\r\n          inputs: {\r\n            query: content,\r\n            remoteJid: remoteJid,\r\n            pushName: pushName,\r\n            instanceName: instance.instanceName,\r\n            serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n            apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n          },\r\n          response_mode: 'blocking',\r\n          user: remoteJid,\r\n        };\r\n\r\n        if (this.isImageMessage(content)) {\r\n          const contentSplit = content.split('|');\r\n\r\n          payload.files = [\r\n            {\r\n              type: 'image',\r\n              transfer_method: 'remote_url',\r\n              url: contentSplit[1].split('?')[0],\r\n            },\r\n          ];\r\n          payload.inputs.query = contentSplit[2] || content;\r\n        }\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n          await instance.client.presenceSubscribe(remoteJid);\r\n          await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n        }\r\n\r\n        const response = await axios.post(endpoint, payload, {\r\n          headers: {\r\n            Authorization: `Bearer ${dify.apiKey}`,\r\n          },\r\n        });\r\n\r\n        if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n          await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n        const message = response?.data?.data.outputs.text;\r\n\r\n        await this.sendMessageWhatsApp(instance, remoteJid, message, settings);\r\n\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'opened',\r\n            awaitUser: true,\r\n          },\r\n        });\r\n\r\n        return;\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error.response?.data || error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private async sendMessageWhatsApp(instance: any, remoteJid: string, message: string, settings: DifySetting) {\r\n    const linkRegex = /(!?)\\[(.*?)\\]\\((.*?)\\)/g;\r\n\r\n    let textBuffer = '';\r\n    let lastIndex = 0;\r\n\r\n    let match: RegExpExecArray | null;\r\n\r\n    const getMediaType = (url: string): string | null => {\r\n      const extension = url.split('.').pop()?.toLowerCase();\r\n      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];\r\n      const audioExtensions = ['mp3', 'wav', 'aac', 'ogg'];\r\n      const videoExtensions = ['mp4', 'avi', 'mkv', 'mov'];\r\n      const documentExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];\r\n\r\n      if (imageExtensions.includes(extension || '')) return 'image';\r\n      if (audioExtensions.includes(extension || '')) return 'audio';\r\n      if (videoExtensions.includes(extension || '')) return 'video';\r\n      if (documentExtensions.includes(extension || '')) return 'document';\r\n      return null;\r\n    };\r\n\r\n    while ((match = linkRegex.exec(message)) !== null) {\r\n      const [fullMatch, exclMark, altText, url] = match;\r\n      const mediaType = getMediaType(url);\r\n\r\n      const beforeText = message.slice(lastIndex, match.index);\r\n      if (beforeText) {\r\n        textBuffer += beforeText;\r\n      }\r\n\r\n      if (mediaType) {\r\n        const splitMessages = settings.splitMessages ?? false;\r\n        const timePerChar = settings.timePerChar ?? 0;\r\n        const minDelay = 1000;\r\n        const maxDelay = 20000;\r\n\r\n        if (textBuffer.trim()) {\r\n          if (splitMessages) {\r\n            const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n            for (let index = 0; index < multipleMessages.length; index++) {\r\n              const message = multipleMessages[index];\r\n\r\n              const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.presenceSubscribe(remoteJid);\r\n                await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n              }\r\n\r\n              await new Promise<void>((resolve) => {\r\n                setTimeout(async () => {\r\n                  await instance.textMessage(\r\n                    {\r\n                      number: remoteJid.split('@')[0],\r\n                      delay: settings?.delayMessage || 1000,\r\n                      text: message,\r\n                    },\r\n                    false,\r\n                  );\r\n                  resolve();\r\n                }, delay);\r\n              });\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n              }\r\n            }\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: textBuffer.trim(),\r\n              },\r\n              false,\r\n            );\r\n          }\r\n          textBuffer = '';\r\n        }\r\n\r\n        if (mediaType === 'audio') {\r\n          await instance.audioWhatsapp({\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            audio: url,\r\n            caption: altText,\r\n          });\r\n        } else {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: mediaType,\r\n              media: url,\r\n              caption: altText,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n        }\r\n      } else {\r\n        textBuffer += `[${altText}](${url})`;\r\n      }\r\n\r\n      lastIndex = linkRegex.lastIndex;\r\n    }\r\n\r\n    if (lastIndex < message.length) {\r\n      const remainingText = message.slice(lastIndex);\r\n      if (remainingText.trim()) {\r\n        textBuffer += remainingText;\r\n      }\r\n    }\r\n\r\n    const splitMessages = settings.splitMessages ?? false;\r\n    const timePerChar = settings.timePerChar ?? 0;\r\n    const minDelay = 1000;\r\n    const maxDelay = 20000;\r\n\r\n    if (textBuffer.trim()) {\r\n      if (splitMessages) {\r\n        const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n        for (let index = 0; index < multipleMessages.length; index++) {\r\n          const message = multipleMessages[index];\r\n\r\n          const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.presenceSubscribe(remoteJid);\r\n            await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n          }\r\n\r\n          await new Promise<void>((resolve) => {\r\n            setTimeout(async () => {\r\n              await instance.textMessage(\r\n                {\r\n                  number: remoteJid.split('@')[0],\r\n                  delay: settings?.delayMessage || 1000,\r\n                  text: message,\r\n                },\r\n                false,\r\n              );\r\n              resolve();\r\n            }, delay);\r\n          });\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n          }\r\n        }\r\n      } else {\r\n        await instance.textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            text: textBuffer.trim(),\r\n          },\r\n          false,\r\n        );\r\n      }\r\n    }\r\n\r\n    sendTelemetry('/message/sendText');\r\n  }\r\n\r\n  private async initNewSession(\r\n    instance: any,\r\n    remoteJid: string,\r\n    dify: Dify,\r\n    settings: DifySetting,\r\n    session: IntegrationSession,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    const data = await this.createNewSession(instance, {\r\n      remoteJid,\r\n      pushName,\r\n      botId: dify.id,\r\n    });\r\n\r\n    if (data.session) {\r\n      session = data.session;\r\n    }\r\n\r\n    await this.sendMessageToBot(instance, session, settings, dify, remoteJid, pushName, content);\r\n\r\n    return;\r\n  }\r\n\r\n  public async processDify(\r\n    instance: any,\r\n    remoteJid: string,\r\n    dify: Dify,\r\n    session: IntegrationSession,\r\n    settings: DifySetting,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    if (session && session.status !== 'opened') {\r\n      return;\r\n    }\r\n\r\n    if (session && settings.expire && settings.expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > settings.expire) {\r\n        if (settings.keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: dify.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        await this.initNewSession(instance, remoteJid, dify, settings, session, content, pushName);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!session) {\r\n      await this.initNewSession(instance, remoteJid, dify, settings, session, content, pushName);\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: false,\r\n      },\r\n    });\r\n\r\n    if (!content) {\r\n      if (settings.unknownMessage) {\r\n        this.waMonitor.waInstances[instance.instanceName].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings.delayMessage || 1000,\r\n            text: settings.unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (settings.keywordFinish && content.toLowerCase() === settings.keywordFinish.toLowerCase()) {\r\n      if (settings.keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: dify.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    await this.sendMessageToBot(instance, session, settings, dify, remoteJid, pushName, content);\r\n\r\n    return;\r\n  }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Integration } from '@api/types/wa.types';\r\nimport { ConfigService, Language } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { IntegrationSession, OpenaiBot, OpenaiCreds, OpenaiSetting } from '@prisma/client';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\nimport { downloadMediaMessage } from 'baileys';\r\nimport FormData from 'form-data';\r\nimport OpenAI from 'openai';\r\nimport P from 'pino';\r\n\r\nexport class OpenaiService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  private client: OpenAI;\r\n\r\n  private readonly logger = new Logger('OpenaiService');\r\n\r\n  private async sendMessageToBot(instance: any, openaiBot: OpenaiBot, remoteJid: string, content: string) {\r\n    const systemMessages: any = openaiBot.systemMessages;\r\n\r\n    const messagesSystem: any[] = systemMessages.map((message) => {\r\n      return {\r\n        role: 'system',\r\n        content: message,\r\n      };\r\n    });\r\n\r\n    const assistantMessages: any = openaiBot.assistantMessages;\r\n\r\n    const messagesAssistant: any[] = assistantMessages.map((message) => {\r\n      return {\r\n        role: 'assistant',\r\n        content: message,\r\n      };\r\n    });\r\n\r\n    const userMessages: any = openaiBot.userMessages;\r\n\r\n    const messagesUser: any[] = userMessages.map((message) => {\r\n      return {\r\n        role: 'user',\r\n        content: message,\r\n      };\r\n    });\r\n\r\n    const messageData: any = {\r\n      role: 'user',\r\n      content: [{ type: 'text', text: content }],\r\n    };\r\n\r\n    if (this.isImageMessage(content)) {\r\n      const contentSplit = content.split('|');\r\n\r\n      const url = contentSplit[1].split('?')[0];\r\n\r\n      messageData.content = [\r\n        { type: 'text', text: contentSplit[2] || content },\r\n        {\r\n          type: 'image_url',\r\n          image_url: {\r\n            url: url,\r\n          },\r\n        },\r\n      ];\r\n    }\r\n\r\n    const messages: any[] = [...messagesSystem, ...messagesAssistant, ...messagesUser, messageData];\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n      await instance.client.presenceSubscribe(remoteJid);\r\n      await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n    }\r\n\r\n    const completions = await this.client.chat.completions.create({\r\n      model: openaiBot.model,\r\n      messages: messages,\r\n      max_tokens: openaiBot.maxTokens,\r\n    });\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n      await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n    const message = completions.choices[0].message.content;\r\n\r\n    return message;\r\n  }\r\n\r\n  private async sendMessageToAssistant(\r\n    instance: any,\r\n    openaiBot: OpenaiBot,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    fromMe: boolean,\r\n    content: string,\r\n    threadId: string,\r\n  ) {\r\n    const messageData: any = {\r\n      role: fromMe ? 'assistant' : 'user',\r\n      content: [{ type: 'text', text: content }],\r\n    };\r\n\r\n    if (this.isImageMessage(content)) {\r\n      const contentSplit = content.split('|');\r\n\r\n      const url = contentSplit[1].split('?')[0];\r\n\r\n      messageData.content = [\r\n        { type: 'text', text: contentSplit[2] || content },\r\n        {\r\n          type: 'image_url',\r\n          image_url: {\r\n            url: url,\r\n          },\r\n        },\r\n      ];\r\n    }\r\n\r\n    await this.client.beta.threads.messages.create(threadId, messageData);\r\n\r\n    if (fromMe) {\r\n      sendTelemetry('/message/sendText');\r\n      return;\r\n    }\r\n\r\n    const runAssistant = await this.client.beta.threads.runs.create(threadId, {\r\n      assistant_id: openaiBot.assistantId,\r\n    });\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n      await instance.client.presenceSubscribe(remoteJid);\r\n      await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n    }\r\n\r\n    const response = await this.getAIResponse(threadId, runAssistant.id, openaiBot.functionUrl, remoteJid, pushName);\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n      await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n    const message = response?.data[0].content[0].text.value;\r\n\r\n    return message;\r\n  }\r\n\r\n  private async sendMessageWhatsapp(\r\n    instance: any,\r\n    session: IntegrationSession,\r\n    remoteJid: string,\r\n    settings: OpenaiSetting,\r\n    message: string,\r\n  ) {\r\n    const linkRegex = /(!?)\\[(.*?)\\]\\((.*?)\\)/g;\r\n\r\n    let textBuffer = '';\r\n    let lastIndex = 0;\r\n\r\n    let match: RegExpExecArray | null;\r\n\r\n    const getMediaType = (url: string): string | null => {\r\n      const extension = url.split('.').pop()?.toLowerCase();\r\n      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];\r\n      const audioExtensions = ['mp3', 'wav', 'aac', 'ogg'];\r\n      const videoExtensions = ['mp4', 'avi', 'mkv', 'mov'];\r\n      const documentExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];\r\n\r\n      if (imageExtensions.includes(extension || '')) return 'image';\r\n      if (audioExtensions.includes(extension || '')) return 'audio';\r\n      if (videoExtensions.includes(extension || '')) return 'video';\r\n      if (documentExtensions.includes(extension || '')) return 'document';\r\n      return null;\r\n    };\r\n\r\n    while ((match = linkRegex.exec(message)) !== null) {\r\n      const [fullMatch, exclMark, altText, url] = match;\r\n      const mediaType = getMediaType(url);\r\n\r\n      const beforeText = message.slice(lastIndex, match.index);\r\n      if (beforeText) {\r\n        textBuffer += beforeText;\r\n      }\r\n\r\n      if (mediaType) {\r\n        const splitMessages = settings.splitMessages ?? false;\r\n        const timePerChar = settings.timePerChar ?? 0;\r\n        const minDelay = 1000;\r\n        const maxDelay = 20000;\r\n\r\n        if (textBuffer.trim()) {\r\n          if (splitMessages) {\r\n            const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n            for (let index = 0; index < multipleMessages.length; index++) {\r\n              const message = multipleMessages[index];\r\n\r\n              const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.presenceSubscribe(remoteJid);\r\n                await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n              }\r\n\r\n              await new Promise<void>((resolve) => {\r\n                setTimeout(async () => {\r\n                  await instance.textMessage(\r\n                    {\r\n                      number: remoteJid.split('@')[0],\r\n                      delay: settings?.delayMessage || 1000,\r\n                      text: message,\r\n                    },\r\n                    false,\r\n                  );\r\n                  resolve();\r\n                }, delay);\r\n              });\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n              }\r\n            }\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: textBuffer.trim(),\r\n              },\r\n              false,\r\n            );\r\n          }\r\n          textBuffer = '';\r\n        }\r\n\r\n        if (mediaType === 'audio') {\r\n          await instance.audioWhatsapp({\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            audio: url,\r\n            caption: altText,\r\n          });\r\n        } else {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: mediaType,\r\n              media: url,\r\n              caption: altText,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n        }\r\n      } else {\r\n        textBuffer += `[${altText}](${url})`;\r\n      }\r\n\r\n      lastIndex = linkRegex.lastIndex;\r\n    }\r\n\r\n    if (lastIndex < message.length) {\r\n      const remainingText = message.slice(lastIndex);\r\n      if (remainingText.trim()) {\r\n        textBuffer += remainingText;\r\n      }\r\n    }\r\n\r\n    const splitMessages = settings.splitMessages ?? false;\r\n    const timePerChar = settings.timePerChar ?? 0;\r\n    const minDelay = 1000;\r\n    const maxDelay = 20000;\r\n\r\n    if (textBuffer.trim()) {\r\n      if (splitMessages) {\r\n        const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n        for (let index = 0; index < multipleMessages.length; index++) {\r\n          const message = multipleMessages[index];\r\n\r\n          const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.presenceSubscribe(remoteJid);\r\n            await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n          }\r\n\r\n          await new Promise<void>((resolve) => {\r\n            setTimeout(async () => {\r\n              await instance.textMessage(\r\n                {\r\n                  number: remoteJid.split('@')[0],\r\n                  delay: settings?.delayMessage || 1000,\r\n                  text: message,\r\n                },\r\n                false,\r\n              );\r\n              resolve();\r\n            }, delay);\r\n          });\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n          }\r\n        }\r\n      } else {\r\n        await instance.textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            text: textBuffer.trim(),\r\n          },\r\n          false,\r\n        );\r\n      }\r\n      textBuffer = '';\r\n    }\r\n\r\n    sendTelemetry('/message/sendText');\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async createAssistantNewSession(instance: InstanceDto, data: any) {\r\n    if (data.remoteJid === 'status@broadcast') return;\r\n\r\n    const creds = await this.prismaRepository.openaiCreds.findFirst({\r\n      where: {\r\n        id: data.openaiCredsId,\r\n      },\r\n    });\r\n\r\n    if (!creds) throw new Error('Openai Creds not found');\r\n\r\n    try {\r\n      this.client = new OpenAI({\r\n        apiKey: creds.apiKey,\r\n      });\r\n\r\n      const threadId = (await this.client.beta.threads.create({})).id;\r\n\r\n      let session = null;\r\n      if (threadId) {\r\n        session = await this.prismaRepository.integrationSession.create({\r\n          data: {\r\n            remoteJid: data.remoteJid,\r\n            pushName: data.pushName,\r\n            sessionId: threadId,\r\n            status: 'opened',\r\n            awaitUser: false,\r\n            botId: data.botId,\r\n            instanceId: instance.instanceId,\r\n            type: 'openai',\r\n          },\r\n        });\r\n      }\r\n      return { session };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private async initAssistantNewSession(\r\n    instance: any,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    fromMe: boolean,\r\n    openaiBot: OpenaiBot,\r\n    settings: OpenaiSetting,\r\n    session: IntegrationSession,\r\n    content: string,\r\n  ) {\r\n    const data = await this.createAssistantNewSession(instance, {\r\n      remoteJid,\r\n      pushName,\r\n      openaiCredsId: openaiBot.openaiCredsId,\r\n      botId: openaiBot.id,\r\n    });\r\n\r\n    if (data.session) {\r\n      session = data.session;\r\n    }\r\n\r\n    const message = await this.sendMessageToAssistant(\r\n      instance,\r\n      openaiBot,\r\n      remoteJid,\r\n      pushName,\r\n      fromMe,\r\n      content,\r\n      session.sessionId,\r\n    );\r\n\r\n    await this.sendMessageWhatsapp(instance, session, remoteJid, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  private isJSON(str: string): boolean {\r\n    try {\r\n      JSON.parse(str);\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async getAIResponse(\r\n    threadId: string,\r\n    runId: string,\r\n    functionUrl: string,\r\n    remoteJid: string,\r\n    pushName: string,\r\n  ) {\r\n    const getRun = await this.client.beta.threads.runs.retrieve(threadId, runId);\r\n    let toolCalls;\r\n    switch (getRun.status) {\r\n      case 'requires_action':\r\n        toolCalls = getRun?.required_action?.submit_tool_outputs?.tool_calls;\r\n\r\n        if (toolCalls) {\r\n          for (const toolCall of toolCalls) {\r\n            const id = toolCall.id;\r\n            const functionName = toolCall?.function?.name;\r\n            const functionArgument = this.isJSON(toolCall?.function?.arguments)\r\n              ? JSON.parse(toolCall?.function?.arguments)\r\n              : toolCall?.function?.arguments;\r\n\r\n            let output = null;\r\n\r\n            try {\r\n              const { data } = await axios.post(functionUrl, {\r\n                name: functionName,\r\n                arguments: { ...functionArgument, remoteJid, pushName },\r\n              });\r\n\r\n              output = JSON.stringify(data)\r\n                .replace(/\\\\/g, '\\\\\\\\')\r\n                .replace(/\"/g, '\\\\\"')\r\n                .replace(/\\n/g, '\\\\n')\r\n                .replace(/\\r/g, '\\\\r')\r\n                .replace(/\\t/g, '\\\\t');\r\n            } catch (error) {\r\n              output = JSON.stringify(error)\r\n                .replace(/\\\\/g, '\\\\\\\\')\r\n                .replace(/\"/g, '\\\\\"')\r\n                .replace(/\\n/g, '\\\\n')\r\n                .replace(/\\r/g, '\\\\r')\r\n                .replace(/\\t/g, '\\\\t');\r\n            }\r\n\r\n            await this.client.beta.threads.runs.submitToolOutputs(threadId, runId, {\r\n              tool_outputs: [\r\n                {\r\n                  tool_call_id: id,\r\n                  output,\r\n                },\r\n              ],\r\n            });\r\n          }\r\n        }\r\n\r\n        return this.getAIResponse(threadId, runId, functionUrl, remoteJid, pushName);\r\n      case 'queued':\r\n        await new Promise((resolve) => setTimeout(resolve, 1000));\r\n        return this.getAIResponse(threadId, runId, functionUrl, remoteJid, pushName);\r\n      case 'in_progress':\r\n        await new Promise((resolve) => setTimeout(resolve, 1000));\r\n        return this.getAIResponse(threadId, runId, functionUrl, remoteJid, pushName);\r\n      case 'completed':\r\n        return await this.client.beta.threads.messages.list(threadId, {\r\n          run_id: runId,\r\n          limit: 1,\r\n        });\r\n    }\r\n  }\r\n\r\n  private isImageMessage(content: string) {\r\n    return content.includes('imageMessage');\r\n  }\r\n\r\n  public async processOpenaiAssistant(\r\n    instance: any,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    fromMe: boolean,\r\n    openaiBot: OpenaiBot,\r\n    session: IntegrationSession,\r\n    settings: OpenaiSetting,\r\n    content: string,\r\n  ) {\r\n    if (session && session.status === 'closed') {\r\n      return;\r\n    }\r\n\r\n    if (session && settings.expire && settings.expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > settings.expire) {\r\n        if (settings.keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: openaiBot.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        await this.initAssistantNewSession(\r\n          instance,\r\n          remoteJid,\r\n          pushName,\r\n          fromMe,\r\n          openaiBot,\r\n          settings,\r\n          session,\r\n          content,\r\n        );\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!session) {\r\n      await this.initAssistantNewSession(instance, remoteJid, pushName, fromMe, openaiBot, settings, session, content);\r\n      return;\r\n    }\r\n\r\n    if (session.status !== 'paused')\r\n      await this.prismaRepository.integrationSession.update({\r\n        where: {\r\n          id: session.id,\r\n        },\r\n        data: {\r\n          status: 'opened',\r\n          awaitUser: false,\r\n        },\r\n      });\r\n\r\n    if (!content) {\r\n      if (settings.unknownMessage) {\r\n        this.waMonitor.waInstances[instance.instanceName].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings.delayMessage || 1000,\r\n            text: settings.unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (settings.keywordFinish && content.toLowerCase() === settings.keywordFinish.toLowerCase()) {\r\n      if (settings.keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: openaiBot.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const creds = await this.prismaRepository.openaiCreds.findFirst({\r\n      where: {\r\n        id: openaiBot.openaiCredsId,\r\n      },\r\n    });\r\n\r\n    if (!creds) throw new Error('Openai Creds not found');\r\n\r\n    this.client = new OpenAI({\r\n      apiKey: creds.apiKey,\r\n    });\r\n\r\n    const threadId = session.sessionId;\r\n\r\n    const message = await this.sendMessageToAssistant(\r\n      instance,\r\n      openaiBot,\r\n      remoteJid,\r\n      pushName,\r\n      fromMe,\r\n      content,\r\n      threadId,\r\n    );\r\n\r\n    await this.sendMessageWhatsapp(instance, session, remoteJid, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  public async createChatCompletionNewSession(instance: InstanceDto, data: any) {\r\n    if (data.remoteJid === 'status@broadcast') return;\r\n\r\n    const id = Math.floor(Math.random() * 10000000000).toString();\r\n\r\n    const creds = await this.prismaRepository.openaiCreds.findFirst({\r\n      where: {\r\n        id: data.openaiCredsId,\r\n      },\r\n    });\r\n\r\n    if (!creds) throw new Error('Openai Creds not found');\r\n\r\n    try {\r\n      const session = await this.prismaRepository.integrationSession.create({\r\n        data: {\r\n          remoteJid: data.remoteJid,\r\n          pushName: data.pushName,\r\n          sessionId: id,\r\n          status: 'opened',\r\n          awaitUser: false,\r\n          botId: data.botId,\r\n          instanceId: instance.instanceId,\r\n          type: 'openai',\r\n        },\r\n      });\r\n\r\n      return { session, creds };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private async initChatCompletionNewSession(\r\n    instance: any,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    openaiBot: OpenaiBot,\r\n    settings: OpenaiSetting,\r\n    session: IntegrationSession,\r\n    content: string,\r\n  ) {\r\n    const data = await this.createChatCompletionNewSession(instance, {\r\n      remoteJid,\r\n      pushName,\r\n      openaiCredsId: openaiBot.openaiCredsId,\r\n      botId: openaiBot.id,\r\n    });\r\n\r\n    session = data.session;\r\n\r\n    const creds = data.creds;\r\n\r\n    this.client = new OpenAI({\r\n      apiKey: creds.apiKey,\r\n    });\r\n\r\n    const message = await this.sendMessageToBot(instance, openaiBot, remoteJid, content);\r\n\r\n    await this.sendMessageWhatsapp(instance, session, remoteJid, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  public async processOpenaiChatCompletion(\r\n    instance: any,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    openaiBot: OpenaiBot,\r\n    session: IntegrationSession,\r\n    settings: OpenaiSetting,\r\n    content: string,\r\n  ) {\r\n    if (session && session.status !== 'opened') {\r\n      return;\r\n    }\r\n\r\n    if (session && settings.expire && settings.expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > settings.expire) {\r\n        if (settings.keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: openaiBot.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        await this.initChatCompletionNewSession(instance, remoteJid, pushName, openaiBot, settings, session, content);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!session) {\r\n      await this.initChatCompletionNewSession(instance, remoteJid, pushName, openaiBot, settings, session, content);\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: false,\r\n      },\r\n    });\r\n\r\n    if (!content) {\r\n      if (settings.unknownMessage) {\r\n        this.waMonitor.waInstances[instance.instanceName].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings.delayMessage || 1000,\r\n            text: settings.unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (settings.keywordFinish && content.toLowerCase() === settings.keywordFinish.toLowerCase()) {\r\n      if (settings.keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: openaiBot.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const creds = await this.prismaRepository.openaiCreds.findFirst({\r\n      where: {\r\n        id: openaiBot.openaiCredsId,\r\n      },\r\n    });\r\n\r\n    if (!creds) throw new Error('Openai Creds not found');\r\n\r\n    this.client = new OpenAI({\r\n      apiKey: creds.apiKey,\r\n    });\r\n\r\n    const message = await this.sendMessageToBot(instance, openaiBot, remoteJid, content);\r\n\r\n    await this.sendMessageWhatsapp(instance, session, remoteJid, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  public async speechToText(creds: OpenaiCreds, msg: any, updateMediaMessage: any) {\r\n    let audio;\r\n\r\n    if (msg?.message?.mediaUrl) {\r\n      audio = await axios.get(msg.message.mediaUrl, { responseType: 'arraybuffer' }).then((response) => {\r\n        return Buffer.from(response.data, 'binary');\r\n      });\r\n    } else {\r\n      audio = await downloadMediaMessage(\r\n        { key: msg.key, message: msg?.message },\r\n        'buffer',\r\n        {},\r\n        {\r\n          logger: P({ level: 'error' }) as any,\r\n          reuploadRequest: updateMediaMessage,\r\n        },\r\n      );\r\n    }\r\n\r\n    const lang = this.configService.get<Language>('LANGUAGE').includes('pt')\r\n      ? 'pt'\r\n      : this.configService.get<Language>('LANGUAGE');\r\n\r\n    const formData = new FormData();\r\n\r\n    formData.append('file', audio, 'audio.ogg');\r\n    formData.append('model', 'whisper-1');\r\n    formData.append('language', lang);\r\n\r\n    const response = await axios.post('https://api.openai.com/v1/audio/transcriptions', formData, {\r\n      headers: {\r\n        'Content-Type': 'multipart/form-data',\r\n        Authorization: `Bearer ${creds.apiKey}`,\r\n      },\r\n    });\r\n\r\n    return response?.data?.text;\r\n  }\r\n}\r\n","import { configService, S3 } from '@config/env.config';\r\n\r\nconst getTypeMessage = (msg: any) => {\r\n  let mediaId: string;\r\n\r\n  if (configService.get<S3>('S3').ENABLE) mediaId = msg.message.mediaUrl;\r\n  else mediaId = msg.key.id;\r\n\r\n  const types = {\r\n    conversation: msg?.message?.conversation,\r\n    extendedTextMessage: msg?.message?.extendedTextMessage?.text,\r\n    contactMessage: msg?.message?.contactMessage?.displayName,\r\n    locationMessage: msg?.message?.locationMessage?.degreesLatitude,\r\n    viewOnceMessageV2:\r\n      msg?.message?.viewOnceMessageV2?.message?.imageMessage?.url ||\r\n      msg?.message?.viewOnceMessageV2?.message?.videoMessage?.url ||\r\n      msg?.message?.viewOnceMessageV2?.message?.audioMessage?.url,\r\n    listResponseMessage: msg?.message?.listResponseMessage?.title,\r\n    responseRowId: msg?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,\r\n    templateButtonReplyMessage:\r\n      msg?.message?.templateButtonReplyMessage?.selectedId || msg?.message?.buttonsResponseMessage?.selectedButtonId,\r\n    // Medias\r\n    audioMessage: msg?.message?.speechToText\r\n      ? msg?.message?.speechToText\r\n      : msg?.message?.audioMessage\r\n        ? `audioMessage|${mediaId}`\r\n        : undefined,\r\n    imageMessage: msg?.message?.imageMessage\r\n      ? `imageMessage|${mediaId}${msg?.message?.imageMessage?.caption ? `|${msg?.message?.imageMessage?.caption}` : ''}`\r\n      : undefined,\r\n    videoMessage: msg?.message?.videoMessage\r\n      ? `videoMessage|${mediaId}${msg?.message?.videoMessage?.caption ? `|${msg?.message?.videoMessage?.caption}` : ''}`\r\n      : undefined,\r\n    documentMessage: msg?.message?.documentMessage\r\n      ? `documentMessage|${mediaId}${\r\n          msg?.message?.documentMessage?.caption ? `|${msg?.message?.documentMessage?.caption}` : ''\r\n        }`\r\n      : undefined,\r\n    documentWithCaptionMessage: msg?.message?.documentWithCaptionMessage?.message?.documentMessage\r\n      ? `documentWithCaptionMessage|${mediaId}${\r\n          msg?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption\r\n            ? `|${msg?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`\r\n            : ''\r\n        }`\r\n      : undefined,\r\n    externalAdReplyBody: msg?.contextInfo?.externalAdReply?.body\r\n      ? `externalAdReplyBody|${msg.contextInfo.externalAdReply.body}`\r\n      : undefined,\r\n  };\r\n\r\n  const messageType = Object.keys(types).find((key) => types[key] !== undefined) || 'unknown';\r\n\r\n  return { ...types, messageType };\r\n};\r\n\r\nconst getMessageContent = (types: any) => {\r\n  const typeKey = Object.keys(types).find((key) => key !== 'externalAdReplyBody' && types[key] !== undefined);\r\n\r\n  let result = typeKey ? types[typeKey] : undefined;\r\n\r\n  if (types.externalAdReplyBody) {\r\n    result = result ? `${result}\\n${types.externalAdReplyBody}` : types.externalAdReplyBody;\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nexport const getConversationMessage = (msg: any) => {\r\n  const types = getTypeMessage(msg);\r\n\r\n  const messageContent = getMessageContent(types);\r\n\r\n  return messageContent;\r\n};\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Auth, ConfigService, HttpServer, Typebot } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Instance, IntegrationSession, Message, Typebot as TypebotModel } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\n\r\nexport class TypebotService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('TypebotService');\r\n\r\n  public async createNewSession(instance: Instance, data: any) {\r\n    if (data.remoteJid === 'status@broadcast') return;\r\n    const id = Math.floor(Math.random() * 10000000000).toString();\r\n\r\n    try {\r\n      const version = this.configService.get<Typebot>('TYPEBOT').API_VERSION;\r\n      let url: string;\r\n      let reqData: {};\r\n      if (version === 'latest') {\r\n        url = `${data.url}/api/v1/typebots/${data.typebot}/startChat`;\r\n\r\n        reqData = {\r\n          prefilledVariables: {\r\n            ...data.prefilledVariables,\r\n            remoteJid: data.remoteJid,\r\n            pushName: data.pushName || data.prefilledVariables?.pushName || '',\r\n            instanceName: instance.name,\r\n            serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n            apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n            ownerJid: instance.number,\r\n          },\r\n        };\r\n      } else {\r\n        url = `${data.url}/api/v1/sendMessage`;\r\n\r\n        reqData = {\r\n          startParams: {\r\n            publicId: data.typebot,\r\n            prefilledVariables: {\r\n              ...data.prefilledVariables,\r\n              remoteJid: data.remoteJid,\r\n              pushName: data.pushName || data.prefilledVariables?.pushName || '',\r\n              instanceName: instance.name,\r\n              serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n              apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n              ownerJid: instance.number,\r\n            },\r\n          },\r\n        };\r\n      }\r\n      const request = await axios.post(url, reqData);\r\n\r\n      let session = null;\r\n      if (request?.data?.sessionId) {\r\n        session = await this.prismaRepository.integrationSession.create({\r\n          data: {\r\n            remoteJid: data.remoteJid,\r\n            pushName: data.pushName || '',\r\n            sessionId: `${id}-${request.data.sessionId}`,\r\n            status: 'opened',\r\n            parameters: {\r\n              ...data.prefilledVariables,\r\n              remoteJid: data.remoteJid,\r\n              pushName: data.pushName || '',\r\n              instanceName: instance.name,\r\n              serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n              apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n              ownerJid: instance.number,\r\n            },\r\n            awaitUser: false,\r\n            botId: data.botId,\r\n            instanceId: instance.id,\r\n            type: 'typebot',\r\n          },\r\n        });\r\n      }\r\n      return { ...request.data, session };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  public async sendWAMessage(\r\n    instance: Instance,\r\n    session: IntegrationSession,\r\n    settings: {\r\n      expire: number;\r\n      keywordFinish: string;\r\n      delayMessage: number;\r\n      unknownMessage: string;\r\n      listeningFromMe: boolean;\r\n      stopBotFromMe: boolean;\r\n      keepOpen: boolean;\r\n    },\r\n    remoteJid: string,\r\n    messages: any,\r\n    input: any,\r\n    clientSideActions: any,\r\n  ) {\r\n    processMessages(\r\n      this.waMonitor.waInstances[instance.name],\r\n      session,\r\n      settings,\r\n      messages,\r\n      input,\r\n      clientSideActions,\r\n      applyFormatting,\r\n      this.prismaRepository,\r\n    ).catch((err) => {\r\n      console.error('Erro ao processar mensagens:', err);\r\n    });\r\n\r\n    function findItemAndGetSecondsToWait(array, targetId) {\r\n      if (!array) return null;\r\n\r\n      for (const item of array) {\r\n        if (item.lastBubbleBlockId === targetId) {\r\n          return item.wait?.secondsToWaitFor;\r\n        }\r\n      }\r\n      return null;\r\n    }\r\n\r\n    function applyFormatting(element) {\r\n      let text = '';\r\n\r\n      if (element.text) {\r\n        text += element.text;\r\n      }\r\n\r\n      if (element.children && element.type !== 'a') {\r\n        for (const child of element.children) {\r\n          text += applyFormatting(child);\r\n        }\r\n      }\r\n\r\n      if (element.type === 'p' && element.type !== 'inline-variable') {\r\n        text = text.trim() + '\\n';\r\n      }\r\n\r\n      if (element.type === 'inline-variable') {\r\n        text = text.trim();\r\n      }\r\n\r\n      if (element.type === 'ol') {\r\n        text =\r\n          '\\n' +\r\n          text\r\n            .split('\\n')\r\n            .map((line, index) => (line ? `${index + 1}. ${line}` : ''))\r\n            .join('\\n');\r\n      }\r\n\r\n      if (element.type === 'li') {\r\n        text = text\r\n          .split('\\n')\r\n          .map((line) => (line ? `  ${line}` : ''))\r\n          .join('\\n');\r\n      }\r\n\r\n      let formats = '';\r\n\r\n      if (element.bold) {\r\n        formats += '*';\r\n      }\r\n\r\n      if (element.italic) {\r\n        formats += '_';\r\n      }\r\n\r\n      if (element.underline) {\r\n        formats += '~';\r\n      }\r\n\r\n      let formattedText = `${formats}${text}${formats.split('').reverse().join('')}`;\r\n\r\n      if (element.url) {\r\n        formattedText = element.children[0]?.text ? `[${formattedText}]\\n(${element.url})` : `${element.url}`;\r\n      }\r\n\r\n      return formattedText;\r\n    }\r\n\r\n    async function processMessages(\r\n      instance: any,\r\n      session: IntegrationSession,\r\n      settings: {\r\n        expire: number;\r\n        keywordFinish: string;\r\n        delayMessage: number;\r\n        unknownMessage: string;\r\n        listeningFromMe: boolean;\r\n        stopBotFromMe: boolean;\r\n        keepOpen: boolean;\r\n      },\r\n      messages: any,\r\n      input: any,\r\n      clientSideActions: any,\r\n      applyFormatting: any,\r\n      prismaRepository: PrismaRepository,\r\n    ) {\r\n      for (const message of messages) {\r\n        if (message.type === 'text') {\r\n          let formattedText = '';\r\n\r\n          for (const richText of message.content.richText) {\r\n            for (const element of richText.children) {\r\n              formattedText += applyFormatting(element);\r\n            }\r\n            formattedText += '\\n';\r\n          }\r\n\r\n          formattedText = formattedText.replace(/\\*\\*/g, '').replace(/__/, '').replace(/~~/, '').replace(/\\n$/, '');\r\n\r\n          formattedText = formattedText.replace(/\\n$/, '');\r\n\r\n          if (formattedText.includes('[list]')) {\r\n            const listJson = {\r\n              number: remoteJid.split('@')[0],\r\n              title: '',\r\n              description: '',\r\n              buttonText: '',\r\n              footerText: '',\r\n              sections: [],\r\n            };\r\n\r\n            const titleMatch = formattedText.match(/\\[title\\]([\\s\\S]*?)(?=\\[description\\])/);\r\n            const descriptionMatch = formattedText.match(/\\[description\\]([\\s\\S]*?)(?=\\[buttonText\\])/);\r\n            const buttonTextMatch = formattedText.match(/\\[buttonText\\]([\\s\\S]*?)(?=\\[footerText\\])/);\r\n            const footerTextMatch = formattedText.match(/\\[footerText\\]([\\s\\S]*?)(?=\\[menu\\])/);\r\n\r\n            if (titleMatch) listJson.title = titleMatch[1].trim();\r\n            if (descriptionMatch) listJson.description = descriptionMatch[1].trim();\r\n            if (buttonTextMatch) listJson.buttonText = buttonTextMatch[1].trim();\r\n            if (footerTextMatch) listJson.footerText = footerTextMatch[1].trim();\r\n\r\n            const menuContent = formattedText.match(/\\[menu\\]([\\s\\S]*?)\\[\\/menu\\]/)?.[1];\r\n            if (menuContent) {\r\n              const sections = menuContent.match(/\\[section\\]([\\s\\S]*?)(?=\\[section\\]|\\[\\/section\\]|\\[\\/menu\\])/g);\r\n              if (sections) {\r\n                sections.forEach((section) => {\r\n                  const sectionTitle = section.match(/title: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                  const rows = section.match(/\\[row\\]([\\s\\S]*?)(?=\\[row\\]|\\[\\/row\\]|\\[\\/section\\]|\\[\\/menu\\])/g);\r\n\r\n                  const sectionData = {\r\n                    title: sectionTitle,\r\n                    rows:\r\n                      rows?.map((row) => ({\r\n                        title: row.match(/title: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                        description: row.match(/description: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                        rowId: row.match(/rowId: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                      })) || [],\r\n                  };\r\n\r\n                  listJson.sections.push(sectionData);\r\n                });\r\n              }\r\n            }\r\n\r\n            await instance.listMessage(listJson);\r\n          } else if (formattedText.includes('[buttons]')) {\r\n            const buttonJson = {\r\n              number: remoteJid.split('@')[0],\r\n              thumbnailUrl: undefined,\r\n              title: '',\r\n              description: '',\r\n              footer: '',\r\n              buttons: [],\r\n            };\r\n\r\n            const thumbnailUrlMatch = formattedText.match(/\\[thumbnailUrl\\]([\\s\\S]*?)(?=\\[title\\])/);\r\n            const titleMatch = formattedText.match(/\\[title\\]([\\s\\S]*?)(?=\\[description\\])/);\r\n            const descriptionMatch = formattedText.match(/\\[description\\]([\\s\\S]*?)(?=\\[footer\\])/);\r\n            const footerMatch = formattedText.match(/\\[footer\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url))/);\r\n\r\n            if (titleMatch) buttonJson.title = titleMatch[1].trim();\r\n            if (thumbnailUrlMatch) buttonJson.thumbnailUrl = thumbnailUrlMatch[1].trim();\r\n            if (descriptionMatch) buttonJson.description = descriptionMatch[1].trim();\r\n            if (footerMatch) buttonJson.footer = footerMatch[1].trim();\r\n\r\n            const buttonTypes = {\r\n              reply: /\\[reply\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              pix: /\\[pix\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              copy: /\\[copy\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              call: /\\[call\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              url: /\\[url\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n            };\r\n\r\n            for (const [type, pattern] of Object.entries(buttonTypes)) {\r\n              let match;\r\n              while ((match = pattern.exec(formattedText)) !== null) {\r\n                const content = match[1].trim();\r\n                const button: any = { type };\r\n\r\n                switch (type) {\r\n                  case 'pix':\r\n                    button.currency = content.match(/currency: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.name = content.match(/name: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.keyType = content.match(/keyType: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.key = content.match(/key: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'reply':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.id = content.match(/id: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'copy':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.copyCode = content.match(/copyCode: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'call':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.phoneNumber = content.match(/phone: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'url':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.url = content.match(/url: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n                }\r\n\r\n                if (Object.keys(button).length > 1) {\r\n                  buttonJson.buttons.push(button);\r\n                }\r\n              }\r\n            }\r\n\r\n            await instance.buttonMessage(buttonJson);\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: formattedText,\r\n              },\r\n              false,\r\n            );\r\n          }\r\n\r\n          sendTelemetry('/message/sendText');\r\n        }\r\n\r\n        if (message.type === 'image') {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: 'image',\r\n              media: message.content.url,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n\r\n          sendTelemetry('/message/sendMedia');\r\n        }\r\n\r\n        if (message.type === 'video') {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: 'video',\r\n              media: message.content.url,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n\r\n          sendTelemetry('/message/sendMedia');\r\n        }\r\n\r\n        if (message.type === 'audio') {\r\n          await instance.audioWhatsapp(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              encoding: true,\r\n              audio: message.content.url,\r\n            },\r\n            false,\r\n          );\r\n\r\n          sendTelemetry('/message/sendWhatsAppAudio');\r\n        }\r\n\r\n        const wait = findItemAndGetSecondsToWait(clientSideActions, message.id);\r\n\r\n        if (wait) {\r\n          await new Promise((resolve) => setTimeout(resolve, wait * 1000));\r\n        }\r\n      }\r\n\r\n      console.log('input', input);\r\n      if (input) {\r\n        if (input.type === 'choice input') {\r\n          let formattedText = '';\r\n\r\n          const items = input.items;\r\n\r\n          for (const item of items) {\r\n            formattedText += ` ${item.content}\\n`;\r\n          }\r\n\r\n          formattedText = formattedText.replace(/\\n$/, '');\r\n\r\n          if (formattedText.includes('[list]')) {\r\n            const listJson = {\r\n              number: remoteJid.split('@')[0],\r\n              title: '',\r\n              description: '',\r\n              buttonText: '',\r\n              footerText: '',\r\n              sections: [],\r\n            };\r\n\r\n            const titleMatch = formattedText.match(/\\[title\\]([\\s\\S]*?)(?=\\[description\\])/);\r\n            const descriptionMatch = formattedText.match(/\\[description\\]([\\s\\S]*?)(?=\\[buttonText\\])/);\r\n            const buttonTextMatch = formattedText.match(/\\[buttonText\\]([\\s\\S]*?)(?=\\[footerText\\])/);\r\n            const footerTextMatch = formattedText.match(/\\[footerText\\]([\\s\\S]*?)(?=\\[menu\\])/);\r\n\r\n            if (titleMatch) listJson.title = titleMatch[1].trim();\r\n            if (descriptionMatch) listJson.description = descriptionMatch[1].trim();\r\n            if (buttonTextMatch) listJson.buttonText = buttonTextMatch[1].trim();\r\n            if (footerTextMatch) listJson.footerText = footerTextMatch[1].trim();\r\n\r\n            const menuContent = formattedText.match(/\\[menu\\]([\\s\\S]*?)\\[\\/menu\\]/)?.[1];\r\n            if (menuContent) {\r\n              const sections = menuContent.match(/\\[section\\]([\\s\\S]*?)(?=\\[section\\]|\\[\\/section\\]|\\[\\/menu\\])/g);\r\n              if (sections) {\r\n                sections.forEach((section) => {\r\n                  const sectionTitle = section.match(/title: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                  const rows = section.match(/\\[row\\]([\\s\\S]*?)(?=\\[row\\]|\\[\\/row\\]|\\[\\/section\\]|\\[\\/menu\\])/g);\r\n\r\n                  const sectionData = {\r\n                    title: sectionTitle,\r\n                    rows:\r\n                      rows?.map((row) => ({\r\n                        title: row.match(/title: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                        description: row.match(/description: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                        rowId: row.match(/rowId: (.*?)(?:\\n|$)/)?.[1]?.trim(),\r\n                      })) || [],\r\n                  };\r\n\r\n                  listJson.sections.push(sectionData);\r\n                });\r\n              }\r\n            }\r\n\r\n            await instance.listMessage(listJson);\r\n          } else if (formattedText.includes('[buttons]')) {\r\n            const buttonJson = {\r\n              number: remoteJid.split('@')[0],\r\n              thumbnailUrl: undefined,\r\n              title: '',\r\n              description: '',\r\n              footer: '',\r\n              buttons: [],\r\n            };\r\n\r\n            const thumbnailUrlMatch = formattedText.match(/\\[thumbnailUrl\\]([\\s\\S]*?)(?=\\[title\\])/);\r\n            const titleMatch = formattedText.match(/\\[title\\]([\\s\\S]*?)(?=\\[description\\])/);\r\n            const descriptionMatch = formattedText.match(/\\[description\\]([\\s\\S]*?)(?=\\[footer\\])/);\r\n            const footerMatch = formattedText.match(/\\[footer\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url))/);\r\n\r\n            if (titleMatch) buttonJson.title = titleMatch[1].trim();\r\n            if (thumbnailUrlMatch) buttonJson.thumbnailUrl = thumbnailUrlMatch[1].trim();\r\n            if (descriptionMatch) buttonJson.description = descriptionMatch[1].trim();\r\n            if (footerMatch) buttonJson.footer = footerMatch[1].trim();\r\n\r\n            const buttonTypes = {\r\n              reply: /\\[reply\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              pix: /\\[pix\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              copy: /\\[copy\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              call: /\\[call\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n              url: /\\[url\\]([\\s\\S]*?)(?=\\[(?:reply|pix|copy|call|url)|$)/g,\r\n            };\r\n\r\n            for (const [type, pattern] of Object.entries(buttonTypes)) {\r\n              let match;\r\n              while ((match = pattern.exec(formattedText)) !== null) {\r\n                const content = match[1].trim();\r\n                const button: any = { type };\r\n\r\n                switch (type) {\r\n                  case 'pix':\r\n                    button.currency = content.match(/currency: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.name = content.match(/name: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.keyType = content.match(/keyType: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.key = content.match(/key: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'reply':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.id = content.match(/id: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'copy':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.copyCode = content.match(/copyCode: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'call':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.phoneNumber = content.match(/phone: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n\r\n                  case 'url':\r\n                    button.displayText = content.match(/displayText: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    button.url = content.match(/url: (.*?)(?:\\n|$)/)?.[1]?.trim();\r\n                    break;\r\n                }\r\n\r\n                if (Object.keys(button).length > 1) {\r\n                  buttonJson.buttons.push(button);\r\n                }\r\n              }\r\n            }\r\n\r\n            await instance.buttonMessage(buttonJson);\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: formattedText,\r\n              },\r\n              false,\r\n            );\r\n          }\r\n\r\n          sendTelemetry('/message/sendText');\r\n        }\r\n\r\n        await prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            awaitUser: true,\r\n          },\r\n        });\r\n      } else {\r\n        if (!settings?.keepOpen) {\r\n          await prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n          });\r\n        } else {\r\n          await prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public async processTypebot(\r\n    instance: Instance,\r\n    remoteJid: string,\r\n    msg: Message,\r\n    session: IntegrationSession,\r\n    findTypebot: TypebotModel,\r\n    url: string,\r\n    expire: number,\r\n    typebot: string,\r\n    keywordFinish: string,\r\n    delayMessage: number,\r\n    unknownMessage: string,\r\n    listeningFromMe: boolean,\r\n    stopBotFromMe: boolean,\r\n    keepOpen: boolean,\r\n    content: string,\r\n    prefilledVariables?: any,\r\n  ) {\r\n    if (session && expire && expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > expire) {\r\n        if (keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: findTypebot.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        const data = await this.createNewSession(instance, {\r\n          enabled: findTypebot?.enabled,\r\n          url: url,\r\n          typebot: typebot,\r\n          expire: expire,\r\n          keywordFinish: keywordFinish,\r\n          delayMessage: delayMessage,\r\n          unknownMessage: unknownMessage,\r\n          listeningFromMe: listeningFromMe,\r\n          remoteJid: remoteJid,\r\n          pushName: msg.pushName,\r\n          botId: findTypebot.id,\r\n          prefilledVariables: prefilledVariables,\r\n        });\r\n\r\n        if (data.session) {\r\n          session = data.session;\r\n        }\r\n\r\n        if (data.messages.length === 0) {\r\n          const content = getConversationMessage(msg.message);\r\n\r\n          if (!content) {\r\n            if (unknownMessage) {\r\n              this.waMonitor.waInstances[instance.name].textMessage(\r\n                {\r\n                  number: remoteJid.split('@')[0],\r\n                  delay: delayMessage || 1000,\r\n                  text: unknownMessage,\r\n                },\r\n                false,\r\n              );\r\n\r\n              sendTelemetry('/message/sendText');\r\n            }\r\n            return;\r\n          }\r\n\r\n          if (keywordFinish && content.toLowerCase() === keywordFinish.toLowerCase()) {\r\n            if (keepOpen) {\r\n              await this.prismaRepository.integrationSession.update({\r\n                where: {\r\n                  id: session.id,\r\n                },\r\n                data: {\r\n                  status: 'closed',\r\n                },\r\n              });\r\n            } else {\r\n              await this.prismaRepository.integrationSession.deleteMany({\r\n                where: {\r\n                  botId: findTypebot.id,\r\n                  remoteJid: remoteJid,\r\n                },\r\n              });\r\n            }\r\n            return;\r\n          }\r\n\r\n          try {\r\n            const version = this.configService.get<Typebot>('TYPEBOT').API_VERSION;\r\n            let urlTypebot: string;\r\n            let reqData: {};\r\n            if (version === 'latest') {\r\n              urlTypebot = `${url}/api/v1/sessions/${data.sessionId}/continueChat`;\r\n              reqData = {\r\n                message: content,\r\n              };\r\n            } else {\r\n              urlTypebot = `${url}/api/v1/sendMessage`;\r\n              reqData = {\r\n                message: content,\r\n                sessionId: data.sessionId,\r\n              };\r\n            }\r\n\r\n            const request = await axios.post(urlTypebot, reqData);\r\n\r\n            await this.sendWAMessage(\r\n              instance,\r\n              session,\r\n              {\r\n                expire: expire,\r\n                keywordFinish: keywordFinish,\r\n                delayMessage: delayMessage,\r\n                unknownMessage: unknownMessage,\r\n                listeningFromMe: listeningFromMe,\r\n                stopBotFromMe: stopBotFromMe,\r\n                keepOpen: keepOpen,\r\n              },\r\n              remoteJid,\r\n              request.data.messages,\r\n              request.data.input,\r\n              request.data.clientSideActions,\r\n            );\r\n          } catch (error) {\r\n            this.logger.error(error);\r\n            return;\r\n          }\r\n        }\r\n\r\n        await this.sendWAMessage(\r\n          instance,\r\n          session,\r\n          {\r\n            expire: expire,\r\n            keywordFinish: keywordFinish,\r\n            delayMessage: delayMessage,\r\n            unknownMessage: unknownMessage,\r\n            listeningFromMe: listeningFromMe,\r\n            stopBotFromMe: stopBotFromMe,\r\n            keepOpen: keepOpen,\r\n          },\r\n          remoteJid,\r\n          data.messages,\r\n          data.input,\r\n          data.clientSideActions,\r\n        );\r\n\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (session && session.status !== 'opened') {\r\n      return;\r\n    }\r\n\r\n    if (!session) {\r\n      const data = await this.createNewSession(instance, {\r\n        enabled: findTypebot?.enabled,\r\n        url: url,\r\n        typebot: typebot,\r\n        expire: expire,\r\n        keywordFinish: keywordFinish,\r\n        delayMessage: delayMessage,\r\n        unknownMessage: unknownMessage,\r\n        listeningFromMe: listeningFromMe,\r\n        remoteJid: remoteJid,\r\n        pushName: msg?.pushName,\r\n        botId: findTypebot.id,\r\n        prefilledVariables: prefilledVariables,\r\n      });\r\n\r\n      if (data?.session) {\r\n        session = data.session;\r\n      }\r\n\r\n      await this.sendWAMessage(\r\n        instance,\r\n        session,\r\n        {\r\n          expire: expire,\r\n          keywordFinish: keywordFinish,\r\n          delayMessage: delayMessage,\r\n          unknownMessage: unknownMessage,\r\n          listeningFromMe: listeningFromMe,\r\n          stopBotFromMe: stopBotFromMe,\r\n          keepOpen: keepOpen,\r\n        },\r\n        remoteJid,\r\n        data?.messages,\r\n        data?.input,\r\n        data?.clientSideActions,\r\n      );\r\n\r\n      if (data.messages.length === 0) {\r\n        if (!content) {\r\n          if (unknownMessage) {\r\n            this.waMonitor.waInstances[instance.name].textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: delayMessage || 1000,\r\n                text: unknownMessage,\r\n              },\r\n              false,\r\n            );\r\n\r\n            sendTelemetry('/message/sendText');\r\n          }\r\n          return;\r\n        }\r\n\r\n        if (keywordFinish && content.toLowerCase() === keywordFinish.toLowerCase()) {\r\n          if (keepOpen) {\r\n            await this.prismaRepository.integrationSession.update({\r\n              where: {\r\n                id: session.id,\r\n              },\r\n              data: {\r\n                status: 'closed',\r\n              },\r\n            });\r\n          } else {\r\n            await this.prismaRepository.integrationSession.deleteMany({\r\n              where: {\r\n                botId: findTypebot.id,\r\n                remoteJid: remoteJid,\r\n              },\r\n            });\r\n          }\r\n\r\n          return;\r\n        }\r\n\r\n        let request: any;\r\n        try {\r\n          const version = this.configService.get<Typebot>('TYPEBOT').API_VERSION;\r\n          let urlTypebot: string;\r\n          let reqData: {};\r\n          if (version === 'latest') {\r\n            urlTypebot = `${url}/api/v1/sessions/${data.sessionId}/continueChat`;\r\n            reqData = {\r\n              message: content,\r\n            };\r\n          } else {\r\n            urlTypebot = `${url}/api/v1/sendMessage`;\r\n            reqData = {\r\n              message: content,\r\n              sessionId: data.sessionId,\r\n            };\r\n          }\r\n          request = await axios.post(urlTypebot, reqData);\r\n\r\n          await this.sendWAMessage(\r\n            instance,\r\n            session,\r\n            {\r\n              expire: expire,\r\n              keywordFinish: keywordFinish,\r\n              delayMessage: delayMessage,\r\n              unknownMessage: unknownMessage,\r\n              listeningFromMe: listeningFromMe,\r\n              stopBotFromMe: stopBotFromMe,\r\n              keepOpen: keepOpen,\r\n            },\r\n            remoteJid,\r\n            request.data.messages,\r\n            request.data.input,\r\n            request.data.clientSideActions,\r\n          );\r\n        } catch (error) {\r\n          this.logger.error(error);\r\n          return;\r\n        }\r\n      }\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: false,\r\n      },\r\n    });\r\n\r\n    if (!content) {\r\n      if (unknownMessage) {\r\n        this.waMonitor.waInstances[instance.name].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: delayMessage || 1000,\r\n            text: unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (keywordFinish && content.toLowerCase() === keywordFinish.toLowerCase()) {\r\n      if (keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: findTypebot.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const version = this.configService.get<Typebot>('TYPEBOT').API_VERSION;\r\n    let urlTypebot: string;\r\n    let reqData: {};\r\n    if (version === 'latest') {\r\n      urlTypebot = `${url}/api/v1/sessions/${session.sessionId.split('-')[1]}/continueChat`;\r\n      reqData = {\r\n        message: content,\r\n      };\r\n    } else {\r\n      urlTypebot = `${url}/api/v1/sendMessage`;\r\n      reqData = {\r\n        message: content,\r\n        sessionId: session.sessionId.split('-')[1],\r\n      };\r\n    }\r\n    const request = await axios.post(urlTypebot, reqData);\r\n\r\n    await this.sendWAMessage(\r\n      instance,\r\n      session,\r\n      {\r\n        expire: expire,\r\n        keywordFinish: keywordFinish,\r\n        delayMessage: delayMessage,\r\n        unknownMessage: unknownMessage,\r\n        listeningFromMe: listeningFromMe,\r\n        stopBotFromMe: stopBotFromMe,\r\n        keepOpen: keepOpen,\r\n      },\r\n      remoteJid,\r\n      request?.data?.messages,\r\n      request?.data?.input,\r\n      request?.data?.clientSideActions,\r\n    );\r\n\r\n    return;\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProxyDto } from '@api/dto/proxy.dto';\r\nimport { SettingsDto } from '@api/dto/settings.dto';\r\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { ChatwootService } from '@api/integrations/chatbot/chatwoot/services/chatwoot.service';\r\nimport { DifyService } from '@api/integrations/chatbot/dify/services/dify.service';\r\nimport { OpenaiService } from '@api/integrations/chatbot/openai/services/openai.service';\r\nimport { TypebotService } from '@api/integrations/chatbot/typebot/services/typebot.service';\r\nimport { PrismaRepository, Query } from '@api/repository/repository.service';\r\nimport { eventManager, waMonitor } from '@api/server.module';\r\nimport { Events, wa } from '@api/types/wa.types';\r\nimport { Auth, Chatwoot, ConfigService, HttpServer } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { NotFoundException } from '@exceptions';\r\nimport { Contact, Message, Prisma } from '@prisma/client';\r\nimport { createJid } from '@utils/createJid';\r\nimport { WASocket } from 'baileys';\r\nimport { isArray } from 'class-validator';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { CacheService } from './cache.service';\r\n\r\nexport class ChannelStartupService {\r\n  constructor(\r\n    public readonly configService: ConfigService,\r\n    public readonly eventEmitter: EventEmitter2,\r\n    public readonly prismaRepository: PrismaRepository,\r\n    public readonly chatwootCache: CacheService,\r\n  ) {}\r\n\r\n  public readonly logger = new Logger('ChannelStartupService');\r\n\r\n  public client: WASocket;\r\n  public readonly instance: wa.Instance = {};\r\n  public readonly localChatwoot: wa.LocalChatwoot = {};\r\n  public readonly localProxy: wa.LocalProxy = {};\r\n  public readonly localSettings: wa.LocalSettings = {};\r\n  public readonly localWebhook: wa.LocalWebHook = {};\r\n\r\n  public chatwootService = new ChatwootService(\r\n    waMonitor,\r\n    this.configService,\r\n    this.prismaRepository,\r\n    this.chatwootCache,\r\n  );\r\n\r\n  public typebotService = new TypebotService(waMonitor, this.configService, this.prismaRepository);\r\n\r\n  public openaiService = new OpenaiService(waMonitor, this.configService, this.prismaRepository);\r\n\r\n  public difyService = new DifyService(waMonitor, this.configService, this.prismaRepository);\r\n\r\n  public setInstance(instance: InstanceDto) {\r\n    this.logger.setInstance(instance.instanceName);\r\n\r\n    this.instance.name = instance.instanceName;\r\n    this.instance.id = instance.instanceId;\r\n    this.instance.integration = instance.integration;\r\n    this.instance.number = instance.number;\r\n    this.instance.token = instance.token;\r\n    this.instance.businessId = instance.businessId;\r\n\r\n    if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n      this.chatwootService.eventWhatsapp(\r\n        Events.STATUS_INSTANCE,\r\n        { instanceName: this.instance.name },\r\n        {\r\n          instance: this.instance.name,\r\n          status: 'created',\r\n        },\r\n      );\r\n    }\r\n  }\r\n\r\n  public set instanceName(name: string) {\r\n    this.logger.setInstance(name);\r\n\r\n    if (!name) {\r\n      this.instance.name = v4();\r\n      return;\r\n    }\r\n    this.instance.name = name;\r\n  }\r\n\r\n  public get instanceName() {\r\n    return this.instance.name;\r\n  }\r\n\r\n  public set instanceId(id: string) {\r\n    if (!id) {\r\n      this.instance.id = v4();\r\n      return;\r\n    }\r\n    this.instance.id = id;\r\n  }\r\n\r\n  public get instanceId() {\r\n    return this.instance.id;\r\n  }\r\n\r\n  public set integration(integration: string) {\r\n    this.instance.integration = integration;\r\n  }\r\n\r\n  public get integration() {\r\n    return this.instance.integration;\r\n  }\r\n\r\n  public set number(number: string) {\r\n    this.instance.number = number;\r\n  }\r\n\r\n  public get number() {\r\n    return this.instance.number;\r\n  }\r\n\r\n  public set token(token: string) {\r\n    this.instance.token = token;\r\n  }\r\n\r\n  public get token() {\r\n    return this.instance.token;\r\n  }\r\n\r\n  public get wuid() {\r\n    return this.instance.wuid;\r\n  }\r\n\r\n  public async loadWebhook() {\r\n    const data = await this.prismaRepository.webhook.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    this.localWebhook.enabled = data?.enabled;\r\n    this.localWebhook.webhookBase64 = data?.webhookBase64;\r\n  }\r\n\r\n  public async loadSettings() {\r\n    const data = await this.prismaRepository.setting.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    this.localSettings.rejectCall = data?.rejectCall;\r\n    this.localSettings.msgCall = data?.msgCall;\r\n    this.localSettings.groupsIgnore = data?.groupsIgnore;\r\n    this.localSettings.alwaysOnline = data?.alwaysOnline;\r\n    this.localSettings.readMessages = data?.readMessages;\r\n    this.localSettings.readStatus = data?.readStatus;\r\n    this.localSettings.syncFullHistory = data?.syncFullHistory;\r\n    this.localSettings.wavoipToken = data?.wavoipToken;\r\n  }\r\n\r\n  public async setSettings(data: SettingsDto) {\r\n    await this.prismaRepository.setting.upsert({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n      update: {\r\n        rejectCall: data.rejectCall,\r\n        msgCall: data.msgCall,\r\n        groupsIgnore: data.groupsIgnore,\r\n        alwaysOnline: data.alwaysOnline,\r\n        readMessages: data.readMessages,\r\n        readStatus: data.readStatus,\r\n        syncFullHistory: data.syncFullHistory,\r\n        wavoipToken: data.wavoipToken,\r\n      },\r\n      create: {\r\n        rejectCall: data.rejectCall,\r\n        msgCall: data.msgCall,\r\n        groupsIgnore: data.groupsIgnore,\r\n        alwaysOnline: data.alwaysOnline,\r\n        readMessages: data.readMessages,\r\n        readStatus: data.readStatus,\r\n        syncFullHistory: data.syncFullHistory,\r\n        wavoipToken: data.wavoipToken,\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    this.localSettings.rejectCall = data?.rejectCall;\r\n    this.localSettings.msgCall = data?.msgCall;\r\n    this.localSettings.groupsIgnore = data?.groupsIgnore;\r\n    this.localSettings.alwaysOnline = data?.alwaysOnline;\r\n    this.localSettings.readMessages = data?.readMessages;\r\n    this.localSettings.readStatus = data?.readStatus;\r\n    this.localSettings.syncFullHistory = data?.syncFullHistory;\r\n    this.localSettings.wavoipToken = data?.wavoipToken;\r\n\r\n    if (this.localSettings.wavoipToken && this.localSettings.wavoipToken.length > 0) {\r\n      this.client.ws.close();\r\n      this.client.ws.connect();\r\n    }\r\n  }\r\n\r\n  public async findSettings() {\r\n    const data = await this.prismaRepository.setting.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (!data) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      rejectCall: data.rejectCall,\r\n      msgCall: data.msgCall,\r\n      groupsIgnore: data.groupsIgnore,\r\n      alwaysOnline: data.alwaysOnline,\r\n      readMessages: data.readMessages,\r\n      readStatus: data.readStatus,\r\n      syncFullHistory: data.syncFullHistory,\r\n      wavoipToken: data.wavoipToken,\r\n    };\r\n  }\r\n\r\n  public async loadChatwoot() {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n      return;\r\n    }\r\n\r\n    const data = await this.prismaRepository.chatwoot.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    this.localChatwoot.enabled = data?.enabled;\r\n    this.localChatwoot.accountId = data?.accountId;\r\n    this.localChatwoot.token = data?.token;\r\n    this.localChatwoot.url = data?.url;\r\n    this.localChatwoot.nameInbox = data?.nameInbox;\r\n    this.localChatwoot.signMsg = data?.signMsg;\r\n    this.localChatwoot.signDelimiter = data?.signDelimiter;\r\n    this.localChatwoot.number = data?.number;\r\n    this.localChatwoot.reopenConversation = data?.reopenConversation;\r\n    this.localChatwoot.conversationPending = data?.conversationPending;\r\n    this.localChatwoot.mergeBrazilContacts = data?.mergeBrazilContacts;\r\n    this.localChatwoot.importContacts = data?.importContacts;\r\n    this.localChatwoot.importMessages = data?.importMessages;\r\n    this.localChatwoot.daysLimitImportMessages = data?.daysLimitImportMessages;\r\n  }\r\n\r\n  public async setChatwoot(data: ChatwootDto) {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n      return;\r\n    }\r\n\r\n    const chatwoot = await this.prismaRepository.chatwoot.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (chatwoot) {\r\n      await this.prismaRepository.chatwoot.update({\r\n        where: {\r\n          instanceId: this.instanceId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          accountId: data.accountId,\r\n          token: data.token,\r\n          url: data.url,\r\n          nameInbox: data.nameInbox,\r\n          signMsg: data.signMsg,\r\n          signDelimiter: data.signMsg ? data.signDelimiter : null,\r\n          number: data.number,\r\n          reopenConversation: data.reopenConversation,\r\n          conversationPending: data.conversationPending,\r\n          mergeBrazilContacts: data.mergeBrazilContacts,\r\n          importContacts: data.importContacts,\r\n          importMessages: data.importMessages,\r\n          daysLimitImportMessages: data.daysLimitImportMessages,\r\n          organization: data.organization,\r\n          logo: data.logo,\r\n          ignoreJids: data.ignoreJids,\r\n        },\r\n      });\r\n\r\n      Object.assign(this.localChatwoot, { ...data, signDelimiter: data.signMsg ? data.signDelimiter : null });\r\n\r\n      this.clearCacheChatwoot();\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.chatwoot.create({\r\n      data: {\r\n        enabled: data?.enabled,\r\n        accountId: data.accountId,\r\n        token: data.token,\r\n        url: data.url,\r\n        nameInbox: data.nameInbox,\r\n        signMsg: data.signMsg,\r\n        number: data.number,\r\n        reopenConversation: data.reopenConversation,\r\n        conversationPending: data.conversationPending,\r\n        mergeBrazilContacts: data.mergeBrazilContacts,\r\n        importContacts: data.importContacts,\r\n        importMessages: data.importMessages,\r\n        daysLimitImportMessages: data.daysLimitImportMessages,\r\n        organization: data.organization,\r\n        logo: data.logo,\r\n        ignoreJids: data.ignoreJids,\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    Object.assign(this.localChatwoot, { ...data, signDelimiter: data.signMsg ? data.signDelimiter : null });\r\n\r\n    this.clearCacheChatwoot();\r\n  }\r\n\r\n  public async findChatwoot(): Promise<ChatwootDto | null> {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n      return null;\r\n    }\r\n\r\n    const data = await this.prismaRepository.chatwoot.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (!data) {\r\n      return null;\r\n    }\r\n\r\n    const ignoreJidsArray = Array.isArray(data.ignoreJids) ? data.ignoreJids.map((event) => String(event)) : [];\r\n\r\n    return {\r\n      enabled: data?.enabled,\r\n      accountId: data.accountId,\r\n      token: data.token,\r\n      url: data.url,\r\n      nameInbox: data.nameInbox,\r\n      signMsg: data.signMsg,\r\n      signDelimiter: data.signDelimiter || null,\r\n      reopenConversation: data.reopenConversation,\r\n      conversationPending: data.conversationPending,\r\n      mergeBrazilContacts: data.mergeBrazilContacts,\r\n      importContacts: data.importContacts,\r\n      importMessages: data.importMessages,\r\n      daysLimitImportMessages: data.daysLimitImportMessages,\r\n      organization: data.organization,\r\n      logo: data.logo,\r\n      ignoreJids: ignoreJidsArray,\r\n    };\r\n  }\r\n\r\n  public clearCacheChatwoot() {\r\n    if (this.localChatwoot?.enabled) {\r\n      this.chatwootService.getCache()?.deleteAll(this.instanceName);\r\n    }\r\n  }\r\n\r\n  public async loadProxy() {\r\n    this.localProxy.enabled = false;\r\n\r\n    if (process.env.PROXY_HOST) {\r\n      this.localProxy.enabled = true;\r\n      this.localProxy.host = process.env.PROXY_HOST;\r\n      this.localProxy.port = process.env.PROXY_PORT || '80';\r\n      this.localProxy.protocol = process.env.PROXY_PROTOCOL || 'http';\r\n      this.localProxy.username = process.env.PROXY_USERNAME;\r\n      this.localProxy.password = process.env.PROXY_PASSWORD;\r\n    }\r\n\r\n    const data = await this.prismaRepository.proxy.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (data?.enabled) {\r\n      this.localProxy.enabled = true;\r\n      this.localProxy.host = data?.host;\r\n      this.localProxy.port = data?.port;\r\n      this.localProxy.protocol = data?.protocol;\r\n      this.localProxy.username = data?.username;\r\n      this.localProxy.password = data?.password;\r\n    }\r\n  }\r\n\r\n  public async setProxy(data: ProxyDto) {\r\n    await this.prismaRepository.proxy.upsert({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n      update: {\r\n        enabled: data?.enabled,\r\n        host: data.host,\r\n        port: data.port,\r\n        protocol: data.protocol,\r\n        username: data.username,\r\n        password: data.password,\r\n      },\r\n      create: {\r\n        enabled: data?.enabled,\r\n        host: data.host,\r\n        port: data.port,\r\n        protocol: data.protocol,\r\n        username: data.username,\r\n        password: data.password,\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    Object.assign(this.localProxy, data);\r\n  }\r\n\r\n  public async findProxy() {\r\n    const data = await this.prismaRepository.proxy.findUnique({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (!data) {\r\n      throw new NotFoundException('Proxy not found');\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  public async sendDataWebhook<T = any>(event: Events, data: T, local = true, integration?: string[]) {\r\n    const serverUrl = this.configService.get<HttpServer>('SERVER').URL;\r\n    const tzoffset = new Date().getTimezoneOffset() * 60000; //offset in milliseconds\r\n    const localISOTime = new Date(Date.now() - tzoffset).toISOString();\r\n    const now = localISOTime;\r\n\r\n    const expose = this.configService.get<Auth>('AUTHENTICATION').EXPOSE_IN_FETCH_INSTANCES;\r\n\r\n    const instanceApikey = this.token || 'Apikey not found';\r\n\r\n    await eventManager.emit({\r\n      instanceName: this.instance.name,\r\n      origin: ChannelStartupService.name,\r\n      event,\r\n      data,\r\n      serverUrl,\r\n      dateTime: now,\r\n      sender: this.wuid,\r\n      apiKey: expose && instanceApikey ? instanceApikey : null,\r\n      local,\r\n      integration,\r\n    });\r\n  }\r\n\r\n  // Check if the number is MX or AR\r\n  public formatMXOrARNumber(jid: string): string {\r\n    const countryCode = jid.substring(0, 2);\r\n\r\n    if (Number(countryCode) === 52 || Number(countryCode) === 54) {\r\n      if (jid.length === 13) {\r\n        const number = countryCode + jid.substring(3);\r\n        return number;\r\n      }\r\n\r\n      return jid;\r\n    }\r\n    return jid;\r\n  }\r\n\r\n  // Check if the number is br\r\n  public formatBRNumber(jid: string) {\r\n    const regexp = new RegExp(/^(\\d{2})(\\d{2})\\d{1}(\\d{8})$/);\r\n    if (regexp.test(jid)) {\r\n      const match = regexp.exec(jid);\r\n      if (match && match[1] === '55') {\r\n        const joker = Number.parseInt(match[3][0]);\r\n        const ddd = Number.parseInt(match[2]);\r\n        if (joker < 7 || ddd < 31) {\r\n          return match[0];\r\n        }\r\n        return match[1] + match[2] + match[3];\r\n      }\r\n      return jid;\r\n    } else {\r\n      return jid;\r\n    }\r\n  }\r\n\r\n  public async fetchContacts(query: Query<Contact>) {\r\n    const remoteJid = query?.where?.remoteJid\r\n      ? query?.where?.remoteJid.includes('@')\r\n        ? query.where?.remoteJid\r\n        : createJid(query.where?.remoteJid)\r\n      : null;\r\n\r\n    const where = {\r\n      instanceId: this.instanceId,\r\n    };\r\n\r\n    if (remoteJid) {\r\n      where['remoteJid'] = remoteJid;\r\n    }\r\n\r\n    return await this.prismaRepository.contact.findMany({\r\n      where,\r\n    });\r\n  }\r\n\r\n  public cleanMessageData(message: any) {\r\n    if (!message) return message;\r\n\r\n    const cleanedMessage = { ...message };\r\n\r\n    const mediaUrl = cleanedMessage.message.mediaUrl;\r\n\r\n    delete cleanedMessage.message.base64;\r\n\r\n    if (cleanedMessage.message) {\r\n      // Limpa imageMessage\r\n      if (cleanedMessage.message.imageMessage) {\r\n        cleanedMessage.message.imageMessage = {\r\n          caption: cleanedMessage.message.imageMessage.caption,\r\n        };\r\n      }\r\n\r\n      // Limpa videoMessage\r\n      if (cleanedMessage.message.videoMessage) {\r\n        cleanedMessage.message.videoMessage = {\r\n          caption: cleanedMessage.message.videoMessage.caption,\r\n        };\r\n      }\r\n\r\n      // Limpa audioMessage\r\n      if (cleanedMessage.message.audioMessage) {\r\n        cleanedMessage.message.audioMessage = {\r\n          seconds: cleanedMessage.message.audioMessage.seconds,\r\n        };\r\n      }\r\n\r\n      // Limpa stickerMessage\r\n      if (cleanedMessage.message.stickerMessage) {\r\n        cleanedMessage.message.stickerMessage = {};\r\n      }\r\n\r\n      // Limpa documentMessage\r\n      if (cleanedMessage.message.documentMessage) {\r\n        cleanedMessage.message.documentMessage = {\r\n          caption: cleanedMessage.message.documentMessage.caption,\r\n          name: cleanedMessage.message.documentMessage.name,\r\n        };\r\n      }\r\n\r\n      // Limpa documentWithCaptionMessage\r\n      if (cleanedMessage.message.documentWithCaptionMessage) {\r\n        cleanedMessage.message.documentWithCaptionMessage = {\r\n          caption: cleanedMessage.message.documentWithCaptionMessage.caption,\r\n          name: cleanedMessage.message.documentWithCaptionMessage.name,\r\n        };\r\n      }\r\n    }\r\n\r\n    if (mediaUrl) cleanedMessage.message.mediaUrl = mediaUrl;\r\n\r\n    return cleanedMessage;\r\n  }\r\n\r\n  public async fetchMessages(query: Query<Message>) {\r\n    const keyFilters = query?.where?.key as {\r\n      id?: string;\r\n      fromMe?: boolean;\r\n      remoteJid?: string;\r\n      participants?: string;\r\n    };\r\n\r\n    const timestampFilter = {};\r\n    if (query?.where?.messageTimestamp) {\r\n      if (query.where.messageTimestamp['gte'] && query.where.messageTimestamp['lte']) {\r\n        timestampFilter['messageTimestamp'] = {\r\n          gte: Math.floor(new Date(query.where.messageTimestamp['gte']).getTime() / 1000),\r\n          lte: Math.floor(new Date(query.where.messageTimestamp['lte']).getTime() / 1000),\r\n        };\r\n      }\r\n    }\r\n\r\n    const count = await this.prismaRepository.message.count({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n        id: query?.where?.id,\r\n        source: query?.where?.source,\r\n        messageType: query?.where?.messageType,\r\n        ...timestampFilter,\r\n        AND: [\r\n          keyFilters?.id ? { key: { path: ['id'], equals: keyFilters?.id } } : {},\r\n          keyFilters?.fromMe ? { key: { path: ['fromMe'], equals: keyFilters?.fromMe } } : {},\r\n          keyFilters?.remoteJid ? { key: { path: ['remoteJid'], equals: keyFilters?.remoteJid } } : {},\r\n          keyFilters?.participants ? { key: { path: ['participants'], equals: keyFilters?.participants } } : {},\r\n        ],\r\n      },\r\n    });\r\n\r\n    if (!query?.offset) {\r\n      query.offset = 50;\r\n    }\r\n\r\n    if (!query?.page) {\r\n      query.page = 1;\r\n    }\r\n\r\n    const messages = await this.prismaRepository.message.findMany({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n        id: query?.where?.id,\r\n        source: query?.where?.source,\r\n        messageType: query?.where?.messageType,\r\n        ...timestampFilter,\r\n        AND: [\r\n          keyFilters?.id ? { key: { path: ['id'], equals: keyFilters?.id } } : {},\r\n          keyFilters?.fromMe ? { key: { path: ['fromMe'], equals: keyFilters?.fromMe } } : {},\r\n          keyFilters?.remoteJid ? { key: { path: ['remoteJid'], equals: keyFilters?.remoteJid } } : {},\r\n          keyFilters?.participants ? { key: { path: ['participants'], equals: keyFilters?.participants } } : {},\r\n        ],\r\n      },\r\n      orderBy: {\r\n        messageTimestamp: 'desc',\r\n      },\r\n      skip: query.offset * (query?.page === 1 ? 0 : (query?.page as number) - 1),\r\n      take: query.offset,\r\n      select: {\r\n        id: true,\r\n        key: true,\r\n        pushName: true,\r\n        messageType: true,\r\n        message: true,\r\n        messageTimestamp: true,\r\n        instanceId: true,\r\n        source: true,\r\n        contextInfo: true,\r\n        MessageUpdate: {\r\n          select: {\r\n            status: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    return {\r\n      messages: {\r\n        total: count,\r\n        pages: Math.ceil(count / query.offset),\r\n        currentPage: query.page,\r\n        records: messages,\r\n      },\r\n    };\r\n  }\r\n\r\n  public async fetchStatusMessage(query: any) {\r\n    return await this.prismaRepository.messageUpdate.findMany({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n        remoteJid: query.where?.remoteJid,\r\n        keyId: query.where?.id,\r\n      },\r\n      skip: query.offset * (query?.page === 1 ? 0 : (query?.page as number) - 1),\r\n      take: query.offset,\r\n    });\r\n  }\r\n\r\n  public async fetchChats(query: any) {\r\n    const remoteJid = query?.where?.remoteJid\r\n      ? query?.where?.remoteJid.includes('@')\r\n        ? query.where?.remoteJid\r\n        : createJid(query.where?.remoteJid)\r\n      : null;\r\n\r\n    const where = {\r\n      instanceId: this.instanceId,\r\n    };\r\n\r\n    if (remoteJid) {\r\n      where['remoteJid'] = remoteJid;\r\n    }\r\n\r\n    const timestampFilter =\r\n      query?.where?.messageTimestamp?.gte && query?.where?.messageTimestamp?.lte\r\n        ? Prisma.sql`\r\n          AND \"Message\".\"messageTimestamp\" >= ${Math.floor(new Date(query.where.messageTimestamp.gte).getTime() / 1000)}\r\n          AND \"Message\".\"messageTimestamp\" <= ${Math.floor(new Date(query.where.messageTimestamp.lte).getTime() / 1000)}`\r\n        : Prisma.sql``;\r\n\r\n    const results = await this.prismaRepository.$queryRaw`\r\n        WITH rankedMessages AS (\r\n          SELECT DISTINCT ON (\"Contact\".\"remoteJid\")\r\n            \"Contact\".\"id\",\r\n            \"Contact\".\"remoteJid\",\r\n            \"Contact\".\"pushName\",\r\n            \"Contact\".\"profilePicUrl\",\r\n            COALESCE(\r\n              to_timestamp(\"Message\".\"messageTimestamp\"::double precision), \r\n              \"Contact\".\"updatedAt\"\r\n            ) as \"updatedAt\",\r\n            \"Chat\".\"createdAt\" as \"windowStart\",\r\n            \"Chat\".\"createdAt\" + INTERVAL '24 hours' as \"windowExpires\",\r\n            CASE \r\n              WHEN \"Chat\".\"createdAt\" + INTERVAL '24 hours' > NOW() THEN true \r\n              ELSE false \r\n            END as \"windowActive\",\r\n            \"Message\".\"id\" AS lastMessageId,\r\n            \"Message\".\"key\" AS lastMessage_key,\r\n            \"Message\".\"pushName\" AS lastMessagePushName,\r\n            \"Message\".\"participant\" AS lastMessageParticipant,\r\n            \"Message\".\"messageType\" AS lastMessageMessageType,\r\n            \"Message\".\"message\" AS lastMessageMessage,\r\n            \"Message\".\"contextInfo\" AS lastMessageContextInfo,\r\n            \"Message\".\"source\" AS lastMessageSource,\r\n            \"Message\".\"messageTimestamp\" AS lastMessageMessageTimestamp,\r\n            \"Message\".\"instanceId\" AS lastMessageInstanceId,\r\n            \"Message\".\"sessionId\" AS lastMessageSessionId,\r\n            \"Message\".\"status\" AS lastMessageStatus\r\n          FROM \"Contact\"\r\n          INNER JOIN \"Message\" ON \"Message\".\"key\"->>'remoteJid' = \"Contact\".\"remoteJid\"\r\n          LEFT JOIN \"Chat\" ON \"Chat\".\"remoteJid\" = \"Contact\".\"remoteJid\" \r\n            AND \"Chat\".\"instanceId\" = \"Contact\".\"instanceId\"\r\n          WHERE \r\n            \"Contact\".\"instanceId\" = ${this.instanceId}\r\n            AND \"Message\".\"instanceId\" = ${this.instanceId}\r\n            ${remoteJid ? Prisma.sql`AND \"Contact\".\"remoteJid\" = ${remoteJid}` : Prisma.sql``}\r\n            ${timestampFilter}\r\n          ORDER BY \r\n            \"Contact\".\"remoteJid\",\r\n            \"Message\".\"messageTimestamp\" DESC\r\n        )\r\n        SELECT * FROM rankedMessages\r\n        ORDER BY \"updatedAt\" DESC NULLS LAST;\r\n    `;\r\n\r\n    if (results && isArray(results) && results.length > 0) {\r\n      const mappedResults = results.map((contact) => {\r\n        const lastMessage = contact.lastMessageId\r\n          ? {\r\n              id: contact.lastMessageId,\r\n              key: contact.lastMessageKey,\r\n              pushName: contact.lastMessagePushName,\r\n              participant: contact.lastMessageParticipant,\r\n              messageType: contact.lastMessageMessageType,\r\n              message: contact.lastMessageMessage,\r\n              contextInfo: contact.lastMessageContextInfo,\r\n              source: contact.lastMessageSource,\r\n              messageTimestamp: contact.lastMessageMessageTimestamp,\r\n              instanceId: contact.lastMessageInstanceId,\r\n              sessionId: contact.lastMessageSessionId,\r\n              status: contact.lastMessageStatus,\r\n            }\r\n          : undefined;\r\n\r\n        return {\r\n          id: contact.id,\r\n          remoteJid: contact.remoteJid,\r\n          pushName: contact.pushName,\r\n          profilePicUrl: contact.profilePicUrl,\r\n          updatedAt: contact.updatedAt,\r\n          windowStart: contact.windowStart,\r\n          windowExpires: contact.windowExpires,\r\n          windowActive: contact.windowActive,\r\n          lastMessage: lastMessage ? this.cleanMessageData(lastMessage) : undefined,\r\n        };\r\n      });\r\n\r\n      return mappedResults;\r\n    }\r\n\r\n    return [];\r\n  }\r\n}\r\n","// Check if the number is MX or AR\r\nfunction formatMXOrARNumber(jid: string): string {\r\n  const countryCode = jid.substring(0, 2);\r\n\r\n  if (Number(countryCode) === 52 || Number(countryCode) === 54) {\r\n    if (jid.length === 13) {\r\n      const number = countryCode + jid.substring(3);\r\n      return number;\r\n    }\r\n\r\n    return jid;\r\n  }\r\n  return jid;\r\n}\r\n\r\n// Check if the number is br\r\nfunction formatBRNumber(jid: string) {\r\n  const regexp = new RegExp(/^(\\d{2})(\\d{2})\\d{1}(\\d{8})$/);\r\n  if (regexp.test(jid)) {\r\n    const match = regexp.exec(jid);\r\n    if (match && match[1] === '55') {\r\n      const joker = Number.parseInt(match[3][0]);\r\n      const ddd = Number.parseInt(match[2]);\r\n      if (joker < 7 || ddd < 31) {\r\n        return match[0];\r\n      }\r\n      return match[1] + match[2] + match[3];\r\n    }\r\n    return jid;\r\n  } else {\r\n    return jid;\r\n  }\r\n}\r\n\r\nexport function createJid(number: string): string {\r\n  number = number.replace(/:\\d+/, '');\r\n\r\n  if (number.includes('@g.us') || number.includes('@s.whatsapp.net') || number.includes('@lid')) {\r\n    return number;\r\n  }\r\n\r\n  if (number.includes('@broadcast')) {\r\n    return number;\r\n  }\r\n\r\n  number = number\r\n    ?.replace(/\\s/g, '')\r\n    .replace(/\\+/g, '')\r\n    .replace(/\\(/g, '')\r\n    .replace(/\\)/g, '')\r\n    .split(':')[0]\r\n    .split('@')[0];\r\n\r\n  if (number.includes('-') && number.length >= 24) {\r\n    number = number.replace(/[^\\d-]/g, '');\r\n    return `${number}@g.us`;\r\n  }\r\n\r\n  number = number.replace(/\\D/g, '');\r\n\r\n  if (number.length >= 18) {\r\n    number = number.replace(/[^\\d-]/g, '');\r\n    return `${number}@g.us`;\r\n  }\r\n\r\n  number = formatMXOrARNumber(number);\r\n\r\n  number = formatBRNumber(number);\r\n\r\n  return `${number}@s.whatsapp.net`;\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport {\r\n  MediaMessage,\r\n  Options,\r\n  SendAudioDto,\r\n  SendButtonsDto,\r\n  SendMediaDto,\r\n  SendTextDto,\r\n} from '@api/dto/sendMessage.dto';\r\nimport * as s3Service from '@api/integrations/storage/s3/libs/minio.server';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { chatbotController } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { ChannelStartupService } from '@api/services/channel.service';\r\nimport { Events, wa } from '@api/types/wa.types';\r\nimport { Chatwoot, ConfigService, Openai, S3 } from '@config/env.config';\r\nimport { BadRequestException, InternalServerErrorException } from '@exceptions';\r\nimport { createJid } from '@utils/createJid';\r\nimport axios from 'axios';\r\nimport { isBase64, isURL } from 'class-validator';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport FormData from 'form-data';\r\nimport mimeTypes from 'mime-types';\r\nimport { join } from 'path';\r\nimport { v4 } from 'uuid';\r\n\r\nexport class EvolutionStartupService extends ChannelStartupService {\r\n  constructor(\r\n    public readonly configService: ConfigService,\r\n    public readonly eventEmitter: EventEmitter2,\r\n    public readonly prismaRepository: PrismaRepository,\r\n    public readonly cache: CacheService,\r\n    public readonly chatwootCache: CacheService,\r\n  ) {\r\n    super(configService, eventEmitter, prismaRepository, chatwootCache);\r\n\r\n    this.client = null;\r\n  }\r\n\r\n  public client: any;\r\n\r\n  public stateConnection: wa.StateConnection = { state: 'open' };\r\n\r\n  public phoneNumber: string;\r\n  public mobile: boolean;\r\n\r\n  public get connectionStatus() {\r\n    return this.stateConnection;\r\n  }\r\n\r\n  public async closeClient() {\r\n    this.stateConnection = { state: 'close' };\r\n  }\r\n\r\n  public get qrCode(): wa.QrCode {\r\n    return {\r\n      pairingCode: this.instance.qrcode?.pairingCode,\r\n      code: this.instance.qrcode?.code,\r\n      base64: this.instance.qrcode?.base64,\r\n      count: this.instance.qrcode?.count,\r\n    };\r\n  }\r\n\r\n  public async logoutInstance() {\r\n    await this.closeClient();\r\n  }\r\n\r\n  public setInstance(instance: InstanceDto) {\r\n    this.logger.setInstance(instance.instanceId);\r\n\r\n    this.instance.name = instance.instanceName;\r\n    this.instance.id = instance.instanceId;\r\n    this.instance.integration = instance.integration;\r\n    this.instance.number = instance.number;\r\n    this.instance.token = instance.token;\r\n    this.instance.businessId = instance.businessId;\r\n\r\n    if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n      this.chatwootService.eventWhatsapp(\r\n        Events.STATUS_INSTANCE,\r\n        {\r\n          instanceName: this.instance.name,\r\n          instanceId: this.instance.id,\r\n          integration: instance.integration,\r\n        },\r\n        {\r\n          instance: this.instance.name,\r\n          status: 'created',\r\n        },\r\n      );\r\n    }\r\n  }\r\n\r\n  public async profilePicture(number: string) {\r\n    const jid = createJid(number);\r\n\r\n    return {\r\n      wuid: jid,\r\n      profilePictureUrl: null,\r\n    };\r\n  }\r\n\r\n  public async getProfileName() {\r\n    return null;\r\n  }\r\n\r\n  public async profilePictureUrl() {\r\n    return null;\r\n  }\r\n\r\n  public async getProfileStatus() {\r\n    return null;\r\n  }\r\n\r\n  public async connectToWhatsapp(data?: any): Promise<any> {\r\n    if (!data) {\r\n      this.loadChatwoot();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.eventHandler(data);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString());\r\n    }\r\n  }\r\n\r\n  protected async eventHandler(received: any) {\r\n    try {\r\n      let messageRaw: any;\r\n\r\n      if (received.message) {\r\n        const key = {\r\n          id: received.key.id || v4(),\r\n          remoteJid: received.key.remoteJid,\r\n          fromMe: received.key.fromMe,\r\n          profilePicUrl: received.profilePicUrl,\r\n        };\r\n        messageRaw = {\r\n          key,\r\n          pushName: received.pushName,\r\n          message: received.message,\r\n          messageType: received.messageType,\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n\r\n        const isAudio = received?.message?.audioMessage;\r\n\r\n        if (this.configService.get<Openai>('OPENAI').ENABLED && isAudio) {\r\n          const openAiDefaultSettings = await this.prismaRepository.openaiSetting.findFirst({\r\n            where: {\r\n              instanceId: this.instanceId,\r\n            },\r\n            include: {\r\n              OpenaiCreds: true,\r\n            },\r\n          });\r\n\r\n          if (\r\n            openAiDefaultSettings &&\r\n            openAiDefaultSettings.openaiCredsId &&\r\n            openAiDefaultSettings.speechToText &&\r\n            received?.message?.audioMessage\r\n          ) {\r\n            messageRaw.message.speechToText = await this.openaiService.speechToText(\r\n              openAiDefaultSettings.OpenaiCreds,\r\n              received,\r\n              this.client.updateMediaMessage,\r\n            );\r\n          }\r\n        }\r\n\r\n        this.logger.log(messageRaw);\r\n\r\n        this.sendDataWebhook(Events.MESSAGES_UPSERT, messageRaw);\r\n\r\n        await chatbotController.emit({\r\n          instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          msg: messageRaw,\r\n          pushName: messageRaw.pushName,\r\n        });\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n          const chatwootSentMessage = await this.chatwootService.eventWhatsapp(\r\n            Events.MESSAGES_UPSERT,\r\n            { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            messageRaw,\r\n          );\r\n\r\n          if (chatwootSentMessage?.id) {\r\n            messageRaw.chatwootMessageId = chatwootSentMessage.id;\r\n            messageRaw.chatwootInboxId = chatwootSentMessage.id;\r\n            messageRaw.chatwootConversationId = chatwootSentMessage.id;\r\n          }\r\n        }\r\n\r\n        await this.prismaRepository.message.create({\r\n          data: messageRaw,\r\n        });\r\n\r\n        await this.updateContact({\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          pushName: messageRaw.pushName,\r\n          profilePicUrl: received.profilePicUrl,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  private async updateContact(data: { remoteJid: string; pushName?: string; profilePicUrl?: string }) {\r\n    const contactRaw: any = {\r\n      remoteJid: data.remoteJid,\r\n      pushName: data?.pushName,\r\n      instanceId: this.instanceId,\r\n      profilePicUrl: data?.profilePicUrl,\r\n    };\r\n\r\n    const existingContact = await this.prismaRepository.contact.findFirst({\r\n      where: {\r\n        remoteJid: data.remoteJid,\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    if (existingContact) {\r\n      await this.prismaRepository.contact.updateMany({\r\n        where: {\r\n          remoteJid: data.remoteJid,\r\n          instanceId: this.instanceId,\r\n        },\r\n        data: contactRaw,\r\n      });\r\n    } else {\r\n      await this.prismaRepository.contact.create({\r\n        data: contactRaw,\r\n      });\r\n    }\r\n\r\n    this.sendDataWebhook(Events.CONTACTS_UPSERT, contactRaw);\r\n\r\n    if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n      await this.chatwootService.eventWhatsapp(\r\n        Events.CONTACTS_UPDATE,\r\n        {\r\n          instanceName: this.instance.name,\r\n          instanceId: this.instanceId,\r\n          integration: this.instance.integration,\r\n        },\r\n        contactRaw,\r\n      );\r\n    }\r\n\r\n    const chat = await this.prismaRepository.chat.findFirst({\r\n      where: { instanceId: this.instanceId, remoteJid: data.remoteJid },\r\n    });\r\n\r\n    if (chat) {\r\n      const chatRaw: any = {\r\n        remoteJid: data.remoteJid,\r\n        instanceId: this.instanceId,\r\n      };\r\n\r\n      this.sendDataWebhook(Events.CHATS_UPDATE, chatRaw);\r\n\r\n      await this.prismaRepository.chat.updateMany({\r\n        where: { remoteJid: chat.remoteJid },\r\n        data: chatRaw,\r\n      });\r\n    }\r\n\r\n    const chatRaw: any = {\r\n      remoteJid: data.remoteJid,\r\n      instanceId: this.instanceId,\r\n    };\r\n\r\n    this.sendDataWebhook(Events.CHATS_UPSERT, chatRaw);\r\n\r\n    await this.prismaRepository.chat.create({\r\n      data: chatRaw,\r\n    });\r\n  }\r\n\r\n  protected async sendMessageWithTyping(\r\n    number: string,\r\n    message: any,\r\n    options?: Options,\r\n    file?: any,\r\n    isIntegration = false,\r\n  ) {\r\n    try {\r\n      let quoted: any;\r\n      let webhookUrl: any;\r\n\r\n      if (options?.quoted) {\r\n        const m = options?.quoted;\r\n\r\n        const msg = m?.key;\r\n\r\n        if (!msg) {\r\n          throw 'Message not found';\r\n        }\r\n\r\n        quoted = msg;\r\n      }\r\n\r\n      if (options.delay) {\r\n        await new Promise((resolve) => setTimeout(resolve, options.delay));\r\n      }\r\n\r\n      if (options?.webhookUrl) {\r\n        webhookUrl = options.webhookUrl;\r\n      }\r\n\r\n      let audioFile;\r\n\r\n      const messageId = v4();\r\n\r\n      let messageRaw: any;\r\n\r\n      if (message?.mediaType === 'image') {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            base64: isBase64(message.media) ? message.media : undefined,\r\n            mediaUrl: isURL(message.media) ? message.media : undefined,\r\n            quoted,\r\n          },\r\n          messageType: 'imageMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      } else if (message?.mediaType === 'video') {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            base64: isBase64(message.media) ? message.media : undefined,\r\n            mediaUrl: isURL(message.media) ? message.media : undefined,\r\n            quoted,\r\n          },\r\n          messageType: 'videoMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      } else if (message?.mediaType === 'audio') {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            base64: isBase64(message.media) ? message.media : undefined,\r\n            mediaUrl: isURL(message.media) ? message.media : undefined,\r\n            quoted,\r\n          },\r\n          messageType: 'audioMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n\r\n        const buffer = Buffer.from(message.media, 'base64');\r\n        audioFile = {\r\n          buffer,\r\n          mimetype: 'audio/mp4',\r\n          originalname: `${messageId}.mp4`,\r\n        };\r\n      } else if (message?.mediaType === 'document') {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            base64: isBase64(message.media) ? message.media : undefined,\r\n            mediaUrl: isURL(message.media) ? message.media : undefined,\r\n            quoted,\r\n          },\r\n          messageType: 'documentMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      } else if (message.buttonMessage) {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            ...message.buttonMessage,\r\n            buttons: message.buttonMessage.buttons,\r\n            footer: message.buttonMessage.footer,\r\n            body: message.buttonMessage.body,\r\n            quoted,\r\n          },\r\n          messageType: 'buttonMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      } else if (message.listMessage) {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            ...message.listMessage,\r\n            quoted,\r\n          },\r\n          messageType: 'listMessage',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      } else {\r\n        messageRaw = {\r\n          key: { fromMe: true, id: messageId, remoteJid: number },\r\n          message: {\r\n            ...message,\r\n            quoted,\r\n          },\r\n          messageType: 'conversation',\r\n          messageTimestamp: Math.round(new Date().getTime() / 1000),\r\n          webhookUrl,\r\n          source: 'unknown',\r\n          instanceId: this.instanceId,\r\n        };\r\n      }\r\n\r\n      if (messageRaw.message.contextInfo) {\r\n        messageRaw.contextInfo = {\r\n          ...messageRaw.message.contextInfo,\r\n        };\r\n      }\r\n\r\n      if (messageRaw.contextInfo?.stanzaId) {\r\n        const key: any = {\r\n          id: messageRaw.contextInfo.stanzaId,\r\n        };\r\n\r\n        const findMessage = await this.prismaRepository.message.findFirst({\r\n          where: {\r\n            instanceId: this.instanceId,\r\n            key,\r\n          },\r\n        });\r\n\r\n        if (findMessage) {\r\n          messageRaw.contextInfo.quotedMessage = findMessage.message;\r\n        }\r\n      }\r\n\r\n      const base64 = messageRaw.message.base64;\r\n      delete messageRaw.message.base64;\r\n\r\n      if (base64 || file || audioFile) {\r\n        if (this.configService.get<S3>('S3').ENABLE) {\r\n          try {\r\n            const fileBuffer = audioFile?.buffer || file?.buffer;\r\n            const buffer = base64 ? Buffer.from(base64, 'base64') : fileBuffer;\r\n\r\n            let mediaType: string;\r\n            let mimetype = audioFile?.mimetype || file.mimetype;\r\n\r\n            if (messageRaw.messageType === 'documentMessage') {\r\n              mediaType = 'document';\r\n              mimetype = !mimetype ? 'application/pdf' : mimetype;\r\n            } else if (messageRaw.messageType === 'imageMessage') {\r\n              mediaType = 'image';\r\n              mimetype = !mimetype ? 'image/png' : mimetype;\r\n            } else if (messageRaw.messageType === 'audioMessage') {\r\n              mediaType = 'audio';\r\n              mimetype = !mimetype ? 'audio/mp4' : mimetype;\r\n            } else if (messageRaw.messageType === 'videoMessage') {\r\n              mediaType = 'video';\r\n              mimetype = !mimetype ? 'video/mp4' : mimetype;\r\n            }\r\n\r\n            const fileName = `${messageRaw.key.id}.${mimetype.split('/')[1]}`;\r\n\r\n            const size = buffer.byteLength;\r\n\r\n            const fullName = join(`${this.instance.id}`, messageRaw.key.remoteJid, mediaType, fileName);\r\n\r\n            await s3Service.uploadFile(fullName, buffer, size, {\r\n              'Content-Type': mimetype,\r\n            });\r\n\r\n            const mediaUrl = await s3Service.getObjectUrl(fullName);\r\n\r\n            messageRaw.message.mediaUrl = mediaUrl;\r\n          } catch (error) {\r\n            this.logger.error(['Error on upload file to minio', error?.message, error?.stack]);\r\n          }\r\n        }\r\n      }\r\n\r\n      this.logger.log(messageRaw);\r\n\r\n      this.sendDataWebhook(Events.SEND_MESSAGE, messageRaw);\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && !isIntegration) {\r\n        this.chatwootService.eventWhatsapp(\r\n          Events.SEND_MESSAGE,\r\n          { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          messageRaw,\r\n        );\r\n      }\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && isIntegration)\r\n        await chatbotController.emit({\r\n          instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          msg: messageRaw,\r\n          pushName: messageRaw.pushName,\r\n        });\r\n\r\n      await this.prismaRepository.message.create({\r\n        data: messageRaw,\r\n      });\r\n\r\n      return messageRaw;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async textMessage(data: SendTextDto, isIntegration = false) {\r\n    const res = await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        conversation: data.text,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      null,\r\n      isIntegration,\r\n    );\r\n    return res;\r\n  }\r\n\r\n  protected async prepareMediaMessage(mediaMessage: MediaMessage) {\r\n    try {\r\n      if (mediaMessage.mediatype === 'document' && !mediaMessage.fileName) {\r\n        const regex = new RegExp(/.*\\/(.+?)\\./);\r\n        const arrayMatch = regex.exec(mediaMessage.media);\r\n        mediaMessage.fileName = arrayMatch[1];\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'image' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'image.png';\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'video' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'video.mp4';\r\n      }\r\n\r\n      let mimetype: string | false;\r\n\r\n      const prepareMedia: any = {\r\n        caption: mediaMessage?.caption,\r\n        fileName: mediaMessage.fileName,\r\n        mediaType: mediaMessage.mediatype,\r\n        media: mediaMessage.media,\r\n        gifPlayback: false,\r\n      };\r\n\r\n      if (isURL(mediaMessage.media)) {\r\n        mimetype = mimeTypes.lookup(mediaMessage.media);\r\n      } else {\r\n        mimetype = mimeTypes.lookup(mediaMessage.fileName);\r\n      }\r\n\r\n      prepareMedia.mimetype = mimetype;\r\n\r\n      return prepareMedia;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString() || error);\r\n    }\r\n  }\r\n\r\n  public async mediaMessage(data: SendMediaDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendMediaDto = { ...data };\r\n\r\n    if (file) mediaData.media = file.buffer.toString('base64');\r\n\r\n    const message = await this.prepareMediaMessage(mediaData);\r\n\r\n    const mediaSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      file,\r\n      isIntegration,\r\n    );\r\n\r\n    return mediaSent;\r\n  }\r\n\r\n  public async processAudio(audio: string, number: string, file: any) {\r\n    number = number.replace(/\\D/g, '');\r\n    const hash = `${number}-${new Date().getTime()}`;\r\n\r\n    if (process.env.API_AUDIO_CONVERTER) {\r\n      try {\r\n        this.logger.verbose('Using audio converter API');\r\n        const formData = new FormData();\r\n\r\n        if (file) {\r\n          formData.append('file', file.buffer, {\r\n            filename: file.originalname,\r\n            contentType: file.mimetype,\r\n          });\r\n        } else if (isURL(audio)) {\r\n          formData.append('url', audio);\r\n        } else {\r\n          formData.append('base64', audio);\r\n        }\r\n\r\n        formData.append('format', 'mp4');\r\n\r\n        const response = await axios.post(process.env.API_AUDIO_CONVERTER, formData, {\r\n          headers: {\r\n            ...formData.getHeaders(),\r\n            apikey: process.env.API_AUDIO_CONVERTER_KEY,\r\n          },\r\n        });\r\n\r\n        if (!response?.data?.audio) {\r\n          throw new InternalServerErrorException('Failed to convert audio');\r\n        }\r\n\r\n        const prepareMedia: any = {\r\n          fileName: `${hash}.mp4`,\r\n          mediaType: 'audio',\r\n          media: response?.data?.audio,\r\n          mimetype: 'audio/mpeg',\r\n        };\r\n\r\n        return prepareMedia;\r\n      } catch (error) {\r\n        this.logger.error(error?.response?.data || error);\r\n        throw new InternalServerErrorException(error?.response?.data?.message || error?.toString() || error);\r\n      }\r\n    } else {\r\n      let mimetype: string;\r\n\r\n      const prepareMedia: any = {\r\n        fileName: `${hash}.mp3`,\r\n        mediaType: 'audio',\r\n        media: audio,\r\n        mimetype: 'audio/mpeg',\r\n      };\r\n\r\n      if (isURL(audio)) {\r\n        mimetype = mimeTypes.lookup(audio).toString();\r\n      } else {\r\n        mimetype = mimeTypes.lookup(prepareMedia.fileName).toString();\r\n      }\r\n\r\n      prepareMedia.mimetype = mimetype;\r\n\r\n      return prepareMedia;\r\n    }\r\n  }\r\n\r\n  public async audioWhatsapp(data: SendAudioDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendAudioDto = { ...data };\r\n\r\n    if (file?.buffer) {\r\n      mediaData.audio = file.buffer.toString('base64');\r\n    } else {\r\n      console.error('El archivo o buffer no est definido correctamente.');\r\n      throw new Error('File or buffer is undefined.');\r\n    }\r\n\r\n    const message = await this.processAudio(mediaData.audio, data.number, file);\r\n\r\n    const audioSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      file,\r\n      isIntegration,\r\n    );\r\n\r\n    return audioSent;\r\n  }\r\n\r\n  public async buttonMessage(data: SendButtonsDto, isIntegration = false) {\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        buttonMessage: {\r\n          title: data.title,\r\n          description: data.description,\r\n          footer: data.footer,\r\n          buttons: data.buttons,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      null,\r\n      isIntegration,\r\n    );\r\n  }\r\n  public async locationMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async listMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async templateMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async contactMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async reactionMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async getBase64FromMediaMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async deleteMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async mediaSticker() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async pollMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async statusMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async reloadConnection() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async whatsappNumber() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async markMessageAsRead() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async archiveChat() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async markChatUnread() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fetchProfile() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async offerCall() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async sendPresence() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async setPresence() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fetchPrivacySettings() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updatePrivacySettings() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fetchBusinessProfile() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateProfileName() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateProfileStatus() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateProfilePicture() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async removeProfilePicture() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async blockUser() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateMessage() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async createGroup() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateGroupPicture() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateGroupSubject() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateGroupDescription() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async findGroup() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fetchAllGroups() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async inviteCode() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async inviteInfo() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async sendInvite() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async acceptInviteCode() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async revokeInviteCode() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async findParticipants() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateGParticipant() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async updateGSetting() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async toggleEphemeral() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async leaveGroup() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fetchLabels() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async handleLabel() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async receiveMobileCode() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n  public async fakeCall() {\r\n    throw new BadRequestException('Method not available on Evolution Channel');\r\n  }\r\n}\r\n","import { wa } from '@api/types/wa.types';\r\n\r\nexport const status: Record<number, wa.StatusMessage> = {\r\n  0: 'ERROR',\r\n  1: 'PENDING',\r\n  2: 'SERVER_ACK',\r\n  3: 'DELIVERY_ACK',\r\n  4: 'READ',\r\n  5: 'PLAYED',\r\n};\r\n","import { NumberBusiness } from '@api/dto/chat.dto';\r\nimport {\r\n  ContactMessage,\r\n  MediaMessage,\r\n  Options,\r\n  SendAudioDto,\r\n  SendButtonsDto,\r\n  SendContactDto,\r\n  SendListDto,\r\n  SendLocationDto,\r\n  SendMediaDto,\r\n  SendReactionDto,\r\n  SendTemplateDto,\r\n  SendTextDto,\r\n} from '@api/dto/sendMessage.dto';\r\nimport * as s3Service from '@api/integrations/storage/s3/libs/minio.server';\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { chatbotController } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { ChannelStartupService } from '@api/services/channel.service';\r\nimport { Events, wa } from '@api/types/wa.types';\r\nimport { Chatwoot, ConfigService, Database, Openai, S3, WaBusiness } from '@config/env.config';\r\nimport { BadRequestException, InternalServerErrorException } from '@exceptions';\r\nimport { createJid } from '@utils/createJid';\r\nimport { status } from '@utils/renderStatus';\r\nimport axios from 'axios';\r\nimport { arrayUnique, isURL } from 'class-validator';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport FormData from 'form-data';\r\nimport { createReadStream } from 'fs';\r\nimport mimeTypes from 'mime-types';\r\nimport { join } from 'path';\r\n\r\nexport class BusinessStartupService extends ChannelStartupService {\r\n  constructor(\r\n    public readonly configService: ConfigService,\r\n    public readonly eventEmitter: EventEmitter2,\r\n    public readonly prismaRepository: PrismaRepository,\r\n    public readonly cache: CacheService,\r\n    public readonly chatwootCache: CacheService,\r\n    public readonly baileysCache: CacheService,\r\n    private readonly providerFiles: ProviderFiles,\r\n  ) {\r\n    super(configService, eventEmitter, prismaRepository, chatwootCache);\r\n  }\r\n\r\n  public stateConnection: wa.StateConnection = { state: 'open' };\r\n\r\n  public phoneNumber: string;\r\n  public mobile: boolean;\r\n\r\n  public get connectionStatus() {\r\n    return this.stateConnection;\r\n  }\r\n\r\n  public async closeClient() {\r\n    this.stateConnection = { state: 'close' };\r\n  }\r\n\r\n  public get qrCode(): wa.QrCode {\r\n    return {\r\n      pairingCode: this.instance.qrcode?.pairingCode,\r\n      code: this.instance.qrcode?.code,\r\n      base64: this.instance.qrcode?.base64,\r\n      count: this.instance.qrcode?.count,\r\n    };\r\n  }\r\n\r\n  public async logoutInstance() {\r\n    await this.closeClient();\r\n  }\r\n\r\n  private isMediaMessage(message: any) {\r\n    return message.document || message.image || message.audio || message.video;\r\n  }\r\n\r\n  private async post(message: any, params: string) {\r\n    try {\r\n      let urlServer = this.configService.get<WaBusiness>('WA_BUSINESS').URL;\r\n      const version = this.configService.get<WaBusiness>('WA_BUSINESS').VERSION;\r\n      urlServer = `${urlServer}/${version}/${this.number}/${params}`;\r\n      const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${this.token}` };\r\n      const result = await axios.post(urlServer, message, { headers });\r\n      return result.data;\r\n    } catch (e) {\r\n      return e.response?.data?.error;\r\n    }\r\n  }\r\n\r\n  public async profilePicture(number: string) {\r\n    const jid = createJid(number);\r\n\r\n    return {\r\n      wuid: jid,\r\n      profilePictureUrl: null,\r\n    };\r\n  }\r\n\r\n  public async getProfileName() {\r\n    return null;\r\n  }\r\n\r\n  public async profilePictureUrl() {\r\n    return null;\r\n  }\r\n\r\n  public async getProfileStatus() {\r\n    return null;\r\n  }\r\n\r\n  public async setWhatsappBusinessProfile(data: NumberBusiness): Promise<any> {\r\n    const content = {\r\n      messaging_product: 'whatsapp',\r\n      about: data.about,\r\n      address: data.address,\r\n      description: data.description,\r\n      vertical: data.vertical,\r\n      email: data.email,\r\n      websites: data.websites,\r\n      profile_picture_handle: data.profilehandle,\r\n    };\r\n    return await this.post(content, 'whatsapp_business_profile');\r\n  }\r\n\r\n  public async connectToWhatsapp(data?: any): Promise<any> {\r\n    if (!data) return;\r\n\r\n    const content = data.entry[0].changes[0].value;\r\n\r\n    try {\r\n      this.loadChatwoot();\r\n\r\n      this.eventHandler(content);\r\n\r\n      this.phoneNumber = createJid(content.messages ? content.messages[0].from : content.statuses[0]?.recipient_id);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString());\r\n    }\r\n  }\r\n\r\n  private async downloadMediaMessage(message: any) {\r\n    try {\r\n      const id = message[message.type].id;\r\n      let urlServer = this.configService.get<WaBusiness>('WA_BUSINESS').URL;\r\n      const version = this.configService.get<WaBusiness>('WA_BUSINESS').VERSION;\r\n      urlServer = `${urlServer}/${version}/${id}`;\r\n      const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${this.token}` };\r\n      let result = await axios.get(urlServer, { headers });\r\n      result = await axios.get(result.data.url, { headers, responseType: 'arraybuffer' });\r\n      return result.data;\r\n    } catch (e) {\r\n      this.logger.error(e);\r\n    }\r\n  }\r\n\r\n  private messageMediaJson(received: any) {\r\n    const message = received.messages[0];\r\n    let content: any = message.type + 'Message';\r\n    content = { [content]: message[message.type] };\r\n    message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    return content;\r\n  }\r\n\r\n  private messageInteractiveJson(received: any) {\r\n    const message = received.messages[0];\r\n    let content: any = { conversation: message.interactive[message.interactive.type].title };\r\n    message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    return content;\r\n  }\r\n\r\n  private messageButtonJson(received: any) {\r\n    const message = received.messages[0];\r\n    let content: any = { conversation: received.messages[0].button?.text };\r\n    message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    return content;\r\n  }\r\n\r\n  private messageReactionJson(received: any) {\r\n    const message = received.messages[0];\r\n    let content: any = {\r\n      reactionMessage: {\r\n        key: {\r\n          id: message.reaction.message_id,\r\n        },\r\n        text: message.reaction.emoji,\r\n      },\r\n    };\r\n    message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    return content;\r\n  }\r\n\r\n  private messageTextJson(received: any) {\r\n    let content: any;\r\n    const message = received.messages[0];\r\n    if (message.from === received.metadata.phone_number_id) {\r\n      content = {\r\n        extendedTextMessage: { text: message.text.body },\r\n      };\r\n      message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    } else {\r\n      content = { conversation: message.text.body };\r\n      message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    }\r\n    return content;\r\n  }\r\n\r\n  private messageContactsJson(received: any) {\r\n    const message = received.messages[0];\r\n    let content: any = {};\r\n\r\n    const vcard = (contact: any) => {\r\n      let result =\r\n        'BEGIN:VCARD\\n' +\r\n        'VERSION:3.0\\n' +\r\n        `N:${contact.name.formatted_name}\\n` +\r\n        `FN:${contact.name.formatted_name}\\n`;\r\n\r\n      if (contact.org) {\r\n        result += `ORG:${contact.org.company};\\n`;\r\n      }\r\n\r\n      if (contact.emails) {\r\n        result += `EMAIL:${contact.emails[0].email}\\n`;\r\n      }\r\n\r\n      if (contact.urls) {\r\n        result += `URL:${contact.urls[0].url}\\n`;\r\n      }\r\n\r\n      if (!contact.phones[0]?.wa_id) {\r\n        contact.phones[0].wa_id = createJid(contact.phones[0].phone);\r\n      }\r\n\r\n      result +=\r\n        `item1.TEL;waid=${contact.phones[0]?.wa_id}:${contact.phones[0].phone}\\n` +\r\n        'item1.X-ABLabel:Celular\\n' +\r\n        'END:VCARD';\r\n\r\n      return result;\r\n    };\r\n\r\n    if (message.contacts.length === 1) {\r\n      content.contactMessage = {\r\n        displayName: message.contacts[0].name.formatted_name,\r\n        vcard: vcard(message.contacts[0]),\r\n      };\r\n    } else {\r\n      content.contactsArrayMessage = {\r\n        displayName: `${message.length} contacts`,\r\n        contacts: message.map((contact) => {\r\n          return {\r\n            displayName: contact.name.formatted_name,\r\n            vcard: vcard(contact),\r\n          };\r\n        }),\r\n      };\r\n    }\r\n    message.context ? (content = { ...content, contextInfo: { stanzaId: message.context.id } }) : content;\r\n    return content;\r\n  }\r\n\r\n  private renderMessageType(type: string) {\r\n    let messageType: string;\r\n\r\n    switch (type) {\r\n      case 'text':\r\n        messageType = 'conversation';\r\n        break;\r\n      case 'image':\r\n        messageType = 'imageMessage';\r\n        break;\r\n      case 'video':\r\n        messageType = 'videoMessage';\r\n        break;\r\n      case 'audio':\r\n        messageType = 'audioMessage';\r\n        break;\r\n      case 'document':\r\n        messageType = 'documentMessage';\r\n        break;\r\n      case 'template':\r\n        messageType = 'conversation';\r\n        break;\r\n      default:\r\n        messageType = 'conversation';\r\n        break;\r\n    }\r\n\r\n    return messageType;\r\n  }\r\n\r\n  protected async messageHandle(received: any, database: Database, settings: any) {\r\n    try {\r\n      let messageRaw: any;\r\n      let pushName: any;\r\n\r\n      if (received.contacts) pushName = received.contacts[0].profile.name;\r\n\r\n      if (received.messages) {\r\n        const key = {\r\n          id: received.messages[0].id,\r\n          remoteJid: this.phoneNumber,\r\n          fromMe: received.messages[0].from === received.metadata.phone_number_id,\r\n        };\r\n        if (this.isMediaMessage(received?.messages[0])) {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: this.messageMediaJson(received),\r\n            contextInfo: this.messageMediaJson(received)?.contextInfo,\r\n            messageType: this.renderMessageType(received.messages[0].type),\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n\r\n          if (this.configService.get<S3>('S3').ENABLE) {\r\n            try {\r\n              const message: any = received;\r\n\r\n              const id = message.messages[0][message.messages[0].type].id;\r\n              let urlServer = this.configService.get<WaBusiness>('WA_BUSINESS').URL;\r\n              const version = this.configService.get<WaBusiness>('WA_BUSINESS').VERSION;\r\n              urlServer = `${urlServer}/${version}/${id}`;\r\n              const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${this.token}` };\r\n              const result = await axios.get(urlServer, { headers });\r\n\r\n              const buffer = await axios.get(result.data.url, { headers, responseType: 'arraybuffer' });\r\n\r\n              let mediaType;\r\n\r\n              if (message.messages[0].document) {\r\n                mediaType = 'document';\r\n              } else if (message.messages[0].image) {\r\n                mediaType = 'image';\r\n              } else if (message.messages[0].audio) {\r\n                mediaType = 'audio';\r\n              } else {\r\n                mediaType = 'video';\r\n              }\r\n\r\n              const mimetype = result.data?.mime_type || result.headers['content-type'];\r\n\r\n              const contentDisposition = result.headers['content-disposition'];\r\n              let fileName = `${message.messages[0].id}.${mimetype.split('/')[1]}`;\r\n              if (contentDisposition) {\r\n                const match = contentDisposition.match(/filename=\"(.+?)\"/);\r\n                if (match) {\r\n                  fileName = match[1];\r\n                }\r\n              }\r\n\r\n              const size = result.headers['content-length'] || buffer.data.byteLength;\r\n\r\n              const fullName = join(`${this.instance.id}`, key.remoteJid, mediaType, fileName);\r\n\r\n              await s3Service.uploadFile(fullName, buffer.data, size, {\r\n                'Content-Type': mimetype,\r\n              });\r\n\r\n              const createdMessage = await this.prismaRepository.message.create({\r\n                data: messageRaw,\r\n              });\r\n\r\n              await this.prismaRepository.media.create({\r\n                data: {\r\n                  messageId: createdMessage.id,\r\n                  instanceId: this.instanceId,\r\n                  type: mediaType,\r\n                  fileName: fullName,\r\n                  mimetype,\r\n                },\r\n              });\r\n\r\n              const mediaUrl = await s3Service.getObjectUrl(fullName);\r\n\r\n              messageRaw.message.mediaUrl = mediaUrl;\r\n              messageRaw.message.base64 = buffer.data.toString('base64');\r\n            } catch (error) {\r\n              this.logger.error(['Error on upload file to minio', error?.message, error?.stack]);\r\n            }\r\n          } else {\r\n            const buffer = await this.downloadMediaMessage(received?.messages[0]);\r\n\r\n            messageRaw.message.base64 = buffer.toString('base64');\r\n          }\r\n        } else if (received?.messages[0].interactive) {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: {\r\n              ...this.messageInteractiveJson(received),\r\n            },\r\n            contextInfo: this.messageInteractiveJson(received)?.contextInfo,\r\n            messageType: 'interactiveMessage',\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n        } else if (received?.messages[0].button) {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: {\r\n              ...this.messageButtonJson(received),\r\n            },\r\n            contextInfo: this.messageButtonJson(received)?.contextInfo,\r\n            messageType: 'buttonMessage',\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n        } else if (received?.messages[0].reaction) {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: {\r\n              ...this.messageReactionJson(received),\r\n            },\r\n            contextInfo: this.messageReactionJson(received)?.contextInfo,\r\n            messageType: 'reactionMessage',\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n        } else if (received?.messages[0].contacts) {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: {\r\n              ...this.messageContactsJson(received),\r\n            },\r\n            contextInfo: this.messageContactsJson(received)?.contextInfo,\r\n            messageType: 'contactMessage',\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n        } else {\r\n          messageRaw = {\r\n            key,\r\n            pushName,\r\n            message: this.messageTextJson(received),\r\n            contextInfo: this.messageTextJson(received)?.contextInfo,\r\n            messageType: this.renderMessageType(received.messages[0].type),\r\n            messageTimestamp: parseInt(received.messages[0].timestamp) as number,\r\n            source: 'unknown',\r\n            instanceId: this.instanceId,\r\n          };\r\n        }\r\n\r\n        if (this.localSettings.readMessages) {\r\n          // await this.client.readMessages([received.key]);\r\n        }\r\n\r\n        if (this.configService.get<Openai>('OPENAI').ENABLED) {\r\n          const openAiDefaultSettings = await this.prismaRepository.openaiSetting.findFirst({\r\n            where: {\r\n              instanceId: this.instanceId,\r\n            },\r\n            include: {\r\n              OpenaiCreds: true,\r\n            },\r\n          });\r\n\r\n          const audioMessage = received?.messages[0]?.audio;\r\n\r\n          if (\r\n            openAiDefaultSettings &&\r\n            openAiDefaultSettings.openaiCredsId &&\r\n            openAiDefaultSettings.speechToText &&\r\n            audioMessage\r\n          ) {\r\n            messageRaw.message.speechToText = await this.openaiService.speechToText(\r\n              openAiDefaultSettings.OpenaiCreds,\r\n              {\r\n                message: {\r\n                  mediaUrl: messageRaw.message.mediaUrl,\r\n                  ...messageRaw,\r\n                },\r\n              },\r\n              () => {},\r\n            );\r\n          }\r\n        }\r\n\r\n        this.logger.log(messageRaw);\r\n\r\n        this.sendDataWebhook(Events.MESSAGES_UPSERT, messageRaw);\r\n\r\n        await chatbotController.emit({\r\n          instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          msg: messageRaw,\r\n          pushName: messageRaw.pushName,\r\n        });\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n          const chatwootSentMessage = await this.chatwootService.eventWhatsapp(\r\n            Events.MESSAGES_UPSERT,\r\n            { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            messageRaw,\r\n          );\r\n\r\n          if (chatwootSentMessage?.id) {\r\n            messageRaw.chatwootMessageId = chatwootSentMessage.id;\r\n            messageRaw.chatwootInboxId = chatwootSentMessage.id;\r\n            messageRaw.chatwootConversationId = chatwootSentMessage.id;\r\n          }\r\n        }\r\n\r\n        if (!this.isMediaMessage(received?.messages[0])) {\r\n          await this.prismaRepository.message.create({\r\n            data: messageRaw,\r\n          });\r\n        }\r\n\r\n        const contact = await this.prismaRepository.contact.findFirst({\r\n          where: { instanceId: this.instanceId, remoteJid: key.remoteJid },\r\n        });\r\n\r\n        const contactRaw: any = {\r\n          remoteJid: received.contacts[0].profile.phone,\r\n          pushName,\r\n          // profilePicUrl: '',\r\n          instanceId: this.instanceId,\r\n        };\r\n\r\n        if (contactRaw.remoteJid === 'status@broadcast') {\r\n          return;\r\n        }\r\n\r\n        if (contact) {\r\n          const contactRaw: any = {\r\n            remoteJid: received.contacts[0].profile.phone,\r\n            pushName,\r\n            // profilePicUrl: '',\r\n            instanceId: this.instanceId,\r\n          };\r\n\r\n          this.sendDataWebhook(Events.CONTACTS_UPDATE, contactRaw);\r\n\r\n          if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n            await this.chatwootService.eventWhatsapp(\r\n              Events.CONTACTS_UPDATE,\r\n              { instanceName: this.instance.name, instanceId: this.instanceId },\r\n              contactRaw,\r\n            );\r\n          }\r\n\r\n          await this.prismaRepository.contact.updateMany({\r\n            where: { remoteJid: contact.remoteJid },\r\n            data: contactRaw,\r\n          });\r\n          return;\r\n        }\r\n\r\n        this.sendDataWebhook(Events.CONTACTS_UPSERT, contactRaw);\r\n\r\n        this.prismaRepository.contact.create({\r\n          data: contactRaw,\r\n        });\r\n      }\r\n      if (received.statuses) {\r\n        for await (const item of received.statuses) {\r\n          const key = {\r\n            id: item.id,\r\n            remoteJid: this.phoneNumber,\r\n            fromMe: this.phoneNumber === received.metadata.phone_number_id,\r\n          };\r\n          if (settings?.groups_ignore && key.remoteJid.includes('@g.us')) {\r\n            return;\r\n          }\r\n          if (key.remoteJid !== 'status@broadcast' && !key?.remoteJid?.match(/(:\\d+)/)) {\r\n            const findMessage = await this.prismaRepository.message.findFirst({\r\n              where: {\r\n                instanceId: this.instanceId,\r\n                key: {\r\n                  path: ['id'],\r\n                  equals: key.id,\r\n                },\r\n              },\r\n            });\r\n\r\n            if (!findMessage) {\r\n              return;\r\n            }\r\n\r\n            if (item.message === null && item.status === undefined) {\r\n              this.sendDataWebhook(Events.MESSAGES_DELETE, key);\r\n\r\n              const message: any = {\r\n                messageId: findMessage.id,\r\n                keyId: key.id,\r\n                remoteJid: key.remoteJid,\r\n                fromMe: key.fromMe,\r\n                participant: key?.remoteJid,\r\n                status: 'DELETED',\r\n                instanceId: this.instanceId,\r\n              };\r\n\r\n              await this.prismaRepository.messageUpdate.create({\r\n                data: message,\r\n              });\r\n\r\n              if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n                this.chatwootService.eventWhatsapp(\r\n                  Events.MESSAGES_DELETE,\r\n                  { instanceName: this.instance.name, instanceId: this.instanceId },\r\n                  { key: key },\r\n                );\r\n              }\r\n\r\n              return;\r\n            }\r\n\r\n            const message: any = {\r\n              messageId: findMessage.id,\r\n              keyId: key.id,\r\n              remoteJid: key.remoteJid,\r\n              fromMe: key.fromMe,\r\n              participant: key?.remoteJid,\r\n              status: item.status.toUpperCase(),\r\n              instanceId: this.instanceId,\r\n            };\r\n\r\n            this.sendDataWebhook(Events.MESSAGES_UPDATE, message);\r\n\r\n            await this.prismaRepository.messageUpdate.create({\r\n              data: message,\r\n            });\r\n\r\n            if (findMessage.webhookUrl) {\r\n              await axios.post(findMessage.webhookUrl, message);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  private convertMessageToRaw(message: any, content: any) {\r\n    let convertMessage: any;\r\n\r\n    if (message?.conversation) {\r\n      if (content?.context?.message_id) {\r\n        convertMessage = {\r\n          ...message,\r\n          contextInfo: { stanzaId: content.context.message_id },\r\n        };\r\n        return convertMessage;\r\n      }\r\n      convertMessage = message;\r\n      return convertMessage;\r\n    }\r\n\r\n    if (message?.mediaType === 'image') {\r\n      if (content?.context?.message_id) {\r\n        convertMessage = {\r\n          imageMessage: message,\r\n          contextInfo: { stanzaId: content.context.message_id },\r\n        };\r\n        return convertMessage;\r\n      }\r\n      return {\r\n        imageMessage: message,\r\n      };\r\n    }\r\n\r\n    if (message?.mediaType === 'video') {\r\n      if (content?.context?.message_id) {\r\n        convertMessage = {\r\n          videoMessage: message,\r\n          contextInfo: { stanzaId: content.context.message_id },\r\n        };\r\n        return convertMessage;\r\n      }\r\n      return {\r\n        videoMessage: message,\r\n      };\r\n    }\r\n\r\n    if (message?.mediaType === 'audio') {\r\n      if (content?.context?.message_id) {\r\n        convertMessage = {\r\n          audioMessage: message,\r\n          contextInfo: { stanzaId: content.context.message_id },\r\n        };\r\n        return convertMessage;\r\n      }\r\n      return {\r\n        audioMessage: message,\r\n      };\r\n    }\r\n\r\n    if (message?.mediaType === 'document') {\r\n      if (content?.context?.message_id) {\r\n        convertMessage = {\r\n          documentMessage: message,\r\n          contextInfo: { stanzaId: content.context.message_id },\r\n        };\r\n        return convertMessage;\r\n      }\r\n      return {\r\n        documentMessage: message,\r\n      };\r\n    }\r\n\r\n    return message;\r\n  }\r\n\r\n  protected async eventHandler(content: any) {\r\n    const database = this.configService.get<Database>('DATABASE');\r\n    const settings = await this.findSettings();\r\n\r\n    this.messageHandle(content, database, settings);\r\n  }\r\n\r\n  protected async sendMessageWithTyping(number: string, message: any, options?: Options, isIntegration = false) {\r\n    try {\r\n      let quoted: any;\r\n      let webhookUrl: any;\r\n      const linkPreview = options?.linkPreview != false ? undefined : false;\r\n      if (options?.quoted) {\r\n        const m = options?.quoted;\r\n\r\n        const msg = m?.key;\r\n\r\n        if (!msg) {\r\n          throw 'Message not found';\r\n        }\r\n\r\n        quoted = msg;\r\n      }\r\n      if (options?.webhookUrl) {\r\n        webhookUrl = options.webhookUrl;\r\n      }\r\n\r\n      let content: any;\r\n      const messageSent = await (async () => {\r\n        if (message['reactionMessage']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: 'reaction',\r\n            to: number.replace(/\\D/g, ''),\r\n            reaction: {\r\n              message_id: message['reactionMessage']['key']['id'],\r\n              emoji: message['reactionMessage']['text'],\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['locationMessage']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: 'location',\r\n            to: number.replace(/\\D/g, ''),\r\n            location: {\r\n              longitude: message['locationMessage']['degreesLongitude'],\r\n              latitude: message['locationMessage']['degreesLatitude'],\r\n              name: message['locationMessage']['name'],\r\n              address: message['locationMessage']['address'],\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['contacts']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: 'contacts',\r\n            to: number.replace(/\\D/g, ''),\r\n            contacts: message['contacts'],\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          message = message['message'];\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['conversation']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: 'text',\r\n            to: number.replace(/\\D/g, ''),\r\n            text: {\r\n              body: message['conversation'],\r\n              preview_url: linkPreview,\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['media']) {\r\n          const isImage = message['mimetype']?.startsWith('image/');\r\n\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: message['mediaType'],\r\n            to: number.replace(/\\D/g, ''),\r\n            [message['mediaType']]: {\r\n              [message['type']]: message['id'],\r\n              preview_url: linkPreview,\r\n              ...(message['fileName'] && !isImage && { filename: message['fileName'] }),\r\n              caption: message['caption'],\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['audio']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            type: 'audio',\r\n            to: number.replace(/\\D/g, ''),\r\n            audio: {\r\n              [message['type']]: message['id'],\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['buttons']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: number.replace(/\\D/g, ''),\r\n            type: 'interactive',\r\n            interactive: {\r\n              type: 'button',\r\n              body: {\r\n                text: message['text'] || 'Select',\r\n              },\r\n              action: {\r\n                buttons: message['buttons'],\r\n              },\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          let formattedText = '';\r\n          for (const item of message['buttons']) {\r\n            formattedText += ` ${item.reply?.title}\\n`;\r\n          }\r\n          message = { conversation: `${message['text'] || 'Select'}\\n` + formattedText };\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['listMessage']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: number.replace(/\\D/g, ''),\r\n            type: 'interactive',\r\n            interactive: {\r\n              type: 'list',\r\n              header: {\r\n                type: 'text',\r\n                text: message['listMessage']['title'],\r\n              },\r\n              body: {\r\n                text: message['listMessage']['description'],\r\n              },\r\n              footer: {\r\n                text: message['listMessage']['footerText'],\r\n              },\r\n              action: {\r\n                button: message['listMessage']['buttonText'],\r\n                sections: message['listMessage']['sections'],\r\n              },\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          let formattedText = '';\r\n          for (const section of message['listMessage']['sections']) {\r\n            formattedText += `${section?.title}\\n`;\r\n            for (const row of section.rows) {\r\n              formattedText += `${row?.title}\\n`;\r\n            }\r\n          }\r\n          message = { conversation: `${message['listMessage']['title']}\\n` + formattedText };\r\n          return await this.post(content, 'messages');\r\n        }\r\n        if (message['template']) {\r\n          content = {\r\n            messaging_product: 'whatsapp',\r\n            recipient_type: 'individual',\r\n            to: number.replace(/\\D/g, ''),\r\n            type: 'template',\r\n            template: {\r\n              name: message['template']['name'],\r\n              language: {\r\n                code: message['template']['language'] || 'en_US',\r\n              },\r\n              components: message['template']['components'],\r\n            },\r\n          };\r\n          quoted ? (content.context = { message_id: quoted.id }) : content;\r\n          message = { conversation: `${message['template']['name']}` };\r\n          return await this.post(content, 'messages');\r\n        }\r\n      })();\r\n\r\n      if (messageSent?.error_data) {\r\n        this.logger.error(messageSent);\r\n        return messageSent;\r\n      }\r\n\r\n      const messageRaw: any = {\r\n        key: { fromMe: true, id: messageSent?.messages[0]?.id, remoteJid: createJid(number) },\r\n        message: this.convertMessageToRaw(message, content),\r\n        messageType: this.renderMessageType(content.type),\r\n        messageTimestamp: (messageSent?.messages[0]?.timestamp as number) || Math.round(new Date().getTime() / 1000),\r\n        instanceId: this.instanceId,\r\n        webhookUrl,\r\n        status: status[1],\r\n        source: 'unknown',\r\n      };\r\n\r\n      this.logger.log(messageRaw);\r\n\r\n      this.sendDataWebhook(Events.SEND_MESSAGE, messageRaw);\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && !isIntegration) {\r\n        this.chatwootService.eventWhatsapp(\r\n          Events.SEND_MESSAGE,\r\n          { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          messageRaw,\r\n        );\r\n      }\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && isIntegration)\r\n        await chatbotController.emit({\r\n          instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          msg: messageRaw,\r\n          pushName: messageRaw.pushName,\r\n        });\r\n\r\n      await this.prismaRepository.message.create({\r\n        data: messageRaw,\r\n      });\r\n\r\n      return messageRaw;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  // Send Message Controller\r\n  public async textMessage(data: SendTextDto, isIntegration = false) {\r\n    const res = await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        conversation: data.text,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n    return res;\r\n  }\r\n\r\n  private async getIdMedia(mediaMessage: any) {\r\n    const formData = new FormData();\r\n\r\n    const fileStream = createReadStream(mediaMessage.media);\r\n\r\n    formData.append('file', fileStream, { filename: 'media', contentType: mediaMessage.mimetype });\r\n    formData.append('typeFile', mediaMessage.mimetype);\r\n    formData.append('messaging_product', 'whatsapp');\r\n\r\n    // const fileBuffer = await fs.readFile(mediaMessage.media);\r\n\r\n    // const fileBlob = new Blob([fileBuffer], { type: mediaMessage.mimetype });\r\n    // formData.append('file', fileBlob);\r\n    // formData.append('typeFile', mediaMessage.mimetype);\r\n    // formData.append('messaging_product', 'whatsapp');\r\n\r\n    const headers = { Authorization: `Bearer ${this.token}` };\r\n    const res = await axios.post(\r\n      process.env.API_URL + '/' + process.env.VERSION + '/' + this.number + '/media',\r\n      formData,\r\n      { headers },\r\n    );\r\n    return res.data.id;\r\n  }\r\n\r\n  protected async prepareMediaMessage(mediaMessage: MediaMessage) {\r\n    try {\r\n      if (mediaMessage.mediatype === 'document' && !mediaMessage.fileName) {\r\n        const regex = new RegExp(/.*\\/(.+?)\\./);\r\n        const arrayMatch = regex.exec(mediaMessage.media);\r\n        mediaMessage.fileName = arrayMatch[1];\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'image' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'image.png';\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'video' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'video.mp4';\r\n      }\r\n\r\n      let mimetype: string | false;\r\n\r\n      const prepareMedia: any = {\r\n        caption: mediaMessage?.caption,\r\n        fileName: mediaMessage.fileName,\r\n        mediaType: mediaMessage.mediatype,\r\n        media: mediaMessage.media,\r\n        gifPlayback: false,\r\n      };\r\n\r\n      if (isURL(mediaMessage.media)) {\r\n        mimetype = mimeTypes.lookup(mediaMessage.media);\r\n        prepareMedia.id = mediaMessage.media;\r\n        prepareMedia.type = 'link';\r\n      } else {\r\n        mimetype = mimeTypes.lookup(mediaMessage.fileName);\r\n        const id = await this.getIdMedia(prepareMedia);\r\n        prepareMedia.id = id;\r\n        prepareMedia.type = 'id';\r\n      }\r\n\r\n      prepareMedia.mimetype = mimetype;\r\n\r\n      return prepareMedia;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString() || error);\r\n    }\r\n  }\r\n\r\n  public async mediaMessage(data: SendMediaDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendMediaDto = { ...data };\r\n\r\n    if (file) mediaData.media = file.buffer.toString('base64');\r\n\r\n    const message = await this.prepareMediaMessage(mediaData);\r\n\r\n    const mediaSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n\r\n    return mediaSent;\r\n  }\r\n\r\n  public async processAudio(audio: string, number: string) {\r\n    number = number.replace(/\\D/g, '');\r\n    const hash = `${number}-${new Date().getTime()}`;\r\n\r\n    let mimetype: string | false;\r\n\r\n    const prepareMedia: any = {\r\n      fileName: `${hash}.mp3`,\r\n      mediaType: 'audio',\r\n      media: audio,\r\n    };\r\n\r\n    if (isURL(audio)) {\r\n      mimetype = mimeTypes.lookup(audio);\r\n      prepareMedia.id = audio;\r\n      prepareMedia.type = 'link';\r\n    } else {\r\n      mimetype = mimeTypes.lookup(prepareMedia.fileName);\r\n      const id = await this.getIdMedia(prepareMedia);\r\n      prepareMedia.id = id;\r\n      prepareMedia.type = 'id';\r\n    }\r\n\r\n    prepareMedia.mimetype = mimetype;\r\n\r\n    return prepareMedia;\r\n  }\r\n\r\n  public async audioWhatsapp(data: SendAudioDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendAudioDto = { ...data };\r\n\r\n    if (file?.buffer) {\r\n      mediaData.audio = file.buffer.toString('base64');\r\n    } else if (isURL(mediaData.audio)) {\r\n      // DO NOTHING\r\n      // mediaData.audio = mediaData.audio;\r\n    } else {\r\n      console.error('El archivo no tiene buffer o file es undefined');\r\n      throw new Error('File or buffer is undefined');\r\n    }\r\n\r\n    const message = await this.processAudio(mediaData.audio, data.number);\r\n\r\n    const audioSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n\r\n    return audioSent;\r\n  }\r\n\r\n  public async buttonMessage(data: SendButtonsDto) {\r\n    const embeddedMedia: any = {};\r\n\r\n    const btnItems = {\r\n      text: data.buttons.map((btn) => btn.displayText),\r\n      ids: data.buttons.map((btn) => btn.id),\r\n    };\r\n\r\n    if (!arrayUnique(btnItems.text) || !arrayUnique(btnItems.ids)) {\r\n      throw new BadRequestException('Button texts cannot be repeated', 'Button IDs cannot be repeated.');\r\n    }\r\n\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        text: !embeddedMedia?.mediaKey ? data.title : undefined,\r\n        buttons: data.buttons.map((button) => {\r\n          return {\r\n            type: 'reply',\r\n            reply: {\r\n              title: button.displayText,\r\n              id: button.id,\r\n            },\r\n          };\r\n        }),\r\n        [embeddedMedia?.mediaKey]: embeddedMedia?.message,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  public async locationMessage(data: SendLocationDto) {\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        locationMessage: {\r\n          degreesLatitude: data.latitude,\r\n          degreesLongitude: data.longitude,\r\n          name: data?.name,\r\n          address: data?.address,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  public async listMessage(data: SendListDto) {\r\n    const sectionsItems = {\r\n      title: data.sections.map((list) => list.title),\r\n    };\r\n\r\n    if (!arrayUnique(sectionsItems.title)) {\r\n      throw new BadRequestException('Section tiles cannot be repeated');\r\n    }\r\n\r\n    const sendData: any = {\r\n      listMessage: {\r\n        title: data.title,\r\n        description: data.description,\r\n        footerText: data?.footerText,\r\n        buttonText: data?.buttonText,\r\n        sections: data.sections.map((section) => {\r\n          return {\r\n            title: section.title,\r\n            rows: section.rows.map((row) => {\r\n              return {\r\n                title: row.title,\r\n                description: row.description.substring(0, 72),\r\n                id: row.rowId,\r\n              };\r\n            }),\r\n          };\r\n        }),\r\n      },\r\n    };\r\n\r\n    return await this.sendMessageWithTyping(data.number, sendData, {\r\n      delay: data?.delay,\r\n      presence: 'composing',\r\n      quoted: data?.quoted,\r\n      linkPreview: data?.linkPreview,\r\n      mentionsEveryOne: data?.mentionsEveryOne,\r\n      mentioned: data?.mentioned,\r\n    });\r\n  }\r\n\r\n  public async templateMessage(data: SendTemplateDto, isIntegration = false) {\r\n    const res = await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        template: {\r\n          name: data.name,\r\n          language: data.language,\r\n          components: data.components,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n        webhookUrl: data?.webhookUrl,\r\n      },\r\n      isIntegration,\r\n    );\r\n    return res;\r\n  }\r\n\r\n  public async contactMessage(data: SendContactDto) {\r\n    const message: any = {};\r\n\r\n    const vcard = (contact: ContactMessage) => {\r\n      let result = 'BEGIN:VCARD\\n' + 'VERSION:3.0\\n' + `N:${contact.fullName}\\n` + `FN:${contact.fullName}\\n`;\r\n\r\n      if (contact.organization) {\r\n        result += `ORG:${contact.organization};\\n`;\r\n      }\r\n\r\n      if (contact.email) {\r\n        result += `EMAIL:${contact.email}\\n`;\r\n      }\r\n\r\n      if (contact.url) {\r\n        result += `URL:${contact.url}\\n`;\r\n      }\r\n\r\n      if (!contact.wuid) {\r\n        contact.wuid = createJid(contact.phoneNumber);\r\n      }\r\n\r\n      result += `item1.TEL;waid=${contact.wuid}:${contact.phoneNumber}\\n` + 'item1.X-ABLabel:Celular\\n' + 'END:VCARD';\r\n\r\n      return result;\r\n    };\r\n\r\n    if (data.contact.length === 1) {\r\n      message.contact = {\r\n        displayName: data.contact[0].fullName,\r\n        vcard: vcard(data.contact[0]),\r\n      };\r\n    } else {\r\n      message.contactsArrayMessage = {\r\n        displayName: `${data.contact.length} contacts`,\r\n        contacts: data.contact.map((contact) => {\r\n          return {\r\n            displayName: contact.fullName,\r\n            vcard: vcard(contact),\r\n          };\r\n        }),\r\n      };\r\n    }\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        contacts: data.contact.map((contact) => {\r\n          return {\r\n            name: { formatted_name: contact.fullName, first_name: contact.fullName },\r\n            phones: [{ phone: contact.phoneNumber }],\r\n            urls: [{ url: contact.url }],\r\n            emails: [{ email: contact.email }],\r\n            org: { company: contact.organization },\r\n          };\r\n        }),\r\n        message,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  public async reactionMessage(data: SendReactionDto) {\r\n    return await this.sendMessageWithTyping(data.key.remoteJid, {\r\n      reactionMessage: {\r\n        key: data.key,\r\n        text: data.reaction,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async getBase64FromMediaMessage(data: any) {\r\n    try {\r\n      const msg = data.message;\r\n      const messageType = msg.messageType.includes('Message') ? msg.messageType : msg.messageType + 'Message';\r\n      const mediaMessage = msg.message[messageType];\r\n\r\n      return {\r\n        mediaType: msg.messageType,\r\n        fileName: mediaMessage?.fileName,\r\n        caption: mediaMessage?.caption,\r\n        size: {\r\n          fileLength: mediaMessage?.fileLength,\r\n          height: mediaMessage?.fileLength,\r\n          width: mediaMessage?.width,\r\n        },\r\n        mimetype: mediaMessage?.mime_type,\r\n        base64: msg.message.base64,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async deleteMessage() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n\r\n  // methods not available on WhatsApp Business API\r\n  public async mediaSticker() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async pollMessage() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async statusMessage() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async reloadConnection() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async whatsappNumber() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async markMessageAsRead() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async archiveChat() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async markChatUnread() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fetchProfile() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async offerCall() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async sendPresence() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async setPresence() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fetchPrivacySettings() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updatePrivacySettings() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fetchBusinessProfile() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateProfileName() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateProfileStatus() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateProfilePicture() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async removeProfilePicture() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async blockUser() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateMessage() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async createGroup() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateGroupPicture() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateGroupSubject() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateGroupDescription() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async findGroup() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fetchAllGroups() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async inviteCode() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async inviteInfo() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async sendInvite() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async acceptInviteCode() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async revokeInviteCode() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async findParticipants() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateGParticipant() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async updateGSetting() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async toggleEphemeral() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async leaveGroup() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fetchLabels() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async handleLabel() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async receiveMobileCode() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n  public async fakeCall() {\r\n    throw new BadRequestException('Method not available on WhatsApp Business API');\r\n  }\r\n}\r\n","import {\r\n  proto,\r\n  WAPresence,\r\n  WAPrivacyGroupAddValue,\r\n  WAPrivacyOnlineValue,\r\n  WAPrivacyValue,\r\n  WAReadReceiptsValue,\r\n} from 'baileys';\r\n\r\nexport class OnWhatsAppDto {\r\n  constructor(\r\n    public readonly jid: string,\r\n    public readonly exists: boolean,\r\n    public readonly number: string,\r\n    public readonly name?: string,\r\n  ) {}\r\n}\r\n\r\nexport class getBase64FromMediaMessageDto {\r\n  message: proto.WebMessageInfo;\r\n  convertToMp4?: boolean;\r\n}\r\n\r\nexport class WhatsAppNumberDto {\r\n  numbers: string[];\r\n}\r\n\r\nexport class NumberDto {\r\n  number: string;\r\n}\r\n\r\nexport class NumberBusiness {\r\n  wid?: string;\r\n  jid?: string;\r\n  exists?: boolean;\r\n  isBusiness: boolean;\r\n  name?: string;\r\n  message?: string;\r\n  description?: string;\r\n  email?: string;\r\n  websites?: string[];\r\n  website?: string[];\r\n  address?: string;\r\n  about?: string;\r\n  vertical?: string;\r\n  profilehandle?: string;\r\n}\r\n\r\nexport class ProfileNameDto {\r\n  name: string;\r\n}\r\n\r\nexport class ProfileStatusDto {\r\n  status: string;\r\n}\r\n\r\nexport class ProfilePictureDto {\r\n  number?: string;\r\n  // url or base64\r\n  picture?: string;\r\n}\r\n\r\nclass Key {\r\n  id: string;\r\n  fromMe: boolean;\r\n  remoteJid: string;\r\n}\r\nexport class ReadMessageDto {\r\n  readMessages: Key[];\r\n}\r\n\r\nexport class LastMessage {\r\n  key: Key;\r\n  messageTimestamp?: number;\r\n}\r\n\r\nexport class ArchiveChatDto {\r\n  lastMessage?: LastMessage;\r\n  chat?: string;\r\n  archive: boolean;\r\n}\r\n\r\nexport class MarkChatUnreadDto {\r\n  lastMessage?: LastMessage;\r\n  chat?: string;\r\n}\r\n\r\nexport class PrivacySettingDto {\r\n  readreceipts: WAReadReceiptsValue;\r\n  profile: WAPrivacyValue;\r\n  status: WAPrivacyValue;\r\n  online: WAPrivacyOnlineValue;\r\n  last: WAPrivacyValue;\r\n  groupadd: WAPrivacyGroupAddValue;\r\n}\r\n\r\nexport class DeleteMessage {\r\n  id: string;\r\n  fromMe: boolean;\r\n  remoteJid: string;\r\n  participant?: string;\r\n}\r\nexport class Options {\r\n  delay?: number;\r\n  presence?: WAPresence;\r\n}\r\nclass OptionsMessage {\r\n  options: Options;\r\n}\r\nexport class Metadata extends OptionsMessage {\r\n  number: string;\r\n}\r\n\r\nexport class SendPresenceDto extends Metadata {\r\n  presence: WAPresence;\r\n  delay: number;\r\n}\r\n\r\nexport class UpdateMessageDto extends Metadata {\r\n  number: string;\r\n  key: proto.IMessageKey;\r\n  text: string;\r\n}\r\n\r\nexport class BlockUserDto {\r\n  number: string;\r\n  status: 'block' | 'unblock';\r\n}\r\n","import { ICache } from '@api/abstract/abstract.cache';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BufferJSON } from 'baileys';\r\n\r\nexport class CacheService {\r\n  private readonly logger = new Logger('CacheService');\r\n\r\n  constructor(private readonly cache: ICache) {\r\n    if (cache) {\r\n      this.logger.verbose(`cacheservice created using cache engine: ${cache.constructor?.name}`);\r\n    } else {\r\n      this.logger.verbose(`cacheservice disabled`);\r\n    }\r\n  }\r\n\r\n  async get(key: string): Promise<any> {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    return this.cache.get(key);\r\n  }\r\n\r\n  public async hGet(key: string, field: string) {\r\n    if (!this.cache) {\r\n      return null;\r\n    }\r\n    try {\r\n      const data = await this.cache.hGet(key, field);\r\n\r\n      if (data) {\r\n        return JSON.parse(data, BufferJSON.reviver);\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async set(key: string, value: any, ttl?: number) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    this.cache.set(key, value, ttl);\r\n  }\r\n\r\n  public async hSet(key: string, field: string, value: any) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    try {\r\n      const json = JSON.stringify(value, BufferJSON.replacer);\r\n\r\n      await this.cache.hSet(key, field, json);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  async has(key: string) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    return this.cache.has(key);\r\n  }\r\n\r\n  async delete(key: string) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    return this.cache.delete(key);\r\n  }\r\n\r\n  async hDelete(key: string, field: string) {\r\n    if (!this.cache) {\r\n      return false;\r\n    }\r\n    try {\r\n      await this.cache.hDelete(key, field);\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async deleteAll(appendCriteria?: string) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    return this.cache.deleteAll(appendCriteria);\r\n  }\r\n\r\n  async keys(appendCriteria?: string) {\r\n    if (!this.cache) {\r\n      return;\r\n    }\r\n    return this.cache.keys(appendCriteria);\r\n  }\r\n}\r\n","import { OfferCallDto } from '@api/dto/call.dto';\r\nimport {\r\n  ArchiveChatDto,\r\n  BlockUserDto,\r\n  DeleteMessage,\r\n  getBase64FromMediaMessageDto,\r\n  LastMessage,\r\n  MarkChatUnreadDto,\r\n  NumberBusiness,\r\n  OnWhatsAppDto,\r\n  PrivacySettingDto,\r\n  ReadMessageDto,\r\n  SendPresenceDto,\r\n  UpdateMessageDto,\r\n  WhatsAppNumberDto,\r\n} from '@api/dto/chat.dto';\r\nimport {\r\n  AcceptGroupInvite,\r\n  CreateGroupDto,\r\n  GetParticipant,\r\n  GroupDescriptionDto,\r\n  GroupInvite,\r\n  GroupJid,\r\n  GroupPictureDto,\r\n  GroupSendInvite,\r\n  GroupSubjectDto,\r\n  GroupToggleEphemeralDto,\r\n  GroupUpdateParticipantDto,\r\n  GroupUpdateSettingDto,\r\n} from '@api/dto/group.dto';\r\nimport { InstanceDto, SetPresenceDto } from '@api/dto/instance.dto';\r\nimport { HandleLabelDto, LabelDto } from '@api/dto/label.dto';\r\nimport {\r\n  Button,\r\n  ContactMessage,\r\n  KeyType,\r\n  MediaMessage,\r\n  Options,\r\n  SendAudioDto,\r\n  SendButtonsDto,\r\n  SendContactDto,\r\n  SendListDto,\r\n  SendLocationDto,\r\n  SendMediaDto,\r\n  SendPollDto,\r\n  SendPtvDto,\r\n  SendReactionDto,\r\n  SendStatusDto,\r\n  SendStickerDto,\r\n  SendTextDto,\r\n  StatusMessage,\r\n  TypeButton,\r\n} from '@api/dto/sendMessage.dto';\r\nimport { chatwootImport } from '@api/integrations/chatbot/chatwoot/utils/chatwoot-import-helper';\r\nimport * as s3Service from '@api/integrations/storage/s3/libs/minio.server';\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { chatbotController, waMonitor } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { ChannelStartupService } from '@api/services/channel.service';\r\nimport { Events, MessageSubtype, TypeMediaMessage, wa } from '@api/types/wa.types';\r\nimport { CacheEngine } from '@cache/cacheengine';\r\nimport {\r\n  CacheConf,\r\n  Chatwoot,\r\n  ConfigService,\r\n  configService,\r\n  ConfigSessionPhone,\r\n  Database,\r\n  Log,\r\n  Openai,\r\n  ProviderSession,\r\n  QrCode,\r\n  S3,\r\n} from '@config/env.config';\r\nimport { BadRequestException, InternalServerErrorException, NotFoundException } from '@exceptions';\r\nimport ffmpegPath from '@ffmpeg-installer/ffmpeg';\r\nimport { Boom } from '@hapi/boom';\r\nimport { createId as cuid } from '@paralleldrive/cuid2';\r\nimport { Instance } from '@prisma/client';\r\nimport { createJid } from '@utils/createJid';\r\nimport { makeProxyAgent } from '@utils/makeProxyAgent';\r\nimport { getOnWhatsappCache, saveOnWhatsappCache } from '@utils/onWhatsappCache';\r\nimport { status } from '@utils/renderStatus';\r\nimport useMultiFileAuthStatePrisma from '@utils/use-multi-file-auth-state-prisma';\r\nimport { AuthStateProvider } from '@utils/use-multi-file-auth-state-provider-files';\r\nimport { useMultiFileAuthStateRedisDb } from '@utils/use-multi-file-auth-state-redis-db';\r\nimport axios from 'axios';\r\nimport makeWASocket, {\r\n  AnyMessageContent,\r\n  BufferedEventData,\r\n  BufferJSON,\r\n  CacheStore,\r\n  Chat,\r\n  ConnectionState,\r\n  Contact,\r\n  delay,\r\n  DisconnectReason,\r\n  downloadMediaMessage,\r\n  fetchLatestBaileysVersion,\r\n  generateWAMessageFromContent,\r\n  getAggregateVotesInPollMessage,\r\n  getContentType,\r\n  getDevice,\r\n  GroupMetadata,\r\n  isJidBroadcast,\r\n  isJidGroup,\r\n  isJidNewsletter,\r\n  isJidUser,\r\n  makeCacheableSignalKeyStore,\r\n  MessageUpsertType,\r\n  MessageUserReceiptUpdate,\r\n  MiscMessageGenerationOptions,\r\n  ParticipantAction,\r\n  prepareWAMessageMedia,\r\n  proto,\r\n  UserFacingSocketConfig,\r\n  WABrowserDescription,\r\n  WAMediaUpload,\r\n  WAMessage,\r\n  WAMessageUpdate,\r\n  WAPresence,\r\n  WASocket,\r\n} from 'baileys';\r\nimport { Label } from 'baileys/lib/Types/Label';\r\nimport { LabelAssociation } from 'baileys/lib/Types/LabelAssociation';\r\nimport { spawn } from 'child_process';\r\nimport { isArray, isBase64, isURL } from 'class-validator';\r\nimport { randomBytes } from 'crypto';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport ffmpeg from 'fluent-ffmpeg';\r\nimport FormData from 'form-data';\r\nimport { readFileSync } from 'fs';\r\nimport Long from 'long';\r\nimport mimeTypes from 'mime-types';\r\nimport NodeCache from 'node-cache';\r\nimport cron from 'node-cron';\r\nimport { release } from 'os';\r\nimport { join } from 'path';\r\nimport P from 'pino';\r\nimport qrcode, { QRCodeToDataURLOptions } from 'qrcode';\r\nimport qrcodeTerminal from 'qrcode-terminal';\r\nimport sharp from 'sharp';\r\nimport { PassThrough, Readable } from 'stream';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { useVoiceCallsBaileys } from './voiceCalls/useVoiceCallsBaileys';\r\n\r\nconst groupMetadataCache = new CacheService(new CacheEngine(configService, 'groups').getEngine());\r\n\r\n// Adicione a funo getVideoDuration no incio do arquivo\r\nasync function getVideoDuration(input: Buffer | string | Readable): Promise<number> {\r\n  const MediaInfoFactory = (await import('mediainfo.js')).default;\r\n  const mediainfo = await MediaInfoFactory({ format: 'JSON' });\r\n\r\n  let fileSize: number;\r\n  let readChunk: (size: number, offset: number) => Promise<Buffer>;\r\n\r\n  if (Buffer.isBuffer(input)) {\r\n    fileSize = input.length;\r\n    readChunk = async (size: number, offset: number): Promise<Buffer> => {\r\n      return input.slice(offset, offset + size);\r\n    };\r\n  } else if (typeof input === 'string') {\r\n    const fs = await import('fs');\r\n    const stat = await fs.promises.stat(input);\r\n    fileSize = stat.size;\r\n    const fd = await fs.promises.open(input, 'r');\r\n\r\n    readChunk = async (size: number, offset: number): Promise<Buffer> => {\r\n      const buffer = Buffer.alloc(size);\r\n      await fd.read(buffer, 0, size, offset);\r\n      return buffer;\r\n    };\r\n\r\n    try {\r\n      const result = await mediainfo.analyzeData(() => fileSize, readChunk);\r\n      const jsonResult = JSON.parse(result);\r\n\r\n      const generalTrack = jsonResult.media.track.find((t: any) => t['@type'] === 'General');\r\n      const duration = generalTrack.Duration;\r\n\r\n      return Math.round(parseFloat(duration));\r\n    } finally {\r\n      await fd.close();\r\n    }\r\n  } else if (input instanceof Readable) {\r\n    const chunks: Buffer[] = [];\r\n    for await (const chunk of input) {\r\n      chunks.push(chunk);\r\n    }\r\n    const data = Buffer.concat(chunks);\r\n    fileSize = data.length;\r\n\r\n    readChunk = async (size: number, offset: number): Promise<Buffer> => {\r\n      return data.slice(offset, offset + size);\r\n    };\r\n  } else {\r\n    throw new Error('Tipo de entrada no suportado');\r\n  }\r\n\r\n  const result = await mediainfo.analyzeData(() => fileSize, readChunk);\r\n  const jsonResult = JSON.parse(result);\r\n\r\n  const generalTrack = jsonResult.media.track.find((t: any) => t['@type'] === 'General');\r\n  const duration = generalTrack.Duration;\r\n\r\n  return Math.round(parseFloat(duration));\r\n}\r\n\r\nexport class BaileysStartupService extends ChannelStartupService {\r\n  constructor(\r\n    public readonly configService: ConfigService,\r\n    public readonly eventEmitter: EventEmitter2,\r\n    public readonly prismaRepository: PrismaRepository,\r\n    public readonly cache: CacheService,\r\n    public readonly chatwootCache: CacheService,\r\n    public readonly baileysCache: CacheService,\r\n    private readonly providerFiles: ProviderFiles,\r\n  ) {\r\n    super(configService, eventEmitter, prismaRepository, chatwootCache);\r\n    this.instance.qrcode = { count: 0 };\r\n\r\n    this.authStateProvider = new AuthStateProvider(this.providerFiles);\r\n  }\r\n\r\n  private authStateProvider: AuthStateProvider;\r\n  private readonly msgRetryCounterCache: CacheStore = new NodeCache();\r\n  private readonly userDevicesCache: CacheStore = new NodeCache();\r\n  private endSession = false;\r\n  private logBaileys = this.configService.get<Log>('LOG').BAILEYS;\r\n\r\n  public stateConnection: wa.StateConnection = { state: 'close' };\r\n\r\n  public phoneNumber: string;\r\n\r\n  public get connectionStatus() {\r\n    return this.stateConnection;\r\n  }\r\n\r\n  public async logoutInstance() {\r\n    await this.client?.logout('Log out instance: ' + this.instanceName);\r\n\r\n    this.client?.ws?.close();\r\n\r\n    const sessionExists = await this.prismaRepository.session.findFirst({\r\n      where: { sessionId: this.instanceId },\r\n    });\r\n    if (sessionExists) {\r\n      await this.prismaRepository.session.delete({\r\n        where: {\r\n          sessionId: this.instanceId,\r\n        },\r\n      });\r\n    }\r\n  }\r\n\r\n  public async getProfileName() {\r\n    let profileName = this.client.user?.name ?? this.client.user?.verifiedName;\r\n    if (!profileName) {\r\n      const data = await this.prismaRepository.session.findUnique({\r\n        where: { sessionId: this.instanceId },\r\n      });\r\n\r\n      if (data) {\r\n        const creds = JSON.parse(JSON.stringify(data.creds), BufferJSON.reviver);\r\n        profileName = creds.me?.name || creds.me?.verifiedName;\r\n      }\r\n    }\r\n\r\n    return profileName;\r\n  }\r\n\r\n  public async getProfileStatus() {\r\n    const status = await this.client.fetchStatus(this.instance.wuid);\r\n\r\n    return status[0]?.status;\r\n  }\r\n\r\n  public get profilePictureUrl() {\r\n    return this.instance.profilePictureUrl;\r\n  }\r\n\r\n  public get qrCode(): wa.QrCode {\r\n    return {\r\n      pairingCode: this.instance.qrcode?.pairingCode,\r\n      code: this.instance.qrcode?.code,\r\n      base64: this.instance.qrcode?.base64,\r\n      count: this.instance.qrcode?.count,\r\n    };\r\n  }\r\n\r\n  private async connectionUpdate({ qr, connection, lastDisconnect }: Partial<ConnectionState>) {\r\n    if (qr) {\r\n      if (this.instance.qrcode.count === this.configService.get<QrCode>('QRCODE').LIMIT) {\r\n        this.sendDataWebhook(Events.QRCODE_UPDATED, {\r\n          message: 'QR code limit reached, please login again',\r\n          statusCode: DisconnectReason.badSession,\r\n        });\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n          this.chatwootService.eventWhatsapp(\r\n            Events.QRCODE_UPDATED,\r\n            { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            {\r\n              message: 'QR code limit reached, please login again',\r\n              statusCode: DisconnectReason.badSession,\r\n            },\r\n          );\r\n        }\r\n\r\n        this.sendDataWebhook(Events.CONNECTION_UPDATE, {\r\n          instance: this.instance.name,\r\n          state: 'refused',\r\n          statusReason: DisconnectReason.connectionClosed,\r\n          wuid: this.instance.wuid,\r\n          profileName: await this.getProfileName(),\r\n          profilePictureUrl: this.instance.profilePictureUrl,\r\n        });\r\n\r\n        this.endSession = true;\r\n\r\n        return this.eventEmitter.emit('no.connection', this.instance.name);\r\n      }\r\n\r\n      this.instance.qrcode.count++;\r\n\r\n      const color = this.configService.get<QrCode>('QRCODE').COLOR;\r\n\r\n      const optsQrcode: QRCodeToDataURLOptions = {\r\n        margin: 3,\r\n        scale: 4,\r\n        errorCorrectionLevel: 'H',\r\n        color: { light: '#ffffff', dark: color },\r\n      };\r\n\r\n      if (this.phoneNumber) {\r\n        await delay(1000);\r\n        this.instance.qrcode.pairingCode = await this.client.requestPairingCode(this.phoneNumber);\r\n      } else {\r\n        this.instance.qrcode.pairingCode = null;\r\n      }\r\n\r\n      qrcode.toDataURL(qr, optsQrcode, (error, base64) => {\r\n        if (error) {\r\n          this.logger.error('Qrcode generate failed:' + error.toString());\r\n          return;\r\n        }\r\n\r\n        this.instance.qrcode.base64 = base64;\r\n        this.instance.qrcode.code = qr;\r\n\r\n        this.sendDataWebhook(Events.QRCODE_UPDATED, {\r\n          qrcode: {\r\n            instance: this.instance.name,\r\n            pairingCode: this.instance.qrcode.pairingCode,\r\n            code: qr,\r\n            base64,\r\n          },\r\n        });\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n          this.chatwootService.eventWhatsapp(\r\n            Events.QRCODE_UPDATED,\r\n            { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            {\r\n              qrcode: {\r\n                instance: this.instance.name,\r\n                pairingCode: this.instance.qrcode.pairingCode,\r\n                code: qr,\r\n                base64,\r\n              },\r\n            },\r\n          );\r\n        }\r\n      });\r\n\r\n      qrcodeTerminal.generate(qr, { small: true }, (qrcode) =>\r\n        this.logger.log(\r\n          `\\n{ instance: ${this.instance.name} pairingCode: ${this.instance.qrcode.pairingCode}, qrcodeCount: ${this.instance.qrcode.count} }\\n` +\r\n            qrcode,\r\n        ),\r\n      );\r\n\r\n      await this.prismaRepository.instance.update({\r\n        where: { id: this.instanceId },\r\n        data: {\r\n          connectionStatus: 'connecting',\r\n        },\r\n      });\r\n    }\r\n\r\n    if (connection) {\r\n      this.stateConnection = {\r\n        state: connection,\r\n        statusReason: (lastDisconnect?.error as Boom)?.output?.statusCode ?? 200,\r\n      };\r\n    }\r\n\r\n    if (connection === 'close') {\r\n      const statusCode = (lastDisconnect?.error as Boom)?.output?.statusCode;\r\n      const codesToNotReconnect = [DisconnectReason.loggedOut, DisconnectReason.forbidden, 402, 406];\r\n      const shouldReconnect = !codesToNotReconnect.includes(statusCode);\r\n      if (shouldReconnect) {\r\n        await this.connectToWhatsapp(this.phoneNumber);\r\n      } else {\r\n        this.sendDataWebhook(Events.STATUS_INSTANCE, {\r\n          instance: this.instance.name,\r\n          status: 'closed',\r\n          disconnectionAt: new Date(),\r\n          disconnectionReasonCode: statusCode,\r\n          disconnectionObject: JSON.stringify(lastDisconnect),\r\n        });\r\n\r\n        await this.prismaRepository.instance.update({\r\n          where: { id: this.instanceId },\r\n          data: {\r\n            connectionStatus: 'close',\r\n            disconnectionAt: new Date(),\r\n            disconnectionReasonCode: statusCode,\r\n            disconnectionObject: JSON.stringify(lastDisconnect),\r\n          },\r\n        });\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n          this.chatwootService.eventWhatsapp(\r\n            Events.STATUS_INSTANCE,\r\n            { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            {\r\n              instance: this.instance.name,\r\n              status: 'closed',\r\n            },\r\n          );\r\n        }\r\n\r\n        this.eventEmitter.emit('logout.instance', this.instance.name, 'inner');\r\n        this.client?.ws?.close();\r\n        this.client.end(new Error('Close connection'));\r\n\r\n        this.sendDataWebhook(Events.CONNECTION_UPDATE, {\r\n          instance: this.instance.name,\r\n          ...this.stateConnection,\r\n        });\r\n      }\r\n    }\r\n\r\n    if (connection === 'open') {\r\n      this.instance.wuid = this.client.user.id.replace(/:\\d+/, '');\r\n      try {\r\n        const profilePic = await this.profilePicture(this.instance.wuid);\r\n        this.instance.profilePictureUrl = profilePic.profilePictureUrl;\r\n      } catch (error) {\r\n        this.instance.profilePictureUrl = null;\r\n      }\r\n      const formattedWuid = this.instance.wuid.split('@')[0].padEnd(30, ' ');\r\n      const formattedName = this.instance.name;\r\n      this.logger.info(\r\n        `\r\n        \r\n            CONNECTED TO WHATSAPP     \r\n        `.replace(/^ +/gm, '  '),\r\n      );\r\n      this.logger.info(\r\n        `\r\n        wuid: ${formattedWuid}\r\n        name: ${formattedName}\r\n      `,\r\n      );\r\n\r\n      await this.prismaRepository.instance.update({\r\n        where: { id: this.instanceId },\r\n        data: {\r\n          ownerJid: this.instance.wuid,\r\n          profileName: (await this.getProfileName()) as string,\r\n          profilePicUrl: this.instance.profilePictureUrl,\r\n          connectionStatus: 'open',\r\n        },\r\n      });\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n        this.chatwootService.eventWhatsapp(\r\n          Events.CONNECTION_UPDATE,\r\n          { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          {\r\n            instance: this.instance.name,\r\n            status: 'open',\r\n          },\r\n        );\r\n        this.syncChatwootLostMessages();\r\n      }\r\n\r\n      this.sendDataWebhook(Events.CONNECTION_UPDATE, {\r\n        instance: this.instance.name,\r\n        wuid: this.instance.wuid,\r\n        profileName: await this.getProfileName(),\r\n        profilePictureUrl: this.instance.profilePictureUrl,\r\n        ...this.stateConnection,\r\n      });\r\n    }\r\n\r\n    if (connection === 'connecting') {\r\n      this.sendDataWebhook(Events.CONNECTION_UPDATE, {\r\n        instance: this.instance.name,\r\n        ...this.stateConnection,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async getMessage(key: proto.IMessageKey, full = false) {\r\n    try {\r\n      const webMessageInfo = (await this.prismaRepository.message.findMany({\r\n        where: {\r\n          instanceId: this.instanceId,\r\n          key: {\r\n            path: ['id'],\r\n            equals: key.id,\r\n          },\r\n        },\r\n      })) as unknown as proto.IWebMessageInfo[];\r\n      if (full) {\r\n        return webMessageInfo[0];\r\n      }\r\n      if (webMessageInfo[0].message?.pollCreationMessage) {\r\n        const messageSecretBase64 = webMessageInfo[0].message?.messageContextInfo?.messageSecret;\r\n\r\n        if (typeof messageSecretBase64 === 'string') {\r\n          const messageSecret = Buffer.from(messageSecretBase64, 'base64');\r\n\r\n          const msg = {\r\n            messageContextInfo: {\r\n              messageSecret,\r\n            },\r\n            pollCreationMessage: webMessageInfo[0].message?.pollCreationMessage,\r\n          };\r\n\r\n          return msg;\r\n        }\r\n      }\r\n\r\n      return webMessageInfo[0].message;\r\n    } catch (error) {\r\n      return { conversation: '' };\r\n    }\r\n  }\r\n\r\n  private async defineAuthState() {\r\n    const db = this.configService.get<Database>('DATABASE');\r\n    const cache = this.configService.get<CacheConf>('CACHE');\r\n\r\n    const provider = this.configService.get<ProviderSession>('PROVIDER');\r\n\r\n    if (provider?.ENABLED) {\r\n      return await this.authStateProvider.authStateProvider(this.instance.id);\r\n    }\r\n\r\n    if (cache?.REDIS.ENABLED && cache?.REDIS.SAVE_INSTANCES) {\r\n      this.logger.info('Redis enabled');\r\n      return await useMultiFileAuthStateRedisDb(this.instance.id, this.cache);\r\n    }\r\n\r\n    if (db.SAVE_DATA.INSTANCE) {\r\n      return await useMultiFileAuthStatePrisma(this.instance.id, this.cache);\r\n    }\r\n  }\r\n\r\n  private async createClient(number?: string): Promise<WASocket> {\r\n    this.instance.authState = await this.defineAuthState();\r\n\r\n    const session = this.configService.get<ConfigSessionPhone>('CONFIG_SESSION_PHONE');\r\n\r\n    let browserOptions = {};\r\n\r\n    if (number || this.phoneNumber) {\r\n      this.phoneNumber = number;\r\n\r\n      this.logger.info(`Phone number: ${number}`);\r\n    } else {\r\n      const browser: WABrowserDescription = [session.CLIENT, session.NAME, release()];\r\n      browserOptions = { browser };\r\n\r\n      this.logger.info(`Browser: ${browser}`);\r\n    }\r\n\r\n    let version;\r\n    let log;\r\n\r\n    if (session.VERSION) {\r\n      version = session.VERSION.split('.');\r\n      log = `Baileys version env: ${version}`;\r\n    } else {\r\n      const baileysVersion = await fetchLatestBaileysVersion();\r\n      version = baileysVersion.version;\r\n      log = `Baileys version: ${version}`;\r\n    }\r\n\r\n    this.logger.info(log);\r\n\r\n    this.logger.info(`Group Ignore: ${this.localSettings.groupsIgnore}`);\r\n\r\n    let options;\r\n\r\n    if (this.localProxy?.enabled) {\r\n      this.logger.info('Proxy enabled: ' + this.localProxy?.host);\r\n\r\n      if (this.localProxy?.host?.includes('proxyscrape')) {\r\n        try {\r\n          const response = await axios.get(this.localProxy?.host);\r\n          const text = response.data;\r\n          const proxyUrls = text.split('\\r\\n');\r\n          const rand = Math.floor(Math.random() * Math.floor(proxyUrls.length));\r\n          const proxyUrl = 'http://' + proxyUrls[rand];\r\n          options = {\r\n            agent: makeProxyAgent(proxyUrl),\r\n            fetchAgent: makeProxyAgent(proxyUrl),\r\n          };\r\n        } catch (error) {\r\n          this.localProxy.enabled = false;\r\n        }\r\n      } else {\r\n        options = {\r\n          agent: makeProxyAgent({\r\n            host: this.localProxy.host,\r\n            port: this.localProxy.port,\r\n            protocol: this.localProxy.protocol,\r\n            username: this.localProxy.username,\r\n            password: this.localProxy.password,\r\n          }),\r\n          fetchAgent: makeProxyAgent({\r\n            host: this.localProxy.host,\r\n            port: this.localProxy.port,\r\n            protocol: this.localProxy.protocol,\r\n            username: this.localProxy.username,\r\n            password: this.localProxy.password,\r\n          }),\r\n        };\r\n      }\r\n    }\r\n\r\n    const socketConfig: UserFacingSocketConfig = {\r\n      ...options,\r\n      version,\r\n      logger: P({ level: this.logBaileys }),\r\n      printQRInTerminal: false,\r\n      auth: {\r\n        creds: this.instance.authState.state.creds,\r\n        keys: makeCacheableSignalKeyStore(this.instance.authState.state.keys, P({ level: 'error' }) as any),\r\n      },\r\n      msgRetryCounterCache: this.msgRetryCounterCache,\r\n      generateHighQualityLinkPreview: true,\r\n      getMessage: async (key) => (await this.getMessage(key)) as Promise<proto.IMessage>,\r\n      ...browserOptions,\r\n      markOnlineOnConnect: this.localSettings.alwaysOnline,\r\n      retryRequestDelayMs: 350,\r\n      maxMsgRetryCount: 4,\r\n      fireInitQueries: true,\r\n      connectTimeoutMs: 30_000,\r\n      keepAliveIntervalMs: 30_000,\r\n      qrTimeout: 45_000,\r\n      emitOwnEvents: false,\r\n      shouldIgnoreJid: (jid) => {\r\n        const isGroupJid = this.localSettings.groupsIgnore && isJidGroup(jid);\r\n        const isBroadcast = !this.localSettings.readStatus && isJidBroadcast(jid);\r\n        const isNewsletter = isJidNewsletter(jid);\r\n\r\n        return isGroupJid || isBroadcast || isNewsletter;\r\n      },\r\n      syncFullHistory: this.localSettings.syncFullHistory,\r\n      shouldSyncHistoryMessage: (msg: proto.Message.IHistorySyncNotification) => {\r\n        return this.historySyncNotification(msg);\r\n      },\r\n      cachedGroupMetadata: this.getGroupMetadataCache,\r\n      userDevicesCache: this.userDevicesCache,\r\n      transactionOpts: { maxCommitRetries: 10, delayBetweenTriesMs: 3000 },\r\n      patchMessageBeforeSending(message) {\r\n        if (\r\n          message.deviceSentMessage?.message?.listMessage?.listType === proto.Message.ListMessage.ListType.PRODUCT_LIST\r\n        ) {\r\n          message = JSON.parse(JSON.stringify(message));\r\n\r\n          message.deviceSentMessage.message.listMessage.listType = proto.Message.ListMessage.ListType.SINGLE_SELECT;\r\n        }\r\n\r\n        if (message.listMessage?.listType == proto.Message.ListMessage.ListType.PRODUCT_LIST) {\r\n          message = JSON.parse(JSON.stringify(message));\r\n\r\n          message.listMessage.listType = proto.Message.ListMessage.ListType.SINGLE_SELECT;\r\n        }\r\n\r\n        return message;\r\n      },\r\n    };\r\n\r\n    this.endSession = false;\r\n\r\n    this.client = makeWASocket(socketConfig);\r\n\r\n    if (this.localSettings.wavoipToken && this.localSettings.wavoipToken.length > 0) {\r\n      useVoiceCallsBaileys(this.localSettings.wavoipToken, this.client, this.connectionStatus.state as any, true);\r\n    }\r\n\r\n    this.eventHandler();\r\n\r\n    this.client.ws.on('CB:call', (packet) => {\r\n      console.log('CB:call', packet);\r\n      const payload = {\r\n        event: 'CB:call',\r\n        packet: packet,\r\n      };\r\n      this.sendDataWebhook(Events.CALL, payload, true, ['websocket']);\r\n    });\r\n\r\n    this.client.ws.on('CB:ack,class:call', (packet) => {\r\n      console.log('CB:ack,class:call', packet);\r\n      const payload = {\r\n        event: 'CB:ack,class:call',\r\n        packet: packet,\r\n      };\r\n      this.sendDataWebhook(Events.CALL, payload, true, ['websocket']);\r\n    });\r\n\r\n    this.phoneNumber = number;\r\n\r\n    return this.client;\r\n  }\r\n\r\n  public async connectToWhatsapp(number?: string): Promise<WASocket> {\r\n    try {\r\n      this.loadChatwoot();\r\n      this.loadSettings();\r\n      this.loadWebhook();\r\n      this.loadProxy();\r\n\r\n      return await this.createClient(number);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString());\r\n    }\r\n  }\r\n\r\n  public async reloadConnection(): Promise<WASocket> {\r\n    try {\r\n      return await this.createClient(this.phoneNumber);\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString());\r\n    }\r\n  }\r\n\r\n  private readonly chatHandle = {\r\n    'chats.upsert': async (chats: Chat[]) => {\r\n      const existingChatIds = await this.prismaRepository.chat.findMany({\r\n        where: { instanceId: this.instanceId },\r\n        select: { remoteJid: true },\r\n      });\r\n\r\n      const existingChatIdSet = new Set(existingChatIds.map((chat) => chat.remoteJid));\r\n\r\n      const chatsToInsert = chats\r\n        .filter((chat) => !existingChatIdSet?.has(chat.id))\r\n        .map((chat) => ({\r\n          remoteJid: chat.id,\r\n          instanceId: this.instanceId,\r\n          name: chat.name,\r\n          unreadMessages: chat.unreadCount !== undefined ? chat.unreadCount : 0,\r\n        }));\r\n\r\n      this.sendDataWebhook(Events.CHATS_UPSERT, chatsToInsert);\r\n\r\n      if (chatsToInsert.length > 0) {\r\n        if (this.configService.get<Database>('DATABASE').SAVE_DATA.CHATS)\r\n          await this.prismaRepository.chat.createMany({\r\n            data: chatsToInsert,\r\n            skipDuplicates: true,\r\n          });\r\n      }\r\n    },\r\n\r\n    'chats.update': async (\r\n      chats: Partial<\r\n        proto.IConversation & {\r\n          lastMessageRecvTimestamp?: number;\r\n        } & {\r\n          conditional: (bufferedData: BufferedEventData) => boolean;\r\n        }\r\n      >[],\r\n    ) => {\r\n      const chatsRaw = chats.map((chat) => {\r\n        return { remoteJid: chat.id, instanceId: this.instanceId };\r\n      });\r\n\r\n      this.sendDataWebhook(Events.CHATS_UPDATE, chatsRaw);\r\n\r\n      for (const chat of chats) {\r\n        await this.prismaRepository.chat.updateMany({\r\n          where: {\r\n            instanceId: this.instanceId,\r\n            remoteJid: chat.id,\r\n            name: chat.name,\r\n          },\r\n          data: { remoteJid: chat.id },\r\n        });\r\n      }\r\n    },\r\n\r\n    'chats.delete': async (chats: string[]) => {\r\n      chats.forEach(\r\n        async (chat) =>\r\n          await this.prismaRepository.chat.deleteMany({\r\n            where: { instanceId: this.instanceId, remoteJid: chat },\r\n          }),\r\n      );\r\n\r\n      this.sendDataWebhook(Events.CHATS_DELETE, [...chats]);\r\n    },\r\n  };\r\n\r\n  private readonly contactHandle = {\r\n    'contacts.upsert': async (contacts: Contact[]) => {\r\n      try {\r\n        const contactsRaw: any = contacts.map((contact) => ({\r\n          remoteJid: contact.id,\r\n          pushName: contact?.name || contact?.verifiedName || contact.id.split('@')[0],\r\n          profilePicUrl: null,\r\n          instanceId: this.instanceId,\r\n        }));\r\n\r\n        if (contactsRaw.length > 0) {\r\n          this.sendDataWebhook(Events.CONTACTS_UPSERT, contactsRaw);\r\n\r\n          if (this.configService.get<Database>('DATABASE').SAVE_DATA.CONTACTS)\r\n            await this.prismaRepository.contact.createMany({\r\n              data: contactsRaw,\r\n              skipDuplicates: true,\r\n            });\r\n\r\n          const usersContacts = contactsRaw.filter((c) => c.remoteJid.includes('@s.whatsapp'));\r\n          if (usersContacts) {\r\n            await saveOnWhatsappCache(usersContacts.map((c) => ({ remoteJid: c.remoteJid })));\r\n          }\r\n        }\r\n\r\n        if (\r\n          this.configService.get<Chatwoot>('CHATWOOT').ENABLED &&\r\n          this.localChatwoot?.enabled &&\r\n          this.localChatwoot.importContacts &&\r\n          contactsRaw.length\r\n        ) {\r\n          this.chatwootService.addHistoryContacts(\r\n            { instanceName: this.instance.name, instanceId: this.instance.id },\r\n            contactsRaw,\r\n          );\r\n          chatwootImport.importHistoryContacts(\r\n            { instanceName: this.instance.name, instanceId: this.instance.id },\r\n            this.localChatwoot,\r\n          );\r\n        }\r\n\r\n        const updatedContacts = await Promise.all(\r\n          contacts.map(async (contact) => ({\r\n            remoteJid: contact.id,\r\n            pushName: contact?.name || contact?.verifiedName || contact.id.split('@')[0],\r\n            profilePicUrl: (await this.profilePicture(contact.id)).profilePictureUrl,\r\n            instanceId: this.instanceId,\r\n          })),\r\n        );\r\n\r\n        if (updatedContacts.length > 0) {\r\n          const usersContacts = updatedContacts.filter((c) => c.remoteJid.includes('@s.whatsapp'));\r\n          if (usersContacts) {\r\n            await saveOnWhatsappCache(usersContacts.map((c) => ({ remoteJid: c.remoteJid })));\r\n          }\r\n\r\n          this.sendDataWebhook(Events.CONTACTS_UPDATE, updatedContacts);\r\n          await Promise.all(\r\n            updatedContacts.map(async (contact) => {\r\n              const update = this.prismaRepository.contact.updateMany({\r\n                where: { remoteJid: contact.remoteJid, instanceId: this.instanceId },\r\n                data: {\r\n                  profilePicUrl: contact.profilePicUrl,\r\n                },\r\n              });\r\n\r\n              if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n                const instance = { instanceName: this.instance.name, instanceId: this.instance.id };\r\n\r\n                const findParticipant = await this.chatwootService.findContact(\r\n                  instance,\r\n                  contact.remoteJid.split('@')[0],\r\n                );\r\n\r\n                if (!findParticipant) {\r\n                  return;\r\n                }\r\n\r\n                this.chatwootService.updateContact(instance, findParticipant.id, {\r\n                  name: contact.pushName,\r\n                  avatar_url: contact.profilePicUrl,\r\n                });\r\n              }\r\n\r\n              return update;\r\n            }),\r\n          );\r\n        }\r\n      } catch (error) {\r\n        console.error(error);\r\n        this.logger.error(`Error: ${error.message}`);\r\n      }\r\n    },\r\n\r\n    'contacts.update': async (contacts: Partial<Contact>[]) => {\r\n      const contactsRaw: {\r\n        remoteJid: string;\r\n        pushName?: string;\r\n        profilePicUrl?: string;\r\n        instanceId: string;\r\n      }[] = [];\r\n      for await (const contact of contacts) {\r\n        contactsRaw.push({\r\n          remoteJid: contact.id,\r\n          pushName: contact?.name ?? contact?.verifiedName,\r\n          profilePicUrl: (await this.profilePicture(contact.id)).profilePictureUrl,\r\n          instanceId: this.instanceId,\r\n        });\r\n      }\r\n\r\n      this.sendDataWebhook(Events.CONTACTS_UPDATE, contactsRaw);\r\n\r\n      const updateTransactions = contactsRaw.map((contact) =>\r\n        this.prismaRepository.contact.upsert({\r\n          where: { remoteJid_instanceId: { remoteJid: contact.remoteJid, instanceId: contact.instanceId } },\r\n          create: contact,\r\n          update: contact,\r\n        }),\r\n      );\r\n      await this.prismaRepository.$transaction(updateTransactions);\r\n\r\n      const usersContacts = contactsRaw.filter((c) => c.remoteJid.includes('@s.whatsapp'));\r\n      if (usersContacts) {\r\n        await saveOnWhatsappCache(usersContacts.map((c) => ({ remoteJid: c.remoteJid })));\r\n      }\r\n    },\r\n  };\r\n\r\n  private readonly messageHandle = {\r\n    'messaging-history.set': async ({\r\n      messages,\r\n      chats,\r\n      contacts,\r\n      isLatest,\r\n      progress,\r\n      syncType,\r\n    }: {\r\n      chats: Chat[];\r\n      contacts: Contact[];\r\n      messages: proto.IWebMessageInfo[];\r\n      isLatest?: boolean;\r\n      progress?: number;\r\n      syncType?: proto.HistorySync.HistorySyncType;\r\n    }) => {\r\n      try {\r\n        if (syncType === proto.HistorySync.HistorySyncType.ON_DEMAND) {\r\n          console.log('received on-demand history sync, messages=', messages);\r\n        }\r\n        console.log(\r\n          `recv ${chats.length} chats, ${contacts.length} contacts, ${messages.length} msgs (is latest: ${isLatest}, progress: ${progress}%), type: ${syncType}`,\r\n        );\r\n\r\n        const instance: InstanceDto = { instanceName: this.instance.name };\r\n\r\n        let timestampLimitToImport = null;\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n          const daysLimitToImport = this.localChatwoot?.enabled ? this.localChatwoot.daysLimitImportMessages : 1000;\r\n\r\n          const date = new Date();\r\n          timestampLimitToImport = new Date(date.setDate(date.getDate() - daysLimitToImport)).getTime() / 1000;\r\n\r\n          const maxBatchTimestamp = Math.max(...messages.map((message) => message.messageTimestamp as number));\r\n\r\n          const processBatch = maxBatchTimestamp >= timestampLimitToImport;\r\n\r\n          if (!processBatch) {\r\n            return;\r\n          }\r\n        }\r\n\r\n        const chatsRaw: { remoteJid: string; instanceId: string; name?: string }[] = [];\r\n        const chatsRepository = new Set(\r\n          (\r\n            await this.prismaRepository.chat.findMany({\r\n              where: { instanceId: this.instanceId },\r\n            })\r\n          ).map((chat) => chat.remoteJid),\r\n        );\r\n\r\n        for (const chat of chats) {\r\n          if (chatsRepository?.has(chat.id)) {\r\n            continue;\r\n          }\r\n\r\n          chatsRaw.push({\r\n            remoteJid: chat.id,\r\n            instanceId: this.instanceId,\r\n            name: chat.name,\r\n          });\r\n        }\r\n\r\n        this.sendDataWebhook(Events.CHATS_SET, chatsRaw);\r\n\r\n        if (this.configService.get<Database>('DATABASE').SAVE_DATA.HISTORIC) {\r\n          await this.prismaRepository.chat.createMany({\r\n            data: chatsRaw,\r\n            skipDuplicates: true,\r\n          });\r\n        }\r\n\r\n        const messagesRaw: any[] = [];\r\n\r\n        const messagesRepository: Set<string> = new Set(\r\n          chatwootImport.getRepositoryMessagesCache(instance) ??\r\n            (\r\n              await this.prismaRepository.message.findMany({\r\n                select: { key: true },\r\n                where: { instanceId: this.instanceId },\r\n              })\r\n            ).map((message) => {\r\n              const key = message.key as {\r\n                id: string;\r\n              };\r\n\r\n              return key.id;\r\n            }),\r\n        );\r\n\r\n        if (chatwootImport.getRepositoryMessagesCache(instance) === null) {\r\n          chatwootImport.setRepositoryMessagesCache(instance, messagesRepository);\r\n        }\r\n\r\n        for (const m of messages) {\r\n          if (!m.message || !m.key || !m.messageTimestamp) {\r\n            continue;\r\n          }\r\n\r\n          if (Long.isLong(m?.messageTimestamp)) {\r\n            m.messageTimestamp = m.messageTimestamp?.toNumber();\r\n          }\r\n\r\n          if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n            if (m.messageTimestamp <= timestampLimitToImport) {\r\n              continue;\r\n            }\r\n          }\r\n\r\n          if (messagesRepository?.has(m.key.id)) {\r\n            continue;\r\n          }\r\n\r\n          messagesRaw.push(this.prepareMessage(m));\r\n        }\r\n\r\n        this.sendDataWebhook(Events.MESSAGES_SET, [...messagesRaw]);\r\n\r\n        if (this.configService.get<Database>('DATABASE').SAVE_DATA.HISTORIC) {\r\n          await this.prismaRepository.message.createMany({\r\n            data: messagesRaw,\r\n            skipDuplicates: true,\r\n          });\r\n        }\r\n\r\n        if (\r\n          this.configService.get<Chatwoot>('CHATWOOT').ENABLED &&\r\n          this.localChatwoot?.enabled &&\r\n          this.localChatwoot.importMessages &&\r\n          messagesRaw.length > 0\r\n        ) {\r\n          this.chatwootService.addHistoryMessages(\r\n            instance,\r\n            messagesRaw.filter((msg) => !chatwootImport.isIgnorePhoneNumber(msg.key?.remoteJid)),\r\n          );\r\n        }\r\n\r\n        await this.contactHandle['contacts.upsert'](\r\n          contacts\r\n            .filter((c) => !!c.notify || !!c.name)\r\n            .map((c) => ({\r\n              id: c.id,\r\n              name: c.name ?? c.notify,\r\n            })),\r\n        );\r\n\r\n        contacts = undefined;\r\n        messages = undefined;\r\n        chats = undefined;\r\n      } catch (error) {\r\n        this.logger.error(error);\r\n      }\r\n    },\r\n\r\n    'messages.upsert': async (\r\n      {\r\n        messages,\r\n        type,\r\n        requestId,\r\n      }: {\r\n        messages: proto.IWebMessageInfo[];\r\n        type: MessageUpsertType;\r\n        requestId?: string;\r\n      },\r\n      settings: any,\r\n    ) => {\r\n      try {\r\n        for (const received of messages) {\r\n          if (received.message?.conversation || received.message?.extendedTextMessage?.text) {\r\n            const text = received.message?.conversation || received.message?.extendedTextMessage?.text;\r\n\r\n            if (text == 'requestPlaceholder' && !requestId) {\r\n              const messageId = await this.client.requestPlaceholderResend(received.key);\r\n\r\n              console.log('requested placeholder resync, id=', messageId);\r\n            } else if (requestId) {\r\n              console.log('Message received from phone, id=', requestId, received);\r\n            }\r\n\r\n            if (text == 'onDemandHistSync') {\r\n              const messageId = await this.client.fetchMessageHistory(50, received.key, received.messageTimestamp!);\r\n              console.log('requested on-demand sync, id=', messageId);\r\n            }\r\n          }\r\n\r\n          if (received.message?.protocolMessage?.editedMessage || received.message?.editedMessage?.message) {\r\n            const editedMessage =\r\n              received.message?.protocolMessage || received.message?.editedMessage?.message?.protocolMessage;\r\n            if (editedMessage) {\r\n              if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled)\r\n                this.chatwootService.eventWhatsapp(\r\n                  'messages.edit',\r\n                  { instanceName: this.instance.name, instanceId: this.instance.id },\r\n                  editedMessage,\r\n                );\r\n\r\n              await this.sendDataWebhook(Events.MESSAGES_EDITED, editedMessage);\r\n            }\r\n          }\r\n\r\n          if (received.messageStubParameters && received.messageStubParameters[0] === 'Message absent from node') {\r\n            this.logger.info(`Recovering message lost messageId: ${received.key.id}`);\r\n\r\n            await this.baileysCache.set(received.key.id, {\r\n              message: received,\r\n              retry: 0,\r\n            });\r\n\r\n            continue;\r\n          }\r\n\r\n          const retryCache = (await this.baileysCache.get(received.key.id)) || null;\r\n\r\n          if (retryCache) {\r\n            this.logger.info('Recovered message lost');\r\n            await this.baileysCache.delete(received.key.id);\r\n          }\r\n\r\n          if (\r\n            (type !== 'notify' && type !== 'append') ||\r\n            received.message?.protocolMessage ||\r\n            received.message?.pollUpdateMessage ||\r\n            !received?.message\r\n          ) {\r\n            continue;\r\n          }\r\n\r\n          if (Long.isLong(received.messageTimestamp)) {\r\n            received.messageTimestamp = received.messageTimestamp?.toNumber();\r\n          }\r\n\r\n          if (settings?.groupsIgnore && received.key.remoteJid.includes('@g.us')) {\r\n            continue;\r\n          }\r\n          const existingChat = await this.prismaRepository.chat.findFirst({\r\n            where: { instanceId: this.instanceId, remoteJid: received.key.remoteJid },\r\n            select: { id: true, name: true },\r\n          });\r\n\r\n          if (\r\n            existingChat &&\r\n            received.pushName &&\r\n            existingChat.name !== received.pushName &&\r\n            received.pushName.trim().length > 0\r\n          ) {\r\n            this.sendDataWebhook(Events.CHATS_UPSERT, [{ ...existingChat, name: received.pushName }]);\r\n            if (this.configService.get<Database>('DATABASE').SAVE_DATA.CHATS) {\r\n              try {\r\n                await this.prismaRepository.chat.update({\r\n                  where: { id: existingChat.id },\r\n                  data: { name: received.pushName },\r\n                });\r\n              } catch (error) {\r\n                console.log(`Chat insert record ignored: ${received.key.remoteJid} - ${this.instanceId}`);\r\n              }\r\n            }\r\n          }\r\n\r\n          const messageRaw = this.prepareMessage(received);\r\n\r\n          const isMedia =\r\n            received?.message?.imageMessage ||\r\n            received?.message?.videoMessage ||\r\n            received?.message?.stickerMessage ||\r\n            received?.message?.documentMessage ||\r\n            received?.message?.documentWithCaptionMessage ||\r\n            received?.message?.ptvMessage ||\r\n            received?.message?.audioMessage;\r\n\r\n          if (this.localSettings.readMessages && received.key.id !== 'status@broadcast') {\r\n            await this.client.readMessages([received.key]);\r\n          }\r\n\r\n          if (this.localSettings.readStatus && received.key.id === 'status@broadcast') {\r\n            await this.client.readMessages([received.key]);\r\n          }\r\n\r\n          if (\r\n            this.configService.get<Chatwoot>('CHATWOOT').ENABLED &&\r\n            this.localChatwoot?.enabled &&\r\n            !received.key.id.includes('@broadcast')\r\n          ) {\r\n            const chatwootSentMessage = await this.chatwootService.eventWhatsapp(\r\n              Events.MESSAGES_UPSERT,\r\n              { instanceName: this.instance.name, instanceId: this.instance.id },\r\n              messageRaw,\r\n            );\r\n\r\n            if (chatwootSentMessage?.id) {\r\n              messageRaw.chatwootMessageId = chatwootSentMessage.id;\r\n              messageRaw.chatwootInboxId = chatwootSentMessage.inbox_id;\r\n              messageRaw.chatwootConversationId = chatwootSentMessage.conversation_id;\r\n            }\r\n          }\r\n\r\n          if (this.configService.get<Openai>('OPENAI').ENABLED && received?.message?.audioMessage) {\r\n            const openAiDefaultSettings = await this.prismaRepository.openaiSetting.findFirst({\r\n              where: {\r\n                instanceId: this.instanceId,\r\n              },\r\n              include: {\r\n                OpenaiCreds: true,\r\n              },\r\n            });\r\n\r\n            if (openAiDefaultSettings && openAiDefaultSettings.openaiCredsId && openAiDefaultSettings.speechToText) {\r\n              messageRaw.message.speechToText = await this.openaiService.speechToText(\r\n                openAiDefaultSettings.OpenaiCreds,\r\n                received,\r\n                this.client.updateMediaMessage,\r\n              );\r\n            }\r\n          }\r\n\r\n          if (this.configService.get<Database>('DATABASE').SAVE_DATA.NEW_MESSAGE) {\r\n            const msg = await this.prismaRepository.message.create({\r\n              data: messageRaw,\r\n            });\r\n\r\n            if (received.key.fromMe === false) {\r\n              if (msg.status === status[3]) {\r\n                this.logger.log(`Update not read messages ${received.key.remoteJid}`);\r\n\r\n                await this.updateChatUnreadMessages(received.key.remoteJid);\r\n              } else if (msg.status === status[4]) {\r\n                this.logger.log(`Update readed messages ${received.key.remoteJid} - ${msg.messageTimestamp}`);\r\n\r\n                await this.updateMessagesReadedByTimestamp(received.key.remoteJid, msg.messageTimestamp);\r\n              }\r\n            } else {\r\n              // is send message by me\r\n              this.logger.log(`Update readed messages ${received.key.remoteJid} - ${msg.messageTimestamp}`);\r\n\r\n              await this.updateMessagesReadedByTimestamp(received.key.remoteJid, msg.messageTimestamp);\r\n            }\r\n\r\n            if (isMedia) {\r\n              if (this.configService.get<S3>('S3').ENABLE) {\r\n                try {\r\n                  const message: any = received;\r\n                  const media = await this.getBase64FromMediaMessage(\r\n                    {\r\n                      message,\r\n                    },\r\n                    true,\r\n                  );\r\n\r\n                  const { buffer, mediaType, fileName, size } = media;\r\n                  const mimetype = mimeTypes.lookup(fileName).toString();\r\n                  const fullName = join(`${this.instance.id}`, received.key.remoteJid, mediaType, fileName);\r\n                  await s3Service.uploadFile(fullName, buffer, size.fileLength?.low, {\r\n                    'Content-Type': mimetype,\r\n                  });\r\n\r\n                  await this.prismaRepository.media.create({\r\n                    data: {\r\n                      messageId: msg.id,\r\n                      instanceId: this.instanceId,\r\n                      type: mediaType,\r\n                      fileName: fullName,\r\n                      mimetype,\r\n                    },\r\n                  });\r\n\r\n                  const mediaUrl = await s3Service.getObjectUrl(fullName);\r\n\r\n                  messageRaw.message.mediaUrl = mediaUrl;\r\n\r\n                  await this.prismaRepository.message.update({\r\n                    where: { id: msg.id },\r\n                    data: messageRaw,\r\n                  });\r\n                } catch (error) {\r\n                  this.logger.error(['Error on upload file to minio', error?.message, error?.stack]);\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          if (this.localWebhook.enabled) {\r\n            if (isMedia && this.localWebhook.webhookBase64) {\r\n              try {\r\n                const buffer = await downloadMediaMessage(\r\n                  { key: received.key, message: received?.message },\r\n                  'buffer',\r\n                  {},\r\n                  {\r\n                    logger: P({ level: 'error' }) as any,\r\n                    reuploadRequest: this.client.updateMediaMessage,\r\n                  },\r\n                );\r\n\r\n                messageRaw.message.base64 = buffer ? buffer.toString('base64') : undefined;\r\n              } catch (error) {\r\n                this.logger.error(['Error converting media to base64', error?.message]);\r\n              }\r\n            }\r\n          }\r\n\r\n          this.logger.log(messageRaw);\r\n\r\n          this.sendDataWebhook(Events.MESSAGES_UPSERT, messageRaw);\r\n\r\n          await chatbotController.emit({\r\n            instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n            remoteJid: messageRaw.key.remoteJid,\r\n            msg: messageRaw,\r\n            pushName: messageRaw.pushName,\r\n          });\r\n\r\n          const contact = await this.prismaRepository.contact.findFirst({\r\n            where: { remoteJid: received.key.remoteJid, instanceId: this.instanceId },\r\n          });\r\n\r\n          const contactRaw: { remoteJid: string; pushName: string; profilePicUrl?: string; instanceId: string } = {\r\n            remoteJid: received.key.remoteJid,\r\n            pushName: received.key.fromMe ? '' : received.key.fromMe == null ? '' : received.pushName,\r\n            profilePicUrl: (await this.profilePicture(received.key.remoteJid)).profilePictureUrl,\r\n            instanceId: this.instanceId,\r\n          };\r\n\r\n          if (contactRaw.remoteJid === 'status@broadcast') {\r\n            continue;\r\n          }\r\n\r\n          if (contact) {\r\n            this.sendDataWebhook(Events.CONTACTS_UPDATE, contactRaw);\r\n\r\n            if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n              await this.chatwootService.eventWhatsapp(\r\n                Events.CONTACTS_UPDATE,\r\n                { instanceName: this.instance.name, instanceId: this.instanceId },\r\n                contactRaw,\r\n              );\r\n            }\r\n\r\n            if (this.configService.get<Database>('DATABASE').SAVE_DATA.CONTACTS)\r\n              await this.prismaRepository.contact.upsert({\r\n                where: { remoteJid_instanceId: { remoteJid: contactRaw.remoteJid, instanceId: contactRaw.instanceId } },\r\n                create: contactRaw,\r\n                update: contactRaw,\r\n              });\r\n\r\n            continue;\r\n          }\r\n\r\n          this.sendDataWebhook(Events.CONTACTS_UPSERT, contactRaw);\r\n\r\n          if (this.configService.get<Database>('DATABASE').SAVE_DATA.CONTACTS)\r\n            await this.prismaRepository.contact.upsert({\r\n              where: {\r\n                remoteJid_instanceId: {\r\n                  remoteJid: contactRaw.remoteJid,\r\n                  instanceId: contactRaw.instanceId,\r\n                },\r\n              },\r\n              update: contactRaw,\r\n              create: contactRaw,\r\n            });\r\n\r\n          if (contactRaw.remoteJid.includes('@s.whatsapp')) {\r\n            await saveOnWhatsappCache([{ remoteJid: contactRaw.remoteJid }]);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        this.logger.error(error);\r\n      }\r\n    },\r\n\r\n    'messages.update': async (args: WAMessageUpdate[], settings: any) => {\r\n      this.logger.log(`Update messages ${JSON.stringify(args, undefined, 2)}`);\r\n\r\n      const readChatToUpdate: Record<string, true> = {}; // {remoteJid: true}\r\n\r\n      for await (const { key, update } of args) {\r\n        if (settings?.groupsIgnore && key.remoteJid?.includes('@g.us')) {\r\n          continue;\r\n        }\r\n\r\n        if (status[update.status] === 'READ' && key.fromMe) {\r\n          if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n            this.chatwootService.eventWhatsapp(\r\n              'messages.read',\r\n              { instanceName: this.instance.name, instanceId: this.instanceId },\r\n              { key: key },\r\n            );\r\n          }\r\n        }\r\n\r\n        if (key.remoteJid !== 'status@broadcast') {\r\n          let pollUpdates: any;\r\n\r\n          if (update.pollUpdates) {\r\n            const pollCreation = await this.getMessage(key);\r\n\r\n            if (pollCreation) {\r\n              pollUpdates = getAggregateVotesInPollMessage({\r\n                message: pollCreation as proto.IMessage,\r\n                pollUpdates: update.pollUpdates,\r\n              });\r\n            }\r\n          }\r\n\r\n          const findMessage = await this.prismaRepository.message.findFirst({\r\n            where: {\r\n              instanceId: this.instanceId,\r\n              key: {\r\n                path: ['id'],\r\n                equals: key.id,\r\n              },\r\n            },\r\n          });\r\n\r\n          if (!findMessage) {\r\n            continue;\r\n          }\r\n\r\n          if (update.message === null && update.status === undefined) {\r\n            this.sendDataWebhook(Events.MESSAGES_DELETE, key);\r\n\r\n            const message: any = {\r\n              messageId: findMessage.id,\r\n              keyId: key.id,\r\n              remoteJid: key.remoteJid,\r\n              fromMe: key.fromMe,\r\n              participant: key?.remoteJid,\r\n              status: 'DELETED',\r\n              instanceId: this.instanceId,\r\n            };\r\n\r\n            if (this.configService.get<Database>('DATABASE').SAVE_DATA.MESSAGE_UPDATE)\r\n              await this.prismaRepository.messageUpdate.create({\r\n                data: message,\r\n              });\r\n\r\n            if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n              this.chatwootService.eventWhatsapp(\r\n                Events.MESSAGES_DELETE,\r\n                { instanceName: this.instance.name, instanceId: this.instanceId },\r\n                { key: key },\r\n              );\r\n            }\r\n\r\n            continue;\r\n          } else if (update.status !== undefined && status[update.status] !== findMessage.status) {\r\n            if (!key.fromMe && key.remoteJid) {\r\n              readChatToUpdate[key.remoteJid] = true;\r\n\r\n              if (status[update.status] === status[4]) {\r\n                this.logger.log(`Update as read ${key.remoteJid} - ${findMessage.messageTimestamp}`);\r\n                this.updateMessagesReadedByTimestamp(key.remoteJid, findMessage.messageTimestamp);\r\n              }\r\n            }\r\n\r\n            await this.prismaRepository.message.update({\r\n              where: { id: findMessage.id },\r\n              data: { status: status[update.status] },\r\n            });\r\n          }\r\n\r\n          const message: any = {\r\n            messageId: findMessage.id,\r\n            keyId: key.id,\r\n            remoteJid: key.remoteJid,\r\n            fromMe: key.fromMe,\r\n            participant: key?.remoteJid,\r\n            status: status[update.status],\r\n            pollUpdates,\r\n            instanceId: this.instanceId,\r\n          };\r\n\r\n          this.sendDataWebhook(Events.MESSAGES_UPDATE, message);\r\n\r\n          if (this.configService.get<Database>('DATABASE').SAVE_DATA.MESSAGE_UPDATE)\r\n            await this.prismaRepository.messageUpdate.create({\r\n              data: message,\r\n            });\r\n\r\n          const existingChat = await this.prismaRepository.chat.findFirst({\r\n            where: { instanceId: this.instanceId, remoteJid: message.remoteJid },\r\n          });\r\n\r\n          if (existingChat) {\r\n            const chatToInsert = {\r\n              remoteJid: message.remoteJid,\r\n              instanceId: this.instanceId,\r\n              name: message.pushName || '',\r\n              unreadMessages: 0,\r\n            };\r\n\r\n            this.sendDataWebhook(Events.CHATS_UPSERT, [chatToInsert]);\r\n            if (this.configService.get<Database>('DATABASE').SAVE_DATA.CHATS) {\r\n              try {\r\n                await this.prismaRepository.chat.update({\r\n                  where: {\r\n                    id: existingChat.id,\r\n                  },\r\n                  data: chatToInsert,\r\n                });\r\n              } catch (error) {\r\n                console.log(`Chat insert record ignored: ${chatToInsert.remoteJid} - ${chatToInsert.instanceId}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      await Promise.all(Object.keys(readChatToUpdate).map((remoteJid) => this.updateChatUnreadMessages(remoteJid)));\r\n    },\r\n  };\r\n\r\n  private readonly groupHandler = {\r\n    'groups.upsert': (groupMetadata: GroupMetadata[]) => {\r\n      this.sendDataWebhook(Events.GROUPS_UPSERT, groupMetadata);\r\n    },\r\n\r\n    'groups.update': (groupMetadataUpdate: Partial<GroupMetadata>[]) => {\r\n      this.sendDataWebhook(Events.GROUPS_UPDATE, groupMetadataUpdate);\r\n\r\n      groupMetadataUpdate.forEach((group) => {\r\n        if (isJidGroup(group.id)) {\r\n          this.updateGroupMetadataCache(group.id);\r\n        }\r\n      });\r\n    },\r\n\r\n    'group-participants.update': (participantsUpdate: {\r\n      id: string;\r\n      participants: string[];\r\n      action: ParticipantAction;\r\n    }) => {\r\n      this.sendDataWebhook(Events.GROUP_PARTICIPANTS_UPDATE, participantsUpdate);\r\n\r\n      this.updateGroupMetadataCache(participantsUpdate.id);\r\n    },\r\n  };\r\n\r\n  private readonly labelHandle = {\r\n    [Events.LABELS_EDIT]: async (label: Label) => {\r\n      this.sendDataWebhook(Events.LABELS_EDIT, { ...label, instance: this.instance.name });\r\n\r\n      const labelsRepository = await this.prismaRepository.label.findMany({\r\n        where: { instanceId: this.instanceId },\r\n      });\r\n\r\n      const savedLabel = labelsRepository.find((l) => l.labelId === label.id);\r\n      if (label.deleted && savedLabel) {\r\n        await this.prismaRepository.label.delete({\r\n          where: { labelId_instanceId: { instanceId: this.instanceId, labelId: label.id } },\r\n        });\r\n        this.sendDataWebhook(Events.LABELS_EDIT, { ...label, instance: this.instance.name });\r\n        return;\r\n      }\r\n\r\n      const labelName = label.name.replace(/[^\\x20-\\x7E]/g, '');\r\n      if (!savedLabel || savedLabel.color !== `${label.color}` || savedLabel.name !== labelName) {\r\n        if (this.configService.get<Database>('DATABASE').SAVE_DATA.LABELS) {\r\n          const labelData = {\r\n            color: `${label.color}`,\r\n            name: labelName,\r\n            labelId: label.id,\r\n            predefinedId: label.predefinedId,\r\n            instanceId: this.instanceId,\r\n          };\r\n          await this.prismaRepository.label.upsert({\r\n            where: {\r\n              labelId_instanceId: {\r\n                instanceId: labelData.instanceId,\r\n                labelId: labelData.labelId,\r\n              },\r\n            },\r\n            update: labelData,\r\n            create: labelData,\r\n          });\r\n        }\r\n      }\r\n    },\r\n\r\n    [Events.LABELS_ASSOCIATION]: async (\r\n      data: { association: LabelAssociation; type: 'remove' | 'add' },\r\n      database: Database,\r\n    ) => {\r\n      this.logger.info(\r\n        `labels association - ${data?.association?.chatId} (${data.type}-${data?.association?.type}): ${data?.association?.labelId}`,\r\n      );\r\n      if (database.SAVE_DATA.CHATS) {\r\n        const instanceId = this.instanceId;\r\n        const chatId = data.association.chatId;\r\n        const labelId = data.association.labelId;\r\n\r\n        if (data.type === 'add') {\r\n          await this.addLabel(labelId, instanceId, chatId);\r\n        } else if (data.type === 'remove') {\r\n          await this.removeLabel(labelId, instanceId, chatId);\r\n        }\r\n      }\r\n\r\n      this.sendDataWebhook(Events.LABELS_ASSOCIATION, {\r\n        instance: this.instance.name,\r\n        type: data.type,\r\n        chatId: data.association.chatId,\r\n        labelId: data.association.labelId,\r\n      });\r\n    },\r\n  };\r\n\r\n  private eventHandler() {\r\n    this.client.ev.process(async (events) => {\r\n      if (!this.endSession) {\r\n        const database = this.configService.get<Database>('DATABASE');\r\n        const settings = await this.findSettings();\r\n\r\n        if (events.call) {\r\n          const call = events.call[0];\r\n\r\n          if (settings?.rejectCall && call.status == 'offer') {\r\n            this.client.rejectCall(call.id, call.from);\r\n          }\r\n\r\n          if (settings?.msgCall?.trim().length > 0 && call.status == 'offer') {\r\n            const msg = await this.client.sendMessage(call.from, {\r\n              text: settings.msgCall,\r\n            });\r\n\r\n            this.client.ev.emit('messages.upsert', {\r\n              messages: [msg],\r\n              type: 'notify',\r\n            });\r\n          }\r\n\r\n          this.sendDataWebhook(Events.CALL, call);\r\n        }\r\n\r\n        if (events['connection.update']) {\r\n          this.connectionUpdate(events['connection.update']);\r\n        }\r\n\r\n        if (events['creds.update']) {\r\n          this.instance.authState.saveCreds();\r\n        }\r\n\r\n        if (events['messaging-history.set']) {\r\n          const payload = events['messaging-history.set'];\r\n          this.messageHandle['messaging-history.set'](payload);\r\n        }\r\n\r\n        if (events['messages.upsert']) {\r\n          const payload = events['messages.upsert'];\r\n          this.messageHandle['messages.upsert'](payload, settings);\r\n        }\r\n\r\n        if (events['messages.update']) {\r\n          const payload = events['messages.update'];\r\n          this.messageHandle['messages.update'](payload, settings);\r\n        }\r\n\r\n        if (events['message-receipt.update']) {\r\n          const payload = events['message-receipt.update'] as MessageUserReceiptUpdate[];\r\n          const remotesJidMap: Record<string, number> = {};\r\n\r\n          for (const event of payload) {\r\n            if (typeof event.key.remoteJid === 'string' && typeof event.receipt.readTimestamp === 'number') {\r\n              remotesJidMap[event.key.remoteJid] = event.receipt.readTimestamp;\r\n            }\r\n          }\r\n\r\n          await Promise.all(\r\n            Object.keys(remotesJidMap).map(async (remoteJid) =>\r\n              this.updateMessagesReadedByTimestamp(remoteJid, remotesJidMap[remoteJid]),\r\n            ),\r\n          );\r\n        }\r\n\r\n        if (events['presence.update']) {\r\n          const payload = events['presence.update'];\r\n\r\n          if (settings?.groupsIgnore && payload.id.includes('@g.us')) {\r\n            return;\r\n          }\r\n\r\n          this.sendDataWebhook(Events.PRESENCE_UPDATE, payload);\r\n        }\r\n\r\n        if (!settings?.groupsIgnore) {\r\n          if (events['groups.upsert']) {\r\n            const payload = events['groups.upsert'];\r\n            this.groupHandler['groups.upsert'](payload);\r\n          }\r\n\r\n          if (events['groups.update']) {\r\n            const payload = events['groups.update'];\r\n            this.groupHandler['groups.update'](payload);\r\n          }\r\n\r\n          if (events['group-participants.update']) {\r\n            const payload = events['group-participants.update'];\r\n            this.groupHandler['group-participants.update'](payload);\r\n          }\r\n        }\r\n\r\n        if (events['chats.upsert']) {\r\n          const payload = events['chats.upsert'];\r\n          this.chatHandle['chats.upsert'](payload);\r\n        }\r\n\r\n        if (events['chats.update']) {\r\n          const payload = events['chats.update'];\r\n          this.chatHandle['chats.update'](payload);\r\n        }\r\n\r\n        if (events['chats.delete']) {\r\n          const payload = events['chats.delete'];\r\n          this.chatHandle['chats.delete'](payload);\r\n        }\r\n\r\n        if (events['contacts.upsert']) {\r\n          const payload = events['contacts.upsert'];\r\n          this.contactHandle['contacts.upsert'](payload);\r\n        }\r\n\r\n        if (events['contacts.update']) {\r\n          const payload = events['contacts.update'];\r\n          this.contactHandle['contacts.update'](payload);\r\n        }\r\n\r\n        if (events[Events.LABELS_ASSOCIATION]) {\r\n          const payload = events[Events.LABELS_ASSOCIATION];\r\n          this.labelHandle[Events.LABELS_ASSOCIATION](payload, database);\r\n          return;\r\n        }\r\n\r\n        if (events[Events.LABELS_EDIT]) {\r\n          const payload = events[Events.LABELS_EDIT];\r\n          this.labelHandle[Events.LABELS_EDIT](payload);\r\n          return;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private historySyncNotification(msg: proto.Message.IHistorySyncNotification) {\r\n    const instance: InstanceDto = { instanceName: this.instance.name };\r\n\r\n    if (\r\n      this.configService.get<Chatwoot>('CHATWOOT').ENABLED &&\r\n      this.localChatwoot?.enabled &&\r\n      this.localChatwoot.importMessages &&\r\n      this.isSyncNotificationFromUsedSyncType(msg)\r\n    ) {\r\n      if (msg.chunkOrder === 1) {\r\n        this.chatwootService.startImportHistoryMessages(instance);\r\n      }\r\n\r\n      if (msg.progress === 100) {\r\n        setTimeout(() => {\r\n          this.chatwootService.importHistoryMessages(instance);\r\n        }, 10000);\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private isSyncNotificationFromUsedSyncType(msg: proto.Message.IHistorySyncNotification) {\r\n    return (\r\n      (this.localSettings.syncFullHistory && msg?.syncType === 2) ||\r\n      (!this.localSettings.syncFullHistory && msg?.syncType === 3)\r\n    );\r\n  }\r\n\r\n  public async profilePicture(number: string) {\r\n    const jid = createJid(number);\r\n\r\n    try {\r\n      const profilePictureUrl = await this.client.profilePictureUrl(jid, 'image');\r\n\r\n      return {\r\n        wuid: jid,\r\n        profilePictureUrl,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        wuid: jid,\r\n        profilePictureUrl: null,\r\n      };\r\n    }\r\n  }\r\n\r\n  public async getStatus(number: string) {\r\n    const jid = createJid(number);\r\n\r\n    try {\r\n      return {\r\n        wuid: jid,\r\n        status: (await this.client.fetchStatus(jid))[0]?.status,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        wuid: jid,\r\n        status: null,\r\n      };\r\n    }\r\n  }\r\n\r\n  public async fetchProfile(instanceName: string, number?: string) {\r\n    const jid = number ? createJid(number) : this.client?.user?.id;\r\n\r\n    const onWhatsapp = (await this.whatsappNumber({ numbers: [jid] }))?.shift();\r\n\r\n    if (!onWhatsapp.exists) {\r\n      throw new BadRequestException(onWhatsapp);\r\n    }\r\n\r\n    try {\r\n      if (number) {\r\n        const info = (await this.whatsappNumber({ numbers: [jid] }))?.shift();\r\n        const picture = await this.profilePicture(info?.jid);\r\n        const status = await this.getStatus(info?.jid);\r\n        const business = await this.fetchBusinessProfile(info?.jid);\r\n\r\n        return {\r\n          wuid: info?.jid || jid,\r\n          name: info?.name,\r\n          numberExists: info?.exists,\r\n          picture: picture?.profilePictureUrl,\r\n          status: status?.status,\r\n          isBusiness: business.isBusiness,\r\n          email: business?.email,\r\n          description: business?.description,\r\n          website: business?.website?.shift(),\r\n        };\r\n      } else {\r\n        const instanceNames = instanceName ? [instanceName] : null;\r\n        const info: Instance = await waMonitor.instanceInfo(instanceNames);\r\n        const business = await this.fetchBusinessProfile(jid);\r\n\r\n        return {\r\n          wuid: jid,\r\n          name: info?.profileName,\r\n          numberExists: true,\r\n          picture: info?.profilePicUrl,\r\n          status: info?.connectionStatus,\r\n          isBusiness: business.isBusiness,\r\n          email: business?.email,\r\n          description: business?.description,\r\n          website: business?.website?.shift(),\r\n        };\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        wuid: jid,\r\n        name: null,\r\n        picture: null,\r\n        status: null,\r\n        os: null,\r\n        isBusiness: false,\r\n      };\r\n    }\r\n  }\r\n\r\n  public async offerCall({ number, isVideo, callDuration }: OfferCallDto) {\r\n    const jid = createJid(number);\r\n\r\n    try {\r\n      const call = await this.client.offerCall(jid, isVideo);\r\n      setTimeout(() => this.client.terminateCall(call.id, call.to), callDuration * 1000);\r\n\r\n      return call;\r\n    } catch (error) {\r\n      return error;\r\n    }\r\n  }\r\n\r\n  private async sendMessage(\r\n    sender: string,\r\n    message: any,\r\n    mentions: any,\r\n    linkPreview: any,\r\n    quoted: any,\r\n    messageId?: string,\r\n    ephemeralExpiration?: number,\r\n    // participants?: GroupParticipant[],\r\n  ) {\r\n    sender = sender.toLowerCase();\r\n\r\n    const option: any = {\r\n      quoted,\r\n    };\r\n\r\n    if (isJidGroup(sender)) {\r\n      option.useCachedGroupMetadata = true;\r\n      // if (participants)\r\n      //   option.cachedGroupMetadata = async () => {\r\n      //     return { participants: participants as GroupParticipant[] };\r\n      //   };\r\n    }\r\n\r\n    if (ephemeralExpiration) option.ephemeralExpiration = ephemeralExpiration;\r\n\r\n    if (messageId) option.messageId = messageId;\r\n    else option.messageId = '3EB0' + randomBytes(18).toString('hex').toUpperCase();\r\n\r\n    if (message['viewOnceMessage']) {\r\n      const m = generateWAMessageFromContent(sender, message, {\r\n        timestamp: new Date(),\r\n        userJid: this.instance.wuid,\r\n        messageId,\r\n        quoted,\r\n      });\r\n      const id = await this.client.relayMessage(sender, message, { messageId });\r\n      m.key = {\r\n        id: id,\r\n        remoteJid: sender,\r\n        participant: isJidUser(sender) ? sender : undefined,\r\n        fromMe: true,\r\n      };\r\n      for (const [key, value] of Object.entries(m)) {\r\n        if (!value || (isArray(value) && value.length) === 0) {\r\n          delete m[key];\r\n        }\r\n      }\r\n      return m;\r\n    }\r\n\r\n    if (\r\n      !message['audio'] &&\r\n      !message['poll'] &&\r\n      !message['sticker'] &&\r\n      !message['conversation'] &&\r\n      sender !== 'status@broadcast'\r\n    ) {\r\n      if (message['reactionMessage']) {\r\n        return await this.client.sendMessage(\r\n          sender,\r\n          {\r\n            react: {\r\n              text: message['reactionMessage']['text'],\r\n              key: message['reactionMessage']['key'],\r\n            },\r\n          } as unknown as AnyMessageContent,\r\n          option as unknown as MiscMessageGenerationOptions,\r\n        );\r\n      }\r\n    }\r\n\r\n    if (message['conversation']) {\r\n      return await this.client.sendMessage(\r\n        sender,\r\n        {\r\n          text: message['conversation'],\r\n          mentions,\r\n          linkPreview: linkPreview,\r\n        } as unknown as AnyMessageContent,\r\n        option as unknown as MiscMessageGenerationOptions,\r\n      );\r\n    }\r\n\r\n    if (!message['audio'] && !message['poll'] && !message['sticker'] && sender != 'status@broadcast') {\r\n      return await this.client.sendMessage(\r\n        sender,\r\n        {\r\n          forward: {\r\n            key: { remoteJid: this.instance.wuid, fromMe: true },\r\n            message,\r\n          },\r\n          mentions,\r\n        },\r\n        option as unknown as MiscMessageGenerationOptions,\r\n      );\r\n    }\r\n\r\n    if (sender === 'status@broadcast') {\r\n      let jidList;\r\n      if (message['status'].option.allContacts) {\r\n        const contacts = await this.prismaRepository.contact.findMany({\r\n          where: {\r\n            instanceId: this.instanceId,\r\n            remoteJid: {\r\n              not: {\r\n                endsWith: '@g.us',\r\n              },\r\n            },\r\n          },\r\n        });\r\n\r\n        jidList = contacts.map((contact) => contact.remoteJid);\r\n      } else {\r\n        jidList = message['status'].option.statusJidList;\r\n      }\r\n\r\n      const batchSize = 10;\r\n\r\n      const batches = Array.from({ length: Math.ceil(jidList.length / batchSize) }, (_, i) =>\r\n        jidList.slice(i * batchSize, i * batchSize + batchSize),\r\n      );\r\n\r\n      let msgId: string | null = null;\r\n\r\n      let firstMessage: WAMessage;\r\n\r\n      const firstBatch = batches.shift();\r\n\r\n      if (firstBatch) {\r\n        firstMessage = await this.client.sendMessage(\r\n          sender,\r\n          message['status'].content as unknown as AnyMessageContent,\r\n          {\r\n            backgroundColor: message['status'].option.backgroundColor,\r\n            font: message['status'].option.font,\r\n            statusJidList: firstBatch,\r\n          } as unknown as MiscMessageGenerationOptions,\r\n        );\r\n\r\n        msgId = firstMessage.key.id;\r\n      }\r\n\r\n      if (batches.length === 0) return firstMessage;\r\n\r\n      await Promise.allSettled(\r\n        batches.map(async (batch) => {\r\n          const messageSent = await this.client.sendMessage(\r\n            sender,\r\n            message['status'].content as unknown as AnyMessageContent,\r\n            {\r\n              backgroundColor: message['status'].option.backgroundColor,\r\n              font: message['status'].option.font,\r\n              statusJidList: batch,\r\n              messageId: msgId,\r\n            } as unknown as MiscMessageGenerationOptions,\r\n          );\r\n\r\n          return messageSent;\r\n        }),\r\n      );\r\n\r\n      return firstMessage;\r\n    }\r\n\r\n    return await this.client.sendMessage(\r\n      sender,\r\n      message as unknown as AnyMessageContent,\r\n      option as unknown as MiscMessageGenerationOptions,\r\n    );\r\n  }\r\n\r\n  private async sendMessageWithTyping<T = proto.IMessage>(\r\n    number: string,\r\n    message: T,\r\n    options?: Options,\r\n    isIntegration = false,\r\n  ) {\r\n    const isWA = (await this.whatsappNumber({ numbers: [number] }))?.shift();\r\n\r\n    if (!isWA.exists && !isJidGroup(isWA.jid) && !isWA.jid.includes('@broadcast')) {\r\n      throw new BadRequestException(isWA);\r\n    }\r\n\r\n    const sender = isWA.jid.toLowerCase();\r\n\r\n    this.logger.verbose(`Sending message to ${sender}`);\r\n\r\n    try {\r\n      if (options?.delay) {\r\n        this.logger.verbose(`Typing for ${options.delay}ms to ${sender}`);\r\n        if (options.delay > 20000) {\r\n          let remainingDelay = options.delay;\r\n          while (remainingDelay > 20000) {\r\n            await this.client.presenceSubscribe(sender);\r\n\r\n            await this.client.sendPresenceUpdate((options.presence as WAPresence) ?? 'composing', sender);\r\n\r\n            await delay(20000);\r\n\r\n            await this.client.sendPresenceUpdate('paused', sender);\r\n\r\n            remainingDelay -= 20000;\r\n          }\r\n          if (remainingDelay > 0) {\r\n            await this.client.presenceSubscribe(sender);\r\n\r\n            await this.client.sendPresenceUpdate((options.presence as WAPresence) ?? 'composing', sender);\r\n\r\n            await delay(remainingDelay);\r\n\r\n            await this.client.sendPresenceUpdate('paused', sender);\r\n          }\r\n        } else {\r\n          await this.client.presenceSubscribe(sender);\r\n\r\n          await this.client.sendPresenceUpdate((options.presence as WAPresence) ?? 'composing', sender);\r\n\r\n          await delay(options.delay);\r\n\r\n          await this.client.sendPresenceUpdate('paused', sender);\r\n        }\r\n      }\r\n\r\n      const linkPreview = options?.linkPreview != false ? undefined : false;\r\n\r\n      let quoted: WAMessage;\r\n\r\n      if (options?.quoted) {\r\n        const m = options?.quoted;\r\n\r\n        const msg = m?.message ? m : ((await this.getMessage(m.key, true)) as proto.IWebMessageInfo);\r\n\r\n        if (msg) {\r\n          quoted = msg;\r\n        }\r\n      }\r\n\r\n      let messageSent: WAMessage;\r\n\r\n      let mentions: string[];\r\n      if (isJidGroup(sender)) {\r\n        let group;\r\n        try {\r\n          const cache = this.configService.get<CacheConf>('CACHE');\r\n          if (!cache.REDIS.ENABLED && !cache.LOCAL.ENABLED) group = await this.findGroup({ groupJid: sender }, 'inner');\r\n          else group = await this.getGroupMetadataCache(sender);\r\n          // group = await this.findGroup({ groupJid: sender }, 'inner');\r\n        } catch (error) {\r\n          throw new NotFoundException('Group not found');\r\n        }\r\n\r\n        if (!group) {\r\n          throw new NotFoundException('Group not found');\r\n        }\r\n\r\n        if (options?.mentionsEveryOne) {\r\n          mentions = group.participants.map((participant) => participant.id);\r\n        } else if (options?.mentioned?.length) {\r\n          mentions = options.mentioned.map((mention) => {\r\n            const jid = createJid(mention);\r\n            if (isJidGroup(jid)) {\r\n              return null;\r\n            }\r\n            return jid;\r\n          });\r\n        }\r\n\r\n        messageSent = await this.sendMessage(\r\n          sender,\r\n          message,\r\n          mentions,\r\n          linkPreview,\r\n          quoted,\r\n          null,\r\n          group?.ephemeralDuration,\r\n          // group?.participants,\r\n        );\r\n      } else {\r\n        messageSent = await this.sendMessage(sender, message, mentions, linkPreview, quoted);\r\n      }\r\n\r\n      if (Long.isLong(messageSent?.messageTimestamp)) {\r\n        messageSent.messageTimestamp = messageSent.messageTimestamp?.toNumber();\r\n      }\r\n\r\n      const messageRaw = this.prepareMessage(messageSent);\r\n\r\n      const isMedia =\r\n        messageSent?.message?.imageMessage ||\r\n        messageSent?.message?.videoMessage ||\r\n        messageSent?.message?.stickerMessage ||\r\n        messageSent?.message?.ptvMessage ||\r\n        messageSent?.message?.documentMessage ||\r\n        messageSent?.message?.documentWithCaptionMessage ||\r\n        messageSent?.message?.ptvMessage ||\r\n        messageSent?.message?.audioMessage;\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && !isIntegration) {\r\n        this.chatwootService.eventWhatsapp(\r\n          Events.SEND_MESSAGE,\r\n          { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          messageRaw,\r\n        );\r\n      }\r\n\r\n      if (this.configService.get<Openai>('OPENAI').ENABLED && messageRaw?.message?.audioMessage) {\r\n        const openAiDefaultSettings = await this.prismaRepository.openaiSetting.findFirst({\r\n          where: {\r\n            instanceId: this.instanceId,\r\n          },\r\n          include: {\r\n            OpenaiCreds: true,\r\n          },\r\n        });\r\n\r\n        if (openAiDefaultSettings && openAiDefaultSettings.openaiCredsId && openAiDefaultSettings.speechToText) {\r\n          messageRaw.message.speechToText = await this.openaiService.speechToText(\r\n            openAiDefaultSettings.OpenaiCreds,\r\n            messageRaw,\r\n            this.client.updateMediaMessage,\r\n          );\r\n        }\r\n      }\r\n\r\n      if (this.configService.get<Database>('DATABASE').SAVE_DATA.NEW_MESSAGE) {\r\n        const msg = await this.prismaRepository.message.create({\r\n          data: messageRaw,\r\n        });\r\n\r\n        if (isMedia && this.configService.get<S3>('S3').ENABLE) {\r\n          try {\r\n            const message: any = messageRaw;\r\n            const media = await this.getBase64FromMediaMessage(\r\n              {\r\n                message,\r\n              },\r\n              true,\r\n            );\r\n\r\n            const { buffer, mediaType, fileName, size } = media;\r\n\r\n            const mimetype = mimeTypes.lookup(fileName).toString();\r\n\r\n            const fullName = join(\r\n              `${this.instance.id}`,\r\n              messageRaw.key.remoteJid,\r\n              `${messageRaw.key.id}`,\r\n              mediaType,\r\n              fileName,\r\n            );\r\n\r\n            await s3Service.uploadFile(fullName, buffer, size.fileLength?.low, {\r\n              'Content-Type': mimetype,\r\n            });\r\n\r\n            await this.prismaRepository.media.create({\r\n              data: {\r\n                messageId: msg.id,\r\n                instanceId: this.instanceId,\r\n                type: mediaType,\r\n                fileName: fullName,\r\n                mimetype,\r\n              },\r\n            });\r\n\r\n            const mediaUrl = await s3Service.getObjectUrl(fullName);\r\n\r\n            messageRaw.message.mediaUrl = mediaUrl;\r\n\r\n            await this.prismaRepository.message.update({\r\n              where: { id: msg.id },\r\n              data: messageRaw,\r\n            });\r\n          } catch (error) {\r\n            this.logger.error(['Error on upload file to minio', error?.message, error?.stack]);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.localWebhook.enabled) {\r\n        if (isMedia && this.localWebhook.webhookBase64) {\r\n          try {\r\n            const buffer = await downloadMediaMessage(\r\n              { key: messageRaw.key, message: messageRaw?.message },\r\n              'buffer',\r\n              {},\r\n              {\r\n                logger: P({ level: 'error' }) as any,\r\n                reuploadRequest: this.client.updateMediaMessage,\r\n              },\r\n            );\r\n\r\n            messageRaw.message.base64 = buffer ? buffer.toString('base64') : undefined;\r\n          } catch (error) {\r\n            this.logger.error(['Error converting media to base64', error?.message]);\r\n          }\r\n        }\r\n      }\r\n\r\n      this.logger.log(messageRaw);\r\n\r\n      this.sendDataWebhook(Events.SEND_MESSAGE, messageRaw);\r\n\r\n      if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled && isIntegration) {\r\n        await chatbotController.emit({\r\n          instance: { instanceName: this.instance.name, instanceId: this.instanceId },\r\n          remoteJid: messageRaw.key.remoteJid,\r\n          msg: messageRaw,\r\n          pushName: messageRaw.pushName,\r\n          isIntegration,\r\n        });\r\n      }\r\n\r\n      return messageRaw;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  // Instance Controller\r\n  public async sendPresence(data: SendPresenceDto) {\r\n    try {\r\n      const { number } = data;\r\n\r\n      const isWA = (await this.whatsappNumber({ numbers: [number] }))?.shift();\r\n\r\n      if (!isWA.exists && !isJidGroup(isWA.jid) && !isWA.jid.includes('@broadcast')) {\r\n        throw new BadRequestException(isWA);\r\n      }\r\n\r\n      const sender = isWA.jid;\r\n\r\n      if (data?.delay && data?.delay > 20000) {\r\n        let remainingDelay = data?.delay;\r\n        while (remainingDelay > 20000) {\r\n          await this.client.presenceSubscribe(sender);\r\n\r\n          await this.client.sendPresenceUpdate((data?.presence as WAPresence) ?? 'composing', sender);\r\n\r\n          await delay(20000);\r\n\r\n          await this.client.sendPresenceUpdate('paused', sender);\r\n\r\n          remainingDelay -= 20000;\r\n        }\r\n        if (remainingDelay > 0) {\r\n          await this.client.presenceSubscribe(sender);\r\n\r\n          await this.client.sendPresenceUpdate((data?.presence as WAPresence) ?? 'composing', sender);\r\n\r\n          await delay(remainingDelay);\r\n\r\n          await this.client.sendPresenceUpdate('paused', sender);\r\n        }\r\n      } else {\r\n        await this.client.presenceSubscribe(sender);\r\n\r\n        await this.client.sendPresenceUpdate((data?.presence as WAPresence) ?? 'composing', sender);\r\n\r\n        await delay(data?.delay);\r\n\r\n        await this.client.sendPresenceUpdate('paused', sender);\r\n      }\r\n\r\n      return { presence: data.presence };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  // Presence Controller\r\n  public async setPresence(data: SetPresenceDto) {\r\n    try {\r\n      await this.client.sendPresenceUpdate(data.presence);\r\n\r\n      return { presence: data.presence };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  // Send Message Controller\r\n  public async textMessage(data: SendTextDto, isIntegration = false) {\r\n    const text = data.text;\r\n\r\n    if (!text || text.trim().length === 0) {\r\n      throw new BadRequestException('Text is required');\r\n    }\r\n\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        conversation: data.text,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n  }\r\n\r\n  public async pollMessage(data: SendPollDto) {\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        poll: {\r\n          name: data.name,\r\n          selectableCount: data.selectableCount,\r\n          values: data.values,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        linkPreview: data?.linkPreview,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  private async formatStatusMessage(status: StatusMessage) {\r\n    if (!status.type) {\r\n      throw new BadRequestException('Type is required');\r\n    }\r\n\r\n    if (!status.content) {\r\n      throw new BadRequestException('Content is required');\r\n    }\r\n\r\n    if (status.allContacts) {\r\n      const contacts = await this.prismaRepository.contact.findMany({\r\n        where: { instanceId: this.instanceId },\r\n      });\r\n\r\n      if (!contacts.length) {\r\n        throw new BadRequestException('Contacts not found');\r\n      }\r\n\r\n      status.statusJidList = contacts.filter((contact) => contact.pushName).map((contact) => contact.remoteJid);\r\n    }\r\n\r\n    if (!status.statusJidList?.length && !status.allContacts) {\r\n      throw new BadRequestException('StatusJidList is required');\r\n    }\r\n\r\n    if (status.type === 'text') {\r\n      if (!status.backgroundColor) {\r\n        throw new BadRequestException('Background color is required');\r\n      }\r\n\r\n      if (!status.font) {\r\n        throw new BadRequestException('Font is required');\r\n      }\r\n\r\n      return {\r\n        content: {\r\n          text: status.content,\r\n        },\r\n        option: {\r\n          backgroundColor: status.backgroundColor,\r\n          font: status.font,\r\n          statusJidList: status.statusJidList,\r\n        },\r\n      };\r\n    }\r\n    if (status.type === 'image') {\r\n      return {\r\n        content: {\r\n          image: {\r\n            url: status.content,\r\n          },\r\n          caption: status.caption,\r\n        },\r\n        option: {\r\n          statusJidList: status.statusJidList,\r\n        },\r\n      };\r\n    }\r\n\r\n    if (status.type === 'video') {\r\n      return {\r\n        content: {\r\n          video: {\r\n            url: status.content,\r\n          },\r\n          caption: status.caption,\r\n        },\r\n        option: {\r\n          statusJidList: status.statusJidList,\r\n        },\r\n      };\r\n    }\r\n\r\n    if (status.type === 'audio') {\r\n      const convert = await this.processAudioMp4(status.content);\r\n      if (Buffer.isBuffer(convert)) {\r\n        const result = {\r\n          content: {\r\n            audio: convert,\r\n            ptt: true,\r\n            mimetype: 'audio/ogg; codecs=opus',\r\n          },\r\n          option: {\r\n            statusJidList: status.statusJidList,\r\n          },\r\n        };\r\n\r\n        return result;\r\n      } else {\r\n        throw new InternalServerErrorException(convert);\r\n      }\r\n    }\r\n\r\n    throw new BadRequestException('Type not found');\r\n  }\r\n\r\n  public async statusMessage(data: SendStatusDto, file?: any) {\r\n    const mediaData: SendStatusDto = { ...data };\r\n\r\n    if (file) mediaData.content = file.buffer.toString('base64');\r\n\r\n    const status = await this.formatStatusMessage(mediaData);\r\n\r\n    const statusSent = await this.sendMessageWithTyping('status@broadcast', {\r\n      status,\r\n    });\r\n\r\n    return statusSent;\r\n  }\r\n\r\n  private async prepareMediaMessage(mediaMessage: MediaMessage) {\r\n    try {\r\n      const type = mediaMessage.mediatype === 'ptv' ? 'video' : mediaMessage.mediatype;\r\n\r\n      const prepareMedia = await prepareWAMessageMedia(\r\n        {\r\n          [type]: isURL(mediaMessage.media) ? { url: mediaMessage.media } : Buffer.from(mediaMessage.media, 'base64'),\r\n        } as any,\r\n        { upload: this.client.waUploadToServer },\r\n      );\r\n\r\n      const mediaType = mediaMessage.mediatype + 'Message';\r\n\r\n      if (mediaMessage.mediatype === 'document' && !mediaMessage.fileName) {\r\n        const regex = new RegExp(/.*\\/(.+?)\\./);\r\n        const arrayMatch = regex.exec(mediaMessage.media);\r\n        mediaMessage.fileName = arrayMatch[1];\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'image' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'image.png';\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'video' && !mediaMessage.fileName) {\r\n        mediaMessage.fileName = 'video.mp4';\r\n      }\r\n\r\n      let mimetype: string | false;\r\n\r\n      if (mediaMessage.mimetype) {\r\n        mimetype = mediaMessage.mimetype;\r\n      } else {\r\n        mimetype = mimeTypes.lookup(mediaMessage.fileName);\r\n\r\n        if (!mimetype && isURL(mediaMessage.media)) {\r\n          let config: any = {\r\n            responseType: 'arraybuffer',\r\n          };\r\n\r\n          if (this.localProxy?.enabled) {\r\n            config = {\r\n              ...config,\r\n              httpsAgent: makeProxyAgent({\r\n                host: this.localProxy.host,\r\n                port: this.localProxy.port,\r\n                protocol: this.localProxy.protocol,\r\n                username: this.localProxy.username,\r\n                password: this.localProxy.password,\r\n              }),\r\n            };\r\n          }\r\n\r\n          const response = await axios.get(mediaMessage.media, config);\r\n\r\n          mimetype = response.headers['content-type'];\r\n        }\r\n      }\r\n\r\n      if (mediaMessage.mediatype === 'ptv') {\r\n        prepareMedia[mediaType] = prepareMedia[type + 'Message'];\r\n        mimetype = 'video/mp4';\r\n\r\n        if (!prepareMedia[mediaType]) {\r\n          throw new Error('Failed to prepare video message');\r\n        }\r\n\r\n        try {\r\n          let mediaInput;\r\n          if (isURL(mediaMessage.media)) {\r\n            mediaInput = mediaMessage.media;\r\n          } else {\r\n            const mediaBuffer = Buffer.from(mediaMessage.media, 'base64');\r\n            if (!mediaBuffer || mediaBuffer.length === 0) {\r\n              throw new Error('Invalid media buffer');\r\n            }\r\n            mediaInput = mediaBuffer;\r\n          }\r\n\r\n          const duration = await getVideoDuration(mediaInput);\r\n          if (!duration || duration <= 0) {\r\n            throw new Error('Invalid media duration');\r\n          }\r\n\r\n          this.logger.verbose(`Video duration: ${duration} seconds`);\r\n          prepareMedia[mediaType].seconds = duration;\r\n        } catch (error) {\r\n          this.logger.error('Error getting video duration:');\r\n          this.logger.error(error);\r\n          throw new Error(`Failed to get video duration: ${error.message}`);\r\n        }\r\n      }\r\n\r\n      prepareMedia[mediaType].caption = mediaMessage?.caption;\r\n      prepareMedia[mediaType].mimetype = mimetype;\r\n      prepareMedia[mediaType].fileName = mediaMessage.fileName;\r\n\r\n      if (mediaMessage.mediatype === 'video') {\r\n        prepareMedia[mediaType].jpegThumbnail = Uint8Array.from(\r\n          readFileSync(join(process.cwd(), 'public', 'images', 'video-cover.png')),\r\n        );\r\n        prepareMedia[mediaType].gifPlayback = false;\r\n      }\r\n\r\n      return generateWAMessageFromContent(\r\n        '',\r\n        { [mediaType]: { ...prepareMedia[mediaType] } },\r\n        { userJid: this.instance.wuid },\r\n      );\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException(error?.toString() || error);\r\n    }\r\n  }\r\n\r\n  private async convertToWebP(image: string): Promise<Buffer> {\r\n    try {\r\n      let imageBuffer: Buffer;\r\n\r\n      if (isBase64(image)) {\r\n        const base64Data = image.replace(/^data:image\\/(jpeg|png|gif);base64,/, '');\r\n        imageBuffer = Buffer.from(base64Data, 'base64');\r\n      } else {\r\n        const timestamp = new Date().getTime();\r\n        const url = `${image}?timestamp=${timestamp}`;\r\n\r\n        let config: any = {\r\n          responseType: 'arraybuffer',\r\n        };\r\n\r\n        if (this.localProxy?.enabled) {\r\n          config = {\r\n            ...config,\r\n            httpsAgent: makeProxyAgent({\r\n              host: this.localProxy.host,\r\n              port: this.localProxy.port,\r\n              protocol: this.localProxy.protocol,\r\n              username: this.localProxy.username,\r\n              password: this.localProxy.password,\r\n            }),\r\n          };\r\n        }\r\n\r\n        const response = await axios.get(url, config);\r\n        imageBuffer = Buffer.from(response.data, 'binary');\r\n      }\r\n\r\n      const webpBuffer = await sharp(imageBuffer).webp().toBuffer();\r\n\r\n      return webpBuffer;\r\n    } catch (error) {\r\n      console.error('Erro ao converter a imagem para WebP:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  public async mediaSticker(data: SendStickerDto, file?: any) {\r\n    const mediaData: SendStickerDto = { ...data };\r\n\r\n    if (file) mediaData.sticker = file.buffer.toString('base64');\r\n\r\n    const convert = await this.convertToWebP(data.sticker);\r\n    const gifPlayback = data.sticker.includes('.gif');\r\n    const result = await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        sticker: convert,\r\n        gifPlayback,\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n\r\n    return result;\r\n  }\r\n\r\n  public async mediaMessage(data: SendMediaDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendMediaDto = { ...data };\r\n\r\n    if (file) mediaData.media = file.buffer.toString('base64');\r\n\r\n    const generate = await this.prepareMediaMessage(mediaData);\r\n\r\n    const mediaSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...generate.message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n\r\n    return mediaSent;\r\n  }\r\n\r\n  public async ptvMessage(data: SendPtvDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendMediaDto = {\r\n      number: data.number,\r\n      media: data.video,\r\n      mediatype: 'ptv',\r\n      delay: data?.delay,\r\n      quoted: data?.quoted,\r\n      mentionsEveryOne: data?.mentionsEveryOne,\r\n      mentioned: data?.mentioned,\r\n    };\r\n\r\n    if (file) mediaData.media = file.buffer.toString('base64');\r\n\r\n    const generate = await this.prepareMediaMessage(mediaData);\r\n\r\n    const mediaSent = await this.sendMessageWithTyping(\r\n      data.number,\r\n      { ...generate.message },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n      isIntegration,\r\n    );\r\n\r\n    return mediaSent;\r\n  }\r\n\r\n  public async processAudioMp4(audio: string) {\r\n    let inputStream: PassThrough;\r\n\r\n    if (isURL(audio)) {\r\n      const response = await axios.get(audio, { responseType: 'stream' });\r\n      inputStream = response.data;\r\n    } else {\r\n      const audioBuffer = Buffer.from(audio, 'base64');\r\n      inputStream = new PassThrough();\r\n      inputStream.end(audioBuffer);\r\n    }\r\n\r\n    return new Promise<Buffer>((resolve, reject) => {\r\n      const ffmpegProcess = spawn(ffmpegPath.path, [\r\n        '-i',\r\n        'pipe:0',\r\n        '-vn',\r\n        '-ab',\r\n        '128k',\r\n        '-ar',\r\n        '44100',\r\n        '-f',\r\n        'mp4',\r\n        '-movflags',\r\n        'frag_keyframe+empty_moov',\r\n        'pipe:1',\r\n      ]);\r\n\r\n      const outputChunks: Buffer[] = [];\r\n      let stderrData = '';\r\n\r\n      ffmpegProcess.stdout.on('data', (chunk) => {\r\n        outputChunks.push(chunk);\r\n      });\r\n\r\n      ffmpegProcess.stderr.on('data', (data) => {\r\n        stderrData += data.toString();\r\n        this.logger.verbose(`ffmpeg stderr: ${data}`);\r\n      });\r\n\r\n      ffmpegProcess.on('error', (error) => {\r\n        console.error('Error in ffmpeg process', error);\r\n        reject(error);\r\n      });\r\n\r\n      ffmpegProcess.on('close', (code) => {\r\n        if (code === 0) {\r\n          this.logger.verbose('Audio converted to mp4');\r\n          const outputBuffer = Buffer.concat(outputChunks);\r\n          resolve(outputBuffer);\r\n        } else {\r\n          this.logger.error(`ffmpeg exited with code ${code}`);\r\n          this.logger.error(`ffmpeg stderr: ${stderrData}`);\r\n          reject(new Error(`ffmpeg exited with code ${code}: ${stderrData}`));\r\n        }\r\n      });\r\n\r\n      inputStream.pipe(ffmpegProcess.stdin);\r\n\r\n      inputStream.on('error', (err) => {\r\n        console.error('Error in inputStream', err);\r\n        ffmpegProcess.stdin.end();\r\n        reject(err);\r\n      });\r\n    });\r\n  }\r\n\r\n  public async processAudio(audio: string): Promise<Buffer> {\r\n    if (process.env.API_AUDIO_CONVERTER) {\r\n      this.logger.verbose('Using audio converter API');\r\n      const formData = new FormData();\r\n\r\n      if (isURL(audio)) {\r\n        formData.append('url', audio);\r\n      } else {\r\n        formData.append('base64', audio);\r\n      }\r\n\r\n      const { data } = await axios.post(process.env.API_AUDIO_CONVERTER, formData, {\r\n        headers: {\r\n          ...formData.getHeaders(),\r\n          apikey: process.env.API_AUDIO_CONVERTER_KEY,\r\n        },\r\n      });\r\n\r\n      if (!data.audio) {\r\n        throw new InternalServerErrorException('Failed to convert audio');\r\n      }\r\n\r\n      this.logger.verbose('Audio converted');\r\n      return Buffer.from(data.audio, 'base64');\r\n    } else {\r\n      let inputAudioStream: PassThrough;\r\n\r\n      if (isURL(audio)) {\r\n        const timestamp = new Date().getTime();\r\n        const url = `${audio}?timestamp=${timestamp}`;\r\n\r\n        const config: any = {\r\n          responseType: 'stream',\r\n        };\r\n\r\n        const response = await axios.get(url, config);\r\n        inputAudioStream = response.data.pipe(new PassThrough());\r\n      } else {\r\n        const audioBuffer = Buffer.from(audio, 'base64');\r\n        inputAudioStream = new PassThrough();\r\n        inputAudioStream.end(audioBuffer);\r\n      }\r\n\r\n      return new Promise((resolve, reject) => {\r\n        const outputAudioStream = new PassThrough();\r\n        const chunks: Buffer[] = [];\r\n\r\n        outputAudioStream.on('data', (chunk) => chunks.push(chunk));\r\n        outputAudioStream.on('end', () => {\r\n          const outputBuffer = Buffer.concat(chunks);\r\n          resolve(outputBuffer);\r\n        });\r\n\r\n        outputAudioStream.on('error', (error) => {\r\n          console.log('error', error);\r\n          reject(error);\r\n        });\r\n\r\n        ffmpeg.setFfmpegPath(ffmpegPath.path);\r\n\r\n        ffmpeg(inputAudioStream)\r\n          .outputFormat('ogg')\r\n          .noVideo()\r\n          .audioCodec('libopus')\r\n          .addOutputOptions('-avoid_negative_ts make_zero')\r\n          .audioChannels(1)\r\n          .pipe(outputAudioStream, { end: true })\r\n          .on('error', function (error) {\r\n            console.log('error', error);\r\n            reject(error);\r\n          });\r\n      });\r\n    }\r\n  }\r\n\r\n  public async audioWhatsapp(data: SendAudioDto, file?: any, isIntegration = false) {\r\n    const mediaData: SendAudioDto = { ...data };\r\n\r\n    if (file?.buffer) {\r\n      mediaData.audio = file.buffer.toString('base64');\r\n    } else if (!isURL(data.audio) && !isBase64(data.audio)) {\r\n      console.error('Invalid file or audio source');\r\n      throw new BadRequestException('File buffer, URL, or base64 audio is required');\r\n    }\r\n\r\n    if (!data?.encoding && data?.encoding !== false) {\r\n      data.encoding = true;\r\n    }\r\n\r\n    if (data?.encoding) {\r\n      const convert = await this.processAudio(mediaData.audio);\r\n\r\n      if (Buffer.isBuffer(convert)) {\r\n        const result = this.sendMessageWithTyping<AnyMessageContent>(\r\n          data.number,\r\n          {\r\n            audio: convert,\r\n            ptt: true,\r\n            mimetype: 'audio/ogg; codecs=opus',\r\n          },\r\n          { presence: 'recording', delay: data?.delay },\r\n          isIntegration,\r\n        );\r\n\r\n        return result;\r\n      } else {\r\n        throw new InternalServerErrorException('Failed to convert audio');\r\n      }\r\n    }\r\n\r\n    return await this.sendMessageWithTyping<AnyMessageContent>(\r\n      data.number,\r\n      {\r\n        audio: isURL(data.audio) ? { url: data.audio } : Buffer.from(data.audio, 'base64'),\r\n        ptt: true,\r\n        mimetype: 'audio/ogg; codecs=opus',\r\n      },\r\n      { presence: 'recording', delay: data?.delay },\r\n      isIntegration,\r\n    );\r\n  }\r\n\r\n  private generateRandomId(length = 11) {\r\n    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\r\n    let result = '';\r\n    for (let i = 0; i < length; i++) {\r\n      result += characters.charAt(Math.floor(Math.random() * characters.length));\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private toJSONString(button: Button): string {\r\n    const toString = (obj: any) => JSON.stringify(obj);\r\n\r\n    const json = {\r\n      call: () => toString({ display_text: button.displayText, phone_number: button.phoneNumber }),\r\n      reply: () => toString({ display_text: button.displayText, id: button.id }),\r\n      copy: () => toString({ display_text: button.displayText, copy_code: button.copyCode }),\r\n      url: () =>\r\n        toString({\r\n          display_text: button.displayText,\r\n          url: button.url,\r\n          merchant_url: button.url,\r\n        }),\r\n      pix: () =>\r\n        toString({\r\n          currency: button.currency,\r\n          total_amount: {\r\n            value: 0,\r\n            offset: 100,\r\n          },\r\n          reference_id: this.generateRandomId(),\r\n          type: 'physical-goods',\r\n          order: {\r\n            status: 'pending',\r\n            subtotal: {\r\n              value: 0,\r\n              offset: 100,\r\n            },\r\n            order_type: 'ORDER',\r\n            items: [\r\n              {\r\n                name: '',\r\n                amount: {\r\n                  value: 0,\r\n                  offset: 100,\r\n                },\r\n                quantity: 0,\r\n                sale_amount: {\r\n                  value: 0,\r\n                  offset: 100,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          payment_settings: [\r\n            {\r\n              type: 'pix_static_code',\r\n              pix_static_code: {\r\n                merchant_name: button.name,\r\n                key: button.key,\r\n                key_type: this.mapKeyType.get(button.keyType),\r\n              },\r\n            },\r\n          ],\r\n          share_payment_status: false,\r\n        }),\r\n    };\r\n\r\n    return json[button.type]?.() || '';\r\n  }\r\n\r\n  private readonly mapType = new Map<TypeButton, string>([\r\n    ['reply', 'quick_reply'],\r\n    ['copy', 'cta_copy'],\r\n    ['url', 'cta_url'],\r\n    ['call', 'cta_call'],\r\n    ['pix', 'payment_info'],\r\n  ]);\r\n\r\n  private readonly mapKeyType = new Map<KeyType, string>([\r\n    ['phone', 'PHONE'],\r\n    ['email', 'EMAIL'],\r\n    ['cpf', 'CPF'],\r\n    ['cnpj', 'CNPJ'],\r\n    ['random', 'EVP'],\r\n  ]);\r\n\r\n  public async buttonMessage(data: SendButtonsDto) {\r\n    if (data.buttons.length === 0) {\r\n      throw new BadRequestException('At least one button is required');\r\n    }\r\n\r\n    const hasReplyButtons = data.buttons.some((btn) => btn.type === 'reply');\r\n\r\n    const hasPixButton = data.buttons.some((btn) => btn.type === 'pix');\r\n\r\n    const hasOtherButtons = data.buttons.some((btn) => btn.type !== 'reply' && btn.type !== 'pix');\r\n\r\n    if (hasReplyButtons) {\r\n      if (data.buttons.length > 3) {\r\n        throw new BadRequestException('Maximum of 3 reply buttons allowed');\r\n      }\r\n      if (hasOtherButtons) {\r\n        throw new BadRequestException('Reply buttons cannot be mixed with other button types');\r\n      }\r\n    }\r\n\r\n    if (hasPixButton) {\r\n      if (data.buttons.length > 1) {\r\n        throw new BadRequestException('Only one PIX button is allowed');\r\n      }\r\n      if (hasOtherButtons) {\r\n        throw new BadRequestException('PIX button cannot be mixed with other button types');\r\n      }\r\n\r\n      const message: proto.IMessage = {\r\n        viewOnceMessage: {\r\n          message: {\r\n            interactiveMessage: {\r\n              nativeFlowMessage: {\r\n                buttons: [\r\n                  {\r\n                    name: this.mapType.get('pix'),\r\n                    buttonParamsJson: this.toJSONString(data.buttons[0]),\r\n                  },\r\n                ],\r\n                messageParamsJson: JSON.stringify({\r\n                  from: 'api',\r\n                  templateId: v4(),\r\n                }),\r\n              },\r\n            },\r\n          },\r\n        },\r\n      };\r\n\r\n      return await this.sendMessageWithTyping(data.number, message, {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      });\r\n    }\r\n\r\n    const generate = await (async () => {\r\n      if (data?.thumbnailUrl) {\r\n        return await this.prepareMediaMessage({\r\n          mediatype: 'image',\r\n          media: data.thumbnailUrl,\r\n        });\r\n      }\r\n    })();\r\n\r\n    const buttons = data.buttons.map((value) => {\r\n      return {\r\n        name: this.mapType.get(value.type),\r\n        buttonParamsJson: this.toJSONString(value),\r\n      };\r\n    });\r\n\r\n    const message: proto.IMessage = {\r\n      viewOnceMessage: {\r\n        message: {\r\n          interactiveMessage: {\r\n            body: {\r\n              text: (() => {\r\n                let t = '*' + data.title + '*';\r\n                if (data?.description) {\r\n                  t += '\\n\\n';\r\n                  t += data.description;\r\n                  t += '\\n';\r\n                }\r\n                return t;\r\n              })(),\r\n            },\r\n            footer: {\r\n              text: data?.footer,\r\n            },\r\n            header: (() => {\r\n              if (generate?.message?.imageMessage) {\r\n                return {\r\n                  hasMediaAttachment: !!generate.message.imageMessage,\r\n                  imageMessage: generate.message.imageMessage,\r\n                };\r\n              }\r\n            })(),\r\n            nativeFlowMessage: {\r\n              buttons: buttons,\r\n              messageParamsJson: JSON.stringify({\r\n                from: 'api',\r\n                templateId: v4(),\r\n              }),\r\n            },\r\n          },\r\n        },\r\n      },\r\n    };\r\n\r\n    return await this.sendMessageWithTyping(data.number, message, {\r\n      delay: data?.delay,\r\n      presence: 'composing',\r\n      quoted: data?.quoted,\r\n      mentionsEveryOne: data?.mentionsEveryOne,\r\n      mentioned: data?.mentioned,\r\n    });\r\n  }\r\n\r\n  public async locationMessage(data: SendLocationDto) {\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        locationMessage: {\r\n          degreesLatitude: data.latitude,\r\n          degreesLongitude: data.longitude,\r\n          name: data?.name,\r\n          address: data?.address,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  public async listMessage(data: SendListDto) {\r\n    return await this.sendMessageWithTyping(\r\n      data.number,\r\n      {\r\n        listMessage: {\r\n          title: data.title,\r\n          description: data.description,\r\n          buttonText: data?.buttonText,\r\n          footerText: data?.footerText,\r\n          sections: data.sections,\r\n          listType: 2,\r\n        },\r\n      },\r\n      {\r\n        delay: data?.delay,\r\n        presence: 'composing',\r\n        quoted: data?.quoted,\r\n        mentionsEveryOne: data?.mentionsEveryOne,\r\n        mentioned: data?.mentioned,\r\n      },\r\n    );\r\n  }\r\n\r\n  public async contactMessage(data: SendContactDto) {\r\n    const message: proto.IMessage = {};\r\n\r\n    const vcard = (contact: ContactMessage) => {\r\n      let result = 'BEGIN:VCARD\\n' + 'VERSION:3.0\\n' + `N:${contact.fullName}\\n` + `FN:${contact.fullName}\\n`;\r\n\r\n      if (contact.organization) {\r\n        result += `ORG:${contact.organization};\\n`;\r\n      }\r\n\r\n      if (contact.email) {\r\n        result += `EMAIL:${contact.email}\\n`;\r\n      }\r\n\r\n      if (contact.url) {\r\n        result += `URL:${contact.url}\\n`;\r\n      }\r\n\r\n      if (!contact.wuid) {\r\n        contact.wuid = createJid(contact.phoneNumber);\r\n      }\r\n\r\n      result += `item1.TEL;waid=${contact.wuid}:${contact.phoneNumber}\\n` + 'item1.X-ABLabel:Celular\\n' + 'END:VCARD';\r\n\r\n      return result;\r\n    };\r\n\r\n    if (data.contact.length === 1) {\r\n      message.contactMessage = {\r\n        displayName: data.contact[0].fullName,\r\n        vcard: vcard(data.contact[0]),\r\n      };\r\n    } else {\r\n      message.contactsArrayMessage = {\r\n        displayName: `${data.contact.length} contacts`,\r\n        contacts: data.contact.map((contact) => {\r\n          return {\r\n            displayName: contact.fullName,\r\n            vcard: vcard(contact),\r\n          };\r\n        }),\r\n      };\r\n    }\r\n\r\n    return await this.sendMessageWithTyping(data.number, { ...message }, {});\r\n  }\r\n\r\n  public async reactionMessage(data: SendReactionDto) {\r\n    return await this.sendMessageWithTyping(data.key.remoteJid, {\r\n      reactionMessage: {\r\n        key: data.key,\r\n        text: data.reaction,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Chat Controller\r\n  public async whatsappNumber(data: WhatsAppNumberDto) {\r\n    const jids: {\r\n      groups: { number: string; jid: string }[];\r\n      broadcast: { number: string; jid: string }[];\r\n      users: { number: string; jid: string; name?: string }[];\r\n    } = {\r\n      groups: [],\r\n      broadcast: [],\r\n      users: [],\r\n    };\r\n\r\n    data.numbers.forEach((number) => {\r\n      const jid = createJid(number);\r\n\r\n      if (isJidGroup(jid)) {\r\n        jids.groups.push({ number, jid });\r\n      } else if (jid === 'status@broadcast') {\r\n        jids.broadcast.push({ number, jid });\r\n      } else {\r\n        jids.users.push({ number, jid });\r\n      }\r\n    });\r\n\r\n    const onWhatsapp: OnWhatsAppDto[] = [];\r\n\r\n    // BROADCAST\r\n    onWhatsapp.push(...jids.broadcast.map(({ jid, number }) => new OnWhatsAppDto(jid, false, number)));\r\n\r\n    // GROUPS\r\n    const groups = await Promise.all(\r\n      jids.groups.map(async ({ jid, number }) => {\r\n        const group = await this.findGroup({ groupJid: jid }, 'inner');\r\n\r\n        if (!group) {\r\n          new OnWhatsAppDto(jid, false, number);\r\n        }\r\n\r\n        return new OnWhatsAppDto(group.id, !!group?.id, number, group?.subject);\r\n      }),\r\n    );\r\n    onWhatsapp.push(...groups);\r\n\r\n    // USERS\r\n    const contacts: any[] = await this.prismaRepository.contact.findMany({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n        remoteJid: {\r\n          in: jids.users.map(({ jid }) => jid),\r\n        },\r\n      },\r\n    });\r\n\r\n    const numbersToVerify = jids.users.map(({ jid }) => jid.replace('+', ''));\r\n\r\n    const cachedNumbers = await getOnWhatsappCache(numbersToVerify);\r\n    const filteredNumbers = numbersToVerify.filter(\r\n      (jid) => !cachedNumbers.some((cached) => cached.jidOptions.includes(jid)),\r\n    );\r\n\r\n    const verify = await this.client.onWhatsApp(...filteredNumbers);\r\n    const users: OnWhatsAppDto[] = await Promise.all(\r\n      jids.users.map(async (user) => {\r\n        let numberVerified: (typeof verify)[0] | null = null;\r\n\r\n        const cached = cachedNumbers.find((cached) => cached.jidOptions.includes(user.jid.replace('+', '')));\r\n        if (cached) {\r\n          return {\r\n            exists: true,\r\n            jid: cached.remoteJid,\r\n            name: contacts.find((c) => c.remoteJid === cached.remoteJid)?.pushName,\r\n            number: user.number,\r\n          };\r\n        }\r\n\r\n        // Brazilian numbers\r\n        if (user.number.startsWith('55')) {\r\n          const numberWithDigit =\r\n            user.number.slice(4, 5) === '9' && user.number.length === 13\r\n              ? user.number\r\n              : `${user.number.slice(0, 4)}9${user.number.slice(4)}`;\r\n          const numberWithoutDigit =\r\n            user.number.length === 12 ? user.number : user.number.slice(0, 4) + user.number.slice(5);\r\n\r\n          numberVerified = verify.find(\r\n            (v) => v.jid === `${numberWithDigit}@s.whatsapp.net` || v.jid === `${numberWithoutDigit}@s.whatsapp.net`,\r\n          );\r\n        }\r\n\r\n        // Mexican/Argentina numbers\r\n        // Ref: https://faq.whatsapp.com/1294841057948784\r\n        if (!numberVerified && (user.number.startsWith('52') || user.number.startsWith('54'))) {\r\n          let prefix = '';\r\n          if (user.number.startsWith('52')) {\r\n            prefix = '';\r\n          }\r\n          if (user.number.startsWith('54')) {\r\n            prefix = '9';\r\n          }\r\n\r\n          const numberWithDigit =\r\n            user.number.slice(2, 3) === prefix && user.number.length === 13\r\n              ? user.number\r\n              : `${user.number.slice(0, 2)}${prefix}${user.number.slice(2)}`;\r\n          const numberWithoutDigit =\r\n            user.number.length === 12 ? user.number : user.number.slice(0, 2) + user.number.slice(3);\r\n\r\n          numberVerified = verify.find(\r\n            (v) => v.jid === `${numberWithDigit}@s.whatsapp.net` || v.jid === `${numberWithoutDigit}@s.whatsapp.net`,\r\n          );\r\n        }\r\n\r\n        if (!numberVerified) {\r\n          numberVerified = verify.find((v) => v.jid === user.jid);\r\n        }\r\n\r\n        const numberJid = numberVerified?.jid || user.jid;\r\n\r\n        return {\r\n          exists: !!numberVerified?.exists,\r\n          jid: numberJid,\r\n          name: contacts.find((c) => c.remoteJid === numberJid)?.pushName,\r\n          number: user.number,\r\n        };\r\n      }),\r\n    );\r\n\r\n    await saveOnWhatsappCache(users.filter((user) => user.exists).map((user) => ({ remoteJid: user.jid })));\r\n\r\n    onWhatsapp.push(...users);\r\n\r\n    return onWhatsapp;\r\n  }\r\n\r\n  public async markMessageAsRead(data: ReadMessageDto) {\r\n    try {\r\n      const keys: proto.IMessageKey[] = [];\r\n      data.readMessages.forEach((read) => {\r\n        if (isJidGroup(read.remoteJid) || isJidUser(read.remoteJid)) {\r\n          keys.push({\r\n            remoteJid: read.remoteJid,\r\n            fromMe: read.fromMe,\r\n            id: read.id,\r\n          });\r\n        }\r\n      });\r\n      await this.client.readMessages(keys);\r\n      return { message: 'Read messages', read: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Read messages fail', error.toString());\r\n    }\r\n  }\r\n\r\n  public async getLastMessage(number: string) {\r\n    const where: any = {\r\n      key: {\r\n        remoteJid: number,\r\n      },\r\n      instanceId: this.instance.id,\r\n    };\r\n\r\n    const messages = await this.prismaRepository.message.findMany({\r\n      where,\r\n      orderBy: {\r\n        messageTimestamp: 'desc',\r\n      },\r\n      take: 1,\r\n    });\r\n\r\n    if (messages.length === 0) {\r\n      throw new NotFoundException('Messages not found');\r\n    }\r\n\r\n    let lastMessage = messages.pop();\r\n\r\n    for (const message of messages) {\r\n      if (message.messageTimestamp >= lastMessage.messageTimestamp) {\r\n        lastMessage = message;\r\n      }\r\n    }\r\n\r\n    return lastMessage as unknown as LastMessage;\r\n  }\r\n\r\n  public async archiveChat(data: ArchiveChatDto) {\r\n    try {\r\n      let last_message = data.lastMessage;\r\n      let number = data.chat;\r\n\r\n      if (!last_message && number) {\r\n        last_message = await this.getLastMessage(number);\r\n      } else {\r\n        last_message = data.lastMessage;\r\n        last_message.messageTimestamp = last_message?.messageTimestamp ?? Date.now();\r\n        number = last_message?.key?.remoteJid;\r\n      }\r\n\r\n      if (!last_message || Object.keys(last_message).length === 0) {\r\n        throw new NotFoundException('Last message not found');\r\n      }\r\n\r\n      await this.client.chatModify(\r\n        {\r\n          archive: data.archive,\r\n          lastMessages: [last_message],\r\n        },\r\n        createJid(number),\r\n      );\r\n\r\n      return {\r\n        chatId: number,\r\n        archived: true,\r\n      };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException({\r\n        archived: false,\r\n        message: ['An error occurred while archiving the chat. Open a calling.', error.toString()],\r\n      });\r\n    }\r\n  }\r\n\r\n  public async markChatUnread(data: MarkChatUnreadDto) {\r\n    try {\r\n      let last_message = data.lastMessage;\r\n      let number = data.chat;\r\n\r\n      if (!last_message && number) {\r\n        last_message = await this.getLastMessage(number);\r\n      } else {\r\n        last_message = data.lastMessage;\r\n        last_message.messageTimestamp = last_message?.messageTimestamp ?? Date.now();\r\n        number = last_message?.key?.remoteJid;\r\n      }\r\n\r\n      if (!last_message || Object.keys(last_message).length === 0) {\r\n        throw new NotFoundException('Last message not found');\r\n      }\r\n\r\n      await this.client.chatModify(\r\n        {\r\n          markRead: false,\r\n          lastMessages: [last_message],\r\n        },\r\n        createJid(number),\r\n      );\r\n\r\n      return {\r\n        chatId: number,\r\n        markedChatUnread: true,\r\n      };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException({\r\n        markedChatUnread: false,\r\n        message: ['An error occurred while marked unread the chat. Open a calling.', error.toString()],\r\n      });\r\n    }\r\n  }\r\n\r\n  public async deleteMessage(del: DeleteMessage) {\r\n    try {\r\n      const response = await this.client.sendMessage(del.remoteJid, { delete: del });\r\n      if (response) {\r\n        const messageId = response.message?.protocolMessage?.key?.id;\r\n        if (messageId) {\r\n          const isLogicalDeleted = configService.get<Database>('DATABASE').DELETE_DATA.LOGICAL_MESSAGE_DELETE;\r\n          let message = await this.prismaRepository.message.findFirst({\r\n            where: {\r\n              key: {\r\n                path: ['id'],\r\n                equals: messageId,\r\n              },\r\n            },\r\n          });\r\n          if (isLogicalDeleted) {\r\n            if (!message) return response;\r\n            const existingKey = typeof message?.key === 'object' && message.key !== null ? message.key : {};\r\n            message = await this.prismaRepository.message.update({\r\n              where: { id: message.id },\r\n              data: {\r\n                key: {\r\n                  ...existingKey,\r\n                  deleted: true,\r\n                },\r\n                status: 'DELETED',\r\n              },\r\n            });\r\n          } else {\r\n            await this.prismaRepository.message.deleteMany({\r\n              where: {\r\n                id: message.id,\r\n              },\r\n            });\r\n          }\r\n          this.sendDataWebhook(Events.MESSAGES_DELETE, {\r\n            id: message.id,\r\n            instanceId: message.instanceId,\r\n            key: message.key,\r\n            messageType: message.messageType,\r\n            status: 'DELETED',\r\n            source: message.source,\r\n            messageTimestamp: message.messageTimestamp,\r\n            pushName: message.pushName,\r\n            participant: message.participant,\r\n            message: message.message,\r\n          });\r\n        }\r\n      }\r\n\r\n      return response;\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error while deleting message for everyone', error?.toString());\r\n    }\r\n  }\r\n\r\n  public async getBase64FromMediaMessage(data: getBase64FromMediaMessageDto, getBuffer = false) {\r\n    try {\r\n      const m = data?.message;\r\n      const convertToMp4 = data?.convertToMp4 ?? false;\r\n\r\n      const msg = m?.message ? m : ((await this.getMessage(m.key, true)) as proto.IWebMessageInfo);\r\n\r\n      if (!msg) {\r\n        throw 'Message not found';\r\n      }\r\n\r\n      for (const subtype of MessageSubtype) {\r\n        if (msg.message[subtype]) {\r\n          msg.message = msg.message[subtype].message;\r\n        }\r\n      }\r\n\r\n      let mediaMessage: any;\r\n      let mediaType: string;\r\n\r\n      for (const type of TypeMediaMessage) {\r\n        mediaMessage = msg.message[type];\r\n        if (mediaMessage) {\r\n          mediaType = type;\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (!mediaMessage) {\r\n        throw 'The message is not of the media type';\r\n      }\r\n\r\n      if (typeof mediaMessage['mediaKey'] === 'object') {\r\n        msg.message = JSON.parse(JSON.stringify(msg.message));\r\n      }\r\n\r\n      const buffer = await downloadMediaMessage(\r\n        { key: msg?.key, message: msg?.message },\r\n        'buffer',\r\n        {},\r\n        {\r\n          logger: P({ level: 'error' }) as any,\r\n          reuploadRequest: this.client.updateMediaMessage,\r\n        },\r\n      );\r\n      const typeMessage = getContentType(msg.message);\r\n\r\n      const ext = mimeTypes.extension(mediaMessage?.['mimetype']);\r\n      const fileName = mediaMessage?.['fileName'] || `${msg.key.id}.${ext}` || `${v4()}.${ext}`;\r\n\r\n      if (convertToMp4 && typeMessage === 'audioMessage') {\r\n        try {\r\n          const convert = await this.processAudioMp4(buffer.toString('base64'));\r\n\r\n          if (Buffer.isBuffer(convert)) {\r\n            const result = {\r\n              mediaType,\r\n              fileName,\r\n              caption: mediaMessage['caption'],\r\n              size: {\r\n                fileLength: mediaMessage['fileLength'],\r\n                height: mediaMessage['height'],\r\n                width: mediaMessage['width'],\r\n              },\r\n              mimetype: 'audio/mp4',\r\n              base64: convert.toString('base64'),\r\n              buffer: getBuffer ? convert : null,\r\n            };\r\n\r\n            return result;\r\n          }\r\n        } catch (error) {\r\n          this.logger.error('Error converting audio to mp4:');\r\n          this.logger.error(error);\r\n          throw new BadRequestException('Failed to convert audio to MP4');\r\n        }\r\n      }\r\n\r\n      return {\r\n        mediaType,\r\n        fileName,\r\n        caption: mediaMessage['caption'],\r\n        size: {\r\n          fileLength: mediaMessage['fileLength'],\r\n          height: mediaMessage['height'],\r\n          width: mediaMessage['width'],\r\n        },\r\n        mimetype: mediaMessage['mimetype'],\r\n        base64: buffer.toString('base64'),\r\n        buffer: getBuffer ? buffer : null,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Error processing media message:');\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async fetchPrivacySettings() {\r\n    const privacy = await this.client.fetchPrivacySettings();\r\n\r\n    return {\r\n      readreceipts: privacy.readreceipts,\r\n      profile: privacy.profile,\r\n      status: privacy.status,\r\n      online: privacy.online,\r\n      last: privacy.last,\r\n      groupadd: privacy.groupadd,\r\n    };\r\n  }\r\n\r\n  public async updatePrivacySettings(settings: PrivacySettingDto) {\r\n    try {\r\n      await this.client.updateReadReceiptsPrivacy(settings.readreceipts);\r\n      await this.client.updateProfilePicturePrivacy(settings.profile);\r\n      await this.client.updateStatusPrivacy(settings.status);\r\n      await this.client.updateOnlinePrivacy(settings.online);\r\n      await this.client.updateLastSeenPrivacy(settings.last);\r\n      await this.client.updateGroupsAddPrivacy(settings.groupadd);\r\n\r\n      this.reloadConnection();\r\n\r\n      return {\r\n        update: 'success',\r\n        data: {\r\n          readreceipts: settings.readreceipts,\r\n          profile: settings.profile,\r\n          status: settings.status,\r\n          online: settings.online,\r\n          last: settings.last,\r\n          groupadd: settings.groupadd,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating privacy settings', error.toString());\r\n    }\r\n  }\r\n\r\n  public async fetchBusinessProfile(number: string): Promise<NumberBusiness> {\r\n    try {\r\n      const jid = number ? createJid(number) : this.instance.wuid;\r\n\r\n      const profile = await this.client.getBusinessProfile(jid);\r\n\r\n      if (!profile) {\r\n        const info = await this.whatsappNumber({ numbers: [jid] });\r\n\r\n        return {\r\n          isBusiness: false,\r\n          message: 'Not is business profile',\r\n          ...info?.shift(),\r\n        };\r\n      }\r\n\r\n      return {\r\n        isBusiness: true,\r\n        ...profile,\r\n      };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating profile name', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateProfileName(name: string) {\r\n    try {\r\n      await this.client.updateProfileName(name);\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating profile name', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateProfileStatus(status: string) {\r\n    try {\r\n      await this.client.updateProfileStatus(status);\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating profile status', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateProfilePicture(picture: string) {\r\n    try {\r\n      let pic: WAMediaUpload;\r\n      if (isURL(picture)) {\r\n        const timestamp = new Date().getTime();\r\n        const url = `${picture}?timestamp=${timestamp}`;\r\n\r\n        let config: any = {\r\n          responseType: 'arraybuffer',\r\n        };\r\n\r\n        if (this.localProxy?.enabled) {\r\n          config = {\r\n            ...config,\r\n            httpsAgent: makeProxyAgent({\r\n              host: this.localProxy.host,\r\n              port: this.localProxy.port,\r\n              protocol: this.localProxy.protocol,\r\n              username: this.localProxy.username,\r\n              password: this.localProxy.password,\r\n            }),\r\n          };\r\n        }\r\n\r\n        pic = (await axios.get(url, config)).data;\r\n      } else if (isBase64(picture)) {\r\n        pic = Buffer.from(picture, 'base64');\r\n      } else {\r\n        throw new BadRequestException('\"profilePicture\" must be a url or a base64');\r\n      }\r\n\r\n      await this.client.updateProfilePicture(this.instance.wuid, pic);\r\n\r\n      this.reloadConnection();\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating profile picture', error.toString());\r\n    }\r\n  }\r\n\r\n  public async removeProfilePicture() {\r\n    try {\r\n      await this.client.removeProfilePicture(this.instance.wuid);\r\n\r\n      this.reloadConnection();\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error removing profile picture', error.toString());\r\n    }\r\n  }\r\n\r\n  public async blockUser(data: BlockUserDto) {\r\n    try {\r\n      const { number } = data;\r\n\r\n      const isWA = (await this.whatsappNumber({ numbers: [number] }))?.shift();\r\n\r\n      if (!isWA.exists && !isJidGroup(isWA.jid) && !isWA.jid.includes('@broadcast')) {\r\n        throw new BadRequestException(isWA);\r\n      }\r\n\r\n      const sender = isWA.jid;\r\n\r\n      await this.client.updateBlockStatus(sender, data.status);\r\n\r\n      return { block: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error blocking user', error.toString());\r\n    }\r\n  }\r\n\r\n  private async formatUpdateMessage(data: UpdateMessageDto) {\r\n    try {\r\n      const msg: any = await this.getMessage(data.key, true);\r\n\r\n      if (msg?.messageType === 'conversation' || msg?.messageType === 'extendedTextMessage') {\r\n        return {\r\n          text: data.text,\r\n        };\r\n      }\r\n\r\n      if (msg?.messageType === 'imageMessage') {\r\n        return {\r\n          image: msg?.message?.imageMessage,\r\n          caption: data.text,\r\n        };\r\n      }\r\n\r\n      if (msg?.messageType === 'videoMessage') {\r\n        return {\r\n          video: msg?.message?.videoMessage,\r\n          caption: data.text,\r\n        };\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateMessage(data: UpdateMessageDto) {\r\n    const jid = createJid(data.number);\r\n\r\n    const options = await this.formatUpdateMessage(data);\r\n\r\n    if (!options) {\r\n      this.logger.error('Message not compatible');\r\n      throw new BadRequestException('Message not compatible');\r\n    }\r\n\r\n    try {\r\n      return await this.client.sendMessage(jid, {\r\n        ...(options as any),\r\n        edit: data.key,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new BadRequestException(error.toString());\r\n    }\r\n  }\r\n\r\n  public async fetchLabels(): Promise<LabelDto[]> {\r\n    const labels = await this.prismaRepository.label.findMany({\r\n      where: {\r\n        instanceId: this.instanceId,\r\n      },\r\n    });\r\n\r\n    return labels.map((label) => ({\r\n      color: label.color,\r\n      name: label.name,\r\n      id: label.labelId,\r\n      predefinedId: label.predefinedId,\r\n    }));\r\n  }\r\n\r\n  public async handleLabel(data: HandleLabelDto) {\r\n    const whatsappContact = await this.whatsappNumber({ numbers: [data.number] });\r\n    if (whatsappContact.length === 0) {\r\n      throw new NotFoundException('Number not found');\r\n    }\r\n    const contact = whatsappContact[0];\r\n    if (!contact.exists) {\r\n      throw new NotFoundException('Number is not on WhatsApp');\r\n    }\r\n\r\n    try {\r\n      if (data.action === 'add') {\r\n        await this.client.addChatLabel(contact.jid, data.labelId);\r\n        await this.addLabel(data.labelId, this.instanceId, contact.jid);\r\n\r\n        return { numberJid: contact.jid, labelId: data.labelId, add: true };\r\n      }\r\n      if (data.action === 'remove') {\r\n        await this.client.removeChatLabel(contact.jid, data.labelId);\r\n        await this.removeLabel(data.labelId, this.instanceId, contact.jid);\r\n\r\n        return { numberJid: contact.jid, labelId: data.labelId, remove: true };\r\n      }\r\n    } catch (error) {\r\n      throw new BadRequestException(`Unable to ${data.action} label to chat`, error.toString());\r\n    }\r\n  }\r\n\r\n  // Group\r\n  private async updateGroupMetadataCache(groupJid: string) {\r\n    try {\r\n      const meta = await this.client.groupMetadata(groupJid);\r\n\r\n      const cacheConf = this.configService.get<CacheConf>('CACHE');\r\n\r\n      if ((cacheConf?.REDIS?.ENABLED && cacheConf?.REDIS?.URI !== '') || cacheConf?.LOCAL?.ENABLED) {\r\n        this.logger.verbose(`Updating cache for group: ${groupJid}`);\r\n        await groupMetadataCache.set(groupJid, {\r\n          timestamp: Date.now(),\r\n          data: meta,\r\n        });\r\n      }\r\n\r\n      return meta;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private getGroupMetadataCache = async (groupJid: string) => {\r\n    if (!isJidGroup(groupJid)) return null;\r\n\r\n    const cacheConf = this.configService.get<CacheConf>('CACHE');\r\n\r\n    if ((cacheConf?.REDIS?.ENABLED && cacheConf?.REDIS?.URI !== '') || cacheConf?.LOCAL?.ENABLED) {\r\n      if (await groupMetadataCache?.has(groupJid)) {\r\n        console.log(`Cache request for group: ${groupJid}`);\r\n        const meta = await groupMetadataCache.get(groupJid);\r\n\r\n        if (Date.now() - meta.timestamp > 3600000) {\r\n          await this.updateGroupMetadataCache(groupJid);\r\n        }\r\n\r\n        return meta.data;\r\n      }\r\n\r\n      console.log(`Cache request for group: ${groupJid} - not found`);\r\n      return await this.updateGroupMetadataCache(groupJid);\r\n    }\r\n\r\n    return await this.findGroup({ groupJid }, 'inner');\r\n  };\r\n\r\n  public async createGroup(create: CreateGroupDto) {\r\n    try {\r\n      const participants = (await this.whatsappNumber({ numbers: create.participants }))\r\n        .filter((participant) => participant.exists)\r\n        .map((participant) => participant.jid);\r\n      const { id } = await this.client.groupCreate(create.subject, participants);\r\n\r\n      if (create?.description) {\r\n        await this.client.groupUpdateDescription(id, create.description);\r\n      }\r\n\r\n      if (create?.promoteParticipants) {\r\n        await this.updateGParticipant({\r\n          groupJid: id,\r\n          action: 'promote',\r\n          participants: participants,\r\n        });\r\n      }\r\n\r\n      const group = await this.client.groupMetadata(id);\r\n\r\n      return group;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException('Error creating group', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateGroupPicture(picture: GroupPictureDto) {\r\n    try {\r\n      let pic: WAMediaUpload;\r\n      if (isURL(picture.image)) {\r\n        const timestamp = new Date().getTime();\r\n        const url = `${picture.image}?timestamp=${timestamp}`;\r\n\r\n        let config: any = {\r\n          responseType: 'arraybuffer',\r\n        };\r\n\r\n        if (this.localProxy?.enabled) {\r\n          config = {\r\n            ...config,\r\n            httpsAgent: makeProxyAgent({\r\n              host: this.localProxy.host,\r\n              port: this.localProxy.port,\r\n              protocol: this.localProxy.protocol,\r\n              username: this.localProxy.username,\r\n              password: this.localProxy.password,\r\n            }),\r\n          };\r\n        }\r\n\r\n        pic = (await axios.get(url, config)).data;\r\n      } else if (isBase64(picture.image)) {\r\n        pic = Buffer.from(picture.image, 'base64');\r\n      } else {\r\n        throw new BadRequestException('\"profilePicture\" must be a url or a base64');\r\n      }\r\n      await this.client.updateProfilePicture(picture.groupJid, pic);\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error update group picture', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateGroupSubject(data: GroupSubjectDto) {\r\n    try {\r\n      await this.client.groupUpdateSubject(data.groupJid, data.subject);\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating group subject', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateGroupDescription(data: GroupDescriptionDto) {\r\n    try {\r\n      await this.client.groupUpdateDescription(data.groupJid, data.description);\r\n\r\n      return { update: 'success' };\r\n    } catch (error) {\r\n      throw new InternalServerErrorException('Error updating group description', error.toString());\r\n    }\r\n  }\r\n\r\n  public async findGroup(id: GroupJid, reply: 'inner' | 'out' = 'out') {\r\n    try {\r\n      const group = await this.client.groupMetadata(id.groupJid);\r\n\r\n      if (!group) {\r\n        this.logger.error('Group not found');\r\n        return null;\r\n      }\r\n\r\n      const picture = await this.profilePicture(group.id);\r\n\r\n      return {\r\n        id: group.id,\r\n        subject: group.subject,\r\n        subjectOwner: group.subjectOwner,\r\n        subjectTime: group.subjectTime,\r\n        pictureUrl: picture.profilePictureUrl,\r\n        size: group.participants.length,\r\n        creation: group.creation,\r\n        owner: group.owner,\r\n        desc: group.desc,\r\n        descId: group.descId,\r\n        restrict: group.restrict,\r\n        announce: group.announce,\r\n        participants: group.participants,\r\n        isCommunity: group.isCommunity,\r\n        isCommunityAnnounce: group.isCommunityAnnounce,\r\n        linkedParent: group.linkedParent,\r\n      };\r\n    } catch (error) {\r\n      if (reply === 'inner') {\r\n        return;\r\n      }\r\n      throw new NotFoundException('Error fetching group', error.toString());\r\n    }\r\n  }\r\n\r\n  public async fetchAllGroups(getParticipants: GetParticipant) {\r\n    const fetch = Object.values(await this?.client?.groupFetchAllParticipating());\r\n\r\n    let groups = [];\r\n    for (const group of fetch) {\r\n      const picture = await this.profilePicture(group.id);\r\n\r\n      const result = {\r\n        id: group.id,\r\n        subject: group.subject,\r\n        subjectOwner: group.subjectOwner,\r\n        subjectTime: group.subjectTime,\r\n        pictureUrl: picture?.profilePictureUrl,\r\n        size: group.participants.length,\r\n        creation: group.creation,\r\n        owner: group.owner,\r\n        desc: group.desc,\r\n        descId: group.descId,\r\n        restrict: group.restrict,\r\n        announce: group.announce,\r\n        isCommunity: group.isCommunity,\r\n        isCommunityAnnounce: group.isCommunityAnnounce,\r\n        linkedParent: group.linkedParent,\r\n      };\r\n\r\n      if (getParticipants.getParticipants == 'true') {\r\n        result['participants'] = group.participants;\r\n      }\r\n\r\n      groups = [...groups, result];\r\n    }\r\n\r\n    return groups;\r\n  }\r\n\r\n  public async inviteCode(id: GroupJid) {\r\n    try {\r\n      const code = await this.client.groupInviteCode(id.groupJid);\r\n      return { inviteUrl: `https://chat.whatsapp.com/${code}`, inviteCode: code };\r\n    } catch (error) {\r\n      throw new NotFoundException('No invite code', error.toString());\r\n    }\r\n  }\r\n\r\n  public async inviteInfo(id: GroupInvite) {\r\n    try {\r\n      return await this.client.groupGetInviteInfo(id.inviteCode);\r\n    } catch (error) {\r\n      throw new NotFoundException('No invite info', id.inviteCode);\r\n    }\r\n  }\r\n\r\n  public async sendInvite(id: GroupSendInvite) {\r\n    try {\r\n      const inviteCode = await this.inviteCode({ groupJid: id.groupJid });\r\n\r\n      const inviteUrl = inviteCode.inviteUrl;\r\n\r\n      const numbers = id.numbers.map((number) => createJid(number));\r\n      const description = id.description ?? '';\r\n\r\n      const msg = `${description}\\n\\n${inviteUrl}`;\r\n\r\n      const message = {\r\n        conversation: msg,\r\n      };\r\n\r\n      for await (const number of numbers) {\r\n        await this.sendMessageWithTyping(number, message);\r\n      }\r\n\r\n      return { send: true, inviteUrl };\r\n    } catch (error) {\r\n      throw new NotFoundException('No send invite');\r\n    }\r\n  }\r\n\r\n  public async acceptInviteCode(id: AcceptGroupInvite) {\r\n    try {\r\n      const groupJid = await this.client.groupAcceptInvite(id.inviteCode);\r\n      return { accepted: true, groupJid: groupJid };\r\n    } catch (error) {\r\n      throw new NotFoundException('Accept invite error', error.toString());\r\n    }\r\n  }\r\n\r\n  public async revokeInviteCode(id: GroupJid) {\r\n    try {\r\n      const inviteCode = await this.client.groupRevokeInvite(id.groupJid);\r\n      return { revoked: true, inviteCode };\r\n    } catch (error) {\r\n      throw new NotFoundException('Revoke error', error.toString());\r\n    }\r\n  }\r\n\r\n  public async findParticipants(id: GroupJid) {\r\n    try {\r\n      const participants = (await this.client.groupMetadata(id.groupJid)).participants;\r\n      const contacts = await this.prismaRepository.contact.findMany({\r\n        where: {\r\n          instanceId: this.instanceId,\r\n          remoteJid: {\r\n            in: participants.map((p) => p.id),\r\n          },\r\n        },\r\n      });\r\n      const parsedParticipants = participants.map((participant) => {\r\n        const contact = contacts.find((c) => c.remoteJid === participant.id);\r\n        return {\r\n          ...participant,\r\n          name: participant.name ?? contact?.pushName,\r\n          imgUrl: participant.imgUrl ?? contact?.profilePicUrl,\r\n        };\r\n      });\r\n\r\n      const usersContacts = parsedParticipants.filter((c) => c.id.includes('@s.whatsapp'));\r\n      if (usersContacts) {\r\n        await saveOnWhatsappCache(usersContacts.map((c) => ({ remoteJid: c.id })));\r\n      }\r\n\r\n      return { participants: parsedParticipants };\r\n    } catch (error) {\r\n      console.error(error);\r\n      throw new NotFoundException('No participants', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateGParticipant(update: GroupUpdateParticipantDto) {\r\n    try {\r\n      const participants = update.participants.map((p) => createJid(p));\r\n      const updateParticipants = await this.client.groupParticipantsUpdate(\r\n        update.groupJid,\r\n        participants,\r\n        update.action,\r\n      );\r\n      return { updateParticipants: updateParticipants };\r\n    } catch (error) {\r\n      throw new BadRequestException('Error updating participants', error.toString());\r\n    }\r\n  }\r\n\r\n  public async updateGSetting(update: GroupUpdateSettingDto) {\r\n    try {\r\n      const updateSetting = await this.client.groupSettingUpdate(update.groupJid, update.action);\r\n      return { updateSetting: updateSetting };\r\n    } catch (error) {\r\n      throw new BadRequestException('Error updating setting', error.toString());\r\n    }\r\n  }\r\n\r\n  public async toggleEphemeral(update: GroupToggleEphemeralDto) {\r\n    try {\r\n      await this.client.groupToggleEphemeral(update.groupJid, update.expiration);\r\n      return { success: true };\r\n    } catch (error) {\r\n      throw new BadRequestException('Error updating setting', error.toString());\r\n    }\r\n  }\r\n\r\n  public async leaveGroup(id: GroupJid) {\r\n    try {\r\n      await this.client.groupLeave(id.groupJid);\r\n      return { groupJid: id.groupJid, leave: true };\r\n    } catch (error) {\r\n      throw new BadRequestException('Unable to leave the group', error.toString());\r\n    }\r\n  }\r\n\r\n  public async templateMessage() {\r\n    throw new Error('Method not available in the Baileys service');\r\n  }\r\n\r\n  private prepareMessage(message: proto.IWebMessageInfo): any {\r\n    const contentType = getContentType(message.message);\r\n    const contentMsg = message?.message[contentType] as any;\r\n\r\n    const messageRaw = {\r\n      key: message.key,\r\n      pushName: message.pushName,\r\n      status: status[message.status],\r\n      message: { ...message.message },\r\n      contextInfo: contentMsg?.contextInfo,\r\n      messageType: contentType || 'unknown',\r\n      messageTimestamp: message.messageTimestamp as number,\r\n      instanceId: this.instanceId,\r\n      source: getDevice(message.key.id),\r\n    };\r\n\r\n    if (!messageRaw.status && message.key.fromMe === false) {\r\n      messageRaw.status = status[3]; // DELIVERED MESSAGE\r\n    }\r\n\r\n    if (messageRaw.message.extendedTextMessage) {\r\n      messageRaw.messageType = 'conversation';\r\n      messageRaw.message.conversation = messageRaw.message.extendedTextMessage.text;\r\n      delete messageRaw.message.extendedTextMessage;\r\n    }\r\n\r\n    if (messageRaw.message.documentWithCaptionMessage) {\r\n      messageRaw.messageType = 'documentMessage';\r\n      messageRaw.message.documentMessage = messageRaw.message.documentWithCaptionMessage.message.documentMessage;\r\n      delete messageRaw.message.documentWithCaptionMessage;\r\n    }\r\n\r\n    const quotedMessage = messageRaw?.contextInfo?.quotedMessage;\r\n    if (quotedMessage) {\r\n      if (quotedMessage.extendedTextMessage) {\r\n        quotedMessage.conversation = quotedMessage.extendedTextMessage.text;\r\n        delete quotedMessage.extendedTextMessage;\r\n      }\r\n\r\n      if (quotedMessage.documentWithCaptionMessage) {\r\n        quotedMessage.documentMessage = quotedMessage.documentWithCaptionMessage.message.documentMessage;\r\n        delete quotedMessage.documentWithCaptionMessage;\r\n      }\r\n    }\r\n\r\n    return messageRaw;\r\n  }\r\n\r\n  private async syncChatwootLostMessages() {\r\n    if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED && this.localChatwoot?.enabled) {\r\n      const chatwootConfig = await this.findChatwoot();\r\n      const prepare = (message: any) => this.prepareMessage(message);\r\n      this.chatwootService.syncLostMessages({ instanceName: this.instance.name }, chatwootConfig, prepare);\r\n\r\n      const task = cron.schedule('0,30 * * * *', async () => {\r\n        this.chatwootService.syncLostMessages({ instanceName: this.instance.name }, chatwootConfig, prepare);\r\n      });\r\n      task.start();\r\n    }\r\n  }\r\n\r\n  private async updateMessagesReadedByTimestamp(remoteJid: string, timestamp?: number): Promise<number> {\r\n    if (timestamp === undefined || timestamp === null) return 0;\r\n\r\n    const result = await this.prismaRepository.message.updateMany({\r\n      where: {\r\n        AND: [\r\n          { key: { path: ['remoteJid'], equals: remoteJid } },\r\n          { key: { path: ['fromMe'], equals: false } },\r\n          { messageTimestamp: { lte: timestamp } },\r\n          {\r\n            OR: [{ status: null }, { status: status[3] }],\r\n          },\r\n        ],\r\n      },\r\n      data: { status: status[4] },\r\n    });\r\n\r\n    if (result) {\r\n      if (result.count > 0) {\r\n        this.updateChatUnreadMessages(remoteJid);\r\n      }\r\n\r\n      return result.count;\r\n    }\r\n\r\n    return 0;\r\n  }\r\n\r\n  private async updateChatUnreadMessages(remoteJid: string): Promise<number> {\r\n    const [chat, unreadMessages] = await Promise.all([\r\n      this.prismaRepository.chat.findFirst({ where: { remoteJid } }),\r\n      this.prismaRepository.message.count({\r\n        where: {\r\n          AND: [\r\n            { key: { path: ['remoteJid'], equals: remoteJid } },\r\n            { key: { path: ['fromMe'], equals: false } },\r\n            { status: { equals: status[3] } },\r\n          ],\r\n        },\r\n      }),\r\n    ]);\r\n\r\n    if (chat && chat.unreadMessages !== unreadMessages) {\r\n      await this.prismaRepository.chat.update({\r\n        where: { id: chat.id },\r\n        data: { unreadMessages },\r\n      });\r\n    }\r\n\r\n    return unreadMessages;\r\n  }\r\n\r\n  private async addLabel(labelId: string, instanceId: string, chatId: string) {\r\n    const id = cuid();\r\n\r\n    await this.prismaRepository.$executeRawUnsafe(\r\n      `INSERT INTO \"Chat\" (\"id\", \"instanceId\", \"remoteJid\", \"labels\", \"createdAt\", \"updatedAt\")\r\n       VALUES ($4, $2, $3, to_jsonb(ARRAY[$1]::text[]), NOW(), NOW()) ON CONFLICT (\"instanceId\", \"remoteJid\")\r\n     DO\r\n      UPDATE\r\n          SET \"labels\" = (\r\n          SELECT to_jsonb(array_agg(DISTINCT elem))\r\n          FROM (\r\n          SELECT jsonb_array_elements_text(\"Chat\".\"labels\") AS elem\r\n          UNION\r\n          SELECT $1::text AS elem\r\n          ) sub\r\n          ),\r\n          \"updatedAt\" = NOW();`,\r\n      labelId,\r\n      instanceId,\r\n      chatId,\r\n      id,\r\n    );\r\n  }\r\n\r\n  private async removeLabel(labelId: string, instanceId: string, chatId: string) {\r\n    const id = cuid();\r\n\r\n    await this.prismaRepository.$executeRawUnsafe(\r\n      `INSERT INTO \"Chat\" (\"id\", \"instanceId\", \"remoteJid\", \"labels\", \"createdAt\", \"updatedAt\")\r\n       VALUES ($4, $2, $3, '[]'::jsonb, NOW(), NOW()) ON CONFLICT (\"instanceId\", \"remoteJid\")\r\n     DO\r\n      UPDATE\r\n          SET \"labels\" = COALESCE (\r\n          (\r\n          SELECT jsonb_agg(elem)\r\n          FROM jsonb_array_elements_text(\"Chat\".\"labels\") AS elem\r\n          WHERE elem <> $1\r\n          ),\r\n          '[]'::jsonb\r\n          ),\r\n          \"updatedAt\" = NOW();`,\r\n      labelId,\r\n      instanceId,\r\n      chatId,\r\n      id,\r\n    );\r\n  }\r\n\r\n  public async baileysOnWhatsapp(jid: string) {\r\n    const response = await this.client.onWhatsApp(jid);\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysProfilePictureUrl(jid: string, type: 'image' | 'preview', timeoutMs: number) {\r\n    const response = await this.client.profilePictureUrl(jid, type, timeoutMs);\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysAssertSessions(jids: string[], force: boolean) {\r\n    const response = await this.client.assertSessions(jids, force);\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysCreateParticipantNodes(jids: string[], message: proto.IMessage, extraAttrs: any) {\r\n    const response = await this.client.createParticipantNodes(jids, message, extraAttrs);\r\n\r\n    const convertedResponse = {\r\n      ...response,\r\n      nodes: response.nodes.map((node: any) => ({\r\n        ...node,\r\n        content: node.content?.map((c: any) => ({\r\n          ...c,\r\n          content: c.content instanceof Uint8Array ? Buffer.from(c.content).toString('base64') : c.content,\r\n        })),\r\n      })),\r\n    };\r\n\r\n    return convertedResponse;\r\n  }\r\n\r\n  public async baileysSendNode(stanza: any) {\r\n    console.log('stanza', JSON.stringify(stanza));\r\n    const response = await this.client.sendNode(stanza);\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysGetUSyncDevices(jids: string[], useCache: boolean, ignoreZeroDevices: boolean) {\r\n    const response = await this.client.getUSyncDevices(jids, useCache, ignoreZeroDevices);\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysGenerateMessageTag() {\r\n    const response = await this.client.generateMessageTag();\r\n\r\n    return response;\r\n  }\r\n\r\n  public async baileysSignalRepositoryDecryptMessage(jid: string, type: 'pkmsg' | 'msg', ciphertext: string) {\r\n    try {\r\n      const ciphertextBuffer = Buffer.from(ciphertext, 'base64');\r\n\r\n      const response = await this.client.signalRepository.decryptMessage({\r\n        jid,\r\n        type,\r\n        ciphertext: ciphertextBuffer,\r\n      });\r\n\r\n      return response instanceof Uint8Array ? Buffer.from(response).toString('base64') : response;\r\n    } catch (error) {\r\n      this.logger.error('Error decrypting message:');\r\n      this.logger.error(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  public async baileysGetAuthState() {\r\n    const response = {\r\n      me: this.client.authState.creds.me,\r\n      account: this.client.authState.creds.account,\r\n    };\r\n\r\n    return response;\r\n  }\r\n}\r\n","import { prismaRepository } from '@api/server.module';\r\nimport { configService, Database } from '@config/env.config';\r\nimport dayjs from 'dayjs';\r\n\r\nfunction getAvailableNumbers(remoteJid: string) {\r\n  const numbersAvailable: string[] = [];\r\n\r\n  if (remoteJid.startsWith('+')) {\r\n    remoteJid = remoteJid.slice(1);\r\n  }\r\n\r\n  const [number, domain] = remoteJid.split('@');\r\n\r\n  // Brazilian numbers\r\n  if (remoteJid.startsWith('55')) {\r\n    const numberWithDigit =\r\n      number.slice(4, 5) === '9' && number.length === 13 ? number : `${number.slice(0, 4)}9${number.slice(4)}`;\r\n    const numberWithoutDigit = number.length === 12 ? number : number.slice(0, 4) + number.slice(5);\r\n\r\n    numbersAvailable.push(numberWithDigit);\r\n    numbersAvailable.push(numberWithoutDigit);\r\n  }\r\n\r\n  // Mexican/Argentina numbers\r\n  // Ref: https://faq.whatsapp.com/1294841057948784\r\n  else if (number.startsWith('52') || number.startsWith('54')) {\r\n    let prefix = '';\r\n    if (number.startsWith('52')) {\r\n      prefix = '1';\r\n    }\r\n    if (number.startsWith('54')) {\r\n      prefix = '9';\r\n    }\r\n\r\n    const numberWithDigit =\r\n      number.slice(2, 3) === prefix && number.length === 13\r\n        ? number\r\n        : `${number.slice(0, 2)}${prefix}${number.slice(2)}`;\r\n    const numberWithoutDigit = number.length === 12 ? number : number.slice(0, 2) + number.slice(3);\r\n\r\n    numbersAvailable.push(numberWithDigit);\r\n    numbersAvailable.push(numberWithoutDigit);\r\n  }\r\n\r\n  // Other countries\r\n  else {\r\n    numbersAvailable.push(remoteJid);\r\n  }\r\n\r\n  return numbersAvailable.map((number) => `${number}@${domain}`);\r\n}\r\n\r\ninterface ISaveOnWhatsappCacheParams {\r\n  remoteJid: string;\r\n}\r\nexport async function saveOnWhatsappCache(data: ISaveOnWhatsappCacheParams[]) {\r\n  if (configService.get<Database>('DATABASE').SAVE_DATA.IS_ON_WHATSAPP) {\r\n    const upsertsQuery = data.map((item) => {\r\n      const remoteJid = item.remoteJid.startsWith('+') ? item.remoteJid.slice(1) : item.remoteJid;\r\n      const numbersAvailable = getAvailableNumbers(remoteJid);\r\n\r\n      return prismaRepository.isOnWhatsapp.upsert({\r\n        create: { remoteJid: remoteJid, jidOptions: numbersAvailable.join(',') },\r\n        update: { jidOptions: numbersAvailable.join(',') },\r\n        where: { remoteJid: remoteJid },\r\n      });\r\n    });\r\n\r\n    await prismaRepository.$transaction(upsertsQuery);\r\n  }\r\n}\r\n\r\nexport async function getOnWhatsappCache(remoteJids: string[]) {\r\n  let results: {\r\n    remoteJid: string;\r\n    number: string;\r\n    jidOptions: string[];\r\n  }[] = [];\r\n\r\n  if (configService.get<Database>('DATABASE').SAVE_DATA.IS_ON_WHATSAPP) {\r\n    const remoteJidsWithoutPlus = remoteJids.map((remoteJid) => getAvailableNumbers(remoteJid)).flat();\r\n\r\n    const onWhatsappCache = await prismaRepository.isOnWhatsapp.findMany({\r\n      where: {\r\n        OR: remoteJidsWithoutPlus.map((remoteJid) => ({ jidOptions: { contains: remoteJid } })),\r\n        updatedAt: {\r\n          gte: dayjs().subtract(configService.get<Database>('DATABASE').SAVE_DATA.IS_ON_WHATSAPP_DAYS, 'days').toDate(),\r\n        },\r\n      },\r\n    });\r\n\r\n    results = onWhatsappCache.map((item) => ({\r\n      remoteJid: item.remoteJid,\r\n      number: item.remoteJid.split('@')[0],\r\n      jidOptions: item.jidOptions.split(','),\r\n    }));\r\n  }\r\n\r\n  return results;\r\n}\r\n","import { join } from 'path';\r\n\r\nexport const ROOT_DIR = process.cwd();\r\nexport const INSTANCE_DIR = join(ROOT_DIR, 'instances');\r\nexport const SRC_DIR = join(ROOT_DIR, 'src');\r\nexport const AUTH_DIR = join(ROOT_DIR, 'store', 'auth');\r\nexport const STORE_DIR = join(ROOT_DIR, 'store');\r\n","import { prismaRepository } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { INSTANCE_DIR } from '@config/path.config';\r\nimport { AuthenticationState, BufferJSON, initAuthCreds, WAProto as proto } from 'baileys';\r\nimport fs from 'fs/promises';\r\nimport path from 'path';\r\n\r\nconst fixFileName = (file: string): string | undefined => {\r\n  if (!file) {\r\n    return undefined;\r\n  }\r\n  const replacedSlash = file.replace(/\\//g, '__');\r\n  const replacedColon = replacedSlash.replace(/:/g, '-');\r\n  return replacedColon;\r\n};\r\n\r\nexport async function keyExists(sessionId: string): Promise<any> {\r\n  try {\r\n    const key = await prismaRepository.session.findUnique({ where: { sessionId: sessionId } });\r\n    return !!key;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function saveKey(sessionId: string, keyJson: any): Promise<any> {\r\n  const exists = await keyExists(sessionId);\r\n  try {\r\n    if (!exists)\r\n      return await prismaRepository.session.create({\r\n        data: {\r\n          sessionId: sessionId,\r\n          creds: JSON.stringify(keyJson),\r\n        },\r\n      });\r\n    await prismaRepository.session.update({\r\n      where: { sessionId: sessionId },\r\n      data: { creds: JSON.stringify(keyJson) },\r\n    });\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getAuthKey(sessionId: string): Promise<any> {\r\n  try {\r\n    const register = await keyExists(sessionId);\r\n    if (!register) return null;\r\n    const auth = await prismaRepository.session.findUnique({ where: { sessionId: sessionId } });\r\n    return JSON.parse(auth?.creds);\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function deleteAuthKey(sessionId: string): Promise<any> {\r\n  try {\r\n    const register = await keyExists(sessionId);\r\n    if (!register) return;\r\n    await prismaRepository.session.delete({ where: { sessionId: sessionId } });\r\n  } catch (error) {\r\n    return;\r\n  }\r\n}\r\n\r\nasync function fileExists(file: string): Promise<any> {\r\n  try {\r\n    const stat = await fs.stat(file);\r\n    if (stat.isFile()) return true;\r\n  } catch (error) {\r\n    return;\r\n  }\r\n}\r\n\r\nexport default async function useMultiFileAuthStatePrisma(\r\n  sessionId: string,\r\n  cache: CacheService,\r\n): Promise<{\r\n  state: AuthenticationState;\r\n  saveCreds: () => Promise<void>;\r\n}> {\r\n  const localFolder = path.join(INSTANCE_DIR, sessionId);\r\n  const localFile = (key: string) => path.join(localFolder, fixFileName(key) + '.json');\r\n  await fs.mkdir(localFolder, { recursive: true });\r\n\r\n  async function writeData(data: any, key: string): Promise<any> {\r\n    const dataString = JSON.stringify(data, BufferJSON.replacer);\r\n\r\n    if (key != 'creds') {\r\n      if (process.env.CACHE_REDIS_ENABLED === 'true') {\r\n        return await cache.hSet(sessionId, key, data);\r\n      } else {\r\n        await fs.writeFile(localFile(key), dataString);\r\n        return;\r\n      }\r\n    }\r\n    await saveKey(sessionId, dataString);\r\n    return;\r\n  }\r\n\r\n  async function readData(key: string): Promise<any> {\r\n    try {\r\n      let rawData;\r\n\r\n      if (key != 'creds') {\r\n        if (process.env.CACHE_REDIS_ENABLED === 'true') {\r\n          return await cache.hGet(sessionId, key);\r\n        } else {\r\n          if (!(await fileExists(localFile(key)))) return null;\r\n          rawData = await fs.readFile(localFile(key), { encoding: 'utf-8' });\r\n          return JSON.parse(rawData, BufferJSON.reviver);\r\n        }\r\n      } else {\r\n        rawData = await getAuthKey(sessionId);\r\n      }\r\n\r\n      const parsedData = JSON.parse(rawData, BufferJSON.reviver);\r\n      return parsedData;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async function removeData(key: string): Promise<any> {\r\n    try {\r\n      if (key != 'creds') {\r\n        if (process.env.CACHE_REDIS_ENABLED === 'true') {\r\n          return await cache.hDelete(sessionId, key);\r\n        } else {\r\n          await fs.unlink(localFile(key));\r\n        }\r\n      } else {\r\n        await deleteAuthKey(sessionId);\r\n      }\r\n    } catch (error) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  let creds = await readData('creds');\r\n  if (!creds) {\r\n    creds = initAuthCreds();\r\n    await writeData(creds, 'creds');\r\n  }\r\n\r\n  return {\r\n    state: {\r\n      creds,\r\n      keys: {\r\n        get: async (type, ids) => {\r\n          const data = {};\r\n          await Promise.all(\r\n            ids.map(async (id) => {\r\n              let value = await readData(`${type}-${id}`);\r\n              if (type === 'app-state-sync-key' && value) {\r\n                value = proto.Message.AppStateSyncKeyData.fromObject(value);\r\n              }\r\n\r\n              data[id] = value;\r\n            }),\r\n          );\r\n          return data;\r\n        },\r\n        set: async (data) => {\r\n          const tasks = [];\r\n          for (const category in data) {\r\n            for (const id in data[category]) {\r\n              const value = data[category][id];\r\n              const key = `${category}-${id}`;\r\n\r\n              tasks.push(value ? writeData(value, key) : removeData(key));\r\n            }\r\n          }\r\n          await Promise.all(tasks);\r\n        },\r\n      },\r\n    },\r\n    saveCreds: () => {\r\n      return writeData(creds, 'creds');\r\n    },\r\n  };\r\n}\r\n","/**\r\n * \r\n *  @author jrCleber                                                             \r\n *  @filename use-multi-file-auth-state-provider-files.ts                              \r\n *  Developed by: Cleber Wilson                                                  \r\n *  Creation date: May 31, 2024                                                 \r\n *  Contact: contato@codechat.dev                                                \r\n * \r\n *  @copyright  Cleber Wilson 2023. All rights reserved.                        \r\n *  Licensed under the Apache License, Version 2.0                               \r\n *                                                                               \r\n *   @license \"https://github.com/code-chat-br/whatsapp-api/blob/main/LICENSE\"   \r\n *                                                                               \r\n *  You may not use this file except in compliance with the License.             \r\n *  You may obtain a copy of the License at                                      \r\n *                                                                               \r\n *     http://www.apache.org/licenses/LICENSE-2.0                                \r\n *                                                                               \r\n *  Unless required by applicable law or agreed to in writing, software          \r\n *  distributed under the License is distributed on an \"AS IS\" BASIS,            \r\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     \r\n *                                                                               \r\n *  See the License for the specific language governing permissions and          \r\n *  limitations under the License.                                               \r\n *                                                                               \r\n *  @type {AuthState}                                                            \r\n *  @function useMultiFileAuthStateRedisDb                                       \r\n *  @returns {Promise<AuthState>}                                                \r\n * \r\n *  @important                                                                   \r\n *  For any future changes to the code in this file, it is recommended to        \r\n *  contain, together with the modification, the information of the developer    \r\n *  who changed it and the date of modification.                                 \r\n * \r\n */\r\n\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { Logger } from '@config/logger.config';\r\nimport { AuthenticationCreds, AuthenticationState, BufferJSON, initAuthCreds, proto, SignalDataTypeMap } from 'baileys';\r\nimport { isNotEmpty } from 'class-validator';\r\n\r\nexport type AuthState = { state: AuthenticationState; saveCreds: () => Promise<void> };\r\n\r\nexport class AuthStateProvider {\r\n  constructor(private readonly providerFiles: ProviderFiles) {}\r\n\r\n  private readonly logger = new Logger('AuthStateProvider');\r\n\r\n  public async authStateProvider(instance: string): Promise<AuthState> {\r\n    const [, error] = await this.providerFiles.create(instance);\r\n    if (error) {\r\n      this.logger.error(['Failed to create folder on file server', error?.message, error?.stack]);\r\n      return;\r\n    }\r\n\r\n    const writeData = async (data: any, key: string): Promise<any> => {\r\n      const json = JSON.stringify(data, BufferJSON.replacer);\r\n      const [response, error] = await this.providerFiles.write(instance, key, {\r\n        data: json,\r\n      });\r\n      if (error) {\r\n        // this.logger.error(['writeData', error?.message, error?.stack]);\r\n        return;\r\n      }\r\n      return response;\r\n    };\r\n\r\n    const readData = async (key: string): Promise<any> => {\r\n      const [response, error] = await this.providerFiles.read(instance, key);\r\n      if (error) {\r\n        // this.logger.error(['readData', error?.message, error?.stack]);\r\n        return;\r\n      }\r\n      if (isNotEmpty(response?.data)) {\r\n        return JSON.parse(JSON.stringify(response.data), BufferJSON.reviver);\r\n      }\r\n    };\r\n\r\n    const removeData = async (key: string) => {\r\n      const [response, error] = await this.providerFiles.delete(instance, key);\r\n      if (error) {\r\n        // this.logger.error(['removeData', error?.message, error?.stack]);\r\n        return;\r\n      }\r\n\r\n      return response;\r\n    };\r\n\r\n    const creds: AuthenticationCreds = (await readData('creds')) || initAuthCreds();\r\n\r\n    return {\r\n      state: {\r\n        creds,\r\n        keys: {\r\n          get: async (type, ids: string[]) => {\r\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n            // @ts-ignore\r\n            const data: { [_: string]: SignalDataTypeMap[type] } = {};\r\n            await Promise.all(\r\n              ids.map(async (id) => {\r\n                let value = await readData(`${type}-${id}`);\r\n                if (type === 'app-state-sync-key' && value) {\r\n                  value = proto.Message.AppStateSyncKeyData.fromObject(value);\r\n                }\r\n\r\n                data[id] = value;\r\n              }),\r\n            );\r\n\r\n            return data;\r\n          },\r\n          set: async (data: any) => {\r\n            const tasks: Promise<void>[] = [];\r\n            for (const category in data) {\r\n              for (const id in data[category]) {\r\n                const value = data[category][id];\r\n                const key = `${category}-${id}`;\r\n                tasks.push(value ? await writeData(value, key) : await removeData(key));\r\n              }\r\n            }\r\n\r\n            await Promise.all(tasks);\r\n          },\r\n        },\r\n      },\r\n      saveCreds: async () => {\r\n        return await writeData(creds, 'creds');\r\n      },\r\n    };\r\n  }\r\n}\r\n","import { CacheService } from '@api/services/cache.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { AuthenticationCreds, AuthenticationState, initAuthCreds, proto, SignalDataTypeMap } from 'baileys';\r\n\r\nexport async function useMultiFileAuthStateRedisDb(\r\n  instanceName: string,\r\n  cache: CacheService,\r\n): Promise<{\r\n  state: AuthenticationState;\r\n  saveCreds: () => Promise<void>;\r\n}> {\r\n  const logger = new Logger('useMultiFileAuthStateRedisDb');\r\n\r\n  const writeData = async (data: any, key: string): Promise<any> => {\r\n    try {\r\n      return await cache.hSet(instanceName, key, data);\r\n    } catch (error) {\r\n      return logger.error({ localError: 'writeData', error });\r\n    }\r\n  };\r\n\r\n  const readData = async (key: string): Promise<any> => {\r\n    try {\r\n      return await cache.hGet(instanceName, key);\r\n    } catch (error) {\r\n      logger.error({ localError: 'readData', error });\r\n      return;\r\n    }\r\n  };\r\n\r\n  const removeData = async (key: string) => {\r\n    try {\r\n      return await cache.hDelete(instanceName, key);\r\n    } catch (error) {\r\n      logger.error({ readData: 'removeData', error });\r\n    }\r\n  };\r\n\r\n  const creds: AuthenticationCreds = (await readData('creds')) || initAuthCreds();\r\n\r\n  return {\r\n    state: {\r\n      creds,\r\n      keys: {\r\n        get: async (type, ids: string[]) => {\r\n          // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n          // @ts-ignore\r\n          const data: { [_: string]: SignalDataTypeMap[type] } = {};\r\n          await Promise.all(\r\n            ids.map(async (id) => {\r\n              let value = await readData(`${type}-${id}`);\r\n              if (type === 'app-state-sync-key' && value) {\r\n                value = proto.Message.AppStateSyncKeyData.fromObject(value);\r\n              }\r\n\r\n              data[id] = value;\r\n            }),\r\n          );\r\n\r\n          return data;\r\n        },\r\n        set: async (data: any) => {\r\n          const tasks: Promise<void>[] = [];\r\n          for (const category in data) {\r\n            for (const id in data[category]) {\r\n              const value = data[category][id];\r\n              const key = `${category}-${id}`;\r\n              tasks.push(value ? await writeData(value, key) : await removeData(key));\r\n            }\r\n          }\r\n\r\n          await Promise.all(tasks);\r\n        },\r\n      },\r\n    },\r\n    saveCreds: async () => {\r\n      return await writeData(creds, 'creds');\r\n    },\r\n  };\r\n}\r\n","import { ConnectionState, WAConnectionState, WASocket } from 'baileys';\r\nimport { io, Socket } from 'socket.io-client';\r\n\r\nimport { ClientToServerEvents, ServerToClientEvents } from './transport.type';\r\n\r\nlet baileys_connection_state: WAConnectionState = 'close';\r\n\r\nexport const useVoiceCallsBaileys = async (\r\n  wavoip_token: string,\r\n  baileys_sock: WASocket,\r\n  status?: WAConnectionState,\r\n  logger?: boolean,\r\n) => {\r\n  baileys_connection_state = status ?? 'close';\r\n\r\n  const socket: Socket<ServerToClientEvents, ClientToServerEvents> = io('https://devices.wavoip.com/baileys', {\r\n    transports: ['websocket'],\r\n    path: `/${wavoip_token}/websocket`,\r\n  });\r\n\r\n  socket.on('connect', () => {\r\n    if (logger) console.log('[*] - Wavoip connected', socket.id);\r\n\r\n    socket.emit(\r\n      'init',\r\n      baileys_sock.authState.creds.me,\r\n      baileys_sock.authState.creds.account,\r\n      baileys_connection_state,\r\n    );\r\n  });\r\n\r\n  socket.on('disconnect', () => {\r\n    if (logger) console.log('[*] - Wavoip disconnect');\r\n  });\r\n\r\n  socket.on('connect_error', (error) => {\r\n    if (socket.active) {\r\n      if (logger)\r\n        console.log(\r\n          '[*] - Wavoip connection error temporary failure, the socket will automatically try to reconnect',\r\n          error,\r\n        );\r\n    } else {\r\n      if (logger) console.log('[*] - Wavoip connection error', error.message);\r\n    }\r\n  });\r\n\r\n  socket.on('onWhatsApp', async (jid, callback) => {\r\n    try {\r\n      const response: any = await baileys_sock.onWhatsApp(jid);\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call onWhatsApp function', response, jid);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call onWhatsApp function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('profilePictureUrl', async (jid, type, timeoutMs, callback) => {\r\n    try {\r\n      const response = await baileys_sock.profilePictureUrl(jid, type, timeoutMs);\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call profilePictureUrl function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call profilePictureUrl function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('assertSessions', async (jids, force, callback) => {\r\n    try {\r\n      const response = await baileys_sock.assertSessions(jids, force);\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call assertSessions function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call assertSessions function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('createParticipantNodes', async (jids, message, extraAttrs, callback) => {\r\n    try {\r\n      const response = await baileys_sock.createParticipantNodes(jids, message, extraAttrs);\r\n\r\n      callback(response, true);\r\n\r\n      if (logger) console.log('[*] Success on call createParticipantNodes function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call createParticipantNodes function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('getUSyncDevices', async (jids, useCache, ignoreZeroDevices, callback) => {\r\n    try {\r\n      const response = await baileys_sock.getUSyncDevices(jids, useCache, ignoreZeroDevices);\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call getUSyncDevices function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call getUSyncDevices function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('generateMessageTag', async (callback) => {\r\n    try {\r\n      const response = await baileys_sock.generateMessageTag();\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call generateMessageTag function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call generateMessageTag function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('sendNode', async (stanza, callback) => {\r\n    try {\r\n      console.log('sendNode', JSON.stringify(stanza));\r\n      const response = await baileys_sock.sendNode(stanza);\r\n\r\n      callback(true);\r\n\r\n      if (logger) console.log('[*] Success on call sendNode function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call sendNode function', error);\r\n    }\r\n  });\r\n\r\n  socket.on('signalRepository:decryptMessage', async (jid, type, ciphertext, callback) => {\r\n    try {\r\n      const response = await baileys_sock.signalRepository.decryptMessage({\r\n        jid: jid,\r\n        type: type,\r\n        ciphertext: ciphertext,\r\n      });\r\n\r\n      callback(response);\r\n\r\n      if (logger) console.log('[*] Success on call signalRepository:decryptMessage function', response);\r\n    } catch (error) {\r\n      if (logger) console.error('[*] Error on call signalRepository:decryptMessage function', error);\r\n    }\r\n  });\r\n\r\n  // we only use this connection data to inform the webphone that the device is connected and creeds account to generate e2e whatsapp key for make call packets\r\n  baileys_sock.ev.on('connection.update', (update: Partial<ConnectionState>) => {\r\n    const { connection } = update;\r\n\r\n    if (connection) {\r\n      baileys_connection_state = connection;\r\n      socket\r\n        .timeout(1000)\r\n        .emit(\r\n          'connection.update:status',\r\n          baileys_sock.authState.creds.me,\r\n          baileys_sock.authState.creds.account,\r\n          connection,\r\n        );\r\n    }\r\n\r\n    if (update.qr) {\r\n      socket.timeout(1000).emit('connection.update:qr', update.qr);\r\n    }\r\n  });\r\n\r\n  baileys_sock.ws.on('CB:call', (packet) => {\r\n    if (logger) console.log('[*] Signling received');\r\n    socket.volatile.timeout(1000).emit('CB:call', packet);\r\n  });\r\n\r\n  baileys_sock.ws.on('CB:ack,class:call', (packet) => {\r\n    if (logger) console.log('[*] Signling ack received');\r\n    socket.volatile.timeout(1000).emit('CB:ack,class:call', packet);\r\n  });\r\n\r\n  return socket;\r\n};\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Integration } from '@api/types/wa.types';\r\nimport { ConfigService } from '@config/env.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport EventEmitter2 from 'eventemitter2';\r\n\r\nimport { EvolutionStartupService } from './evolution/evolution.channel.service';\r\nimport { BusinessStartupService } from './meta/whatsapp.business.service';\r\nimport { BaileysStartupService } from './whatsapp/whatsapp.baileys.service';\r\n\r\ntype ChannelDataType = {\r\n  configService: ConfigService;\r\n  eventEmitter: EventEmitter2;\r\n  prismaRepository: PrismaRepository;\r\n  cache: CacheService;\r\n  chatwootCache: CacheService;\r\n  baileysCache: CacheService;\r\n  providerFiles: ProviderFiles;\r\n};\r\n\r\nexport interface ChannelControllerInterface {\r\n  receiveWebhook(data: any): Promise<any>;\r\n}\r\n\r\nexport class ChannelController {\r\n  public prismaRepository: PrismaRepository;\r\n  public waMonitor: WAMonitoringService;\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    this.prisma = prismaRepository;\r\n    this.monitor = waMonitor;\r\n  }\r\n\r\n  public set prisma(prisma: PrismaRepository) {\r\n    this.prismaRepository = prisma;\r\n  }\r\n\r\n  public get prisma() {\r\n    return this.prismaRepository;\r\n  }\r\n\r\n  public set monitor(waMonitor: WAMonitoringService) {\r\n    this.waMonitor = waMonitor;\r\n  }\r\n\r\n  public get monitor() {\r\n    return this.waMonitor;\r\n  }\r\n\r\n  public init(instanceData: InstanceDto, data: ChannelDataType) {\r\n    if (!instanceData.token && instanceData.integration === Integration.WHATSAPP_BUSINESS) {\r\n      throw new BadRequestException('token is required');\r\n    }\r\n\r\n    if (instanceData.integration === Integration.WHATSAPP_BUSINESS) {\r\n      return new BusinessStartupService(\r\n        data.configService,\r\n        data.eventEmitter,\r\n        data.prismaRepository,\r\n        data.cache,\r\n        data.chatwootCache,\r\n        data.baileysCache,\r\n        data.providerFiles,\r\n      );\r\n    }\r\n\r\n    if (instanceData.integration === Integration.EVOLUTION) {\r\n      return new EvolutionStartupService(\r\n        data.configService,\r\n        data.eventEmitter,\r\n        data.prismaRepository,\r\n        data.cache,\r\n        data.chatwootCache,\r\n      );\r\n    }\r\n\r\n    if (instanceData.integration === Integration.WHATSAPP_BAILEYS) {\r\n      return new BaileysStartupService(\r\n        data.configService,\r\n        data.eventEmitter,\r\n        data.prismaRepository,\r\n        data.cache,\r\n        data.chatwootCache,\r\n        data.baileysCache,\r\n        data.providerFiles,\r\n      );\r\n    }\r\n\r\n    return null;\r\n  }\r\n}\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Logger } from '@config/logger.config';\r\n\r\nimport { ChannelController, ChannelControllerInterface } from '../channel.controller';\r\n\r\nexport class EvolutionController extends ChannelController implements ChannelControllerInterface {\r\n  private readonly logger = new Logger('EvolutionController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor);\r\n  }\r\n\r\n  integrationEnabled: boolean;\r\n\r\n  public async receiveWebhook(data: any) {\r\n    const numberId = data.numberId;\r\n\r\n    if (!numberId) {\r\n      this.logger.error('WebhookService -> receiveWebhookEvolution -> numberId not found');\r\n      return;\r\n    }\r\n\r\n    const instance = await this.prismaRepository.instance.findFirst({\r\n      where: { number: numberId },\r\n    });\r\n\r\n    if (!instance) {\r\n      this.logger.error('WebhookService -> receiveWebhook -> instance not found');\r\n      return;\r\n    }\r\n\r\n    await this.waMonitor.waInstances[instance.name].connectToWhatsapp(data);\r\n\r\n    return {\r\n      status: 'success',\r\n    };\r\n  }\r\n}\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport axios from 'axios';\r\n\r\nimport { ChannelController, ChannelControllerInterface } from '../channel.controller';\r\n\r\nexport class MetaController extends ChannelController implements ChannelControllerInterface {\r\n  private readonly logger = new Logger('MetaController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor);\r\n  }\r\n\r\n  integrationEnabled: boolean;\r\n\r\n  public async receiveWebhook(data: any) {\r\n    if (data.object === 'whatsapp_business_account') {\r\n      if (data.entry[0]?.changes[0]?.field === 'message_template_status_update') {\r\n        const template = await this.prismaRepository.template.findFirst({\r\n          where: { templateId: `${data.entry[0].changes[0].value.message_template_id}` },\r\n        });\r\n\r\n        if (!template) {\r\n          console.log('template not found');\r\n          return;\r\n        }\r\n\r\n        const { webhookUrl } = template;\r\n\r\n        await axios.post(webhookUrl, data.entry[0].changes[0].value, {\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      data.entry?.forEach(async (entry: any) => {\r\n        const numberId = entry.changes[0].value.metadata.phone_number_id;\r\n\r\n        if (!numberId) {\r\n          this.logger.error('WebhookService -> receiveWebhookMeta -> numberId not found');\r\n          return {\r\n            status: 'success',\r\n          };\r\n        }\r\n\r\n        const instance = await this.prismaRepository.instance.findFirst({\r\n          where: { number: numberId },\r\n        });\r\n\r\n        if (!instance) {\r\n          this.logger.error('WebhookService -> receiveWebhookMeta -> instance not found');\r\n          return {\r\n            status: 'success',\r\n          };\r\n        }\r\n\r\n        await this.waMonitor.waInstances[instance.name].connectToWhatsapp(data);\r\n\r\n        return {\r\n          status: 'success',\r\n        };\r\n      });\r\n    }\r\n\r\n    return {\r\n      status: 'success',\r\n    };\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\n\r\nexport class BaileysController {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  public async onWhatsapp({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysOnWhatsapp(body?.jid);\r\n  }\r\n\r\n  public async profilePictureUrl({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysProfilePictureUrl(body?.jid, body?.type, body?.timeoutMs);\r\n  }\r\n\r\n  public async assertSessions({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysAssertSessions(body?.jids, body?.force);\r\n  }\r\n\r\n  public async createParticipantNodes({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysCreateParticipantNodes(body?.jids, body?.message, body?.extraAttrs);\r\n  }\r\n\r\n  public async getUSyncDevices({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysGetUSyncDevices(body?.jids, body?.useCache, body?.ignoreZeroDevices);\r\n  }\r\n\r\n  public async generateMessageTag({ instanceName }: InstanceDto) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysGenerateMessageTag();\r\n  }\r\n\r\n  public async sendNode({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysSendNode(body?.stanza);\r\n  }\r\n\r\n  public async signalRepositoryDecryptMessage({ instanceName }: InstanceDto, body: any) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysSignalRepositoryDecryptMessage(body?.jid, body?.type, body?.ciphertext);\r\n  }\r\n\r\n  public async getAuthState({ instanceName }: InstanceDto) {\r\n    const instance = this.waMonitor.waInstances[instanceName];\r\n\r\n    return instance.baileysGetAuthState();\r\n  }\r\n}\r\n","function normalizeString(str: string): string {\r\n  return str\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .toLowerCase();\r\n}\r\n\r\nexport function advancedOperatorsSearch(data: string, query: string): boolean {\r\n  const filters = query.split(' ').reduce((acc: Record<string, string[]>, filter) => {\r\n    const [operator, ...values] = filter.split(':');\r\n    const value = values.join(':');\r\n\r\n    if (!acc[operator]) {\r\n      acc[operator] = [];\r\n    }\r\n    acc[operator].push(value);\r\n    return acc;\r\n  }, {});\r\n\r\n  const normalizedItem = normalizeString(data);\r\n\r\n  return Object.entries(filters).every(([operator, values]) => {\r\n    return values.some((val) => {\r\n      const subValues = val.split(',');\r\n      return subValues.every((subVal) => {\r\n        const normalizedSubVal = normalizeString(subVal);\r\n\r\n        switch (operator.toLowerCase()) {\r\n          case 'contains':\r\n            return normalizedItem.includes(normalizedSubVal);\r\n          case 'notcontains':\r\n            return !normalizedItem.includes(normalizedSubVal);\r\n          case 'startswith':\r\n            return normalizedItem.startsWith(normalizedSubVal);\r\n          case 'endswith':\r\n            return normalizedItem.endsWith(normalizedSubVal);\r\n          case 'exact':\r\n            return normalizedItem === normalizedSubVal;\r\n          default:\r\n            return false;\r\n        }\r\n      });\r\n    });\r\n  });\r\n}\r\n","import { advancedOperatorsSearch } from './advancedOperatorsSearch';\r\n\r\nexport const findBotByTrigger = async (botRepository: any, content: string, instanceId: string) => {\r\n  // Check for triggerType 'all'\r\n  const findTriggerAll = await botRepository.findFirst({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'all',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  if (findTriggerAll) return findTriggerAll;\r\n\r\n  const findTriggerAdvanced = await botRepository.findMany({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'advanced',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n  for (const advanced of findTriggerAdvanced) {\r\n    if (advancedOperatorsSearch(content, advanced.triggerValue)) {\r\n      return advanced;\r\n    }\r\n  }\r\n\r\n  // Check for exact match\r\n  const findTriggerEquals = await botRepository.findFirst({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'keyword',\r\n      triggerOperator: 'equals',\r\n      triggerValue: content,\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  if (findTriggerEquals) return findTriggerEquals;\r\n\r\n  // Check for regex match\r\n  const findRegex = await botRepository.findMany({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'keyword',\r\n      triggerOperator: 'regex',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  let findTriggerRegex = null;\r\n\r\n  for (const regex of findRegex) {\r\n    const regexValue = new RegExp(regex.triggerValue);\r\n\r\n    if (regexValue.test(content)) {\r\n      findTriggerRegex = regex;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (findTriggerRegex) return findTriggerRegex;\r\n\r\n  // Check for startsWith match\r\n  const findStartsWith = await botRepository.findMany({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'keyword',\r\n      triggerOperator: 'startsWith',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  let findTriggerStartsWith = null;\r\n\r\n  for (const startsWith of findStartsWith) {\r\n    if (content.startsWith(startsWith.triggerValue)) {\r\n      findTriggerStartsWith = startsWith;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (findTriggerStartsWith) return findTriggerStartsWith;\r\n\r\n  // Check for endsWith match\r\n  const findEndsWith = await botRepository.findMany({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'keyword',\r\n      triggerOperator: 'endsWith',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  let findTriggerEndsWith = null;\r\n\r\n  for (const endsWith of findEndsWith) {\r\n    if (content.endsWith(endsWith.triggerValue)) {\r\n      findTriggerEndsWith = endsWith;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (findTriggerEndsWith) return findTriggerEndsWith;\r\n\r\n  // Check for contains match\r\n  const findContains = await botRepository.findMany({\r\n    where: {\r\n      enabled: true,\r\n      triggerType: 'keyword',\r\n      triggerOperator: 'contains',\r\n      instanceId: instanceId,\r\n    },\r\n  });\r\n\r\n  let findTriggerContains = null;\r\n\r\n  for (const contains of findContains) {\r\n    if (content.includes(contains.triggerValue)) {\r\n      findTriggerContains = contains;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (findTriggerContains) return findTriggerContains;\r\n\r\n  return null;\r\n};\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport {\r\n  difyController,\r\n  evolutionBotController,\r\n  flowiseController,\r\n  openaiController,\r\n  typebotController,\r\n} from '@api/server.module';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { IntegrationSession } from '@prisma/client';\r\nimport { findBotByTrigger } from '@utils/findBotByTrigger';\r\n\r\nexport type EmitData = {\r\n  instance: InstanceDto;\r\n  remoteJid: string;\r\n  msg: any;\r\n  pushName?: string;\r\n};\r\n\r\nexport interface ChatbotControllerInterface {\r\n  integrationEnabled: boolean;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } };\r\n\r\n  createBot(instance: InstanceDto, data: any): Promise<any>;\r\n  findBot(instance: InstanceDto): Promise<any>;\r\n  fetchBot(instance: InstanceDto, botId: string): Promise<any>;\r\n  updateBot(instance: InstanceDto, botId: string, data: any): Promise<any>;\r\n  deleteBot(instance: InstanceDto, botId: string): Promise<any>;\r\n\r\n  settings(instance: InstanceDto, data: any): Promise<any>;\r\n  fetchSettings(instance: InstanceDto): Promise<any>;\r\n\r\n  changeStatus(instance: InstanceDto, botId: string, status: string): Promise<any>;\r\n  fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string): Promise<any>;\r\n  ignoreJid(instance: InstanceDto, data: any): Promise<any>;\r\n\r\n  emit(data: EmitData): Promise<void>;\r\n}\r\n\r\nexport class ChatbotController {\r\n  public prismaRepository: PrismaRepository;\r\n  public waMonitor: WAMonitoringService;\r\n\r\n  public readonly logger = new Logger('ChatbotController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    this.prisma = prismaRepository;\r\n    this.monitor = waMonitor;\r\n  }\r\n\r\n  public set prisma(prisma: PrismaRepository) {\r\n    this.prismaRepository = prisma;\r\n  }\r\n\r\n  public get prisma() {\r\n    return this.prismaRepository;\r\n  }\r\n\r\n  public set monitor(waMonitor: WAMonitoringService) {\r\n    this.waMonitor = waMonitor;\r\n  }\r\n\r\n  public get monitor() {\r\n    return this.waMonitor;\r\n  }\r\n\r\n  public async emit({\r\n    instance,\r\n    remoteJid,\r\n    msg,\r\n    pushName,\r\n    isIntegration = false,\r\n  }: {\r\n    instance: InstanceDto;\r\n    remoteJid: string;\r\n    msg: any;\r\n    pushName?: string;\r\n    isIntegration?: boolean;\r\n  }): Promise<void> {\r\n    const emitData = {\r\n      instance,\r\n      remoteJid,\r\n      msg,\r\n      pushName,\r\n      isIntegration,\r\n    };\r\n    await evolutionBotController.emit(emitData);\r\n\r\n    await typebotController.emit(emitData);\r\n\r\n    await openaiController.emit(emitData);\r\n\r\n    await difyController.emit(emitData);\r\n\r\n    await flowiseController.emit(emitData);\r\n  }\r\n\r\n  public processDebounce(\r\n    userMessageDebounce: any,\r\n    content: string,\r\n    remoteJid: string,\r\n    debounceTime: number,\r\n    callback: any,\r\n  ) {\r\n    if (userMessageDebounce[remoteJid]) {\r\n      userMessageDebounce[remoteJid].message += `\\n${content}`;\r\n      this.logger.log('message debounced: ' + userMessageDebounce[remoteJid].message);\r\n      clearTimeout(userMessageDebounce[remoteJid].timeoutId);\r\n    } else {\r\n      userMessageDebounce[remoteJid] = {\r\n        message: content,\r\n        timeoutId: null,\r\n      };\r\n    }\r\n\r\n    userMessageDebounce[remoteJid].timeoutId = setTimeout(() => {\r\n      const myQuestion = userMessageDebounce[remoteJid].message;\r\n      this.logger.log('Debounce complete. Processing message: ' + myQuestion);\r\n\r\n      delete userMessageDebounce[remoteJid];\r\n      callback(myQuestion);\r\n    }, debounceTime * 1000);\r\n  }\r\n\r\n  public checkIgnoreJids(ignoreJids: any, remoteJid: string) {\r\n    if (ignoreJids && ignoreJids.length > 0) {\r\n      let ignoreGroups = false;\r\n      let ignoreContacts = false;\r\n\r\n      if (ignoreJids.includes('@g.us')) {\r\n        ignoreGroups = true;\r\n      }\r\n\r\n      if (ignoreJids.includes('@s.whatsapp.net')) {\r\n        ignoreContacts = true;\r\n      }\r\n\r\n      if (ignoreGroups && remoteJid.endsWith('@g.us')) {\r\n        this.logger.warn('Ignoring message from group: ' + remoteJid);\r\n        return true;\r\n      }\r\n\r\n      if (ignoreContacts && remoteJid.endsWith('@s.whatsapp.net')) {\r\n        this.logger.warn('Ignoring message from contact: ' + remoteJid);\r\n        return true;\r\n      }\r\n\r\n      if (ignoreJids.includes(remoteJid)) {\r\n        this.logger.warn('Ignoring message from jid: ' + remoteJid);\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public async getSession(remoteJid: string, instance: InstanceDto) {\r\n    let session = await this.prismaRepository.integrationSession.findFirst({\r\n      where: {\r\n        remoteJid: remoteJid,\r\n        instanceId: instance.instanceId,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    if (session) {\r\n      if (session.status !== 'closed' && !session.botId) {\r\n        this.logger.warn('Session is already opened in another integration');\r\n        return;\r\n      } else if (!session.botId) {\r\n        session = null;\r\n      }\r\n    }\r\n\r\n    return session;\r\n  }\r\n\r\n  public async findBotTrigger(\r\n    botRepository: any,\r\n    content: string,\r\n    instance: InstanceDto,\r\n    session?: IntegrationSession,\r\n  ) {\r\n    let findBot: null;\r\n\r\n    if (!session) {\r\n      findBot = await findBotByTrigger(botRepository, content, instance.instanceId);\r\n\r\n      if (!findBot) {\r\n        return;\r\n      }\r\n    } else {\r\n      findBot = await botRepository.findFirst({\r\n        where: {\r\n          id: session.botId,\r\n        },\r\n      });\r\n    }\r\n\r\n    return findBot;\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { ChatwootService } from '@api/integrations/chatbot/chatwoot/services/chatwoot.service';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { waMonitor } from '@api/server.module';\r\nimport { CacheService } from '@api/services/cache.service';\r\nimport { CacheEngine } from '@cache/cacheengine';\r\nimport { Chatwoot, ConfigService, HttpServer } from '@config/env.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { isURL } from 'class-validator';\r\n\r\nexport class ChatwootController {\r\n  constructor(\r\n    private readonly chatwootService: ChatwootService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  public async createChatwoot(instance: InstanceDto, data: ChatwootDto) {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) throw new BadRequestException('Chatwoot is disabled');\r\n\r\n    if (data?.enabled) {\r\n      if (!isURL(data.url, { require_tld: false })) {\r\n        throw new BadRequestException('url is not valid');\r\n      }\r\n\r\n      if (!data.accountId) {\r\n        throw new BadRequestException('accountId is required');\r\n      }\r\n\r\n      if (!data.token) {\r\n        throw new BadRequestException('token is required');\r\n      }\r\n\r\n      if (data.signMsg !== true && data.signMsg !== false) {\r\n        throw new BadRequestException('signMsg is required');\r\n      }\r\n      if (data.signMsg === false) data.signDelimiter = null;\r\n    }\r\n\r\n    if (!data.nameInbox || data.nameInbox === '') {\r\n      data.nameInbox = instance.instanceName;\r\n    }\r\n\r\n    const result = await this.chatwootService.create(instance, data);\r\n\r\n    const urlServer = this.configService.get<HttpServer>('SERVER').URL;\r\n\r\n    const response = {\r\n      ...result,\r\n      webhook_url: `${urlServer}/chatwoot/webhook/${encodeURIComponent(instance.instanceName)}`,\r\n    };\r\n\r\n    return response;\r\n  }\r\n\r\n  public async findChatwoot(instance: InstanceDto): Promise<ChatwootDto & { webhook_url: string }> {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) throw new BadRequestException('Chatwoot is disabled');\r\n\r\n    const result = await this.chatwootService.find(instance);\r\n\r\n    const urlServer = this.configService.get<HttpServer>('SERVER').URL;\r\n\r\n    if (Object.keys(result || {}).length === 0) {\r\n      return {\r\n        enabled: false,\r\n        url: '',\r\n        accountId: '',\r\n        token: '',\r\n        signMsg: false,\r\n        nameInbox: '',\r\n        webhook_url: '',\r\n      };\r\n    }\r\n\r\n    const response = {\r\n      ...result,\r\n      webhook_url: `${urlServer}/chatwoot/webhook/${encodeURIComponent(instance.instanceName)}`,\r\n    };\r\n\r\n    return response;\r\n  }\r\n\r\n  public async receiveWebhook(instance: InstanceDto, data: any) {\r\n    if (!this.configService.get<Chatwoot>('CHATWOOT').ENABLED) throw new BadRequestException('Chatwoot is disabled');\r\n\r\n    const chatwootCache = new CacheService(new CacheEngine(this.configService, ChatwootService.name).getEngine());\r\n    const chatwootService = new ChatwootService(waMonitor, this.configService, this.prismaRepository, chatwootCache);\r\n\r\n    return chatwootService.receiveWebhook(instance, data);\r\n  }\r\n}\r\n","import { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { DifyDto } from '@api/integrations/chatbot/dify/dto/dify.dto';\r\nimport { DifyService } from '@api/integrations/chatbot/dify/services/dify.service';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { configService, Dify } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { Dify as DifyModel } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\n\r\nimport { ChatbotController, ChatbotControllerInterface, EmitData } from '../../chatbot.controller';\r\n\r\nexport class DifyController extends ChatbotController implements ChatbotControllerInterface {\r\n  constructor(\r\n    private readonly difyService: DifyService,\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n  ) {\r\n    super(prismaRepository, waMonitor);\r\n\r\n    this.botRepository = this.prismaRepository.dify;\r\n    this.settingsRepository = this.prismaRepository.difySetting;\r\n    this.sessionRepository = this.prismaRepository.integrationSession;\r\n  }\r\n\r\n  public readonly logger = new Logger('DifyController');\r\n\r\n  integrationEnabled = configService.get<Dify>('DIFY').ENABLED;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } } = {};\r\n\r\n  // Bots\r\n  public async createBot(instance: InstanceDto, data: DifyDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (\r\n      !data.expire ||\r\n      !data.keywordFinish ||\r\n      !data.delayMessage ||\r\n      !data.unknownMessage ||\r\n      !data.listeningFromMe ||\r\n      !data.stopBotFromMe ||\r\n      !data.keepOpen ||\r\n      !data.debounceTime ||\r\n      !data.ignoreJids ||\r\n      !data.splitMessages ||\r\n      !data.timePerChar\r\n    ) {\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (data.expire === undefined || data.expire === null) data.expire = defaultSettingCheck.expire;\r\n      if (data.keywordFinish === undefined || data.keywordFinish === null)\r\n        data.keywordFinish = defaultSettingCheck.keywordFinish;\r\n      if (data.delayMessage === undefined || data.delayMessage === null)\r\n        data.delayMessage = defaultSettingCheck.delayMessage;\r\n      if (data.unknownMessage === undefined || data.unknownMessage === null)\r\n        data.unknownMessage = defaultSettingCheck.unknownMessage;\r\n      if (data.listeningFromMe === undefined || data.listeningFromMe === null)\r\n        data.listeningFromMe = defaultSettingCheck.listeningFromMe;\r\n      if (data.stopBotFromMe === undefined || data.stopBotFromMe === null)\r\n        data.stopBotFromMe = defaultSettingCheck.stopBotFromMe;\r\n      if (data.keepOpen === undefined || data.keepOpen === null) data.keepOpen = defaultSettingCheck.keepOpen;\r\n      if (data.debounceTime === undefined || data.debounceTime === null)\r\n        data.debounceTime = defaultSettingCheck.debounceTime;\r\n      if (data.ignoreJids === undefined || data.ignoreJids === null) data.ignoreJids = defaultSettingCheck.ignoreJids;\r\n      if (data.splitMessages === undefined || data.splitMessages === null)\r\n        data.splitMessages = defaultSettingCheck?.splitMessages ?? false;\r\n      if (data.timePerChar === undefined || data.timePerChar === null)\r\n        data.timePerChar = defaultSettingCheck?.timePerChar ?? 0;\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        });\r\n      }\r\n    }\r\n\r\n    const checkTriggerAll = await this.botRepository.findFirst({\r\n      where: {\r\n        enabled: true,\r\n        triggerType: 'all',\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkTriggerAll && data.triggerType === 'all') {\r\n      throw new Error('You already have a dify with an \"All\" trigger, you cannot have more bots while it is active');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        instanceId: instanceId,\r\n        botType: data.botType,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Dify already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.create({\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          botType: data.botType,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating dify');\r\n    }\r\n  }\r\n\r\n  public async findBot(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bots = await this.botRepository.findMany({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (!bots.length) {\r\n      return null;\r\n    }\r\n\r\n    return bots;\r\n  }\r\n\r\n  public async fetchBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Dify not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Dify not found');\r\n    }\r\n\r\n    return bot;\r\n  }\r\n\r\n  public async updateBot(instance: InstanceDto, botId: string, data: DifyDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Dify not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Dify not found');\r\n    }\r\n\r\n    if (data.triggerType === 'all') {\r\n      const checkTriggerAll = await this.botRepository.findFirst({\r\n        where: {\r\n          enabled: true,\r\n          triggerType: 'all',\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkTriggerAll) {\r\n        throw new Error('You already have a dify with an \"All\" trigger, you cannot have more bots while it is active');\r\n      }\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        id: {\r\n          not: botId,\r\n        },\r\n        instanceId: instanceId,\r\n        botType: data.botType,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Dify already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.update({\r\n        where: {\r\n          id: botId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          botType: data.botType,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error updating dify');\r\n    }\r\n  }\r\n\r\n  public async deleteBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Dify not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Dify not found');\r\n    }\r\n    try {\r\n      await this.prismaRepository.integrationSession.deleteMany({\r\n        where: {\r\n          botId: botId,\r\n        },\r\n      });\r\n\r\n      await this.botRepository.delete({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      return { bot: { id: botId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting dify bot');\r\n    }\r\n  }\r\n\r\n  // Settings\r\n  public async settings(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (settings) {\r\n        const updateSettings = await this.settingsRepository.update({\r\n          where: {\r\n            id: settings.id,\r\n          },\r\n          data: {\r\n            expire: data.expire,\r\n            keywordFinish: data.keywordFinish,\r\n            delayMessage: data.delayMessage,\r\n            unknownMessage: data.unknownMessage,\r\n            listeningFromMe: data.listeningFromMe,\r\n            stopBotFromMe: data.stopBotFromMe,\r\n            keepOpen: data.keepOpen,\r\n            debounceTime: data.debounceTime,\r\n            difyIdFallback: data.difyIdFallback,\r\n            ignoreJids: data.ignoreJids,\r\n            splitMessages: data.splitMessages,\r\n            timePerChar: data.timePerChar,\r\n          },\r\n        });\r\n\r\n        return {\r\n          expire: updateSettings.expire,\r\n          keywordFinish: updateSettings.keywordFinish,\r\n          delayMessage: updateSettings.delayMessage,\r\n          unknownMessage: updateSettings.unknownMessage,\r\n          listeningFromMe: updateSettings.listeningFromMe,\r\n          stopBotFromMe: updateSettings.stopBotFromMe,\r\n          keepOpen: updateSettings.keepOpen,\r\n          debounceTime: updateSettings.debounceTime,\r\n          difyIdFallback: updateSettings.difyIdFallback,\r\n          ignoreJids: updateSettings.ignoreJids,\r\n          splitMessages: updateSettings.splitMessages,\r\n          timePerChar: updateSettings.timePerChar,\r\n        };\r\n      }\r\n\r\n      const newSetttings = await this.settingsRepository.create({\r\n        data: {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          difyIdFallback: data.difyIdFallback,\r\n          ignoreJids: data.ignoreJids,\r\n          instanceId: instanceId,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return {\r\n        expire: newSetttings.expire,\r\n        keywordFinish: newSetttings.keywordFinish,\r\n        delayMessage: newSetttings.delayMessage,\r\n        unknownMessage: newSetttings.unknownMessage,\r\n        listeningFromMe: newSetttings.listeningFromMe,\r\n        stopBotFromMe: newSetttings.stopBotFromMe,\r\n        keepOpen: newSetttings.keepOpen,\r\n        debounceTime: newSetttings.debounceTime,\r\n        difyIdFallback: newSetttings.difyIdFallback,\r\n        ignoreJids: newSetttings.ignoreJids,\r\n        splitMessages: newSetttings.splitMessages,\r\n        timePerChar: newSetttings.timePerChar,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async fetchSettings(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n        include: {\r\n          Fallback: true,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        return {\r\n          expire: 0,\r\n          keywordFinish: '',\r\n          delayMessage: 0,\r\n          unknownMessage: '',\r\n          listeningFromMe: false,\r\n          stopBotFromMe: false,\r\n          keepOpen: false,\r\n          ignoreJids: [],\r\n          splitMessages: false,\r\n          timePerChar: 0,\r\n          difyIdFallback: '',\r\n          fallback: null,\r\n        };\r\n      }\r\n\r\n      return {\r\n        expire: settings.expire,\r\n        keywordFinish: settings.keywordFinish,\r\n        delayMessage: settings.delayMessage,\r\n        unknownMessage: settings.unknownMessage,\r\n        listeningFromMe: settings.listeningFromMe,\r\n        stopBotFromMe: settings.stopBotFromMe,\r\n        keepOpen: settings.keepOpen,\r\n        ignoreJids: settings.ignoreJids,\r\n        splitMessages: settings.splitMessages,\r\n        timePerChar: settings.timePerChar,\r\n        difyIdFallback: settings.difyIdFallback,\r\n        fallback: settings.Fallback,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching default settings');\r\n    }\r\n  }\r\n\r\n  // Sessions\r\n  public async changeStatus(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId,\r\n        },\r\n      });\r\n\r\n      const remoteJid = data.remoteJid;\r\n      const status = data.status;\r\n\r\n      if (status === 'delete') {\r\n        await this.sessionRepository.deleteMany({\r\n          where: {\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n        });\r\n\r\n        return { bot: { remoteJid: remoteJid, status: status } };\r\n      }\r\n\r\n      if (status === 'closed') {\r\n        if (defaultSettingCheck?.keepOpen) {\r\n          await this.sessionRepository.updateMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.sessionRepository.deleteMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n          });\r\n        }\r\n\r\n        return { bot: { ...instance, bot: { remoteJid: remoteJid, status: status } } };\r\n      } else {\r\n        const session = await this.sessionRepository.updateMany({\r\n          where: {\r\n            instanceId: instanceId,\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n          data: {\r\n            status: status,\r\n          },\r\n        });\r\n\r\n        const botData = {\r\n          remoteJid: remoteJid,\r\n          status: status,\r\n          session,\r\n        };\r\n\r\n        return { bot: { ...instance, bot: botData } };\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error changing status');\r\n    }\r\n  }\r\n\r\n  public async fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const bot = await this.botRepository.findFirst({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      if (bot && bot.instanceId !== instanceId) {\r\n        throw new Error('Dify not found');\r\n      }\r\n\r\n      return await this.sessionRepository.findMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid,\r\n          botId: bot ? botId : { not: null },\r\n          type: 'dify',\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching sessions');\r\n    }\r\n  }\r\n\r\n  public async ignoreJid(instance: InstanceDto, data: IgnoreJidDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Dify is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      let ignoreJids: any = settings?.ignoreJids || [];\r\n\r\n      if (data.action === 'add') {\r\n        if (ignoreJids.includes(data.remoteJid)) return { ignoreJids: ignoreJids };\r\n\r\n        ignoreJids.push(data.remoteJid);\r\n      } else {\r\n        ignoreJids = ignoreJids.filter((jid) => jid !== data.remoteJid);\r\n      }\r\n\r\n      const updateSettings = await this.settingsRepository.update({\r\n        where: {\r\n          id: settings.id,\r\n        },\r\n        data: {\r\n          ignoreJids: ignoreJids,\r\n        },\r\n      });\r\n\r\n      return {\r\n        ignoreJids: updateSettings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  // Emit\r\n  public async emit({ instance, remoteJid, msg }: EmitData) {\r\n    if (!this.integrationEnabled) return;\r\n\r\n    try {\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      if (this.checkIgnoreJids(settings?.ignoreJids, remoteJid)) return;\r\n\r\n      const session = await this.getSession(remoteJid, instance);\r\n\r\n      const content = getConversationMessage(msg);\r\n\r\n      let findBot = (await this.findBotTrigger(this.botRepository, content, instance, session)) as DifyModel;\r\n\r\n      if (!findBot) {\r\n        const fallback = await this.settingsRepository.findFirst({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (fallback?.difyIdFallback) {\r\n          const findFallback = await this.botRepository.findFirst({\r\n            where: {\r\n              id: fallback.difyIdFallback,\r\n            },\r\n          });\r\n\r\n          findBot = findFallback;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      let expire = findBot?.expire;\r\n      let keywordFinish = findBot?.keywordFinish;\r\n      let delayMessage = findBot?.delayMessage;\r\n      let unknownMessage = findBot?.unknownMessage;\r\n      let listeningFromMe = findBot?.listeningFromMe;\r\n      let stopBotFromMe = findBot?.stopBotFromMe;\r\n      let keepOpen = findBot?.keepOpen;\r\n      let debounceTime = findBot?.debounceTime;\r\n      let ignoreJids = findBot?.ignoreJids;\r\n      let splitMessages = findBot?.splitMessages;\r\n      let timePerChar = findBot?.timePerChar;\r\n\r\n      if (expire === undefined || expire === null) expire = settings.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = settings.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = settings.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = settings.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null) listeningFromMe = settings.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = settings.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = settings.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = settings.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = settings.ignoreJids;\r\n      if (splitMessages === undefined || splitMessages === null) splitMessages = settings?.splitMessages ?? false;\r\n      if (timePerChar === undefined || timePerChar === null) timePerChar = settings?.timePerChar ?? 0;\r\n\r\n      const key = msg.key as {\r\n        id: string;\r\n        remoteJid: string;\r\n        fromMe: boolean;\r\n        participant: string;\r\n      };\r\n\r\n      if (stopBotFromMe && key.fromMe && session) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'paused',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!listeningFromMe && key.fromMe) {\r\n        return;\r\n      }\r\n\r\n      if (session && !session.awaitUser) {\r\n        return;\r\n      }\r\n\r\n      if (debounceTime && debounceTime > 0) {\r\n        this.processDebounce(this.userMessageDebounce, content, remoteJid, debounceTime, async (debouncedContent) => {\r\n          await this.difyService.processDify(\r\n            this.waMonitor.waInstances[instance.instanceName],\r\n            remoteJid,\r\n            findBot,\r\n            session,\r\n            {\r\n              ...settings,\r\n              expire,\r\n              keywordFinish,\r\n              delayMessage,\r\n              unknownMessage,\r\n              listeningFromMe,\r\n              stopBotFromMe,\r\n              keepOpen,\r\n              debounceTime,\r\n              ignoreJids,\r\n              splitMessages,\r\n              timePerChar,\r\n            },\r\n            debouncedContent,\r\n            msg?.pushName,\r\n          );\r\n        });\r\n      } else {\r\n        await this.difyService.processDify(\r\n          this.waMonitor.waInstances[instance.instanceName],\r\n          remoteJid,\r\n          findBot,\r\n          session,\r\n          {\r\n            ...settings,\r\n            expire,\r\n            keywordFinish,\r\n            delayMessage,\r\n            unknownMessage,\r\n            listeningFromMe,\r\n            stopBotFromMe,\r\n            keepOpen,\r\n            debounceTime,\r\n            ignoreJids,\r\n            splitMessages,\r\n            timePerChar,\r\n          },\r\n          content,\r\n          msg?.pushName,\r\n        );\r\n      }\r\n\r\n      return;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { EvolutionBot } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\n\r\nimport { ChatbotController, ChatbotControllerInterface, EmitData } from '../../chatbot.controller';\r\nimport { EvolutionBotDto } from '../dto/evolutionBot.dto';\r\nimport { EvolutionBotService } from '../services/evolutionBot.service';\r\n\r\nexport class EvolutionBotController extends ChatbotController implements ChatbotControllerInterface {\r\n  constructor(\r\n    private readonly evolutionBotService: EvolutionBotService,\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n  ) {\r\n    super(prismaRepository, waMonitor);\r\n\r\n    this.botRepository = this.prismaRepository.evolutionBot;\r\n    this.settingsRepository = this.prismaRepository.evolutionBotSetting;\r\n    this.sessionRepository = this.prismaRepository.integrationSession;\r\n  }\r\n\r\n  public readonly logger = new Logger('EvolutionBotController');\r\n\r\n  integrationEnabled: boolean;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } } = {};\r\n\r\n  // Bots\r\n  public async createBot(instance: InstanceDto, data: EvolutionBotDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (\r\n      !data.expire ||\r\n      !data.keywordFinish ||\r\n      !data.delayMessage ||\r\n      !data.unknownMessage ||\r\n      !data.listeningFromMe ||\r\n      !data.stopBotFromMe ||\r\n      !data.keepOpen ||\r\n      !data.debounceTime ||\r\n      !data.ignoreJids ||\r\n      !data.splitMessages ||\r\n      !data.timePerChar\r\n    ) {\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (data.expire === undefined || data.expire === null) data.expire = defaultSettingCheck.expire;\r\n      if (data.keywordFinish === undefined || data.keywordFinish === null)\r\n        data.keywordFinish = defaultSettingCheck.keywordFinish;\r\n      if (data.delayMessage === undefined || data.delayMessage === null)\r\n        data.delayMessage = defaultSettingCheck.delayMessage;\r\n      if (data.unknownMessage === undefined || data.unknownMessage === null)\r\n        data.unknownMessage = defaultSettingCheck.unknownMessage;\r\n      if (data.listeningFromMe === undefined || data.listeningFromMe === null)\r\n        data.listeningFromMe = defaultSettingCheck.listeningFromMe;\r\n      if (data.stopBotFromMe === undefined || data.stopBotFromMe === null)\r\n        data.stopBotFromMe = defaultSettingCheck.stopBotFromMe;\r\n      if (data.keepOpen === undefined || data.keepOpen === null) data.keepOpen = defaultSettingCheck.keepOpen;\r\n      if (data.debounceTime === undefined || data.debounceTime === null)\r\n        data.debounceTime = defaultSettingCheck.debounceTime;\r\n      if (data.ignoreJids === undefined || data.ignoreJids === null) data.ignoreJids = defaultSettingCheck.ignoreJids;\r\n      if (data.splitMessages === undefined || data.splitMessages === null)\r\n        data.splitMessages = defaultSettingCheck?.splitMessages ?? false;\r\n      if (data.timePerChar === undefined || data.timePerChar === null)\r\n        data.timePerChar = defaultSettingCheck?.timePerChar ?? 0;\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        });\r\n      }\r\n    }\r\n\r\n    const checkTriggerAll = await this.botRepository.findFirst({\r\n      where: {\r\n        enabled: true,\r\n        triggerType: 'all',\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkTriggerAll && data.triggerType === 'all') {\r\n      throw new Error('You already have a dify with an \"All\" trigger, you cannot have more bots while it is active');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        instanceId: instanceId,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Dify already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.create({\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating bot');\r\n    }\r\n  }\r\n\r\n  public async findBot(instance: InstanceDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bots = await this.botRepository.findMany({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (!bots.length) {\r\n      return null;\r\n    }\r\n\r\n    return bots;\r\n  }\r\n\r\n  public async fetchBot(instance: InstanceDto, botId: string) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    return bot;\r\n  }\r\n\r\n  public async updateBot(instance: InstanceDto, botId: string, data: EvolutionBotDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (data.triggerType === 'all') {\r\n      const checkTriggerAll = await this.botRepository.findFirst({\r\n        where: {\r\n          enabled: true,\r\n          triggerType: 'all',\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkTriggerAll) {\r\n        throw new Error('You already have a bot with an \"All\" trigger, you cannot have more bots while it is active');\r\n      }\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        id: {\r\n          not: botId,\r\n        },\r\n        instanceId: instanceId,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Bot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.update({\r\n        where: {\r\n          id: botId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error updating bot');\r\n    }\r\n  }\r\n\r\n  public async deleteBot(instance: InstanceDto, botId: string) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n    try {\r\n      await this.prismaRepository.integrationSession.deleteMany({\r\n        where: {\r\n          botId: botId,\r\n        },\r\n      });\r\n\r\n      await this.botRepository.delete({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      return { bot: { id: botId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting bot');\r\n    }\r\n  }\r\n\r\n  // Settings\r\n  public async settings(instance: InstanceDto, data: any) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (settings) {\r\n        const updateSettings = await this.settingsRepository.update({\r\n          where: {\r\n            id: settings.id,\r\n          },\r\n          data: {\r\n            expire: data.expire,\r\n            keywordFinish: data.keywordFinish,\r\n            delayMessage: data.delayMessage,\r\n            unknownMessage: data.unknownMessage,\r\n            listeningFromMe: data.listeningFromMe,\r\n            stopBotFromMe: data.stopBotFromMe,\r\n            keepOpen: data.keepOpen,\r\n            debounceTime: data.debounceTime,\r\n            botIdFallback: data.botIdFallback,\r\n            ignoreJids: data.ignoreJids,\r\n            splitMessages: data.splitMessages,\r\n            timePerChar: data.timePerChar,\r\n          },\r\n        });\r\n\r\n        return {\r\n          expire: updateSettings.expire,\r\n          keywordFinish: updateSettings.keywordFinish,\r\n          delayMessage: updateSettings.delayMessage,\r\n          unknownMessage: updateSettings.unknownMessage,\r\n          listeningFromMe: updateSettings.listeningFromMe,\r\n          stopBotFromMe: updateSettings.stopBotFromMe,\r\n          keepOpen: updateSettings.keepOpen,\r\n          debounceTime: updateSettings.debounceTime,\r\n          botIdFallback: updateSettings.botIdFallback,\r\n          ignoreJids: updateSettings.ignoreJids,\r\n          splitMessages: updateSettings.splitMessages,\r\n          timePerChar: updateSettings.timePerChar,\r\n        };\r\n      }\r\n\r\n      const newSetttings = await this.settingsRepository.create({\r\n        data: {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          botIdFallback: data.botIdFallback,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      return {\r\n        expire: newSetttings.expire,\r\n        keywordFinish: newSetttings.keywordFinish,\r\n        delayMessage: newSetttings.delayMessage,\r\n        unknownMessage: newSetttings.unknownMessage,\r\n        listeningFromMe: newSetttings.listeningFromMe,\r\n        stopBotFromMe: newSetttings.stopBotFromMe,\r\n        keepOpen: newSetttings.keepOpen,\r\n        debounceTime: newSetttings.debounceTime,\r\n        botIdFallback: newSetttings.botIdFallback,\r\n        ignoreJids: newSetttings.ignoreJids,\r\n        splitMessages: newSetttings.splitMessages,\r\n        timePerChar: newSetttings.timePerChar,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async fetchSettings(instance: InstanceDto) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n        include: {\r\n          Fallback: true,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        return {\r\n          expire: 0,\r\n          keywordFinish: '',\r\n          delayMessage: 0,\r\n          unknownMessage: '',\r\n          listeningFromMe: false,\r\n          stopBotFromMe: false,\r\n          keepOpen: false,\r\n          ignoreJids: [],\r\n          splitMessages: false,\r\n          timePerChar: 0,\r\n          botIdFallback: '',\r\n          fallback: null,\r\n        };\r\n      }\r\n\r\n      return {\r\n        expire: settings.expire,\r\n        keywordFinish: settings.keywordFinish,\r\n        delayMessage: settings.delayMessage,\r\n        unknownMessage: settings.unknownMessage,\r\n        listeningFromMe: settings.listeningFromMe,\r\n        stopBotFromMe: settings.stopBotFromMe,\r\n        keepOpen: settings.keepOpen,\r\n        ignoreJids: settings.ignoreJids,\r\n        splitMessages: settings.splitMessages,\r\n        timePerChar: settings.timePerChar,\r\n        botIdFallback: settings.botIdFallback,\r\n        fallback: settings.Fallback,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching default settings');\r\n    }\r\n  }\r\n\r\n  // Sessions\r\n  public async changeStatus(instance: InstanceDto, data: any) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId,\r\n        },\r\n      });\r\n\r\n      const remoteJid = data.remoteJid;\r\n      const status = data.status;\r\n\r\n      if (status === 'delete') {\r\n        await this.sessionRepository.deleteMany({\r\n          where: {\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n        });\r\n\r\n        return { bot: { remoteJid: remoteJid, status: status } };\r\n      }\r\n\r\n      if (status === 'closed') {\r\n        if (defaultSettingCheck?.keepOpen) {\r\n          await this.sessionRepository.updateMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.sessionRepository.deleteMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n          });\r\n        }\r\n\r\n        return { bot: { ...instance, bot: { remoteJid: remoteJid, status: status } } };\r\n      } else {\r\n        const session = await this.sessionRepository.updateMany({\r\n          where: {\r\n            instanceId: instanceId,\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n          data: {\r\n            status: status,\r\n          },\r\n        });\r\n\r\n        const botData = {\r\n          remoteJid: remoteJid,\r\n          status: status,\r\n          session,\r\n        };\r\n\r\n        return { bot: { ...instance, bot: botData } };\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error changing status');\r\n    }\r\n  }\r\n\r\n  public async fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const bot = await this.botRepository.findFirst({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      if (bot && bot.instanceId !== instanceId) {\r\n        throw new Error('Dify not found');\r\n      }\r\n\r\n      return await this.sessionRepository.findMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid,\r\n          botId: bot ? botId : { not: null },\r\n          type: 'evolution',\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching sessions');\r\n    }\r\n  }\r\n\r\n  public async ignoreJid(instance: InstanceDto, data: IgnoreJidDto) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      let ignoreJids: any = settings?.ignoreJids || [];\r\n\r\n      if (data.action === 'add') {\r\n        if (ignoreJids.includes(data.remoteJid)) return { ignoreJids: ignoreJids };\r\n\r\n        ignoreJids.push(data.remoteJid);\r\n      } else {\r\n        ignoreJids = ignoreJids.filter((jid) => jid !== data.remoteJid);\r\n      }\r\n\r\n      const updateSettings = await this.settingsRepository.update({\r\n        where: {\r\n          id: settings.id,\r\n        },\r\n        data: {\r\n          ignoreJids: ignoreJids,\r\n        },\r\n      });\r\n\r\n      return {\r\n        ignoreJids: updateSettings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  // Emit\r\n  public async emit({ instance, remoteJid, msg }: EmitData) {\r\n    try {\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      if (this.checkIgnoreJids(settings?.ignoreJids, remoteJid)) return;\r\n\r\n      const session = await this.getSession(remoteJid, instance);\r\n\r\n      const content = getConversationMessage(msg);\r\n\r\n      let findBot = (await this.findBotTrigger(this.botRepository, content, instance, session)) as EvolutionBot;\r\n\r\n      if (!findBot) {\r\n        const fallback = await this.settingsRepository.findFirst({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (fallback?.botIdFallback) {\r\n          const findFallback = await this.botRepository.findFirst({\r\n            where: {\r\n              id: fallback.botIdFallback,\r\n            },\r\n          });\r\n\r\n          findBot = findFallback;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      let expire = findBot?.expire;\r\n      let keywordFinish = findBot?.keywordFinish;\r\n      let delayMessage = findBot?.delayMessage;\r\n      let unknownMessage = findBot?.unknownMessage;\r\n      let listeningFromMe = findBot?.listeningFromMe;\r\n      let stopBotFromMe = findBot?.stopBotFromMe;\r\n      let keepOpen = findBot?.keepOpen;\r\n      let debounceTime = findBot?.debounceTime;\r\n      let ignoreJids = findBot?.ignoreJids;\r\n      let splitMessages = findBot?.splitMessages;\r\n      let timePerChar = findBot?.timePerChar;\r\n\r\n      if (expire === undefined || expire === null) expire = settings.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = settings.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = settings.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = settings.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null) listeningFromMe = settings.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = settings.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = settings.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = settings.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = settings.ignoreJids;\r\n      if (splitMessages === undefined || splitMessages === null) splitMessages = settings?.splitMessages ?? false;\r\n      if (timePerChar === undefined || timePerChar === null) timePerChar = settings?.timePerChar ?? 0;\r\n\r\n      const key = msg.key as {\r\n        id: string;\r\n        remoteJid: string;\r\n        fromMe: boolean;\r\n        participant: string;\r\n      };\r\n\r\n      if (stopBotFromMe && key.fromMe && session) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'paused',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!listeningFromMe && key.fromMe) {\r\n        return;\r\n      }\r\n\r\n      if (session && !session.awaitUser) {\r\n        return;\r\n      }\r\n\r\n      if (debounceTime && debounceTime > 0) {\r\n        this.processDebounce(this.userMessageDebounce, content, remoteJid, debounceTime, async (debouncedContent) => {\r\n          await this.evolutionBotService.processBot(\r\n            this.waMonitor.waInstances[instance.instanceName],\r\n            remoteJid,\r\n            findBot,\r\n            session,\r\n            {\r\n              ...settings,\r\n              expire,\r\n              keywordFinish,\r\n              delayMessage,\r\n              unknownMessage,\r\n              listeningFromMe,\r\n              stopBotFromMe,\r\n              keepOpen,\r\n              debounceTime,\r\n              ignoreJids,\r\n              splitMessages,\r\n              timePerChar,\r\n            },\r\n            debouncedContent,\r\n            msg?.pushName,\r\n          );\r\n        });\r\n      } else {\r\n        await this.evolutionBotService.processBot(\r\n          this.waMonitor.waInstances[instance.instanceName],\r\n          remoteJid,\r\n          findBot,\r\n          session,\r\n          {\r\n            ...settings,\r\n            expire,\r\n            keywordFinish,\r\n            delayMessage,\r\n            unknownMessage,\r\n            listeningFromMe,\r\n            stopBotFromMe,\r\n            keepOpen,\r\n            debounceTime,\r\n            ignoreJids,\r\n            splitMessages,\r\n            timePerChar,\r\n          },\r\n          content,\r\n          msg?.pushName,\r\n        );\r\n      }\r\n\r\n      return;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Integration } from '@api/types/wa.types';\r\nimport { Auth, ConfigService, HttpServer } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { EvolutionBot, EvolutionBotSetting, IntegrationSession } from '@prisma/client';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\n\r\nexport class EvolutionBotService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('EvolutionBotService');\r\n\r\n  public async createNewSession(instance: InstanceDto, data: any) {\r\n    try {\r\n      const session = await this.prismaRepository.integrationSession.create({\r\n        data: {\r\n          remoteJid: data.remoteJid,\r\n          pushName: data.pushName,\r\n          sessionId: data.remoteJid,\r\n          status: 'opened',\r\n          awaitUser: false,\r\n          botId: data.botId,\r\n          instanceId: instance.instanceId,\r\n          type: 'evolution',\r\n        },\r\n      });\r\n\r\n      return { session };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private isImageMessage(content: string) {\r\n    return content.includes('imageMessage');\r\n  }\r\n\r\n  private async sendMessageToBot(\r\n    instance: any,\r\n    session: IntegrationSession,\r\n    bot: EvolutionBot,\r\n    remoteJid: string,\r\n    pushName: string,\r\n    content: string,\r\n  ) {\r\n    const payload: any = {\r\n      inputs: {\r\n        sessionId: session.id,\r\n        remoteJid: remoteJid,\r\n        pushName: pushName,\r\n        instanceName: instance.instanceName,\r\n        serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n        apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n      },\r\n      query: content,\r\n      conversation_id: session.sessionId === remoteJid ? undefined : session.sessionId,\r\n      user: remoteJid,\r\n    };\r\n\r\n    if (this.isImageMessage(content)) {\r\n      const contentSplit = content.split('|');\r\n\r\n      payload.files = [\r\n        {\r\n          type: 'image',\r\n          url: contentSplit[1].split('?')[0],\r\n        },\r\n      ];\r\n      payload.query = contentSplit[2] || content;\r\n    }\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n      await instance.client.presenceSubscribe(remoteJid);\r\n      await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n    }\r\n\r\n    let headers: any = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    if (bot.apiKey) {\r\n      headers = {\r\n        ...headers,\r\n        Authorization: `Bearer ${bot.apiKey}`,\r\n      };\r\n    }\r\n\r\n    const response = await axios.post(bot.apiUrl, payload, {\r\n      headers,\r\n    });\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n      await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n    const message = response?.data?.message;\r\n\r\n    return message;\r\n  }\r\n\r\n  private async sendMessageWhatsApp(\r\n    instance: any,\r\n    remoteJid: string,\r\n    session: IntegrationSession,\r\n    settings: EvolutionBotSetting,\r\n    message: string,\r\n  ) {\r\n    const linkRegex = /(!?)\\[(.*?)\\]\\((.*?)\\)/g;\r\n\r\n    let textBuffer = '';\r\n    let lastIndex = 0;\r\n\r\n    let match: RegExpExecArray | null;\r\n\r\n    const getMediaType = (url: string): string | null => {\r\n      const extension = url.split('.').pop()?.toLowerCase();\r\n      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];\r\n      const audioExtensions = ['mp3', 'wav', 'aac', 'ogg'];\r\n      const videoExtensions = ['mp4', 'avi', 'mkv', 'mov'];\r\n      const documentExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];\r\n\r\n      if (imageExtensions.includes(extension || '')) return 'image';\r\n      if (audioExtensions.includes(extension || '')) return 'audio';\r\n      if (videoExtensions.includes(extension || '')) return 'video';\r\n      if (documentExtensions.includes(extension || '')) return 'document';\r\n      return null;\r\n    };\r\n\r\n    while ((match = linkRegex.exec(message)) !== null) {\r\n      const [fullMatch, exclMark, altText, url] = match;\r\n      const mediaType = getMediaType(url);\r\n\r\n      const beforeText = message.slice(lastIndex, match.index);\r\n      if (beforeText) {\r\n        textBuffer += beforeText;\r\n      }\r\n\r\n      if (mediaType) {\r\n        const splitMessages = settings.splitMessages ?? false;\r\n        const timePerChar = settings.timePerChar ?? 0;\r\n        const minDelay = 1000;\r\n        const maxDelay = 20000;\r\n\r\n        if (textBuffer.trim()) {\r\n          if (splitMessages) {\r\n            const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n            for (let index = 0; index < multipleMessages.length; index++) {\r\n              const message = multipleMessages[index];\r\n\r\n              const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.presenceSubscribe(remoteJid);\r\n                await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n              }\r\n\r\n              await new Promise<void>((resolve) => {\r\n                setTimeout(async () => {\r\n                  await instance.textMessage(\r\n                    {\r\n                      number: remoteJid.split('@')[0],\r\n                      delay: settings?.delayMessage || 1000,\r\n                      text: message,\r\n                    },\r\n                    false,\r\n                  );\r\n                  resolve();\r\n                }, delay);\r\n              });\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n              }\r\n            }\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: textBuffer.trim(),\r\n              },\r\n              false,\r\n            );\r\n          }\r\n          textBuffer = '';\r\n        }\r\n\r\n        if (mediaType === 'audio') {\r\n          await instance.audioWhatsapp({\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            audio: url,\r\n            caption: altText,\r\n          });\r\n        } else {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: mediaType,\r\n              media: url,\r\n              caption: altText,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n        }\r\n      } else {\r\n        textBuffer += `[${altText}](${url})`;\r\n      }\r\n\r\n      lastIndex = linkRegex.lastIndex;\r\n    }\r\n\r\n    if (lastIndex < message.length) {\r\n      const remainingText = message.slice(lastIndex);\r\n      if (remainingText.trim()) {\r\n        textBuffer += remainingText;\r\n      }\r\n    }\r\n\r\n    const splitMessages = settings.splitMessages ?? false;\r\n    const timePerChar = settings.timePerChar ?? 0;\r\n    const minDelay = 1000;\r\n    const maxDelay = 20000;\r\n\r\n    if (textBuffer.trim()) {\r\n      if (splitMessages) {\r\n        const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n        for (let index = 0; index < multipleMessages.length; index++) {\r\n          const message = multipleMessages[index];\r\n\r\n          const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.presenceSubscribe(remoteJid);\r\n            await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n          }\r\n\r\n          await new Promise<void>((resolve) => {\r\n            setTimeout(async () => {\r\n              await instance.textMessage(\r\n                {\r\n                  number: remoteJid.split('@')[0],\r\n                  delay: settings?.delayMessage || 1000,\r\n                  text: message,\r\n                },\r\n                false,\r\n              );\r\n              resolve();\r\n            }, delay);\r\n          });\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n          }\r\n        }\r\n      } else {\r\n        await instance.textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            text: textBuffer.trim(),\r\n          },\r\n          false,\r\n        );\r\n      }\r\n      textBuffer = '';\r\n    }\r\n\r\n    sendTelemetry('/message/sendText');\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  private async initNewSession(\r\n    instance: any,\r\n    remoteJid: string,\r\n    bot: EvolutionBot,\r\n    settings: EvolutionBotSetting,\r\n    session: IntegrationSession,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    const data = await this.createNewSession(instance, {\r\n      remoteJid,\r\n      pushName,\r\n      botId: bot.id,\r\n    });\r\n\r\n    if (data.session) {\r\n      session = data.session;\r\n    }\r\n\r\n    const message = await this.sendMessageToBot(instance, session, bot, remoteJid, pushName, content);\r\n\r\n    if (!message) return;\r\n\r\n    await this.sendMessageWhatsApp(instance, remoteJid, session, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  public async processBot(\r\n    instance: any,\r\n    remoteJid: string,\r\n    bot: EvolutionBot,\r\n    session: IntegrationSession,\r\n    settings: EvolutionBotSetting,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    if (session && session.status !== 'opened') {\r\n      return;\r\n    }\r\n\r\n    if (session && settings.expire && settings.expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > settings.expire) {\r\n        if (settings.keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: bot.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        await this.initNewSession(instance, remoteJid, bot, settings, session, content, pushName);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!session) {\r\n      await this.initNewSession(instance, remoteJid, bot, settings, session, content, pushName);\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: false,\r\n      },\r\n    });\r\n\r\n    if (!content) {\r\n      if (settings.unknownMessage) {\r\n        this.waMonitor.waInstances[instance.instanceName].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings.delayMessage || 1000,\r\n            text: settings.unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (settings.keywordFinish && content.toLowerCase() === settings.keywordFinish.toLowerCase()) {\r\n      if (settings.keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: bot.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const message = await this.sendMessageToBot(instance, session, bot, remoteJid, pushName, content);\r\n\r\n    if (!message) return;\r\n\r\n    await this.sendMessageWhatsApp(instance, remoteJid, session, settings, message);\r\n\r\n    return;\r\n  }\r\n}\r\n","import { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Flowise } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\n\r\nimport { ChatbotController, ChatbotControllerInterface, EmitData } from '../../chatbot.controller';\r\nimport { FlowiseDto } from '../dto/flowise.dto';\r\nimport { FlowiseService } from '../services/flowise.service';\r\n\r\nexport class FlowiseController extends ChatbotController implements ChatbotControllerInterface {\r\n  constructor(\r\n    private readonly flowiseService: FlowiseService,\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n  ) {\r\n    super(prismaRepository, waMonitor);\r\n\r\n    this.botRepository = this.prismaRepository.flowise;\r\n    this.settingsRepository = this.prismaRepository.flowiseSetting;\r\n    this.sessionRepository = this.prismaRepository.integrationSession;\r\n  }\r\n\r\n  public readonly logger = new Logger('FlowiseController');\r\n\r\n  integrationEnabled: boolean;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } } = {};\r\n\r\n  // Bots\r\n  public async createBot(instance: InstanceDto, data: FlowiseDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (\r\n      !data.expire ||\r\n      !data.keywordFinish ||\r\n      !data.delayMessage ||\r\n      !data.unknownMessage ||\r\n      !data.listeningFromMe ||\r\n      !data.stopBotFromMe ||\r\n      !data.keepOpen ||\r\n      !data.debounceTime ||\r\n      !data.ignoreJids ||\r\n      !data.splitMessages ||\r\n      !data.timePerChar\r\n    ) {\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (data.expire === undefined || data.expire === null) data.expire = defaultSettingCheck.expire;\r\n      if (data.keywordFinish === undefined || data.keywordFinish === null)\r\n        data.keywordFinish = defaultSettingCheck.keywordFinish;\r\n      if (data.delayMessage === undefined || data.delayMessage === null)\r\n        data.delayMessage = defaultSettingCheck.delayMessage;\r\n      if (data.unknownMessage === undefined || data.unknownMessage === null)\r\n        data.unknownMessage = defaultSettingCheck.unknownMessage;\r\n      if (data.listeningFromMe === undefined || data.listeningFromMe === null)\r\n        data.listeningFromMe = defaultSettingCheck.listeningFromMe;\r\n      if (data.stopBotFromMe === undefined || data.stopBotFromMe === null)\r\n        data.stopBotFromMe = defaultSettingCheck.stopBotFromMe;\r\n      if (data.keepOpen === undefined || data.keepOpen === null) data.keepOpen = defaultSettingCheck.keepOpen;\r\n      if (data.debounceTime === undefined || data.debounceTime === null)\r\n        data.debounceTime = defaultSettingCheck.debounceTime;\r\n      if (data.ignoreJids === undefined || data.ignoreJids === null) data.ignoreJids = defaultSettingCheck.ignoreJids;\r\n      if (data.splitMessages === undefined || data.splitMessages === null)\r\n        data.splitMessages = defaultSettingCheck?.splitMessages ?? false;\r\n      if (data.timePerChar === undefined || data.timePerChar === null)\r\n        data.timePerChar = defaultSettingCheck?.timePerChar ?? 0;\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        });\r\n      }\r\n    }\r\n\r\n    const checkTriggerAll = await this.botRepository.findFirst({\r\n      where: {\r\n        enabled: true,\r\n        triggerType: 'all',\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkTriggerAll && data.triggerType === 'all') {\r\n      throw new Error('You already have a Flowise with an \"All\" trigger, you cannot have more bots while it is active');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        instanceId: instanceId,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Flowise already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.create({\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating bot');\r\n    }\r\n  }\r\n\r\n  public async findBot(instance: InstanceDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bots = await this.botRepository.findMany({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (!bots.length) {\r\n      return null;\r\n    }\r\n\r\n    return bots;\r\n  }\r\n\r\n  public async fetchBot(instance: InstanceDto, botId: string) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    return bot;\r\n  }\r\n\r\n  public async updateBot(instance: InstanceDto, botId: string, data: FlowiseDto) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (data.triggerType === 'all') {\r\n      const checkTriggerAll = await this.botRepository.findFirst({\r\n        where: {\r\n          enabled: true,\r\n          triggerType: 'all',\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkTriggerAll) {\r\n        throw new Error('You already have a bot with an \"All\" trigger, you cannot have more bots while it is active');\r\n      }\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        id: {\r\n          not: botId,\r\n        },\r\n        instanceId: instanceId,\r\n        apiUrl: data.apiUrl,\r\n        apiKey: data.apiKey,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Bot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.update({\r\n        where: {\r\n          id: botId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          apiUrl: data.apiUrl,\r\n          apiKey: data.apiKey,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error updating bot');\r\n    }\r\n  }\r\n\r\n  public async deleteBot(instance: InstanceDto, botId: string) {\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Bot not found');\r\n    }\r\n    try {\r\n      await this.prismaRepository.integrationSession.deleteMany({\r\n        where: {\r\n          botId: botId,\r\n        },\r\n      });\r\n\r\n      await this.botRepository.delete({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      return { bot: { id: botId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting bot');\r\n    }\r\n  }\r\n\r\n  // Settings\r\n  public async settings(instance: InstanceDto, data: any) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (settings) {\r\n        const updateSettings = await this.settingsRepository.update({\r\n          where: {\r\n            id: settings.id,\r\n          },\r\n          data: {\r\n            expire: data.expire,\r\n            keywordFinish: data.keywordFinish,\r\n            delayMessage: data.delayMessage,\r\n            unknownMessage: data.unknownMessage,\r\n            listeningFromMe: data.listeningFromMe,\r\n            stopBotFromMe: data.stopBotFromMe,\r\n            keepOpen: data.keepOpen,\r\n            debounceTime: data.debounceTime,\r\n            flowiseIdFallback: data.flowiseIdFallback,\r\n            ignoreJids: data.ignoreJids,\r\n            splitMessages: data.splitMessages,\r\n            timePerChar: data.timePerChar,\r\n          },\r\n        });\r\n\r\n        return {\r\n          expire: updateSettings.expire,\r\n          keywordFinish: updateSettings.keywordFinish,\r\n          delayMessage: updateSettings.delayMessage,\r\n          unknownMessage: updateSettings.unknownMessage,\r\n          listeningFromMe: updateSettings.listeningFromMe,\r\n          stopBotFromMe: updateSettings.stopBotFromMe,\r\n          keepOpen: updateSettings.keepOpen,\r\n          debounceTime: updateSettings.debounceTime,\r\n          flowiseIdFallback: updateSettings.flowiseIdFallback,\r\n          ignoreJids: updateSettings.ignoreJids,\r\n          splitMessages: updateSettings.splitMessages,\r\n          timePerChar: updateSettings.timePerChar,\r\n        };\r\n      }\r\n\r\n      const newSetttings = await this.settingsRepository.create({\r\n        data: {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          flowiseIdFallback: data.flowiseIdFallback,\r\n          ignoreJids: data.ignoreJids,\r\n          instanceId: instanceId,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return {\r\n        expire: newSetttings.expire,\r\n        keywordFinish: newSetttings.keywordFinish,\r\n        delayMessage: newSetttings.delayMessage,\r\n        unknownMessage: newSetttings.unknownMessage,\r\n        listeningFromMe: newSetttings.listeningFromMe,\r\n        stopBotFromMe: newSetttings.stopBotFromMe,\r\n        keepOpen: newSetttings.keepOpen,\r\n        debounceTime: newSetttings.debounceTime,\r\n        flowiseIdFallback: newSetttings.flowiseIdFallback,\r\n        ignoreJids: newSetttings.ignoreJids,\r\n        splitMessages: newSetttings.splitMessages,\r\n        timePerChar: newSetttings.timePerChar,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async fetchSettings(instance: InstanceDto) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n        include: {\r\n          Fallback: true,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        return {\r\n          expire: 0,\r\n          keywordFinish: '',\r\n          delayMessage: 0,\r\n          unknownMessage: '',\r\n          listeningFromMe: false,\r\n          stopBotFromMe: false,\r\n          keepOpen: false,\r\n          ignoreJids: [],\r\n          splitMessages: false,\r\n          timePerChar: 0,\r\n          flowiseIdFallback: '',\r\n          fallback: null,\r\n        };\r\n      }\r\n\r\n      return {\r\n        expire: settings.expire,\r\n        keywordFinish: settings.keywordFinish,\r\n        delayMessage: settings.delayMessage,\r\n        unknownMessage: settings.unknownMessage,\r\n        listeningFromMe: settings.listeningFromMe,\r\n        stopBotFromMe: settings.stopBotFromMe,\r\n        keepOpen: settings.keepOpen,\r\n        ignoreJids: settings.ignoreJids,\r\n        splitMessages: settings.splitMessages,\r\n        timePerChar: settings.timePerChar,\r\n        flowiseIdFallback: settings.flowiseIdFallback,\r\n        fallback: settings.Fallback,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching default settings');\r\n    }\r\n  }\r\n\r\n  // Sessions\r\n  public async changeStatus(instance: InstanceDto, data: any) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId,\r\n        },\r\n      });\r\n\r\n      const remoteJid = data.remoteJid;\r\n      const status = data.status;\r\n\r\n      if (status === 'delete') {\r\n        await this.sessionRepository.deleteMany({\r\n          where: {\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n        });\r\n\r\n        return { bot: { remoteJid: remoteJid, status: status } };\r\n      }\r\n\r\n      if (status === 'closed') {\r\n        if (defaultSettingCheck?.keepOpen) {\r\n          await this.sessionRepository.updateMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.sessionRepository.deleteMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n          });\r\n        }\r\n\r\n        return { bot: { ...instance, bot: { remoteJid: remoteJid, status: status } } };\r\n      } else {\r\n        const session = await this.sessionRepository.updateMany({\r\n          where: {\r\n            instanceId: instanceId,\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n          data: {\r\n            status: status,\r\n          },\r\n        });\r\n\r\n        const botData = {\r\n          remoteJid: remoteJid,\r\n          status: status,\r\n          session,\r\n        };\r\n\r\n        return { bot: { ...instance, bot: botData } };\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error changing status');\r\n    }\r\n  }\r\n\r\n  public async fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const bot = await this.botRepository.findFirst({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      if (bot && bot.instanceId !== instanceId) {\r\n        throw new Error('Dify not found');\r\n      }\r\n\r\n      return await this.sessionRepository.findMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid,\r\n          botId: bot ? botId : { not: null },\r\n          type: 'flowise',\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching sessions');\r\n    }\r\n  }\r\n\r\n  public async ignoreJid(instance: InstanceDto, data: IgnoreJidDto) {\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      let ignoreJids: any = settings?.ignoreJids || [];\r\n\r\n      if (data.action === 'add') {\r\n        if (ignoreJids.includes(data.remoteJid)) return { ignoreJids: ignoreJids };\r\n\r\n        ignoreJids.push(data.remoteJid);\r\n      } else {\r\n        ignoreJids = ignoreJids.filter((jid) => jid !== data.remoteJid);\r\n      }\r\n\r\n      const updateSettings = await this.settingsRepository.update({\r\n        where: {\r\n          id: settings.id,\r\n        },\r\n        data: {\r\n          ignoreJids: ignoreJids,\r\n        },\r\n      });\r\n\r\n      return {\r\n        ignoreJids: updateSettings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  // Emit\r\n  public async emit({ instance, remoteJid, msg }: EmitData) {\r\n    try {\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      if (this.checkIgnoreJids(settings?.ignoreJids, remoteJid)) return;\r\n\r\n      const session = await this.getSession(remoteJid, instance);\r\n\r\n      const content = getConversationMessage(msg);\r\n\r\n      let findBot = (await this.findBotTrigger(this.botRepository, content, instance, session)) as Flowise;\r\n\r\n      if (!findBot) {\r\n        const fallback = await this.settingsRepository.findFirst({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (fallback?.flowiseIdFallback) {\r\n          const findFallback = await this.botRepository.findFirst({\r\n            where: {\r\n              id: fallback.flowiseIdFallback,\r\n            },\r\n          });\r\n\r\n          findBot = findFallback;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      let expire = findBot?.expire;\r\n      let keywordFinish = findBot?.keywordFinish;\r\n      let delayMessage = findBot?.delayMessage;\r\n      let unknownMessage = findBot?.unknownMessage;\r\n      let listeningFromMe = findBot?.listeningFromMe;\r\n      let stopBotFromMe = findBot?.stopBotFromMe;\r\n      let keepOpen = findBot?.keepOpen;\r\n      let debounceTime = findBot?.debounceTime;\r\n      let ignoreJids = findBot?.ignoreJids;\r\n      let splitMessages = findBot?.splitMessages;\r\n      let timePerChar = findBot?.timePerChar;\r\n\r\n      if (expire === undefined || expire === null) expire = settings.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = settings.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = settings.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = settings.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null) listeningFromMe = settings.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = settings.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = settings.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = settings.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = settings.ignoreJids;\r\n      if (splitMessages === undefined || splitMessages === null) splitMessages = settings?.splitMessages ?? false;\r\n      if (timePerChar === undefined || timePerChar === null) timePerChar = settings?.timePerChar ?? 0;\r\n\r\n      const key = msg.key as {\r\n        id: string;\r\n        remoteJid: string;\r\n        fromMe: boolean;\r\n        participant: string;\r\n      };\r\n\r\n      if (stopBotFromMe && key.fromMe && session) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'paused',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!listeningFromMe && key.fromMe) {\r\n        return;\r\n      }\r\n\r\n      if (session && !session.awaitUser) {\r\n        return;\r\n      }\r\n\r\n      if (debounceTime && debounceTime > 0) {\r\n        this.processDebounce(this.userMessageDebounce, content, remoteJid, debounceTime, async (debouncedContent) => {\r\n          await this.flowiseService.processBot(\r\n            this.waMonitor.waInstances[instance.instanceName],\r\n            remoteJid,\r\n            findBot,\r\n            session,\r\n            {\r\n              ...settings,\r\n              expire,\r\n              keywordFinish,\r\n              delayMessage,\r\n              unknownMessage,\r\n              listeningFromMe,\r\n              stopBotFromMe,\r\n              keepOpen,\r\n              debounceTime,\r\n              ignoreJids,\r\n              splitMessages,\r\n              timePerChar,\r\n            },\r\n            debouncedContent,\r\n            msg?.pushName,\r\n          );\r\n        });\r\n      } else {\r\n        await this.flowiseService.processBot(\r\n          this.waMonitor.waInstances[instance.instanceName],\r\n          remoteJid,\r\n          findBot,\r\n          session,\r\n          {\r\n            ...settings,\r\n            expire,\r\n            keywordFinish,\r\n            delayMessage,\r\n            unknownMessage,\r\n            listeningFromMe,\r\n            stopBotFromMe,\r\n            keepOpen,\r\n            debounceTime,\r\n            ignoreJids,\r\n            splitMessages,\r\n            timePerChar,\r\n          },\r\n          content,\r\n          msg?.pushName,\r\n        );\r\n      }\r\n\r\n      return;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Integration } from '@api/types/wa.types';\r\nimport { Auth, ConfigService, HttpServer } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Flowise, FlowiseSetting, IntegrationSession } from '@prisma/client';\r\nimport { sendTelemetry } from '@utils/sendTelemetry';\r\nimport axios from 'axios';\r\n\r\nexport class FlowiseService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('FlowiseService');\r\n\r\n  public async createNewSession(instance: InstanceDto, data: any) {\r\n    try {\r\n      const session = await this.prismaRepository.integrationSession.create({\r\n        data: {\r\n          remoteJid: data.remoteJid,\r\n          pushName: data.pushName,\r\n          sessionId: data.remoteJid,\r\n          status: 'opened',\r\n          awaitUser: false,\r\n          botId: data.botId,\r\n          instanceId: instance.instanceId,\r\n          type: 'flowise',\r\n        },\r\n      });\r\n\r\n      return { session };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n\r\n  private isImageMessage(content: string) {\r\n    return content.includes('imageMessage');\r\n  }\r\n\r\n  private async sendMessageToBot(instance: any, bot: Flowise, remoteJid: string, pushName: string, content: string) {\r\n    const payload: any = {\r\n      question: content,\r\n      overrideConfig: {\r\n        sessionId: remoteJid,\r\n        vars: {\r\n          remoteJid: remoteJid,\r\n          pushName: pushName,\r\n          instanceName: instance.instanceName,\r\n          serverUrl: this.configService.get<HttpServer>('SERVER').URL,\r\n          apiKey: this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY,\r\n        },\r\n      },\r\n    };\r\n\r\n    if (this.isImageMessage(content)) {\r\n      const contentSplit = content.split('|');\r\n\r\n      payload.uploads = [\r\n        {\r\n          data: contentSplit[1].split('?')[0],\r\n          type: 'url',\r\n          name: 'Flowise.png',\r\n          mime: 'image/png',\r\n        },\r\n      ];\r\n      payload.question = contentSplit[2] || content;\r\n    }\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n      await instance.client.presenceSubscribe(remoteJid);\r\n      await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n    }\r\n\r\n    let headers: any = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    if (bot.apiKey) {\r\n      headers = {\r\n        ...headers,\r\n        Authorization: `Bearer ${bot.apiKey}`,\r\n      };\r\n    }\r\n\r\n    const endpoint = bot.apiUrl;\r\n\r\n    if (!endpoint) return null;\r\n\r\n    const response = await axios.post(endpoint, payload, {\r\n      headers,\r\n    });\r\n\r\n    if (instance.integration === Integration.WHATSAPP_BAILEYS)\r\n      await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n\r\n    const message = response?.data?.text;\r\n\r\n    return message;\r\n  }\r\n\r\n  private async sendMessageWhatsApp(\r\n    instance: any,\r\n    remoteJid: string,\r\n    session: IntegrationSession,\r\n    settings: FlowiseSetting,\r\n    message: string,\r\n  ) {\r\n    const linkRegex = /(!?)\\[(.*?)\\]\\((.*?)\\)/g;\r\n\r\n    let textBuffer = '';\r\n    let lastIndex = 0;\r\n\r\n    let match: RegExpExecArray | null;\r\n\r\n    const getMediaType = (url: string): string | null => {\r\n      const extension = url.split('.').pop()?.toLowerCase();\r\n      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];\r\n      const audioExtensions = ['mp3', 'wav', 'aac', 'ogg'];\r\n      const videoExtensions = ['mp4', 'avi', 'mkv', 'mov'];\r\n      const documentExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];\r\n\r\n      if (imageExtensions.includes(extension || '')) return 'image';\r\n      if (audioExtensions.includes(extension || '')) return 'audio';\r\n      if (videoExtensions.includes(extension || '')) return 'video';\r\n      if (documentExtensions.includes(extension || '')) return 'document';\r\n      return null;\r\n    };\r\n\r\n    while ((match = linkRegex.exec(message)) !== null) {\r\n      const [fullMatch, exclMark, altText, url] = match;\r\n      const mediaType = getMediaType(url);\r\n\r\n      const beforeText = message.slice(lastIndex, match.index);\r\n      if (beforeText) {\r\n        textBuffer += beforeText;\r\n      }\r\n\r\n      if (mediaType) {\r\n        const splitMessages = settings.splitMessages ?? false;\r\n        const timePerChar = settings.timePerChar ?? 0;\r\n        const minDelay = 1000;\r\n        const maxDelay = 20000;\r\n\r\n        if (textBuffer.trim()) {\r\n          if (splitMessages) {\r\n            const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n            for (let index = 0; index < multipleMessages.length; index++) {\r\n              const message = multipleMessages[index];\r\n\r\n              const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.presenceSubscribe(remoteJid);\r\n                await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n              }\r\n\r\n              await new Promise<void>((resolve) => {\r\n                setTimeout(async () => {\r\n                  await instance.textMessage(\r\n                    {\r\n                      number: remoteJid.split('@')[0],\r\n                      delay: settings?.delayMessage || 1000,\r\n                      text: message,\r\n                    },\r\n                    false,\r\n                  );\r\n                  resolve();\r\n                }, delay);\r\n              });\r\n\r\n              if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n                await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n              }\r\n            }\r\n          } else {\r\n            await instance.textMessage(\r\n              {\r\n                number: remoteJid.split('@')[0],\r\n                delay: settings?.delayMessage || 1000,\r\n                text: textBuffer.trim(),\r\n              },\r\n              false,\r\n            );\r\n          }\r\n          textBuffer = '';\r\n        }\r\n\r\n        if (mediaType === 'audio') {\r\n          await instance.audioWhatsapp({\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            audio: url,\r\n            caption: altText,\r\n          });\r\n        } else {\r\n          await instance.mediaMessage(\r\n            {\r\n              number: remoteJid.split('@')[0],\r\n              delay: settings?.delayMessage || 1000,\r\n              mediatype: mediaType,\r\n              media: url,\r\n              caption: altText,\r\n            },\r\n            null,\r\n            false,\r\n          );\r\n        }\r\n      } else {\r\n        textBuffer += `[${altText}](${url})`;\r\n      }\r\n\r\n      lastIndex = linkRegex.lastIndex;\r\n    }\r\n\r\n    if (lastIndex < message.length) {\r\n      const remainingText = message.slice(lastIndex);\r\n      if (remainingText.trim()) {\r\n        textBuffer += remainingText;\r\n      }\r\n    }\r\n\r\n    const splitMessages = settings.splitMessages ?? false;\r\n    const timePerChar = settings.timePerChar ?? 0;\r\n    const minDelay = 1000;\r\n    const maxDelay = 20000;\r\n\r\n    if (textBuffer.trim()) {\r\n      if (splitMessages) {\r\n        const multipleMessages = textBuffer.trim().split('\\n\\n');\r\n\r\n        for (let index = 0; index < multipleMessages.length; index++) {\r\n          const message = multipleMessages[index];\r\n\r\n          const delay = Math.min(Math.max(message.length * timePerChar, minDelay), maxDelay);\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.presenceSubscribe(remoteJid);\r\n            await instance.client.sendPresenceUpdate('composing', remoteJid);\r\n          }\r\n\r\n          await new Promise<void>((resolve) => {\r\n            setTimeout(async () => {\r\n              await instance.textMessage(\r\n                {\r\n                  number: remoteJid.split('@')[0],\r\n                  delay: settings?.delayMessage || 1000,\r\n                  text: message,\r\n                },\r\n                false,\r\n              );\r\n              resolve();\r\n            }, delay);\r\n          });\r\n\r\n          if (instance.integration === Integration.WHATSAPP_BAILEYS) {\r\n            await instance.client.sendPresenceUpdate('paused', remoteJid);\r\n          }\r\n        }\r\n      } else {\r\n        await instance.textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings?.delayMessage || 1000,\r\n            text: textBuffer.trim(),\r\n          },\r\n          false,\r\n        );\r\n      }\r\n      textBuffer = '';\r\n    }\r\n\r\n    sendTelemetry('/message/sendText');\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: true,\r\n      },\r\n    });\r\n\r\n    return;\r\n  }\r\n\r\n  private async initNewSession(\r\n    instance: any,\r\n    remoteJid: string,\r\n    bot: Flowise,\r\n    settings: FlowiseSetting,\r\n    session: IntegrationSession,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    const data = await this.createNewSession(instance, {\r\n      remoteJid,\r\n      pushName,\r\n      botId: bot.id,\r\n    });\r\n\r\n    if (data.session) {\r\n      session = data.session;\r\n    }\r\n\r\n    const message = await this.sendMessageToBot(instance, bot, remoteJid, pushName, content);\r\n\r\n    await this.sendMessageWhatsApp(instance, remoteJid, session, settings, message);\r\n\r\n    return;\r\n  }\r\n\r\n  public async processBot(\r\n    instance: any,\r\n    remoteJid: string,\r\n    bot: Flowise,\r\n    session: IntegrationSession,\r\n    settings: FlowiseSetting,\r\n    content: string,\r\n    pushName?: string,\r\n  ) {\r\n    if (session && session.status !== 'opened') {\r\n      return;\r\n    }\r\n\r\n    if (session && settings.expire && settings.expire > 0) {\r\n      const now = Date.now();\r\n\r\n      const sessionUpdatedAt = new Date(session.updatedAt).getTime();\r\n\r\n      const diff = now - sessionUpdatedAt;\r\n\r\n      const diffInMinutes = Math.floor(diff / 1000 / 60);\r\n\r\n      if (diffInMinutes > settings.expire) {\r\n        if (settings.keepOpen) {\r\n          await this.prismaRepository.integrationSession.update({\r\n            where: {\r\n              id: session.id,\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.prismaRepository.integrationSession.deleteMany({\r\n            where: {\r\n              botId: bot.id,\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        await this.initNewSession(instance, remoteJid, bot, settings, session, content, pushName);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!session) {\r\n      await this.initNewSession(instance, remoteJid, bot, settings, session, content, pushName);\r\n      return;\r\n    }\r\n\r\n    await this.prismaRepository.integrationSession.update({\r\n      where: {\r\n        id: session.id,\r\n      },\r\n      data: {\r\n        status: 'opened',\r\n        awaitUser: false,\r\n      },\r\n    });\r\n\r\n    if (!content) {\r\n      if (settings.unknownMessage) {\r\n        this.waMonitor.waInstances[instance.instanceName].textMessage(\r\n          {\r\n            number: remoteJid.split('@')[0],\r\n            delay: settings.delayMessage || 1000,\r\n            text: settings.unknownMessage,\r\n          },\r\n          false,\r\n        );\r\n\r\n        sendTelemetry('/message/sendText');\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (settings.keywordFinish && content.toLowerCase() === settings.keywordFinish.toLowerCase()) {\r\n      if (settings.keepOpen) {\r\n        await this.prismaRepository.integrationSession.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'closed',\r\n          },\r\n        });\r\n      } else {\r\n        await this.prismaRepository.integrationSession.deleteMany({\r\n          where: {\r\n            botId: bot.id,\r\n            remoteJid: remoteJid,\r\n          },\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const message = await this.sendMessageToBot(instance, bot, remoteJid, pushName, content);\r\n\r\n    await this.sendMessageWhatsApp(instance, remoteJid, session, settings, message);\r\n\r\n    return;\r\n  }\r\n}\r\n","import { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { OpenaiCredsDto, OpenaiDto } from '@api/integrations/chatbot/openai/dto/openai.dto';\r\nimport { OpenaiService } from '@api/integrations/chatbot/openai/services/openai.service';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { configService, Openai } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { OpenaiBot } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\nimport OpenAI from 'openai';\r\n\r\nimport { ChatbotController, ChatbotControllerInterface, EmitData } from '../../chatbot.controller';\r\n\r\nexport class OpenaiController extends ChatbotController implements ChatbotControllerInterface {\r\n  constructor(\r\n    private readonly openaiService: OpenaiService,\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n  ) {\r\n    super(prismaRepository, waMonitor);\r\n\r\n    this.botRepository = this.prismaRepository.openaiBot;\r\n    this.settingsRepository = this.prismaRepository.openaiSetting;\r\n    this.sessionRepository = this.prismaRepository.integrationSession;\r\n    this.credsRepository = this.prismaRepository.openaiCreds;\r\n  }\r\n\r\n  public readonly logger = new Logger('OpenaiController');\r\n\r\n  integrationEnabled = configService.get<Openai>('OPENAI').ENABLED;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } } = {};\r\n  private client: OpenAI;\r\n  private credsRepository: any;\r\n\r\n  // Credentials\r\n  public async createOpenaiCreds(instance: InstanceDto, data: OpenaiCredsDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (!data.apiKey) throw new Error('API Key is required');\r\n    if (!data.name) throw new Error('Name is required');\r\n\r\n    try {\r\n      const creds = await this.credsRepository.create({\r\n        data: {\r\n          name: data.name,\r\n          apiKey: data.apiKey,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      return creds;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating openai creds');\r\n    }\r\n  }\r\n\r\n  public async findOpenaiCreds(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const creds = await this.credsRepository.findMany({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n      include: {\r\n        OpenaiAssistant: true,\r\n      },\r\n    });\r\n\r\n    return creds;\r\n  }\r\n\r\n  public async deleteCreds(instance: InstanceDto, openaiCredsId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const creds = await this.credsRepository.findFirst({\r\n      where: {\r\n        id: openaiCredsId,\r\n      },\r\n    });\r\n\r\n    if (!creds) {\r\n      throw new Error('Openai Creds not found');\r\n    }\r\n\r\n    if (creds.instanceId !== instanceId) {\r\n      throw new Error('Openai Creds not found');\r\n    }\r\n\r\n    try {\r\n      await this.credsRepository.delete({\r\n        where: {\r\n          id: openaiCredsId,\r\n        },\r\n      });\r\n\r\n      return { openaiCreds: { id: openaiCredsId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting openai creds');\r\n    }\r\n  }\r\n\r\n  // Models\r\n  public async getModels(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (!instanceId) throw new Error('Instance not found');\r\n\r\n    const defaultSettings = await this.settingsRepository.findFirst({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n      include: {\r\n        OpenaiCreds: true,\r\n      },\r\n    });\r\n\r\n    if (!defaultSettings) throw new Error('Settings not found');\r\n\r\n    const { apiKey } = defaultSettings.OpenaiCreds;\r\n\r\n    try {\r\n      this.client = new OpenAI({ apiKey });\r\n\r\n      const models: any = await this.client.models.list();\r\n\r\n      return models?.body?.data;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching models');\r\n    }\r\n  }\r\n\r\n  // Bots\r\n  public async createBot(instance: InstanceDto, data: OpenaiDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (\r\n      !data.openaiCredsId ||\r\n      !data.expire ||\r\n      !data.keywordFinish ||\r\n      !data.delayMessage ||\r\n      !data.unknownMessage ||\r\n      !data.listeningFromMe ||\r\n      !data.stopBotFromMe ||\r\n      !data.keepOpen ||\r\n      !data.debounceTime ||\r\n      !data.ignoreJids ||\r\n      !data.splitMessages ||\r\n      !data.timePerChar\r\n    ) {\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (data.expire === undefined || data.expire === null) data.expire = defaultSettingCheck.expire;\r\n      if (data.keywordFinish === undefined || data.keywordFinish === null)\r\n        data.keywordFinish = defaultSettingCheck.keywordFinish;\r\n      if (data.delayMessage === undefined || data.delayMessage === null)\r\n        data.delayMessage = defaultSettingCheck.delayMessage;\r\n      if (data.unknownMessage === undefined || data.unknownMessage === null)\r\n        data.unknownMessage = defaultSettingCheck.unknownMessage;\r\n      if (data.listeningFromMe === undefined || data.listeningFromMe === null)\r\n        data.listeningFromMe = defaultSettingCheck.listeningFromMe;\r\n      if (data.stopBotFromMe === undefined || data.stopBotFromMe === null)\r\n        data.stopBotFromMe = defaultSettingCheck.stopBotFromMe;\r\n      if (data.keepOpen === undefined || data.keepOpen === null) data.keepOpen = defaultSettingCheck.keepOpen;\r\n      if (data.debounceTime === undefined || data.debounceTime === null)\r\n        data.debounceTime = defaultSettingCheck.debounceTime;\r\n      if (data.ignoreJids === undefined || data.ignoreJids === null) data.ignoreJids = defaultSettingCheck.ignoreJids;\r\n      if (data.splitMessages === undefined || data.splitMessages === null)\r\n        data.splitMessages = defaultSettingCheck?.splitMessages ?? false;\r\n      if (data.timePerChar === undefined || data.timePerChar === null)\r\n        data.timePerChar = defaultSettingCheck?.timePerChar ?? 0;\r\n\r\n      if (!data.openaiCredsId) {\r\n        throw new Error('Openai Creds Id is required');\r\n      }\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          openaiCredsId: data.openaiCredsId,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        });\r\n      }\r\n    }\r\n\r\n    const checkTriggerAll = await this.botRepository.findFirst({\r\n      where: {\r\n        enabled: true,\r\n        triggerType: 'all',\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkTriggerAll && data.triggerType === 'all') {\r\n      throw new Error('You already have a openai with an \"All\" trigger, you cannot have more bots while it is active');\r\n    }\r\n\r\n    let whereDuplication: any = {\r\n      instanceId: instanceId,\r\n    };\r\n\r\n    if (data.botType === 'assistant') {\r\n      if (!data.assistantId) throw new Error('Assistant ID is required');\r\n\r\n      whereDuplication = {\r\n        ...whereDuplication,\r\n        assistantId: data.assistantId,\r\n        botType: data.botType,\r\n      };\r\n    } else if (data.botType === 'chatCompletion') {\r\n      if (!data.model) throw new Error('Model is required');\r\n      if (!data.maxTokens) throw new Error('Max tokens is required');\r\n\r\n      whereDuplication = {\r\n        ...whereDuplication,\r\n        model: data.model,\r\n        maxTokens: data.maxTokens,\r\n        botType: data.botType,\r\n      };\r\n    } else {\r\n      throw new Error('Bot type is required');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: whereDuplication,\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Openai Bot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.create({\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          openaiCredsId: data.openaiCredsId,\r\n          botType: data.botType,\r\n          assistantId: data.assistantId,\r\n          functionUrl: data.functionUrl,\r\n          model: data.model,\r\n          systemMessages: data.systemMessages,\r\n          assistantMessages: data.assistantMessages,\r\n          userMessages: data.userMessages,\r\n          maxTokens: data.maxTokens,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating openai bot');\r\n    }\r\n  }\r\n\r\n  public async findBot(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bots = await this.botRepository.findMany({\r\n      where: {\r\n        instanceId,\r\n      },\r\n    });\r\n\r\n    if (!bots.length) {\r\n      return null;\r\n    }\r\n\r\n    return bots;\r\n  }\r\n\r\n  public async fetchBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Openai Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Openai Bot not found');\r\n    }\r\n\r\n    return bot;\r\n  }\r\n\r\n  public async updateBot(instance: InstanceDto, botId: string, data: OpenaiDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Openai Bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Openai Bot not found');\r\n    }\r\n\r\n    if (data.triggerType === 'all') {\r\n      const checkTriggerAll = await this.botRepository.findFirst({\r\n        where: {\r\n          enabled: true,\r\n          triggerType: 'all',\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkTriggerAll) {\r\n        throw new Error(\r\n          'You already have a openai bot with an \"All\" trigger, you cannot have more bots while it is active',\r\n        );\r\n      }\r\n    }\r\n\r\n    let whereDuplication: any = {\r\n      id: {\r\n        not: botId,\r\n      },\r\n      instanceId: instanceId,\r\n    };\r\n\r\n    if (data.botType === 'assistant') {\r\n      if (!data.assistantId) throw new Error('Assistant ID is required');\r\n\r\n      whereDuplication = {\r\n        ...whereDuplication,\r\n        assistantId: data.assistantId,\r\n      };\r\n    } else if (data.botType === 'chatCompletion') {\r\n      if (!data.model) throw new Error('Model is required');\r\n      if (!data.maxTokens) throw new Error('Max tokens is required');\r\n\r\n      whereDuplication = {\r\n        ...whereDuplication,\r\n        model: data.model,\r\n        maxTokens: data.maxTokens,\r\n      };\r\n    } else {\r\n      throw new Error('Bot type is required');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: whereDuplication,\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Openai Bot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.update({\r\n        where: {\r\n          id: botId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          openaiCredsId: data.openaiCredsId,\r\n          botType: data.botType,\r\n          assistantId: data.assistantId,\r\n          functionUrl: data.functionUrl,\r\n          model: data.model,\r\n          systemMessages: data.systemMessages,\r\n          assistantMessages: data.assistantMessages,\r\n          userMessages: data.userMessages,\r\n          maxTokens: data.maxTokens,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error updating openai bot');\r\n    }\r\n  }\r\n\r\n  public async deleteBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Openai bot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Openai bot not found');\r\n    }\r\n    try {\r\n      await this.sessionRepository.deleteMany({\r\n        where: {\r\n          botId: botId,\r\n        },\r\n      });\r\n\r\n      await this.botRepository.delete({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      return { bot: { id: botId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting openai bot');\r\n    }\r\n  }\r\n\r\n  // Settings\r\n  public async settings(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (settings) {\r\n        const updateSettings = await this.settingsRepository.update({\r\n          where: {\r\n            id: settings.id,\r\n          },\r\n          data: {\r\n            openaiCredsId: data.openaiCredsId,\r\n            expire: data.expire,\r\n            keywordFinish: data.keywordFinish,\r\n            delayMessage: data.delayMessage,\r\n            unknownMessage: data.unknownMessage,\r\n            listeningFromMe: data.listeningFromMe,\r\n            stopBotFromMe: data.stopBotFromMe,\r\n            keepOpen: data.keepOpen,\r\n            debounceTime: data.debounceTime,\r\n            speechToText: data.speechToText,\r\n            openaiIdFallback: data.openaiIdFallback,\r\n            ignoreJids: data.ignoreJids,\r\n            splitMessages: data.splitMessages,\r\n            timePerChar: data.timePerChar,\r\n          },\r\n        });\r\n\r\n        return {\r\n          openaiCredsId: updateSettings.openaiCredsId,\r\n          expire: updateSettings.expire,\r\n          keywordFinish: updateSettings.keywordFinish,\r\n          delayMessage: updateSettings.delayMessage,\r\n          unknownMessage: updateSettings.unknownMessage,\r\n          listeningFromMe: updateSettings.listeningFromMe,\r\n          stopBotFromMe: updateSettings.stopBotFromMe,\r\n          keepOpen: updateSettings.keepOpen,\r\n          debounceTime: updateSettings.debounceTime,\r\n          speechToText: updateSettings.speechToText,\r\n          openaiIdFallback: updateSettings.openaiIdFallback,\r\n          ignoreJids: updateSettings.ignoreJids,\r\n          splitMessages: updateSettings.splitMessages,\r\n          timePerChar: updateSettings.timePerChar,\r\n        };\r\n      }\r\n\r\n      const newSetttings = await this.settingsRepository.create({\r\n        data: {\r\n          openaiCredsId: data.openaiCredsId,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          openaiIdFallback: data.openaiIdFallback,\r\n          ignoreJids: data.ignoreJids,\r\n          speechToText: data.speechToText,\r\n          instanceId: instanceId,\r\n          splitMessages: data.splitMessages,\r\n          timePerChar: data.timePerChar,\r\n        },\r\n      });\r\n\r\n      return {\r\n        openaiCredsId: newSetttings.openaiCredsId,\r\n        expire: newSetttings.expire,\r\n        keywordFinish: newSetttings.keywordFinish,\r\n        delayMessage: newSetttings.delayMessage,\r\n        unknownMessage: newSetttings.unknownMessage,\r\n        listeningFromMe: newSetttings.listeningFromMe,\r\n        stopBotFromMe: newSetttings.stopBotFromMe,\r\n        keepOpen: newSetttings.keepOpen,\r\n        debounceTime: newSetttings.debounceTime,\r\n        openaiIdFallback: newSetttings.openaiIdFallback,\r\n        ignoreJids: newSetttings.ignoreJids,\r\n        speechToText: newSetttings.speechToText,\r\n        splitMessages: newSetttings.splitMessages,\r\n        timePerChar: newSetttings.timePerChar,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async fetchSettings(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    try {\r\n      const instanceId = (\r\n        await this.prismaRepository.instance.findFirst({\r\n          select: { id: true },\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n      )?.id;\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n        include: {\r\n          Fallback: true,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        return {\r\n          openaiCredsId: null,\r\n          expire: 0,\r\n          keywordFinish: '',\r\n          delayMessage: 0,\r\n          unknownMessage: '',\r\n          listeningFromMe: false,\r\n          stopBotFromMe: false,\r\n          keepOpen: false,\r\n          ignoreJids: [],\r\n          splitMessages: false,\r\n          timePerChar: 0,\r\n          openaiIdFallback: null,\r\n          speechToText: false,\r\n          fallback: null,\r\n        };\r\n      }\r\n\r\n      return {\r\n        openaiCredsId: settings.openaiCredsId,\r\n        expire: settings.expire,\r\n        keywordFinish: settings.keywordFinish,\r\n        delayMessage: settings.delayMessage,\r\n        unknownMessage: settings.unknownMessage,\r\n        listeningFromMe: settings.listeningFromMe,\r\n        stopBotFromMe: settings.stopBotFromMe,\r\n        keepOpen: settings.keepOpen,\r\n        ignoreJids: settings.ignoreJids,\r\n        splitMessages: settings.splitMessages,\r\n        timePerChar: settings.timePerChar,\r\n        openaiIdFallback: settings.openaiIdFallback,\r\n        speechToText: settings.speechToText,\r\n        fallback: settings.Fallback,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching default settings');\r\n    }\r\n  }\r\n\r\n  // Sessions\r\n  public async changeStatus(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId,\r\n        },\r\n      });\r\n\r\n      const remoteJid = data.remoteJid;\r\n      const status = data.status;\r\n\r\n      if (status === 'delete') {\r\n        await this.sessionRepository.deleteMany({\r\n          where: {\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n        });\r\n\r\n        return { openai: { remoteJid: remoteJid, status: status } };\r\n      }\r\n\r\n      if (status === 'closed') {\r\n        if (defaultSettingCheck?.keepOpen) {\r\n          await this.sessionRepository.updateMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n              status: { not: 'closed' },\r\n            },\r\n            data: {\r\n              status: 'closed',\r\n            },\r\n          });\r\n        } else {\r\n          await this.sessionRepository.deleteMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n            },\r\n          });\r\n        }\r\n\r\n        return { openai: { ...instance, openai: { remoteJid: remoteJid, status: status } } };\r\n      } else {\r\n        const session = await this.sessionRepository.updateMany({\r\n          where: {\r\n            instanceId: instanceId,\r\n            remoteJid: remoteJid,\r\n            botId: { not: null },\r\n          },\r\n          data: {\r\n            status: status,\r\n          },\r\n        });\r\n\r\n        const openaiData = {\r\n          remoteJid: remoteJid,\r\n          status: status,\r\n          session,\r\n        };\r\n\r\n        return { openai: { ...instance, openai: openaiData } };\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error changing status');\r\n    }\r\n  }\r\n\r\n  public async fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const openaiBot = await this.botRepository.findFirst({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      if (openaiBot && openaiBot.instanceId !== instanceId) {\r\n        throw new Error('Openai Bot not found');\r\n      }\r\n\r\n      return await this.sessionRepository.findMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid,\r\n          botId: openaiBot ? botId : { not: null },\r\n          type: 'openai',\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching sessions');\r\n    }\r\n  }\r\n\r\n  public async ignoreJid(instance: InstanceDto, data: IgnoreJidDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Openai is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      let ignoreJids: any = settings?.ignoreJids || [];\r\n\r\n      if (data.action === 'add') {\r\n        if (ignoreJids.includes(data.remoteJid)) return { ignoreJids: ignoreJids };\r\n\r\n        ignoreJids.push(data.remoteJid);\r\n      } else {\r\n        ignoreJids = ignoreJids.filter((jid) => jid !== data.remoteJid);\r\n      }\r\n\r\n      const updateSettings = await this.settingsRepository.update({\r\n        where: {\r\n          id: settings.id,\r\n        },\r\n        data: {\r\n          ignoreJids: ignoreJids,\r\n        },\r\n      });\r\n\r\n      return {\r\n        ignoreJids: updateSettings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  // Emit\r\n  public async emit({ instance, remoteJid, msg, pushName }: EmitData) {\r\n    if (!this.integrationEnabled) return;\r\n\r\n    try {\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      if (this.checkIgnoreJids(settings?.ignoreJids, remoteJid)) return;\r\n\r\n      let session = await this.getSession(remoteJid, instance);\r\n\r\n      const content = getConversationMessage(msg);\r\n\r\n      let findBot = (await this.findBotTrigger(this.botRepository, content, instance, session)) as OpenaiBot;\r\n\r\n      if (!findBot) {\r\n        const fallback = await this.settingsRepository.findFirst({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (fallback?.openaiIdFallback) {\r\n          const findFallback = await this.botRepository.findFirst({\r\n            where: {\r\n              id: fallback.openaiIdFallback,\r\n            },\r\n          });\r\n\r\n          findBot = findFallback;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      let expire = findBot?.expire;\r\n      let keywordFinish = findBot?.keywordFinish;\r\n      let delayMessage = findBot?.delayMessage;\r\n      let unknownMessage = findBot?.unknownMessage;\r\n      let listeningFromMe = findBot?.listeningFromMe;\r\n      let stopBotFromMe = findBot?.stopBotFromMe;\r\n      let keepOpen = findBot?.keepOpen;\r\n      let debounceTime = findBot?.debounceTime;\r\n      let ignoreJids = findBot?.ignoreJids;\r\n      let splitMessages = findBot?.splitMessages;\r\n      let timePerChar = findBot?.timePerChar;\r\n\r\n      if (expire === undefined || expire === null) expire = settings.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = settings.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = settings.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = settings.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null) listeningFromMe = settings.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = settings.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = settings.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = settings.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = settings.ignoreJids;\r\n      if (splitMessages === undefined || splitMessages === null) splitMessages = settings?.splitMessages ?? false;\r\n      if (timePerChar === undefined || timePerChar === null) timePerChar = settings?.timePerChar ?? 0;\r\n\r\n      const key = msg.key as {\r\n        id: string;\r\n        remoteJid: string;\r\n        fromMe: boolean;\r\n        participant: string;\r\n      };\r\n\r\n      if (stopBotFromMe && key.fromMe && session) {\r\n        session = await this.sessionRepository.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'paused',\r\n          },\r\n        });\r\n      }\r\n\r\n      if (!listeningFromMe && key.fromMe) {\r\n        return;\r\n      }\r\n\r\n      if (session && !session.awaitUser) {\r\n        return;\r\n      }\r\n\r\n      if (debounceTime && debounceTime > 0) {\r\n        this.processDebounce(this.userMessageDebounce, content, remoteJid, debounceTime, async (debouncedContent) => {\r\n          if (findBot.botType === 'assistant') {\r\n            await this.openaiService.processOpenaiAssistant(\r\n              this.waMonitor.waInstances[instance.instanceName],\r\n              remoteJid,\r\n              pushName,\r\n              key.fromMe,\r\n              findBot,\r\n              session,\r\n              {\r\n                ...settings,\r\n                expire,\r\n                keywordFinish,\r\n                delayMessage,\r\n                unknownMessage,\r\n                listeningFromMe,\r\n                stopBotFromMe,\r\n                keepOpen,\r\n                debounceTime,\r\n                ignoreJids,\r\n                splitMessages,\r\n                timePerChar,\r\n              },\r\n              debouncedContent,\r\n            );\r\n          }\r\n\r\n          if (findBot.botType === 'chatCompletion') {\r\n            await this.openaiService.processOpenaiChatCompletion(\r\n              this.waMonitor.waInstances[instance.instanceName],\r\n              remoteJid,\r\n              pushName,\r\n              findBot,\r\n              session,\r\n              {\r\n                ...settings,\r\n                expire,\r\n                keywordFinish,\r\n                delayMessage,\r\n                unknownMessage,\r\n                listeningFromMe,\r\n                stopBotFromMe,\r\n                keepOpen,\r\n                debounceTime,\r\n                ignoreJids,\r\n                splitMessages,\r\n                timePerChar,\r\n              },\r\n              debouncedContent,\r\n            );\r\n          }\r\n        });\r\n      } else {\r\n        if (findBot.botType === 'assistant') {\r\n          await this.openaiService.processOpenaiAssistant(\r\n            this.waMonitor.waInstances[instance.instanceName],\r\n            remoteJid,\r\n            pushName,\r\n            key.fromMe,\r\n            findBot,\r\n            session,\r\n            settings,\r\n            content,\r\n          );\r\n        }\r\n\r\n        if (findBot.botType === 'chatCompletion') {\r\n          await this.openaiService.processOpenaiChatCompletion(\r\n            this.waMonitor.waInstances[instance.instanceName],\r\n            remoteJid,\r\n            pushName,\r\n            findBot,\r\n            session,\r\n            settings,\r\n            content,\r\n          );\r\n        }\r\n      }\r\n\r\n      return;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { TypebotDto } from '@api/integrations/chatbot/typebot/dto/typebot.dto';\r\nimport { TypebotService } from '@api/integrations/chatbot/typebot/services/typebot.service';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Events } from '@api/types/wa.types';\r\nimport { configService, Typebot } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport { Typebot as TypebotModel } from '@prisma/client';\r\nimport { getConversationMessage } from '@utils/getConversationMessage';\r\nimport axios from 'axios';\r\n\r\nimport { ChatbotController, ChatbotControllerInterface } from '../../chatbot.controller';\r\n\r\nexport class TypebotController extends ChatbotController implements ChatbotControllerInterface {\r\n  constructor(\r\n    private readonly typebotService: TypebotService,\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n  ) {\r\n    super(prismaRepository, waMonitor);\r\n\r\n    this.botRepository = this.prismaRepository.typebot;\r\n    this.settingsRepository = this.prismaRepository.typebotSetting;\r\n    this.sessionRepository = this.prismaRepository.integrationSession;\r\n  }\r\n\r\n  public readonly logger = new Logger('TypebotController');\r\n\r\n  integrationEnabled = configService.get<Typebot>('TYPEBOT').ENABLED;\r\n  botRepository: any;\r\n  settingsRepository: any;\r\n  sessionRepository: any;\r\n  userMessageDebounce: { [key: string]: { message: string; timeoutId: NodeJS.Timeout } } = {};\r\n\r\n  // Bots\r\n  public async createBot(instance: InstanceDto, data: TypebotDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    if (\r\n      !data.expire ||\r\n      !data.keywordFinish ||\r\n      !data.delayMessage ||\r\n      !data.unknownMessage ||\r\n      !data.listeningFromMe ||\r\n      !data.stopBotFromMe ||\r\n      !data.keepOpen ||\r\n      !data.debounceTime ||\r\n      !data.ignoreJids\r\n    ) {\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!data.expire) data.expire = defaultSettingCheck?.expire || 0;\r\n      if (!data.keywordFinish) data.keywordFinish = defaultSettingCheck?.keywordFinish || '#SAIR';\r\n      if (!data.delayMessage) data.delayMessage = defaultSettingCheck?.delayMessage || 1000;\r\n      if (!data.unknownMessage) data.unknownMessage = defaultSettingCheck?.unknownMessage || 'Desculpe, no entendi';\r\n      if (!data.listeningFromMe) data.listeningFromMe = defaultSettingCheck?.listeningFromMe || false;\r\n      if (!data.stopBotFromMe) data.stopBotFromMe = defaultSettingCheck?.stopBotFromMe || false;\r\n      if (!data.keepOpen) data.keepOpen = defaultSettingCheck?.keepOpen || false;\r\n      if (!data.debounceTime) data.debounceTime = defaultSettingCheck?.debounceTime || 0;\r\n      if (!data.ignoreJids) data.ignoreJids = defaultSettingCheck?.ignoreJids || [];\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          ignoreJids: data.ignoreJids,\r\n        });\r\n      }\r\n    }\r\n\r\n    const checkTriggerAll = await this.botRepository.findFirst({\r\n      where: {\r\n        enabled: true,\r\n        triggerType: 'all',\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkTriggerAll && data.triggerType === 'all') {\r\n      throw new Error('You already have a typebot with an \"All\" trigger, you cannot have more bots while it is active');\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        url: data.url,\r\n        typebot: data.typebot,\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Typebot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.create({\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          url: data.url,\r\n          typebot: data.typebot,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          instanceId: instanceId,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error creating typebot');\r\n    }\r\n  }\r\n\r\n  public async findBot(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bots = await this.botRepository.findMany({\r\n      where: {\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (!bots.length) {\r\n      return null;\r\n    }\r\n\r\n    return bots;\r\n  }\r\n\r\n  public async fetchBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const bot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!bot) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n\r\n    if (bot.instanceId !== instanceId) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n\r\n    return bot;\r\n  }\r\n\r\n  public async updateBot(instance: InstanceDto, botId: string, data: TypebotDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const typebot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!typebot) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n\r\n    if (typebot.instanceId !== instanceId) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n\r\n    if (data.triggerType === 'all') {\r\n      const checkTriggerAll = await this.botRepository.findFirst({\r\n        where: {\r\n          enabled: true,\r\n          triggerType: 'all',\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkTriggerAll) {\r\n        throw new Error(\r\n          'You already have a typebot with an \"All\" trigger, you cannot have more bots while it is active',\r\n        );\r\n      }\r\n    }\r\n\r\n    const checkDuplicate = await this.botRepository.findFirst({\r\n      where: {\r\n        url: data.url,\r\n        typebot: data.typebot,\r\n        id: {\r\n          not: botId,\r\n        },\r\n        instanceId: instanceId,\r\n      },\r\n    });\r\n\r\n    if (checkDuplicate) {\r\n      throw new Error('Typebot already exists');\r\n    }\r\n\r\n    if (data.triggerType === 'keyword') {\r\n      if (!data.triggerOperator || !data.triggerValue) {\r\n        throw new Error('Trigger operator and value are required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          id: {\r\n            not: botId,\r\n          },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    if (data.triggerType === 'advanced') {\r\n      if (!data.triggerValue) {\r\n        throw new Error('Trigger value is required');\r\n      }\r\n\r\n      const checkDuplicate = await this.botRepository.findFirst({\r\n        where: {\r\n          triggerValue: data.triggerValue,\r\n          id: { not: botId },\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (checkDuplicate) {\r\n        throw new Error('Trigger already exists');\r\n      }\r\n    }\r\n\r\n    try {\r\n      const bot = await this.botRepository.update({\r\n        where: {\r\n          id: botId,\r\n        },\r\n        data: {\r\n          enabled: data?.enabled,\r\n          description: data.description,\r\n          url: data.url,\r\n          typebot: data.typebot,\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          triggerType: data.triggerType,\r\n          triggerOperator: data.triggerOperator,\r\n          triggerValue: data.triggerValue,\r\n          ignoreJids: data.ignoreJids,\r\n        },\r\n      });\r\n\r\n      return bot;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error updating typebot');\r\n    }\r\n  }\r\n\r\n  public async deleteBot(instance: InstanceDto, botId: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    const instanceId = await this.prismaRepository.instance\r\n      .findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      })\r\n      .then((instance) => instance.id);\r\n\r\n    const typebot = await this.botRepository.findFirst({\r\n      where: {\r\n        id: botId,\r\n      },\r\n    });\r\n\r\n    if (!typebot) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n\r\n    if (typebot.instanceId !== instanceId) {\r\n      throw new Error('Typebot not found');\r\n    }\r\n    try {\r\n      await this.prismaRepository.integrationSession.deleteMany({\r\n        where: {\r\n          botId: botId,\r\n        },\r\n      });\r\n\r\n      await this.botRepository.delete({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      return { typebot: { id: botId } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error deleting typebot');\r\n    }\r\n  }\r\n\r\n  // Settings\r\n  public async settings(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (settings) {\r\n        const updateSettings = await this.settingsRepository.update({\r\n          where: {\r\n            id: settings.id,\r\n          },\r\n          data: {\r\n            expire: data.expire,\r\n            keywordFinish: data.keywordFinish,\r\n            delayMessage: data.delayMessage,\r\n            unknownMessage: data.unknownMessage,\r\n            listeningFromMe: data.listeningFromMe,\r\n            stopBotFromMe: data.stopBotFromMe,\r\n            keepOpen: data.keepOpen,\r\n            debounceTime: data.debounceTime,\r\n            typebotIdFallback: data.typebotIdFallback,\r\n            ignoreJids: data.ignoreJids,\r\n          },\r\n        });\r\n\r\n        return {\r\n          expire: updateSettings.expire,\r\n          keywordFinish: updateSettings.keywordFinish,\r\n          delayMessage: updateSettings.delayMessage,\r\n          unknownMessage: updateSettings.unknownMessage,\r\n          listeningFromMe: updateSettings.listeningFromMe,\r\n          stopBotFromMe: updateSettings.stopBotFromMe,\r\n          keepOpen: updateSettings.keepOpen,\r\n          debounceTime: updateSettings.debounceTime,\r\n          typebotIdFallback: updateSettings.typebotIdFallback,\r\n          ignoreJids: updateSettings.ignoreJids,\r\n        };\r\n      }\r\n\r\n      const newSetttings = await this.settingsRepository.create({\r\n        data: {\r\n          expire: data.expire,\r\n          keywordFinish: data.keywordFinish,\r\n          delayMessage: data.delayMessage,\r\n          unknownMessage: data.unknownMessage,\r\n          listeningFromMe: data.listeningFromMe,\r\n          stopBotFromMe: data.stopBotFromMe,\r\n          keepOpen: data.keepOpen,\r\n          debounceTime: data.debounceTime,\r\n          typebotIdFallback: data.typebotIdFallback,\r\n          ignoreJids: data.ignoreJids,\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      return {\r\n        expire: newSetttings.expire,\r\n        keywordFinish: newSetttings.keywordFinish,\r\n        delayMessage: newSetttings.delayMessage,\r\n        unknownMessage: newSetttings.unknownMessage,\r\n        listeningFromMe: newSetttings.listeningFromMe,\r\n        stopBotFromMe: newSetttings.stopBotFromMe,\r\n        keepOpen: newSetttings.keepOpen,\r\n        debounceTime: newSetttings.debounceTime,\r\n        typebotIdFallback: newSetttings.typebotIdFallback,\r\n        ignoreJids: newSetttings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async fetchSettings(instance: InstanceDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n        include: {\r\n          Fallback: true,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        return {\r\n          expire: 0,\r\n          keywordFinish: '',\r\n          delayMessage: 0,\r\n          unknownMessage: '',\r\n          listeningFromMe: false,\r\n          stopBotFromMe: false,\r\n          keepOpen: false,\r\n          ignoreJids: [],\r\n          typebotIdFallback: null,\r\n          fallback: null,\r\n        };\r\n      }\r\n\r\n      return {\r\n        expire: settings.expire,\r\n        keywordFinish: settings.keywordFinish,\r\n        delayMessage: settings.delayMessage,\r\n        unknownMessage: settings.unknownMessage,\r\n        listeningFromMe: settings.listeningFromMe,\r\n        stopBotFromMe: settings.stopBotFromMe,\r\n        keepOpen: settings.keepOpen,\r\n        ignoreJids: settings.ignoreJids,\r\n        typebotIdFallback: settings.typebotIdFallback,\r\n        fallback: settings.Fallback,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching default settings');\r\n    }\r\n  }\r\n\r\n  // Sessions\r\n  public async startBot(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    if (data.remoteJid === 'status@broadcast') return;\r\n\r\n    const instanceData = await this.prismaRepository.instance.findFirst({\r\n      where: {\r\n        name: instance.instanceName,\r\n      },\r\n    });\r\n\r\n    if (!instanceData) throw new Error('Instance not found');\r\n\r\n    const remoteJid = data.remoteJid;\r\n    const url = data.url;\r\n    const typebot = data.typebot;\r\n    const startSession = data.startSession;\r\n    const variables = data.variables;\r\n    let expire = data?.typebot?.expire;\r\n    let keywordFinish = data?.typebot?.keywordFinish;\r\n    let delayMessage = data?.typebot?.delayMessage;\r\n    let unknownMessage = data?.typebot?.unknownMessage;\r\n    let listeningFromMe = data?.typebot?.listeningFromMe;\r\n    let stopBotFromMe = data?.typebot?.stopBotFromMe;\r\n    let keepOpen = data?.typebot?.keepOpen;\r\n    let debounceTime = data?.typebot?.debounceTime;\r\n    let ignoreJids = data?.typebot?.ignoreJids;\r\n\r\n    const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n      where: {\r\n        instanceId: instanceData.id,\r\n      },\r\n    });\r\n\r\n    if (this.checkIgnoreJids(defaultSettingCheck?.ignoreJids, remoteJid)) throw new Error('Jid not allowed');\r\n\r\n    if (\r\n      !expire ||\r\n      !keywordFinish ||\r\n      !delayMessage ||\r\n      !unknownMessage ||\r\n      !listeningFromMe ||\r\n      !stopBotFromMe ||\r\n      !keepOpen ||\r\n      !debounceTime ||\r\n      !ignoreJids\r\n    ) {\r\n      if (expire === undefined || expire === null) expire = defaultSettingCheck.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = defaultSettingCheck.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = defaultSettingCheck.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = defaultSettingCheck.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null)\r\n        listeningFromMe = defaultSettingCheck.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = defaultSettingCheck.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = defaultSettingCheck.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = defaultSettingCheck.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = defaultSettingCheck.ignoreJids;\r\n\r\n      if (!defaultSettingCheck) {\r\n        await this.settings(instance, {\r\n          expire: expire,\r\n          keywordFinish: keywordFinish,\r\n          delayMessage: delayMessage,\r\n          unknownMessage: unknownMessage,\r\n          listeningFromMe: listeningFromMe,\r\n          stopBotFromMe: stopBotFromMe,\r\n          keepOpen: keepOpen,\r\n          debounceTime: debounceTime,\r\n          ignoreJids: ignoreJids,\r\n        });\r\n      }\r\n    }\r\n\r\n    const prefilledVariables: any = {};\r\n\r\n    if (variables?.length) {\r\n      variables.forEach((variable: { name: string | number; value: string }) => {\r\n        prefilledVariables[variable.name] = variable.value;\r\n      });\r\n    }\r\n\r\n    if (startSession) {\r\n      let findBot: any = await this.botRepository.findFirst({\r\n        where: {\r\n          url: url,\r\n          typebot: typebot,\r\n          instanceId: instanceData.id,\r\n        },\r\n      });\r\n\r\n      if (!findBot) {\r\n        findBot = await this.botRepository.create({\r\n          data: {\r\n            enabled: true,\r\n            url: url,\r\n            typebot: typebot,\r\n            instanceId: instanceData.id,\r\n            expire: expire,\r\n            keywordFinish: keywordFinish,\r\n            delayMessage: delayMessage,\r\n            unknownMessage: unknownMessage,\r\n            listeningFromMe: listeningFromMe,\r\n            stopBotFromMe: stopBotFromMe,\r\n            keepOpen: keepOpen,\r\n          },\r\n        });\r\n      }\r\n\r\n      await this.prismaRepository.integrationSession.deleteMany({\r\n        where: {\r\n          remoteJid: remoteJid,\r\n          instanceId: instanceData.id,\r\n          botId: { not: null },\r\n        },\r\n      });\r\n\r\n      await this.typebotService.processTypebot(\r\n        instanceData,\r\n        remoteJid,\r\n        null,\r\n        null,\r\n        findBot,\r\n        url,\r\n        expire,\r\n        typebot,\r\n        keywordFinish,\r\n        delayMessage,\r\n        unknownMessage,\r\n        listeningFromMe,\r\n        stopBotFromMe,\r\n        keepOpen,\r\n        'init',\r\n        prefilledVariables,\r\n      );\r\n    } else {\r\n      const id = Math.floor(Math.random() * 10000000000).toString();\r\n\r\n      try {\r\n        const version = configService.get<Typebot>('TYPEBOT').API_VERSION;\r\n        let url: string;\r\n        let reqData: {};\r\n        if (version === 'latest') {\r\n          url = `${data.url}/api/v1/typebots/${data.typebot}/startChat`;\r\n\r\n          reqData = {\r\n            prefilledVariables: prefilledVariables,\r\n          };\r\n        } else {\r\n          url = `${data.url}/api/v1/sendMessage`;\r\n\r\n          reqData = {\r\n            startParams: {\r\n              publicId: data.typebot,\r\n              prefilledVariables: prefilledVariables,\r\n            },\r\n          };\r\n        }\r\n        const request = await axios.post(url, reqData);\r\n\r\n        await this.typebotService.sendWAMessage(\r\n          instanceData,\r\n          null,\r\n          {\r\n            expire: expire,\r\n            keywordFinish: keywordFinish,\r\n            delayMessage: delayMessage,\r\n            unknownMessage: unknownMessage,\r\n            listeningFromMe: listeningFromMe,\r\n            stopBotFromMe: stopBotFromMe,\r\n            keepOpen: keepOpen,\r\n          },\r\n          remoteJid,\r\n          request.data.messages,\r\n          request.data.input,\r\n          request.data.clientSideActions,\r\n        );\r\n\r\n        this.waMonitor.waInstances[instance.instanceName].sendDataWebhook(Events.TYPEBOT_START, {\r\n          remoteJid: remoteJid,\r\n          url: url,\r\n          typebot: typebot,\r\n          variables: variables,\r\n          sessionId: id,\r\n        });\r\n      } catch (error) {\r\n        this.logger.error(error);\r\n        return;\r\n      }\r\n    }\r\n\r\n    return {\r\n      typebot: {\r\n        ...instance,\r\n        typebot: {\r\n          url: url,\r\n          remoteJid: remoteJid,\r\n          typebot: typebot,\r\n          prefilledVariables: prefilledVariables,\r\n        },\r\n      },\r\n    };\r\n  }\r\n\r\n  public async changeStatus(instance: InstanceDto, data: any) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const remoteJid = data.remoteJid;\r\n      const status = data.status;\r\n\r\n      const defaultSettingCheck = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId,\r\n        },\r\n      });\r\n\r\n      if (status === 'delete') {\r\n        await this.sessionRepository.deleteMany({\r\n          where: {\r\n            remoteJid: remoteJid,\r\n            instanceId: instanceId,\r\n            botId: { not: null },\r\n          },\r\n        });\r\n\r\n        return { typebot: { ...instance, typebot: { remoteJid: remoteJid, status: status } } };\r\n      }\r\n\r\n      if (status === 'closed') {\r\n        if (defaultSettingCheck?.keepOpen) {\r\n          await this.sessionRepository.updateMany({\r\n            where: {\r\n              instanceId: instanceId,\r\n              remoteJid: remoteJid,\r\n              botId: { not: null },\r\n            },\r\n            data: {\r\n              status: status,\r\n            },\r\n          });\r\n        } else {\r\n          await this.sessionRepository.deleteMany({\r\n            where: {\r\n              remoteJid: remoteJid,\r\n              instanceId: instanceId,\r\n              botId: { not: null },\r\n            },\r\n          });\r\n        }\r\n\r\n        return { typebot: { ...instance, typebot: { remoteJid: remoteJid, status: status } } };\r\n      }\r\n\r\n      const session = await this.sessionRepository.updateMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid: remoteJid,\r\n          botId: { not: null },\r\n        },\r\n        data: {\r\n          status: status,\r\n        },\r\n      });\r\n\r\n      const typebotData = {\r\n        remoteJid: remoteJid,\r\n        status: status,\r\n        session,\r\n      };\r\n\r\n      this.waMonitor.waInstances[instance.instanceName].sendDataWebhook(Events.TYPEBOT_CHANGE_STATUS, typebotData);\r\n\r\n      return { typebot: { ...instance, typebot: typebotData } };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error changing status');\r\n    }\r\n  }\r\n\r\n  public async fetchSessions(instance: InstanceDto, botId: string, remoteJid?: string) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const typebot = await this.botRepository.findFirst({\r\n        where: {\r\n          id: botId,\r\n        },\r\n      });\r\n\r\n      if (typebot && typebot.instanceId !== instanceId) {\r\n        throw new Error('Typebot not found');\r\n      }\r\n\r\n      return await this.sessionRepository.findMany({\r\n        where: {\r\n          instanceId: instanceId,\r\n          remoteJid,\r\n          botId: botId ?? { not: null },\r\n          type: 'typebot',\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error fetching sessions');\r\n    }\r\n  }\r\n\r\n  public async ignoreJid(instance: InstanceDto, data: IgnoreJidDto) {\r\n    if (!this.integrationEnabled) throw new BadRequestException('Typebot is disabled');\r\n\r\n    try {\r\n      const instanceId = await this.prismaRepository.instance\r\n        .findFirst({\r\n          where: {\r\n            name: instance.instanceName,\r\n          },\r\n        })\r\n        .then((instance) => instance.id);\r\n\r\n      const settings = await this.settingsRepository.findFirst({\r\n        where: {\r\n          instanceId: instanceId,\r\n        },\r\n      });\r\n\r\n      if (!settings) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      let ignoreJids: any = settings?.ignoreJids || [];\r\n\r\n      if (data.action === 'add') {\r\n        if (ignoreJids.includes(data.remoteJid)) return { ignoreJids: ignoreJids };\r\n\r\n        ignoreJids.push(data.remoteJid);\r\n      } else {\r\n        ignoreJids = ignoreJids.filter((jid) => jid !== data.remoteJid);\r\n      }\r\n\r\n      const updateSettings = await this.settingsRepository.update({\r\n        where: {\r\n          id: settings.id,\r\n        },\r\n        data: {\r\n          ignoreJids: ignoreJids,\r\n        },\r\n      });\r\n\r\n      return {\r\n        ignoreJids: updateSettings.ignoreJids,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error setting default settings');\r\n    }\r\n  }\r\n\r\n  public async emit({\r\n    instance,\r\n    remoteJid,\r\n    msg,\r\n  }: {\r\n    instance: InstanceDto;\r\n    remoteJid: string;\r\n    msg: any;\r\n    pushName?: string;\r\n  }) {\r\n    if (!this.integrationEnabled) return;\r\n\r\n    try {\r\n      const instanceData = await this.prismaRepository.instance.findFirst({\r\n        where: {\r\n          name: instance.instanceName,\r\n        },\r\n      });\r\n\r\n      if (!instanceData) throw new Error('Instance not found');\r\n\r\n      const session = await this.getSession(remoteJid, instance);\r\n\r\n      const content = getConversationMessage(msg);\r\n\r\n      let findBot = (await this.findBotTrigger(this.botRepository, content, instance, session)) as TypebotModel;\r\n\r\n      if (!findBot) {\r\n        const fallback = await this.settingsRepository.findFirst({\r\n          where: {\r\n            instanceId: instance.instanceId,\r\n          },\r\n        });\r\n\r\n        if (fallback?.typebotIdFallback) {\r\n          const findFallback = await this.botRepository.findFirst({\r\n            where: {\r\n              id: fallback.typebotIdFallback,\r\n            },\r\n          });\r\n\r\n          findBot = findFallback;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      const settings = await this.prismaRepository.typebotSetting.findFirst({\r\n        where: {\r\n          instanceId: instance.instanceId,\r\n        },\r\n      });\r\n\r\n      const url = findBot?.url;\r\n      const typebot = findBot?.typebot;\r\n      let expire = findBot?.expire;\r\n      let keywordFinish = findBot?.keywordFinish;\r\n      let delayMessage = findBot?.delayMessage;\r\n      let unknownMessage = findBot?.unknownMessage;\r\n      let listeningFromMe = findBot?.listeningFromMe;\r\n      let stopBotFromMe = findBot?.stopBotFromMe;\r\n      let keepOpen = findBot?.keepOpen;\r\n      let debounceTime = findBot?.debounceTime;\r\n      let ignoreJids = findBot?.ignoreJids;\r\n\r\n      if (expire === undefined || expire === null) expire = settings.expire;\r\n      if (keywordFinish === undefined || keywordFinish === null) keywordFinish = settings.keywordFinish;\r\n      if (delayMessage === undefined || delayMessage === null) delayMessage = settings.delayMessage;\r\n      if (unknownMessage === undefined || unknownMessage === null) unknownMessage = settings.unknownMessage;\r\n      if (listeningFromMe === undefined || listeningFromMe === null) listeningFromMe = settings.listeningFromMe;\r\n      if (stopBotFromMe === undefined || stopBotFromMe === null) stopBotFromMe = settings.stopBotFromMe;\r\n      if (keepOpen === undefined || keepOpen === null) keepOpen = settings.keepOpen;\r\n      if (debounceTime === undefined || debounceTime === null) debounceTime = settings.debounceTime;\r\n      if (ignoreJids === undefined || ignoreJids === null) ignoreJids = settings.ignoreJids;\r\n\r\n      if (this.checkIgnoreJids(ignoreJids, remoteJid)) return;\r\n\r\n      const key = msg.key as {\r\n        id: string;\r\n        remoteJid: string;\r\n        fromMe: boolean;\r\n        participant: string;\r\n      };\r\n\r\n      if (stopBotFromMe && key.fromMe && session) {\r\n        await this.sessionRepository.update({\r\n          where: {\r\n            id: session.id,\r\n          },\r\n          data: {\r\n            status: 'paused',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!listeningFromMe && key.fromMe) {\r\n        return;\r\n      }\r\n\r\n      if (session && !session.awaitUser) {\r\n        return;\r\n      }\r\n\r\n      if (debounceTime && debounceTime > 0) {\r\n        this.processDebounce(this.userMessageDebounce, content, remoteJid, debounceTime, async (debouncedContent) => {\r\n          await this.typebotService.processTypebot(\r\n            instanceData,\r\n            remoteJid,\r\n            msg,\r\n            session,\r\n            findBot,\r\n            url,\r\n            expire,\r\n            typebot,\r\n            keywordFinish,\r\n            delayMessage,\r\n            unknownMessage,\r\n            listeningFromMe,\r\n            stopBotFromMe,\r\n            keepOpen,\r\n            debouncedContent,\r\n          );\r\n        });\r\n      } else {\r\n        await this.typebotService.processTypebot(\r\n          instanceData,\r\n          remoteJid,\r\n          msg,\r\n          session,\r\n          findBot,\r\n          url,\r\n          expire,\r\n          typebot,\r\n          keywordFinish,\r\n          delayMessage,\r\n          unknownMessage,\r\n          listeningFromMe,\r\n          stopBotFromMe,\r\n          keepOpen,\r\n          content,\r\n        );\r\n      }\r\n\r\n      if (session && !session.awaitUser) return;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { EventDto } from '@api/integrations/event/event.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { wa } from '@api/types/wa.types';\r\nimport { configService, Log, Pusher as ConfigPusher } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport Pusher from 'pusher';\r\n\r\nimport { EmitData, EventController, EventControllerInterface } from '../event.controller';\r\nexport class PusherController extends EventController implements EventControllerInterface {\r\n  private readonly logger = new Logger('PusherController');\r\n  private pusherClients: { [instanceName: string]: Pusher } = {};\r\n  private globalPusherClient: Pusher | null = null;\r\n  private pusherConfig: ConfigPusher = configService.get<ConfigPusher>('PUSHER');\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor, configService.get<ConfigPusher>('PUSHER')?.ENABLED, 'pusher');\r\n    this.init();\r\n  }\r\n  public async init(): Promise<void> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n    if (this.pusherConfig.GLOBAL?.ENABLED) {\r\n      const { APP_ID, KEY, SECRET, CLUSTER, USE_TLS } = this.pusherConfig.GLOBAL;\r\n      if (APP_ID && KEY && SECRET && CLUSTER) {\r\n        this.globalPusherClient = new Pusher({\r\n          appId: APP_ID,\r\n          key: KEY,\r\n          secret: SECRET,\r\n          cluster: CLUSTER,\r\n          useTLS: USE_TLS,\r\n        });\r\n        this.logger.info('Pusher global client initialized');\r\n      }\r\n    }\r\n    const instances = await this.prismaRepository.instance.findMany({\r\n      where: {\r\n        Pusher: {\r\n          isNot: null,\r\n        },\r\n      },\r\n      include: {\r\n        Pusher: true,\r\n      },\r\n    });\r\n    instances.forEach((instance) => {\r\n      if (\r\n        instance.Pusher.enabled &&\r\n        instance.Pusher.appId &&\r\n        instance.Pusher.key &&\r\n        instance.Pusher.secret &&\r\n        instance.Pusher.cluster\r\n      ) {\r\n        this.pusherClients[instance.name] = new Pusher({\r\n          appId: instance.Pusher.appId,\r\n          key: instance.Pusher.key,\r\n          secret: instance.Pusher.secret,\r\n          cluster: instance.Pusher.cluster,\r\n          useTLS: instance.Pusher.useTLS,\r\n        });\r\n        this.logger.info(`Pusher client initialized for instance ${instance.name}`);\r\n      } else {\r\n        delete this.pusherClients[instance.name];\r\n        this.logger.warn(`Pusher client disabled or misconfigured for instance ${instance.name}`);\r\n      }\r\n    });\r\n  }\r\n  override async set(instanceName: string, data: EventDto): Promise<wa.LocalPusher> {\r\n    if (!data.pusher?.enabled) {\r\n      data.pusher.events = [];\r\n    } else if (data.pusher.events.length === 0) {\r\n      data.pusher.events = EventController.events;\r\n    }\r\n    const instance = await this.prisma.pusher.upsert({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n      update: {\r\n        enabled: data.pusher.enabled,\r\n        events: data.pusher.events,\r\n        appId: data.pusher.appId,\r\n        key: data.pusher.key,\r\n        secret: data.pusher.secret,\r\n        cluster: data.pusher.cluster,\r\n        useTLS: data.pusher.useTLS,\r\n      },\r\n      create: {\r\n        enabled: data.pusher.enabled,\r\n        events: data.pusher.events,\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n        appId: data.pusher.appId,\r\n        key: data.pusher.key,\r\n        secret: data.pusher.secret,\r\n        cluster: data.pusher.cluster,\r\n        useTLS: data.pusher.useTLS,\r\n      },\r\n    });\r\n    if (instance.enabled && instance.appId && instance.key && instance.secret && instance.cluster) {\r\n      this.pusherClients[instanceName] = new Pusher({\r\n        appId: instance.appId,\r\n        key: instance.key,\r\n        secret: instance.secret,\r\n        cluster: instance.cluster,\r\n        useTLS: instance.useTLS,\r\n      });\r\n      this.logger.info(`Pusher client initialized for instance ${instanceName}`);\r\n    } else {\r\n      delete this.pusherClients[instanceName];\r\n      this.logger.warn(`Pusher client disabled or misconfigured for instance ${instanceName}`);\r\n    }\r\n    return instance;\r\n  }\r\n  public async emit({\r\n    instanceName,\r\n    origin,\r\n    event,\r\n    data,\r\n    serverUrl,\r\n    dateTime,\r\n    sender,\r\n    apiKey,\r\n    local,\r\n    integration,\r\n  }: EmitData): Promise<void> {\r\n    if (integration && !integration.includes('pusher')) {\r\n      return;\r\n    }\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n    const instance = (await this.get(instanceName)) as wa.LocalPusher;\r\n    const we = event.replace(/[.-]/gm, '_').toUpperCase();\r\n    const enabledLog = configService.get<Log>('LOG').LEVEL.includes('WEBHOOKS');\r\n    const eventName = event.replace(/_/g, '.').toLowerCase();\r\n    const pusherData = {\r\n      event,\r\n      instance: instanceName,\r\n      data,\r\n      destination: instance?.appId || this.pusherConfig.GLOBAL?.APP_ID,\r\n      date_time: dateTime,\r\n      sender,\r\n      server_url: serverUrl,\r\n      apikey: apiKey,\r\n    };\r\n    if (event == 'qrcode.updated') {\r\n      delete pusherData.data.qrcode.base64;\r\n    }\r\n    const payload = JSON.stringify(pusherData);\r\n    const payloadSize = Buffer.byteLength(payload, 'utf8');\r\n    const MAX_SIZE = 10240;\r\n    if (payloadSize > MAX_SIZE) {\r\n      this.logger.error({\r\n        local: `${origin}.sendData-Pusher`,\r\n        message: 'Payload size exceeds Pusher limit',\r\n        event,\r\n        instanceName,\r\n        payloadSize,\r\n      });\r\n      return;\r\n    }\r\n    if (local && instance && instance.enabled) {\r\n      const pusherLocalEvents = instance.events;\r\n      if (Array.isArray(pusherLocalEvents) && pusherLocalEvents.includes(we)) {\r\n        if (enabledLog) {\r\n          this.logger.log({\r\n            local: `${origin}.sendData-Pusher`,\r\n            appId: instance.appId,\r\n            ...pusherData,\r\n          });\r\n        }\r\n        try {\r\n          const pusher = this.pusherClients[instanceName];\r\n          if (pusher) {\r\n            pusher.trigger(instanceName, eventName, pusherData);\r\n          } else {\r\n            this.logger.error(`Pusher client not found for instance ${instanceName}`);\r\n          }\r\n        } catch (error) {\r\n          this.logger.error({\r\n            local: `${origin}.sendData-Pusher`,\r\n            message: error?.message,\r\n            error,\r\n          });\r\n        }\r\n      }\r\n    }\r\n    if (this.pusherConfig.GLOBAL?.ENABLED) {\r\n      const globalEvents = this.pusherConfig.EVENTS;\r\n      if (globalEvents[we]) {\r\n        if (enabledLog) {\r\n          this.logger.log({\r\n            local: `${origin}.sendData-Pusher-Global`,\r\n            appId: this.pusherConfig.GLOBAL?.APP_ID,\r\n            ...pusherData,\r\n          });\r\n        }\r\n        try {\r\n          if (this.globalPusherClient) {\r\n            this.globalPusherClient.trigger(instanceName, eventName, pusherData);\r\n          } else {\r\n            this.logger.error('Global Pusher client not initialized');\r\n          }\r\n        } catch (error) {\r\n          this.logger.error({\r\n            local: `${origin}.sendData-Pusher-Global`,\r\n            message: error?.message,\r\n            error,\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { EventDto } from '@api/integrations/event/event.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { wa } from '@api/types/wa.types';\r\n\r\nexport type EmitData = {\r\n  instanceName: string;\r\n  origin: string;\r\n  event: string;\r\n  data: any;\r\n  serverUrl: string;\r\n  dateTime: string;\r\n  sender: string;\r\n  apiKey?: string;\r\n  local?: boolean;\r\n  integration?: string[];\r\n};\r\n\r\nexport interface EventControllerInterface {\r\n  set(instanceName: string, data: any): Promise<any>;\r\n  get(instanceName: string): Promise<any>;\r\n  emit({ instanceName, origin, event, data, serverUrl, dateTime, sender, apiKey, local }: EmitData): Promise<void>;\r\n}\r\n\r\nexport class EventController {\r\n  public prismaRepository: PrismaRepository;\r\n  protected waMonitor: WAMonitoringService;\r\n  private integrationStatus: boolean;\r\n  private integrationName: string;\r\n\r\n  constructor(\r\n    prismaRepository: PrismaRepository,\r\n    waMonitor: WAMonitoringService,\r\n    integrationStatus: boolean,\r\n    integrationName: string,\r\n  ) {\r\n    this.prisma = prismaRepository;\r\n    this.monitor = waMonitor;\r\n    this.status = integrationStatus;\r\n    this.name = integrationName;\r\n  }\r\n\r\n  public set prisma(prisma: PrismaRepository) {\r\n    this.prismaRepository = prisma;\r\n  }\r\n\r\n  public get prisma() {\r\n    return this.prismaRepository;\r\n  }\r\n\r\n  public set monitor(waMonitor: WAMonitoringService) {\r\n    this.waMonitor = waMonitor;\r\n  }\r\n\r\n  public get monitor() {\r\n    return this.waMonitor;\r\n  }\r\n\r\n  public set name(name: string) {\r\n    this.integrationName = name;\r\n  }\r\n\r\n  public get name() {\r\n    return this.integrationName;\r\n  }\r\n\r\n  public set status(status: boolean) {\r\n    this.integrationStatus = status;\r\n  }\r\n\r\n  public get status() {\r\n    return this.integrationStatus;\r\n  }\r\n\r\n  public async set(instanceName: string, data: EventDto): Promise<wa.LocalEvent> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    if (!data[this.name]?.enabled) {\r\n      data[this.name].events = [];\r\n    } else {\r\n      if (0 === data[this.name].events.length) {\r\n        data[this.name].events = EventController.events;\r\n      }\r\n    }\r\n\r\n    return this.prisma[this.name].upsert({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n      update: {\r\n        enabled: data[this.name]?.enabled,\r\n        events: data[this.name].events,\r\n      },\r\n      create: {\r\n        enabled: data[this.name]?.enabled,\r\n        events: data[this.name].events,\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async get(instanceName: string): Promise<wa.LocalEvent> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    if (undefined === this.monitor.waInstances[instanceName]) {\r\n      return null;\r\n    }\r\n\r\n    const data = await this.prisma[this.name].findUnique({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n    });\r\n\r\n    if (!data) {\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  public static readonly events = [\r\n    'APPLICATION_STARTUP',\r\n    'QRCODE_UPDATED',\r\n    'MESSAGES_SET',\r\n    'MESSAGES_UPSERT',\r\n    'MESSAGES_EDITED',\r\n    'MESSAGES_UPDATE',\r\n    'MESSAGES_DELETE',\r\n    'SEND_MESSAGE',\r\n    'CONTACTS_SET',\r\n    'CONTACTS_UPSERT',\r\n    'CONTACTS_UPDATE',\r\n    'PRESENCE_UPDATE',\r\n    'CHATS_SET',\r\n    'CHATS_UPSERT',\r\n    'CHATS_UPDATE',\r\n    'CHATS_DELETE',\r\n    'GROUPS_UPSERT',\r\n    'GROUP_UPDATE',\r\n    'GROUP_PARTICIPANTS_UPDATE',\r\n    'CONNECTION_UPDATE',\r\n    'LABELS_EDIT',\r\n    'LABELS_ASSOCIATION',\r\n    'CALL',\r\n    'TYPEBOT_START',\r\n    'TYPEBOT_CHANGE_STATUS',\r\n    'REMOVE_INSTANCE',\r\n    'LOGOUT_INSTANCE',\r\n  ];\r\n}\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { configService, Log, Rabbitmq } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport * as amqp from 'amqplib/callback_api';\r\n\r\nimport { EmitData, EventController, EventControllerInterface } from '../event.controller';\r\n\r\nexport class RabbitmqController extends EventController implements EventControllerInterface {\r\n  public amqpChannel: amqp.Channel | null = null;\r\n  private readonly logger = new Logger('RabbitmqController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor, configService.get<Rabbitmq>('RABBITMQ')?.ENABLED, 'rabbitmq');\r\n  }\r\n\r\n  public async init(): Promise<void> {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    await new Promise<void>((resolve, reject) => {\r\n      const uri = configService.get<Rabbitmq>('RABBITMQ').URI;\r\n      const rabbitmqExchangeName = configService.get<Rabbitmq>('RABBITMQ').EXCHANGE_NAME;\r\n\r\n      amqp.connect(uri, (error, connection) => {\r\n        if (error) {\r\n          reject(error);\r\n\r\n          return;\r\n        }\r\n\r\n        connection.createChannel((channelError, channel) => {\r\n          if (channelError) {\r\n            reject(channelError);\r\n\r\n            return;\r\n          }\r\n\r\n          const exchangeName = rabbitmqExchangeName;\r\n\r\n          channel.assertExchange(exchangeName, 'topic', {\r\n            durable: true,\r\n            autoDelete: false,\r\n          });\r\n\r\n          this.amqpChannel = channel;\r\n\r\n          this.logger.info('AMQP initialized');\r\n\r\n          resolve();\r\n        });\r\n      });\r\n    }).then(() => {\r\n      if (configService.get<Rabbitmq>('RABBITMQ')?.GLOBAL_ENABLED) this.initGlobalQueues();\r\n    });\r\n  }\r\n\r\n  private set channel(channel: amqp.Channel) {\r\n    this.amqpChannel = channel;\r\n  }\r\n\r\n  public get channel(): amqp.Channel {\r\n    return this.amqpChannel;\r\n  }\r\n\r\n  public async emit({\r\n    instanceName,\r\n    origin,\r\n    event,\r\n    data,\r\n    serverUrl,\r\n    dateTime,\r\n    sender,\r\n    apiKey,\r\n    integration,\r\n  }: EmitData): Promise<void> {\r\n    if (integration && !integration.includes('rabbitmq')) {\r\n      return;\r\n    }\r\n\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    const instanceRabbitmq = await this.get(instanceName);\r\n    const rabbitmqLocal = instanceRabbitmq?.events;\r\n    const rabbitmqGlobal = configService.get<Rabbitmq>('RABBITMQ').GLOBAL_ENABLED;\r\n    const rabbitmqEvents = configService.get<Rabbitmq>('RABBITMQ').EVENTS;\r\n    const prefixKey = configService.get<Rabbitmq>('RABBITMQ').PREFIX_KEY;\r\n    const rabbitmqExchangeName = configService.get<Rabbitmq>('RABBITMQ').EXCHANGE_NAME;\r\n    const we = event.replace(/[.-]/gm, '_').toUpperCase();\r\n    const logEnabled = configService.get<Log>('LOG').LEVEL.includes('WEBHOOKS');\r\n\r\n    const message = {\r\n      event,\r\n      instance: instanceName,\r\n      data,\r\n      server_url: serverUrl,\r\n      date_time: dateTime,\r\n      sender,\r\n      apikey: apiKey,\r\n    };\r\n\r\n    if (instanceRabbitmq?.enabled && this.amqpChannel) {\r\n      if (Array.isArray(rabbitmqLocal) && rabbitmqLocal.includes(we)) {\r\n        const exchangeName = instanceName ?? rabbitmqExchangeName;\r\n\r\n        let retry = 0;\r\n\r\n        while (retry < 3) {\r\n          try {\r\n            await this.amqpChannel.assertExchange(exchangeName, 'topic', {\r\n              durable: true,\r\n              autoDelete: false,\r\n            });\r\n\r\n            const eventName = event.replace(/_/g, '.').toLowerCase();\r\n\r\n            const queueName = `${instanceName}.${eventName}`;\r\n\r\n            await this.amqpChannel.assertQueue(queueName, {\r\n              durable: true,\r\n              autoDelete: false,\r\n              arguments: {\r\n                'x-queue-type': 'quorum',\r\n              },\r\n            });\r\n\r\n            await this.amqpChannel.bindQueue(queueName, exchangeName, eventName);\r\n\r\n            await this.amqpChannel.publish(exchangeName, event, Buffer.from(JSON.stringify(message)));\r\n\r\n            if (logEnabled) {\r\n              const logData = {\r\n                local: `${origin}.sendData-RabbitMQ`,\r\n                ...message,\r\n              };\r\n\r\n              this.logger.log(logData);\r\n            }\r\n\r\n            break;\r\n          } catch (error) {\r\n            retry++;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (rabbitmqGlobal && rabbitmqEvents[we] && this.amqpChannel) {\r\n      const exchangeName = rabbitmqExchangeName;\r\n\r\n      let retry = 0;\r\n\r\n      while (retry < 3) {\r\n        try {\r\n          await this.amqpChannel.assertExchange(exchangeName, 'topic', {\r\n            durable: true,\r\n            autoDelete: false,\r\n          });\r\n\r\n          const queueName = prefixKey\r\n            ? `${prefixKey}.${event.replace(/_/g, '.').toLowerCase()}`\r\n            : event.replace(/_/g, '.').toLowerCase();\r\n\r\n          await this.amqpChannel.assertQueue(queueName, {\r\n            durable: true,\r\n            autoDelete: false,\r\n            arguments: {\r\n              'x-queue-type': 'quorum',\r\n            },\r\n          });\r\n\r\n          await this.amqpChannel.bindQueue(queueName, exchangeName, event);\r\n\r\n          await this.amqpChannel.publish(exchangeName, event, Buffer.from(JSON.stringify(message)));\r\n\r\n          if (logEnabled) {\r\n            const logData = {\r\n              local: `${origin}.sendData-RabbitMQ-Global`,\r\n              ...message,\r\n            };\r\n\r\n            this.logger.log(logData);\r\n          }\r\n\r\n          break;\r\n        } catch (error) {\r\n          retry++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async initGlobalQueues(): Promise<void> {\r\n    this.logger.info('Initializing global queues');\r\n\r\n    const rabbitmqExchangeName = configService.get<Rabbitmq>('RABBITMQ').EXCHANGE_NAME;\r\n    const events = configService.get<Rabbitmq>('RABBITMQ').EVENTS;\r\n    const prefixKey = configService.get<Rabbitmq>('RABBITMQ').PREFIX_KEY;\r\n\r\n    if (!events) {\r\n      this.logger.warn('No events to initialize on AMQP');\r\n\r\n      return;\r\n    }\r\n\r\n    const eventKeys = Object.keys(events);\r\n\r\n    eventKeys.forEach((event) => {\r\n      if (events[event] === false) return;\r\n\r\n      const queueName =\r\n        prefixKey !== ''\r\n          ? `${prefixKey}.${event.replace(/_/g, '.').toLowerCase()}`\r\n          : `${event.replace(/_/g, '.').toLowerCase()}`;\r\n      const exchangeName = rabbitmqExchangeName;\r\n\r\n      this.amqpChannel.assertExchange(exchangeName, 'topic', {\r\n        durable: true,\r\n        autoDelete: false,\r\n      });\r\n\r\n      this.amqpChannel.assertQueue(queueName, {\r\n        durable: true,\r\n        autoDelete: false,\r\n        arguments: {\r\n          'x-queue-type': 'quorum',\r\n        },\r\n      });\r\n\r\n      this.amqpChannel.bindQueue(queueName, exchangeName, event);\r\n    });\r\n  }\r\n}\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { SQS } from '@aws-sdk/client-sqs';\r\nimport { configService, Log, Sqs } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\n\r\nimport { EmitData, EventController, EventControllerInterface } from '../event.controller';\r\n\r\nexport class SqsController extends EventController implements EventControllerInterface {\r\n  private sqs: SQS;\r\n  private readonly logger = new Logger('SqsController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor, configService.get<Sqs>('SQS')?.ENABLED, 'sqs');\r\n  }\r\n\r\n  public init(): void {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    new Promise<void>((resolve) => {\r\n      const awsConfig = configService.get<Sqs>('SQS');\r\n\r\n      this.sqs = new SQS({\r\n        credentials: {\r\n          accessKeyId: awsConfig.ACCESS_KEY_ID,\r\n          secretAccessKey: awsConfig.SECRET_ACCESS_KEY,\r\n        },\r\n\r\n        region: awsConfig.REGION,\r\n      });\r\n\r\n      this.logger.info('SQS initialized');\r\n\r\n      resolve();\r\n    });\r\n  }\r\n\r\n  private set channel(sqs: SQS) {\r\n    this.sqs = sqs;\r\n  }\r\n\r\n  public get channel(): SQS {\r\n    return this.sqs;\r\n  }\r\n\r\n  public async emit({\r\n    instanceName,\r\n    origin,\r\n    event,\r\n    data,\r\n    serverUrl,\r\n    dateTime,\r\n    sender,\r\n    apiKey,\r\n    integration,\r\n  }: EmitData): Promise<void> {\r\n    if (integration && !integration.includes('sqs')) {\r\n      return;\r\n    }\r\n\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    const instanceSqs = await this.get(instanceName);\r\n    const sqsLocal = instanceSqs?.events;\r\n    const we = event.replace(/[.-]/gm, '_').toUpperCase();\r\n\r\n    if (instanceSqs?.enabled) {\r\n      if (this.sqs) {\r\n        if (Array.isArray(sqsLocal) && sqsLocal.includes(we)) {\r\n          const eventFormatted = `${event.replace('.', '_').toLowerCase()}`;\r\n          const queueName = `${instanceName}_${eventFormatted}.fifo`;\r\n          const sqsConfig = configService.get<Sqs>('SQS');\r\n          const sqsUrl = `https://sqs.${sqsConfig.REGION}.amazonaws.com/${sqsConfig.ACCOUNT_ID}/${queueName}`;\r\n\r\n          const message = {\r\n            event,\r\n            instance: instanceName,\r\n            data,\r\n            server_url: serverUrl,\r\n            date_time: dateTime,\r\n            sender,\r\n            apikey: apiKey,\r\n          };\r\n\r\n          const params = {\r\n            MessageBody: JSON.stringify(message),\r\n            MessageGroupId: 'evolution',\r\n            MessageDeduplicationId: `${instanceName}_${eventFormatted}_${Date.now()}`,\r\n            QueueUrl: sqsUrl,\r\n          };\r\n\r\n          this.sqs.sendMessage(params, (err) => {\r\n            if (err) {\r\n              this.logger.error({\r\n                local: `${origin}.sendData-SQS`,\r\n                message: err?.message,\r\n                hostName: err?.hostname,\r\n                code: err?.code,\r\n                stack: err?.stack,\r\n                name: err?.name,\r\n                url: queueName,\r\n                server_url: serverUrl,\r\n              });\r\n            } else {\r\n              if (configService.get<Log>('LOG').LEVEL.includes('WEBHOOKS')) {\r\n                const logData = {\r\n                  local: `${origin}.sendData-SQS`,\r\n                  ...message,\r\n                };\r\n\r\n                this.logger.log(logData);\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public async initQueues(instanceName: string, events: string[]) {\r\n    if (!events || !events.length) return;\r\n\r\n    const queues = events.map((event) => {\r\n      return `${event.replace(/_/g, '_').toLowerCase()}`;\r\n    });\r\n\r\n    queues.forEach((event) => {\r\n      const queueName = `${instanceName}_${event}.fifo`;\r\n\r\n      this.sqs.createQueue(\r\n        {\r\n          QueueName: queueName,\r\n          Attributes: {\r\n            FifoQueue: 'true',\r\n          },\r\n        },\r\n        (err, data) => {\r\n          if (err) {\r\n            this.logger.error(`Error creating queue ${queueName}: ${err.message}`);\r\n          } else {\r\n            this.logger.info(`Queue ${queueName} created: ${data.QueueUrl}`);\r\n          }\r\n        },\r\n      );\r\n    });\r\n  }\r\n\r\n  public async removeQueues(instanceName: string, events: any) {\r\n    const eventsArray = Array.isArray(events) ? events.map((event) => String(event)) : [];\r\n    if (!events || !eventsArray.length) return;\r\n\r\n    const queues = eventsArray.map((event) => {\r\n      return `${event.replace(/_/g, '_').toLowerCase()}`;\r\n    });\r\n\r\n    queues.forEach((event) => {\r\n      const queueName = `${instanceName}_${event}.fifo`;\r\n\r\n      this.sqs.getQueueUrl(\r\n        {\r\n          QueueName: queueName,\r\n        },\r\n        (err, data) => {\r\n          if (err) {\r\n            this.logger.error(`Error getting queue URL for ${queueName}: ${err.message}`);\r\n          } else {\r\n            const queueUrl = data.QueueUrl;\r\n\r\n            this.sqs.deleteQueue(\r\n              {\r\n                QueueUrl: queueUrl,\r\n              },\r\n              (deleteErr) => {\r\n                if (deleteErr) {\r\n                  this.logger.error(`Error deleting queue ${queueName}: ${deleteErr.message}`);\r\n                } else {\r\n                  this.logger.info(`Queue ${queueName} deleted`);\r\n                }\r\n              },\r\n            );\r\n          }\r\n        },\r\n      );\r\n    });\r\n  }\r\n}\r\n","import { EventDto } from '@api/integrations/event/event.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { wa } from '@api/types/wa.types';\r\nimport { configService, Log, Webhook } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\nimport axios, { AxiosInstance } from 'axios';\r\nimport { isURL } from 'class-validator';\r\n\r\nimport { EmitData, EventController, EventControllerInterface } from '../event.controller';\r\n\r\nexport class WebhookController extends EventController implements EventControllerInterface {\r\n  private readonly logger = new Logger('WebhookController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor, true, 'webhook');\r\n  }\r\n\r\n  override async set(instanceName: string, data: EventDto): Promise<wa.LocalWebHook> {\r\n    if (!isURL(data.webhook.url, { require_tld: false })) {\r\n      throw new BadRequestException('Invalid \"url\" property');\r\n    }\r\n\r\n    if (!data.webhook?.enabled) {\r\n      data.webhook.events = [];\r\n    } else {\r\n      if (0 === data.webhook.events.length) {\r\n        data.webhook.events = EventController.events;\r\n      }\r\n    }\r\n\r\n    return this.prisma.webhook.upsert({\r\n      where: {\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n      },\r\n      update: {\r\n        enabled: data.webhook?.enabled,\r\n        events: data.webhook?.events,\r\n        url: data.webhook?.url,\r\n        headers: data.webhook?.headers,\r\n        webhookBase64: data.webhook.base64,\r\n        webhookByEvents: data.webhook.byEvents,\r\n      },\r\n      create: {\r\n        enabled: data.webhook?.enabled,\r\n        events: data.webhook?.events,\r\n        instanceId: this.monitor.waInstances[instanceName].instanceId,\r\n        url: data.webhook?.url,\r\n        headers: data.webhook?.headers,\r\n        webhookBase64: data.webhook.base64,\r\n        webhookByEvents: data.webhook.byEvents,\r\n      },\r\n    });\r\n  }\r\n\r\n  public async emit({\r\n    instanceName,\r\n    origin,\r\n    event,\r\n    data,\r\n    serverUrl,\r\n    dateTime,\r\n    sender,\r\n    apiKey,\r\n    local,\r\n    integration,\r\n  }: EmitData): Promise<void> {\r\n    if (integration && !integration.includes('webhook')) {\r\n      return;\r\n    }\r\n\r\n    const instance = (await this.get(instanceName)) as wa.LocalWebHook;\r\n\r\n    const webhookConfig = configService.get<Webhook>('WEBHOOK');\r\n    const webhookLocal = instance?.events;\r\n    const webhookHeaders = instance?.headers;\r\n    const we = event.replace(/[.-]/gm, '_').toUpperCase();\r\n    const transformedWe = we.replace(/_/gm, '-').toLowerCase();\r\n    const enabledLog = configService.get<Log>('LOG').LEVEL.includes('WEBHOOKS');\r\n\r\n    const webhookData = {\r\n      event,\r\n      instance: instanceName,\r\n      data,\r\n      destination: instance?.url || `${webhookConfig.GLOBAL.URL}/${transformedWe}`,\r\n      date_time: dateTime,\r\n      sender,\r\n      server_url: serverUrl,\r\n      apikey: apiKey,\r\n    };\r\n\r\n    if (local && instance?.enabled) {\r\n      if (Array.isArray(webhookLocal) && webhookLocal.includes(we)) {\r\n        let baseURL: string;\r\n\r\n        if (instance?.webhookByEvents) {\r\n          baseURL = `${instance?.url}/${transformedWe}`;\r\n        } else {\r\n          baseURL = instance?.url;\r\n        }\r\n\r\n        if (enabledLog) {\r\n          const logData = {\r\n            local: `${origin}.sendData-Webhook`,\r\n            url: baseURL,\r\n            ...webhookData,\r\n          };\r\n\r\n          this.logger.log(logData);\r\n        }\r\n\r\n        try {\r\n          if (instance?.enabled && isURL(instance.url, { require_tld: false })) {\r\n            const httpService = axios.create({\r\n              baseURL,\r\n              headers: webhookHeaders as Record<string, string> | undefined,\r\n            });\r\n\r\n            await this.retryWebhookRequest(httpService, webhookData, `${origin}.sendData-Webhook`, baseURL, serverUrl);\r\n          }\r\n        } catch (error) {\r\n          this.logger.error({\r\n            local: `${origin}.sendData-Webhook`,\r\n            message: `Todas as tentativas falharam: ${error?.message}`,\r\n            hostName: error?.hostname,\r\n            syscall: error?.syscall,\r\n            code: error?.code,\r\n            error: error?.errno,\r\n            stack: error?.stack,\r\n            name: error?.name,\r\n            url: baseURL,\r\n            server_url: serverUrl,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    if (webhookConfig.GLOBAL?.ENABLED) {\r\n      if (webhookConfig.EVENTS[we]) {\r\n        let globalURL = webhookConfig.GLOBAL.URL;\r\n\r\n        if (webhookConfig.GLOBAL.WEBHOOK_BY_EVENTS) {\r\n          globalURL = `${globalURL}/${transformedWe}`;\r\n        }\r\n\r\n        if (enabledLog) {\r\n          const logData = {\r\n            local: `${origin}.sendData-Webhook-Global`,\r\n            url: globalURL,\r\n            ...webhookData,\r\n          };\r\n\r\n          this.logger.log(logData);\r\n        }\r\n\r\n        try {\r\n          if (isURL(globalURL)) {\r\n            const httpService = axios.create({ baseURL: globalURL });\r\n\r\n            await this.retryWebhookRequest(\r\n              httpService,\r\n              webhookData,\r\n              `${origin}.sendData-Webhook-Global`,\r\n              globalURL,\r\n              serverUrl,\r\n            );\r\n          }\r\n        } catch (error) {\r\n          this.logger.error({\r\n            local: `${origin}.sendData-Webhook-Global`,\r\n            message: `Todas as tentativas falharam: ${error?.message}`,\r\n            hostName: error?.hostname,\r\n            syscall: error?.syscall,\r\n            code: error?.code,\r\n            error: error?.errno,\r\n            stack: error?.stack,\r\n            name: error?.name,\r\n            url: globalURL,\r\n            server_url: serverUrl,\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async retryWebhookRequest(\r\n    httpService: AxiosInstance,\r\n    webhookData: any,\r\n    origin: string,\r\n    baseURL: string,\r\n    serverUrl: string,\r\n    maxRetries = 10,\r\n    delaySeconds = 30,\r\n  ): Promise<void> {\r\n    let attempts = 0;\r\n\r\n    while (attempts < maxRetries) {\r\n      try {\r\n        await httpService.post('', webhookData);\r\n        if (attempts > 0) {\r\n          this.logger.log({\r\n            local: `${origin}`,\r\n            message: `Sucesso no envio aps ${attempts + 1} tentativas`,\r\n            url: baseURL,\r\n          });\r\n        }\r\n        return;\r\n      } catch (error) {\r\n        attempts++;\r\n\r\n        this.logger.error({\r\n          local: `${origin}`,\r\n          message: `Tentativa ${attempts}/${maxRetries} falhou: ${error?.message}`,\r\n          hostName: error?.hostname,\r\n          syscall: error?.syscall,\r\n          code: error?.code,\r\n          error: error?.errno,\r\n          stack: error?.stack,\r\n          name: error?.name,\r\n          url: baseURL,\r\n          server_url: serverUrl,\r\n        });\r\n\r\n        if (attempts === maxRetries) {\r\n          throw error;\r\n        }\r\n\r\n        await new Promise((resolve) => setTimeout(resolve, delaySeconds * 1000));\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { configService, Cors, Log, Websocket } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Server } from 'http';\r\nimport { Server as SocketIO } from 'socket.io';\r\n\r\nimport { EmitData, EventController, EventControllerInterface } from '../event.controller';\r\n\r\nexport class WebsocketController extends EventController implements EventControllerInterface {\r\n  private io: SocketIO;\r\n  private corsConfig: Array<any>;\r\n  private readonly logger = new Logger('WebsocketController');\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    super(prismaRepository, waMonitor, configService.get<Websocket>('WEBSOCKET')?.ENABLED, 'websocket');\r\n\r\n    this.cors = configService.get<Cors>('CORS').ORIGIN;\r\n  }\r\n\r\n  public init(httpServer: Server): void {\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    this.socket = new SocketIO(httpServer, {\r\n      cors: {\r\n        origin: this.cors,\r\n      },\r\n    });\r\n\r\n    this.socket.on('connection', (socket) => {\r\n      this.logger.info('User connected');\r\n\r\n      socket.on('disconnect', () => {\r\n        this.logger.info('User disconnected');\r\n      });\r\n\r\n      socket.on('sendNode', async (data) => {\r\n        try {\r\n          await this.waMonitor.waInstances[data.instanceId].baileysSendNode(data.stanza);\r\n          this.logger.info('Node sent successfully');\r\n        } catch (error) {\r\n          this.logger.error('Error sending node:');\r\n          this.logger.error(error);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.logger.info('Socket.io initialized');\r\n  }\r\n\r\n  private set cors(cors: Array<any>) {\r\n    this.corsConfig = cors;\r\n  }\r\n\r\n  private get cors(): string | Array<any> {\r\n    return this.corsConfig?.includes('*') ? '*' : this.corsConfig;\r\n  }\r\n\r\n  private set socket(socket: SocketIO) {\r\n    this.io = socket;\r\n  }\r\n\r\n  public get socket(): SocketIO {\r\n    return this.io;\r\n  }\r\n\r\n  public async emit({\r\n    instanceName,\r\n    origin,\r\n    event,\r\n    data,\r\n    serverUrl,\r\n    dateTime,\r\n    sender,\r\n    apiKey,\r\n    integration,\r\n  }: EmitData): Promise<void> {\r\n    if (integration && !integration.includes('websocket')) {\r\n      return;\r\n    }\r\n\r\n    if (!this.status) {\r\n      return;\r\n    }\r\n\r\n    const configEv = event.replace(/[.-]/gm, '_').toUpperCase();\r\n    const logEnabled = configService.get<Log>('LOG').LEVEL.includes('WEBSOCKET');\r\n    const message = {\r\n      event,\r\n      instance: instanceName,\r\n      data,\r\n      server_url: serverUrl,\r\n      date_time: dateTime,\r\n      sender,\r\n      apikey: apiKey,\r\n    };\r\n\r\n    if (configService.get<Websocket>('WEBSOCKET')?.GLOBAL_EVENTS) {\r\n      this.socket.emit(event, message);\r\n\r\n      if (logEnabled) {\r\n        this.logger.log({\r\n          local: `${origin}.sendData-WebsocketGlobal`,\r\n          ...message,\r\n        });\r\n      }\r\n    }\r\n\r\n    try {\r\n      const instance = await this.get(instanceName);\r\n\r\n      if (!instance?.enabled) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(instance?.events) && instance?.events.includes(configEv)) {\r\n        this.socket.of(`/${instanceName}`).emit(event, message);\r\n\r\n        if (logEnabled) {\r\n          this.logger.log({\r\n            local: `${origin}.sendData-Websocket`,\r\n            ...message,\r\n          });\r\n        }\r\n      }\r\n    } catch (err) {\r\n      if (logEnabled) {\r\n        this.logger.log(err);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { PusherController } from '@api/integrations/event/pusher/pusher.controller';\r\nimport { RabbitmqController } from '@api/integrations/event/rabbitmq/rabbitmq.controller';\r\nimport { SqsController } from '@api/integrations/event/sqs/sqs.controller';\r\nimport { WebhookController } from '@api/integrations/event/webhook/webhook.controller';\r\nimport { WebsocketController } from '@api/integrations/event/websocket/websocket.controller';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { WAMonitoringService } from '@api/services/monitor.service';\r\nimport { Server } from 'http';\r\n\r\nexport class EventManager {\r\n  private prismaRepository: PrismaRepository;\r\n  private waMonitor: WAMonitoringService;\r\n  private websocketController: WebsocketController;\r\n  private webhookController: WebhookController;\r\n  private rabbitmqController: RabbitmqController;\r\n  private sqsController: SqsController;\r\n  private pusherController: PusherController;\r\n\r\n  constructor(prismaRepository: PrismaRepository, waMonitor: WAMonitoringService) {\r\n    this.prisma = prismaRepository;\r\n    this.monitor = waMonitor;\r\n\r\n    this.websocket = new WebsocketController(prismaRepository, waMonitor);\r\n    this.webhook = new WebhookController(prismaRepository, waMonitor);\r\n    this.rabbitmq = new RabbitmqController(prismaRepository, waMonitor);\r\n    this.sqs = new SqsController(prismaRepository, waMonitor);\r\n    this.pusher = new PusherController(prismaRepository, waMonitor);\r\n  }\r\n\r\n  public set prisma(prisma: PrismaRepository) {\r\n    this.prismaRepository = prisma;\r\n  }\r\n\r\n  public get prisma() {\r\n    return this.prismaRepository;\r\n  }\r\n\r\n  public set monitor(waMonitor: WAMonitoringService) {\r\n    this.waMonitor = waMonitor;\r\n  }\r\n\r\n  public get monitor() {\r\n    return this.waMonitor;\r\n  }\r\n\r\n  public set websocket(websocket: WebsocketController) {\r\n    this.websocketController = websocket;\r\n  }\r\n\r\n  public get websocket() {\r\n    return this.websocketController;\r\n  }\r\n\r\n  public set webhook(webhook: WebhookController) {\r\n    this.webhookController = webhook;\r\n  }\r\n\r\n  public get webhook() {\r\n    return this.webhookController;\r\n  }\r\n\r\n  public set rabbitmq(rabbitmq: RabbitmqController) {\r\n    this.rabbitmqController = rabbitmq;\r\n  }\r\n\r\n  public get rabbitmq() {\r\n    return this.rabbitmqController;\r\n  }\r\n\r\n  public set sqs(sqs: SqsController) {\r\n    this.sqsController = sqs;\r\n  }\r\n\r\n  public get sqs() {\r\n    return this.sqsController;\r\n  }\r\n\r\n  public set pusher(pusher: PusherController) {\r\n    this.pusherController = pusher;\r\n  }\r\n  public get pusher() {\r\n    return this.pusherController;\r\n  }\r\n\r\n  public init(httpServer: Server): void {\r\n    this.websocket.init(httpServer);\r\n    this.rabbitmq.init();\r\n    this.sqs.init();\r\n    this.pusher.init();\r\n  }\r\n\r\n  public async emit(eventData: {\r\n    instanceName: string;\r\n    origin: string;\r\n    event: string;\r\n    data: Object;\r\n    serverUrl: string;\r\n    dateTime: string;\r\n    sender: string;\r\n    apiKey?: string;\r\n    local?: boolean;\r\n    integration?: string[];\r\n  }): Promise<void> {\r\n    await this.websocket.emit(eventData);\r\n    await this.rabbitmq.emit(eventData);\r\n    await this.sqs.emit(eventData);\r\n    await this.webhook.emit(eventData);\r\n    await this.pusher.emit(eventData);\r\n  }\r\n\r\n  public async setInstance(instanceName: string, data: any): Promise<any> {\r\n    if (data.websocket)\r\n      await this.websocket.set(instanceName, {\r\n        websocket: {\r\n          enabled: true,\r\n          events: data.websocket?.events,\r\n        },\r\n      });\r\n\r\n    if (data.rabbitmq)\r\n      await this.rabbitmq.set(instanceName, {\r\n        rabbitmq: {\r\n          enabled: true,\r\n          events: data.rabbitmq?.events,\r\n        },\r\n      });\r\n\r\n    if (data.sqs)\r\n      await this.sqs.set(instanceName, {\r\n        sqs: {\r\n          enabled: true,\r\n          events: data.sqs?.events,\r\n        },\r\n      });\r\n\r\n    if (data.webhook)\r\n      await this.webhook.set(instanceName, {\r\n        webhook: {\r\n          enabled: true,\r\n          events: data.webhook?.events,\r\n          url: data.webhook?.url,\r\n          headers: data.webhook?.headers,\r\n          base64: data.webhook?.base64,\r\n          byEvents: data.webhook?.byEvents,\r\n        },\r\n      });\r\n\r\n    if (data.pusher)\r\n      await this.pusher.set(instanceName, {\r\n        pusher: {\r\n          enabled: true,\r\n          events: data.pusher?.events,\r\n          appId: data.pusher?.appId,\r\n          key: data.pusher?.key,\r\n          secret: data.pusher?.secret,\r\n          cluster: data.pusher?.cluster,\r\n          useTLS: data.pusher?.useTLS,\r\n        },\r\n      });\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { MediaDto } from '@api/integrations/storage/s3/dto/media.dto';\r\nimport { S3Service } from '@api/integrations/storage/s3/services/s3.service';\r\n\r\nexport class S3Controller {\r\n  constructor(private readonly s3Service: S3Service) {}\r\n\r\n  public async getMedia(instance: InstanceDto, data: MediaDto) {\r\n    return this.s3Service.getMedia(instance, data);\r\n  }\r\n\r\n  public async getMediaUrl(instance: InstanceDto, data: MediaDto) {\r\n    return this.s3Service.getMediaUrl(instance, data);\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { MediaDto } from '@api/integrations/storage/s3/dto/media.dto';\r\nimport { getObjectUrl } from '@api/integrations/storage/s3/libs/minio.server';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { Logger } from '@config/logger.config';\r\nimport { BadRequestException } from '@exceptions';\r\n\r\nexport class S3Service {\r\n  constructor(private readonly prismaRepository: PrismaRepository) {}\r\n\r\n  private readonly logger = new Logger('S3Service');\r\n\r\n  public async getMedia(instance: InstanceDto, query?: MediaDto) {\r\n    try {\r\n      const where: any = {\r\n        instanceId: instance.instanceId,\r\n        ...query,\r\n      };\r\n\r\n      const media = await this.prismaRepository.media.findMany({\r\n        where,\r\n        select: {\r\n          id: true,\r\n          fileName: true,\r\n          type: true,\r\n          mimetype: true,\r\n          createdAt: true,\r\n          Message: true,\r\n        },\r\n      });\r\n\r\n      if (!media || media.length === 0) {\r\n        throw 'Media not found';\r\n      }\r\n\r\n      return media;\r\n    } catch (error) {\r\n      throw new BadRequestException(error);\r\n    }\r\n  }\r\n\r\n  public async getMediaUrl(instance: InstanceDto, data: MediaDto) {\r\n    const media = (await this.getMedia(instance, { id: data.id }))[0];\r\n    const mediaUrl = await getObjectUrl(media.fileName, data.expiry);\r\n    return {\r\n      mediaUrl,\r\n      ...media,\r\n    };\r\n  }\r\n}\r\n","import { Auth, ConfigService, ProviderSession } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport axios from 'axios';\r\nimport { execSync } from 'child_process';\r\n\r\ntype ResponseSuccess = { status: number; data?: any };\r\ntype ResponseProvider = Promise<[ResponseSuccess?, Error?]>;\r\n\r\nexport class ProviderFiles {\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.baseUrl = `http://${this.config.HOST}:${this.config.PORT}/session/${this.config.PREFIX}`;\r\n    this.globalApiToken = this.configService.get<Auth>('AUTHENTICATION').API_KEY.KEY;\r\n  }\r\n\r\n  private readonly logger = new Logger('ProviderFiles');\r\n\r\n  private baseUrl: string;\r\n  private globalApiToken: string;\r\n\r\n  private readonly config = Object.freeze(this.configService.get<ProviderSession>('PROVIDER'));\r\n\r\n  get isEnabled() {\r\n    return !!this.config?.ENABLED;\r\n  }\r\n\r\n  public async onModuleInit() {\r\n    if (this.config.ENABLED) {\r\n      const url = `http://${this.config.HOST}:${this.config.PORT}`;\r\n      try {\r\n        const response = await axios.options(url + '/ping');\r\n        if (response?.data != 'pong') {\r\n          throw new Error('Offline file provider.');\r\n        }\r\n\r\n        await axios.post(`${url}/session`, { group: this.config.PREFIX }, { headers: { apikey: this.globalApiToken } });\r\n      } catch (error) {\r\n        this.logger.error(['Failed to connect to the file server', error?.message, error?.stack]);\r\n        const pid = process.pid;\r\n        execSync(`kill -9 ${pid}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  public async onModuleDestroy() {\r\n    //\r\n  }\r\n\r\n  public async create(instance: string): ResponseProvider {\r\n    try {\r\n      const response = await axios.post(\r\n        `${this.baseUrl}`,\r\n        {\r\n          instance,\r\n        },\r\n        { headers: { apikey: this.globalApiToken } },\r\n      );\r\n      return [{ status: response.status, data: response?.data }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n\r\n  public async write(instance: string, key: string, data: any): ResponseProvider {\r\n    try {\r\n      const response = await axios.post(`${this.baseUrl}/${instance}/${key}`, data, {\r\n        headers: { apikey: this.globalApiToken },\r\n      });\r\n      return [{ status: response.status, data: response?.data }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n\r\n  public async read(instance: string, key: string): ResponseProvider {\r\n    try {\r\n      const response = await axios.get(`${this.baseUrl}/${instance}/${key}`, {\r\n        headers: { apikey: this.globalApiToken },\r\n      });\r\n      return [{ status: response.status, data: response?.data }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n\r\n  public async delete(instance: string, key: string): ResponseProvider {\r\n    try {\r\n      const response = await axios.delete(`${this.baseUrl}/${instance}/${key}`, {\r\n        headers: { apikey: this.globalApiToken },\r\n      });\r\n      return [{ status: response.status, data: response?.data }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n\r\n  public async allInstances(): ResponseProvider {\r\n    try {\r\n      const response = await axios.get(`${this.baseUrl}/list-instances`, { headers: { apikey: this.globalApiToken } });\r\n      return [{ status: response.status, data: response?.data as string[] }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n\r\n  public async removeSession(instance: string): ResponseProvider {\r\n    try {\r\n      const response = await axios.delete(`${this.baseUrl}/${instance}`, { headers: { apikey: this.globalApiToken } });\r\n      return [{ status: response.status, data: response?.data }];\r\n    } catch (error) {\r\n      return [\r\n        {\r\n          status: error?.response?.status,\r\n          data: error?.response?.data,\r\n        },\r\n        error,\r\n      ];\r\n    }\r\n  }\r\n}\r\n","import { ConfigService } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nexport class Query<T> {\r\n  where?: T;\r\n  sort?: 'asc' | 'desc';\r\n  page?: number;\r\n  offset?: number;\r\n}\r\n\r\nexport class PrismaRepository extends PrismaClient {\r\n  constructor(private readonly configService: ConfigService) {\r\n    super();\r\n  }\r\n\r\n  private readonly logger = new Logger('PrismaRepository');\r\n\r\n  public async onModuleInit() {\r\n    await this.$connect();\r\n    this.logger.info('Repository:Prisma - ON');\r\n  }\r\n\r\n  public async onModuleDestroy() {\r\n    await this.$disconnect();\r\n    this.logger.warn('Repository:Prisma - OFF');\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProviderFiles } from '@api/provider/sessions';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { channelController } from '@api/server.module';\r\nimport { Events, Integration } from '@api/types/wa.types';\r\nimport { CacheConf, Chatwoot, ConfigService, Database, DelInstance, ProviderSession } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { INSTANCE_DIR, STORE_DIR } from '@config/path.config';\r\nimport { NotFoundException } from '@exceptions';\r\nimport { execSync } from 'child_process';\r\nimport EventEmitter2 from 'eventemitter2';\r\nimport { rmSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\nimport { CacheService } from './cache.service';\r\n\r\nexport class WAMonitoringService {\r\n  constructor(\r\n    private readonly eventEmitter: EventEmitter2,\r\n    private readonly configService: ConfigService,\r\n    private readonly prismaRepository: PrismaRepository,\r\n    private readonly providerFiles: ProviderFiles,\r\n    private readonly cache: CacheService,\r\n    private readonly chatwootCache: CacheService,\r\n    private readonly baileysCache: CacheService,\r\n  ) {\r\n    this.removeInstance();\r\n    this.noConnection();\r\n\r\n    Object.assign(this.db, configService.get<Database>('DATABASE'));\r\n    Object.assign(this.redis, configService.get<CacheConf>('CACHE'));\r\n  }\r\n\r\n  private readonly db: Partial<Database> = {};\r\n  private readonly redis: Partial<CacheConf> = {};\r\n\r\n  private readonly logger = new Logger('WAMonitoringService');\r\n  public readonly waInstances: Record<string, any> = {};\r\n\r\n  private readonly providerSession = Object.freeze(this.configService.get<ProviderSession>('PROVIDER'));\r\n\r\n  public delInstanceTime(instance: string) {\r\n    const time = this.configService.get<DelInstance>('DEL_INSTANCE');\r\n    if (typeof time === 'number' && time > 0) {\r\n      setTimeout(\r\n        async () => {\r\n          if (this.waInstances[instance]?.connectionStatus?.state !== 'open') {\r\n            if (this.waInstances[instance]?.connectionStatus?.state === 'connecting') {\r\n              if ((await this.waInstances[instance].integration) === Integration.WHATSAPP_BAILEYS) {\r\n                await this.waInstances[instance]?.client?.logout('Log out instance: ' + instance);\r\n                this.waInstances[instance]?.client?.ws?.close();\r\n                this.waInstances[instance]?.client?.end(undefined);\r\n              }\r\n              this.eventEmitter.emit('remove.instance', instance, 'inner');\r\n            } else {\r\n              this.eventEmitter.emit('remove.instance', instance, 'inner');\r\n            }\r\n          }\r\n        },\r\n        1000 * 60 * time,\r\n      );\r\n    }\r\n  }\r\n\r\n  public async instanceInfo(instanceNames?: string[]): Promise<any> {\r\n    if (instanceNames && instanceNames.length > 0) {\r\n      const inexistentInstances = instanceNames ? instanceNames.filter((instance) => !this.waInstances[instance]) : [];\r\n\r\n      if (inexistentInstances.length > 0) {\r\n        throw new NotFoundException(\r\n          `Instance${inexistentInstances.length > 1 ? 's' : ''} \"${inexistentInstances.join(', ')}\" not found`,\r\n        );\r\n      }\r\n    }\r\n\r\n    const clientName = this.configService.get<Database>('DATABASE').CONNECTION.CLIENT_NAME;\r\n\r\n    const where =\r\n      instanceNames && instanceNames.length > 0\r\n        ? {\r\n            name: {\r\n              in: instanceNames,\r\n            },\r\n            clientName,\r\n          }\r\n        : { clientName };\r\n\r\n    const instances = await this.prismaRepository.instance.findMany({\r\n      where,\r\n      include: {\r\n        Chatwoot: true,\r\n        Proxy: true,\r\n        Rabbitmq: true,\r\n        Sqs: true,\r\n        Websocket: true,\r\n        Setting: true,\r\n        _count: {\r\n          select: {\r\n            Message: true,\r\n            Contact: true,\r\n            Chat: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    return instances;\r\n  }\r\n\r\n  public async instanceInfoById(instanceId?: string, number?: string) {\r\n    let instanceName: string;\r\n    if (instanceId) {\r\n      instanceName = await this.prismaRepository.instance.findFirst({ where: { id: instanceId } }).then((r) => r?.name);\r\n      if (!instanceName) {\r\n        throw new NotFoundException(`Instance \"${instanceId}\" not found`);\r\n      }\r\n    } else if (number) {\r\n      instanceName = await this.prismaRepository.instance.findFirst({ where: { number } }).then((r) => r?.name);\r\n      if (!instanceName) {\r\n        throw new NotFoundException(`Instance \"${number}\" not found`);\r\n      }\r\n    }\r\n\r\n    if (!instanceName) {\r\n      throw new NotFoundException(`Instance \"${instanceId}\" not found`);\r\n    }\r\n\r\n    if (instanceName && !this.waInstances[instanceName]) {\r\n      throw new NotFoundException(`Instance \"${instanceName}\" not found`);\r\n    }\r\n\r\n    const instanceNames = instanceName ? [instanceName] : null;\r\n\r\n    return this.instanceInfo(instanceNames);\r\n  }\r\n\r\n  public async cleaningUp(instanceName: string) {\r\n    let instanceDbId: string;\r\n    if (this.db.SAVE_DATA.INSTANCE) {\r\n      const findInstance = await this.prismaRepository.instance.findFirst({\r\n        where: { name: instanceName },\r\n      });\r\n\r\n      if (findInstance) {\r\n        const instance = await this.prismaRepository.instance.update({\r\n          where: { name: instanceName },\r\n          data: { connectionStatus: 'close' },\r\n        });\r\n\r\n        rmSync(join(INSTANCE_DIR, instance.id), { recursive: true, force: true });\r\n\r\n        instanceDbId = instance.id;\r\n        await this.prismaRepository.session.deleteMany({ where: { sessionId: instance.id } });\r\n      }\r\n    }\r\n\r\n    if (this.redis.REDIS.ENABLED && this.redis.REDIS.SAVE_INSTANCES) {\r\n      await this.cache.delete(instanceName);\r\n      if (instanceDbId) {\r\n        await this.cache.delete(instanceDbId);\r\n      }\r\n    }\r\n\r\n    if (this.providerSession?.ENABLED) {\r\n      await this.providerFiles.removeSession(instanceName);\r\n    }\r\n  }\r\n\r\n  public async cleaningStoreData(instanceName: string) {\r\n    if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n      execSync(`rm -rf ${join(STORE_DIR, 'chatwoot', instanceName + '*')}`);\r\n    }\r\n\r\n    const instance = await this.prismaRepository.instance.findFirst({\r\n      where: { name: instanceName },\r\n    });\r\n\r\n    if (!instance) return;\r\n\r\n    rmSync(join(INSTANCE_DIR, instance.id), { recursive: true, force: true });\r\n\r\n    await this.prismaRepository.session.deleteMany({ where: { sessionId: instance.id } });\r\n\r\n    await this.prismaRepository.chat.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.contact.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.messageUpdate.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.message.deleteMany({ where: { instanceId: instance.id } });\r\n\r\n    await this.prismaRepository.webhook.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.chatwoot.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.proxy.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.rabbitmq.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.sqs.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.integrationSession.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.typebot.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.websocket.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.setting.deleteMany({ where: { instanceId: instance.id } });\r\n    await this.prismaRepository.label.deleteMany({ where: { instanceId: instance.id } });\r\n\r\n    await this.prismaRepository.instance.delete({ where: { name: instanceName } });\r\n  }\r\n\r\n  public async loadInstance() {\r\n    try {\r\n      if (this.providerSession?.ENABLED) {\r\n        await this.loadInstancesFromProvider();\r\n      } else if (this.db.SAVE_DATA.INSTANCE) {\r\n        await this.loadInstancesFromDatabasePostgres();\r\n      } else if (this.redis.REDIS.ENABLED && this.redis.REDIS.SAVE_INSTANCES) {\r\n        await this.loadInstancesFromRedis();\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public async saveInstance(data: any) {\r\n    try {\r\n      const clientName = await this.configService.get<Database>('DATABASE').CONNECTION.CLIENT_NAME;\r\n      await this.prismaRepository.instance.create({\r\n        data: {\r\n          id: data.instanceId,\r\n          name: data.instanceName,\r\n          ownerJid: data.ownerJid,\r\n          profileName: data.profileName,\r\n          profilePicUrl: data.profilePicUrl,\r\n          connectionStatus:\r\n            data.integration && data.integration === Integration.WHATSAPP_BAILEYS ? 'close' : (data.status ?? 'open'),\r\n          number: data.number,\r\n          integration: data.integration || Integration.WHATSAPP_BAILEYS,\r\n          token: data.hash,\r\n          clientName: clientName,\r\n          businessId: data.businessId,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  public deleteInstance(instanceName: string) {\r\n    try {\r\n      this.eventEmitter.emit('remove.instance', instanceName, 'inner');\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n    }\r\n  }\r\n\r\n  private async setInstance(instanceData: InstanceDto) {\r\n    const instance = channelController.init(instanceData, {\r\n      configService: this.configService,\r\n      eventEmitter: this.eventEmitter,\r\n      prismaRepository: this.prismaRepository,\r\n      cache: this.cache,\r\n      chatwootCache: this.chatwootCache,\r\n      baileysCache: this.baileysCache,\r\n      providerFiles: this.providerFiles,\r\n    });\r\n\r\n    if (!instance) return;\r\n\r\n    instance.setInstance({\r\n      instanceId: instanceData.instanceId,\r\n      instanceName: instanceData.instanceName,\r\n      integration: instanceData.integration,\r\n      token: instanceData.token,\r\n      number: instanceData.number,\r\n      businessId: instanceData.businessId,\r\n    });\r\n\r\n    await instance.connectToWhatsapp();\r\n\r\n    this.waInstances[instanceData.instanceName] = instance;\r\n  }\r\n\r\n  private async loadInstancesFromRedis() {\r\n    const keys = await this.cache.keys();\r\n\r\n    if (keys?.length > 0) {\r\n      await Promise.all(\r\n        keys.map(async (k) => {\r\n          const instanceData = await this.prismaRepository.instance.findUnique({\r\n            where: { id: k.split(':')[1] },\r\n          });\r\n\r\n          if (!instanceData) {\r\n            return;\r\n          }\r\n\r\n          const instance = {\r\n            instanceId: k.split(':')[1],\r\n            instanceName: k.split(':')[2],\r\n            integration: instanceData.integration,\r\n            token: instanceData.token,\r\n            number: instanceData.number,\r\n            businessId: instanceData.businessId,\r\n          };\r\n\r\n          this.setInstance(instance);\r\n        }),\r\n      );\r\n    }\r\n  }\r\n\r\n  private async loadInstancesFromDatabasePostgres() {\r\n    const clientName = await this.configService.get<Database>('DATABASE').CONNECTION.CLIENT_NAME;\r\n\r\n    const instances = await this.prismaRepository.instance.findMany({\r\n      where: { clientName: clientName },\r\n    });\r\n\r\n    if (instances.length === 0) {\r\n      return;\r\n    }\r\n\r\n    await Promise.all(\r\n      instances.map(async (instance) => {\r\n        this.setInstance({\r\n          instanceId: instance.id,\r\n          instanceName: instance.name,\r\n          integration: instance.integration,\r\n          token: instance.token,\r\n          number: instance.number,\r\n          businessId: instance.businessId,\r\n        });\r\n      }),\r\n    );\r\n  }\r\n\r\n  private async loadInstancesFromProvider() {\r\n    const [instances] = await this.providerFiles.allInstances();\r\n\r\n    if (!instances?.data) {\r\n      return;\r\n    }\r\n\r\n    await Promise.all(\r\n      instances?.data?.map(async (instanceId: string) => {\r\n        const instance = await this.prismaRepository.instance.findUnique({\r\n          where: { id: instanceId },\r\n        });\r\n\r\n        this.setInstance({\r\n          instanceId: instance.id,\r\n          instanceName: instance.name,\r\n          integration: instance.integration,\r\n          token: instance.token,\r\n          businessId: instance.businessId,\r\n        });\r\n      }),\r\n    );\r\n  }\r\n\r\n  private removeInstance() {\r\n    this.eventEmitter.on('remove.instance', async (instanceName: string) => {\r\n      try {\r\n        await this.waInstances[instanceName]?.sendDataWebhook(Events.REMOVE_INSTANCE, null);\r\n\r\n        this.cleaningUp(instanceName);\r\n        this.cleaningStoreData(instanceName);\r\n      } finally {\r\n        this.logger.warn(`Instance \"${instanceName}\" - REMOVED`);\r\n      }\r\n\r\n      try {\r\n        delete this.waInstances[instanceName];\r\n      } catch (error) {\r\n        this.logger.error(error);\r\n      }\r\n    });\r\n    this.eventEmitter.on('logout.instance', async (instanceName: string) => {\r\n      try {\r\n        await this.waInstances[instanceName]?.sendDataWebhook(Events.LOGOUT_INSTANCE, null);\r\n\r\n        if (this.configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n          this.waInstances[instanceName]?.clearCacheChatwoot();\r\n        }\r\n\r\n        this.cleaningUp(instanceName);\r\n      } finally {\r\n        this.logger.warn(`Instance \"${instanceName}\" - LOGOUT`);\r\n      }\r\n    });\r\n  }\r\n\r\n  private noConnection() {\r\n    this.eventEmitter.on('no.connection', async (instanceName) => {\r\n      try {\r\n        await this.waInstances[instanceName]?.client?.logout('Log out instance: ' + instanceName);\r\n\r\n        this.waInstances[instanceName]?.client?.ws?.close();\r\n\r\n        this.waInstances[instanceName].instance.qrcode = { count: 0 };\r\n        this.waInstances[instanceName].stateConnection.state = 'close';\r\n      } catch (error) {\r\n        this.logger.error({\r\n          localError: 'noConnection',\r\n          warn: 'Error deleting instance from memory.',\r\n          error,\r\n        });\r\n      } finally {\r\n        this.logger.warn(`Instance \"${instanceName}\" - NOT CONNECTION`);\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProxyDto } from '@api/dto/proxy.dto';\r\nimport { Logger } from '@config/logger.config';\r\nimport { Proxy } from '@prisma/client';\r\n\r\nimport { WAMonitoringService } from './monitor.service';\r\n\r\nexport class ProxyService {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  private readonly logger = new Logger('ProxyService');\r\n\r\n  public create(instance: InstanceDto, data: ProxyDto) {\r\n    this.waMonitor.waInstances[instance.instanceName].setProxy(data);\r\n\r\n    return { proxy: { ...instance, proxy: data } };\r\n  }\r\n\r\n  public async find(instance: InstanceDto): Promise<Proxy> {\r\n    try {\r\n      const result = await this.waMonitor.waInstances[instance.instanceName].findProxy();\r\n\r\n      if (Object.keys(result).length === 0) {\r\n        throw new Error('Proxy not found');\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { SettingsDto } from '@api/dto/settings.dto';\r\nimport { Logger } from '@config/logger.config';\r\n\r\nimport { WAMonitoringService } from './monitor.service';\r\n\r\nexport class SettingsService {\r\n  constructor(private readonly waMonitor: WAMonitoringService) {}\r\n\r\n  private readonly logger = new Logger('SettingsService');\r\n\r\n  public async create(instance: InstanceDto, data: SettingsDto) {\r\n    await this.waMonitor.waInstances[instance.instanceName].setSettings(data);\r\n\r\n    return { settings: { ...instance, settings: data } };\r\n  }\r\n\r\n  public async find(instance: InstanceDto): Promise<SettingsDto> {\r\n    try {\r\n      const result = await this.waMonitor.waInstances[instance.instanceName].findSettings();\r\n\r\n      if (Object.keys(result).length === 0) {\r\n        throw new Error('Settings not found');\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { TemplateDto } from '@api/dto/template.dto';\r\nimport { PrismaRepository } from '@api/repository/repository.service';\r\nimport { ConfigService, WaBusiness } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport axios from 'axios';\r\n\r\nimport { WAMonitoringService } from './monitor.service';\r\n\r\nexport class TemplateService {\r\n  constructor(\r\n    private readonly waMonitor: WAMonitoringService,\r\n    public readonly prismaRepository: PrismaRepository,\r\n    private readonly configService: ConfigService,\r\n  ) {}\r\n\r\n  private readonly logger = new Logger('TemplateService');\r\n\r\n  private businessId: string;\r\n  private token: string;\r\n\r\n  public async find(instance: InstanceDto) {\r\n    const getInstance = await this.waMonitor.waInstances[instance.instanceName].instance;\r\n\r\n    if (!getInstance) {\r\n      throw new Error('Instance not found');\r\n    }\r\n\r\n    this.businessId = getInstance.businessId;\r\n    this.token = getInstance.token;\r\n\r\n    const response = await this.requestTemplate({}, 'GET');\r\n\r\n    if (!response) {\r\n      throw new Error('Error to create template');\r\n    }\r\n\r\n    return response.data;\r\n  }\r\n\r\n  public async create(instance: InstanceDto, data: TemplateDto) {\r\n    try {\r\n      const getInstance = await this.waMonitor.waInstances[instance.instanceName].instance;\r\n\r\n      if (!getInstance) {\r\n        throw new Error('Instance not found');\r\n      }\r\n\r\n      this.businessId = getInstance.businessId;\r\n      this.token = getInstance.token;\r\n\r\n      const postData = {\r\n        name: data.name,\r\n        category: data.category,\r\n        allow_category_change: data.allowCategoryChange,\r\n        language: data.language,\r\n        components: data.components,\r\n      };\r\n\r\n      const response = await this.requestTemplate(postData, 'POST');\r\n\r\n      if (!response || response.error) {\r\n        throw new Error('Error to create template');\r\n      }\r\n\r\n      const template = await this.prismaRepository.template.create({\r\n        data: {\r\n          templateId: response.id,\r\n          name: data.name,\r\n          template: response,\r\n          webhookUrl: data.webhookUrl,\r\n          instanceId: getInstance.id,\r\n        },\r\n      });\r\n\r\n      return template;\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new Error('Error to create template');\r\n    }\r\n  }\r\n\r\n  private async requestTemplate(data: any, method: string) {\r\n    try {\r\n      let urlServer = this.configService.get<WaBusiness>('WA_BUSINESS').URL;\r\n      const version = this.configService.get<WaBusiness>('WA_BUSINESS').VERSION;\r\n      urlServer = `${urlServer}/${version}/${this.businessId}/message_templates`;\r\n      const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${this.token}` };\r\n      if (method === 'GET') {\r\n        const result = await axios.get(urlServer, { headers });\r\n        return result.data;\r\n      } else if (method === 'POST') {\r\n        const result = await axios.post(urlServer, data, { headers });\r\n        return result.data;\r\n      }\r\n    } catch (e) {\r\n      this.logger.error(e.response.data);\r\n      return e.response.data.error;\r\n    }\r\n  }\r\n}\r\n","import { CacheEngine } from '@cache/cacheengine';\r\nimport { Chatwoot, configService, ProviderSession } from '@config/env.config';\r\nimport { eventEmitter } from '@config/event.config';\r\nimport { Logger } from '@config/logger.config';\r\n\r\nimport { CallController } from './controllers/call.controller';\r\nimport { ChatController } from './controllers/chat.controller';\r\nimport { GroupController } from './controllers/group.controller';\r\nimport { InstanceController } from './controllers/instance.controller';\r\nimport { LabelController } from './controllers/label.controller';\r\nimport { ProxyController } from './controllers/proxy.controller';\r\nimport { SendMessageController } from './controllers/sendMessage.controller';\r\nimport { SettingsController } from './controllers/settings.controller';\r\nimport { TemplateController } from './controllers/template.controller';\r\nimport { ChannelController } from './integrations/channel/channel.controller';\r\nimport { EvolutionController } from './integrations/channel/evolution/evolution.controller';\r\nimport { MetaController } from './integrations/channel/meta/meta.controller';\r\nimport { BaileysController } from './integrations/channel/whatsapp/baileys.controller';\r\nimport { ChatbotController } from './integrations/chatbot/chatbot.controller';\r\nimport { ChatwootController } from './integrations/chatbot/chatwoot/controllers/chatwoot.controller';\r\nimport { ChatwootService } from './integrations/chatbot/chatwoot/services/chatwoot.service';\r\nimport { DifyController } from './integrations/chatbot/dify/controllers/dify.controller';\r\nimport { DifyService } from './integrations/chatbot/dify/services/dify.service';\r\nimport { EvolutionBotController } from './integrations/chatbot/evolutionBot/controllers/evolutionBot.controller';\r\nimport { EvolutionBotService } from './integrations/chatbot/evolutionBot/services/evolutionBot.service';\r\nimport { FlowiseController } from './integrations/chatbot/flowise/controllers/flowise.controller';\r\nimport { FlowiseService } from './integrations/chatbot/flowise/services/flowise.service';\r\nimport { OpenaiController } from './integrations/chatbot/openai/controllers/openai.controller';\r\nimport { OpenaiService } from './integrations/chatbot/openai/services/openai.service';\r\nimport { TypebotController } from './integrations/chatbot/typebot/controllers/typebot.controller';\r\nimport { TypebotService } from './integrations/chatbot/typebot/services/typebot.service';\r\nimport { EventManager } from './integrations/event/event.manager';\r\nimport { S3Controller } from './integrations/storage/s3/controllers/s3.controller';\r\nimport { S3Service } from './integrations/storage/s3/services/s3.service';\r\nimport { ProviderFiles } from './provider/sessions';\r\nimport { PrismaRepository } from './repository/repository.service';\r\nimport { CacheService } from './services/cache.service';\r\nimport { WAMonitoringService } from './services/monitor.service';\r\nimport { ProxyService } from './services/proxy.service';\r\nimport { SettingsService } from './services/settings.service';\r\nimport { TemplateService } from './services/template.service';\r\n\r\nconst logger = new Logger('WA MODULE');\r\n\r\nlet chatwootCache: CacheService = null;\r\nif (configService.get<Chatwoot>('CHATWOOT').ENABLED) {\r\n  chatwootCache = new CacheService(new CacheEngine(configService, ChatwootService.name).getEngine());\r\n}\r\n\r\nexport const cache = new CacheService(new CacheEngine(configService, 'instance').getEngine());\r\nconst baileysCache = new CacheService(new CacheEngine(configService, 'baileys').getEngine());\r\n\r\nlet providerFiles: ProviderFiles = null;\r\nif (configService.get<ProviderSession>('PROVIDER').ENABLED) {\r\n  providerFiles = new ProviderFiles(configService);\r\n}\r\n\r\nexport const prismaRepository = new PrismaRepository(configService);\r\n\r\nexport const waMonitor = new WAMonitoringService(\r\n  eventEmitter,\r\n  configService,\r\n  prismaRepository,\r\n  providerFiles,\r\n  cache,\r\n  chatwootCache,\r\n  baileysCache,\r\n);\r\n\r\nconst s3Service = new S3Service(prismaRepository);\r\nexport const s3Controller = new S3Controller(s3Service);\r\n\r\nconst templateService = new TemplateService(waMonitor, prismaRepository, configService);\r\nexport const templateController = new TemplateController(templateService);\r\n\r\nconst proxyService = new ProxyService(waMonitor);\r\nexport const proxyController = new ProxyController(proxyService, waMonitor);\r\n\r\nconst chatwootService = new ChatwootService(waMonitor, configService, prismaRepository, chatwootCache);\r\nexport const chatwootController = new ChatwootController(chatwootService, configService, prismaRepository);\r\n\r\nconst settingsService = new SettingsService(waMonitor);\r\nexport const settingsController = new SettingsController(settingsService);\r\n\r\nexport const instanceController = new InstanceController(\r\n  waMonitor,\r\n  configService,\r\n  prismaRepository,\r\n  eventEmitter,\r\n  chatwootService,\r\n  settingsService,\r\n  proxyController,\r\n  cache,\r\n  chatwootCache,\r\n  baileysCache,\r\n  providerFiles,\r\n);\r\nexport const sendMessageController = new SendMessageController(waMonitor);\r\nexport const callController = new CallController(waMonitor);\r\nexport const chatController = new ChatController(waMonitor);\r\nexport const groupController = new GroupController(waMonitor);\r\nexport const labelController = new LabelController(waMonitor);\r\n\r\nexport const eventManager = new EventManager(prismaRepository, waMonitor);\r\nexport const chatbotController = new ChatbotController(prismaRepository, waMonitor);\r\nexport const channelController = new ChannelController(prismaRepository, waMonitor);\r\n\r\n// channels\r\nexport const evolutionController = new EvolutionController(prismaRepository, waMonitor);\r\nexport const metaController = new MetaController(prismaRepository, waMonitor);\r\nexport const baileysController = new BaileysController(waMonitor);\r\n// chatbots\r\nconst typebotService = new TypebotService(waMonitor, configService, prismaRepository);\r\nexport const typebotController = new TypebotController(typebotService, prismaRepository, waMonitor);\r\n\r\nconst openaiService = new OpenaiService(waMonitor, configService, prismaRepository);\r\nexport const openaiController = new OpenaiController(openaiService, prismaRepository, waMonitor);\r\n\r\nconst difyService = new DifyService(waMonitor, configService, prismaRepository);\r\nexport const difyController = new DifyController(difyService, prismaRepository, waMonitor);\r\n\r\nconst evolutionBotService = new EvolutionBotService(waMonitor, configService, prismaRepository);\r\nexport const evolutionBotController = new EvolutionBotController(evolutionBotService, prismaRepository, waMonitor);\r\n\r\nconst flowiseService = new FlowiseService(waMonitor, configService, prismaRepository);\r\nexport const flowiseController = new FlowiseController(flowiseService, prismaRepository, waMonitor);\r\n\r\nlogger.info('Module - ON');\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { prismaRepository } from '@api/server.module';\r\nimport { Auth, configService, Database } from '@config/env.config';\r\nimport { Logger } from '@config/logger.config';\r\nimport { ForbiddenException, UnauthorizedException } from '@exceptions';\r\nimport { NextFunction, Request, Response } from 'express';\r\n\r\nconst logger = new Logger('GUARD');\r\n\r\nasync function apikey(req: Request, _: Response, next: NextFunction) {\r\n  const env = configService.get<Auth>('AUTHENTICATION').API_KEY;\r\n  const key = req.get('apikey');\r\n  const db = configService.get<Database>('DATABASE');\r\n\r\n  if (!key) {\r\n    throw new UnauthorizedException();\r\n  }\r\n\r\n  if (env.KEY === key) {\r\n    return next();\r\n  }\r\n\r\n  if ((req.originalUrl.includes('/instance/create') || req.originalUrl.includes('/instance/fetchInstances')) && !key) {\r\n    throw new ForbiddenException('Missing global api key', 'The global api key must be set');\r\n  }\r\n  const param = req.params as unknown as InstanceDto;\r\n\r\n  try {\r\n    if (param?.instanceName) {\r\n      const instance = await prismaRepository.instance.findUnique({\r\n        where: { name: param.instanceName },\r\n      });\r\n      if (instance.token === key) {\r\n        return next();\r\n      }\r\n    } else {\r\n      if (req.originalUrl.includes('/instance/fetchInstances') && db.SAVE_DATA.INSTANCE) {\r\n        const instanceByKey = await prismaRepository.instance.findFirst({\r\n          where: { token: key },\r\n        });\r\n        if (instanceByKey) {\r\n          return next();\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    logger.error(error);\r\n  }\r\n\r\n  throw new UnauthorizedException();\r\n}\r\n\r\nexport const authGuard = { apikey };\r\n","import { InstanceDto } from '@api/dto/instance.dto';\r\nimport { cache, prismaRepository, waMonitor } from '@api/server.module';\r\nimport { CacheConf, configService } from '@config/env.config';\r\nimport { BadRequestException, ForbiddenException, InternalServerErrorException, NotFoundException } from '@exceptions';\r\nimport { NextFunction, Request, Response } from 'express';\r\n\r\nasync function getInstance(instanceName: string) {\r\n  try {\r\n    const cacheConf = configService.get<CacheConf>('CACHE');\r\n\r\n    const exists = !!waMonitor.waInstances[instanceName];\r\n\r\n    if (cacheConf.REDIS.ENABLED && cacheConf.REDIS.SAVE_INSTANCES) {\r\n      const keyExists = await cache.has(instanceName);\r\n\r\n      return exists || keyExists;\r\n    }\r\n\r\n    return exists || (await prismaRepository.instance.findMany({ where: { name: instanceName } })).length > 0;\r\n  } catch (error) {\r\n    throw new InternalServerErrorException(error?.toString());\r\n  }\r\n}\r\n\r\nexport async function instanceExistsGuard(req: Request, _: Response, next: NextFunction) {\r\n  if (req.originalUrl.includes('/instance/create') || req.originalUrl.includes('/instance/fetchInstances')) {\r\n    return next();\r\n  }\r\n\r\n  const param = req.params as unknown as InstanceDto;\r\n  if (!param?.instanceName) {\r\n    throw new BadRequestException('\"instanceName\" not provided.');\r\n  }\r\n\r\n  if (!(await getInstance(param.instanceName))) {\r\n    throw new NotFoundException(`The \"${param.instanceName}\" instance does not exist`);\r\n  }\r\n\r\n  next();\r\n}\r\n\r\nexport async function instanceLoggedGuard(req: Request, _: Response, next: NextFunction) {\r\n  if (req.originalUrl.includes('/instance/create')) {\r\n    const instance = req.body as InstanceDto;\r\n    if (await getInstance(instance.instanceName)) {\r\n      throw new ForbiddenException(`This name \"${instance.instanceName}\" is already in use.`);\r\n    }\r\n\r\n    if (waMonitor.waInstances[instance.instanceName]) {\r\n      delete waMonitor.waInstances[instance.instanceName];\r\n    }\r\n  }\r\n\r\n  next();\r\n}\r\n","import { sendTelemetry } from '@utils/sendTelemetry';\r\nimport { NextFunction, Request, Response } from 'express';\r\n\r\nclass Telemetry {\r\n  public collectTelemetry(req: Request, res: Response, next: NextFunction): void {\r\n    sendTelemetry(req.path);\r\n\r\n    next();\r\n  }\r\n}\r\n\r\nexport default Telemetry;\r\n","import { Router } from 'express';\r\n\r\nimport { EvolutionRouter } from './evolution/evolution.router';\r\nimport { MetaRouter } from './meta/meta.router';\r\nimport { BaileysRouter } from './whatsapp/baileys.router';\r\n\r\nexport class ChannelRouter {\r\n  public readonly router: Router;\r\n\r\n  constructor(configService: any, ...guards: any[]) {\r\n    this.router = Router();\r\n\r\n    this.router.use('/', new EvolutionRouter(configService).router);\r\n    this.router.use('/', new MetaRouter(configService).router);\r\n    this.router.use('/baileys', new BaileysRouter(...guards).router);\r\n  }\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { evolutionController } from '@api/server.module';\r\nimport { ConfigService } from '@config/env.config';\r\nimport { Router } from 'express';\r\n\r\nexport class EvolutionRouter extends RouterBroker {\r\n  constructor(readonly configService: ConfigService) {\r\n    super();\r\n    this.router.post(this.routerPath('webhook/evolution', false), async (req, res) => {\r\n      const { body } = req;\r\n      const response = await evolutionController.receiveWebhook(body);\r\n\r\n      return res.status(200).json(response);\r\n    });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { metaController } from '@api/server.module';\r\nimport { ConfigService, WaBusiness } from '@config/env.config';\r\nimport { Router } from 'express';\r\n\r\nexport class MetaRouter extends RouterBroker {\r\n  constructor(readonly configService: ConfigService) {\r\n    super();\r\n    this.router\r\n      .get(this.routerPath('webhook/meta', false), async (req, res) => {\r\n        if (req.query['hub.verify_token'] === configService.get<WaBusiness>('WA_BUSINESS').TOKEN_WEBHOOK)\r\n          res.send(req.query['hub.challenge']);\r\n        else res.send('Error, wrong validation token');\r\n      })\r\n      .post(this.routerPath('webhook/meta', false), async (req, res) => {\r\n        const { body } = req;\r\n        const response = await metaController.receiveWebhook(body);\r\n\r\n        return res.status(200).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { Constructor } from '@api/integrations/integration.dto';\r\n\r\nexport class ChatwootDto {\r\n  enabled?: boolean;\r\n  accountId?: string;\r\n  token?: string;\r\n  url?: string;\r\n  nameInbox?: string;\r\n  signMsg?: boolean;\r\n  signDelimiter?: string;\r\n  number?: string;\r\n  reopenConversation?: boolean;\r\n  conversationPending?: boolean;\r\n  mergeBrazilContacts?: boolean;\r\n  importContacts?: boolean;\r\n  importMessages?: boolean;\r\n  daysLimitImportMessages?: number;\r\n  autoCreate?: boolean;\r\n  organization?: string;\r\n  logo?: string;\r\n  ignoreJids?: string[];\r\n}\r\n\r\nexport function ChatwootInstanceMixin<TBase extends Constructor>(Base: TBase) {\r\n  return class extends Base {\r\n    chatwootAccountId?: string;\r\n    chatwootToken?: string;\r\n    chatwootUrl?: string;\r\n    chatwootSignMsg?: boolean;\r\n    chatwootReopenConversation?: boolean;\r\n    chatwootConversationPending?: boolean;\r\n    chatwootMergeBrazilContacts?: boolean;\r\n    chatwootImportContacts?: boolean;\r\n    chatwootImportMessages?: boolean;\r\n    chatwootDaysLimitImportMessages?: number;\r\n    chatwootNameInbox?: string;\r\n    chatwootOrganization?: string;\r\n    chatwootLogo?: string;\r\n    chatwootAutoCreate?: boolean;\r\n  };\r\n}\r\n","import { Constructor } from '@api/integrations/integration.dto';\r\nimport { JsonValue } from '@prisma/client/runtime/library';\r\n\r\nexport class EventDto {\r\n  webhook?: {\r\n    enabled?: boolean;\r\n    events?: string[];\r\n    url?: string;\r\n    headers?: JsonValue;\r\n    byEvents?: boolean;\r\n    base64?: boolean;\r\n  };\r\n\r\n  websocket?: {\r\n    enabled?: boolean;\r\n    events?: string[];\r\n  };\r\n\r\n  sqs?: {\r\n    enabled?: boolean;\r\n    events?: string[];\r\n  };\r\n\r\n  rabbitmq?: {\r\n    enabled?: boolean;\r\n    events?: string[];\r\n  };\r\n\r\n  pusher?: {\r\n    enabled?: boolean;\r\n    appId?: string;\r\n    key?: string;\r\n    secret?: string;\r\n    cluster?: string;\r\n    useTLS?: boolean;\r\n    events?: string[];\r\n  };\r\n}\r\n\r\nexport function EventInstanceMixin<TBase extends Constructor>(Base: TBase) {\r\n  return class extends Base {\r\n    webhook?: {\r\n      enabled?: boolean;\r\n      events?: string[];\r\n      headers?: JsonValue;\r\n      url?: string;\r\n      byEvents?: boolean;\r\n      base64?: boolean;\r\n    };\r\n\r\n    websocket?: {\r\n      enabled?: boolean;\r\n      events?: string[];\r\n    };\r\n\r\n    sqs?: {\r\n      enabled?: boolean;\r\n      events?: string[];\r\n    };\r\n\r\n    rabbitmq?: {\r\n      enabled?: boolean;\r\n      events?: string[];\r\n    };\r\n\r\n    pusher?: {\r\n      enabled?: boolean;\r\n      appId?: string;\r\n      key?: string;\r\n      secret?: string;\r\n      cluster?: string;\r\n      useTLS?: boolean;\r\n      events?: string[];\r\n    };\r\n  };\r\n}\r\n","import { ChatwootInstanceMixin } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { EventInstanceMixin } from '@api/integrations/event/event.dto';\r\n\r\nexport type Constructor<T = {}> = new (...args: any[]) => T;\r\n\r\nexport class IntegrationDto extends EventInstanceMixin(ChatwootInstanceMixin(class {})) {}\r\n","import { IntegrationDto } from '@api/integrations/integration.dto';\r\nimport { JsonValue } from '@prisma/client/runtime/library';\r\nimport { WAPresence } from 'baileys';\r\n\r\nexport class InstanceDto extends IntegrationDto {\r\n  instanceName: string;\r\n  instanceId?: string;\r\n  qrcode?: boolean;\r\n  businessId?: string;\r\n  number?: string;\r\n  integration?: string;\r\n  token?: string;\r\n  status?: string;\r\n  ownerJid?: string;\r\n  profileName?: string;\r\n  profilePicUrl?: string;\r\n  // settings\r\n  rejectCall?: boolean;\r\n  msgCall?: string;\r\n  groupsIgnore?: boolean;\r\n  alwaysOnline?: boolean;\r\n  readMessages?: boolean;\r\n  readStatus?: boolean;\r\n  syncFullHistory?: boolean;\r\n  wavoipToken?: string;\r\n  // proxy\r\n  proxyHost?: string;\r\n  proxyPort?: string;\r\n  proxyProtocol?: string;\r\n  proxyUsername?: string;\r\n  proxyPassword?: string;\r\n  webhook?: {\r\n    enabled?: boolean;\r\n    events?: string[];\r\n    headers?: JsonValue;\r\n    url?: string;\r\n    byEvents?: boolean;\r\n    base64?: boolean;\r\n  };\r\n  chatwootAccountId?: string;\r\n  chatwootConversationPending?: boolean;\r\n  chatwootAutoCreate?: boolean;\r\n  chatwootDaysLimitImportMessages?: number;\r\n  chatwootImportContacts?: boolean;\r\n  chatwootImportMessages?: boolean;\r\n  chatwootLogo?: string;\r\n  chatwootMergeBrazilContacts?: boolean;\r\n  chatwootNameInbox?: string;\r\n  chatwootOrganization?: string;\r\n  chatwootReopenConversation?: boolean;\r\n  chatwootSignMsg?: boolean;\r\n  chatwootToken?: string;\r\n  chatwootUrl?: string;\r\n}\r\n\r\nexport class SetPresenceDto {\r\n  presence: WAPresence;\r\n}\r\n","import { Integration } from '@api/types/wa.types';\r\nimport { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const instanceSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    // Instance\r\n    instanceName: { type: 'string' },\r\n    token: { type: 'string' },\r\n    number: { type: 'string', pattern: '^\\\\d+[\\\\.@\\\\w-]+' },\r\n    businessId: { type: 'string' },\r\n    qrcode: { type: 'boolean' },\r\n    Integration: {\r\n      type: 'string',\r\n      enum: Object.values(Integration),\r\n    },\r\n    // Settings\r\n    rejectCall: { type: 'boolean' },\r\n    msgCall: { type: 'string' },\r\n    groupsIgnore: { type: 'boolean' },\r\n    alwaysOnline: { type: 'boolean' },\r\n    readMessages: { type: 'boolean' },\r\n    readStatus: { type: 'boolean' },\r\n    syncFullHistory: { type: 'boolean' },\r\n    wavoipToken: { type: 'string' },\r\n    // Proxy\r\n    proxyHost: { type: 'string' },\r\n    proxyPort: { type: 'string' },\r\n    proxyProtocol: { type: 'string' },\r\n    proxyUsername: { type: 'string' },\r\n    proxyPassword: { type: 'string' },\r\n    // Webhook\r\n    webhookUrl: { type: 'string' },\r\n    webhookByEvents: { type: 'boolean' },\r\n    webhookBase64: { type: 'boolean' },\r\n    webhookEvents: {\r\n      type: 'array',\r\n      minItems: 0,\r\n      items: {\r\n        type: 'string',\r\n        enum: [\r\n          'APPLICATION_STARTUP',\r\n          'QRCODE_UPDATED',\r\n          'MESSAGES_SET',\r\n          'MESSAGES_UPSERT',\r\n          'MESSAGES_EDITED',\r\n          'MESSAGES_UPDATE',\r\n          'MESSAGES_DELETE',\r\n          'SEND_MESSAGE',\r\n          'CONTACTS_SET',\r\n          'CONTACTS_UPSERT',\r\n          'CONTACTS_UPDATE',\r\n          'PRESENCE_UPDATE',\r\n          'CHATS_SET',\r\n          'CHATS_UPSERT',\r\n          'CHATS_UPDATE',\r\n          'CHATS_DELETE',\r\n          'GROUPS_UPSERT',\r\n          'GROUP_UPDATE',\r\n          'GROUP_PARTICIPANTS_UPDATE',\r\n          'CONNECTION_UPDATE',\r\n          'LABELS_EDIT',\r\n          'LABELS_ASSOCIATION',\r\n          'CALL',\r\n          'TYPEBOT_START',\r\n          'TYPEBOT_CHANGE_STATUS',\r\n        ],\r\n      },\r\n    },\r\n    // RabbitMQ\r\n    rabbitmqEnabled: { type: 'boolean' },\r\n    rabbitmqEvents: {\r\n      type: 'array',\r\n      minItems: 0,\r\n      items: {\r\n        type: 'string',\r\n        enum: [\r\n          'APPLICATION_STARTUP',\r\n          'QRCODE_UPDATED',\r\n          'MESSAGES_SET',\r\n          'MESSAGES_UPSERT',\r\n          'MESSAGES_EDITED',\r\n          'MESSAGES_UPDATE',\r\n          'MESSAGES_DELETE',\r\n          'SEND_MESSAGE',\r\n          'CONTACTS_SET',\r\n          'CONTACTS_UPSERT',\r\n          'CONTACTS_UPDATE',\r\n          'PRESENCE_UPDATE',\r\n          'CHATS_SET',\r\n          'CHATS_UPSERT',\r\n          'CHATS_UPDATE',\r\n          'CHATS_DELETE',\r\n          'GROUPS_UPSERT',\r\n          'GROUP_UPDATE',\r\n          'GROUP_PARTICIPANTS_UPDATE',\r\n          'CONNECTION_UPDATE',\r\n          'LABELS_EDIT',\r\n          'LABELS_ASSOCIATION',\r\n          'CALL',\r\n          'TYPEBOT_START',\r\n          'TYPEBOT_CHANGE_STATUS',\r\n        ],\r\n      },\r\n    },\r\n    // SQS\r\n    sqsEnabled: { type: 'boolean' },\r\n    sqsEvents: {\r\n      type: 'array',\r\n      minItems: 0,\r\n      items: {\r\n        type: 'string',\r\n        enum: [\r\n          'APPLICATION_STARTUP',\r\n          'QRCODE_UPDATED',\r\n          'MESSAGES_SET',\r\n          'MESSAGES_UPSERT',\r\n          'MESSAGES_EDITED',\r\n          'MESSAGES_UPDATE',\r\n          'MESSAGES_DELETE',\r\n          'SEND_MESSAGE',\r\n          'CONTACTS_SET',\r\n          'CONTACTS_UPSERT',\r\n          'CONTACTS_UPDATE',\r\n          'PRESENCE_UPDATE',\r\n          'CHATS_SET',\r\n          'CHATS_UPSERT',\r\n          'CHATS_UPDATE',\r\n          'CHATS_DELETE',\r\n          'GROUPS_UPSERT',\r\n          'GROUP_UPDATE',\r\n          'GROUP_PARTICIPANTS_UPDATE',\r\n          'CONNECTION_UPDATE',\r\n          'LABELS_EDIT',\r\n          'LABELS_ASSOCIATION',\r\n          'CALL',\r\n          'TYPEBOT_START',\r\n          'TYPEBOT_CHANGE_STATUS',\r\n        ],\r\n      },\r\n    },\r\n    // Chatwoot\r\n    chatwootAccountId: { type: 'string' },\r\n    chatwootToken: { type: 'string' },\r\n    chatwootUrl: { type: 'string' },\r\n    chatwootSignMsg: { type: 'boolean' },\r\n    chatwootReopenConversation: { type: 'boolean' },\r\n    chatwootConversationPending: { type: 'boolean' },\r\n    chatwootImportContacts: { type: 'boolean' },\r\n    chatwootNameInbox: { type: 'string' },\r\n    chatwootMergeBrazilContacts: { type: 'boolean' },\r\n    chatwootImportMessages: { type: 'boolean' },\r\n    chatwootDaysLimitImportMessages: { type: 'number' },\r\n  },\r\n  ...isNotEmpty('instanceName'),\r\n};\r\n\r\nexport const presenceOnlySchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    presence: {\r\n      type: 'string',\r\n      enum: ['unavailable', 'available', 'composing', 'recording', 'paused'],\r\n    },\r\n  },\r\n  required: ['presence'],\r\n};\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { baileysController } from '@api/server.module';\r\nimport { instanceSchema } from '@validate/instance.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class BaileysRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('onWhatsapp'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.onWhatsapp(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('profilePictureUrl'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.profilePictureUrl(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('assertSessions'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.assertSessions(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('createParticipantNodes'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.createParticipantNodes(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('getUSyncDevices'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.getUSyncDevices(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('generateMessageTag'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.generateMessageTag(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('sendNode'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.sendNode(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('signalRepositoryDecryptMessage'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.signalRepositoryDecryptMessage(instance, req.body),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('getAuthState'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => baileysController.getAuthState(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { JSONSchema7, JSONSchema7Definition } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nconst numberDefinition: JSONSchema7Definition = {\r\n  type: 'string',\r\n  description: 'Invalid format',\r\n};\r\n\r\nexport const whatsappNumberSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    numbers: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        description: '\"numbers\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n};\r\n\r\nexport const readMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    readMessages: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        properties: {\r\n          id: { type: 'string' },\r\n          fromMe: { type: 'boolean', enum: [true, false] },\r\n          remoteJid: { type: 'string' },\r\n        },\r\n        required: ['id', 'fromMe', 'remoteJid'],\r\n        ...isNotEmpty('id', 'remoteJid'),\r\n      },\r\n    },\r\n  },\r\n  required: ['readMessages'],\r\n};\r\n\r\nexport const archiveChatSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    chat: { type: 'string' },\r\n    lastMessage: {\r\n      type: 'object',\r\n      properties: {\r\n        key: {\r\n          type: 'object',\r\n          properties: {\r\n            id: { type: 'string' },\r\n            remoteJid: { type: 'string' },\r\n            fromMe: { type: 'boolean', enum: [true, false] },\r\n          },\r\n          required: ['id', 'fromMe', 'remoteJid'],\r\n          ...isNotEmpty('id', 'remoteJid'),\r\n        },\r\n        messageTimestamp: { type: 'integer', minLength: 1 },\r\n      },\r\n      required: ['key'],\r\n      ...isNotEmpty('messageTimestamp'),\r\n    },\r\n    archive: { type: 'boolean', enum: [true, false] },\r\n  },\r\n  required: ['archive'],\r\n};\r\n\r\nexport const markChatUnreadSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    chat: { type: 'string' },\r\n    lastMessage: {\r\n      type: 'object',\r\n      properties: {\r\n        key: {\r\n          type: 'object',\r\n          properties: {\r\n            id: { type: 'string' },\r\n            remoteJid: { type: 'string' },\r\n            fromMe: { type: 'boolean', enum: [true, false] },\r\n          },\r\n          required: ['id', 'fromMe', 'remoteJid'],\r\n          ...isNotEmpty('id', 'remoteJid'),\r\n        },\r\n        messageTimestamp: { type: 'integer', minLength: 1 },\r\n      },\r\n      required: ['key'],\r\n      ...isNotEmpty('messageTimestamp'),\r\n    },\r\n  },\r\n  required: ['lastMessage'],\r\n};\r\n\r\nexport const deleteMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    id: { type: 'string' },\r\n    fromMe: { type: 'boolean', enum: [true, false] },\r\n    remoteJid: { type: 'string' },\r\n    participant: { type: 'string' },\r\n  },\r\n  required: ['id', 'fromMe', 'remoteJid'],\r\n  ...isNotEmpty('id', 'remoteJid', 'participant'),\r\n};\r\n\r\nexport const profilePictureSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { type: 'string' },\r\n    picture: { type: 'string' },\r\n  },\r\n};\r\n\r\nexport const updateMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { type: 'string' },\r\n    text: { type: 'string' },\r\n    key: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' },\r\n        remoteJid: { type: 'string' },\r\n        fromMe: { type: 'boolean', enum: [true, false] },\r\n      },\r\n      required: ['id', 'fromMe', 'remoteJid'],\r\n      ...isNotEmpty('id', 'remoteJid'),\r\n    },\r\n  },\r\n  ...isNotEmpty('number', 'text', 'key'),\r\n};\r\n\r\nexport const presenceSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    delay: { type: 'number' },\r\n    presence: {\r\n      type: 'string',\r\n      enum: ['unavailable', 'available', 'composing', 'recording', 'paused'],\r\n    },\r\n  },\r\n  required: ['number', 'presence', 'delay'],\r\n};\r\n\r\nexport const blockUserSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { type: 'string' },\r\n    status: { type: 'string', enum: ['block', 'unblock'] },\r\n  },\r\n  required: ['number', 'status'],\r\n  ...isNotEmpty('number', 'status'),\r\n};\r\n\r\nexport const contactValidateSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    where: {\r\n      type: 'object',\r\n      properties: {\r\n        _id: { type: 'string', minLength: 1 },\r\n        pushName: { type: 'string', minLength: 1 },\r\n        id: { type: 'string', minLength: 1 },\r\n      },\r\n      ...isNotEmpty('_id', 'id', 'pushName'),\r\n    },\r\n  },\r\n};\r\n\r\nexport const messageValidateSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    where: {\r\n      type: 'object',\r\n      properties: {\r\n        _id: { type: 'string', minLength: 1 },\r\n        key: {\r\n          type: 'object',\r\n          if: {\r\n            propertyNames: {\r\n              enum: ['fromMe', 'remoteJid', 'id'],\r\n            },\r\n          },\r\n          then: {\r\n            properties: {\r\n              remoteJid: {\r\n                type: 'string',\r\n                minLength: 1,\r\n                description: 'The property cannot be empty',\r\n              },\r\n              id: {\r\n                type: 'string',\r\n                minLength: 1,\r\n                description: 'The property cannot be empty',\r\n              },\r\n              fromMe: { type: 'boolean', enum: [true, false] },\r\n            },\r\n          },\r\n        },\r\n        message: { type: 'object' },\r\n      },\r\n      ...isNotEmpty('_id'),\r\n    },\r\n    limit: { type: 'integer' },\r\n  },\r\n};\r\n\r\nexport const messageUpSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    where: {\r\n      type: 'object',\r\n      properties: {\r\n        _id: { type: 'string' },\r\n        remoteJid: { type: 'string' },\r\n        id: { type: 'string' },\r\n        fromMe: { type: 'boolean', enum: [true, false] },\r\n        participant: { type: 'string' },\r\n        status: {\r\n          type: 'string',\r\n          enum: ['ERROR', 'PENDING', 'SERVER_ACK', 'DELIVERY_ACK', 'READ', 'PLAYED'],\r\n        },\r\n      },\r\n      ...isNotEmpty('_id', 'remoteJid', 'id', 'status'),\r\n    },\r\n    limit: { type: 'integer' },\r\n  },\r\n};\r\n\r\nexport const privacySettingsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    readreceipts: { type: 'string', enum: ['all', 'none'] },\r\n    profile: {\r\n      type: 'string',\r\n      enum: ['all', 'contacts', 'contact_blacklist', 'none'],\r\n    },\r\n    status: {\r\n      type: 'string',\r\n      enum: ['all', 'contacts', 'contact_blacklist', 'none'],\r\n    },\r\n    online: { type: 'string', enum: ['all', 'match_last_seen'] },\r\n    last: { type: 'string', enum: ['all', 'contacts', 'contact_blacklist', 'none'] },\r\n    groupadd: {\r\n      type: 'string',\r\n      enum: ['all', 'contacts', 'contact_blacklist', 'none'],\r\n    },\r\n  },\r\n  required: ['readreceipts', 'profile', 'status', 'online', 'last', 'groupadd'],\r\n  ...isNotEmpty('readreceipts', 'profile', 'status', 'online', 'last', 'groupadd'),\r\n};\r\n\r\nexport const profileNameSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    name: { type: 'string' },\r\n  },\r\n  ...isNotEmpty('name'),\r\n};\r\n\r\nexport const profileStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    status: { type: 'string' },\r\n  },\r\n  ...isNotEmpty('status'),\r\n};\r\n\r\nexport const profileSchema: JSONSchema7 = {\r\n  type: 'object',\r\n  properties: {\r\n    wuid: { type: 'string' },\r\n    name: { type: 'string' },\r\n    picture: { type: 'string' },\r\n    status: { type: 'string' },\r\n    isBusiness: { type: 'boolean' },\r\n  },\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const createGroupSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    subject: { type: 'string' },\r\n    description: { type: 'string' },\r\n    profilePicture: { type: 'string' },\r\n    promoteParticipants: { type: 'boolean', enum: [true, false] },\r\n    participants: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        minLength: 10,\r\n        pattern: '\\\\d+',\r\n        description: '\"participants\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['subject', 'participants'],\r\n  ...isNotEmpty('subject', 'description', 'profilePicture'),\r\n};\r\n\r\nexport const groupJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string', pattern: '^[\\\\d-]+@g.us$' },\r\n  },\r\n  required: ['groupJid'],\r\n  ...isNotEmpty('groupJid'),\r\n};\r\n\r\nexport const getParticipantsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    getParticipants: { type: 'string', enum: ['true', 'false'] },\r\n  },\r\n  required: ['getParticipants'],\r\n  ...isNotEmpty('getParticipants'),\r\n};\r\n\r\nexport const groupSendInviteSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    description: { type: 'string' },\r\n    numbers: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        minLength: 10,\r\n        pattern: '\\\\d+',\r\n        description: '\"numbers\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['groupJid', 'description', 'numbers'],\r\n  ...isNotEmpty('groupJid', 'description', 'numbers'),\r\n};\r\n\r\nexport const groupInviteSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    inviteCode: { type: 'string', pattern: '^[a-zA-Z0-9]{22}$' },\r\n  },\r\n  required: ['inviteCode'],\r\n  ...isNotEmpty('inviteCode'),\r\n};\r\n\r\nexport const AcceptGroupInviteSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    inviteCode: { type: 'string', pattern: '^[a-zA-Z0-9]{22}$' },\r\n  },\r\n  required: ['inviteCode'],\r\n  ...isNotEmpty('inviteCode'),\r\n};\r\n\r\nexport const updateParticipantsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    action: {\r\n      type: 'string',\r\n      enum: ['add', 'remove', 'promote', 'demote'],\r\n    },\r\n    participants: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        minLength: 10,\r\n        pattern: '\\\\d+',\r\n        description: '\"participants\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['groupJid', 'action', 'participants'],\r\n  ...isNotEmpty('groupJid', 'action'),\r\n};\r\n\r\nexport const updateSettingsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    action: {\r\n      type: 'string',\r\n      enum: ['announcement', 'not_announcement', 'locked', 'unlocked'],\r\n    },\r\n  },\r\n  required: ['groupJid', 'action'],\r\n  ...isNotEmpty('groupJid', 'action'),\r\n};\r\n\r\nexport const toggleEphemeralSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    expiration: {\r\n      type: 'number',\r\n      enum: [0, 86400, 604800, 7776000],\r\n    },\r\n  },\r\n  required: ['groupJid', 'expiration'],\r\n  ...isNotEmpty('groupJid', 'expiration'),\r\n};\r\n\r\nexport const updateGroupPictureSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    image: { type: 'string' },\r\n  },\r\n  required: ['groupJid', 'image'],\r\n  ...isNotEmpty('groupJid', 'image'),\r\n};\r\n\r\nexport const updateGroupSubjectSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    subject: { type: 'string' },\r\n  },\r\n  required: ['groupJid', 'subject'],\r\n  ...isNotEmpty('groupJid', 'subject'),\r\n};\r\n\r\nexport const updateGroupDescriptionSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    groupJid: { type: 'string' },\r\n    description: { type: 'string' },\r\n  },\r\n  required: ['groupJid', 'description'],\r\n  ...isNotEmpty('groupJid', 'description'),\r\n};\r\n","import { JSONSchema7, JSONSchema7Definition } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nconst numberDefinition: JSONSchema7Definition = {\r\n  type: 'string',\r\n  description: 'Invalid format',\r\n};\r\n\r\nexport const handleLabelSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    labelId: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['number', 'labelId', 'action'],\r\n  ...isNotEmpty('number', 'labelId', 'action'),\r\n};\r\n","import { JSONSchema7, JSONSchema7Definition } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nconst numberDefinition: JSONSchema7Definition = {\r\n  type: 'string',\r\n  description: 'Invalid format',\r\n};\r\n\r\nexport const templateMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    name: { type: 'string' },\r\n    language: { type: 'string' },\r\n    components: { type: 'array' },\r\n    webhookUrl: { type: 'string' },\r\n  },\r\n  required: ['name', 'language'],\r\n};\r\n\r\nconst quotedOptionsSchema: JSONSchema7 = {\r\n  properties: {\r\n    key: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' },\r\n        remoteJid: { type: 'string' },\r\n        fromMe: { type: 'boolean', enum: [true, false] },\r\n      },\r\n      required: ['id'],\r\n      ...isNotEmpty('id'),\r\n    },\r\n    message: { type: 'object' },\r\n  },\r\n};\r\n\r\nexport const offerCallSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    isVideo: { type: 'boolean', enum: [true, false] },\r\n    callDuration: { type: 'integer', minimum: 1, maximum: 15 },\r\n  },\r\n  required: ['number', 'callDuration'],\r\n};\r\n\r\nexport const textMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    text: { type: 'string' },\r\n    linkPreview: { type: 'boolean' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number', 'text'],\r\n};\r\n\r\nexport const mediaMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    mediatype: { type: 'string', enum: ['image', 'document', 'video', 'audio'] },\r\n    mimetype: { type: 'string' },\r\n    media: { type: 'string' },\r\n    fileName: { type: 'string' },\r\n    caption: { type: 'string' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number', 'mediatype'],\r\n};\r\n\r\nexport const ptvMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    video: { type: 'string' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number'],\r\n};\r\n\r\nexport const audioMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    audio: { type: 'string' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number'],\r\n};\r\n\r\nexport const statusMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    type: { type: 'string', enum: ['text', 'image', 'audio', 'video'] },\r\n    content: { type: 'string' },\r\n    caption: { type: 'string' },\r\n    backgroundColor: { type: 'string' },\r\n    font: { type: 'integer', minimum: 0, maximum: 5 },\r\n    statusJidList: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"statusJidList\" must be an array of numeric strings',\r\n      },\r\n    },\r\n    allContacts: { type: 'boolean', enum: [true, false] },\r\n  },\r\n  required: ['type'],\r\n};\r\n\r\nexport const stickerMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    sticker: { type: 'string' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number'],\r\n};\r\n\r\nexport const locationMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    latitude: { type: 'number' },\r\n    longitude: { type: 'number' },\r\n    name: { type: 'string' },\r\n    address: { type: 'string' },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number', 'latitude', 'longitude', 'name', 'address'],\r\n};\r\n\r\nexport const contactMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    contact: {\r\n      type: 'array',\r\n      items: {\r\n        type: 'object',\r\n        properties: {\r\n          fullName: { type: 'string' },\r\n          wuid: {\r\n            type: 'string',\r\n            minLength: 10,\r\n            pattern: '\\\\d+',\r\n            description: '\"wuid\" must be a numeric string',\r\n          },\r\n          phoneNumber: { type: 'string', minLength: 10 },\r\n          organization: { type: 'string' },\r\n          email: { type: 'string' },\r\n          url: { type: 'string' },\r\n        },\r\n        required: ['fullName', 'phoneNumber'],\r\n        ...isNotEmpty('fullName'),\r\n      },\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n    },\r\n  },\r\n  required: ['number', 'contact'],\r\n};\r\n\r\nexport const reactionMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    key: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' },\r\n        remoteJid: { type: 'string' },\r\n        fromMe: { type: 'boolean', enum: [true, false] },\r\n      },\r\n      required: ['id', 'remoteJid', 'fromMe'],\r\n      ...isNotEmpty('id', 'remoteJid'),\r\n    },\r\n    reaction: { type: 'string' },\r\n  },\r\n  required: ['key', 'reaction'],\r\n};\r\n\r\nexport const pollMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    name: { type: 'string' },\r\n    selectableCount: { type: 'integer', minimum: 0, maximum: 10 },\r\n    values: {\r\n      type: 'array',\r\n      minItems: 2,\r\n      maxItems: 10,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n      },\r\n    },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number', 'name', 'selectableCount', 'values'],\r\n};\r\n\r\nexport const listMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    title: { type: 'string' },\r\n    description: { type: 'string' },\r\n    footerText: { type: 'string' },\r\n    buttonText: { type: 'string' },\r\n    sections: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'object',\r\n        properties: {\r\n          title: { type: 'string' },\r\n          rows: {\r\n            type: 'array',\r\n            minItems: 1,\r\n            uniqueItems: true,\r\n            items: {\r\n              type: 'object',\r\n              properties: {\r\n                title: { type: 'string' },\r\n                description: { type: 'string' },\r\n                rowId: { type: 'string' },\r\n              },\r\n              required: ['title', 'rowId'],\r\n              ...isNotEmpty('title', 'description', 'rowId'),\r\n            },\r\n          },\r\n        },\r\n        required: ['title', 'rows'],\r\n        ...isNotEmpty('title'),\r\n      },\r\n    },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number', 'title', 'footerText', 'buttonText', 'sections'],\r\n};\r\n\r\nexport const buttonsMessageSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    number: { ...numberDefinition },\r\n    thumbnailUrl: { type: 'string' },\r\n    title: { type: 'string' },\r\n    description: { type: 'string' },\r\n    footer: { type: 'string' },\r\n    buttons: {\r\n      type: 'array',\r\n      items: {\r\n        type: 'object',\r\n        properties: {\r\n          type: {\r\n            type: 'string',\r\n            enum: ['reply', 'copy', 'url', 'call', 'pix'],\r\n          },\r\n          displayText: { type: 'string' },\r\n          id: { type: 'string' },\r\n          url: { type: 'string' },\r\n          phoneNumber: { type: 'string' },\r\n          currency: { type: 'string' },\r\n          name: { type: 'string' },\r\n          keyType: { type: 'string', enum: ['phone', 'email', 'cpf', 'cnpj', 'random'] },\r\n          key: { type: 'string' },\r\n        },\r\n        required: ['type'],\r\n        ...isNotEmpty('id', 'url', 'phoneNumber'),\r\n      },\r\n    },\r\n    delay: {\r\n      type: 'integer',\r\n      description: 'Enter a value in milliseconds',\r\n    },\r\n    quoted: { ...quotedOptionsSchema },\r\n    everyOne: { type: 'boolean', enum: [true, false] },\r\n    mentioned: {\r\n      type: 'array',\r\n      minItems: 1,\r\n      uniqueItems: true,\r\n      items: {\r\n        type: 'string',\r\n        pattern: '^\\\\d+',\r\n        description: '\"mentioned\" must be an array of numeric strings',\r\n      },\r\n    },\r\n  },\r\n  required: ['number'],\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const proxySchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean', enum: [true, false] },\r\n    host: { type: 'string' },\r\n    port: { type: 'string' },\r\n    protocol: { type: 'string' },\r\n    username: { type: 'string' },\r\n    password: { type: 'string' },\r\n  },\r\n  required: ['enabled', 'host', 'port', 'protocol'],\r\n  ...isNotEmpty('enabled', 'host', 'port', 'protocol'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const settingsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    rejectCall: { type: 'boolean' },\r\n    msgCall: { type: 'string' },\r\n    groupsIgnore: { type: 'boolean' },\r\n    alwaysOnline: { type: 'boolean' },\r\n    readMessages: { type: 'boolean' },\r\n    readStatus: { type: 'boolean' },\r\n    syncFullHistory: { type: 'boolean' },\r\n    wavoipToken: { type: 'string' },\r\n  },\r\n  required: ['rejectCall', 'groupsIgnore', 'alwaysOnline', 'readMessages', 'readStatus', 'syncFullHistory'],\r\n  ...isNotEmpty('rejectCall', 'groupsIgnore', 'alwaysOnline', 'readMessages', 'readStatus', 'syncFullHistory'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const templateSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    name: { type: 'string' },\r\n    category: { type: 'string', enum: ['AUTHENTICATION', 'MARKETING', 'UTILITY'] },\r\n    allowCategoryChange: { type: 'boolean' },\r\n    language: { type: 'string' },\r\n    components: { type: 'array' },\r\n    webhookUrl: { type: 'string' },\r\n  },\r\n  required: ['name', 'category', 'language', 'components'],\r\n  ...isNotEmpty('name', 'category', 'language', 'components'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const chatwootSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean', enum: [true, false] },\r\n    accountId: { type: 'string' },\r\n    token: { type: 'string' },\r\n    url: { type: 'string' },\r\n    signMsg: { type: 'boolean', enum: [true, false] },\r\n    signDelimiter: { type: ['string', 'null'] },\r\n    nameInbox: { type: ['string', 'null'] },\r\n    reopenConversation: { type: 'boolean', enum: [true, false] },\r\n    conversationPending: { type: 'boolean', enum: [true, false] },\r\n    autoCreate: { type: 'boolean', enum: [true, false] },\r\n    importContacts: { type: 'boolean', enum: [true, false] },\r\n    mergeBrazilContacts: { type: 'boolean', enum: [true, false] },\r\n    importMessages: { type: 'boolean', enum: [true, false] },\r\n    daysLimitImportMessages: { type: 'number' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n  },\r\n  required: ['enabled', 'accountId', 'token', 'url', 'signMsg', 'reopenConversation', 'conversationPending'],\r\n  ...isNotEmpty('enabled', 'accountId', 'token', 'url', 'signMsg', 'reopenConversation', 'conversationPending'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const difySchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean' },\r\n    description: { type: 'string' },\r\n    botType: { type: 'string', enum: ['chatBot', 'textGenerator', 'agent', 'workflow'] },\r\n    apiUrl: { type: 'string' },\r\n    apiKey: { type: 'string' },\r\n    triggerType: { type: 'string', enum: ['all', 'keyword', 'none', 'advanced'] },\r\n    triggerOperator: { type: 'string', enum: ['equals', 'contains', 'startsWith', 'endsWith', 'regex'] },\r\n    triggerValue: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    splitMessages: { type: 'boolean' },\r\n    timePerChar: { type: 'integer' },\r\n  },\r\n  required: ['enabled', 'botType', 'triggerType'],\r\n  ...isNotEmpty('enabled', 'botType', 'triggerType'),\r\n};\r\n\r\nexport const difyStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    status: { type: 'string', enum: ['opened', 'closed', 'paused', 'delete'] },\r\n  },\r\n  required: ['remoteJid', 'status'],\r\n  ...isNotEmpty('remoteJid', 'status'),\r\n};\r\n\r\nexport const difySettingSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    difyIdFallback: { type: 'string' },\r\n    splitMessages: { type: 'boolean' },\r\n    timePerChar: { type: 'integer' },\r\n  },\r\n  required: [\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n    'splitMessages',\r\n    'timePerChar',\r\n  ],\r\n  ...isNotEmpty(\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n    'splitMessages',\r\n    'timePerChar',\r\n  ),\r\n};\r\n\r\nexport const difyIgnoreJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['remoteJid', 'action'],\r\n  ...isNotEmpty('remoteJid', 'action'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const evolutionBotSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean' },\r\n    description: { type: 'string' },\r\n    apiUrl: { type: 'string' },\r\n    apiKey: { type: 'string' },\r\n    triggerType: { type: 'string', enum: ['all', 'keyword', 'none', 'advanced'] },\r\n    triggerOperator: { type: 'string', enum: ['equals', 'contains', 'startsWith', 'endsWith', 'regex'] },\r\n    triggerValue: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    splitMessages: { type: 'boolean' },\r\n    timePerChar: { type: 'integer' },\r\n  },\r\n  required: ['enabled', 'apiUrl', 'triggerType'],\r\n  ...isNotEmpty('enabled', 'apiUrl', 'triggerType'),\r\n};\r\n\r\nexport const evolutionBotStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    status: { type: 'string', enum: ['opened', 'closed', 'paused', 'delete'] },\r\n  },\r\n  required: ['remoteJid', 'status'],\r\n  ...isNotEmpty('remoteJid', 'status'),\r\n};\r\n\r\nexport const evolutionBotSettingSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    botIdFallback: { type: 'string' },\r\n    splitMessages: { type: 'boolean' },\r\n    timePerChar: { type: 'integer' },\r\n  },\r\n  required: [\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n    'splitMessages',\r\n    'timePerChar',\r\n  ],\r\n  ...isNotEmpty(\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n    'splitMessages',\r\n    'timePerChar',\r\n  ),\r\n};\r\n\r\nexport const evolutionBotIgnoreJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['remoteJid', 'action'],\r\n  ...isNotEmpty('remoteJid', 'action'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const flowiseSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean' },\r\n    description: { type: 'string' },\r\n    apiUrl: { type: 'string' },\r\n    apiKey: { type: 'string' },\r\n    triggerType: { type: 'string', enum: ['all', 'keyword', 'none', 'advanced'] },\r\n    triggerOperator: { type: 'string', enum: ['equals', 'contains', 'startsWith', 'endsWith', 'regex'] },\r\n    triggerValue: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n  },\r\n  required: ['enabled', 'apiUrl', 'triggerType'],\r\n  ...isNotEmpty('enabled', 'apiUrl', 'triggerType'),\r\n};\r\n\r\nexport const flowiseStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    status: { type: 'string', enum: ['opened', 'closed', 'paused', 'delete'] },\r\n  },\r\n  required: ['remoteJid', 'status'],\r\n  ...isNotEmpty('remoteJid', 'status'),\r\n};\r\n\r\nexport const flowiseSettingSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    botIdFallback: { type: 'string' },\r\n  },\r\n  required: [\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n  ],\r\n  ...isNotEmpty(\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n  ),\r\n};\r\n\r\nexport const flowiseIgnoreJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['remoteJid', 'action'],\r\n  ...isNotEmpty('remoteJid', 'action'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const openaiSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean' },\r\n    description: { type: 'string' },\r\n    openaiCredsId: { type: 'string' },\r\n    botType: { type: 'string', enum: ['assistant', 'chatCompletion'] },\r\n    assistantId: { type: 'string' },\r\n    functionUrl: { type: 'string' },\r\n    model: { type: 'string' },\r\n    systemMessages: { type: 'array', items: { type: 'string' } },\r\n    assistantMessages: { type: 'array', items: { type: 'string' } },\r\n    userMessages: { type: 'array', items: { type: 'string' } },\r\n    maxTokens: { type: 'integer' },\r\n    triggerType: { type: 'string', enum: ['all', 'keyword', 'none', 'advanced'] },\r\n    triggerOperator: { type: 'string', enum: ['equals', 'contains', 'startsWith', 'endsWith', 'regex'] },\r\n    triggerValue: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n  },\r\n  required: ['enabled', 'openaiCredsId', 'botType', 'triggerType'],\r\n  ...isNotEmpty('enabled', 'openaiCredsId', 'botType', 'triggerType'),\r\n};\r\n\r\nexport const openaiCredsSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    name: { type: 'string' },\r\n    apiKey: { type: 'string' },\r\n  },\r\n  required: ['name', 'apiKey'],\r\n  ...isNotEmpty('name', 'apiKey'),\r\n};\r\n\r\nexport const openaiStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    status: { type: 'string', enum: ['opened', 'closed', 'paused', 'delete'] },\r\n  },\r\n  required: ['remoteJid', 'status'],\r\n  ...isNotEmpty('remoteJid', 'status'),\r\n};\r\n\r\nexport const openaiSettingSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    openaiCredsId: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    speechToText: { type: 'boolean' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n    openaiIdFallback: { type: 'string' },\r\n  },\r\n  required: [\r\n    'openaiCredsId',\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n  ],\r\n  ...isNotEmpty(\r\n    'openaiCredsId',\r\n    'expire',\r\n    'keywordFinish',\r\n    'delayMessage',\r\n    'unknownMessage',\r\n    'listeningFromMe',\r\n    'stopBotFromMe',\r\n    'keepOpen',\r\n    'debounceTime',\r\n    'ignoreJids',\r\n  ),\r\n};\r\n\r\nexport const openaiIgnoreJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['remoteJid', 'action'],\r\n  ...isNotEmpty('remoteJid', 'action'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const typebotSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    enabled: { type: 'boolean' },\r\n    description: { type: 'string' },\r\n    url: { type: 'string' },\r\n    typebot: { type: 'string' },\r\n    triggerType: { type: 'string', enum: ['all', 'keyword', 'none', 'advanced'] },\r\n    triggerOperator: { type: 'string', enum: ['equals', 'contains', 'startsWith', 'endsWith', 'regex'] },\r\n    triggerValue: { type: 'string' },\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n  },\r\n  required: ['enabled', 'url', 'typebot', 'triggerType'],\r\n  ...isNotEmpty('enabled', 'url', 'typebot', 'triggerType'),\r\n};\r\n\r\nexport const typebotStatusSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    status: { type: 'string', enum: ['opened', 'closed', 'paused', 'delete'] },\r\n  },\r\n  required: ['remoteJid', 'status'],\r\n  ...isNotEmpty('remoteJid', 'status'),\r\n};\r\n\r\nexport const typebotStartSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    url: { type: 'string' },\r\n    typebot: { type: 'string' },\r\n  },\r\n  required: ['remoteJid', 'url', 'typebot'],\r\n  ...isNotEmpty('remoteJid', 'url', 'typebot'),\r\n};\r\n\r\nexport const typebotSettingSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    expire: { type: 'integer' },\r\n    keywordFinish: { type: 'string' },\r\n    delayMessage: { type: 'integer' },\r\n    unknownMessage: { type: 'string' },\r\n    listeningFromMe: { type: 'boolean' },\r\n    stopBotFromMe: { type: 'boolean' },\r\n    keepOpen: { type: 'boolean' },\r\n    debounceTime: { type: 'integer' },\r\n    typebotIdFallback: { type: 'string' },\r\n    ignoreJids: { type: 'array', items: { type: 'string' } },\r\n  },\r\n  required: ['expire', 'keywordFinish', 'delayMessage', 'unknownMessage', 'listeningFromMe', 'stopBotFromMe'],\r\n  ...isNotEmpty('expire', 'keywordFinish', 'delayMessage', 'unknownMessage', 'listeningFromMe', 'stopBotFromMe'),\r\n};\r\n\r\nexport const typebotIgnoreJidSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    remoteJid: { type: 'string' },\r\n    action: { type: 'string', enum: ['add', 'remove'] },\r\n  },\r\n  required: ['remoteJid', 'action'],\r\n  ...isNotEmpty('remoteJid', 'action'),\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { EventController } from '../event.controller';\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\nexport const pusherSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    pusher: {\r\n      type: 'object',\r\n      properties: {\r\n        enabled: { type: 'boolean' },\r\n        appId: { type: 'string' },\r\n        key: { type: 'string' },\r\n        secret: { type: 'string' },\r\n        cluster: { type: 'string' },\r\n        useTLS: { type: 'boolean' },\r\n        events: {\r\n          type: 'array',\r\n          minItems: 0,\r\n          items: {\r\n            type: 'string',\r\n            enum: EventController.events,\r\n          },\r\n        },\r\n      },\r\n      required: ['enabled', 'appId', 'key', 'secret', 'cluster', 'useTLS'],\r\n      ...isNotEmpty('enabled', 'appId', 'key', 'secret', 'cluster', 'useTLS'),\r\n    },\r\n  },\r\n  required: ['pusher'],\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { EventController } from '../event.controller';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const webhookSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    webhook: {\r\n      type: 'object',\r\n      properties: {\r\n        enabled: { type: 'boolean' },\r\n        url: { type: 'string' },\r\n        headers: { type: 'object' },\r\n        byEvents: { type: 'boolean' },\r\n        base64: { type: 'boolean' },\r\n        events: {\r\n          type: 'array',\r\n          minItems: 0,\r\n          items: {\r\n            type: 'string',\r\n            enum: EventController.events,\r\n          },\r\n        },\r\n      },\r\n      required: ['enabled', 'url'],\r\n      ...isNotEmpty('enabled', 'url'),\r\n    },\r\n  },\r\n  required: ['webhook'],\r\n};\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nimport { EventController } from './event.controller';\r\n\r\nexport * from '@api/integrations/event/pusher/pusher.schema';\r\nexport * from '@api/integrations/event/webhook/webhook.schema';\r\n\r\nexport const eventSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    websocket: {\r\n      $ref: '#/$defs/event',\r\n    },\r\n    rabbitmq: {\r\n      $ref: '#/$defs/event',\r\n    },\r\n    sqs: {\r\n      $ref: '#/$defs/event',\r\n    },\r\n  },\r\n  $defs: {\r\n    event: {\r\n      type: 'object',\r\n      properties: {\r\n        enabled: { type: 'boolean', enum: [true, false] },\r\n        events: {\r\n          type: 'array',\r\n          minItems: 0,\r\n          items: {\r\n            type: 'string',\r\n            enum: EventController.events,\r\n          },\r\n        },\r\n      },\r\n      required: ['enabled'],\r\n    },\r\n  },\r\n};\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ChatwootDto } from '@api/integrations/chatbot/chatwoot/dto/chatwoot.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { chatwootController } from '@api/server.module';\r\nimport { chatwootSchema, instanceSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class ChatwootRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ChatwootDto>({\r\n          request: req,\r\n          schema: chatwootSchema,\r\n          ClassRef: ChatwootDto,\r\n          execute: (instance, data) => chatwootController.createChatwoot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => chatwootController.findChatwoot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('webhook'), async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => chatwootController.receiveWebhook(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class Session {\r\n  remoteJid?: string;\r\n  sessionId?: string;\r\n  status?: string;\r\n  createdAt?: number;\r\n  updateAt?: number;\r\n}\r\n\r\nexport class IgnoreJidDto {\r\n  remoteJid?: string;\r\n  action?: string;\r\n}\r\n","import { $Enums, TriggerOperator, TriggerType } from '@prisma/client';\r\n\r\nexport class DifyDto {\r\n  enabled?: boolean;\r\n  description?: string;\r\n  botType?: $Enums.DifyBotType;\r\n  apiUrl?: string;\r\n  apiKey?: string;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  triggerType?: TriggerType;\r\n  triggerOperator?: TriggerOperator;\r\n  triggerValue?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n\r\nexport class DifySettingDto {\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  difyIdFallback?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { DifyDto, DifySettingDto } from '@api/integrations/chatbot/dify/dto/dify.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { difyController } from '@api/server.module';\r\nimport {\r\n  difyIgnoreJidSchema,\r\n  difySchema,\r\n  difySettingSchema,\r\n  difyStatusSchema,\r\n  instanceSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class DifyRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<DifyDto>({\r\n          request: req,\r\n          schema: difySchema,\r\n          ClassRef: DifyDto,\r\n          execute: (instance, data) => difyController.createBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => difyController.findBot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetch/:difyId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => difyController.fetchBot(instance, req.params.difyId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .put(this.routerPath('update/:difyId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<DifyDto>({\r\n          request: req,\r\n          schema: difySchema,\r\n          ClassRef: DifyDto,\r\n          execute: (instance, data) => difyController.updateBot(instance, req.params.difyId, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete/:difyId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => difyController.deleteBot(instance, req.params.difyId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('settings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<DifySettingDto>({\r\n          request: req,\r\n          schema: difySettingSchema,\r\n          ClassRef: DifySettingDto,\r\n          execute: (instance, data) => difyController.settings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => difyController.fetchSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('changeStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: difyStatusSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => difyController.changeStatus(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSessions/:difyId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => difyController.fetchSessions(instance, req.params.difyId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('ignoreJid'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<IgnoreJidDto>({\r\n          request: req,\r\n          schema: difyIgnoreJidSchema,\r\n          ClassRef: IgnoreJidDto,\r\n          execute: (instance, data) => difyController.ignoreJid(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { TriggerOperator, TriggerType } from '@prisma/client';\r\n\r\nexport class OpenaiCredsDto {\r\n  name: string;\r\n  apiKey: string;\r\n}\r\n\r\nexport class OpenaiDto {\r\n  enabled?: boolean;\r\n  description?: string;\r\n  openaiCredsId: string;\r\n  botType?: string;\r\n  assistantId?: string;\r\n  functionUrl?: string;\r\n  model?: string;\r\n  systemMessages?: string[];\r\n  assistantMessages?: string[];\r\n  userMessages?: string[];\r\n  maxTokens?: number;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  triggerType?: TriggerType;\r\n  triggerOperator?: TriggerOperator;\r\n  triggerValue?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n\r\nexport class OpenaiSettingDto {\r\n  openaiCredsId?: string;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  openaiIdFallback?: string;\r\n  ignoreJids?: any;\r\n  speechToText?: boolean;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { OpenaiCredsDto, OpenaiDto, OpenaiSettingDto } from '@api/integrations/chatbot/openai/dto/openai.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { openaiController } from '@api/server.module';\r\nimport {\r\n  instanceSchema,\r\n  openaiCredsSchema,\r\n  openaiIgnoreJidSchema,\r\n  openaiSchema,\r\n  openaiSettingSchema,\r\n  openaiStatusSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class OpenaiRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('creds'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<OpenaiCredsDto>({\r\n          request: req,\r\n          schema: openaiCredsSchema,\r\n          ClassRef: OpenaiCredsDto,\r\n          execute: (instance, data) => openaiController.createOpenaiCreds(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('creds'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.findOpenaiCreds(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('creds/:openaiCredsId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.deleteCreds(instance, req.params.openaiCredsId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<OpenaiDto>({\r\n          request: req,\r\n          schema: openaiSchema,\r\n          ClassRef: OpenaiDto,\r\n          execute: (instance, data) => openaiController.createBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.findBot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetch/:openaiBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.fetchBot(instance, req.params.openaiBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .put(this.routerPath('update/:openaiBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<OpenaiDto>({\r\n          request: req,\r\n          schema: openaiSchema,\r\n          ClassRef: OpenaiDto,\r\n          execute: (instance, data) => openaiController.updateBot(instance, req.params.openaiBotId, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete/:openaiBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.deleteBot(instance, req.params.openaiBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('settings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<OpenaiSettingDto>({\r\n          request: req,\r\n          schema: openaiSettingSchema,\r\n          ClassRef: OpenaiSettingDto,\r\n          execute: (instance, data) => openaiController.settings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.fetchSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('changeStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: openaiStatusSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => openaiController.changeStatus(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSessions/:openaiBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.fetchSessions(instance, req.params.openaiBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('ignoreJid'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<IgnoreJidDto>({\r\n          request: req,\r\n          schema: openaiIgnoreJidSchema,\r\n          ClassRef: IgnoreJidDto,\r\n          execute: (instance, data) => openaiController.ignoreJid(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('getModels'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => openaiController.getModels(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { TriggerOperator, TriggerType } from '@prisma/client';\r\n\r\nexport class PrefilledVariables {\r\n  remoteJid?: string;\r\n  pushName?: string;\r\n  messageType?: string;\r\n  additionalData?: { [key: string]: any };\r\n}\r\n\r\nexport class TypebotDto {\r\n  enabled?: boolean;\r\n  description?: string;\r\n  url: string;\r\n  typebot?: string;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  triggerType?: TriggerType;\r\n  triggerOperator?: TriggerOperator;\r\n  triggerValue?: string;\r\n  ignoreJids?: any;\r\n}\r\n\r\nexport class TypebotSettingDto {\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  typebotIdFallback?: string;\r\n  ignoreJids?: any;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { TypebotDto, TypebotSettingDto } from '@api/integrations/chatbot/typebot/dto/typebot.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { typebotController } from '@api/server.module';\r\nimport {\r\n  instanceSchema,\r\n  typebotIgnoreJidSchema,\r\n  typebotSchema,\r\n  typebotSettingSchema,\r\n  typebotStartSchema,\r\n  typebotStatusSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class TypebotRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<TypebotDto>({\r\n          request: req,\r\n          schema: typebotSchema,\r\n          ClassRef: TypebotDto,\r\n          execute: (instance, data) => typebotController.createBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => typebotController.findBot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetch/:typebotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => typebotController.fetchBot(instance, req.params.typebotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .put(this.routerPath('update/:typebotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<TypebotDto>({\r\n          request: req,\r\n          schema: typebotSchema,\r\n          ClassRef: TypebotDto,\r\n          execute: (instance, data) => typebotController.updateBot(instance, req.params.typebotId, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete/:typebotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => typebotController.deleteBot(instance, req.params.typebotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('settings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<TypebotSettingDto>({\r\n          request: req,\r\n          schema: typebotSettingSchema,\r\n          ClassRef: TypebotSettingDto,\r\n          execute: (instance, data) => typebotController.settings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => typebotController.fetchSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('start'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: typebotStartSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => typebotController.startBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('changeStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: typebotStatusSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => typebotController.changeStatus(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSessions/:typebotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => typebotController.fetchSessions(instance, req.params.typebotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('ignoreJid'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<IgnoreJidDto>({\r\n          request: req,\r\n          schema: typebotIgnoreJidSchema,\r\n          ClassRef: IgnoreJidDto,\r\n          execute: (instance, data) => typebotController.ignoreJid(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { ChatwootRouter } from '@api/integrations/chatbot/chatwoot/routes/chatwoot.router';\r\nimport { DifyRouter } from '@api/integrations/chatbot/dify/routes/dify.router';\r\nimport { OpenaiRouter } from '@api/integrations/chatbot/openai/routes/openai.router';\r\nimport { TypebotRouter } from '@api/integrations/chatbot/typebot/routes/typebot.router';\r\nimport { Router } from 'express';\r\n\r\nimport { EvolutionBotRouter } from './evolutionBot/routes/evolutionBot.router';\r\nimport { FlowiseRouter } from './flowise/routes/flowise.router';\r\n\r\nexport class ChatbotRouter {\r\n  public readonly router: Router;\r\n\r\n  constructor(...guards: any[]) {\r\n    this.router = Router();\r\n\r\n    this.router.use('/evolutionBot', new EvolutionBotRouter(...guards).router);\r\n    this.router.use('/chatwoot', new ChatwootRouter(...guards).router);\r\n    this.router.use('/typebot', new TypebotRouter(...guards).router);\r\n    this.router.use('/openai', new OpenaiRouter(...guards).router);\r\n    this.router.use('/dify', new DifyRouter(...guards).router);\r\n    this.router.use('/flowise', new FlowiseRouter(...guards).router);\r\n  }\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { evolutionBotController } from '@api/server.module';\r\nimport { instanceSchema } from '@validate/instance.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { EvolutionBotDto, EvolutionBotSettingDto } from '../dto/evolutionBot.dto';\r\nimport {\r\n  evolutionBotIgnoreJidSchema,\r\n  evolutionBotSchema,\r\n  evolutionBotSettingSchema,\r\n  evolutionBotStatusSchema,\r\n} from '../validate/evolutionBot.schema';\r\n\r\nexport class EvolutionBotRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EvolutionBotDto>({\r\n          request: req,\r\n          schema: evolutionBotSchema,\r\n          ClassRef: EvolutionBotDto,\r\n          execute: (instance, data) => evolutionBotController.createBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => evolutionBotController.findBot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetch/:evolutionBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => evolutionBotController.fetchBot(instance, req.params.evolutionBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .put(this.routerPath('update/:evolutionBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EvolutionBotDto>({\r\n          request: req,\r\n          schema: evolutionBotSchema,\r\n          ClassRef: EvolutionBotDto,\r\n          execute: (instance, data) => evolutionBotController.updateBot(instance, req.params.evolutionBotId, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete/:evolutionBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => evolutionBotController.deleteBot(instance, req.params.evolutionBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('settings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EvolutionBotSettingDto>({\r\n          request: req,\r\n          schema: evolutionBotSettingSchema,\r\n          ClassRef: EvolutionBotSettingDto,\r\n          execute: (instance, data) => evolutionBotController.settings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => evolutionBotController.fetchSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('changeStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: evolutionBotStatusSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => evolutionBotController.changeStatus(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSessions/:evolutionBotId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => evolutionBotController.fetchSessions(instance, req.params.evolutionBotId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('ignoreJid'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<IgnoreJidDto>({\r\n          request: req,\r\n          schema: evolutionBotIgnoreJidSchema,\r\n          ClassRef: IgnoreJidDto,\r\n          execute: (instance, data) => evolutionBotController.ignoreJid(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { TriggerOperator, TriggerType } from '@prisma/client';\r\n\r\nexport class EvolutionBotDto {\r\n  enabled?: boolean;\r\n  description?: string;\r\n  apiUrl?: string;\r\n  apiKey?: string;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  triggerType?: TriggerType;\r\n  triggerOperator?: TriggerOperator;\r\n  triggerValue?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n\r\nexport class EvolutionBotSettingDto {\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  botIdFallback?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { IgnoreJidDto } from '@api/dto/chatbot.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { flowiseController } from '@api/server.module';\r\nimport { instanceSchema } from '@validate/instance.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { FlowiseDto, FlowiseSettingDto } from '../dto/flowise.dto';\r\nimport {\r\n  flowiseIgnoreJidSchema,\r\n  flowiseSchema,\r\n  flowiseSettingSchema,\r\n  flowiseStatusSchema,\r\n} from '../validate/flowise.schema';\r\n\r\nexport class FlowiseRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<FlowiseDto>({\r\n          request: req,\r\n          schema: flowiseSchema,\r\n          ClassRef: FlowiseDto,\r\n          execute: (instance, data) => flowiseController.createBot(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => flowiseController.findBot(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetch/:flowiseId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => flowiseController.fetchBot(instance, req.params.flowiseId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .put(this.routerPath('update/:flowiseId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<FlowiseDto>({\r\n          request: req,\r\n          schema: flowiseSchema,\r\n          ClassRef: FlowiseDto,\r\n          execute: (instance, data) => flowiseController.updateBot(instance, req.params.flowiseId, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete/:flowiseId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => flowiseController.deleteBot(instance, req.params.flowiseId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('settings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<FlowiseSettingDto>({\r\n          request: req,\r\n          schema: flowiseSettingSchema,\r\n          ClassRef: FlowiseSettingDto,\r\n          execute: (instance, data) => flowiseController.settings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => flowiseController.fetchSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('changeStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: flowiseStatusSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance, data) => flowiseController.changeStatus(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchSessions/:flowiseId'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => flowiseController.fetchSessions(instance, req.params.flowiseId),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('ignoreJid'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<IgnoreJidDto>({\r\n          request: req,\r\n          schema: flowiseIgnoreJidSchema,\r\n          ClassRef: IgnoreJidDto,\r\n          execute: (instance, data) => flowiseController.ignoreJid(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { TriggerOperator, TriggerType } from '@prisma/client';\r\n\r\nexport class FlowiseDto {\r\n  enabled?: boolean;\r\n  description?: string;\r\n  apiUrl?: string;\r\n  apiKey?: string;\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  triggerType?: TriggerType;\r\n  triggerOperator?: TriggerOperator;\r\n  triggerValue?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n\r\nexport class FlowiseSettingDto {\r\n  expire?: number;\r\n  keywordFinish?: string;\r\n  delayMessage?: number;\r\n  unknownMessage?: string;\r\n  listeningFromMe?: boolean;\r\n  stopBotFromMe?: boolean;\r\n  keepOpen?: boolean;\r\n  debounceTime?: number;\r\n  flowiseIdFallback?: string;\r\n  ignoreJids?: any;\r\n  splitMessages?: boolean;\r\n  timePerChar?: number;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { EventDto } from '@api/integrations/event/event.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { eventManager } from '@api/server.module';\r\nimport { instanceSchema, pusherSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\nexport class PusherRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EventDto>({\r\n          request: req,\r\n          schema: pusherSchema,\r\n          ClassRef: EventDto,\r\n          execute: (instance, data) => eventManager.pusher.set(instance.instanceName, data),\r\n        });\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => eventManager.pusher.get(instance.instanceName),\r\n        });\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { EventDto } from '@api/integrations/event/event.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { eventManager } from '@api/server.module';\r\nimport { eventSchema, instanceSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class RabbitmqRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EventDto>({\r\n          request: req,\r\n          schema: eventSchema,\r\n          ClassRef: EventDto,\r\n          execute: (instance, data) => eventManager.rabbitmq.set(instance.instanceName, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => eventManager.rabbitmq.get(instance.instanceName),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { EventDto } from '@api/integrations/event/event.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { eventManager } from '@api/server.module';\r\nimport { eventSchema, instanceSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class SqsRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EventDto>({\r\n          request: req,\r\n          schema: eventSchema,\r\n          ClassRef: EventDto,\r\n          execute: (instance, data) => eventManager.sqs.set(instance.instanceName, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => eventManager.sqs.get(instance.instanceName),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { EventDto } from '@api/integrations/event/event.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { eventManager } from '@api/server.module';\r\nimport { ConfigService } from '@config/env.config';\r\nimport { instanceSchema, webhookSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class WebhookRouter extends RouterBroker {\r\n  constructor(\r\n    readonly configService: ConfigService,\r\n    ...guards: RequestHandler[]\r\n  ) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EventDto>({\r\n          request: req,\r\n          schema: webhookSchema,\r\n          ClassRef: EventDto,\r\n          execute: (instance, data) => eventManager.webhook.set(instance.instanceName, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => eventManager.webhook.get(instance.instanceName),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { EventDto } from '@api/integrations/event/event.dto';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { eventManager } from '@api/server.module';\r\nimport { eventSchema, instanceSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class WebsocketRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<EventDto>({\r\n          request: req,\r\n          schema: eventSchema,\r\n          ClassRef: EventDto,\r\n          execute: (instance, data) => eventManager.websocket.set(instance.instanceName, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => eventManager.websocket.get(instance.instanceName),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { PusherRouter } from '@api/integrations/event/pusher/pusher.router';\r\nimport { RabbitmqRouter } from '@api/integrations/event/rabbitmq/rabbitmq.router';\r\nimport { SqsRouter } from '@api/integrations/event/sqs/sqs.router';\r\nimport { WebhookRouter } from '@api/integrations/event/webhook/webhook.router';\r\nimport { WebsocketRouter } from '@api/integrations/event/websocket/websocket.router';\r\nimport { Router } from 'express';\r\n\r\nexport class EventRouter {\r\n  public readonly router: Router;\r\n\r\n  constructor(configService: any, ...guards: any[]) {\r\n    this.router = Router();\r\n\r\n    this.router.use('/webhook', new WebhookRouter(configService, ...guards).router);\r\n    this.router.use('/websocket', new WebsocketRouter(...guards).router);\r\n    this.router.use('/rabbitmq', new RabbitmqRouter(...guards).router);\r\n    this.router.use('/pusher', new PusherRouter(...guards).router);\r\n    this.router.use('/sqs', new SqsRouter(...guards).router);\r\n  }\r\n}\r\n","import { S3Router } from '@api/integrations/storage/s3/routes/s3.router';\r\nimport { Router } from 'express';\r\n\r\nexport class StorageRouter {\r\n  public readonly router: Router;\r\n\r\n  constructor(...guards: any[]) {\r\n    this.router = Router();\r\n\r\n    this.router.use('/s3', new S3Router(...guards).router);\r\n  }\r\n}\r\n","import { authGuard } from '@api/guards/auth.guard';\r\nimport { instanceExistsGuard, instanceLoggedGuard } from '@api/guards/instance.guard';\r\nimport Telemetry from '@api/guards/telemetry.guard';\r\nimport { ChannelRouter } from '@api/integrations/channel/channel.router';\r\nimport { ChatbotRouter } from '@api/integrations/chatbot/chatbot.router';\r\nimport { EventRouter } from '@api/integrations/event/event.router';\r\nimport { StorageRouter } from '@api/integrations/storage/storage.router';\r\nimport { configService } from '@config/env.config';\r\nimport { Router } from 'express';\r\nimport fs from 'fs';\r\nimport mimeTypes from 'mime-types';\r\nimport path from 'path';\r\n\r\nimport { CallRouter } from './call.router';\r\nimport { ChatRouter } from './chat.router';\r\nimport { GroupRouter } from './group.router';\r\nimport { InstanceRouter } from './instance.router';\r\nimport { LabelRouter } from './label.router';\r\nimport { ProxyRouter } from './proxy.router';\r\nimport { MessageRouter } from './sendMessage.router';\r\nimport { SettingsRouter } from './settings.router';\r\nimport { TemplateRouter } from './template.router';\r\nimport { ViewsRouter } from './view.router';\r\n\r\nenum HttpStatus {\r\n  OK = 200,\r\n  CREATED = 201,\r\n  NOT_FOUND = 404,\r\n  FORBIDDEN = 403,\r\n  BAD_REQUEST = 400,\r\n  UNAUTHORIZED = 401,\r\n  INTERNAL_SERVER_ERROR = 500,\r\n}\r\n\r\nconst router: Router = Router();\r\nconst serverConfig = configService.get('SERVER');\r\nconst guards = [instanceExistsGuard, instanceLoggedGuard, authGuard['apikey']];\r\n\r\nconst telemetry = new Telemetry();\r\n\r\nconst packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));\r\n\r\nif (!serverConfig.DISABLE_MANAGER) router.use('/manager', new ViewsRouter().router);\r\n\r\nrouter.get('/assets/*', (req, res) => {\r\n  const fileName = req.params[0];\r\n  const basePath = path.join(process.cwd(), 'manager', 'dist');\r\n\r\n  const filePath = path.join(basePath, 'assets/', fileName);\r\n\r\n  if (fs.existsSync(filePath)) {\r\n    res.set('Content-Type', mimeTypes.lookup(filePath) || 'text/css');\r\n    res.send(fs.readFileSync(filePath));\r\n  } else {\r\n    res.status(404).send('File not found');\r\n  }\r\n});\r\n\r\nrouter\r\n  .use((req, res, next) => telemetry.collectTelemetry(req, res, next))\r\n\r\n  .get('/', (req, res) => {\r\n    res.status(HttpStatus.OK).json({\r\n      status: HttpStatus.OK,\r\n      message: 'Welcome to the Evolution API, it is working!',\r\n      version: packageJson.version,\r\n      clientName: process.env.DATABASE_CONNECTION_CLIENT_NAME,\r\n      manager: !serverConfig.DISABLE_MANAGER ? `${req.protocol}://${req.get('host')}/manager` : undefined,\r\n      documentation: `https://doc.evolution-api.com`,\r\n    });\r\n  })\r\n  .post('/verify-creds', authGuard['apikey'], async (req, res) => {\r\n    return res.status(HttpStatus.OK).json({\r\n      status: HttpStatus.OK,\r\n      message: 'Credentials are valid',\r\n      facebookAppId: process.env.FACEBOOK_APP_ID,\r\n      facebookConfigId: process.env.FACEBOOK_CONFIG_ID,\r\n      facebookUserToken: process.env.FACEBOOK_USER_TOKEN,\r\n    });\r\n  })\r\n  .use('/instance', new InstanceRouter(configService, ...guards).router)\r\n  .use('/message', new MessageRouter(...guards).router)\r\n  .use('/call', new CallRouter(...guards).router)\r\n  .use('/chat', new ChatRouter(...guards).router)\r\n  .use('/group', new GroupRouter(...guards).router)\r\n  .use('/template', new TemplateRouter(configService, ...guards).router)\r\n  .use('/settings', new SettingsRouter(...guards).router)\r\n  .use('/proxy', new ProxyRouter(...guards).router)\r\n  .use('/label', new LabelRouter(...guards).router)\r\n  .use('', new ChannelRouter(configService, ...guards).router)\r\n  .use('', new EventRouter(configService, ...guards).router)\r\n  .use('', new ChatbotRouter(...guards).router)\r\n  .use('', new StorageRouter(...guards).router);\r\n\r\nexport { HttpStatus, router };\r\n","export class Metadata {\r\n  number: string;\r\n}\r\n\r\nexport class OfferCallDto extends Metadata {\r\n  isVideo?: boolean;\r\n  callDuration?: number;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { OfferCallDto } from '@api/dto/call.dto';\r\nimport { callController } from '@api/server.module';\r\nimport { offerCallSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class CallRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router.post(this.routerPath('offer'), ...guards, async (req, res) => {\r\n      const response = await this.dataValidate<OfferCallDto>({\r\n        request: req,\r\n        schema: offerCallSchema,\r\n        ClassRef: OfferCallDto,\r\n        execute: (instance, data) => callController.offerCall(instance, data),\r\n      });\r\n\r\n      return res.status(HttpStatus.CREATED).json(response);\r\n    });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport {\r\n  ArchiveChatDto,\r\n  BlockUserDto,\r\n  DeleteMessage,\r\n  getBase64FromMediaMessageDto,\r\n  MarkChatUnreadDto,\r\n  NumberDto,\r\n  PrivacySettingDto,\r\n  ProfileNameDto,\r\n  ProfilePictureDto,\r\n  ProfileStatusDto,\r\n  ReadMessageDto,\r\n  SendPresenceDto,\r\n  UpdateMessageDto,\r\n  WhatsAppNumberDto,\r\n} from '@api/dto/chat.dto';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { Query } from '@api/repository/repository.service';\r\nimport { chatController } from '@api/server.module';\r\nimport { Contact, Message, MessageUpdate } from '@prisma/client';\r\nimport {\r\n  archiveChatSchema,\r\n  blockUserSchema,\r\n  contactValidateSchema,\r\n  deleteMessageSchema,\r\n  markChatUnreadSchema,\r\n  messageUpSchema,\r\n  messageValidateSchema,\r\n  presenceSchema,\r\n  privacySettingsSchema,\r\n  profileNameSchema,\r\n  profilePictureSchema,\r\n  profileSchema,\r\n  profileStatusSchema,\r\n  readMessageSchema,\r\n  updateMessageSchema,\r\n  whatsappNumberSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class ChatRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('whatsappNumbers'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<WhatsAppNumberDto>({\r\n          request: req,\r\n          schema: whatsappNumberSchema,\r\n          ClassRef: WhatsAppNumberDto,\r\n          execute: (instance, data) => chatController.whatsappNumber(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('markMessageAsRead'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ReadMessageDto>({\r\n          request: req,\r\n          schema: readMessageSchema,\r\n          ClassRef: ReadMessageDto,\r\n          execute: (instance, data) => chatController.readMessage(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('archiveChat'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ArchiveChatDto>({\r\n          request: req,\r\n          schema: archiveChatSchema,\r\n          ClassRef: ArchiveChatDto,\r\n          execute: (instance, data) => chatController.archiveChat(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('markChatUnread'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<MarkChatUnreadDto>({\r\n          request: req,\r\n          schema: markChatUnreadSchema,\r\n          ClassRef: MarkChatUnreadDto,\r\n          execute: (instance, data) => chatController.markChatUnread(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .delete(this.routerPath('deleteMessageForEveryone'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<DeleteMessage>({\r\n          request: req,\r\n          schema: deleteMessageSchema,\r\n          ClassRef: DeleteMessage,\r\n          execute: (instance, data) => chatController.deleteMessage(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('fetchProfilePictureUrl'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<NumberDto>({\r\n          request: req,\r\n          schema: profilePictureSchema,\r\n          ClassRef: NumberDto,\r\n          execute: (instance, data) => chatController.fetchProfilePicture(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('getBase64FromMediaMessage'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<getBase64FromMediaMessageDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: getBase64FromMediaMessageDto,\r\n          execute: (instance, data) => chatController.getBase64FromMediaMessage(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      // TODO: corrigir updateMessage para medias tambem\r\n      .post(this.routerPath('updateMessage'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<UpdateMessageDto>({\r\n          request: req,\r\n          schema: updateMessageSchema,\r\n          ClassRef: UpdateMessageDto,\r\n          execute: (instance, data) => chatController.updateMessage(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('sendPresence'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<null>({\r\n          request: req,\r\n          schema: presenceSchema,\r\n          ClassRef: SendPresenceDto,\r\n          execute: (instance, data) => chatController.sendPresence(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateBlockStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<BlockUserDto>({\r\n          request: req,\r\n          schema: blockUserSchema,\r\n          ClassRef: BlockUserDto,\r\n          execute: (instance, data) => chatController.blockUser(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('findContacts'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<Query<Contact>>({\r\n          request: req,\r\n          schema: contactValidateSchema,\r\n          ClassRef: Query<Contact>,\r\n          execute: (instance, data) => chatController.fetchContacts(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('findMessages'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<Query<Message>>({\r\n          request: req,\r\n          schema: messageValidateSchema,\r\n          ClassRef: Query<Message>,\r\n          execute: (instance, data) => chatController.fetchMessages(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('findStatusMessage'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<Query<MessageUpdate>>({\r\n          request: req,\r\n          schema: messageUpSchema,\r\n          ClassRef: Query<MessageUpdate>,\r\n          execute: (instance, data) => chatController.fetchStatusMessage(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('findChats'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<Query<Contact>>({\r\n          request: req,\r\n          schema: contactValidateSchema,\r\n          ClassRef: Query<Contact>,\r\n          execute: (instance, data) => chatController.fetchChats(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      // Profile routes\r\n      .post(this.routerPath('fetchBusinessProfile'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProfilePictureDto>({\r\n          request: req,\r\n          schema: profilePictureSchema,\r\n          ClassRef: ProfilePictureDto,\r\n          execute: (instance, data) => chatController.fetchBusinessProfile(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('fetchProfile'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<NumberDto>({\r\n          request: req,\r\n          schema: profileSchema,\r\n          ClassRef: NumberDto,\r\n          execute: (instance, data) => chatController.fetchProfile(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n\r\n      .post(this.routerPath('updateProfileName'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProfileNameDto>({\r\n          request: req,\r\n          schema: profileNameSchema,\r\n          ClassRef: ProfileNameDto,\r\n          execute: (instance, data) => chatController.updateProfileName(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('updateProfileStatus'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProfileStatusDto>({\r\n          request: req,\r\n          schema: profileStatusSchema,\r\n          ClassRef: ProfileStatusDto,\r\n          execute: (instance, data) => chatController.updateProfileStatus(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('updateProfilePicture'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProfilePictureDto>({\r\n          request: req,\r\n          schema: profilePictureSchema,\r\n          ClassRef: ProfilePictureDto,\r\n          execute: (instance, data) => chatController.updateProfilePicture(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('removeProfilePicture'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProfilePictureDto>({\r\n          request: req,\r\n          schema: profilePictureSchema,\r\n          ClassRef: ProfilePictureDto,\r\n          execute: (instance) => chatController.removeProfilePicture(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchPrivacySettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => chatController.fetchPrivacySettings(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('updatePrivacySettings'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<PrivacySettingDto>({\r\n          request: req,\r\n          schema: privacySettingsSchema,\r\n          ClassRef: PrivacySettingDto,\r\n          execute: (instance, data) => chatController.updatePrivacySettings(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class CreateGroupDto {\r\n  subject: string;\r\n  participants: string[];\r\n  description?: string;\r\n  promoteParticipants?: boolean;\r\n}\r\n\r\nexport class GroupPictureDto {\r\n  groupJid: string;\r\n  image: string;\r\n}\r\n\r\nexport class GroupSubjectDto {\r\n  groupJid: string;\r\n  subject: string;\r\n}\r\n\r\nexport class GroupDescriptionDto {\r\n  groupJid: string;\r\n  description: string;\r\n}\r\n\r\nexport class GroupJid {\r\n  groupJid: string;\r\n}\r\n\r\nexport class GetParticipant {\r\n  getParticipants: string;\r\n}\r\n\r\nexport class GroupInvite {\r\n  inviteCode: string;\r\n}\r\n\r\nexport class AcceptGroupInvite {\r\n  inviteCode: string;\r\n}\r\n\r\nexport class GroupSendInvite {\r\n  groupJid: string;\r\n  description: string;\r\n  numbers: string[];\r\n}\r\n\r\nexport class GroupUpdateParticipantDto extends GroupJid {\r\n  action: 'add' | 'remove' | 'promote' | 'demote';\r\n  participants: string[];\r\n}\r\n\r\nexport class GroupUpdateSettingDto extends GroupJid {\r\n  action: 'announcement' | 'not_announcement' | 'unlocked' | 'locked';\r\n}\r\n\r\nexport class GroupToggleEphemeralDto extends GroupJid {\r\n  expiration: 0 | 86400 | 604800 | 7776000;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport {\r\n  AcceptGroupInvite,\r\n  CreateGroupDto,\r\n  GetParticipant,\r\n  GroupDescriptionDto,\r\n  GroupInvite,\r\n  GroupJid,\r\n  GroupPictureDto,\r\n  GroupSendInvite,\r\n  GroupSubjectDto,\r\n  GroupToggleEphemeralDto,\r\n  GroupUpdateParticipantDto,\r\n  GroupUpdateSettingDto,\r\n} from '@api/dto/group.dto';\r\nimport { groupController } from '@api/server.module';\r\nimport {\r\n  AcceptGroupInviteSchema,\r\n  createGroupSchema,\r\n  getParticipantsSchema,\r\n  groupInviteSchema,\r\n  groupJidSchema,\r\n  groupSendInviteSchema,\r\n  toggleEphemeralSchema,\r\n  updateGroupDescriptionSchema,\r\n  updateGroupPictureSchema,\r\n  updateGroupSubjectSchema,\r\n  updateParticipantsSchema,\r\n  updateSettingsSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class GroupRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<CreateGroupDto>({\r\n          request: req,\r\n          schema: createGroupSchema,\r\n          ClassRef: CreateGroupDto,\r\n          execute: (instance, data) => groupController.createGroup(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateGroupSubject'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupSubjectDto>({\r\n          request: req,\r\n          schema: updateGroupSubjectSchema,\r\n          ClassRef: GroupSubjectDto,\r\n          execute: (instance, data) => groupController.updateGroupSubject(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateGroupPicture'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupPictureDto>({\r\n          request: req,\r\n          schema: updateGroupPictureSchema,\r\n          ClassRef: GroupPictureDto,\r\n          execute: (instance, data) => groupController.updateGroupPicture(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateGroupDescription'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupDescriptionDto>({\r\n          request: req,\r\n          schema: updateGroupDescriptionSchema,\r\n          ClassRef: GroupDescriptionDto,\r\n          execute: (instance, data) => groupController.updateGroupDescription(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('findGroupInfos'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupJid>({\r\n          request: req,\r\n          schema: groupJidSchema,\r\n          ClassRef: GroupJid,\r\n          execute: (instance, data) => groupController.findGroupInfo(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchAllGroups'), ...guards, async (req, res) => {\r\n        const response = await this.getParticipantsValidate<GetParticipant>({\r\n          request: req,\r\n          schema: getParticipantsSchema,\r\n          ClassRef: GetParticipant,\r\n          execute: (instance, data) => groupController.fetchAllGroups(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('participants'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupJid>({\r\n          request: req,\r\n          schema: groupJidSchema,\r\n          ClassRef: GroupJid,\r\n          execute: (instance, data) => groupController.findParticipants(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('inviteCode'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupJid>({\r\n          request: req,\r\n          schema: groupJidSchema,\r\n          ClassRef: GroupJid,\r\n          execute: (instance, data) => groupController.inviteCode(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('inviteInfo'), ...guards, async (req, res) => {\r\n        const response = await this.inviteCodeValidate<GroupInvite>({\r\n          request: req,\r\n          schema: groupInviteSchema,\r\n          ClassRef: GroupInvite,\r\n          execute: (instance, data) => groupController.inviteInfo(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('acceptInviteCode'), ...guards, async (req, res) => {\r\n        const response = await this.inviteCodeValidate<AcceptGroupInvite>({\r\n          request: req,\r\n          schema: AcceptGroupInviteSchema,\r\n          ClassRef: AcceptGroupInvite,\r\n          execute: (instance, data) => groupController.acceptInviteCode(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('sendInvite'), ...guards, async (req, res) => {\r\n        const response = await this.groupNoValidate<GroupSendInvite>({\r\n          request: req,\r\n          schema: groupSendInviteSchema,\r\n          ClassRef: GroupSendInvite,\r\n          execute: (instance, data) => groupController.sendInvite(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('revokeInviteCode'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupJid>({\r\n          request: req,\r\n          schema: groupJidSchema,\r\n          ClassRef: GroupJid,\r\n          execute: (instance, data) => groupController.revokeInviteCode(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateParticipant'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupUpdateParticipantDto>({\r\n          request: req,\r\n          schema: updateParticipantsSchema,\r\n          ClassRef: GroupUpdateParticipantDto,\r\n          execute: (instance, data) => groupController.updateGParticipate(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('updateSetting'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupUpdateSettingDto>({\r\n          request: req,\r\n          schema: updateSettingsSchema,\r\n          ClassRef: GroupUpdateSettingDto,\r\n          execute: (instance, data) => groupController.updateGSetting(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('toggleEphemeral'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupToggleEphemeralDto>({\r\n          request: req,\r\n          schema: toggleEphemeralSchema,\r\n          ClassRef: GroupToggleEphemeralDto,\r\n          execute: (instance, data) => groupController.toggleEphemeral(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .delete(this.routerPath('leaveGroup'), ...guards, async (req, res) => {\r\n        const response = await this.groupValidate<GroupJid>({\r\n          request: req,\r\n          schema: {},\r\n          ClassRef: GroupJid,\r\n          execute: (instance, data) => groupController.leaveGroup(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto, SetPresenceDto } from '@api/dto/instance.dto';\r\nimport { instanceController } from '@api/server.module';\r\nimport { ConfigService } from '@config/env.config';\r\nimport { instanceSchema, presenceOnlySchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class InstanceRouter extends RouterBroker {\r\n  constructor(\r\n    readonly configService: ConfigService,\r\n    ...guards: RequestHandler[]\r\n  ) {\r\n    super();\r\n    this.router\r\n      .post('/create', ...guards, async (req, res) => {\r\n        console.log('create instance', req.body);\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.createInstance(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('restart'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.restartInstance(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('connect'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.connectToWhatsapp(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('connectionState'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.connectionState(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .get(this.routerPath('fetchInstances', false), ...guards, async (req, res) => {\r\n        const key = req.get('apikey');\r\n\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.fetchInstances(instance, key),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('setPresence'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<null>({\r\n          request: req,\r\n          schema: presenceOnlySchema,\r\n          ClassRef: SetPresenceDto,\r\n          execute: (instance, data) => instanceController.setPresence(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .delete(this.routerPath('logout'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.logout(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .delete(this.routerPath('delete'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => instanceController.deleteInstance(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class LabelDto {\r\n  id?: string;\r\n  name: string;\r\n  color: string;\r\n  predefinedId?: string;\r\n}\r\n\r\nexport class HandleLabelDto {\r\n  number: string;\r\n  labelId: string;\r\n  action: 'add' | 'remove';\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { HandleLabelDto, LabelDto } from '@api/dto/label.dto';\r\nimport { labelController } from '@api/server.module';\r\nimport { handleLabelSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class LabelRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .get(this.routerPath('findLabels'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<LabelDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: LabelDto,\r\n          execute: (instance) => labelController.fetchLabels(instance),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      })\r\n      .post(this.routerPath('handleLabel'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<HandleLabelDto>({\r\n          request: req,\r\n          schema: handleLabelSchema,\r\n          ClassRef: HandleLabelDto,\r\n          execute: (instance, data) => labelController.handleLabel(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class ProxyDto {\r\n  enabled?: boolean;\r\n  host: string;\r\n  port: string;\r\n  protocol: string;\r\n  username?: string;\r\n  password?: string;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { ProxyDto } from '@api/dto/proxy.dto';\r\nimport { proxyController } from '@api/server.module';\r\nimport { instanceSchema, proxySchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class ProxyRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<ProxyDto>({\r\n          request: req,\r\n          schema: proxySchema,\r\n          ClassRef: ProxyDto,\r\n          execute: (instance, data) => proxyController.createProxy(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => proxyController.findProxy(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { proto, WAPresence } from 'baileys';\r\n\r\nexport class Quoted {\r\n  key: proto.IMessageKey;\r\n  message: proto.IMessage;\r\n}\r\n\r\nexport class Options {\r\n  delay?: number;\r\n  presence?: WAPresence;\r\n  quoted?: Quoted;\r\n  linkPreview?: boolean;\r\n  encoding?: boolean;\r\n  mentionsEveryOne?: boolean;\r\n  mentioned?: string[];\r\n  webhookUrl?: string;\r\n}\r\n\r\nexport class MediaMessage {\r\n  mediatype: MediaType;\r\n  mimetype?: string;\r\n  caption?: string;\r\n  // for document\r\n  fileName?: string;\r\n  // url or base64\r\n  media: string;\r\n}\r\n\r\nexport class StatusMessage {\r\n  type: string;\r\n  content: string;\r\n  statusJidList?: string[];\r\n  allContacts?: boolean;\r\n  caption?: string;\r\n  backgroundColor?: string;\r\n  font?: number;\r\n}\r\n\r\nexport class Metadata {\r\n  number: string;\r\n  delay?: number;\r\n  quoted?: Quoted;\r\n  linkPreview?: boolean;\r\n  mentionsEveryOne?: boolean;\r\n  mentioned?: string[];\r\n  encoding?: boolean;\r\n}\r\n\r\nexport class SendTextDto extends Metadata {\r\n  text: string;\r\n}\r\nexport class SendPresence extends Metadata {\r\n  text: string;\r\n}\r\n\r\nexport class SendStatusDto extends Metadata {\r\n  type: string;\r\n  content: string;\r\n  statusJidList?: string[];\r\n  allContacts?: boolean;\r\n  caption?: string;\r\n  backgroundColor?: string;\r\n  font?: number;\r\n}\r\n\r\nexport class SendPollDto extends Metadata {\r\n  name: string;\r\n  selectableCount: number;\r\n  values: string[];\r\n  messageSecret?: Uint8Array;\r\n}\r\n\r\nexport type MediaType = 'image' | 'document' | 'video' | 'audio' | 'ptv';\r\n\r\nexport class SendMediaDto extends Metadata {\r\n  mediatype: MediaType;\r\n  mimetype?: string;\r\n  caption?: string;\r\n  // for document\r\n  fileName?: string;\r\n  // url or base64\r\n  media: string;\r\n}\r\n\r\nexport class SendPtvDto extends Metadata {\r\n  video: string;\r\n}\r\n\r\nexport class SendStickerDto extends Metadata {\r\n  sticker: string;\r\n}\r\n\r\nexport class SendAudioDto extends Metadata {\r\n  audio: string;\r\n}\r\n\r\nexport type TypeButton = 'reply' | 'copy' | 'url' | 'call' | 'pix';\r\n\r\nexport type KeyType = 'phone' | 'email' | 'cpf' | 'cnpj' | 'random';\r\n\r\nexport class Button {\r\n  type: TypeButton;\r\n  displayText?: string;\r\n  id?: string;\r\n  url?: string;\r\n  copyCode?: string;\r\n  phoneNumber?: string;\r\n  currency?: string;\r\n  name?: string;\r\n  keyType?: KeyType;\r\n  key?: string;\r\n}\r\n\r\nexport class SendButtonsDto extends Metadata {\r\n  thumbnailUrl?: string;\r\n  title: string;\r\n  description?: string;\r\n  footer?: string;\r\n  buttons: Button[];\r\n}\r\n\r\nexport class SendLocationDto extends Metadata {\r\n  latitude: number;\r\n  longitude: number;\r\n  name?: string;\r\n  address?: string;\r\n}\r\n\r\nclass Row {\r\n  title: string;\r\n  description: string;\r\n  rowId: string;\r\n}\r\nclass Section {\r\n  title: string;\r\n  rows: Row[];\r\n}\r\nexport class SendListDto extends Metadata {\r\n  title: string;\r\n  description?: string;\r\n  footerText?: string;\r\n  buttonText: string;\r\n  sections: Section[];\r\n}\r\n\r\nexport class ContactMessage {\r\n  fullName: string;\r\n  wuid: string;\r\n  phoneNumber: string;\r\n  organization?: string;\r\n  email?: string;\r\n  url?: string;\r\n}\r\n\r\nexport class SendTemplateDto extends Metadata {\r\n  name: string;\r\n  language: string;\r\n  components: any;\r\n  webhookUrl?: string;\r\n}\r\nexport class SendContactDto extends Metadata {\r\n  contact: ContactMessage[];\r\n}\r\n\r\nexport class SendReactionDto {\r\n  key: proto.IMessageKey;\r\n  reaction: string;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport {\r\n  SendAudioDto,\r\n  SendButtonsDto,\r\n  SendContactDto,\r\n  SendListDto,\r\n  SendLocationDto,\r\n  SendMediaDto,\r\n  SendPollDto,\r\n  SendPtvDto,\r\n  SendReactionDto,\r\n  SendStatusDto,\r\n  SendStickerDto,\r\n  SendTemplateDto,\r\n  SendTextDto,\r\n} from '@api/dto/sendMessage.dto';\r\nimport { sendMessageController } from '@api/server.module';\r\nimport {\r\n  audioMessageSchema,\r\n  buttonsMessageSchema,\r\n  contactMessageSchema,\r\n  listMessageSchema,\r\n  locationMessageSchema,\r\n  mediaMessageSchema,\r\n  pollMessageSchema,\r\n  ptvMessageSchema,\r\n  reactionMessageSchema,\r\n  statusMessageSchema,\r\n  stickerMessageSchema,\r\n  templateMessageSchema,\r\n  textMessageSchema,\r\n} from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\nimport multer from 'multer';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nconst upload = multer({ storage: multer.memoryStorage() });\r\n\r\nexport class MessageRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('sendTemplate'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendTemplateDto>({\r\n          request: req,\r\n          schema: templateMessageSchema,\r\n          ClassRef: SendTemplateDto,\r\n          execute: (instance, data) => sendMessageController.sendTemplate(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendText'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendTextDto>({\r\n          request: req,\r\n          schema: textMessageSchema,\r\n          ClassRef: SendTextDto,\r\n          execute: (instance, data) => sendMessageController.sendText(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendMedia'), ...guards, upload.single('file'), async (req, res) => {\r\n        const bodyData = req.body;\r\n\r\n        const response = await this.dataValidate<SendMediaDto>({\r\n          request: req,\r\n          schema: mediaMessageSchema,\r\n          ClassRef: SendMediaDto,\r\n          execute: (instance) => sendMessageController.sendMedia(instance, bodyData, req.file as any),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendPtv'), ...guards, upload.single('file'), async (req, res) => {\r\n        const bodyData = req.body;\r\n\r\n        const response = await this.dataValidate<SendPtvDto>({\r\n          request: req,\r\n          schema: ptvMessageSchema,\r\n          ClassRef: SendPtvDto,\r\n          execute: (instance) => sendMessageController.sendPtv(instance, bodyData, req.file as any),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendWhatsAppAudio'), ...guards, upload.single('file'), async (req, res) => {\r\n        const bodyData = req.body;\r\n\r\n        const response = await this.dataValidate<SendAudioDto>({\r\n          request: req,\r\n          schema: audioMessageSchema,\r\n          ClassRef: SendMediaDto,\r\n          execute: (instance) => sendMessageController.sendWhatsAppAudio(instance, bodyData, req.file as any),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      // TODO: Revisar funcionamento do envio de Status\r\n      .post(this.routerPath('sendStatus'), ...guards, upload.single('file'), async (req, res) => {\r\n        const bodyData = req.body;\r\n\r\n        const response = await this.dataValidate<SendStatusDto>({\r\n          request: req,\r\n          schema: statusMessageSchema,\r\n          ClassRef: SendStatusDto,\r\n          execute: (instance) => sendMessageController.sendStatus(instance, bodyData, req.file as any),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendSticker'), ...guards, upload.single('file'), async (req, res) => {\r\n        const bodyData = req.body;\r\n\r\n        const response = await this.dataValidate<SendStickerDto>({\r\n          request: req,\r\n          schema: stickerMessageSchema,\r\n          ClassRef: SendStickerDto,\r\n          execute: (instance) => sendMessageController.sendSticker(instance, bodyData, req.file as any),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendLocation'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendLocationDto>({\r\n          request: req,\r\n          schema: locationMessageSchema,\r\n          ClassRef: SendLocationDto,\r\n          execute: (instance, data) => sendMessageController.sendLocation(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendContact'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendContactDto>({\r\n          request: req,\r\n          schema: contactMessageSchema,\r\n          ClassRef: SendContactDto,\r\n          execute: (instance, data) => sendMessageController.sendContact(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendReaction'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendReactionDto>({\r\n          request: req,\r\n          schema: reactionMessageSchema,\r\n          ClassRef: SendReactionDto,\r\n          execute: (instance, data) => sendMessageController.sendReaction(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendPoll'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendPollDto>({\r\n          request: req,\r\n          schema: pollMessageSchema,\r\n          ClassRef: SendPollDto,\r\n          execute: (instance, data) => sendMessageController.sendPoll(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendList'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendListDto>({\r\n          request: req,\r\n          schema: listMessageSchema,\r\n          ClassRef: SendListDto,\r\n          execute: (instance, data) => sendMessageController.sendList(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('sendButtons'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SendButtonsDto>({\r\n          request: req,\r\n          schema: buttonsMessageSchema,\r\n          ClassRef: SendButtonsDto,\r\n          execute: (instance, data) => sendMessageController.sendButtons(instance, data),\r\n        });\r\n\r\n        return res.status(HttpStatus.CREATED).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class SettingsDto {\r\n  rejectCall?: boolean;\r\n  msgCall?: string;\r\n  groupsIgnore?: boolean;\r\n  alwaysOnline?: boolean;\r\n  readMessages?: boolean;\r\n  readStatus?: boolean;\r\n  syncFullHistory?: boolean;\r\n  wavoipToken?: string;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { SettingsDto } from '@api/dto/settings.dto';\r\nimport { settingsController } from '@api/server.module';\r\nimport { settingsSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class SettingsRouter extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('set'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<SettingsDto>({\r\n          request: req,\r\n          schema: settingsSchema,\r\n          ClassRef: SettingsDto,\r\n          execute: (instance, data) => settingsController.createSettings(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: null,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => settingsController.findSettings(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","export class TemplateDto {\r\n  name: string;\r\n  category: string;\r\n  allowCategoryChange: boolean;\r\n  language: string;\r\n  components: any;\r\n  webhookUrl?: string;\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { InstanceDto } from '@api/dto/instance.dto';\r\nimport { TemplateDto } from '@api/dto/template.dto';\r\nimport { templateController } from '@api/server.module';\r\nimport { ConfigService } from '@config/env.config';\r\nimport { instanceSchema, templateSchema } from '@validate/validate.schema';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nimport { HttpStatus } from './index.router';\r\n\r\nexport class TemplateRouter extends RouterBroker {\r\n  constructor(\r\n    readonly configService: ConfigService,\r\n    ...guards: RequestHandler[]\r\n  ) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('create'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<TemplateDto>({\r\n          request: req,\r\n          schema: templateSchema,\r\n          ClassRef: TemplateDto,\r\n          execute: (instance, data) => templateController.createTemplate(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .get(this.routerPath('find'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<InstanceDto>({\r\n          request: req,\r\n          schema: instanceSchema,\r\n          ClassRef: InstanceDto,\r\n          execute: (instance) => templateController.findTemplate(instance),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport express, { Router } from 'express';\r\nimport path from 'path';\r\n\r\nexport class ViewsRouter extends RouterBroker {\r\n  public readonly router: Router;\r\n\r\n  constructor() {\r\n    super();\r\n    this.router = Router();\r\n\r\n    const basePath = path.join(process.cwd(), 'manager', 'dist');\r\n    const indexPath = path.join(basePath, 'index.html');\r\n\r\n    this.router.use(express.static(basePath));\r\n\r\n    this.router.get('*', (req, res) => {\r\n      res.sendFile(indexPath);\r\n    });\r\n  }\r\n}\r\n","import { HttpStatus } from '@api/routes/index.router';\r\n\r\nexport class BadRequestException {\r\n  constructor(...objectError: any[]) {\r\n    throw {\r\n      status: HttpStatus.BAD_REQUEST,\r\n      error: 'Bad Request',\r\n      message: objectError.length > 0 ? objectError : undefined,\r\n    };\r\n  }\r\n}\r\n","import { HttpStatus } from '@api/routes/index.router';\r\n\r\nexport class UnauthorizedException {\r\n  constructor(...objectError: any[]) {\r\n    throw {\r\n      status: HttpStatus.UNAUTHORIZED,\r\n      error: 'Unauthorized',\r\n      message: objectError.length > 0 ? objectError : 'Unauthorized',\r\n    };\r\n  }\r\n}\r\n","import { HttpStatus } from '@api/routes/index.router';\r\n\r\nexport class ForbiddenException {\r\n  constructor(...objectError: any[]) {\r\n    throw {\r\n      status: HttpStatus.FORBIDDEN,\r\n      error: 'Forbidden',\r\n      message: objectError.length > 0 ? objectError : undefined,\r\n    };\r\n  }\r\n}\r\n","import { HttpStatus } from '@api/routes/index.router';\r\n\r\nexport class NotFoundException {\r\n  constructor(...objectError: any[]) {\r\n    throw {\r\n      status: HttpStatus.NOT_FOUND,\r\n      error: 'Not Found',\r\n      message: objectError.length > 0 ? objectError : undefined,\r\n    };\r\n  }\r\n}\r\n","import { HttpStatus } from '@api/routes/index.router';\r\n\r\nexport class InternalServerErrorException {\r\n  constructor(...objectError: any[]) {\r\n    throw {\r\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\r\n      error: 'Internal Server Error',\r\n      message: objectError.length > 0 ? objectError : undefined,\r\n    };\r\n  }\r\n}\r\n","export class MediaDto {\r\n  id?: string;\r\n  type?: string;\r\n  messageId?: number;\r\n  expiry?: number;\r\n}\r\n","import { JSONSchema7 } from 'json-schema';\r\nimport { v4 } from 'uuid';\r\n\r\nconst isNotEmpty = (...propertyNames: string[]): JSONSchema7 => {\r\n  const properties = {};\r\n  propertyNames.forEach(\r\n    (property) =>\r\n      (properties[property] = {\r\n        minLength: 1,\r\n        description: `The \"${property}\" cannot be empty`,\r\n      }),\r\n  );\r\n  return {\r\n    if: {\r\n      propertyNames: {\r\n        enum: [...propertyNames],\r\n      },\r\n    },\r\n    then: { properties },\r\n  };\r\n};\r\n\r\nexport const s3Schema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    id: { type: 'string' },\r\n    type: { type: 'string' },\r\n    messageId: { type: 'integer' },\r\n  },\r\n  ...isNotEmpty('id', 'type', 'messageId'),\r\n};\r\n\r\nexport const s3UrlSchema: JSONSchema7 = {\r\n  $id: v4(),\r\n  type: 'object',\r\n  properties: {\r\n    id: { type: 'string', pattern: '\\\\d+', minLength: 1 },\r\n    expiry: { type: 'string', pattern: '\\\\d+', minLength: 1 },\r\n  },\r\n  ...isNotEmpty('id'),\r\n  required: ['id'],\r\n};\r\n","import { RouterBroker } from '@api/abstract/abstract.router';\r\nimport { MediaDto } from '@api/integrations/storage/s3/dto/media.dto';\r\nimport { s3Schema, s3UrlSchema } from '@api/integrations/storage/s3/validate/s3.schema';\r\nimport { HttpStatus } from '@api/routes/index.router';\r\nimport { s3Controller } from '@api/server.module';\r\nimport { RequestHandler, Router } from 'express';\r\n\r\nexport class S3Router extends RouterBroker {\r\n  constructor(...guards: RequestHandler[]) {\r\n    super();\r\n    this.router\r\n      .post(this.routerPath('getMedia'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<MediaDto>({\r\n          request: req,\r\n          schema: s3Schema,\r\n          ClassRef: MediaDto,\r\n          execute: (instance, data) => s3Controller.getMedia(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.CREATED).json(response);\r\n      })\r\n      .post(this.routerPath('getMediaUrl'), ...guards, async (req, res) => {\r\n        const response = await this.dataValidate<MediaDto>({\r\n          request: req,\r\n          schema: s3UrlSchema,\r\n          ClassRef: MediaDto,\r\n          execute: (instance, data) => s3Controller.getMediaUrl(instance, data),\r\n        });\r\n\r\n        res.status(HttpStatus.OK).json(response);\r\n      });\r\n  }\r\n\r\n  public readonly router: Router = Router();\r\n}\r\n"],"mappings":"0PAAA,MAAO,uBCAP,OAAOA,OAAW,QAClB,OAAOC,OAAQ,KCDf,OAAS,mBAAAC,OAAuB,kBAChC,OAAOC,OAAY,SAEnBA,GAAO,OAAO,EA6RP,IAAMC,GAAN,KAAoB,CACzB,aAAc,CACZ,KAAK,QAAQ,CACf,CAIO,IAAaC,EAAU,CAC5B,OAAO,KAAK,IAAIA,CAAG,CACrB,CAEQ,SAAU,CAChB,KAAK,IAAM,KAAK,WAAW,EAC3B,KAAK,IAAI,WAAa,QAAQ,KAAK,WAAa,OAC5C,QAAQ,KAAK,aAAe,SAC9B,KAAK,IAAI,OAAO,KAAO,QAAQ,IAAI,YACnC,KAAK,IAAI,OAAO,KAAO,OAAO,SAAS,QAAQ,IAAI,WAAW,GAAK,KAEvE,CAEQ,YAAkB,CACxB,MAAO,CACL,OAAQ,CACN,KAAO,QAAQ,IAAI,aAAoC,OACvD,KAAM,OAAO,SAAS,QAAQ,IAAI,WAAW,GAAK,KAClD,IAAK,QAAQ,IAAI,WACjB,aAAc,QAAQ,KAAK,sBAAwB,OACnD,gBAAiB,QAAQ,KAAK,yBAA2B,MAC3D,EACA,KAAM,CACJ,OAAQ,QAAQ,IAAI,aAAa,MAAM,GAAG,GAAK,CAAC,GAAG,EACnD,QACG,QAAQ,IAAI,cAAc,MAAM,GAAG,GACnC,CAAC,OAAQ,MAAO,MAAO,QAAQ,EAClC,YAAa,QAAQ,KAAK,mBAAqB,MACjD,EACA,SAAU,CACR,QAAS,QAAQ,KAAK,kBAAoB,GAC1C,UAAW,QAAQ,KAAK,oBAAsB,EAChD,EACA,SAAU,CACR,QAAS,QAAQ,KAAK,mBAAqB,OAC3C,KAAM,QAAQ,IAAI,cAClB,KAAM,QAAQ,KAAK,eAAiB,OACpC,OAAQ,QAAQ,KAAK,iBAAmB,WAC1C,EACA,SAAU,CACR,WAAY,CACV,IAAK,QAAQ,IAAI,yBAA2B,GAC5C,YAAa,QAAQ,IAAI,iCAAmC,WAC9D,EACA,SAAU,QAAQ,IAAI,mBAAqB,aAC3C,UAAW,CACT,SAAU,QAAQ,KAAK,8BAAgC,OACvD,YAAa,QAAQ,KAAK,iCAAmC,OAC7D,eAAgB,QAAQ,KAAK,+BAAiC,OAC9D,SAAU,QAAQ,KAAK,8BAAgC,OACvD,MAAO,QAAQ,KAAK,2BAA6B,OACjD,SAAU,QAAQ,KAAK,8BAAgC,OACvD,OAAQ,QAAQ,KAAK,4BAA8B,OACnD,eAAgB,QAAQ,KAAK,+BAAiC,OAC9D,oBAAqB,OAAO,SAAS,QAAQ,KAAK,mCAAqC,GAAG,CAC5F,EACA,YAAa,CACX,uBAAwB,QAAQ,KAAK,0BAA4B,MACnE,CACF,EACA,SAAU,CACR,QAAS,QAAQ,KAAK,mBAAqB,OAC3C,eAAgB,QAAQ,KAAK,0BAA4B,OACzD,WAAY,QAAQ,KAAK,qBAAuB,YAChD,cAAe,QAAQ,KAAK,wBAA0B,qBACtD,IAAK,QAAQ,IAAI,cAAgB,GACjC,OAAQ,CACN,oBAAqB,QAAQ,KAAK,sCAAwC,OAC1E,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,eAAgB,QAAQ,KAAK,iCAAmC,OAChE,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,gBAAiB,QAAQ,KAAK,kCAAoC,OAClE,UAAW,QAAQ,KAAK,4BAA8B,OACtD,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,kBAAmB,QAAQ,KAAK,oCAAsC,OACtE,YAAa,QAAQ,KAAK,8BAAgC,OAC1D,mBAAoB,QAAQ,KAAK,qCAAuC,OACxE,cAAe,QAAQ,KAAK,gCAAkC,OAC9D,aAAc,QAAQ,KAAK,gCAAkC,OAC7D,0BAA2B,QAAQ,KAAK,4CAA8C,OACtF,KAAM,QAAQ,KAAK,uBAAyB,OAC5C,cAAe,QAAQ,KAAK,gCAAkC,OAC9D,sBAAuB,QAAQ,KAAK,wCAA0C,MAChF,CACF,EACA,IAAK,CACH,QAAS,QAAQ,KAAK,cAAgB,OACtC,cAAe,QAAQ,IAAI,mBAAqB,GAChD,kBAAmB,QAAQ,IAAI,uBAAyB,GACxD,WAAY,QAAQ,IAAI,gBAAkB,GAC1C,OAAQ,QAAQ,IAAI,YAAc,EACpC,EACA,UAAW,CACT,QAAS,QAAQ,KAAK,oBAAsB,OAC5C,cAAe,QAAQ,KAAK,0BAA4B,MAC1D,EACA,OAAQ,CACN,QAAS,QAAQ,KAAK,iBAAmB,OACzC,OAAQ,CACN,QAAS,QAAQ,KAAK,wBAA0B,OAChD,OAAQ,QAAQ,KAAK,sBAAwB,GAC7C,IAAK,QAAQ,KAAK,mBAAqB,GACvC,OAAQ,QAAQ,KAAK,sBAAwB,GAC7C,QAAS,QAAQ,KAAK,uBAAyB,GAC/C,QAAS,QAAQ,KAAK,wBAA0B,MAClD,EACA,OAAQ,CACN,oBAAqB,QAAQ,KAAK,oCAAsC,OACxE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,eAAgB,QAAQ,KAAK,+BAAiC,OAC9D,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,gBAAiB,QAAQ,KAAK,gCAAkC,OAChE,UAAW,QAAQ,KAAK,0BAA4B,OACpD,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,aAAc,QAAQ,KAAK,6BAA+B,OAC1D,kBAAmB,QAAQ,KAAK,kCAAoC,OACpE,YAAa,QAAQ,KAAK,4BAA8B,OACxD,mBAAoB,QAAQ,KAAK,mCAAqC,OACtE,cAAe,QAAQ,KAAK,8BAAgC,OAC5D,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,0BAA2B,QAAQ,KAAK,0CAA4C,OACpF,KAAM,QAAQ,KAAK,qBAAuB,OAC1C,cAAe,QAAQ,KAAK,8BAAgC,OAC5D,sBAAuB,QAAQ,KAAK,sCAAwC,MAC9E,CACF,EACA,YAAa,CACX,cAAe,QAAQ,IAAI,2BAA6B,YACxD,IAAK,QAAQ,IAAI,iBAAmB,6BACpC,QAAS,QAAQ,IAAI,qBAAuB,QAC5C,SAAU,QAAQ,IAAI,sBAAwB,IAChD,EACA,IAAK,CACH,MACG,QAAQ,KAAK,WAAW,MAAM,GAAG,GACjC,CAAC,QAAS,OAAQ,QAAS,OAAQ,MAAO,UAAW,OAAQ,WAAY,WAAW,EACvF,MAAO,QAAQ,KAAK,YAAc,OAClC,QAAU,QAAQ,KAAK,aAA8B,OACvD,EACA,aAAcH,GAAgB,QAAQ,KAAK,YAAY,EACnD,QAAQ,IAAI,eAAiB,OAC7B,OAAO,SAAS,QAAQ,IAAI,YAAY,GAAK,GACjD,mBAAoBA,GAAgB,QAAQ,KAAK,kBAAkB,EAC/D,QAAQ,IAAI,qBAAuB,OACnC,GACJ,SAAU,QAAQ,KAAK,UAAY,KACnC,QAAS,CACP,OAAQ,CACN,IAAK,QAAQ,KAAK,oBAAsB,GACxC,QAAS,QAAQ,KAAK,yBAA2B,OACjD,kBAAmB,QAAQ,KAAK,mCAAqC,MACvE,EACA,OAAQ,CACN,oBAAqB,QAAQ,KAAK,qCAAuC,OACzE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,eAAgB,QAAQ,KAAK,gCAAkC,OAC/D,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,gBAAiB,QAAQ,KAAK,iCAAmC,OACjE,UAAW,QAAQ,KAAK,2BAA6B,OACrD,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,aAAc,QAAQ,KAAK,8BAAgC,OAC3D,kBAAmB,QAAQ,KAAK,mCAAqC,OACrE,YAAa,QAAQ,KAAK,6BAA+B,OACzD,mBAAoB,QAAQ,KAAK,oCAAsC,OACvE,cAAe,QAAQ,KAAK,+BAAiC,OAC7D,aAAc,QAAQ,KAAK,+BAAiC,OAC5D,0BAA2B,QAAQ,KAAK,2CAA6C,OACrF,KAAM,QAAQ,KAAK,sBAAwB,OAC3C,cAAe,QAAQ,KAAK,+BAAiC,OAC7D,sBAAuB,QAAQ,KAAK,uCAAyC,OAC7E,OAAQ,QAAQ,KAAK,wBAA0B,OAC/C,eAAgB,QAAQ,KAAK,+BAAiC,EAChE,CACF,EACA,qBAAsB,CACpB,OAAQ,QAAQ,KAAK,6BAA+B,gBACpD,KAAM,QAAQ,KAAK,2BAA6B,SAChD,QAAS,QAAQ,KAAK,8BAAgC,IACxD,EACA,OAAQ,CACN,MAAO,OAAO,SAAS,QAAQ,IAAI,YAAY,GAAK,GACpD,MAAO,QAAQ,IAAI,cAAgB,SACrC,EACA,QAAS,CACP,QAAS,QAAQ,KAAK,kBAAoB,OAC1C,YAAa,QAAQ,KAAK,qBAAuB,MACjD,kBAAmB,QAAQ,KAAK,4BAA8B,MAChE,EACA,SAAU,CACR,QAAS,QAAQ,KAAK,mBAAqB,OAC3C,eAAgB,QAAQ,IAAI,0BAA4B,OACxD,aAAc,QAAQ,IAAI,wBAA0B,OACpD,YAAa,CAAC,QAAQ,IAAI,sBAAwB,QAAQ,IAAI,uBAAyB,OACvF,OAAQ,CACN,SAAU,CACR,WAAY,CACV,IAAK,QAAQ,IAAI,yCAA2C,EAC9D,CACF,EACA,0BAA2B,QAAQ,KAAK,4CAA8C,MACxF,CACF,EACA,OAAQ,CACN,QAAS,QAAQ,KAAK,iBAAmB,OACzC,eAAgB,QAAQ,KAAK,uBAAyB,IACxD,EACA,KAAM,CACJ,QAAS,QAAQ,KAAK,eAAiB,MACzC,EACA,MAAO,CACL,MAAO,CACL,QAAS,QAAQ,KAAK,sBAAwB,OAC9C,IAAK,QAAQ,KAAK,iBAAmB,GACrC,WAAY,QAAQ,KAAK,wBAA0B,kBACnD,IAAK,OAAO,SAAS,QAAQ,KAAK,eAAe,GAAK,OACtD,eAAgB,QAAQ,KAAK,6BAA+B,MAC9D,EACA,MAAO,CACL,QAAS,QAAQ,KAAK,sBAAwB,OAC9C,IAAK,OAAO,SAAS,QAAQ,KAAK,eAAe,GAAK,KACxD,CACF,EACA,GAAI,CACF,WAAY,QAAQ,KAAK,cACzB,WAAY,QAAQ,KAAK,cACzB,SAAU,QAAQ,KAAK,YACvB,YAAa,QAAQ,KAAK,UAC1B,OAAQ,QAAQ,KAAK,aAAe,OACpC,KAAM,OAAO,SAAS,QAAQ,KAAK,SAAW,MAAM,EACpD,QAAS,QAAQ,KAAK,aAAe,OACrC,OAAQ,QAAQ,KAAK,SACvB,EACA,eAAgB,CACd,QAAS,CACP,IAAK,QAAQ,IAAI,wBAA0B,WAC7C,EACA,0BAA2B,QAAQ,KAAK,2CAA6C,MACvF,CACF,CACF,CACF,EAEaI,EAAgB,IAAIF,GDpjBjC,IAAMG,GAAc,KAAK,MAAMC,GAAG,aAAa,iBAAkB,MAAM,CAAC,EAElEC,GAAiBC,GACrBC,GAAMD,CAAS,EACZ,OAAO,EACP,SAAS,EACT,QAAQ,UAAW,EAAE,EAErBE,QACHA,EAAA,IAAM,WACNA,EAAA,KAAO,WACPA,EAAA,KAAO,WACPA,EAAA,MAAQ,WACRA,EAAA,MAAQ,WACRA,EAAA,QAAU,WACVA,EAAA,KAAO,WAPJA,QAAA,IAgBL,IAAKC,QACHA,EAAA,IAAM,oBACNA,EAAA,KAAO,oBACPA,EAAA,KAAO,oBACPA,EAAA,KAAO,oBACPA,EAAA,MAAQ,oBACRA,EAAA,MAAQ,oBACRA,EAAA,QAAU,oBAPPA,QAAA,IAUAC,QACHA,EAAA,IAAM,MACNA,EAAA,KAAO,OACPA,EAAA,KAAO,OACPA,EAAA,KAAO,OACPA,EAAA,MAAQ,QACRA,EAAA,MAAQ,QACRA,EAAA,QAAU,UAPPA,QAAA,IAUAC,QACHA,EAAA,IAAM,WACNA,EAAA,KAAO,WACPA,EAAA,KAAO,WACPA,EAAA,KAAO,WACPA,EAAA,MAAQ,WACRA,EAAA,MAAQ,WACRA,EAAA,QAAU,WAPPA,QAAA,IAUQC,EAAN,KAAa,CAIlB,YAAYC,EAAU,SAAU,CAHhC,KAAiB,cAAgBC,EAOjC,KAAQ,SAAW,KAHjB,KAAK,QAAUD,CACjB,CAIO,WAAWE,EAAe,CAC/B,KAAK,QAAUA,CACjB,CAEO,YAAYA,EAAe,CAChC,KAAK,SAAWA,CAClB,CAEQ,QAAQA,EAAYC,EAAY,CACtC,IAAMC,EAAgB,CAAC,EAEvB,KAAK,cAAc,IAAS,KAAK,EAAE,MAAM,QAASC,GAAUD,EAAM,KAAKP,GAAKQ,CAAK,CAAC,CAAC,EAEnF,IAAMC,EAAY,OAAOJ,EACrBE,EAAM,SAASD,CAAI,IACjBF,EAAc,IAAS,KAAK,EAAE,OAChC,QAAQ,IACmB,UAAiBL,GAAMO,CAAI,EACpD,kBACA,UAAiBI,GAAMJ,CAAI,EAC3B,KAAK,SAAW,IAAI,KAAK,QAAQ,IAAM,GACvC,UAAiBI,GAAMJ,CAAI,EAC3B,IAAIK,GAAY,OAAO,GACvB,UAAiBD,GAAMJ,CAAI,EAC3B,QAAQ,IAAI,SAAS,EACrB,UACA,UAAiBI,GAAMJ,CAAI,EAC3B,IACA,kBACA,GAAGM,GAAc,KAAK,IAAI,CAAC,CAAC,KAC5B,UACAF,GAAMJ,CAAI,EAAIL,GAAWK,CAAI,EAAI,UACjC,GAAGA,CAAI,WACP,kBACA,IAAI,KAAK,OAAO,WAChBI,GAAMJ,CAAI,EAAI,UACd,IAAIG,CAAS,WACbC,GAAMJ,CAAI,EACVG,IAAc,SAAWJ,EAAQ,GACjC,SACF,EACAI,IAAc,UAAW,QAAQ,IAAoBJ,EAAO;AAAA,CAAI,GAEhE,QAAQ,IACN,kBACA,KAAK,SAAW,IAAI,KAAK,QAAQ,IAAM,GACvC,QAAQ,IAAI,SAAS,EACrB,IACA,GAAGO,GAAc,KAAK,IAAI,CAAC,CAAC,KAC5B,GAAGN,CAAI,IACP,IAAI,KAAK,OAAO,IAChB,IAAIG,CAAS,IACbJ,CACF,EAGN,CAEO,IAAIA,EAAY,CACrB,KAAK,QAAQA,EAAO,KAAQ,CAC9B,CAEO,KAAKA,EAAY,CACtB,KAAK,QAAQA,EAAO,MAAS,CAC/B,CAEO,KAAKA,EAAY,CACtB,KAAK,QAAQA,EAAO,MAAS,CAC/B,CAEO,MAAMA,EAAY,CACvB,KAAK,QAAQA,EAAO,OAAU,CAChC,CAEO,QAAQA,EAAY,CACzB,KAAK,QAAQA,EAAO,SAAY,CAClC,CAEO,MAAMA,EAAY,CACvB,KAAK,QAAQA,EAAO,OAAU,CAChC,CAEO,KAAKA,EAAY,CACtB,KAAK,QAAQA,EAAO,MAAS,CAC/B,CACF,EEtJA,OAAS,cAAAQ,OAAkB,UAC3B,OAAOC,OAAe,aAEf,IAAMC,GAAN,MAAMA,EAA6B,CAKxC,YACmBC,EACAC,EACjB,CAFiB,mBAAAD,EACA,YAAAC,EANnB,KAAiB,OAAS,IAAIC,EAAO,YAAY,EAQ/C,KAAK,KAAO,KAAK,cAAc,IAAe,OAAO,GAAG,KAC1D,CAEA,MAAM,IAAIC,EAA2B,CACnC,OAAOJ,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,CACrD,CAEA,MAAM,IAAIA,EAAaC,EAAYC,EAAc,CAC/C,OAAON,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,EAAGC,EAAOC,GAAO,KAAK,KAAK,GAAG,CAClF,CAEA,MAAM,IAAIF,EAAa,CACrB,OAAOJ,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,CACrD,CAEA,MAAM,OAAOA,EAAa,CACxB,OAAOJ,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,CACrD,CAEA,MAAM,UAAUG,EAAyB,CACvC,IAAMC,EAAO,MAAM,KAAK,KAAKD,CAAc,EAC3C,OAAKC,GAAM,OAIJR,GAAW,WAAW,IAAIQ,CAAI,EAH5B,CAIX,CAEA,MAAM,KAAKD,EAAyB,CAClC,IAAME,EAAS,GAAG,KAAK,SAAS,EAAE,CAAC,GAAGF,EAAiB,GAAGA,CAAc,IAAM,EAAE,GAEhF,OAAOP,GAAW,WAAW,KAAK,EAAE,OAAQI,GAAQA,EAAI,UAAU,EAAGK,EAAO,MAAM,IAAMA,CAAM,CAChG,CAEA,SAASL,EAAa,CACpB,MAAO,GAAG,KAAK,MAAM,IAAIA,CAAG,EAC9B,CAEA,MAAM,KAAKA,EAAaM,EAAe,CACrC,GAAI,CACF,IAAMC,EAAOX,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,EAEzD,OAAIO,GAAQD,KAASC,EACZ,KAAK,MAAMA,EAAKD,CAAK,EAAGZ,GAAW,OAAO,EAG5C,IACT,OAASc,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,KAAKR,EAAaM,EAAeL,EAAY,CACjD,GAAI,CACF,IAAMQ,EAAO,KAAK,UAAUR,EAAOP,GAAW,QAAQ,EAElDgB,EAAOd,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,EAElDU,IACHA,EAAO,CAAC,GAGVA,EAAKJ,CAAK,EAAIG,EACdb,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,EAAGU,CAAI,CACpD,OAASF,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,QAAQR,EAAaM,EAAe,CACxC,GAAI,CACF,IAAMC,EAAOX,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,CAAC,EAEzD,OAAIO,GAAQD,KAASC,GACnB,OAAOA,EAAKD,CAAK,EACjBV,GAAW,WAAW,IAAI,KAAK,SAASI,CAAG,EAAGO,CAAI,EAC3C,GAGF,CACT,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CACF,EA7FaZ,GAGJ,WAAa,IAAID,GAHnB,IAAMgB,GAANf,GCHP,OAAS,cAAAgB,OAAkB,UCD3B,OAAS,gBAAAC,OAAqC,QAE9C,IAAMC,GAAN,KAAY,CAMV,aAAc,CALd,KAAQ,OAAS,IAAIC,EAAO,OAAO,EACnC,KAAQ,OAA0B,KAElC,KAAQ,UAAY,GAGlB,KAAK,KAAOC,EAAc,IAAe,OAAO,GAAG,KACrD,CAEA,eAAiC,CAC/B,GAAI,KAAK,UACP,OAAO,KAAK,OAEZ,KAAK,OAASH,GAAa,CACzB,IAAK,KAAK,KAAK,GACjB,CAAC,EAED,KAAK,OAAO,GAAG,UAAW,IAAM,CAC9B,KAAK,OAAO,QAAQ,kBAAkB,CACxC,CAAC,EAED,KAAK,OAAO,GAAG,QAAS,IAAM,CAC5B,KAAK,OAAO,QAAQ,aAAa,EACjC,KAAK,UAAY,EACnB,CAAC,EAED,KAAK,OAAO,GAAG,QAAS,IAAM,CAC5B,KAAK,OAAO,MAAM,oBAAoB,EACtC,KAAK,UAAY,EACnB,CAAC,EAED,KAAK,OAAO,GAAG,MAAO,IAAM,CAC1B,KAAK,OAAO,QAAQ,wBAAwB,EAC5C,KAAK,UAAY,EACnB,CAAC,EAED,GAAI,CACF,KAAK,OAAO,QAAQ,EACpB,KAAK,UAAY,EACnB,OAASI,EAAG,CACV,YAAK,UAAY,GACjB,KAAK,OAAO,MAAM,mCAAqCA,CAAC,EACjD,IACT,CAEA,OAAO,KAAK,MAEhB,CACF,EAEaC,GAAc,IAAIJ,GD/CxB,IAAMK,GAAN,KAAmC,CAKxC,YACmBC,EACAC,EACjB,CAFiB,mBAAAD,EACA,YAAAC,EANnB,KAAiB,OAAS,IAAIC,EAAO,YAAY,EAQ/C,KAAK,KAAO,KAAK,cAAc,IAAe,OAAO,GAAG,MACxD,KAAK,OAASC,GAAY,cAAc,CAC1C,CACA,MAAM,IAAIC,EAA2B,CACnC,GAAI,CACF,OAAO,KAAK,MAAM,MAAM,KAAK,OAAO,IAAI,KAAK,SAASA,CAAG,CAAC,CAAC,CAC7D,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,KAAKD,EAAaE,EAAe,CACrC,GAAI,CACF,IAAMC,EAAO,MAAM,KAAK,OAAO,KAAK,KAAK,SAASH,CAAG,EAAGE,CAAK,EAE7D,OAAIC,EACK,KAAK,MAAMA,EAAMC,GAAW,OAAO,EAGrC,IACT,OAASH,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,IAAID,EAAaK,EAAYC,EAAc,CAC/C,GAAI,CACF,MAAM,KAAK,OAAO,MAAM,KAAK,SAASN,CAAG,EAAGM,GAAO,KAAK,MAAM,IAAK,KAAK,UAAUD,CAAK,CAAC,CAC1F,OAASJ,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,KAAKD,EAAaE,EAAeG,EAAY,CACjD,GAAI,CACF,IAAME,EAAO,KAAK,UAAUF,EAAOD,GAAW,QAAQ,EAEtD,MAAM,KAAK,OAAO,KAAK,KAAK,SAASJ,CAAG,EAAGE,EAAOK,CAAI,CACxD,OAASN,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,IAAID,EAAa,CACrB,GAAI,CACF,OAAQ,MAAM,KAAK,OAAO,OAAO,KAAK,SAASA,CAAG,CAAC,EAAK,CAC1D,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,OAAOD,EAAa,CACxB,GAAI,CACF,OAAO,MAAM,KAAK,OAAO,IAAI,KAAK,SAASA,CAAG,CAAC,CACjD,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,QAAQD,EAAaE,EAAe,CACxC,GAAI,CACF,OAAO,MAAM,KAAK,OAAO,KAAK,KAAK,SAASF,CAAG,EAAGE,CAAK,CACzD,OAASD,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,UAAUO,EAAyB,CACvC,GAAI,CACF,IAAMC,EAAO,MAAM,KAAK,KAAKD,CAAc,EAC3C,OAAKC,GAAM,OAIJ,MAAM,KAAK,OAAO,IAAIA,CAAI,EAHxB,CAIX,OAASR,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,KAAKO,EAAyB,CAClC,GAAI,CACF,IAAME,EAAQ,GAAG,KAAK,SAAS,EAAE,CAAC,GAAGF,EAAiB,GAAGA,CAAc,IAAM,EAAE,IACzEC,EAAO,CAAC,EACd,cAAiBT,KAAO,KAAK,OAAO,aAAa,CAC/C,MAAOU,EACP,MAAO,GACT,CAAC,EACCD,EAAK,KAAKT,CAAG,EAGf,MAAO,CAAC,GAAG,IAAI,IAAIS,CAAI,CAAC,CAC1B,OAASR,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,SAASD,EAAa,CACpB,MAAO,GAAG,KAAK,MAAM,UAAU,IAAI,KAAK,MAAM,IAAIA,CAAG,EACvD,CACF,EE9GA,IAAMW,GAAS,IAAIC,EAAO,aAAa,EAE1BC,GAAN,KAAkB,CAGvB,YACmBC,EACjBC,EACA,CAFiB,mBAAAD,EAGjB,IAAME,EAAYF,EAAc,IAAe,OAAO,EAElDE,GAAW,OAAO,SAAWA,GAAW,OAAO,MAAQ,IACzDL,GAAO,QAAQ,8BAA8BI,CAAM,EAAE,EACrD,KAAK,OAAS,IAAIE,GAAWH,EAAeC,CAAM,GACzCC,GAAW,OAAO,UAC3BL,GAAO,QAAQ,8BAA8BI,CAAM,EAAE,EACrD,KAAK,OAAS,IAAIG,GAAWJ,EAAeC,CAAM,EAEtD,CAEO,WAAY,CACjB,OAAO,KAAK,MACd,CACF,EC9BA,OAAOI,OAAmB,gBAE1B,IAAMC,GAAe,SAAS,QAAQ,IAAI,4BAA6B,EAAE,GAAK,GAEjEC,GAAe,IAAIF,GAAc,CAC5C,UAAW,IACX,YAAa,GACb,aAAc,GACd,aAAcC,EAChB,CAAC,ECLM,IAAME,GAAN,KAAqB,CAC1B,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,UAAU,CAAE,aAAAC,CAAa,EAAgBC,EAAoB,CACxE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,UAAUC,CAAI,CACtE,CACF,ECWO,IAAMC,GAAN,KAAqB,CAC1B,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,eAAe,CAAE,aAAAC,CAAa,EAAgBC,EAAyB,CAClF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,eAAeC,CAAI,CAC3E,CAEA,MAAa,YAAY,CAAE,aAAAD,CAAa,EAAgBC,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,kBAAkBC,CAAI,CAC9E,CAEA,MAAa,YAAY,CAAE,aAAAD,CAAa,EAAgBC,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,YAAYC,CAAI,CACxE,CAEA,MAAa,eAAe,CAAE,aAAAD,CAAa,EAAgBC,EAAyB,CAClF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,eAAeC,CAAI,CAC3E,CAEA,MAAa,cAAc,CAAE,aAAAD,CAAa,EAAgBC,EAAqB,CAC7E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,cAAcC,CAAI,CAC1E,CAEA,MAAa,oBAAoB,CAAE,aAAAD,CAAa,EAAgBC,EAAiB,CAC/E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,eAAeC,EAAK,MAAM,CAClF,CAEA,MAAa,aAAa,CAAE,aAAAD,CAAa,EAAgBC,EAAiB,CACxE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,aAAaA,EAAcC,EAAK,MAAM,CAC9F,CAEA,MAAa,cAAc,CAAE,aAAAD,CAAa,EAAgBE,EAAuB,CAC/E,OAAO,MAAM,KAAK,UAAU,YAAYF,CAAY,EAAE,cAAcE,CAAK,CAC3E,CAEA,MAAa,0BAA0B,CAAE,aAAAF,CAAa,EAAgBC,EAAoC,CACxG,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,0BAA0BC,CAAI,CACtF,CAEA,MAAa,cAAc,CAAE,aAAAD,CAAa,EAAgBE,EAAuB,CAC/E,OAAO,MAAM,KAAK,UAAU,YAAYF,CAAY,EAAE,cAAcE,CAAK,CAC3E,CAEA,MAAa,mBAAmB,CAAE,aAAAF,CAAa,EAAgBE,EAA6B,CAC1F,OAAO,MAAM,KAAK,UAAU,YAAYF,CAAY,EAAE,mBAAmBE,CAAK,CAChF,CAEA,MAAa,WAAW,CAAE,aAAAF,CAAa,EAAgBE,EAAuB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYF,CAAY,EAAE,WAAWE,CAAK,CACxE,CAEA,MAAa,aAAa,CAAE,aAAAF,CAAa,EAAgBC,EAAuB,CAC9E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,aAAaC,CAAI,CACzE,CAEA,MAAa,qBAAqB,CAAE,aAAAD,CAAa,EAAgB,CAC/D,OAAO,MAAM,KAAK,UAAU,YAAYA,CAAY,EAAE,qBAAqB,CAC7E,CAEA,MAAa,sBAAsB,CAAE,aAAAA,CAAa,EAAgBC,EAAyB,CACzF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,sBAAsBC,CAAI,CAClF,CAEA,MAAa,qBAAqB,CAAE,aAAAD,CAAa,EAAgBC,EAAyB,CACxF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,qBAAqBC,EAAK,MAAM,CACxF,CAEA,MAAa,kBAAkB,CAAE,aAAAD,CAAa,EAAgBC,EAAsB,CAClF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,kBAAkBC,EAAK,IAAI,CACnF,CAEA,MAAa,oBAAoB,CAAE,aAAAD,CAAa,EAAgBC,EAAwB,CACtF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,oBAAoBC,EAAK,MAAM,CACvF,CAEA,MAAa,qBAAqB,CAAE,aAAAD,CAAa,EAAgBC,EAAyB,CACxF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,qBAAqBC,EAAK,OAAO,CACzF,CAEA,MAAa,qBAAqB,CAAE,aAAAD,CAAa,EAAgB,CAC/D,OAAO,MAAM,KAAK,UAAU,YAAYA,CAAY,EAAE,qBAAqB,CAC7E,CAEA,MAAa,cAAc,CAAE,aAAAA,CAAa,EAAgBC,EAAwB,CAChF,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,cAAcC,CAAI,CAC1E,CAEA,MAAa,UAAU,CAAE,aAAAD,CAAa,EAAgBC,EAAoB,CACxE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,UAAUC,CAAI,CACtE,CACF,EC9FO,IAAME,GAAN,KAAsB,CAC3B,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,YAAYC,EAAuBC,EAAwB,CACtE,OAAO,MAAM,KAAK,UAAU,YAAYD,EAAS,YAAY,EAAE,YAAYC,CAAM,CACnF,CAEA,MAAa,mBAAmBD,EAAuBE,EAAyB,CAC9E,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,mBAAmBE,CAAM,CAC1F,CAEA,MAAa,mBAAmBF,EAAuBE,EAAyB,CAC9E,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,mBAAmBE,CAAM,CAC1F,CAEA,MAAa,uBAAuBF,EAAuBE,EAA6B,CACtF,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,uBAAuBE,CAAM,CAC9F,CAEA,MAAa,cAAcF,EAAuBG,EAAoB,CACpE,OAAO,MAAM,KAAK,UAAU,YAAYH,EAAS,YAAY,EAAE,UAAUG,CAAQ,CACnF,CAEA,MAAa,eAAeH,EAAuBI,EAAgC,CACjF,OAAO,MAAM,KAAK,UAAU,YAAYJ,EAAS,YAAY,EAAE,eAAeI,CAAc,CAC9F,CAEA,MAAa,WAAWJ,EAAuBG,EAAoB,CACjE,OAAO,MAAM,KAAK,UAAU,YAAYH,EAAS,YAAY,EAAE,WAAWG,CAAQ,CACpF,CAEA,MAAa,WAAWH,EAAuBK,EAAyB,CACtE,OAAO,MAAM,KAAK,UAAU,YAAYL,EAAS,YAAY,EAAE,WAAWK,CAAU,CACtF,CAEA,MAAa,WAAWL,EAAuBM,EAAuB,CACpE,OAAO,MAAM,KAAK,UAAU,YAAYN,EAAS,YAAY,EAAE,WAAWM,CAAI,CAChF,CAEA,MAAa,iBAAiBN,EAAuBK,EAA+B,CAClF,OAAO,MAAM,KAAK,UAAU,YAAYL,EAAS,YAAY,EAAE,iBAAiBK,CAAU,CAC5F,CAEA,MAAa,iBAAiBL,EAAuBG,EAAoB,CACvE,OAAO,MAAM,KAAK,UAAU,YAAYH,EAAS,YAAY,EAAE,iBAAiBG,CAAQ,CAC1F,CAEA,MAAa,iBAAiBH,EAAuBG,EAAoB,CACvE,OAAO,MAAM,KAAK,UAAU,YAAYH,EAAS,YAAY,EAAE,iBAAiBG,CAAQ,CAC1F,CAEA,MAAa,mBAAmBH,EAAuBE,EAAmC,CACxF,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,mBAAmBE,CAAM,CAC1F,CAEA,MAAa,eAAeF,EAAuBE,EAA+B,CAChF,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,eAAeE,CAAM,CACtF,CAEA,MAAa,gBAAgBF,EAAuBE,EAAiC,CACnF,OAAO,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,gBAAgBE,CAAM,CACvF,CAEA,MAAa,WAAWF,EAAuBG,EAAoB,CACjE,OAAO,MAAM,KAAK,UAAU,YAAYH,EAAS,YAAY,EAAE,WAAWG,CAAQ,CACpF,CACF,ECmDO,IAAMI,GAAmB,CAC9B,eACA,kBACA,eACA,eACA,iBACA,YACF,EAEaC,GAAiB,CAC5B,mBACA,6BACA,kBACA,mBACF,EAEaC,EAAc,CACzB,kBAAmB,oBACnB,iBAAkB,mBAClB,UAAW,WACb,EC9IA,OAAS,SAAAC,OAAa,UACtB,OAAS,WAAAC,GAAS,SAAAC,OAAa,kBCb/B,OAAOC,OAAY,SACnB,IAAMC,GAAY,IAAI,WAAW,GAAG,EAEhCC,GAAUD,GAAU,OACT,SAARE,IAAuB,CAC5B,OAAID,GAAUD,GAAU,OAAS,KAC/BD,GAAO,eAAeC,EAAS,EAC/BC,GAAU,GAGLD,GAAU,MAAMC,GAASA,IAAW,EAAE,CAC/C,CCLA,IAAME,EAAY,CAAC,EAEnB,QAASC,EAAI,EAAGA,EAAI,IAAK,EAAEA,EACzBD,EAAU,MAAMC,EAAI,KAAO,SAAS,EAAE,EAAE,MAAM,CAAC,CAAC,EAG3C,SAASC,GAAgBC,EAAKC,EAAS,EAAG,CAG/C,OAAOJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAI,IAAMJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAI,IAAMJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAI,IAAMJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,CAAC,CAAC,EAAI,IAAMJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,EAAIJ,EAAUG,EAAIC,EAAS,EAAE,CAAC,CACnf,CChBA,OAAOC,OAAY,SACnB,IAAOC,GAAQ,CACb,WAAYD,GAAO,UACrB,ECCA,SAASE,GAAGC,EAASC,EAAKC,EAAQ,CAChC,GAAIC,GAAO,YAAc,CAACF,GAAO,CAACD,EAChC,OAAOG,GAAO,WAAW,EAG3BH,EAAUA,GAAW,CAAC,EACtB,IAAMI,EAAOJ,EAAQ,SAAWA,EAAQ,KAAOK,IAAK,EAKpD,GAHAD,EAAK,CAAC,EAAIA,EAAK,CAAC,EAAI,GAAO,GAC3BA,EAAK,CAAC,EAAIA,EAAK,CAAC,EAAI,GAAO,IAEvBH,EAAK,CACPC,EAASA,GAAU,EAEnB,QAASI,EAAI,EAAGA,EAAI,GAAI,EAAEA,EACxBL,EAAIC,EAASI,CAAC,EAAIF,EAAKE,CAAC,EAG1B,OAAOL,CACT,CAEA,OAAOM,GAAgBH,CAAI,CAC7B,CAEA,IAAOI,EAAQT,GJTR,IAAMU,GAAN,KAAyB,CAC9B,YACmBC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACjB,CAXiB,eAAAV,EACA,mBAAAC,EACA,sBAAAC,EACA,kBAAAC,EACA,qBAAAC,EACA,qBAAAC,EACA,kBAAAC,EACA,WAAAC,EACA,mBAAAC,EACA,kBAAAC,EACA,mBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,oBAAoB,CAFtD,CAIH,MAAa,eAAeC,EAA2B,CACrD,GAAI,CACF,IAAMC,EAAWC,GAAkB,KAAKF,EAAc,CACpD,cAAe,KAAK,cACpB,aAAc,KAAK,aACnB,iBAAkB,KAAK,iBACvB,MAAO,KAAK,MACZ,cAAe,KAAK,cACpB,aAAc,KAAK,aACnB,cAAe,KAAK,aACtB,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAIE,EAAoB,qBAAqB,EAGrD,IAAMC,EAAaC,EAAG,EAEtBL,EAAa,WAAaI,EAE1B,IAAIE,EAsCJ,GApCKN,EAAa,MACbM,EAAON,EAAa,MADAM,EAAOD,EAAG,EAAE,YAAY,EAGjD,MAAM,KAAK,UAAU,aAAa,CAChC,WAAAD,EACA,YAAaJ,EAAa,YAC1B,aAAcA,EAAa,aAC3B,SAAUA,EAAa,SACvB,YAAaA,EAAa,YAC1B,cAAeA,EAAa,cAC5B,KAAAM,EACA,OAAQN,EAAa,OACrB,WAAYA,EAAa,WACzB,OAAQA,EAAa,MACvB,CAAC,EAEDC,EAAS,YAAY,CACnB,aAAcD,EAAa,aAC3B,WAAAI,EACA,YAAaJ,EAAa,YAC1B,MAAOM,EACP,OAAQN,EAAa,OACrB,WAAYA,EAAa,UAC3B,CAAC,EAED,KAAK,UAAU,YAAYC,EAAS,YAAY,EAAIA,EACpD,KAAK,UAAU,gBAAgBA,EAAS,YAAY,EAGpD,MAAMM,EAAa,YAAYN,EAAS,aAAcD,CAAY,EAElEC,EAAS,kCAAwC,CAC/C,aAAcD,EAAa,aAC3B,WAAYI,CACd,CAAC,EAEGJ,EAAa,WAAaA,EAAa,WAAaA,EAAa,cAAe,CAQlF,GAAI,CAPc,MAAM,KAAK,aAAa,UAAU,CAClD,KAAMA,EAAa,UACnB,KAAMA,EAAa,UACnB,SAAUA,EAAa,cACvB,SAAUA,EAAa,cACvB,SAAUA,EAAa,aACzB,CAAC,EAEC,MAAM,IAAIG,EAAoB,eAAe,EAG/C,MAAM,KAAK,aAAa,YAAYF,EAAU,CAC5C,QAAS,GACT,KAAMD,EAAa,UACnB,KAAMA,EAAa,UACnB,SAAUA,EAAa,cACvB,SAAUA,EAAa,cACvB,SAAUA,EAAa,aACzB,CAAC,CACH,CAEA,IAAMQ,EAA6B,CACjC,WAAYR,EAAa,aAAe,GACxC,QAASA,EAAa,SAAW,GACjC,aAAcA,EAAa,eAAiB,GAC5C,aAAcA,EAAa,eAAiB,GAC5C,aAAcA,EAAa,eAAiB,GAC5C,WAAYA,EAAa,aAAe,GACxC,gBAAiBA,EAAa,kBAAoB,GAClD,YAAaA,EAAa,aAAe,EAC3C,EAEA,MAAM,KAAK,gBAAgB,OAAOC,EAAUO,CAAQ,EAEpD,IAAIC,EAAoB,KACtBC,EAAwB,GAE1B,GAAIV,EAAa,cAAgBW,EAAY,kBAAmB,CAC9D,GAAI,CAACX,EAAa,OAChB,MAAM,IAAIG,EAAoB,oBAAoB,EAGpDM,EAAoB,GADF,KAAK,cAAc,IAAgB,QAAQ,EAAE,GAC/B,gBAChCC,EAAwB,KAAK,cAAc,IAAgB,aAAa,EAAE,aAC5E,CAEA,GAAI,CAACV,EAAa,mBAAqB,CAACA,EAAa,eAAiB,CAACA,EAAa,YAAa,CAC/F,IAAIY,EAEJ,OAAIZ,EAAa,QAAUA,EAAa,cAAgBW,EAAY,mBAClE,MAAMV,EAAS,kBAAkBD,EAAa,MAAM,EACpD,MAAMa,GAAM,GAAI,EAChBD,EAAYX,EAAS,QAGR,CACb,SAAU,CACR,aAAcA,EAAS,aACvB,WAAYG,EACZ,YAAaJ,EAAa,YAC1B,kBAAAS,EACA,sBAAAC,EACA,OAAQT,EAAS,iBAAiB,KACpC,EACA,KAAAK,EACA,QAAS,CACP,WAAYN,GAAc,SAAS,IACnC,eAAgBA,GAAc,SAAS,QACvC,gBAAiBA,GAAc,SAAS,SACxC,cAAeA,GAAc,SAAS,MACxC,EACA,UAAW,CACT,QAASA,GAAc,WAAW,OACpC,EACA,SAAU,CACR,QAASA,GAAc,UAAU,OACnC,EACA,IAAK,CACH,QAASA,GAAc,KAAK,OAC9B,EACA,SAAAQ,EACA,OAAQI,CACV,CAGF,CAEA,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAChD,MAAM,IAAIT,EAAoB,yBAAyB,EAEzD,GAAI,CAACH,EAAa,kBAChB,MAAM,IAAIG,EAAoB,uBAAuB,EAGvD,GAAI,CAACH,EAAa,cAChB,MAAM,IAAIG,EAAoB,mBAAmB,EAGnD,GAAI,CAACH,EAAa,YAChB,MAAM,IAAIG,EAAoB,iBAAiB,EAGjD,GAAI,CAACW,GAAMd,EAAa,YAAa,CAAE,YAAa,EAAM,CAAC,EACzD,MAAM,IAAIG,EAAoB,oCAAoC,EAGpE,GAAIH,EAAa,kBAAoB,IAAQA,EAAa,kBAAoB,GAC5E,MAAM,IAAIG,EAAoB,qBAAqB,EAGrD,GAAIH,EAAa,6BAA+B,IAAQA,EAAa,6BAA+B,GAClG,MAAM,IAAIG,EAAoB,gCAAgC,EAGhE,GAAIH,EAAa,8BAAgC,IAAQA,EAAa,8BAAgC,GACpG,MAAM,IAAIG,EAAoB,iCAAiC,EAGjE,IAAMY,EAAY,KAAK,cAAc,IAAgB,QAAQ,EAAE,IAE/D,GAAI,CACF,KAAK,gBAAgB,OAAOd,EAAU,CACpC,QAAS,GACT,UAAWD,EAAa,kBACxB,MAAOA,EAAa,cACpB,IAAKA,EAAa,YAClB,QAASA,EAAa,iBAAmB,GACzC,UAAWA,EAAa,mBAAqBC,EAAS,aAAa,MAAM,QAAQ,EAAE,CAAC,EACpF,OAAQD,EAAa,OACrB,mBAAoBA,EAAa,4BAA8B,GAC/D,oBAAqBA,EAAa,6BAA+B,GACjE,eAAgBA,EAAa,wBAA0B,GACvD,oBAAqBA,EAAa,6BAA+B,GACjE,eAAgBA,EAAa,wBAA0B,GACvD,wBAAyBA,EAAa,iCAAmC,GACzE,aAAcA,EAAa,qBAC3B,KAAMA,EAAa,aACnB,WAAYA,EAAa,qBAAuB,EAClD,CAAC,CACH,OAASgB,EAAO,CACd,KAAK,OAAO,IAAIA,CAAK,CACvB,CAEA,MAAO,CACL,SAAU,CACR,aAAcf,EAAS,aACvB,WAAYG,EACZ,YAAaJ,EAAa,YAC1B,kBAAAS,EACA,sBAAAC,EACA,OAAQT,EAAS,iBAAiB,KACpC,EACA,KAAAK,EACA,QAAS,CACP,WAAYN,GAAc,SAAS,IACnC,eAAgBA,GAAc,SAAS,QACvC,gBAAiBA,GAAc,SAAS,SACxC,cAAeA,GAAc,SAAS,MACxC,EACA,UAAW,CACT,QAASA,GAAc,WAAW,OACpC,EACA,SAAU,CACR,QAASA,GAAc,UAAU,OACnC,EACA,IAAK,CACH,QAASA,GAAc,KAAK,OAC9B,EACA,SAAAQ,EACA,SAAU,CACR,QAAS,GACT,UAAWR,EAAa,kBACxB,MAAOA,EAAa,cACpB,IAAKA,EAAa,YAClB,QAASA,EAAa,iBAAmB,GACzC,mBAAoBA,EAAa,4BAA8B,GAC/D,oBAAqBA,EAAa,6BAA+B,GACjE,oBAAqBA,EAAa,6BAA+B,GACjE,eAAgBA,EAAa,wBAA0B,GACvD,eAAgBA,EAAa,wBAA0B,GACvD,wBAAyBA,EAAa,iCAAmC,GACzE,OAAQA,EAAa,OACrB,UAAWA,EAAa,mBAAqBC,EAAS,aACtD,WAAY,GAAGc,CAAS,qBAAqB,mBAAmBd,EAAS,YAAY,CAAC,EACxF,CACF,CACF,OAASe,EAAO,CACd,WAAK,UAAU,eAAehB,EAAa,YAAY,EACvD,KAAK,OAAO,MAAMiB,GAAQD,EAAM,OAAO,EAAIA,EAAM,QAAQ,CAAC,EAAIA,EAAM,OAAO,EACrE,IAAIb,EAAoBc,GAAQD,EAAM,OAAO,EAAIA,EAAM,QAAQ,CAAC,EAAIA,EAAM,OAAO,CACzF,CACF,CAEA,MAAa,kBAAkB,CAAE,aAAAE,EAAc,OAAAC,EAAS,IAAK,EAAgB,CAC3E,GAAI,CACF,IAAMlB,EAAW,KAAK,UAAU,YAAYiB,CAAY,EAClDE,EAAQnB,GAAU,kBAAkB,MAE1C,GAAI,CAACmB,EACH,MAAM,IAAIjB,EAAoB,QAAUe,EAAe,2BAA2B,EAGpF,OAAIE,GAAS,OACJ,MAAM,KAAK,gBAAgB,CAAE,aAAAF,CAAa,CAAC,EAGhDE,GAAS,aACJnB,EAAS,OAGdmB,GAAS,SACX,MAAMnB,EAAS,kBAAkBkB,CAAM,EAEvC,MAAMN,GAAM,GAAI,EACTZ,EAAS,QAGX,CACL,SAAU,CACR,aAAciB,EACd,OAAQE,CACV,EACA,OAAQnB,GAAU,MACpB,CACF,OAASe,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAChB,CAAE,MAAO,GAAM,QAASA,EAAM,SAAS,CAAE,CAClD,CACF,CAEA,MAAa,gBAAgB,CAAE,aAAAE,CAAa,EAAgB,CAC1D,GAAI,CACF,IAAMjB,EAAW,KAAK,UAAU,YAAYiB,CAAY,EAClDE,EAAQnB,GAAU,kBAAkB,MAE1C,GAAI,CAACmB,EACH,MAAM,IAAIjB,EAAoB,QAAUe,EAAe,2BAA2B,EAGpF,GAAIE,GAAS,QACX,MAAM,IAAIjB,EAAoB,QAAUe,EAAe,6BAA6B,EAC/E,GAAIE,GAAS,OAClB,OAAI,KAAK,cAAc,IAAc,UAAU,EAAE,SAASnB,EAAS,mBAAmB,EACtF,KAAK,OAAO,KAAK,sBAAwBiB,CAAY,EAErDjB,EAAS,QAAQ,IAAI,MAAM,EAC3BA,EAAS,QAAQ,IAAI,IAAI,MAAM,SAAS,CAAC,EAClC,MAAM,KAAK,kBAAkB,CAAE,aAAAiB,CAAa,CAAC,EAC/C,GAAIE,GAAS,aAClB,OAAAnB,EAAS,QAAQ,IAAI,MAAM,EAC3BA,EAAS,QAAQ,IAAI,IAAI,MAAM,SAAS,CAAC,EAClC,MAAM,KAAK,kBAAkB,CAAE,aAAAiB,CAAa,CAAC,CAExD,OAASF,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAChB,CAAE,MAAO,GAAM,QAASA,EAAM,SAAS,CAAE,CAClD,CACF,CAEA,MAAa,gBAAgB,CAAE,aAAAE,CAAa,EAAgB,CAC1D,MAAO,CACL,SAAU,CACR,aAAcA,EACd,MAAO,KAAK,UAAU,YAAYA,CAAY,GAAG,kBAAkB,KACrE,CACF,CACF,CAEA,MAAa,eAAe,CAAE,aAAAA,EAAc,WAAAd,EAAY,OAAAe,CAAO,EAAgBE,EAAa,CAG1F,GAFY,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAEnD,MAAQA,EAAK,CACnB,IAAMC,EAAiB,MAAM,KAAK,iBAAiB,SAAS,SAAS,CACnE,MAAO,CACL,MAAOD,EACP,KAAMH,GAAgB,OACtB,GAAId,GAAc,MACpB,CACF,CAAC,EAED,GAAIkB,EAAe,OAAS,EAAG,CAC7B,IAAMC,EAAQD,EAAe,IAAKrB,GAAaA,EAAS,IAAI,EAE5D,OAAO,KAAK,UAAU,aAAasB,CAAK,CAC1C,KACE,OAAM,IAAIC,EAEd,CAEA,GAAIpB,GAAce,EAChB,OAAO,KAAK,UAAU,iBAAiBf,EAAYe,CAAM,EAG3D,IAAMM,EAAgBP,EAAe,CAACA,CAAY,EAAI,KAEtD,OAAO,KAAK,UAAU,aAAaO,CAAa,CAClD,CAEA,MAAa,YAAY,CAAE,aAAAP,CAAa,EAAgBQ,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYR,CAAY,EAAE,YAAYQ,CAAI,CACxE,CAEA,MAAa,OAAO,CAAE,aAAAR,CAAa,EAAgB,CACjD,GAAM,CAAE,SAAAjB,CAAS,EAAI,MAAM,KAAK,gBAAgB,CAAE,aAAAiB,CAAa,CAAC,EAEhE,GAAIjB,EAAS,QAAU,QACrB,MAAM,IAAIE,EAAoB,QAAUe,EAAe,6BAA6B,EAGtF,GAAI,CACF,YAAK,UAAU,YAAYA,CAAY,GAAG,eAAe,EAElD,CAAE,OAAQ,UAAW,MAAO,GAAO,SAAU,CAAE,QAAS,qBAAsB,CAAE,CACzF,OAASF,EAAO,CACd,MAAM,IAAIW,EAA6BX,EAAM,SAAS,CAAC,CACzD,CACF,CAEA,MAAa,eAAe,CAAE,aAAAE,CAAa,EAAgB,CACzD,GAAM,CAAE,SAAAjB,CAAS,EAAI,MAAM,KAAK,gBAAgB,CAAE,aAAAiB,CAAa,CAAC,EAChE,GAAI,CACF,IAAMU,EAAc,KAAK,UAAU,YAAYV,CAAY,EACvD,KAAK,cAAc,IAAc,UAAU,EAAE,SAASU,GAAa,mBAAmB,GAEtF3B,EAAS,QAAU,cAAgBA,EAAS,QAAU,SACxD,MAAM,KAAK,OAAO,CAAE,aAAAiB,CAAa,CAAC,EAGpC,GAAI,CACFU,GAAa,kCAAwC,CACnD,aAAAV,EACA,WAAYU,EAAY,UAC1B,CAAC,CACH,OAASZ,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CAEA,YAAK,aAAa,KAAK,kBAAmBE,EAAc,OAAO,EACxD,CAAE,OAAQ,UAAW,MAAO,GAAO,SAAU,CAAE,QAAS,kBAAmB,CAAE,CACtF,OAASF,EAAO,CACd,MAAM,IAAIb,EAAoBa,EAAM,SAAS,CAAC,CAChD,CACF,CACF,EKlbO,IAAMa,GAAN,KAAsB,CAC3B,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,YAAY,CAAE,aAAAC,CAAa,EAAgB,CACtD,OAAO,MAAM,KAAK,UAAU,YAAYA,CAAY,EAAE,YAAY,CACpE,CAEA,MAAa,YAAY,CAAE,aAAAA,CAAa,EAAgBC,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,YAAYC,CAAI,CACxE,CACF,ECdA,OAAS,mBAAAC,OAAuB,oBAUzB,SAASC,GAAeC,EAAuB,CACpD,GAAI,OAAOA,GAAU,SACnB,OAAO,IAAIF,GAAgBE,CAAK,EAGlC,GAAM,CAAE,KAAAC,EAAM,SAAAC,EAAU,KAAAC,EAAM,SAAAC,EAAU,SAAAC,CAAS,EAAIL,EACjDM,EAAW,GAAGF,CAAQ,MAAMH,CAAI,IAAIE,CAAI,GAE5C,OAAIE,GAAYH,IACdI,EAAW,GAAGF,CAAQ,MAAMC,CAAQ,IAAIH,CAAQ,IAAID,CAAI,IAAIE,CAAI,IAE3D,IAAIL,GAAgBQ,CAAQ,CACrC,CCfA,OAAOC,OAAW,QAElB,IAAMC,GAAS,IAAIC,EAAO,iBAAiB,EAE9BC,GAAN,KAAsB,CAC3B,YACmBC,EACAC,EACjB,CAFiB,kBAAAD,EACA,eAAAC,CAChB,CAEH,MAAa,YAAYC,EAAuBC,EAAgB,CAC9D,GAAI,CAAC,KAAK,UAAU,YAAYD,EAAS,YAAY,EACnD,MAAM,IAAIE,EAAkB,QAAQF,EAAS,YAAY,2BAA2B,EAWtF,GARKC,GAAM,UACTA,EAAK,KAAO,GACZA,EAAK,KAAO,GACZA,EAAK,SAAW,GAChBA,EAAK,SAAW,GAChBA,EAAK,SAAW,IAGdA,EAAK,MAEH,CADc,MAAM,KAAK,UAAUA,CAAI,EAEzC,MAAM,IAAIE,EAAoB,eAAe,EAIjD,OAAO,KAAK,aAAa,OAAOH,EAAUC,CAAI,CAChD,CAEA,MAAa,UAAUD,EAAuB,CAC5C,GAAI,CAAC,KAAK,UAAU,YAAYA,EAAS,YAAY,EACnD,MAAM,IAAIE,EAAkB,QAAQF,EAAS,YAAY,2BAA2B,EAGtF,OAAO,KAAK,aAAa,KAAKA,CAAQ,CACxC,CAEA,MAAa,UAAUI,EAAiB,CACtC,GAAI,CACF,IAAMC,EAAW,MAAMX,GAAM,IAAI,wBAAwB,EAKzD,OAJiB,MAAMA,GAAM,IAAI,yBAA0B,CACzD,WAAYY,GAAeF,CAAK,CAClC,CAAC,IAEgB,OAASC,GAAU,IACtC,OAASE,EAAO,CACd,OAAIb,GAAM,aAAaa,CAAK,GAAKA,EAAM,UAAU,KAC/CZ,GAAO,MAAM,oBAAsBY,EAAM,SAAS,IAAI,GAC7Cb,GAAM,aAAaa,CAAK,EACjCZ,GAAO,MAAM,mBAAmB,GAI3B,EACT,CACF,CACF,ECjDA,OAAS,YAAAa,GAAU,SAAAC,OAAa,kBAEzB,IAAMC,GAAN,KAA4B,CACjC,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,aAAa,CAAE,aAAAC,CAAa,EAAgBC,EAAuB,CAC9E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,gBAAgBC,CAAI,CAC5E,CAEA,MAAa,SAAS,CAAE,aAAAD,CAAa,EAAgBC,EAAmB,CACtE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,YAAYC,CAAI,CACxE,CAEA,MAAa,UAAU,CAAE,aAAAD,CAAa,EAAgBC,EAAoBC,EAAY,CACpF,GAAIN,GAASK,GAAM,KAAK,GAAK,CAACA,GAAM,UAAYA,GAAM,YAAc,WAClE,MAAM,IAAIE,EAAoB,4CAA4C,EAG5E,GAAID,GAAQL,GAAMI,GAAM,KAAK,GAAKL,GAASK,GAAM,KAAK,EACpD,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,aAAaC,EAAMC,CAAI,EAE/E,MAAM,IAAIC,EAAoB,qCAAqC,CACrE,CAEA,MAAa,QAAQ,CAAE,aAAAH,CAAa,EAAgBC,EAAkBC,EAAY,CAChF,GAAIA,GAAQL,GAAMI,GAAM,KAAK,GAAKL,GAASK,GAAM,KAAK,EACpD,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,WAAWC,EAAMC,CAAI,EAE7E,MAAM,IAAIC,EAAoB,qCAAqC,CACrE,CAEA,MAAa,YAAY,CAAE,aAAAH,CAAa,EAAgBC,EAAsBC,EAAY,CACxF,GAAIA,GAAQL,GAAMI,EAAK,OAAO,GAAKL,GAASK,EAAK,OAAO,EACtD,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,aAAaC,EAAMC,CAAI,EAE/E,MAAM,IAAIC,EAAoB,qCAAqC,CACrE,CAEA,MAAa,kBAAkB,CAAE,aAAAH,CAAa,EAAgBC,EAAoBC,EAAY,CAC5F,GAAIA,GAAM,QAAUL,GAAMI,EAAK,KAAK,GAAKL,GAASK,EAAK,KAAK,EAE1D,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,cAAcC,EAAMC,CAAI,EAE9E,cAAQ,MAAM,wEAAqE,EAC7E,IAAIC,EAAoB,8DAA8D,CAEhG,CAEA,MAAa,YAAY,CAAE,aAAAH,CAAa,EAAgBC,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,cAAcC,CAAI,CAC1E,CAEA,MAAa,aAAa,CAAE,aAAAD,CAAa,EAAgBC,EAAuB,CAC9E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,gBAAgBC,CAAI,CAC5E,CAEA,MAAa,SAAS,CAAE,aAAAD,CAAa,EAAgBC,EAAmB,CACtE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,YAAYC,CAAI,CACxE,CAEA,MAAa,YAAY,CAAE,aAAAD,CAAa,EAAgBC,EAAsB,CAC5E,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,eAAeC,CAAI,CAC3E,CAEA,MAAa,aAAa,CAAE,aAAAD,CAAa,EAAgBC,EAAuB,CAC9E,GAAI,CAACA,EAAK,SAAS,MAAM,kBAAkB,EACzC,MAAM,IAAIE,EAAoB,6BAA6B,EAE7D,OAAO,MAAM,KAAK,UAAU,YAAYH,CAAY,EAAE,gBAAgBC,CAAI,CAC5E,CAEA,MAAa,SAAS,CAAE,aAAAD,CAAa,EAAgBC,EAAmB,CACtE,OAAO,MAAM,KAAK,UAAU,YAAYD,CAAY,EAAE,YAAYC,CAAI,CACxE,CAEA,MAAa,WAAW,CAAE,aAAAD,CAAa,EAAgBC,EAAqBC,EAAY,CACtF,OAAO,MAAM,KAAK,UAAU,YAAYF,CAAY,EAAE,cAAcC,EAAMC,CAAI,CAChF,CACF,EC5FO,IAAME,GAAN,KAAyB,CAC9B,YAA6BC,EAAkC,CAAlC,qBAAAA,CAAmC,CAEhE,MAAa,eAAeC,EAAuBC,EAAmB,CACpE,OAAO,KAAK,gBAAgB,OAAOD,EAAUC,CAAI,CACnD,CAEA,MAAa,aAAaD,EAAuB,CAE/C,OADiB,KAAK,gBAAgB,KAAKA,CAAQ,CAErD,CACF,ECXO,IAAME,GAAN,KAAyB,CAC9B,YAA6BC,EAAkC,CAAlC,qBAAAA,CAAmC,CAEhE,MAAa,eAAeC,EAAuBC,EAAmB,CACpE,OAAO,KAAK,gBAAgB,OAAOD,EAAUC,CAAI,CACnD,CAEA,MAAa,aAAaD,EAAuB,CAC/C,OAAO,KAAK,gBAAgB,KAAKA,CAAQ,CAC3C,CACF,ECXA,UAAYE,OAAW,QACvB,OAAS,QAAAC,OAAY,OAGrB,IAAMC,GAAS,IAAIC,EAAO,YAAY,EAEhCC,GAAS,IAAIC,GAAc,EAAE,IAAQ,IAAI,EAMzCC,IAAe,IAAM,CACzB,GAAIF,IAAQ,OACV,OAAO,IAAU,UAAO,CACtB,SAAUA,GAAO,SACjB,KAAMA,GAAO,KACb,OAAQA,GAAO,QACf,UAAWA,GAAO,WAClB,UAAWA,GAAO,WAClB,OAAQA,GAAO,MACjB,CAAC,CAEL,GAAG,EAEGG,GAAa,QAAQ,IAAI,UAEzBC,GAAe,SAAY,CAC/B,GAAIF,GACF,GAAI,CAEF,OADa,MAAMA,GAAY,YAAY,GAC/B,KAAMG,GAAWA,EAAO,OAASF,EAAU,CACzD,MAAgB,CACd,MAAO,EACT,CAEJ,EAEMG,GAAkB,SAAY,CAClC,GAAIJ,GAAa,CACf,IAAMK,EAAS,CACb,QAAS,aACT,UAAW,CACT,CACE,OAAQ,QACR,UAAW,IACX,OAAQ,CAAC,cAAc,EACvB,SAAU,CAAC,gBAAgBJ,EAAU,IAAI,CAC3C,CACF,CACF,EACA,MAAMD,GAAY,gBAAgBC,GAAY,KAAK,UAAUI,CAAM,CAAC,CACtE,CACF,EAEMC,GAAe,SAAY,CAC/B,GAAIN,GACF,GAAI,CAEF,OADe,MAAME,GAAa,GAEhC,MAAMF,GAAY,WAAWC,EAAU,EAGzC,MAAMG,GAAgB,EAEtBR,GAAO,KAAK,aAAaK,EAAU,OAAO,EACnC,EACT,OAASM,EAAO,CACd,OAAAX,GAAO,MAAM,WAAW,EACxBA,GAAO,MAAMW,CAAK,EACX,EACT,CAEJ,EAEAD,GAAa,EAEb,IAAME,GAAa,MAAOC,EAAkBC,EAAqCC,EAAcC,IAAuB,CACpH,GAAIZ,GAAa,CACf,IAAMa,EAAalB,GAAK,gBAAiBc,CAAQ,EACjD,GAAI,CACF,OAAAG,EAAS,2BAA2B,EAAI,gBACjC,MAAMZ,GAAY,UAAUC,GAAYY,EAAYH,EAAMC,EAAMC,CAAQ,CACjF,OAASL,EAAO,CACd,OAAAX,GAAO,MAAMW,CAAK,EACXA,CACT,CACF,CACF,EAEMO,GAAe,MAAOL,EAAkBM,IAAoB,CAChE,GAAIf,GACF,GAAI,CACF,IAAMa,EAAalB,GAAK,gBAAiBc,CAAQ,EACjD,OAAIM,EACK,MAAMf,GAAY,mBAAmBC,GAAYY,EAAYE,CAAM,EAErE,MAAMf,GAAY,mBAAmBC,GAAYY,CAAU,CACpE,OAASN,EAAO,CACd,MAAM,IAAIS,EAAoBT,GAAO,OAAO,CAC9C,CAEJ,ECvGA,OAAOU,OAAgB,KAEvB,GAAM,CAAE,KAAAC,EAAK,EAAID,GAEXE,GAAN,KAAe,CAAf,cACE,KAAQ,OAAS,IAAIC,EAAO,UAAU,EAEtC,KAAQ,UAAY,GAEpB,cAAcC,EAA0B,CACtC,GAAI,KAAK,UACP,OAAO,KAAK,KAEZ,KAAK,KAAO,IAAIH,GAAK,CACnB,iBAAAG,EACA,IAAK,CACH,mBAAoB,EACtB,CACF,CAAC,EAED,KAAK,KAAK,GAAG,QAAS,IAAM,CAC1B,KAAK,OAAO,MAAM,uBAAuB,EACzC,KAAK,UAAY,EACnB,CAAC,EAED,GAAI,CACF,KAAK,UAAY,EACnB,OAAS,EAAG,CACV,YAAK,UAAY,GACjB,KAAK,OAAO,MAAM,sCAAwC,CAAC,EACpD,IACT,CAEA,OAAO,KAAK,IAEhB,CAEA,uBAAwB,CACtB,IAAMC,EAAMC,EAAc,IAAc,UAAU,EAAE,OAAO,SAAS,WAAW,IAE/E,OAAO,KAAK,cAAcD,CAAG,CAC/B,CACF,EAEaE,GAAiB,IAAIL,GClBlC,IAAMM,GAAN,KAAqB,CAArB,cACE,KAAQ,OAAS,IAAIC,EAAO,gBAAgB,EAC5C,KAAQ,wBAA0B,IAAI,IACtC,KAAQ,gBAAkB,IAAI,IAC9B,KAAQ,gBAAkB,IAAI,IAEvB,2BAA2BC,EAAuB,CACvD,OAAO,KAAK,wBAAwB,IAAIA,EAAS,YAAY,EACzD,KAAK,wBAAwB,IAAIA,EAAS,YAAY,EACtD,IACN,CAEO,2BAA2BA,EAAuBC,EAAsC,CAC7F,KAAK,wBAAwB,IAAID,EAAS,aAAcC,CAAuB,CACjF,CAEO,8BAA8BD,EAAuB,CAC1D,KAAK,wBAAwB,OAAOA,EAAS,YAAY,CAC3D,CAEO,mBAAmBA,EAAuBE,EAAwB,CACvE,IAAMC,EAAc,KAAK,gBAAgB,IAAIH,EAAS,YAAY,EAC9D,KAAK,gBAAgB,IAAIA,EAAS,YAAY,EAC9C,CAAC,EACL,KAAK,gBAAgB,IAAIA,EAAS,aAAc,CAAC,GAAGG,EAAa,GAAGD,CAAW,CAAC,CAClF,CAEO,mBAAmBF,EAAuBI,EAAwB,CACvE,IAAMD,EAAc,KAAK,gBAAgB,IAAIH,EAAS,YAAY,EAC9D,KAAK,gBAAgB,IAAIA,EAAS,YAAY,EAC9C,CAAC,EACL,KAAK,gBAAgB,IAAIA,EAAS,aAAcG,EAAY,OAAOC,CAAW,CAAC,CACjF,CAEO,sBAAsBJ,EAAuB,CAClD,KAAK,gBAAgB,OAAOA,EAAS,YAAY,CACnD,CAEO,sBAAsBA,EAAuB,CAClD,KAAK,gBAAgB,OAAOA,EAAS,YAAY,CACnD,CAEO,SAASA,EAAuB,CACrC,KAAK,8BAA8BA,CAAQ,EAC3C,KAAK,sBAAsBA,CAAQ,EACnC,KAAK,sBAAsBA,CAAQ,CACrC,CAEO,yBAAyBA,EAAuB,CACrD,OAAO,KAAK,gBAAgB,IAAIA,EAAS,YAAY,GAAG,QAAU,CACpE,CAEA,MAAa,sBAAsBA,EAAuBK,EAAuB,CAC/E,GAAI,CACF,GAAI,KAAK,yBAAyBL,CAAQ,EAAI,EAC5C,OAGF,IAAMM,EAAWC,GAAe,sBAAsB,EAElDC,EAAwB,EAEtBC,EAAW,KAAK,gBAAgB,IAAIT,EAAS,YAAY,GAAK,CAAC,EACrE,GAAIS,EAAS,SAAW,EACtB,MAAO,GAGT,IAAIC,EAA2B,KAAK,gBAAgBD,EAAU,GAAI,EAClE,KAAOC,EAAc,OAAS,GAAG,CAC/B,IAAMC,EAAW,wCAAwCN,EAAS,SAAS,sBAAsBA,EAAS,SAAS,WAE/GO,GAAW,MAAMN,EAAS,MAAMK,CAAQ,IAAI,KAAK,CAAC,GAAG,GAEzD,GAAI,CAACC,EAAS,CAEZ,IAAMC,EAAW,mGAAmGR,EAAS,SAAS,uBAAuBA,EAAS,SAAS,+BAE/KO,GAAW,MAAMN,EAAS,MAAMO,CAAQ,IAAI,KAAK,CAAC,GAAG,EACvD,CAGA,IAAIC,EAAY;AAAA,wFAEVC,EAAa,CAACV,EAAS,SAAS,EAEtC,QAAWW,KAAWN,EAAe,CACnCK,EAAW,KAAKC,EAAQ,QAAQ,EAChC,IAAMC,EAAW,IAAIF,EAAW,MAAM,GAEtCA,EAAW,KAAK,IAAIC,EAAQ,UAAU,MAAM,GAAG,EAAE,CAAC,CAAC,EAAE,EACrD,IAAME,EAAkB,IAAIH,EAAW,MAAM,GAE7CA,EAAW,KAAKC,EAAQ,SAAS,EACjC,IAAMG,EAAiB,IAAIJ,EAAW,MAAM,GAE5CD,GAAa,IAAIG,CAAQ,KAAKC,CAAe,SAASC,CAAc,kBACtE,CACIL,EAAU,MAAM,EAAE,IAAM,MAC1BA,EAAYA,EAAU,MAAM,EAAG,EAAE,GAEnCA,GAAa;AAAA;AAAA;AAAA;AAAA,0DAMbN,IAA0B,MAAMF,EAAS,MAAMQ,EAAWC,CAAU,IAAI,UAAY,EAEpF,IAAMK,EAAU,qCAAqCf,EAAS,SAAS,YAGnEgB,GADa,MAAMf,EAAS,MAAMc,CAAO,IAAI,KAAK,CAAC,GAClC,GAEfE,EAAS,oDAAoDjB,EAAS,SAAS,MAAMG,CAAqB,6EAA6EA,CAAqB,gBAElNa,GAAS,MAAMf,EAAS,MAAMgB,CAAM,IAAI,KAAK,CAAC,GAAG,GAEjD,MAAMhB,EAAS,MAAMgB,CAAM,EAE3B,IAAIC,EAAiB,yFAErBb,EAAc,QAASM,GAAY,CACjC,IAAMQ,EAAiB,gDAAgDR,EAAQ,SAAS,sBAAsBX,EAAS,SAAS,IAChIkB,GAAkB,YAAYC,CAAc,eAC9C,CAAC,EAEGD,EAAe,MAAM,EAAE,IAAM,MAC/BA,EAAiBA,EAAe,MAAM,EAAG,EAAE,GAG7C,MAAMjB,EAAS,MAAMiB,EAAgB,CAACF,EAAO,UAAW,QAAQ,CAAC,EAEjEX,EAAgB,KAAK,gBAAgBD,EAAU,GAAI,CACrD,CAEA,YAAK,sBAAsBT,CAAQ,EAE5BQ,CACT,OAASiB,EAAO,CACd,KAAK,OAAO,MAAM,qCAAqCA,EAAM,SAAS,CAAC,EAAE,CAC3E,CACF,CAEA,MAAa,qBAAqBC,EAA2C,CAC3E,GAAI,CACF,IAAMC,EAAuB,IAAI,IAEjC,GAAID,EAAU,SAAW,EACvB,OAAOC,EAGT,IAAMC,EAAqBF,EAAU,IAAKG,GAAa,QAAQA,EAAS,QAAQ,QAAS,EAAE,CAAC,EAAE,EAGxFC,EAAS,MADEvB,GAAe,sBAAsB,EACxB,MAFhB,2DAE6B,CAACqB,CAAkB,CAAC,EAE/D,QAAWG,KAAOD,EAAO,KACvBH,EAAqB,IAAII,EAAI,SAAS,EAGxC,OAAOJ,CACT,MAAgB,CACd,OAAO,IACT,CACF,CAEA,MAAa,sBACX3B,EACAgC,EACAC,EACA5B,EACA,CACA,GAAI,CACF,IAAMC,EAAWC,GAAe,sBAAsB,EAEhD2B,EAAe,MAAM,KAAK,gBAAgB7B,CAAQ,EACxD,GAAI,CAAC6B,EACH,MAAM,IAAI,MAAM,oCAAoC,EAGtD,IAAIC,EAAwB,EAExBC,EAAkB,KAAK,gBAAgB,IAAIpC,EAAS,YAAY,GAAK,CAAC,EAC1E,GAAIoC,EAAgB,SAAW,EAC7B,MAAO,GAITA,EAAgB,KAAK,CAACC,EAAGC,IAAM,CAC7B,IAAMC,EAAOF,EAAE,IAITG,EAAOF,EAAE,IAITG,EAAoBJ,EAAE,iBACtBK,EAAoBJ,EAAE,iBAE5B,OAAO,SAASC,EAAK,SAAS,EAAI,SAASC,EAAK,SAAS,GAAKC,EAAoBC,CACpF,CAAC,EAED,IAAMC,EAAiC,KAAK,+BAA+BP,CAAe,EAEpFQ,EAA4B,IAAI,IACtCD,EAA+B,QAAQ,CAACE,EAAqBC,IAAwB,CACnFF,EAA0B,IAAIE,EAAa,CACzC,MAAOD,EAAS,CAAC,GAAG,iBACpB,KAAMA,EAASA,EAAS,OAAS,CAAC,GAAG,gBACvC,CAAC,CACH,CAAC,EAED,IAAME,EAAoB,MAAM,KAAK,qBAAqBX,EAAgB,IAAKY,GAAiBA,EAAQ,IAAI,EAAE,CAAC,EAC/GZ,EAAkBA,EAAgB,OAAQY,GAAiB,CAACD,EAAkB,IAAIC,EAAQ,IAAI,EAAE,CAAC,EAEjG,IAAMC,EAAY,IACdC,EAA2B,KAAK,gBAAgBd,EAAiBa,CAAS,EAC9E,KAAOC,EAAc,OAAS,GAAG,CAE/B,IAAMC,EAAwB,KAAK,+BAA+BD,CAAa,EAE/E,GAAIC,EAAsB,KAAO,EAAG,CAClC,IAAMC,EAAc,MAAM,KAAK,8BAC7B/C,EACA4B,EACAW,EACAO,CACF,EAGIE,EAAe;AAAA;AAAA,gFAGbC,EAAgB,CAACjD,EAAS,UAAW4B,EAAM,EAAE,EAEnDkB,EAAsB,QAAQ,CAACN,EAAiBC,IAAwB,CACtE,IAAMS,EAAcH,EAAY,IAAIN,CAAW,EAE/CD,EAAS,QAASG,GAAY,CAK5B,GAJI,CAACA,EAAQ,SAIT,CAACO,GAAa,iBAAmB,CAACA,GAAa,WACjD,OAGF,IAAMC,EAAiB,KAAK,kBAAkBxB,EAAiBgB,CAAO,EACtE,GAAI,CAACQ,EACH,OAGFF,EAAc,KAAKE,CAAc,EACjC,IAAMC,EAAc,IAAIH,EAAc,MAAM,GAE5CA,EAAc,KAAKC,EAAY,eAAe,EAC9C,IAAMG,EAAqB,IAAIJ,EAAc,MAAM,GAEnDA,EAAc,KAAKN,EAAQ,IAAI,OAAS,IAAM,GAAG,EACjD,IAAMW,EAAkB,IAAIL,EAAc,MAAM,GAEhDA,EAAc,KAAKN,EAAQ,IAAI,OAASd,EAAa,UAAY,SAAS,EAC1E,IAAM0B,EAAiB,IAAIN,EAAc,MAAM,GAE/CA,EAAc,KAAKN,EAAQ,IAAI,OAASd,EAAa,QAAUqB,EAAY,UAAU,EACrF,IAAMM,EAAe,IAAIP,EAAc,MAAM,GAE7CA,EAAc,KAAK,QAAUN,EAAQ,IAAI,EAAE,EAC3C,IAAMc,EAAe,IAAIR,EAAc,MAAM,GAE7CA,EAAc,KAAKN,EAAQ,gBAA0B,EACrD,IAAMe,EAAuB,IAAIT,EAAc,MAAM,GAErDD,GAAgB,IAAII,CAAW,KAAKA,CAAW,aAAaC,CAAkB,KAAKC,CAAe;AAAA,oBAC5FC,CAAc,IAAIC,CAAY,IAAIC,CAAY,kBAAkBC,CAAoB,mBAAmBA,CAAoB,KACnI,CAAC,CACH,CAAC,EACGT,EAAc,OAAS,IACrBD,EAAa,MAAM,EAAE,IAAM,MAC7BA,EAAeA,EAAa,MAAM,EAAG,EAAE,GAEzClB,IAA0B,MAAM7B,EAAS,MAAM+C,EAAcC,CAAa,IAAI,UAAY,EAE9F,CACAJ,EAAgB,KAAK,gBAAgBd,EAAiBa,CAAS,CACjE,CAEA,KAAK,sBAAsBjD,CAAQ,EACnC,KAAK,8BAA8BA,CAAQ,EAE3C,IAAMgE,EAA4B,CAChC,GAAG3D,EACH,WAAY,MAAM,QAAQA,EAAS,UAAU,EAAIA,EAAS,WAAW,IAAK4D,GAAU,OAAOA,CAAK,CAAC,EAAI,CAAC,CACxG,EAEA,YAAK,sBAAsBjE,EAAUgE,CAAY,EAE1C7B,CACT,OAASV,EAAO,CACd,KAAK,OAAO,MAAM,qCAAqCA,EAAM,SAAS,CAAC,EAAE,EAEzE,KAAK,sBAAsBzB,CAAQ,EACnC,KAAK,8BAA8BA,CAAQ,CAC7C,CACF,CAEA,MAAa,8BACXK,EACA4B,EACAW,EACAO,EACmC,CACnC,IAAM7C,EAAWC,GAAe,sBAAsB,EAEhD2D,EAAa,CAAC7D,EAAS,UAAW4B,EAAM,EAAE,EAmB1CkC,EAAkB;AAAA;AAAA;AAAA;AAAA,qBAlBA,MAAM,KAAKhB,EAAsB,KAAK,CAAC,EAC5D,IAAKL,GAAgB,CACpB,IAAMsB,EAAuBxB,EAA0B,IAAIE,CAAW,EAEtE,GAAIsB,EAAsB,CACxBF,EAAW,KAAKpB,CAAW,EAC3B,IAAIuB,EAAU,KAAKH,EAAW,MAAM,IAEpC,OAAAA,EAAW,KAAKE,EAAqB,KAAK,EAC1CC,GAAW,IAAIH,EAAW,MAAM,IAEhCA,EAAW,KAAKE,EAAqB,IAAI,EAClC,GAAGC,CAAO,IAAIH,EAAW,MAAM,GACxC,CACF,CAAC,EACA,KAAK,GAAG,CAOqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iEAwD1BI,EAAkB,MAAMhE,EAAS,MAAM6D,EAAiBD,CAAU,EAExE,OAAO,IAAI,IAAII,EAAgB,KAAK,IAAKC,GAAsB,CAACA,EAAK,aAAcA,CAAI,CAAC,CAAC,CAC3F,CAEA,MAAa,gBAAgBlE,EAAgD,CAC3E,GAAI,CAOF,OAAQ,MANSE,GAAe,sBAAsB,EAM/B,MAJP;AAAA;AAAA,yCAIsB,CAACF,EAAS,KAAK,CAAC,IAAI,KAAK,CAAC,GAAK,EACvE,OAASoB,EAAO,CACd,KAAK,OAAO,MAAM,6BAA6BA,EAAM,SAAS,CAAC,EAAE,CACnE,CACF,CAEO,+BAA+BoB,EAA6C,CACjF,OAAOA,EAAS,OAAO,CAAC2B,EAA6BxB,IAAqB,CACxE,IAAMyB,EAAMzB,GAAS,IAGrB,GAAI,CAAC,KAAK,oBAAoByB,GAAK,SAAS,EAAG,CAC7C,IAAM3B,EAAc2B,GAAK,WAAW,MAAM,GAAG,EAAE,CAAC,EAChD,GAAI3B,EAAa,CACf,IAAM4B,EAAkB,IAAI5B,CAAW,GACjCD,EAAW2B,EAAI,IAAIE,CAAe,EAAIF,EAAI,IAAIE,CAAe,EAAI,CAAC,EACxE7B,EAAS,KAAKG,CAAO,EACrBwB,EAAI,IAAIE,EAAiB7B,CAAQ,CACnC,CACF,CAEA,OAAO2B,CACT,EAAG,IAAI,GAAK,CACd,CAEA,MAAa,sCACXvC,EACA5B,EACAsE,EAAQ,GAC6D,CACrE,GAAI,CAWF,OAAQ,MAVSpE,GAAe,sBAAsB,EAU/B,MARX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAQsB,CAACF,EAAS,UAAW4B,EAAM,GAAI0C,CAAK,CAAC,IAAI,IAC7E,OAASlD,EAAO,CACd,KAAK,OAAO,MAAM,sCAAsCA,EAAM,SAAS,CAAC,EAAE,CAC5E,CACF,CAEO,kBAAkBO,EAAkC4C,EAAsB,CAC/E,IAAMpB,EAAiBxB,EAAgB,uBAAuB4C,EAAI,OAAO,EACzE,GAAIpB,EACF,OAAOA,EAGT,GAAI,CAACqB,EAAc,IAAc,UAAU,EAAE,OAAO,0BAClD,MAAO,GAGT,IAAMC,EAAQ,CACZ,gBAAiBF,EAAI,QAAQ,gBAC7B,2BAA4BA,EAAI,QAAQ,4BAA4B,SAAS,gBAC7E,aAAcA,EAAI,QAAQ,aAC1B,aAAcA,EAAI,QAAQ,aAC1B,aAAcA,EAAI,QAAQ,aAC1B,eAAgBA,EAAI,QAAQ,eAC5B,gBAAiBA,EAAI,QAAQ,iBAAiB,kBAAkB,mBAClE,EAGA,OAFgB,OAAO,KAAKE,CAAK,EAAE,KAAML,GAAQK,EAAML,CAAG,IAAM,MAAS,EAExD,CACf,IAAK,kBACH,MAAO,WAAWG,EAAI,QAAQ,gBAAgB,QAAQ,GACpDA,EAAI,QAAQ,gBAAgB,QAAU,IAAIA,EAAI,QAAQ,gBAAgB,OAAO,GAAK,EACpF,KAEF,IAAK,6BACH,MAAO,WAAWA,EAAI,QAAQ,2BAA2B,QAAQ,gBAAgB,QAAQ,GACvFA,EAAI,QAAQ,2BAA2B,QAAQ,gBAAgB,QAC3D,IAAIA,EAAI,QAAQ,2BAA2B,QAAQ,gBAAgB,OAAO,GAC1E,EACN,KAEF,IAAK,kBACH,OAAOA,EAAI,QAAQ,gBAAgB,iBAAiB,kBAChD,IAAIA,EAAI,QAAQ,gBAAgB,iBAAiB,iBAAiB,OAClE,GAAKA,EAAI,QAAQ,gBAAgB,iBAAiB,oBAExD,IAAK,eACH,MAAO,oBAET,IAAK,eACH,MAAO,oBAET,IAAK,eACH,MAAO,oBAET,IAAK,iBACH,MAAO,sBAET,QACE,MAAO,EACX,CACF,CAEO,gBAAgBG,EAAYC,EAAmB,CACpD,OAAOD,EAAI,OAAO,EAAGC,CAAS,CAChC,CAEO,QAAQC,EAAmB,CAChC,OAAOA,EAAU,SAAS,OAAO,CACnC,CAEO,oBAAoBA,EAAmB,CAC5C,OAAO,KAAK,QAAQA,CAAS,GAAKA,IAAc,oBAAsBA,IAAc,kBACtF,CAEO,sBAAsBC,EAA4BrD,EAAkB,CAKzE,OAJiBtB,GAAe,sBAAsB,EAItC,MAFJ,wGAEe,CAAC,QAAQsB,CAAQ,GAAIqD,CAAS,CAAC,CAC5D,CACF,EAEaC,EAAiB,IAAIrF,GCpiBlC,OAAOsF,OAQA,uBACP,OAAS,WAAWC,OAAuB,yCCnB3C,OAAOC,OAAQ,KACf,OAAOC,OAAa,UACpB,OAAOC,OAAU,OAEjB,IAAMC,GAAY,CAAC,KAAM,QAAS,IAAI,EAChCC,GAAmBC,GAAK,KAAK,UAAW,cAAc,EACtDC,GAA+B,IAAIC,GAEnCC,GAAiB,CAAC,EAExBL,GAAU,QAASM,GAAa,CAC9B,IAAMC,EAAeL,GAAK,KAAKD,GAAkB,GAAGK,CAAQ,OAAO,EAC/DE,GAAG,WAAWD,CAAY,IAC5BF,GAAUC,CAAQ,EAAI,CACpB,YAAaG,GAAQF,CAAY,CACnC,EAEJ,CAAC,EAEDG,GAAQ,KAAK,CACX,UAAAL,GACA,YAAa,KACb,IAAKF,GAAc,IAAc,UAAU,EAC3C,MAAO,GAEP,cAAe,CACb,YAAa,EACf,CACF,CAAC,EACD,IAAOQ,EAAQD,GC9Bf,OAAOE,OAAW,QAClB,OAAOC,OAAQ,KAEf,IAAMC,GAAc,KAAK,MAAMD,GAAG,aAAa,iBAAkB,MAAM,CAAC,EAQ3DE,EAAgB,MAAOC,GAAiC,CAOnE,GAJI,EAFY,QAAQ,IAAI,oBAAsB,QAAa,QAAQ,IAAI,oBAAsB,SAM7FA,IAAU,IACZ,OAGF,IAAMC,EAA2B,CAC/B,MAAAD,EACA,WAAY,GAAGF,GAAY,OAAO,GAClC,UAAW,IAAI,IACjB,EAEMI,EACJ,QAAQ,IAAI,eAAiB,QAAQ,IAAI,gBAAkB,GACvD,QAAQ,IAAI,cACZ,0CAENN,GACG,KAAKM,EAAKD,CAAS,EACnB,KAAK,IAAM,CAAC,CAAC,EACb,MAAM,IAAM,CAAC,CAAC,CACnB,EFbA,OAAOE,OAAW,QAElB,OAAOC,OAAW,QAClB,OAAOC,OAAc,YACrB,OAAOC,OAAU,OACjB,OAAOC,OAAU,OACjB,OAAOC,OAAe,aACtB,OAAOC,OAAU,OACjB,OAAS,YAAAC,OAAgB,SAUlB,IAAMC,GAAN,KAAsB,CAK3B,YACmBC,EACAC,EACAC,EACAC,EACjB,CAJiB,eAAAH,EACA,mBAAAC,EACA,sBAAAC,EACA,WAAAC,EARnB,KAAiB,OAAS,IAAIC,EAAO,iBAAiB,EAWtD,KAAQ,SAAWC,GAAe,sBAAsB,CAFrD,CAIH,MAAc,YAAYC,EAAsD,CAC9E,IAAMC,EAAW,GAAGD,EAAS,YAAY,eACzC,GAAI,MAAM,KAAK,MAAM,IAAIC,CAAQ,EAG/B,OAFkB,MAAM,KAAK,MAAM,IAAIA,CAAQ,EAKjD,IAAMC,EAAW,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,GAAG,aAAa,EAEvF,OAAKE,GAKL,KAAK,MAAM,IAAID,EAAUC,CAAQ,EAE1BA,IANL,KAAK,OAAO,KAAK,oBAAoB,EAC9B,KAMX,CAEA,MAAc,SAASF,EAAuB,CAC5C,IAAME,EAAW,MAAM,KAAK,YAAYF,CAAQ,EAEhD,OAAKE,GAKL,KAAK,SAAWA,EAED,IAAIC,GAAe,CAChC,OAAQ,KAAK,kBAAkB,CACjC,CAAC,IARC,KAAK,OAAO,MAAM,oBAAoB,EAC/B,KAUX,CAEO,mBAA6F,CAClG,MAAO,CACL,SAAU,KAAK,SAAS,IACxB,iBAAkB,GAClB,YAAa,UACb,MAAO,KAAK,SAAS,MACrB,UAAW,KAAK,SAAS,UACzB,oBAAqB,KAAK,SAAS,mBACrC,CACF,CAEO,UAAW,CAChB,OAAO,KAAK,KACd,CAEA,MAAa,OAAOH,EAAuBI,EAAmB,CAG5D,GAFA,MAAM,KAAK,UAAU,YAAYJ,EAAS,YAAY,EAAE,YAAYI,CAAI,EAEpEA,EAAK,WAAY,CACnB,KAAK,OAAO,IAAI,+BAA+B,EAC/C,IAAMC,EAAY,KAAK,cAAc,IAAgB,QAAQ,EAAE,IAE/D,MAAM,KAAK,qBACTL,EACAI,EAAK,WAAaJ,EAAS,aAAa,MAAM,QAAQ,EAAE,CAAC,EACzD,GAAGK,CAAS,qBAAqB,mBAAmBL,EAAS,YAAY,CAAC,GAC1E,GACAI,EAAK,OACLA,EAAK,aACLA,EAAK,IACP,CACF,CACA,OAAOA,CACT,CAEA,MAAa,KAAKJ,EAA6C,CAC7D,GAAI,CACF,OAAO,MAAM,KAAK,UAAU,YAAYA,EAAS,YAAY,EAAE,aAAa,CAC9E,MAAgB,CACd,YAAK,OAAO,MAAM,oBAAoB,EAC/B,CAAE,QAAS,KAAM,IAAK,EAAG,CAClC,CACF,CAEA,MAAa,WAAWA,EAAuBM,EAAY,CACzD,IAAMC,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,GAAI,CAACD,EACH,YAAK,OAAO,KAAK,gBAAgB,EAC1B,KAGT,IAAME,EAAU,MAAMD,EAAO,QAAQ,eAAe,CAClD,UAAW,KAAK,SAAS,UACzB,GAAAD,CACF,CAAC,EAED,OAAKE,IACH,KAAK,OAAO,KAAK,mBAAmB,EAC7B,KAIX,CAEA,MAAa,qBACXR,EACAS,EACAC,EACAC,EACAC,EACAC,EACAC,EACA,CACA,IAAMP,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAMQ,EAAiB,MAAMR,EAAO,QAAQ,KAAK,CAC/C,UAAW,KAAK,SAAS,SAC3B,CAAC,EAEKS,EAAiBD,EAAU,QAAQ,IAAKE,GAAUA,EAAM,IAAI,EAAE,SAASR,CAAS,EAElFS,EAGJ,GADA,KAAK,OAAO,IAAI,yBAAyB,EACpCF,EAoBE,CACL,IAAMC,EAAQF,EAAU,QAAQ,KAAME,GAAUA,EAAM,OAASR,CAAS,EAExE,GAAI,CAACQ,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGTC,EAAUD,EAAM,EAClB,KA7BqB,CACnB,IAAMb,EAAO,CACX,KAAM,MACN,YAAaM,CACf,EAEMO,EAAQ,MAAMV,EAAO,QAAQ,OAAO,CACxC,UAAW,KAAK,SAAS,UACzB,KAAM,CACJ,KAAME,EACN,QAASL,CACX,CACF,CAAC,EAED,GAAI,CAACa,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGTC,EAAUD,EAAM,EAClB,CAYA,GAFA,KAAK,OAAO,IAAI,4BAA4BC,CAAO,EAAE,EAEjD,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,YAChD,YAAK,OAAO,IAAI,kCAAkC,EAE3C,GAGT,KAAK,OAAO,IAAI,+BAA+B,EAC/C,IAAMV,EACH,MAAM,KAAK,YAAYR,EAAU,QAAQ,GACxC,MAAM,KAAK,cACXA,EACA,SACAkB,EACA,GACAL,GAA8B,eAC9BC,GAAc,2DAChB,EAEF,GAAI,CAACN,EACH,YAAK,OAAO,KAAK,mBAAmB,EAC7B,KAGT,IAAMW,EAAYX,EAAQ,IAAMA,EAAQ,QAAQ,QAAQ,GAGxD,GAFA,KAAK,OAAO,IAAI,gCAAgCW,CAAS,EAAE,EAEvDR,EAAQ,CACV,KAAK,OAAO,IAAI,iBAAiB,EACjC,IAAMP,EAAO,CACX,WAAYe,EAAU,SAAS,EAC/B,SAAUD,EAAQ,SAAS,CAC7B,EAEME,EAAe,MAAMb,EAAO,cAAc,OAAO,CACrD,UAAW,KAAK,SAAS,UACzB,KAAAH,CACF,CAAC,EAED,GAAI,CAACgB,EACH,YAAK,OAAO,KAAK,wBAAwB,EAClC,KAGT,IAAIC,EAAa,OAejB,GAbIT,IACFS,EAAa,QAAQT,CAAM,IAYzB,CATY,MAAML,EAAO,SAAS,OAAO,CAC3C,UAAW,KAAK,SAAS,UACzB,eAAgBa,EAAa,GAC7B,KAAM,CACJ,QAASC,EACT,aAAc,UAChB,CACF,CAAC,EAGC,YAAK,OAAO,KAAK,wBAAwB,EAClC,KAET,KAAK,OAAO,IAAI,mBAAmB,CACrC,CAEA,MAAO,EACT,CAEA,MAAa,cACXrB,EACAsB,EACAJ,EACAK,EACAC,EACAC,EACAC,EACA,CACA,IAAMnB,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAIH,EAAY,CAAC,EACZmB,EAYHnB,EAAO,CACL,SAAUc,EACV,KAAMM,GAAQF,EACd,WAAYA,EACZ,WAAYG,CACd,GAhBArB,EAAO,CACL,SAAUc,EACV,KAAMM,GAAQF,EACd,WAAYI,EACZ,WAAYD,CACd,GAEKC,GAAOA,EAAI,SAAS,GAAG,GAAM,CAACA,KACjCtB,EAAK,aAAkB,IAAIkB,CAAW,KAW1C,IAAMd,EAAU,MAAMD,EAAO,SAAS,OAAO,CAC3C,UAAW,KAAK,SAAS,UACzB,KAAAH,CACF,CAAC,EAED,GAAI,CAACI,EACH,YAAK,OAAO,KAAK,mBAAmB,EAC7B,KAKT,IAAMW,GAFc,MAAM,KAAK,YAAYnB,EAAUsB,CAAW,IAEjC,GAE/B,aAAM,KAAK,kBAAkB,KAAK,SAAS,UAAWH,CAAS,EAExDX,CACT,CAEA,MAAa,cAAcR,EAAuBM,EAAYF,EAAW,CACvE,IAAMG,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,GAAI,CAACD,EACH,YAAK,OAAO,KAAK,gBAAgB,EAC1B,KAGT,GAAI,CAOF,OANgB,MAAMC,EAAO,SAAS,OAAO,CAC3C,UAAW,KAAK,SAAS,UACzB,GAAAD,EACA,KAAAF,CACF,CAAC,CAGH,MAAgB,CACd,OAAO,IACT,CACF,CAEA,MAAa,kBAAkBuB,EAAmBR,EAAmB,CACnE,GAAI,CAGF,GAAI,CAFQ,KAAK,cAAc,IAAc,UAAU,EAAE,OAAO,SAAS,WAAW,IAE1E,MAAO,GAGjB,IAAMS,GAAW,MAAM,KAAK,SAAS,MADrB,8DACoC,CAACD,CAAS,CAAC,IAAI,KAAK,CAAC,EACrEE,EAAQD,GAAS,GACfE,EAAgBF,GAAS,gBAAkB,EAQjD,OAAAC,GAAS,MAAM,KAAK,SAAS,MANd;AAAA;AAAA;AAAA;AAAA,oCAM4B,CAACF,EAAWG,EAAgB,CAAC,CAAC,IAAI,KAAK,CAAC,GAAG,IAK/D,MAAM,KAAK,SAAS,MAHnB;AAAA,oIAG0C,CAACD,EAAOV,CAAS,CAAC,IAAI,SAAW,GAMjG,MAAM,KAAK,SAAS,MAHG;AAAA,6EAGmB,CAACU,EAAOV,CAAS,CAAC,EAGvD,EACT,MAAgB,CACd,MAAO,EACT,CACF,CAEA,MAAa,YAAYnB,EAAuBsB,EAAqB,CACnE,IAAMf,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAIwB,EACER,EAAUD,EAAY,SAAS,OAAO,EAEvCC,EAGHQ,EAAQT,EAFRS,EAAQ,IAAIT,CAAW,GAKzB,IAAId,EAiBJ,OAfIe,EACFf,EAAU,MAAMD,EAAO,SAAS,OAAO,CACrC,UAAW,KAAK,SAAS,UACzB,EAAGwB,CACL,CAAC,EAEDvB,EAAU,MAAMwB,GAAgB,KAAK,kBAAkB,EAAG,CACxD,OAAQ,OACR,IAAK,oBAAoB,KAAK,SAAS,SAAS,mBAChD,KAAM,CACJ,QAAS,KAAK,iBAAiBD,CAAK,CACtC,CACF,CAAC,EAGC,CAACvB,GAAWA,GAAS,SAAS,SAAW,GAC3C,KAAK,OAAO,KAAK,mBAAmB,EAC7B,MAGJe,EAGIf,EAAQ,QAAQ,KAAMA,GAAYA,EAAQ,aAAeuB,CAAK,EAF9DvB,EAAQ,QAAQ,OAAS,EAAI,KAAK,yBAAyBA,EAAQ,QAASuB,CAAK,EAAIvB,EAAQ,QAAQ,CAAC,CAIjH,CAEA,MAAc,uBAAuByB,EAAiB,CACpD,GAAI,CAUF,OATgB,MAAMD,GAAgB,KAAK,kBAAkB,EAAG,CAC9D,OAAQ,OACR,IAAK,oBAAoB,KAAK,SAAS,SAAS,yBAChD,KAAM,CACJ,gBAAiBC,EAAS,KAAMzB,GAAYA,EAAQ,aAAa,SAAW,EAAE,GAAG,GACjF,kBAAmByB,EAAS,KAAMzB,GAAYA,EAAQ,aAAa,SAAW,EAAE,GAAG,EACrF,CACF,CAAC,CAGH,MAAQ,CACN,YAAK,OAAO,MAAM,wBAAwB,EACnC,IACT,CACF,CAEQ,yBAAyByB,EAAiBF,EAAe,CAC/D,IAAMG,EAAe,KAAK,WAAWH,CAAK,EACpCI,EAAmB,KAAK,oBAAoB,EAGlD,GAAIF,EAAS,SAAW,GAAK,KAAK,kBAAkB,EAAE,qBAAuBF,EAAM,WAAW,KAAK,EAAG,CACpG,IAAMvB,EAAU,KAAK,uBAAuByB,CAAQ,EACpD,GAAIzB,EACF,OAAOA,CAEX,CAEA,IAAM4B,EAAQF,EAAa,OACzB,CAACG,EAAazB,IAAYA,EAAO,OAASyB,EAAY,OAASzB,EAASyB,EACxE,EACF,EAEMC,EAAgBL,EAAS,KAAMzB,GAAYA,EAAQ,eAAiB4B,CAAK,EAC/E,GAAIE,EACF,OAAOA,EAGT,QAAW9B,KAAWyB,EACpB,QAAWM,KAASJ,EAClB,GAAI3B,EAAQ+B,CAAK,GAAKL,EAAa,SAAS1B,EAAQ+B,CAAK,CAAC,EACxD,OAAO/B,EAKb,OAAO,IACT,CAEQ,WAAWuB,EAAe,CAChC,IAAMS,EAAU,CAAC,EAGjB,GAFAA,EAAQ,KAAKT,CAAK,EAEdA,EAAM,WAAW,KAAK,GAAKA,EAAM,SAAW,GAAI,CAClD,IAAMU,EAAcV,EAAM,MAAM,EAAG,CAAC,EAAIA,EAAM,MAAM,CAAC,EACrDS,EAAQ,KAAKC,CAAW,CAC1B,SAAWV,EAAM,WAAW,KAAK,GAAKA,EAAM,SAAW,GAAI,CACzD,IAAMW,EAAWX,EAAM,MAAM,EAAG,CAAC,EAAI,IAAMA,EAAM,MAAM,CAAC,EACxDS,EAAQ,KAAKE,CAAQ,CACvB,CAEA,OAAOF,CACT,CAEQ,qBAAsB,CAC5B,MAAO,CAAC,cAAc,CACxB,CAEQ,iBAAiBT,EAAe,CACtC,IAAMY,EAAgB,CAAC,EAEjBH,EAAU,KAAK,WAAWT,CAAK,EAC/Ba,EAAiB,KAAK,oBAAoB,EAEhD,OAAAA,EAAe,QAAQ,CAACL,EAAOM,IAAW,CACxCL,EAAQ,QAAQ,CAAC5B,EAAQkC,IAAW,CAClC,IAAMC,EAAgBH,EAAe,OAAS,IAAMC,GAAUL,EAAQ,OAAS,IAAMM,EAAS,KAAO,KACrGH,EAAc,KAAK,CACjB,cAAeJ,EACf,gBAAiB,WACjB,OAAQ,CAAC3B,EAAO,QAAQ,IAAK,EAAE,CAAC,EAChC,eAAgBmC,CAClB,CAAC,CACH,CAAC,CACH,CAAC,EAEMJ,CACT,CAEA,MAAa,mBAAmB3C,EAAuBgD,EAAW,CAChE,GAAI,CACF,KAAK,OAAO,QAAQ,kCAAkC,EACtD,KAAK,OAAO,QAAQ,aAAa,KAAK,UAAUhD,CAAQ,CAAC,EAAE,EAE3D,IAAMO,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kCAAkC,KAAK,UAAUP,CAAQ,CAAC,EAAE,EACtE,KAGT,IAAMC,EAAW,GAAGD,EAAS,YAAY,uBAAuBgD,EAAK,IAAI,SAAS,GAGlF,GAFA,KAAK,OAAO,QAAQ,cAAc/C,CAAQ,EAAE,EAExC,MAAM,KAAK,MAAM,IAAIA,CAAQ,EAAG,CAClC,KAAK,OAAO,QAAQ,sBAAsBA,CAAQ,EAAE,EACpD,IAAMgD,EAAkB,MAAM,KAAK,MAAM,IAAIhD,CAAQ,EACrD,KAAK,OAAO,QAAQ,2BAA2BgD,CAAc,EAAE,EAC/D,IAAIC,EACJ,GAAI,CACFA,EAAqB,MAAM3C,EAAO,cAAc,IAAI,CAClD,UAAW,KAAK,SAAS,UACzB,eAAgB0C,CAClB,CAAC,EACD,KAAK,OAAO,QAAQ,wBAAwB,KAAK,UAAUC,CAAkB,CAAC,EAAE,CAClF,OAASC,EAAO,CACd,KAAK,OAAO,MAAM,+BAA+BA,CAAK,EAAE,EACxDD,EAAqB,EACvB,CACA,OAAKA,EAMED,GALL,KAAK,OAAO,QAAQ,4DAA4D,EAChF,KAAK,MAAM,OAAOhD,CAAQ,EACnB,MAAM,KAAK,mBAAmBD,EAAUgD,CAAI,EAIvD,CAEA,IAAMzB,EAAUyB,EAAK,IAAI,UAAU,SAAS,OAAO,EACnD,KAAK,OAAO,QAAQ,aAAazB,CAAO,EAAE,EAE1C,IAAM6B,EAAS7B,EAAUyB,EAAK,IAAI,UAAYA,EAAK,IAAI,UAAU,MAAM,GAAG,EAAE,CAAC,EAC7E,KAAK,OAAO,QAAQ,YAAYI,CAAM,EAAE,EAExC,IAAIC,EAEJA,EAAeL,EAAK,IAAI,OAAyBI,EAAhBJ,EAAK,SACtC,KAAK,OAAO,QAAQ,iBAAiBK,CAAW,EAAE,EAElD,IAAMC,EAAc,MAAM,KAAK,SAAStD,CAAQ,EAEhD,GAAI,CAACsD,EACH,YAAK,OAAO,KAAK,iCAAiC,KAAK,UAAUtD,CAAQ,CAAC,EAAE,EACrE,KAGT,GAAIuB,EAAS,CACX,KAAK,OAAO,QAAQ,+BAA+B,EACnD,IAAMgC,EAAQ,MAAM,KAAK,UAAU,YAAYvD,EAAS,YAAY,EAAE,OAAO,cAAcoD,CAAM,EACjG,KAAK,OAAO,QAAQ,mBAAmB,KAAK,UAAUG,CAAK,CAAC,EAAE,EAE9DF,EAAc,GAAGE,EAAM,OAAO,WAE9B,IAAMC,EAAc,MAAM,KAAK,UAAU,YAAYxD,EAAS,YAAY,EAAE,eAC1EgD,EAAK,IAAI,YAAY,MAAM,GAAG,EAAE,CAAC,CACnC,EACA,KAAK,OAAO,QAAQ,oCAAoC,KAAK,UAAUQ,CAAW,CAAC,EAAE,EAErF,IAAMC,EAAkB,MAAM,KAAK,YAAYzD,EAAUgD,EAAK,IAAI,YAAY,MAAM,GAAG,EAAE,CAAC,CAAC,EAC3F,KAAK,OAAO,QAAQ,sBAAsB,KAAK,UAAUS,CAAe,CAAC,EAAE,EAEvEA,GACE,CAACA,EAAgB,MAAQA,EAAgB,OAASL,IACpD,MAAM,KAAK,cAAcpD,EAAUyD,EAAgB,GAAI,CACrD,KAAMT,EAAK,SACX,WAAYQ,EAAY,mBAAqB,IAC/C,CAAC,EAGH,MAAM,KAAK,cACTxD,EACAgD,EAAK,IAAI,YAAY,MAAM,GAAG,EAAE,CAAC,EACjCM,EAAY,GACZ,GACAN,EAAK,SACLQ,EAAY,mBAAqB,KACjCR,EAAK,IAAI,WACX,CAEJ,CAEA,IAAMQ,EAAc,MAAM,KAAK,UAAU,YAAYxD,EAAS,YAAY,EAAE,eAAeoD,CAAM,EACjG,KAAK,OAAO,QAAQ,gCAAgC,KAAK,UAAUI,CAAW,CAAC,EAAE,EAEjF,IAAIhD,EAAU,MAAM,KAAK,YAAYR,EAAUoD,CAAM,EAGrD,GAFA,KAAK,OAAO,QAAQ,kBAAkB,KAAK,UAAU5C,CAAO,CAAC,EAAE,EAE3DA,GACF,GAAI,CAACwC,EAAK,IAAI,OAAQ,CACpB,IAAMU,EACJF,GAAa,mBAAmB,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,IAAI,GAAK,GAC5EG,EAA6BnD,GAAS,WAAW,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAAE,MAAM,GAAG,EAAE,IAAI,GAAK,GACjGoD,EAAqBF,IAAyBC,EAC9CE,EACJ,CAACrD,EAAQ,MACTA,EAAQ,OAAS4C,IAChB,IAAIA,CAAM,GAAG,WAAW,KAAK,EAC1B,KAAK,WAAW,IAAIA,CAAM,EAAE,EAAE,KAC3BU,GAAMtD,EAAQ,OAASsD,GAAKtD,EAAQ,OAASsD,EAAE,UAAU,CAAC,GAAKtD,EAAQ,OAASsD,EAAE,UAAU,CAAC,CAChG,EACA,IAEN,KAAK,OAAO,QAAQ,yBAAyBF,CAAkB,EAAE,EACjE,KAAK,OAAO,QAAQ,sBAAsBC,CAAe,EAAE,GAEvDD,GAAsBC,KACxBrD,EAAU,MAAM,KAAK,cAAcR,EAAUQ,EAAQ,GAAI,CACvD,GAAIqD,GAAmB,CAAE,KAAMR,CAAY,EAC3C,GAAIK,IAAyB,IAAM,CAAE,OAAQ,IAAK,EAClD,GAAIE,GAAsB,CAAE,WAAYJ,GAAa,iBAAkB,CACzE,CAAC,EAEL,MACK,CACL,IAAM9B,EAAMsB,EAAK,IAAI,UACrBxC,EAAU,MAAM,KAAK,cACnBR,EACAoD,EACAE,EAAY,GACZ/B,EACA8B,EACAG,EAAY,mBAAqB,KACjC9B,CACF,CACF,CAEA,GAAI,CAAClB,EACH,YAAK,OAAO,KAAK,8BAA8B,EACxC,KAGT,IAAMW,EAAYX,GAAS,SAAS,IAAMA,GAAS,SAAS,SAAS,IAAMA,GAAS,GACpF,KAAK,OAAO,QAAQ,eAAeW,CAAS,EAAE,EAE9C,IAAM4C,EAAwB,MAAMxD,EAAO,SAAS,kBAAkB,CACpE,UAAW,KAAK,SAAS,UACzB,GAAIY,CACN,CAAC,EAGD,GAFA,KAAK,OAAO,QAAQ,0BAA0B,KAAK,UAAU4C,CAAoB,CAAC,EAAE,EAEhF,CAACA,GAAwB,CAACA,EAAqB,QACjD,YAAK,OAAO,MAAM,gDAAgD,EAC3D,KAGT,GAAIA,EAAqB,QAAQ,OAAQ,CACvC,IAAI3C,EAuBJ,GAtBI,KAAK,SAAS,oBAChBA,EAAe2C,EAAqB,QAAQ,KAAM3C,GAAiBA,EAAa,UAAYkC,EAAY,EAAE,EAC1G,KAAK,OAAO,QAAQ,kDAAkD,KAAK,UAAUlC,CAAY,CAAC,EAAE,EAEhG,KAAK,SAAS,qBAAuBA,EAAa,SAAW,QAC3DA,GACF,MAAMb,EAAO,cAAc,aAAa,CACtC,UAAW,KAAK,SAAS,UACzB,eAAgBa,EAAa,GAC7B,KAAM,CACJ,OAAQ,SACV,CACF,CAAC,IAILA,EAAe2C,EAAqB,QAAQ,KACzC3C,GAAiBA,EAAa,SAAW,YAAcA,EAAa,UAAYkC,EAAY,EAC/F,EACA,KAAK,OAAO,QAAQ,uBAAuB,KAAK,UAAUlC,CAAY,CAAC,EAAE,GAGvEA,EACF,YAAK,OAAO,QAAQ,uCAAuCA,EAAa,EAAE,EAAE,EAC5E,KAAK,MAAM,IAAInB,EAAUmB,EAAa,EAAE,EACjCA,EAAa,EAExB,CAEA,IAAMhB,EAAO,CACX,WAAYe,EAAU,SAAS,EAC/B,SAAUmC,EAAY,GAAG,SAAS,CACpC,EAEI,KAAK,SAAS,sBAChBlD,EAAK,OAAY,WAGnB,IAAMgB,EAAe,MAAMb,EAAO,cAAc,OAAO,CACrD,UAAW,KAAK,SAAS,UACzB,KAAAH,CACF,CAAC,EAED,OAAKgB,GAKL,KAAK,OAAO,QAAQ,qCAAqCA,EAAa,EAAE,EAAE,EAC1E,KAAK,MAAM,IAAInB,EAAUmB,EAAa,EAAE,EACjCA,EAAa,KANlB,KAAK,OAAO,KAAK,mCAAmC,EAC7C,KAMX,OAAS+B,EAAO,CACd,KAAK,OAAO,MAAM,gCAAgCA,CAAK,EAAE,CAC3D,CACF,CAEA,MAAa,SAASnD,EAA8C,CAClE,IAAMC,EAAW,GAAGD,EAAS,YAAY,YACzC,GAAI,MAAM,KAAK,MAAM,IAAIC,CAAQ,EAC/B,OAAQ,MAAM,KAAK,MAAM,IAAIA,CAAQ,EAGvC,IAAMM,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAMU,EAAS,MAAMV,EAAO,QAAQ,KAAK,CACvC,UAAW,KAAK,SAAS,SAC3B,CAAC,EAED,GAAI,CAACU,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGT,IAAM+C,EAAa/C,EAAM,QAAQ,KAAMA,GAAUA,EAAM,OAAS,KAAK,kBAAkB,EAAE,SAAS,EAElG,OAAK+C,GAKL,KAAK,MAAM,IAAI/D,EAAU+D,CAAU,EAC5BA,IALL,KAAK,OAAO,KAAK,iBAAiB,EAC3B,KAKX,CAEA,MAAa,cACXhE,EACAiD,EACAgB,EACAC,EACAC,EACAC,EAKAC,EACAC,EACAC,EACA,CACA,IAAMhE,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAMiE,EAAa,MAAM,KAAK,cAAcH,EAAarE,CAAQ,EAE3DyE,EAAgBF,GAAW,mBAAqB,KAEhDG,EAAU,MAAMnE,EAAO,SAAS,OAAO,CAC3C,UAAW,KAAK,SAAS,UACzB,eAAgB0C,EAChB,KAAM,CACJ,QAASgB,EACT,aAAcC,EACd,YAAaE,EACb,QAASD,GAAkB,GAC3B,UAAWG,EACX,mBAAoB,CAClB,GAAGE,CACL,EACA,gBAAiBC,EAAgBA,EAAc,SAAS,EAAI,IAC9D,CACF,CAAC,EAED,OAAKC,IACH,KAAK,OAAO,KAAK,mBAAmB,EAC7B,KAIX,CAEA,MAAa,6BACX1E,EACAiB,EACAT,EACuB,CACvB,IAAMD,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,OAAKO,GAKkB,MAAMA,EAAO,SAAS,kBAAkB,CAC7D,UAAW,KAAK,SAAS,UACzB,GAAIC,EAAQ,EACd,CAAC,GAGe,QAAQ,KACnBY,GAAiBA,EAAa,WAAaH,EAAM,IAAMG,EAAa,SAAW,MAClF,GAAK,QAZL,KAAK,OAAO,KAAK,kBAAkB,EAC5B,KAaX,CAEA,MAAa,iBACXpB,EACAiE,EACAC,EACAE,EAKA,CACA,IAAM7D,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAMC,EAAU,MAAM,KAAK,YAAYR,EAAU,QAAQ,EAEzD,GAAI,CAACQ,EACH,YAAK,OAAO,KAAK,mBAAmB,EAC7B,KAGT,IAAM8C,EAAc,MAAM,KAAK,SAAStD,CAAQ,EAEhD,GAAI,CAACsD,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGT,IAAMlC,EAAe,MAAM,KAAK,6BAA6BpB,EAAUsD,EAAa9C,CAAO,EAE3F,GAAI,CAACY,EAAc,CACjB,KAAK,OAAO,KAAK,wBAAwB,EACzC,MACF,CAEA,IAAMsD,EAAU,MAAMnE,EAAO,SAAS,OAAO,CAC3C,UAAW,KAAK,SAAS,UACzB,eAAgBa,EAAa,GAC7B,KAAM,CACJ,QAAS6C,EACT,aAAcC,EACd,YAAaE,CACf,CACF,CAAC,EAED,OAAKM,IACH,KAAK,OAAO,KAAK,mBAAmB,EAC7B,KAIX,CAEA,MAAc,SACZzB,EACA0B,EACAC,EACAV,EACAD,EACAjE,EACAqE,EACAC,EACAC,EACA,CACA,GAAID,GAAY,KAAK,yBAAyB,EAAG,CAC/C,IAAMO,EAAsB,MAAMC,EAAe,qBAAqB,CAACR,CAAQ,CAAC,EAChF,GAAIO,GACEA,EAAoB,KAAO,EAC7B,YAAK,OAAO,KAAK,mCAAmC,EAC7C,IAGb,CACA,IAAMzE,EAAO,IAAIjB,GAEb8E,GACF7D,EAAK,OAAO,UAAW6D,CAAO,EAGhC7D,EAAK,OAAO,eAAgB8D,CAAW,EAEvC9D,EAAK,OAAO,gBAAiBuE,EAAY,CAAE,SAAUC,CAAS,CAAC,EAE/D,IAAMH,EAAgBF,GAAW,mBAAqB,KAEtD,GAAIF,GAAerE,EAAU,CAC3B,IAAMwE,EAAa,MAAM,KAAK,cAAcH,EAAarE,CAAQ,EAEjE,GAAIwE,EAAW,aAAeA,EAAW,wBAAyB,CAChE,IAAMP,EAAU,KAAK,UAAU,CAC7B,GAAGO,CACL,CAAC,EACDpE,EAAK,OAAO,qBAAsB6D,CAAO,CAC3C,CACF,CAEIQ,GACFrE,EAAK,OAAO,kBAAmBqE,EAAc,SAAS,CAAC,EAGrDH,GACFlE,EAAK,OAAO,YAAakE,CAAQ,EAGnC,IAAMS,EAAS,CACb,OAAQ,OACR,cAAe,IACf,IAAK,GAAG,KAAK,SAAS,GAAG,oBAAoB,KAAK,SAAS,SAAS,kBAAkB9B,CAAc,YACpG,QAAS,CACP,iBAAkB,KAAK,SAAS,MAChC,GAAG7C,EAAK,WAAW,CACrB,EACA,KAAMA,CACR,EAEA,GAAI,CACF,GAAM,CAAE,KAAAA,CAAK,EAAI,MAAMnB,GAAM,QAAQ8F,CAAM,EAE3C,OAAO3E,CACT,OAAS+C,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAa,YACXnD,EACAiE,EACAC,EACAS,EACAC,EACA,CAGA,GAAI,CAFW,MAAM,KAAK,SAAS5E,CAAQ,EAGzC,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,YAChD,YAAK,OAAO,IAAI,kCAAkC,EAE3C,GAGT,IAAMQ,EAAU,MAAM,KAAK,YAAYR,EAAU,QAAQ,EAEzD,GAAI,CAACQ,EACH,YAAK,OAAO,KAAK,mBAAmB,EAC7B,KAGT,IAAM8C,EAAc,MAAM,KAAK,SAAStD,CAAQ,EAEhD,GAAI,CAACsD,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGT,IAAMlC,EAAe,MAAM,KAAK,6BAA6BpB,EAAUsD,EAAa9C,CAAO,EAE3F,GAAI,CAACY,EAAc,CACjB,KAAK,OAAO,KAAK,wBAAwB,EACzC,MACF,CAEA,IAAMhB,EAAO,IAAIjB,GAEb8E,GACF7D,EAAK,OAAO,UAAW6D,CAAO,EAGhC7D,EAAK,OAAO,eAAgB8D,CAAW,EAEnCS,GAAcC,GAChBxE,EAAK,OAAO,gBAAiBuE,EAAY,CAAE,SAAUC,CAAS,CAAC,EAGjE,IAAMG,EAAS,CACb,OAAQ,OACR,cAAe,IACf,IAAK,GAAG,KAAK,SAAS,GAAG,oBAAoB,KAAK,SAAS,SAAS,kBAAkB3D,EAAa,EAAE,YACrG,QAAS,CACP,iBAAkB,KAAK,SAAS,MAChC,GAAGhB,EAAK,WAAW,CACrB,EACA,KAAMA,CACR,EAEA,GAAI,CACF,GAAM,CAAE,KAAAA,CAAK,EAAI,MAAMnB,GAAM,QAAQ8F,CAAM,EAE3C,OAAO3E,CACT,OAAS+C,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAa,eAAe6B,EAAiBpE,EAAgBqE,EAAYC,EAAkBC,EAAmB,CAC5G,GAAI,CACF,IAAMC,EAAc7F,GAAK,MAAM,mBAAmB0F,CAAK,CAAC,EACpDI,EAAW/F,GAAU,OAAO8F,GAAa,GAAG,GAAK,GACjDR,EAAWQ,GAAa,KAAOA,GAAa,IAEhD,GAAI,CAACC,EAAU,CACb,IAAMC,EAAQL,EAAM,MAAM,GAAG,EAC7BL,EAAW,mBAAmBU,EAAMA,EAAM,OAAS,CAAC,CAAC,EAKrDD,GAHiB,MAAMpG,GAAM,IAAIgG,EAAO,CACtC,aAAc,aAChB,CAAC,GACmB,QAAQ,cAAc,CAC5C,CAEA,IAAIM,EAAO,WAEX,OAAQF,EAAS,MAAM,GAAG,EAAE,CAAC,EAAG,CAC9B,IAAK,QACHE,EAAO,QACP,MACF,IAAK,QACHA,EAAO,QACP,MACF,IAAK,QACHA,EAAO,QACP,MACF,QACEA,EAAO,WACP,KACJ,CAEA,GAAIA,IAAS,QAAS,CACpB,IAAMnF,EAAqB,CACzB,OAAQQ,EACR,MAAOqE,EACP,MAAO,KACP,OAAQE,GAAS,MACnB,EAEA,OAAAK,EAAc,4BAA4B,EAEtB,MAAMR,GAAY,cAAc5E,EAAM,EAAI,CAGhE,CAEImF,IAAS,SAAWH,GAAeA,GAAa,MAAQ,SAC1DG,EAAO,YAGT,IAAMnF,EAAqB,CACzB,OAAQQ,EACR,UAAW2E,EACX,SAAUX,EACV,MAAOK,EACP,MAAO,KACP,OAAQE,GAAS,MACnB,EAEA,OAAAK,EAAc,oBAAoB,EAE9BN,IACF9E,EAAK,QAAU8E,GAGG,MAAMF,GAAY,aAAa5E,EAAM,KAAM,EAAI,CAGrE,OAAS+C,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAa,mBAAmBnD,EAAuBoB,EAAsB+B,EAAa,CACxF,KAAK,OAAO,QAAQ,sBAAsB,KAAK,UAAUA,CAAK,CAAC,EAAE,EAEjE,IAAM5C,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAKO,EAIL,IAAI4C,GAASA,GAAO,SAAW,KAAOA,GAAO,QAAQ,CAAC,GAAG,SAAW,GAAO,CACzE5C,EAAO,SAAS,OAAO,CACrB,UAAW,KAAK,SAAS,UACzB,eAAgBa,EAChB,KAAM,CACJ,QAAS,GAAGqE,EAAQ,EAAE,gCAAgC,CAAC,GACvD,aAAc,WACd,QAAS,EACX,CACF,CAAC,EAED,MACF,CAEAlF,EAAO,SAAS,OAAO,CACrB,UAAW,KAAK,SAAS,UACzB,eAAgBa,EAChB,KAAM,CACJ,QAASqE,EAAQ,EAAE,qBAAsB,CACvC,MAAOtC,EAAQ,IAAIA,EAAM,SAAS,CAAC,IAAM,EAC3C,CAAC,EACD,aAAc,WACd,QAAS,EACX,CACF,CAAC,EACH,CAEA,MAAa,eAAenD,EAAuBgD,EAAW,CAC5D,GAAI,CAKF,GAJA,MAAM,IAAI,QAAS0C,GAAY,WAAWA,EAAS,GAAG,CAAC,EAInD,CAFW,MAAM,KAAK,SAAS1F,CAAQ,EAGzC,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,GACE,KAAK,SAAS,qBAAuB,IACrCgD,EAAK,QAAU,+BACfA,EAAK,SAAW,YAChBA,EAAK,MAAM,QAAQ,WACnB,CACA,IAAM2C,EAAc,GAAG3F,EAAS,YAAY,uBAAuBgD,EAAK,KAAK,OAAO,UAAU,GAC9F,KAAK,MAAM,OAAO2C,CAAW,CAC/B,CAEA,GACE,CAAC3C,GAAM,cACPA,EAAK,SACJA,EAAK,QAAU,mBAAqB,CAACA,EAAK,oBAAoB,QAE/D,MAAO,CAAE,QAAS,KAAM,EAG1B,IAAMI,EACJJ,EAAK,aAAa,KAAK,QAAQ,YAAcA,EAAK,aAAa,KAAK,QAAQ,aAAa,QAAQ,IAAK,EAAE,EAEpG4C,EAAkB5C,EAAK,QACzBA,EAAK,QACF,WAAW,8CAA+C,MAAM,EAChE,WAAW,uCAAwC,MAAM,EACzD,WAAW,qCAAsC,MAAM,EACvD,WAAW,yCAA0C,UAAU,EAClEA,EAAK,QAEH6C,EAAa7C,GAAM,cAAc,SAAS,CAAC,GAAG,QAAQ,gBAAkBA,GAAM,QAAQ,KACtFgC,EAAa,KAAK,UAAU,YAAYhF,EAAS,YAAY,EAEnE,GAAIgD,EAAK,QAAU,mBAAqBA,EAAK,oBAAoB,QAAS,CACxE,IAAM0B,EAAU,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC5D,MAAO,CACL,kBAAmB1B,EAAK,GACxB,WAAYhD,EAAS,UACvB,CACF,CAAC,EAED,GAAI0E,EAAS,CACX,IAAMoB,EAAMpB,EAAQ,IAOpB,MAAMM,GAAY,OAAO,YAAYc,EAAI,UAAW,CAAE,OAAQA,CAAI,CAAC,EAEnE,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,WAAY9F,EAAS,WACrB,kBAAmBgD,EAAK,EAC1B,CACF,CAAC,CACH,CACA,MAAO,CAAE,QAAS,KAAM,CAC1B,CAEA,IAAM+C,EAAe,KAAK,cAAc,IAAc,UAAU,EAAE,YAElE,GAAI3C,IAAW,UAAYJ,EAAK,eAAiB,WAAY,CAC3D,IAAMgD,EAAUJ,EAAgB,QAAQ,IAAK,EAAE,EAE/C,GAAIG,IAAiBC,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,SAAS,GAGzE,GAFchB,GAAY,kBAAkB,QAE9B,OAAQ,CACpB,IAAMpE,EAASoF,EAAQ,MAAM,GAAG,EAAE,CAAC,EACnC,MAAMhB,EAAW,kBAAkBpE,CAAM,CAC3C,MACE,MAAM,KAAK,iBACTZ,EACAyF,EAAQ,EAAE,4BAA6B,CACrC,UAAWzC,EAAK,MAAM,IACxB,CAAC,EACD,UACF,EAeJ,GAXIgD,IAAY,eACdhB,EAAW,mBAAmB,EAC9B,MAAM,KAAK,iBACThF,EACAyF,EAAQ,EAAE,sBAAuB,CAC/B,UAAWzC,EAAK,MAAM,IACxB,CAAC,EACD,UACF,GAGEgD,IAAY,SAAU,CACxB,IAAMC,EAAQjB,GAAY,kBAAkB,MAEvCiB,GACH,MAAM,KAAK,iBACTjG,EACAyF,EAAQ,EAAE,oBAAqB,CAC7B,UAAWzC,EAAK,MAAM,IACxB,CAAC,EACD,UACF,EAGEiD,GACF,MAAM,KAAK,iBACTjG,EACAyF,EAAQ,EAAE,kBAAmB,CAC3B,UAAWzC,EAAK,MAAM,KACtB,MAAOiD,CACT,CAAC,EACD,UACF,CAEJ,CAEA,GAAIF,IAAiBC,IAAY,cAAgBA,IAAY,eAAgB,CAC3E,IAAME,EAAYT,EAAQ,EAAE,sBAAuB,CACjD,UAAWzC,EAAK,MAAM,IACxB,CAAC,EAED,MAAM,KAAK,iBAAiBhD,EAAUkG,EAAW,UAAU,EAE3D,MAAMlB,GAAY,QAAQ,OAAO,qBAAuBhF,EAAS,YAAY,EAC7E,MAAMgF,GAAY,QAAQ,IAAI,MAAM,CACtC,CACF,CAEA,GAAIhC,EAAK,eAAiB,YAAcA,GAAM,cAAc,UAAU,QAAUI,IAAW,SAAU,CACnG,GAAIJ,GAAM,cAAc,SAAS,CAAC,GAAG,WAAW,UAAU,EAAG,CAAC,IAAM,QAClE,MAAO,CAAE,QAAS,KAAM,EAG1B,GAAI,CAACgC,GAAchC,EAAK,cAAc,GACpC,YAAK,mBAAmBhD,EAAUgD,EAAK,cAAc,GAAI,oBAAoB,EACtE,CAAE,QAAS,KAAM,EAG1B,IAAImD,EACJ,GAAIN,GAAe,KACjBM,EAAaP,MACR,CACL,IAAMQ,EAAqB,KAAK,SAAS,cACrC,KAAK,SAAS,cAAc,WAAW,MAAO;AAAA,CAAI,EAClD;AAAA,EACEC,EAAe,KAAK,SAAS,QAAU,CAAC,IAAIR,CAAU,IAAI,EAAI,CAAC,EACrEQ,EAAa,KAAKT,CAAe,EAEjCO,EAAaE,EAAa,KAAKD,CAAkB,CACnD,CAEA,QAAW1B,KAAW1B,EAAK,aAAa,SACtC,GAAI0B,EAAQ,aAAeA,EAAQ,YAAY,OAAS,EACtD,QAAW4B,KAAc5B,EAAQ,YAAa,CACvCkB,IACHO,EAAa,MAGf,IAAMhB,EAAmB,CACvB,OAAQ,MAAM,KAAK,iBAAiBnC,EAAMhD,CAAQ,CACpD,EAEMuG,EAAc,MAAM,KAAK,eAC7BvB,EACA5B,EACAkD,EAAW,SACXH,EACAhB,CACF,EACI,CAACoB,GAAevD,EAAK,cAAc,IACrC,KAAK,mBAAmBhD,EAAUgD,EAAK,cAAc,EAAE,EAGzD,MAAM,KAAK,wBACT,CACE,GAAGuD,EACH,MAAOvG,EAAS,YAClB,EACA,CACE,UAAWgD,EAAK,GAChB,QAASA,EAAK,OAAO,GACrB,eAAgBA,EAAK,cAAc,GACnC,qBAAsBA,EAAK,cAAc,eAAe,SAC1D,EACAhD,CACF,CACF,KACK,CACL,IAAMI,EAAoB,CACxB,OAAQgD,EACR,KAAM+C,EACN,MAAO,KACP,OAAQ,MAAM,KAAK,iBAAiBnD,EAAMhD,CAAQ,CACpD,EAEAwF,EAAc,mBAAmB,EAEjC,IAAIe,EACJ,GAAI,CAEF,GADAA,EAAc,MAAMvB,GAAY,YAAY5E,EAAM,EAAI,EAClD,CAACmG,EACH,MAAM,IAAI,MAAM,kBAAkB,EAGhClH,GAAK,OAAOkH,GAAa,gBAAgB,IAC3CA,EAAY,iBAAmBA,EAAY,kBAAkB,SAAS,GAGxE,MAAM,KAAK,wBACT,CACE,GAAGA,EACH,WAAYvG,EAAS,UACvB,EACA,CACE,UAAWgD,EAAK,GAChB,QAASA,EAAK,OAAO,GACrB,eAAgBA,EAAK,cAAc,GACnC,qBAAsBA,EAAK,cAAc,eAAe,SAC1D,EACAhD,CACF,CACF,OAASmD,EAAO,CACd,KAAI,CAACoD,GAAevD,EAAK,cAAc,IACrC,KAAK,mBAAmBhD,EAAUgD,EAAK,cAAc,GAAIG,CAAK,EAE1DA,CACR,CACF,CAIF,GADqB,KAAK,cAAc,IAAc,UAAU,EAAE,aAChD,CAChB,IAAMqD,EAAc,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAChE,MAAO,CACL,IAAK,CACH,KAAM,CAAC,QAAQ,EACf,OAAQ,EACV,EACA,WAAYxG,EAAS,UACvB,CACF,CAAC,EACD,GAAIwG,GAAe,CAACA,EAAY,eAAgB,CAC9C,IAAMV,EAAMU,EAAY,IAOxBxB,GAAY,kBAAkB,CAC5B,aAAc,CACZ,CACE,GAAIc,EAAI,GACR,OAAQA,EAAI,OACZ,UAAWA,EAAI,SACjB,CACF,CACF,CAAC,EACD,IAAMW,EAAgB,CACpB,kBAAmBD,EAAY,kBAC/B,uBAAwBA,EAAY,uBACpC,gBAAiBA,EAAY,gBAC7B,6BAA8BA,EAAY,6BAC1C,eAAgB,EAClB,EAEA,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,WAAYxG,EAAS,WACrB,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQ8F,EAAI,EACd,CACF,EACA,KAAMW,CACR,CAAC,CACH,CACF,CACF,CAEA,GAAIzD,EAAK,eAAiB,YAAcA,EAAK,QAAU,kBAAmB,CACxE,IAAM5C,EAAoB,CACxB,OAAQgD,EACR,KAAMJ,EAAK,QAAQ,QAAQ,kBAAmB;AAAA,CAAI,EAClD,MAAO,IACT,EAEAwC,EAAc,mBAAmB,EAEjC,MAAMR,GAAY,YAAY5E,CAAI,CACpC,CAEA,MAAO,CAAE,QAAS,KAAM,CAC1B,OAAS+C,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAEhB,CAAE,QAAS,KAAM,CAC1B,CACF,CAEA,MAAc,wBACZuB,EACAgC,EACA1G,EACA,CACA,IAAM8F,EAAMpB,EAAQ,IAOhB,CAACgC,EAAmB,WAAa,CAACZ,GAAK,KAI3C,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQA,EAAI,EACd,EACA,WAAY9F,EAAS,UACvB,EACA,KAAM,CACJ,kBAAmB0G,EAAmB,UACtC,uBAAwBA,EAAmB,eAC3C,gBAAiBA,EAAmB,QACpC,6BAA8BA,EAAmB,qBACjD,eAAgBA,EAAmB,MACrC,CACF,CAAC,EAEG,KAAK,yBAAyB,GAChC5B,EAAe,sBAAsB4B,EAAmB,UAAWZ,EAAI,EAAE,EAE7E,CAEA,MAAc,kBAAkB9F,EAAuB2G,EAAsC,CAW3F,OAViB,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC7D,MAAO,CACL,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQA,CACV,EACA,WAAY3G,EAAS,UACvB,CACF,CAAC,GAEkB,IACrB,CAEA,MAAc,cACZ4G,EACA5G,EACmE,CACnE,IAAI6G,EAAY,KACZC,EAAsB,KAE1B,GAAIF,IACFE,EAAsBF,EAAI,SAAS,qBAAqB,aAAa,UAAYA,EAAI,aAAa,SAC9FE,GAAqB,CACvB,IAAMpC,EAAU,MAAM,KAAK,kBAAkB1E,EAAU8G,CAAmB,EACtEpC,GAAS,oBACXmC,EAAYnC,EAAQ,kBAExB,CAGF,MAAO,CACL,YAAamC,EACb,wBAAyBC,CAC3B,CACF,CAEA,MAAc,iBAAiBF,EAAU5G,EAAwC,CAC/E,GAAI4G,GAAK,oBAAoB,YAAa,CACxC,IAAMlC,EAAU,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC5D,MAAO,CACL,kBAAmBkC,GAAK,oBAAoB,YAC5C,WAAY5G,EAAS,UACvB,CACF,CAAC,EAEK8F,EAAMpB,GAAS,IAOrB,GAAIA,GAAWoB,GAAK,GAClB,MAAO,CACL,IAAKpB,EAAQ,IACb,QAASA,EAAQ,OACnB,CAEJ,CAEA,OAAO,IACT,CAEQ,eAAeA,EAAc,CACnC,IAAMO,EAAQ,CACZ,eACA,kBACA,6BACA,eACA,eACA,iBACA,mBACF,EAMA,OAJoB,OAAO,KAAKP,CAAO,EAEZ,KAAMoB,GAAQb,EAAM,SAASa,CAAG,CAAC,CAG9D,CAEQ,cAAcc,EAAU,CAkB9B,MAV2C,CACzC,MAAOA,EAAI,qBAAqB,aAAa,iBAAiB,OAASA,EAAI,aAAa,iBAAiB,MACzG,KAAMA,EAAI,qBAAqB,aAAa,iBAAiB,MAAQA,EAAI,aAAa,iBAAiB,KACvG,aACEA,EAAI,qBAAqB,aAAa,iBAAiB,cACvDA,EAAI,aAAa,iBAAiB,aACpC,UACEA,EAAI,qBAAqB,aAAa,iBAAiB,WAAaA,EAAI,aAAa,iBAAiB,SAC1G,CAGF,CAEQ,mBAAmBA,EAAU,CAYnC,OAFqDA,GAAK,eAG5D,CAEQ,eAAeA,EAAU,CAuB/B,MAtBc,CACZ,aAAcA,EAAI,aAClB,aAAcA,EAAI,cAAc,QAChC,aAAcA,EAAI,cAAc,QAChC,oBAAqBA,EAAI,qBAAqB,KAC9C,mBAAoBA,EAAI,oBAAoB,SAC5C,eAAgB,OAChB,gBAAiBA,EAAI,iBAAiB,QACtC,2BAA4BA,EAAI,4BAA4B,SAAS,iBAAiB,QACtF,aAAcA,EAAI,cAAc,QAChC,eAAgBA,EAAI,gBAAgB,MACpC,qBAAsBA,EAAI,qBAC1B,gBAAiBA,EAAI,gBACrB,oBAAqBA,EAAI,oBACzB,YAAaA,EAAI,YACjB,oBAAqBA,EAAI,oBACzB,kBACEA,GAAK,SAAS,mBAAmB,SAAS,cAAc,KACxDA,GAAK,SAAS,mBAAmB,SAAS,cAAc,KACxDA,GAAK,SAAS,mBAAmB,SAAS,cAAc,GAC5D,CAGF,CAEQ,kBAAkBG,EAAY,CACpC,IAAMC,EAAU,OAAO,KAAKD,CAAK,EAAE,KAAMjB,GAAQiB,EAAMjB,CAAG,IAAM,MAAS,EAErEmB,EAASD,EAAUD,EAAMC,CAAO,EAAI,OAOxC,GAJIC,GAAU,OAAOA,GAAW,UAAYA,EAAO,SAAS,sBAAsB,IAChFA,EAASA,EAAO,MAAM,sBAAsB,EAAE,OAAO,OAAO,EAAE,KAAK,EAAE,GAGnED,IAAY,mBAAqBA,IAAY,sBAAuB,CACtE,IAAME,EAAWD,EAAO,gBAClBE,EAAYF,EAAO,iBAEnBG,EAAeH,GAAQ,KACvBI,EAAkBJ,GAAQ,QAWhC,MARE,IAAIxB,EAAQ,EAAE,6BAA6B,CAAC;AAAA;AAAA,GACxCA,EAAQ,EAAE,6BAA6B,CAAC,MAAMyB,CAAQ;AAAA,GACtDzB,EAAQ,EAAE,8BAA8B,CAAC,MAAM0B,CAAS;AAAA,GAC3DC,EAAe,IAAI3B,EAAQ,EAAE,iCAAiC,CAAC,MAAM2B,CAAY;AAAA,EAAO,KACxFC,EAAkB,IAAI5B,EAAQ,EAAE,oCAAoC,CAAC,MAAM4B,CAAe;AAAA,EAAQ,IACnG,IAAI5B,EAAQ,EAAE,gCAAgC,CAAC,sDACIyB,CAAQ,IAAIC,CAAS,EAG5E,CAEA,GAAIH,IAAY,iBAAkB,CAChC,IAAMM,EAAYL,EAAO,MAAM;AAAA,CAAI,EAC7BM,EAAc,CAAC,EAErBD,EAAU,QAASE,GAAS,CAC1B,GAAM,CAAC1B,EAAK2B,CAAK,EAAID,EAAK,MAAM,GAAG,EAC/B1B,GAAO2B,IACTF,EAAYzB,CAAG,EAAI2B,EAEvB,CAAC,EAED,IAAIC,EACF,IAAIjC,EAAQ,EAAE,2BAA2B,CAAC;AAAA;AAAA,GACtCA,EAAQ,EAAE,wBAAwB,CAAC,MAAM8B,EAAY,EAAK,GAE5DI,EAAc,EAClB,cAAO,KAAKJ,CAAW,EAAE,QAASzB,GAAQ,CACxC,GAAIA,EAAI,WAAW,MAAM,GAAKA,EAAI,SAAS,KAAK,EAAG,CACjD,IAAMxE,EAAciG,EAAYzB,CAAG,EACnC4B,GAAoB;AAAA,GAAMjC,EAAQ,EAAE,0BAA0B,CAAC,KAAKkC,CAAW,OAAOrG,CAAW,GACjGqG,GACF,SAAW7B,EAAI,SAAS,KAAK,EAAG,CAC9B,IAAMxE,EAAciG,EAAYzB,CAAG,EACnC4B,GAAoB;AAAA,GAAMjC,EAAQ,EAAE,0BAA0B,CAAC,KAAKkC,CAAW,OAAOrG,CAAW,GACjGqG,GACF,CACF,CAAC,EAEMD,CACT,CAEA,GAAIV,IAAY,uBAkCd,OAjC0BC,EAAO,SAAS,IAAKzG,GAAY,CACzD,IAAM8G,EAAY9G,EAAQ,MAAM,MAAM;AAAA,CAAI,EACpC+G,EAAc,CAAC,EAErBD,EAAU,QAASE,GAAS,CAC1B,GAAM,CAAC1B,EAAK2B,CAAK,EAAID,EAAK,MAAM,GAAG,EAC/B1B,GAAO2B,IACTF,EAAYzB,CAAG,EAAI2B,EAEvB,CAAC,EAED,IAAIC,EAAmB,IAAIjC,EAAQ,EAAE,2BAA2B,CAAC;AAAA;AAAA,GAAUA,EAAQ,EACjF,wBACF,CAAC,MAAMjF,EAAQ,WAAW,GAEtBmH,EAAc,EAClB,cAAO,KAAKJ,CAAW,EAAE,QAASzB,GAAQ,CACxC,GAAIA,EAAI,WAAW,MAAM,GAAKA,EAAI,SAAS,KAAK,EAAG,CACjD,IAAMxE,EAAciG,EAAYzB,CAAG,EACnC4B,GAAoB;AAAA,GAAMjC,EAAQ,EAAE,0BAA0B,CAAC,KAAKkC,CAAW,OAAOrG,CAAW,GACjGqG,GACF,SAAW7B,EAAI,SAAS,KAAK,EAAG,CAC9B,IAAMxE,EAAciG,EAAYzB,CAAG,EACnC4B,GAAoB;AAAA,GAAMjC,EAAQ,EAAE,0BAA0B,CAAC,KAAKkC,CAAW,OAAOrG,CAAW,GACjGqG,GACF,CACF,CAAC,EAEMD,CACT,CAAC,EAEgD,KAAK;AAAA;AAAA,CAAM,EAK9D,GAAIV,IAAY,cAAe,CAC7B,IAAMY,EAAYX,GAAQ,OAAS,UAC7BY,EAAkBZ,GAAQ,aAAe,UACzCa,EAAab,GAAQ,YAAc,UAErCc,EACF;AAAA;AAAA,WAEAH,EACA;AAAA,iBAEAC,EACA;AAAA,YAEAC,EAEF,OAAIb,EAAO,UAAYA,EAAO,SAAS,OAAS,EAC9CA,EAAO,SAAS,QAAQ,CAACe,EAASC,IAAiB,CACjDF,GAAiB;AAAA;AAAA,YAAmBE,EAAe,GAAK,MAAQD,EAAQ,OAAS;AAAA,EAE7EA,EAAQ,MAAQA,EAAQ,KAAK,OAAS,EACxCA,EAAQ,KAAK,QAAQ,CAACE,EAAKC,IAAa,CACtCJ,GAAiB;AAAA,SAAcI,EAAW,GAAK;AAAA,EAC/CJ,GAAiB,0BAAkBG,EAAI,OAAS,WAAa;AAAA,EAC7DH,GAAiB,gCAAwBG,EAAI,aAAe,WAAa;AAAA,EACzEH,GAAiB,uBAAeG,EAAI,OAAS,WAAa;AAAA,CAC5D,CAAC,EAEDH,GAAiB;AAAA;AAAA,CAErB,CAAC,EAEDA,GAAiB;AAAA;AAAA,EAGZA,CACT,CAEA,GAAIf,IAAY,sBAAuB,CACrC,IAAMoB,EAAgBnB,GAAQ,OAAS,UACjCoB,EAAsBpB,GAAQ,aAAe,UAC7CqB,EAAgBrB,GAAQ,mBAAmB,eAAiB,UAYlE,MATE;AAAA;AAAA,WAEAmB,EACA;AAAA,iBAEAC,EACA;AAAA,QAEAC,CAEJ,CAEA,OAAOrB,CACT,CAEO,uBAAuBL,EAAU,CACtC,IAAMG,EAAQ,KAAK,eAAeH,CAAG,EAIrC,OAFuB,KAAK,kBAAkBG,CAAK,CAGrD,CAEA,MAAa,cAAcwB,EAAevI,EAAuBgD,EAAW,CAC1E,GAAI,CACF,IAAMgC,EAAa,KAAK,UAAU,YAAYhF,EAAS,YAAY,EAEnE,GAAI,CAACgF,EACH,YAAK,OAAO,KAAK,uBAAuB,EACjC,KAGT,IAAMzE,EAAS,MAAM,KAAK,SAASP,CAAQ,EAE3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,GAAI,KAAK,UAAU,YAAc,KAAK,UAAU,WAAW,OAAS,EAAG,CACrE,IAAMiI,EAAkB,KAAK,UAAU,WAEnCC,EAAe,GACfC,EAAiB,GAUrB,GARIF,EAAW,SAAS,OAAO,IAC7BC,EAAe,IAGbD,EAAW,SAAS,iBAAiB,IACvCE,EAAiB,IAGfD,GAAgBzF,GAAM,KAAK,UAAU,SAAS,OAAO,EAAG,CAC1D,KAAK,OAAO,KAAK,gCAAkCA,GAAM,KAAK,SAAS,EACvE,MACF,CAEA,GAAI0F,GAAkB1F,GAAM,KAAK,UAAU,SAAS,iBAAiB,EAAG,CACtE,KAAK,OAAO,KAAK,kCAAoCA,GAAM,KAAK,SAAS,EACzE,MACF,CAEA,GAAIwF,EAAW,SAASxF,GAAM,KAAK,SAAS,EAAG,CAC7C,KAAK,OAAO,KAAK,8BAAgCA,GAAM,KAAK,SAAS,EACrE,MACF,CACF,CAEA,GAAIuF,IAAU,mBAAqBA,IAAU,eAAgB,CAC3D,GAAIvF,EAAK,IAAI,YAAc,mBACzB,OAGEA,EAAK,SAAS,kBAAkB,UAClCA,EAAK,QAAU,CACb,GAAGA,EAAK,SAAS,kBAAkB,OACrC,GAGF,IAAM2F,EAAkB,MAAM,KAAK,uBAAuB3F,EAAK,OAAO,EAChE4F,EAAcD,GAChBA,EACG,WAAW,iCAAkC,QAAQ,EACrD,WAAW,+BAAgC,MAAM,EACjD,WAAW,+BAAgC,QAAQ,EAG1D,GAAIC,GAAeA,EAAY,SAAS,4CAA4C,EAClF,OAGF,IAAMC,EAAW7F,EAAK,aAAa,UAAYA,EAAK,SAAS,aAAa,SAEtEuB,EAAY,KAEZsE,IACFtE,EAAY,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CACxD,MAAO,CACL,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQsE,CACV,EACA,kBAAmB,CACjB,IAAK,IACP,CACF,CACF,CAAC,GAEH,IAAMC,EAAU,KAAK,eAAe9F,EAAK,OAAO,EAE1C+F,EAAa,KAAK,cAAc/F,CAAI,EAEpCgG,EAAkB,KAAK,mBAAmBhG,EAAK,OAAO,EAE5D,GAAI,CAAC4F,GAAe,CAACE,GAAW,CAACE,EAAiB,CAChD,KAAK,OAAO,KAAK,uBAAuB,EACxC,MACF,CAEA,IAAMC,EAAkB,MAAM,KAAK,mBAAmBjJ,EAAUgD,CAAI,EAEpE,GAAI,CAACiG,EAAiB,CACpB,KAAK,OAAO,KAAK,wBAAwB,EACzC,MACF,CAEA,IAAM/E,EAAclB,EAAK,IAAI,OAAS,WAAa,WAEnD,GAAI8F,EAAS,CACX,IAAMI,EAAiB,MAAMlE,GAAY,0BAA0B,CACjE,QAAS,CACP,GAAGhC,CACL,CACF,CAAC,EAEGmG,EACE9E,EAAcrB,GAAM,QAAQA,GAAM,WAAW,EAC7CoG,EACJ/E,GAAa,UAAYA,GAAa,UAAYA,GAAa,SAAS,iBAAiB,SAC3F,GAAI+E,EAAkB,CACpB,IAAMC,EAAa9J,GAAK,MAAM6J,CAAgB,EAC1CC,EAAW,MAAQA,EAAW,MAChCF,EAAW,GAAGE,EAAW,IAAI,IAAI,KAAK,MAAM,KAAK,OAAO,EAAK,GAAe,EAAE,CAAC,GAAGA,EAAW,GAAG,GAEpG,CAEKF,IACHA,EAAW,GAAG,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,CAAC,CAAC,IAAI7J,GAAU,UAAU4J,EAAe,QAAQ,GAAK,EAAE,IAG7G,IAAMI,EAAW,OAAO,KAAKJ,EAAe,OAAQ,QAAQ,EAEtDvE,EAAa,IAAInF,GAKvB,GAJAmF,EAAW,MAAQ,IAAM,CAAC,EAC1BA,EAAW,KAAK2E,CAAQ,EACxB3E,EAAW,KAAK,IAAI,EAEhB3B,EAAK,IAAI,UAAU,SAAS,OAAO,EAAG,CACxC,IAAMuG,EAAkBvG,EAAK,SACvBwG,EAAiBxG,EAAK,IAAI,YAAY,MAAM,GAAG,EAAE,CAAC,EAClDyG,EAAaD,EAAe,MAAM,gCAAgC,EAEpEE,EAEAD,EACFC,EAAuB,IAAID,EAAW,CAAC,CAAC,KAAKA,EAAW,CAAC,CAAC,KAAKA,EAAW,CAAC,CAAC,IAAIA,EAAW,CAAC,CAAC,GAE7FC,EAAuB,IAAIF,CAAc,GAG3C,IAAIvF,EAECjB,EAAK,IAAI,OAGZiB,EAAU,GAAG2E,CAAW,GAFxB3E,EAAU,KAAKyF,CAAoB,MAAMH,CAAe;AAAA;AAAA,EAAUX,CAAW,GAK/E,IAAMe,EAAO,MAAM,KAAK,SACtBV,EACAtE,EACAwE,EACAjF,EACAD,EACAjE,EACAgD,EACA,QAAUA,EAAK,IAAI,GACnBuB,CACF,EAEA,GAAI,CAACoF,EAAM,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAEA,OAAOA,CACT,KAAO,CACL,IAAMA,EAAO,MAAM,KAAK,SACtBV,EACAtE,EACAwE,EACAjF,EACA0E,EACA5I,EACAgD,EACA,QAAUA,EAAK,IAAI,GACnBuB,CACF,EAEA,GAAI,CAACoF,EAAM,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAEA,OAAOA,CACT,CACF,CAEA,GAAIX,EAAiB,CACnB,GAAIA,EAAgB,MAcd,CAbS,MAAM,KAAK,cACtBhJ,EACAiJ,EACAD,EAAgB,KAChB9E,EACA,GACA,CAAC,EACD,CACE,QAAS,CAAE,oBAAqB,CAAE,YAAa,CAAE,SAAU8E,EAAgB,IAAI,EAAG,CAAE,CAAE,CACxF,EACA,QAAUhG,EAAK,IAAI,GACnBuB,CACF,EACW,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAGF,MACF,CAGA,GADsBwE,GAAcA,EAAW,OAAUA,EAAW,MAAQA,EAAW,aACrE,CAChB,IAAMa,EAAY,MAAM3K,GAAM,IAAI8J,EAAW,aAAc,CAAE,aAAc,aAAc,CAAC,EAEpFc,EAAYvK,GAAU,UAAUsK,EAAU,QAAQ,cAAc,CAAC,EACjEvE,EAAWwE,GAAavK,GAAU,OAAOuK,CAAS,EAExD,GAAI,CAACxE,EAAU,CACb,KAAK,OAAO,KAAK,mCAAmC,EACpD,MACF,CAGA,IAAM8D,EAAW,GADF,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,CAAC,CAC3B,IAAI7J,GAAU,UAAU+F,CAAQ,CAAC,GACrDiE,EAAW,OAAO,KAAKM,EAAU,KAAM,QAAQ,EAE/CE,EAAM,MAAM1K,GAAK,KAAKkK,CAAQ,EACpC,MAAMQ,EAAI,MAAM,IAAK,GAAG,EAExB,IAAMC,EAAkB,MAAMD,EAAI,eAAe1K,GAAK,QAAQ,EAExDuF,EAAa,IAAInF,GACvBmF,EAAW,MAAQ,IAAM,CAAC,EAC1BA,EAAW,KAAKoF,CAAe,EAC/BpF,EAAW,KAAK,IAAI,EAEpB,IAAMqF,EAAW,CAACC,EAAaC,IACxBD,EAEEA,EAAI,OAASC,EAAMD,EAAI,UAAU,EAAGC,CAAG,EAAI,MAAQD,EAFzC,GAKbE,EAAQH,EAASjB,EAAW,MAAO,EAAE,EACrCqB,EAAcJ,EAASjB,GAAY,KAAM,EAAE,EAE3CY,EAAO,MAAM,KAAK,SACtBV,EACAtE,EACAwE,EACAjF,EACA,GAAG0E,CAAW;AAAA;AAAA;AAAA,IAAWuB,CAAK;AAAA,EAAOC,CAAW;AAAA,EAAKrB,EAAW,SAAS,GACzE/I,EACAgD,EACA,QAAUA,EAAK,IAAI,EACrB,EAEA,GAAI,CAAC2G,EAAM,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAEA,OAAOA,CACT,CAEA,GAAI3G,EAAK,IAAI,UAAU,SAAS,OAAO,EAAG,CACxC,IAAMuG,EAAkBvG,EAAK,SACvBwG,EAAiBxG,EAAK,IAAI,YAAY,MAAM,GAAG,EAAE,CAAC,EAClDyG,EAAaD,EAAe,MAAM,gCAAgC,EAEpEE,EAEAD,EACFC,EAAuB,IAAID,EAAW,CAAC,CAAC,KAAKA,EAAW,CAAC,CAAC,KAAKA,EAAW,CAAC,CAAC,IAAIA,EAAW,CAAC,CAAC,GAE7FC,EAAuB,IAAIF,CAAc,GAG3C,IAAIvF,EAECjB,EAAK,IAAI,OAGZiB,EAAU,GAAG2E,CAAW,GAFxB3E,EAAU,KAAKyF,CAAoB,MAAMH,CAAe;AAAA;AAAA,EAAUX,CAAW,GAK/E,IAAMe,EAAO,MAAM,KAAK,cACtB3J,EACAiJ,EACAhF,EACAC,EACA,GACA,CAAC,EACDlB,EACA,QAAUA,EAAK,IAAI,GACnBuB,CACF,EAEA,GAAI,CAACoF,EAAM,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAEA,OAAOA,CACT,KAAO,CACL,IAAMA,EAAO,MAAM,KAAK,cACtB3J,EACAiJ,EACAL,EACA1E,EACA,GACA,CAAC,EACDlB,EACA,QAAUA,EAAK,IAAI,GACnBuB,CACF,EAEA,GAAI,CAACoF,EAAM,CACT,KAAK,OAAO,KAAK,kBAAkB,EACnC,MACF,CAEA,OAAOA,CACT,CACF,CAEA,GAAIpB,IAAU,mBACW,KAAK,cAAc,IAAc,UAAU,EAAE,iBAE7C,GAAM,CAC3B,GAAI,CAACvF,GAAM,KAAK,GAAI,CAClB,KAAK,OAAO,KAAK,sBAAsB,EACvC,MACF,CAEA,IAAM0B,EAAU,MAAM,KAAK,kBAAkB1E,EAAUgD,EAAK,IAAI,EAAE,EAElE,GAAI0B,GAAS,mBAAqBA,GAAS,uBACzC,aAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQ1B,EAAK,IAAI,EACnB,EACA,WAAYhD,EAAS,UACvB,CACF,CAAC,EAEM,MAAMO,EAAO,SAAS,OAAO,CAClC,UAAW,KAAK,SAAS,UACzB,eAAgBmE,EAAQ,uBACxB,UAAWA,EAAQ,iBACrB,CAAC,CAEL,CAGF,GAAI6D,IAAU,gBAAiB,CAC7B,IAAM8B,EAAa,GACjBrH,GAAM,eAAe,cAAgBA,GAAM,eAAe,qBAAqB,IACjF;AAAA;AAAA,KAAUyC,EAAQ,EAAE,mBAAmB,CAAC,OAClCf,EAAU,MAAM,KAAK,kBAAkB1E,EAAUgD,GAAM,KAAK,EAAE,EAC9D8C,EAAMpB,EAAQ,IAOdR,EAAc4B,GAAK,OAAS,WAAa,WAE/C,GAAIpB,GAAWA,EAAQ,wBAcjB,CAbS,MAAM,KAAK,cACtB1E,EACA0E,EAAQ,uBACR2F,EACAnG,EACA,GACA,CAAC,EACD,CACE,QAAS,CAAE,oBAAqB,CAAE,YAAa,CAAE,SAAU4B,EAAI,EAAG,CAAE,CAAE,CACxE,EACA,QAAU9C,EAAK,IAAI,GACnB,IACF,EACW,CACT,KAAK,OAAO,KAAK,yBAAyB,EAC1C,MACF,CAEF,MACF,CAEA,GAAIuF,IAAU,gBAAiB,CAC7B,GAAI,CAACvF,GAAM,KAAK,IAAM,CAACA,GAAM,KAAK,UAAW,CAC3C,KAAK,OAAO,KAAK,sBAAsB,EACvC,MACF,CAEA,IAAM0B,EAAU,MAAM,KAAK,kBAAkB1E,EAAUgD,EAAK,IAAI,EAAE,EAC5DC,EAAiByB,GAAS,uBAC1B4F,EAAuB5F,GAAS,6BAEtC,GAAIzB,EAAgB,CAClB,IAAIqB,EAAWgG,EACTrJ,EAAS,MAAM,KAAK,SAASjB,CAAQ,EAc3C,GAVI,CAACsE,GAAYrD,IAOfqD,GANsB,MAAM/D,EAAO,cAAc,IAAI,CACnD,UAAW,KAAK,SAAS,UACzB,eAAgB0C,CAClB,CAAC,GAGuB,2BAA2B,cAAc,eAAe,WAG9EqB,GAAYrD,GAAO,iBAAkB,CACvC,IAAMsJ,EACJ,0BAA0BtJ,EAAM,gBAAgB,aAAaqD,CAAQ,kBACnDrB,CAAc,oBAClCjB,GAAgB,KAAK,kBAAkB,EAAG,CACxC,OAAQ,OACR,IAAKuI,CACP,CAAC,CACH,CACF,CACA,MACF,CAEA,GAAIhC,IAAU,kBAAmB,CAC/B,IAAMnI,EAAO4C,EACP/B,EAAQ,MAAM,KAAK,SAASjB,CAAQ,EAE1C,GAAI,CAACiB,EAAO,CACV,KAAK,OAAO,KAAK,iBAAiB,EAClC,MACF,CAEA,IAAMuJ,EAAY/E,EAAQ,EAAE,kBAAmB,CAC7C,UAAWxE,EAAM,KACjB,MAAOb,EAAK,MACd,CAAC,EAED,MAAM,KAAK,iBAAiBJ,EAAUwK,EAAW,UAAU,CAC7D,CAEA,GAAIjC,IAAU,qBACRvF,EAAK,SAAW,QAEd,KAAK,UAAU,YAAYhD,EAAS,YAAY,EAAE,OAAO,MAAQ,EAAG,CACtE,IAAMyK,EAAgBhF,EAAQ,EAAE,oBAAoB,EACpD,MAAM,KAAK,iBAAiBzF,EAAUyK,EAAe,UAAU,EAC/D,KAAK,UAAU,YAAYzK,EAAS,YAAY,EAAE,OAAO,MAAQ,EACjE8E,EAAe,SAAS9E,CAAQ,CAClC,CAIJ,GAAIuI,IAAU,iBACZ,GAAIvF,EAAK,aAAe,IAAK,CAC3B,IAAM0H,EAAa,aAAMjF,EAAQ,EAAE,gBAAgB,CAAC,GACpD,OAAO,MAAM,KAAK,iBAAiBzF,EAAU0K,EAAY,UAAU,CACrE,KAAO,CACL,IAAMpB,EAAW,OAAO,KAAKtG,GAAM,OAAO,OAAO,QAAQ,yBAA0B,EAAE,EAAG,QAAQ,EAE1F2B,EAAa,IAAInF,GACvBmF,EAAW,MAAQ,IAAM,CAAC,EAC1BA,EAAW,KAAK2E,CAAQ,EACxB3E,EAAW,KAAK,IAAI,EAEpB,MAAM,KAAK,YACT3E,EACAyF,EAAQ,EAAE,wBAAwB,EAClC,WACAd,EACA,GAAG3E,EAAS,YAAY,MAC1B,EAEA,IAAI2K,EAAY,eAAKlF,EAAQ,EAAE,wBAAwB,CAAC;AAAA;AAAA,EAAOA,EAAQ,EAAE,QAAQ,CAAC,GAE9EzC,GAAM,QAAQ,cAChB2H,EACEA,EACA;AAAA;AAAA,kBAAuB3H,EAAK,OAAO,YAAY,UAAU,EAAG,CAAC,CAAC,IAAIA,EAAK,OAAO,YAAY,UACxF,EACA,CACF,CAAC,IAGL,MAAM,KAAK,iBAAiBhD,EAAU2K,EAAW,UAAU,CAC7D,CAEJ,OAASxH,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEO,uBAAuByH,EAAmB,CAC/C,OAAOA,EAAU,QAAQ,OAAQ,EAAE,EAAE,MAAM,GAAG,EAAE,CAAC,CACnD,CAEO,2BAA2B5K,EAAuB,CAClD,KAAK,yBAAyB,GAInC,KAAK,iBAAiBA,EAAUyF,EAAQ,EAAE,uBAAuB,EAAG,UAAU,CAChF,CAEO,0BAA2B,CAChC,IAAMoF,EAAM,KAAK,cAAc,IAAc,UAAU,EAAE,OAAO,SAAS,WAAW,IAEpF,OAAOA,GAAOA,IAAQ,+CACxB,CAEO,mBAAmB7K,EAAuB8K,EAA6B,CACvE,KAAK,yBAAyB,GAInChG,EAAe,mBAAmB9E,EAAU8K,CAAW,CACzD,CAEO,mBAAmB9K,EAAuB+K,EAA6B,CAC5E,GAAK,KAAK,yBAAyB,EAInC,OAAOjG,EAAe,mBAAmB9E,EAAU+K,CAAW,CAChE,CAEA,MAAa,sBAAsB/K,EAAuB,CACxD,GAAI,CAAC,KAAK,yBAAyB,EACjC,OAGF,KAAK,iBAAiBA,EAAUyF,EAAQ,EAAE,6BAA6B,EAAG,UAAU,EAEpF,IAAMuF,EAAwB,MAAMlG,EAAe,sBACjD9E,EACA,KACA,MAAM,KAAK,SAASA,CAAQ,EAC5B,KAAK,QACP,EACA,KAAK,yCAAyCA,CAAQ,EAEtD,IAAM4G,EAAM,OAAO,UAAUoE,CAAqB,EAC9CvF,EAAQ,EAAE,6BAA8B,CAAE,sBAAAuF,CAAsB,CAAC,EACjEvF,EAAQ,EAAE,6BAA6B,EAE3C,YAAK,iBAAiBzF,EAAU4G,EAAK,UAAU,EAExCoE,CACT,CAEA,MAAa,yCAAyChL,EAAuBiL,EAAgB,IAAK,CAChG,GAAI,CACF,GAAI,CAAC,KAAK,yBAAyB,EACjC,OAGF,IAAM1K,EAAS,MAAM,KAAK,SAASP,CAAQ,EAC3C,GAAI,CAACO,EACH,YAAK,OAAO,KAAK,kBAAkB,EAC5B,KAGT,IAAMU,EAAQ,MAAM,KAAK,SAASjB,CAAQ,EAC1C,GAAI,CAACiB,EACH,YAAK,OAAO,KAAK,iBAAiB,EAC3B,KAGT,IAAMiK,EAAiB,MAAMpG,EAAe,sCAC1C7D,EACA,KAAK,SACLgK,CACF,EAEME,EAAqBD,EACxB,IAAK1K,GAAYA,EAAQ,UAAU,EACnC,OAAQ4K,GAAeA,IAAe,IAAI,EAEvCC,GACJ,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC3C,MAAO,CACL,WAAYrL,EAAS,WACrB,GAAI,CACF,GAAImL,CACN,EACA,cAAe,CACb,IAAK,IACP,CACF,CACF,CAAC,GACD,OAAO,CAACG,EAAgC9K,IAA0B8K,EAAI,IAAI9K,EAAQ,GAAIA,CAAO,EAAG,IAAI,GAAK,EAE3G0K,EAAe,QAAQ,MAAO1K,GAAY,CACpC6K,EAA2B,IAAI7K,EAAQ,UAAU,GACnDD,EAAO,SAAS,OAAO,CACrB,UAAW,KAAK,SAAS,UACzB,GAAIC,EAAQ,GACZ,KAAM,CACJ,WAAY6K,EAA2B,IAAI7K,EAAQ,UAAU,EAAE,mBAAqB,IACtF,CACF,CAAC,CAEL,CAAC,CACH,OAAS2C,EAAO,CACd,KAAK,OAAO,MAAM,mDAAmDA,EAAM,SAAS,CAAC,EAAE,CACzF,CACF,CAEA,MAAa,iBACXnD,EACAuL,EACAC,EACA,CACA,GAAI,CAIF,GAHI,CAAC,KAAK,yBAAyB,GAG/B,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,eAC1D,OAGF,IAAMvK,EAAQ,MAAM,KAAK,SAASjB,CAAQ,EAEpCyL,EAAc;AAAA,2BACCF,EAAe,SAAS;AAAA,uBAC5BtK,EAAM,EAAE;AAAA;AAAA,gCAKnByK,IADgB,MAAM,KAAK,SAAS,MAAMD,CAAW,IAAI,MAE5D,OAAQ/G,GAAY,CAAC,CAACA,EAAQ,SAAS,EACvC,IAAKA,GAAYA,EAAQ,UAAU,QAAQ,QAAS,EAAE,CAAC,EAUpDiH,GARgB,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CACjE,MAAO,CACL,SAAU,CAAE,KAAM3L,EAAS,YAAa,EACxC,iBAAkB,CAAE,IAAKd,GAAM,EAAE,SAAS,EAAG,OAAO,EAAE,KAAK,CAAE,EAC7D,IAAKwM,EAAI,IAAKpL,IAAQ,CAAE,IAAK,CAAE,KAAM,CAAC,IAAI,EAAG,IAAKA,CAAG,CAAE,EAAE,CAC3D,CACF,CAAC,GAEsC,OACpCsG,GAAa,CAAC9B,EAAe,oBAAoB8B,EAAI,KAAK,SAAS,CACtE,EACMkE,EAAqB,CAAC,EAC5B,QAAWc,KAAKD,EACV,CAACC,EAAE,SAAW,CAACA,EAAE,KAAO,CAACA,EAAE,mBAI3BvM,GAAK,OAAOuM,GAAG,gBAAgB,IACjCA,EAAE,iBAAmBA,EAAE,kBAAkB,SAAS,GAGpDd,EAAY,KAAKU,EAAeI,CAAQ,CAAC,GAG3C,KAAK,mBACH5L,EACA8K,EAAY,OAAQlE,GAAQ,CAAC9B,EAAe,oBAAoB8B,EAAI,KAAK,SAAS,CAAC,CACrF,EAEA,MAAM9B,EAAe,sBAAsB9E,EAAU,KAAMiB,EAAO,KAAK,QAAQ,EAC5D,KAAK,UAAU,YAAYjB,EAAS,YAAY,EACxD,mBAAmB,CAChC,MAAgB,CACd,MACF,CACF,CACF,EGj9EA,OAAO6L,OAAW,QAGX,IAAMC,GAAN,KAAkB,CACvB,YACmBC,EACAC,EACAC,EACjB,CAHiB,eAAAF,EACA,mBAAAC,EACA,sBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,aAAa,CAF/C,CAIH,MAAa,iBAAiBC,EAAuBC,EAAW,CAC9D,GAAI,CAcF,MAAO,CAAE,QAbO,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpE,KAAM,CACJ,UAAWA,EAAK,UAChB,SAAUA,EAAK,SACf,UAAWA,EAAK,UAChB,OAAQ,SACR,UAAW,GACX,MAAOA,EAAK,MACZ,WAAYD,EAAS,WACrB,KAAM,MACR,CACF,CAAC,CAEgB,CACnB,OAASE,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEQ,eAAeC,EAAiB,CACtC,OAAOA,EAAQ,SAAS,cAAc,CACxC,CAEQ,OAAOC,EAAsB,CACnC,GAAI,CACF,YAAK,MAAMA,CAAG,EACP,EACT,MAAY,CACV,MAAO,EACT,CACF,CAEA,MAAc,iBACZJ,EACAK,EACAC,EACAC,EACAC,EACAC,EACAN,EACA,CACA,GAAI,CACF,IAAIO,EAAmBH,EAAK,OAE5B,GAAIA,EAAK,UAAY,UAAW,CAC9BG,GAAY,iBACZ,IAAMC,EAAe,CACnB,OAAQ,CACN,UAAWH,EACX,SAAUC,EACV,aAAcT,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,EACA,MAAOG,EACP,cAAe,WACf,gBAAiBE,EAAQ,YAAcG,EAAY,OAAYH,EAAQ,UACvE,KAAMG,CACR,EAEA,GAAI,KAAK,eAAeL,CAAO,EAAG,CAChC,IAAMS,EAAeT,EAAQ,MAAM,GAAG,EAEtCQ,EAAQ,MAAQ,CACd,CACE,KAAM,QACN,gBAAiB,aACjB,IAAKC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,CACnC,CACF,EACAD,EAAQ,MAAQC,EAAa,CAAC,GAAKT,CACrC,CAEIH,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,IAAMM,EAAW,MAAMpB,GAAM,KAAKgB,EAAUC,EAAS,CACnD,QAAS,CACP,cAAe,UAAUJ,EAAK,MAAM,EACtC,CACF,CAAC,EAEGP,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,EAE9D,IAAMO,EAAUD,GAAU,MAAM,OAC1BE,EAAiBF,GAAU,MAAM,gBAEvC,MAAM,KAAK,oBAAoBd,EAAUQ,EAAWO,EAAST,CAAQ,EAErE,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,GACX,UAAWA,EAAQ,YAAcG,EAAYQ,EAAiBX,EAAQ,SACxE,CACF,CAAC,CACH,CAEA,GAAIE,EAAK,UAAY,gBAAiB,CACpCG,GAAY,uBACZ,IAAMC,EAAe,CACnB,OAAQ,CACN,MAAOR,EACP,SAAUM,EACV,UAAWD,EACX,aAAcR,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,EACA,cAAe,WACf,gBAAiBK,EAAQ,YAAcG,EAAY,OAAYH,EAAQ,UACvE,KAAMG,CACR,EAEA,GAAI,KAAK,eAAeL,CAAO,EAAG,CAChC,IAAMS,EAAeT,EAAQ,MAAM,GAAG,EAEtCQ,EAAQ,MAAQ,CACd,CACE,KAAM,QACN,gBAAiB,aACjB,IAAKC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,CACnC,CACF,EACAD,EAAQ,OAAO,MAAQC,EAAa,CAAC,GAAKT,CAC5C,CAEIH,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,IAAMM,EAAW,MAAMpB,GAAM,KAAKgB,EAAUC,EAAS,CACnD,QAAS,CACP,cAAe,UAAUJ,EAAK,MAAM,EACtC,CACF,CAAC,EAEGP,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,EAE9D,IAAMO,EAAUD,GAAU,MAAM,OAC1BE,EAAiBF,GAAU,MAAM,gBAEvC,MAAM,KAAK,oBAAoBd,EAAUQ,EAAWO,EAAST,CAAQ,EAErE,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,GACX,UAAWA,EAAQ,YAAcG,EAAYQ,EAAiBX,EAAQ,SACxE,CACF,CAAC,CACH,CAEA,GAAIE,EAAK,UAAY,QAAS,CAC5BG,GAAY,iBACZ,IAAMC,EAAe,CACnB,OAAQ,CACN,UAAWH,EACX,SAAUC,EACV,aAAcT,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,EACA,MAAOG,EACP,cAAe,YACf,gBAAiBE,EAAQ,YAAcG,EAAY,OAAYH,EAAQ,UACvE,KAAMG,CACR,EAEA,GAAI,KAAK,eAAeL,CAAO,EAAG,CAChC,IAAMS,EAAeT,EAAQ,MAAM,GAAG,EAEtCQ,EAAQ,MAAQ,CACd,CACE,KAAM,QACN,gBAAiB,aACjB,IAAKC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,CACnC,CACF,EACAD,EAAQ,MAAQC,EAAa,CAAC,GAAKT,CACrC,CAEIH,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,IAAMM,EAAW,MAAMpB,GAAM,KAAKgB,EAAUC,EAAS,CACnD,QAAS,CACP,cAAe,UAAUJ,EAAK,MAAM,EACtC,CACF,CAAC,EAEGS,EACAC,EAAS,GAIPC,EAFOJ,EAAS,KAAK,WAAW,SAAU,EAAE,EAE9B,MAAM;AAAA,CAAI,EAAE,OAAQK,GAASA,EAAK,KAAK,IAAM,EAAE,EAEnE,QAAWC,KAAeF,EACxB,GAAIE,EAAY,KAAK,EAAE,WAAW,GAAG,EAAG,CACtC,IAAMC,EAAQ,KAAK,MAAMD,CAAW,EAEhCC,GAAO,QAAU,kBACnB,QAAQ,IAAI,SAAUA,CAAK,EAC3BL,EAAiBA,GAAkBK,GAAO,gBAC1CJ,GAAUI,GAAO,OAErB,CAGErB,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,EAE9D,IAAMO,EAAUE,EAEhB,MAAM,KAAK,oBAAoBjB,EAAUQ,EAAWO,EAAST,CAAQ,EAErE,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,GACX,UAAWW,CACb,CACF,CAAC,EAED,MACF,CAEA,GAAIT,EAAK,UAAY,WAAY,CAC/BG,GAAY,iBACZ,IAAMC,EAAe,CACnB,OAAQ,CACN,MAAOR,EACP,UAAWK,EACX,SAAUC,EACV,aAAcT,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,EACA,cAAe,WACf,KAAMQ,CACR,EAEA,GAAI,KAAK,eAAeL,CAAO,EAAG,CAChC,IAAMS,EAAeT,EAAQ,MAAM,GAAG,EAEtCQ,EAAQ,MAAQ,CACd,CACE,KAAM,QACN,gBAAiB,aACjB,IAAKC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,CACnC,CACF,EACAD,EAAQ,OAAO,MAAQC,EAAa,CAAC,GAAKT,CAC5C,CAEIH,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,IAAMM,EAAW,MAAMpB,GAAM,KAAKgB,EAAUC,EAAS,CACnD,QAAS,CACP,cAAe,UAAUJ,EAAK,MAAM,EACtC,CACF,CAAC,EAEGP,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,EAE9D,IAAMO,EAAUD,GAAU,MAAM,KAAK,QAAQ,KAE7C,MAAM,KAAK,oBAAoBd,EAAUQ,EAAWO,EAAST,CAAQ,EAErE,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAED,MACF,CACF,OAASH,EAAO,CACd,KAAK,OAAO,MAAMA,EAAM,UAAU,MAAQA,CAAK,EAC/C,MACF,CACF,CAEA,MAAc,oBAAoBF,EAAeQ,EAAmBO,EAAiBT,EAAuB,CAC1G,IAAMgB,EAAY,0BAEdC,EAAa,GACbC,EAAY,EAEZC,EAEEC,EAAgBC,GAA+B,CACnD,IAAMC,EAAYD,EAAI,MAAM,GAAG,EAAE,IAAI,GAAG,YAAY,EAC9CE,EAAkB,CAAC,MAAO,OAAQ,MAAO,MAAO,MAAO,MAAM,EAC7DC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAqB,CAAC,MAAO,MAAO,OAAQ,MAAO,OAAQ,MAAO,OAAQ,KAAK,EAErF,OAAIH,EAAgB,SAASD,GAAa,EAAE,EAAU,QAClDE,EAAgB,SAASF,GAAa,EAAE,EAAU,QAClDG,EAAgB,SAASH,GAAa,EAAE,EAAU,QAClDI,EAAmB,SAASJ,GAAa,EAAE,EAAU,WAClD,IACT,EAEA,MAAQH,EAAQH,EAAU,KAAKP,CAAO,KAAO,MAAM,CACjD,GAAM,CAACkB,EAAWC,EAAUC,EAASR,CAAG,EAAIF,EACtCW,EAAYV,EAAaC,CAAG,EAE5BU,EAAatB,EAAQ,MAAMS,EAAWC,EAAM,KAAK,EAKvD,GAJIY,IACFd,GAAcc,GAGZD,EAAW,CACb,IAAME,EAAgBhC,EAAS,eAAiB,GAC1CiC,EAAcjC,EAAS,aAAe,EACtCkC,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAAG,CACrB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAM5B,EAAU2B,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAI7B,EAAQ,OAASwB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7EzC,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,MAAM,IAAI,QAAeqC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAM7C,EAAS,YACb,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,KAAMS,CACR,EACA,EACF,EACA8B,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEG5C,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,CAEhE,CACF,MACE,MAAMR,EAAS,YACb,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,KAAMiB,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEIa,IAAc,QAChB,MAAMpC,EAAS,cAAc,CAC3B,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,MAAOqB,EACP,QAASQ,CACX,CAAC,EAED,MAAMnC,EAAS,aACb,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,UAAW8B,EACX,MAAOT,EACP,QAASQ,CACX,EACA,KACA,EACF,CAEJ,MACEZ,GAAc,IAAIY,CAAO,KAAKR,CAAG,IAGnCH,EAAYF,EAAU,SACxB,CAEA,GAAIE,EAAYT,EAAQ,OAAQ,CAC9B,IAAM+B,EAAgB/B,EAAQ,MAAMS,CAAS,EACzCsB,EAAc,KAAK,IACrBvB,GAAcuB,EAElB,CAEA,IAAMR,EAAgBhC,EAAS,eAAiB,GAC1CiC,EAAcjC,EAAS,aAAe,EACtCkC,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAClB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAM5B,EAAU2B,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAI7B,EAAQ,OAASwB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7EzC,EAAS,cAAgBa,EAAY,mBACvC,MAAMb,EAAS,OAAO,kBAAkBQ,CAAS,EACjD,MAAMR,EAAS,OAAO,mBAAmB,YAAaQ,CAAS,GAGjE,MAAM,IAAI,QAAeqC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAM7C,EAAS,YACb,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,KAAMS,CACR,EACA,EACF,EACA8B,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEG5C,EAAS,cAAgBa,EAAY,kBACvC,MAAMb,EAAS,OAAO,mBAAmB,SAAUQ,CAAS,CAEhE,CACF,MACE,MAAMR,EAAS,YACb,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,GAAU,cAAgB,IACjC,KAAMiB,EAAW,KAAK,CACxB,EACA,EACF,EAIJwB,EAAc,mBAAmB,CACnC,CAEA,MAAc,eACZ/C,EACAQ,EACAD,EACAD,EACAD,EACAF,EACAM,EACA,CACA,IAAMR,EAAO,MAAM,KAAK,iBAAiBD,EAAU,CACjD,UAAAQ,EACA,SAAAC,EACA,MAAOF,EAAK,EACd,CAAC,EAEGN,EAAK,UACPI,EAAUJ,EAAK,SAGjB,MAAM,KAAK,iBAAiBD,EAAUK,EAASC,EAAUC,EAAMC,EAAWC,EAAUN,CAAO,CAG7F,CAEA,MAAa,YACXH,EACAQ,EACAD,EACAF,EACAC,EACAH,EACAM,EACA,CACA,GAAI,EAAAJ,GAAWA,EAAQ,SAAW,UAIlC,IAAIA,GAAWC,EAAS,QAAUA,EAAS,OAAS,EAAG,CACrD,IAAM0C,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAK5C,EAAQ,SAAS,EAAE,QAAQ,EAEvD6C,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7B5C,EAAS,OAAQ,CAC/BA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOE,EAAK,GACZ,UAAWC,CACb,CACF,CAAC,EAGH,MAAM,KAAK,eAAeR,EAAUQ,EAAWD,EAAMD,EAAUD,EAASF,EAASM,CAAQ,EACzF,MACF,CACF,CAEA,GAAI,CAACJ,EAAS,CACZ,MAAM,KAAK,eAAeL,EAAUQ,EAAWD,EAAMD,EAAUD,EAASF,EAASM,CAAQ,EACzF,MACF,CAYA,GAVA,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIJ,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEG,CAACF,EAAS,CACRG,EAAS,iBACX,KAAK,UAAU,YAAYN,EAAS,YAAY,EAAE,YAChD,CACE,OAAQQ,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOF,EAAS,cAAgB,IAChC,KAAMA,EAAS,cACjB,EACA,EACF,EAEAyC,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAIzC,EAAS,eAAiBH,EAAQ,YAAY,IAAMG,EAAS,cAAc,YAAY,EAAG,CACxFA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOE,EAAK,GACZ,UAAWC,CACb,CACF,CAAC,EAEH,MACF,CAEA,MAAM,KAAK,iBAAiBR,EAAUK,EAASC,EAAUC,EAAMC,EAAWC,EAAUN,CAAO,EAG7F,CACF,ECzmBA,OAAOgD,OAAW,QAClB,OAAS,wBAAAC,OAA4B,UACrC,OAAOC,OAAc,YACrB,OAAOC,OAAY,SACnB,OAAOC,OAAO,OAEP,IAAMC,GAAN,KAAoB,CACzB,YACmBC,EACAC,EACAC,EACjB,CAHiB,eAAAF,EACA,mBAAAC,EACA,sBAAAC,EAKnB,KAAiB,OAAS,IAAIC,EAAO,eAAe,CAJjD,CAMH,MAAc,iBAAiBC,EAAeC,EAAsBC,EAAmBC,EAAiB,CAGtG,IAAMC,EAFsBH,EAAU,eAEO,IAAKI,IACzC,CACL,KAAM,SACN,QAASA,CACX,EACD,EAIKC,EAFyBL,EAAU,kBAEU,IAAKI,IAC/C,CACL,KAAM,YACN,QAASA,CACX,EACD,EAIKE,EAFoBN,EAAU,aAEK,IAAKI,IACrC,CACL,KAAM,OACN,QAASA,CACX,EACD,EAEKG,EAAmB,CACvB,KAAM,OACN,QAAS,CAAC,CAAE,KAAM,OAAQ,KAAML,CAAQ,CAAC,CAC3C,EAEA,GAAI,KAAK,eAAeA,CAAO,EAAG,CAChC,IAAMM,EAAeN,EAAQ,MAAM,GAAG,EAEhCO,EAAMD,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAExCD,EAAY,QAAU,CACpB,CAAE,KAAM,OAAQ,KAAMC,EAAa,CAAC,GAAKN,CAAQ,EACjD,CACE,KAAM,YACN,UAAW,CACT,IAAKO,CACP,CACF,CACF,CACF,CAEA,IAAMC,EAAkB,CAAC,GAAGP,EAAgB,GAAGE,EAAmB,GAAGC,EAAcC,CAAW,EAE1FR,EAAS,cAAgBY,EAAY,mBACvC,MAAMZ,EAAS,OAAO,kBAAkBE,CAAS,EACjD,MAAMF,EAAS,OAAO,mBAAmB,YAAaE,CAAS,GAGjE,IAAMW,EAAc,MAAM,KAAK,OAAO,KAAK,YAAY,OAAO,CAC5D,MAAOZ,EAAU,MACjB,SAAUU,EACV,WAAYV,EAAU,SACxB,CAAC,EAED,OAAID,EAAS,cAAgBY,EAAY,kBACvC,MAAMZ,EAAS,OAAO,mBAAmB,SAAUE,CAAS,EAE9CW,EAAY,QAAQ,CAAC,EAAE,QAAQ,OAGjD,CAEA,MAAc,uBACZb,EACAC,EACAC,EACAY,EACAC,EACAZ,EACAa,EACA,CACA,IAAMR,EAAmB,CACvB,KAAMO,EAAS,YAAc,OAC7B,QAAS,CAAC,CAAE,KAAM,OAAQ,KAAMZ,CAAQ,CAAC,CAC3C,EAEA,GAAI,KAAK,eAAeA,CAAO,EAAG,CAChC,IAAMM,EAAeN,EAAQ,MAAM,GAAG,EAEhCO,EAAMD,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAExCD,EAAY,QAAU,CACpB,CAAE,KAAM,OAAQ,KAAMC,EAAa,CAAC,GAAKN,CAAQ,EACjD,CACE,KAAM,YACN,UAAW,CACT,IAAKO,CACP,CACF,CACF,CACF,CAIA,GAFA,MAAM,KAAK,OAAO,KAAK,QAAQ,SAAS,OAAOM,EAAUR,CAAW,EAEhEO,EAAQ,CACVE,EAAc,mBAAmB,EACjC,MACF,CAEA,IAAMC,EAAe,MAAM,KAAK,OAAO,KAAK,QAAQ,KAAK,OAAOF,EAAU,CACxE,aAAcf,EAAU,WAC1B,CAAC,EAEGD,EAAS,cAAgBY,EAAY,mBACvC,MAAMZ,EAAS,OAAO,kBAAkBE,CAAS,EACjD,MAAMF,EAAS,OAAO,mBAAmB,YAAaE,CAAS,GAGjE,IAAMiB,EAAW,MAAM,KAAK,cAAcH,EAAUE,EAAa,GAAIjB,EAAU,YAAaC,EAAWY,CAAQ,EAE/G,OAAId,EAAS,cAAgBY,EAAY,kBACvC,MAAMZ,EAAS,OAAO,mBAAmB,SAAUE,CAAS,EAE9CiB,GAAU,KAAK,CAAC,EAAE,QAAQ,CAAC,EAAE,KAAK,KAGpD,CAEA,MAAc,oBACZnB,EACAoB,EACAlB,EACAmB,EACAhB,EACA,CACA,IAAMiB,EAAY,0BAEdC,EAAa,GACbC,EAAY,EAEZC,EAEEC,EAAgBhB,GAA+B,CACnD,IAAMiB,EAAYjB,EAAI,MAAM,GAAG,EAAE,IAAI,GAAG,YAAY,EAC9CkB,EAAkB,CAAC,MAAO,OAAQ,MAAO,MAAO,MAAO,MAAM,EAC7DC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAqB,CAAC,MAAO,MAAO,OAAQ,MAAO,OAAQ,MAAO,OAAQ,KAAK,EAErF,OAAIH,EAAgB,SAASD,GAAa,EAAE,EAAU,QAClDE,EAAgB,SAASF,GAAa,EAAE,EAAU,QAClDG,EAAgB,SAASH,GAAa,EAAE,EAAU,QAClDI,EAAmB,SAASJ,GAAa,EAAE,EAAU,WAClD,IACT,EAEA,MAAQF,EAAQH,EAAU,KAAKjB,CAAO,KAAO,MAAM,CACjD,GAAM,CAAC2B,EAAWC,EAAUC,EAASxB,CAAG,EAAIe,EACtCU,EAAYT,EAAahB,CAAG,EAE5B0B,EAAa/B,EAAQ,MAAMmB,EAAWC,EAAM,KAAK,EAKvD,GAJIW,IACFb,GAAca,GAGZD,EAAW,CACb,IAAME,EAAgBhB,EAAS,eAAiB,GAC1CiB,EAAcjB,EAAS,aAAe,EACtCkB,EAAW,IACXC,EAAW,IAEjB,GAAIjB,EAAW,KAAK,EAAG,CACrB,GAAIc,EAAe,CACjB,IAAMI,EAAmBlB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASmB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMrC,EAAUoC,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAItC,EAAQ,OAASiC,EAAaC,CAAQ,EAAGC,CAAQ,EAE7ExC,EAAS,cAAgBY,EAAY,mBACvC,MAAMZ,EAAS,OAAO,kBAAkBE,CAAS,EACjD,MAAMF,EAAS,OAAO,mBAAmB,YAAaE,CAAS,GAGjE,MAAM,IAAI,QAAe0C,GAAY,CACnC,WAAW,SAAY,CACrB,MAAM5C,EAAS,YACb,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,KAAMhB,CACR,EACA,EACF,EACAuC,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEG3C,EAAS,cAAgBY,EAAY,kBACvC,MAAMZ,EAAS,OAAO,mBAAmB,SAAUE,CAAS,CAEhE,CACF,MACE,MAAMF,EAAS,YACb,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,KAAME,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEIY,IAAc,QAChB,MAAMnC,EAAS,cAAc,CAC3B,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,MAAOX,EACP,QAASwB,CACX,CAAC,EAED,MAAMlC,EAAS,aACb,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,UAAWc,EACX,MAAOzB,EACP,QAASwB,CACX,EACA,KACA,EACF,CAEJ,MACEX,GAAc,IAAIW,CAAO,KAAKxB,CAAG,IAGnCc,EAAYF,EAAU,SACxB,CAEA,GAAIE,EAAYnB,EAAQ,OAAQ,CAC9B,IAAMwC,EAAgBxC,EAAQ,MAAMmB,CAAS,EACzCqB,EAAc,KAAK,IACrBtB,GAAcsB,EAElB,CAEA,IAAMR,EAAgBhB,EAAS,eAAiB,GAC1CiB,EAAcjB,EAAS,aAAe,EACtCkB,EAAW,IACXC,EAAW,IAEjB,GAAIjB,EAAW,KAAK,EAAG,CACrB,GAAIc,EAAe,CACjB,IAAMI,EAAmBlB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASmB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMrC,EAAUoC,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAItC,EAAQ,OAASiC,EAAaC,CAAQ,EAAGC,CAAQ,EAE7ExC,EAAS,cAAgBY,EAAY,mBACvC,MAAMZ,EAAS,OAAO,kBAAkBE,CAAS,EACjD,MAAMF,EAAS,OAAO,mBAAmB,YAAaE,CAAS,GAGjE,MAAM,IAAI,QAAe0C,GAAY,CACnC,WAAW,SAAY,CACrB,MAAM5C,EAAS,YACb,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,KAAMhB,CACR,EACA,EACF,EACAuC,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEG3C,EAAS,cAAgBY,EAAY,kBACvC,MAAMZ,EAAS,OAAO,mBAAmB,SAAUE,CAAS,CAEhE,CACF,MACE,MAAMF,EAAS,YACb,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,GAAU,cAAgB,IACjC,KAAME,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEAN,EAAc,mBAAmB,EAEjC,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIG,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,CACH,CAEA,MAAa,0BAA0BpB,EAAuB8C,EAAW,CACvE,GAAIA,EAAK,YAAc,mBAAoB,OAE3C,IAAMC,EAAQ,MAAM,KAAK,iBAAiB,YAAY,UAAU,CAC9D,MAAO,CACL,GAAID,EAAK,aACX,CACF,CAAC,EAED,GAAI,CAACC,EAAO,MAAM,IAAI,MAAM,wBAAwB,EAEpD,GAAI,CACF,KAAK,OAAS,IAAItD,GAAO,CACvB,OAAQsD,EAAM,MAChB,CAAC,EAED,IAAM/B,GAAY,MAAM,KAAK,OAAO,KAAK,QAAQ,OAAO,CAAC,CAAC,GAAG,GAEzDI,EAAU,KACd,OAAIJ,IACFI,EAAU,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CAC9D,KAAM,CACJ,UAAW0B,EAAK,UAChB,SAAUA,EAAK,SACf,UAAW9B,EACX,OAAQ,SACR,UAAW,GACX,MAAO8B,EAAK,MACZ,WAAY9C,EAAS,WACrB,KAAM,QACR,CACF,CAAC,GAEI,CAAE,QAAAoB,CAAQ,CACnB,OAAS4B,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEA,MAAc,wBACZhD,EACAE,EACAY,EACAC,EACAd,EACAoB,EACAD,EACAjB,EACA,CACA,IAAM2C,EAAO,MAAM,KAAK,0BAA0B9C,EAAU,CAC1D,UAAAE,EACA,SAAAY,EACA,cAAeb,EAAU,cACzB,MAAOA,EAAU,EACnB,CAAC,EAEG6C,EAAK,UACP1B,EAAU0B,EAAK,SAGjB,IAAMzC,EAAU,MAAM,KAAK,uBACzBL,EACAC,EACAC,EACAY,EACAC,EACAZ,EACAiB,EAAQ,SACV,EAEA,MAAM,KAAK,oBAAoBpB,EAAUoB,EAASlB,EAAWmB,EAAUhB,CAAO,CAGhF,CAEQ,OAAO4C,EAAsB,CACnC,GAAI,CACF,YAAK,MAAMA,CAAG,EACP,EACT,MAAY,CACV,MAAO,EACT,CACF,CAEA,MAAc,cACZjC,EACAkC,EACAC,EACAjD,EACAY,EACA,CACA,IAAMsC,EAAS,MAAM,KAAK,OAAO,KAAK,QAAQ,KAAK,SAASpC,EAAUkC,CAAK,EACvEG,EACJ,OAAQD,EAAO,OAAQ,CACrB,IAAK,kBAGH,GAFAC,EAAYD,GAAQ,iBAAiB,qBAAqB,WAEtDC,EACF,QAAWC,KAAYD,EAAW,CAChC,IAAME,EAAKD,EAAS,GACdE,EAAeF,GAAU,UAAU,KACnCG,EAAmB,KAAK,OAAOH,GAAU,UAAU,SAAS,EAC9D,KAAK,MAAMA,GAAU,UAAU,SAAS,EACxCA,GAAU,UAAU,UAEpBI,EAAS,KAEb,GAAI,CACF,GAAM,CAAE,KAAAZ,CAAK,EAAI,MAAMxD,GAAM,KAAK6D,EAAa,CAC7C,KAAMK,EACN,UAAW,CAAE,GAAGC,EAAkB,UAAAvD,EAAW,SAAAY,CAAS,CACxD,CAAC,EAED4C,EAAS,KAAK,UAAUZ,CAAI,EACzB,QAAQ,MAAO,MAAM,EACrB,QAAQ,KAAM,KAAK,EACnB,QAAQ,MAAO,KAAK,EACpB,QAAQ,MAAO,KAAK,EACpB,QAAQ,MAAO,KAAK,CACzB,OAASE,EAAO,CACdU,EAAS,KAAK,UAAUV,CAAK,EAC1B,QAAQ,MAAO,MAAM,EACrB,QAAQ,KAAM,KAAK,EACnB,QAAQ,MAAO,KAAK,EACpB,QAAQ,MAAO,KAAK,EACpB,QAAQ,MAAO,KAAK,CACzB,CAEA,MAAM,KAAK,OAAO,KAAK,QAAQ,KAAK,kBAAkBhC,EAAUkC,EAAO,CACrE,aAAc,CACZ,CACE,aAAcK,EACd,OAAAG,CACF,CACF,CACF,CAAC,CACH,CAGF,OAAO,KAAK,cAAc1C,EAAUkC,EAAOC,EAAajD,EAAWY,CAAQ,EAC7E,IAAK,SACH,aAAM,IAAI,QAAS8B,GAAY,WAAWA,EAAS,GAAI,CAAC,EACjD,KAAK,cAAc5B,EAAUkC,EAAOC,EAAajD,EAAWY,CAAQ,EAC7E,IAAK,cACH,aAAM,IAAI,QAAS8B,GAAY,WAAWA,EAAS,GAAI,CAAC,EACjD,KAAK,cAAc5B,EAAUkC,EAAOC,EAAajD,EAAWY,CAAQ,EAC7E,IAAK,YACH,OAAO,MAAM,KAAK,OAAO,KAAK,QAAQ,SAAS,KAAKE,EAAU,CAC5D,OAAQkC,EACR,MAAO,CACT,CAAC,CACL,CACF,CAEQ,eAAe/C,EAAiB,CACtC,OAAOA,EAAQ,SAAS,cAAc,CACxC,CAEA,MAAa,uBACXH,EACAE,EACAY,EACAC,EACAd,EACAmB,EACAC,EACAlB,EACA,CACA,GAAIiB,GAAWA,EAAQ,SAAW,SAChC,OAGF,GAAIA,GAAWC,EAAS,QAAUA,EAAS,OAAS,EAAG,CACrD,IAAMsC,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAKxC,EAAQ,SAAS,EAAE,QAAQ,EAEvDyC,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7BxC,EAAS,OAAQ,CAC/BA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOnB,EAAU,GACjB,UAAWC,CACb,CACF,CAAC,EAGH,MAAM,KAAK,wBACTF,EACAE,EACAY,EACAC,EACAd,EACAoB,EACAD,EACAjB,CACF,EACA,MACF,CACF,CAEA,GAAI,CAACiB,EAAS,CACZ,MAAM,KAAK,wBAAwBpB,EAAUE,EAAWY,EAAUC,EAAQd,EAAWoB,EAAUD,EAASjB,CAAO,EAC/G,MACF,CAaA,GAXIiB,EAAQ,SAAW,UACrB,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEC,CAACjB,EAAS,CACRkB,EAAS,iBACX,KAAK,UAAU,YAAYrB,EAAS,YAAY,EAAE,YAChD,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,EAAS,cAAgB,IAChC,KAAMA,EAAS,cACjB,EACA,EACF,EAEAJ,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAII,EAAS,eAAiBlB,EAAQ,YAAY,IAAMkB,EAAS,cAAc,YAAY,EAAG,CACxFA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOnB,EAAU,GACjB,UAAWC,CACb,CACF,CAAC,EAEH,MACF,CAEA,IAAM6C,EAAQ,MAAM,KAAK,iBAAiB,YAAY,UAAU,CAC9D,MAAO,CACL,GAAI9C,EAAU,aAChB,CACF,CAAC,EAED,GAAI,CAAC8C,EAAO,MAAM,IAAI,MAAM,wBAAwB,EAEpD,KAAK,OAAS,IAAItD,GAAO,CACvB,OAAQsD,EAAM,MAChB,CAAC,EAED,IAAM/B,EAAWI,EAAQ,UAEnBf,EAAU,MAAM,KAAK,uBACzBL,EACAC,EACAC,EACAY,EACAC,EACAZ,EACAa,CACF,EAEA,MAAM,KAAK,oBAAoBhB,EAAUoB,EAASlB,EAAWmB,EAAUhB,CAAO,CAGhF,CAEA,MAAa,+BAA+BL,EAAuB8C,EAAW,CAC5E,GAAIA,EAAK,YAAc,mBAAoB,OAE3C,IAAMS,EAAK,KAAK,MAAM,KAAK,OAAO,EAAI,IAAW,EAAE,SAAS,EAEtDR,EAAQ,MAAM,KAAK,iBAAiB,YAAY,UAAU,CAC9D,MAAO,CACL,GAAID,EAAK,aACX,CACF,CAAC,EAED,GAAI,CAACC,EAAO,MAAM,IAAI,MAAM,wBAAwB,EAEpD,GAAI,CAcF,MAAO,CAAE,QAbO,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpE,KAAM,CACJ,UAAWD,EAAK,UAChB,SAAUA,EAAK,SACf,UAAWS,EACX,OAAQ,SACR,UAAW,GACX,MAAOT,EAAK,MACZ,WAAY9C,EAAS,WACrB,KAAM,QACR,CACF,CAAC,EAEiB,MAAA+C,CAAM,CAC1B,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEA,MAAc,6BACZhD,EACAE,EACAY,EACAb,EACAoB,EACAD,EACAjB,EACA,CACA,IAAM2C,EAAO,MAAM,KAAK,+BAA+B9C,EAAU,CAC/D,UAAAE,EACA,SAAAY,EACA,cAAeb,EAAU,cACzB,MAAOA,EAAU,EACnB,CAAC,EAEDmB,EAAU0B,EAAK,QAEf,IAAMC,EAAQD,EAAK,MAEnB,KAAK,OAAS,IAAIrD,GAAO,CACvB,OAAQsD,EAAM,MAChB,CAAC,EAED,IAAM1C,EAAU,MAAM,KAAK,iBAAiBL,EAAUC,EAAWC,EAAWC,CAAO,EAEnF,MAAM,KAAK,oBAAoBH,EAAUoB,EAASlB,EAAWmB,EAAUhB,CAAO,CAGhF,CAEA,MAAa,4BACXL,EACAE,EACAY,EACAb,EACAmB,EACAC,EACAlB,EACA,CACA,GAAIiB,GAAWA,EAAQ,SAAW,SAChC,OAGF,GAAIA,GAAWC,EAAS,QAAUA,EAAS,OAAS,EAAG,CACrD,IAAMsC,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAKxC,EAAQ,SAAS,EAAE,QAAQ,EAEvDyC,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7BxC,EAAS,OAAQ,CAC/BA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOnB,EAAU,GACjB,UAAWC,CACb,CACF,CAAC,EAGH,MAAM,KAAK,6BAA6BF,EAAUE,EAAWY,EAAUb,EAAWoB,EAAUD,EAASjB,CAAO,EAC5G,MACF,CACF,CAEA,GAAI,CAACiB,EAAS,CACZ,MAAM,KAAK,6BAA6BpB,EAAUE,EAAWY,EAAUb,EAAWoB,EAAUD,EAASjB,CAAO,EAC5G,MACF,CAYA,GAVA,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIiB,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEG,CAACjB,EAAS,CACRkB,EAAS,iBACX,KAAK,UAAU,YAAYrB,EAAS,YAAY,EAAE,YAChD,CACE,OAAQE,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOmB,EAAS,cAAgB,IAChC,KAAMA,EAAS,cACjB,EACA,EACF,EAEAJ,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAII,EAAS,eAAiBlB,EAAQ,YAAY,IAAMkB,EAAS,cAAc,YAAY,EAAG,CACxFA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOnB,EAAU,GACjB,UAAWC,CACb,CACF,CAAC,EAEH,MACF,CAEA,IAAM6C,EAAQ,MAAM,KAAK,iBAAiB,YAAY,UAAU,CAC9D,MAAO,CACL,GAAI9C,EAAU,aAChB,CACF,CAAC,EAED,GAAI,CAAC8C,EAAO,MAAM,IAAI,MAAM,wBAAwB,EAEpD,KAAK,OAAS,IAAItD,GAAO,CACvB,OAAQsD,EAAM,MAChB,CAAC,EAED,IAAM1C,EAAU,MAAM,KAAK,iBAAiBL,EAAUC,EAAWC,EAAWC,CAAO,EAEnF,MAAM,KAAK,oBAAoBH,EAAUoB,EAASlB,EAAWmB,EAAUhB,CAAO,CAGhF,CAEA,MAAa,aAAa0C,EAAoBe,EAAUC,EAAyB,CAC/E,IAAIC,EAEAF,GAAK,SAAS,SAChBE,EAAQ,MAAM1E,GAAM,IAAIwE,EAAI,QAAQ,SAAU,CAAE,aAAc,aAAc,CAAC,EAAE,KAAM3C,GAC5E,OAAO,KAAKA,EAAS,KAAM,QAAQ,CAC3C,EAED6C,EAAQ,MAAMzE,GACZ,CAAE,IAAKuE,EAAI,IAAK,QAASA,GAAK,OAAQ,EACtC,SACA,CAAC,EACD,CACE,OAAQpE,GAAE,CAAE,MAAO,OAAQ,CAAC,EAC5B,gBAAiBqE,CACnB,CACF,EAGF,IAAME,EAAO,KAAK,cAAc,IAAc,UAAU,EAAE,SAAS,IAAI,EACnE,KACA,KAAK,cAAc,IAAc,UAAU,EAEzCC,EAAW,IAAI1E,GAErB,OAAA0E,EAAS,OAAO,OAAQF,EAAO,WAAW,EAC1CE,EAAS,OAAO,QAAS,WAAW,EACpCA,EAAS,OAAO,WAAYD,CAAI,GAEf,MAAM3E,GAAM,KAAK,iDAAkD4E,EAAU,CAC5F,QAAS,CACP,eAAgB,sBAChB,cAAe,UAAUnB,EAAM,MAAM,EACvC,CACF,CAAC,IAEgB,MAAM,IACzB,CACF,ECp1BA,IAAMoB,GAAkBC,GAAa,CACnC,IAAIC,EAEAC,EAAc,IAAQ,IAAI,EAAE,OAAQD,EAAUD,EAAI,QAAQ,SACzDC,EAAUD,EAAI,IAAI,GAEvB,IAAMG,EAAQ,CACZ,aAAcH,GAAK,SAAS,aAC5B,oBAAqBA,GAAK,SAAS,qBAAqB,KACxD,eAAgBA,GAAK,SAAS,gBAAgB,YAC9C,gBAAiBA,GAAK,SAAS,iBAAiB,gBAChD,kBACEA,GAAK,SAAS,mBAAmB,SAAS,cAAc,KACxDA,GAAK,SAAS,mBAAmB,SAAS,cAAc,KACxDA,GAAK,SAAS,mBAAmB,SAAS,cAAc,IAC1D,oBAAqBA,GAAK,SAAS,qBAAqB,MACxD,cAAeA,GAAK,SAAS,qBAAqB,mBAAmB,cACrE,2BACEA,GAAK,SAAS,4BAA4B,YAAcA,GAAK,SAAS,wBAAwB,iBAEhG,aAAcA,GAAK,SAAS,aACxBA,GAAK,SAAS,aACdA,GAAK,SAAS,aACZ,gBAAgBC,CAAO,GACvB,OACN,aAAcD,GAAK,SAAS,aACxB,gBAAgBC,CAAO,GAAGD,GAAK,SAAS,cAAc,QAAU,IAAIA,GAAK,SAAS,cAAc,OAAO,GAAK,EAAE,GAC9G,OACJ,aAAcA,GAAK,SAAS,aACxB,gBAAgBC,CAAO,GAAGD,GAAK,SAAS,cAAc,QAAU,IAAIA,GAAK,SAAS,cAAc,OAAO,GAAK,EAAE,GAC9G,OACJ,gBAAiBA,GAAK,SAAS,gBAC3B,mBAAmBC,CAAO,GACxBD,GAAK,SAAS,iBAAiB,QAAU,IAAIA,GAAK,SAAS,iBAAiB,OAAO,GAAK,EAC1F,GACA,OACJ,2BAA4BA,GAAK,SAAS,4BAA4B,SAAS,gBAC3E,8BAA8BC,CAAO,GACnCD,GAAK,SAAS,4BAA4B,SAAS,iBAAiB,QAChE,IAAIA,GAAK,SAAS,4BAA4B,SAAS,iBAAiB,OAAO,GAC/E,EACN,GACA,OACJ,oBAAqBA,GAAK,aAAa,iBAAiB,KACpD,uBAAuBA,EAAI,YAAY,gBAAgB,IAAI,GAC3D,MACN,EAEMI,EAAc,OAAO,KAAKD,CAAK,EAAE,KAAME,GAAQF,EAAME,CAAG,IAAM,MAAS,GAAK,UAElF,MAAO,CAAE,GAAGF,EAAO,YAAAC,CAAY,CACjC,EAEME,GAAqBH,GAAe,CACxC,IAAMI,EAAU,OAAO,KAAKJ,CAAK,EAAE,KAAME,GAAQA,IAAQ,uBAAyBF,EAAME,CAAG,IAAM,MAAS,EAEtGG,EAASD,EAAUJ,EAAMI,CAAO,EAAI,OAExC,OAAIJ,EAAM,sBACRK,EAASA,EAAS,GAAGA,CAAM;AAAA,EAAKL,EAAM,mBAAmB,GAAKA,EAAM,qBAG/DK,CACT,EAEaC,GAA0BT,GAAa,CAClD,IAAMG,EAAQJ,GAAeC,CAAG,EAIhC,OAFuBM,GAAkBH,CAAK,CAGhD,EClEA,OAAOO,OAAW,QAEX,IAAMC,GAAN,KAAqB,CAC1B,YACmBC,EACAC,EACAC,EACjB,CAHiB,eAAAF,EACA,mBAAAC,EACA,sBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,gBAAgB,CAFlD,CAIH,MAAa,iBAAiBC,EAAoBC,EAAW,CAC3D,GAAIA,EAAK,YAAc,mBAAoB,OAC3C,IAAMC,EAAK,KAAK,MAAM,KAAK,OAAO,EAAI,IAAW,EAAE,SAAS,EAE5D,GAAI,CACF,IAAMC,EAAU,KAAK,cAAc,IAAa,SAAS,EAAE,YACvDC,EACAC,EACAF,IAAY,UACdC,EAAM,GAAGH,EAAK,GAAG,oBAAoBA,EAAK,OAAO,aAEjDI,EAAU,CACR,mBAAoB,CAClB,GAAGJ,EAAK,mBACR,UAAWA,EAAK,UAChB,SAAUA,EAAK,UAAYA,EAAK,oBAAoB,UAAY,GAChE,aAAcD,EAAS,KACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,IAC/D,SAAUA,EAAS,MACrB,CACF,IAEAI,EAAM,GAAGH,EAAK,GAAG,sBAEjBI,EAAU,CACR,YAAa,CACX,SAAUJ,EAAK,QACf,mBAAoB,CAClB,GAAGA,EAAK,mBACR,UAAWA,EAAK,UAChB,SAAUA,EAAK,UAAYA,EAAK,oBAAoB,UAAY,GAChE,aAAcD,EAAS,KACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,IAC/D,SAAUA,EAAS,MACrB,CACF,CACF,GAEF,IAAMM,EAAU,MAAMZ,GAAM,KAAKU,EAAKC,CAAO,EAEzCE,EAAU,KACd,OAAID,GAAS,MAAM,YACjBC,EAAU,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CAC9D,KAAM,CACJ,UAAWN,EAAK,UAChB,SAAUA,EAAK,UAAY,GAC3B,UAAW,GAAGC,CAAE,IAAII,EAAQ,KAAK,SAAS,GAC1C,OAAQ,SACR,WAAY,CACV,GAAGL,EAAK,mBACR,UAAWA,EAAK,UAChB,SAAUA,EAAK,UAAY,GAC3B,aAAcD,EAAS,KACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,IAC/D,SAAUA,EAAS,MACrB,EACA,UAAW,GACX,MAAOC,EAAK,MACZ,WAAYD,EAAS,GACrB,KAAM,SACR,CACF,CAAC,GAEI,CAAE,GAAGM,EAAQ,KAAM,QAAAC,CAAQ,CACpC,OAASC,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEA,MAAa,cACXR,EACAO,EACAE,EASAC,EACAC,EACAC,EACAC,EACA,CACAC,EACE,KAAK,UAAU,YAAYd,EAAS,IAAI,EACxCO,EACAE,EACAE,EACAC,EACAC,EACAE,EACA,KAAK,gBACP,EAAE,MAAOC,GAAQ,CACf,QAAQ,MAAM,+BAAgCA,CAAG,CACnD,CAAC,EAED,SAASC,EAA4BC,EAAOC,EAAU,CACpD,GAAI,CAACD,EAAO,OAAO,KAEnB,QAAWE,KAAQF,EACjB,GAAIE,EAAK,oBAAsBD,EAC7B,OAAOC,EAAK,MAAM,iBAGtB,OAAO,IACT,CAEA,SAASL,EAAgBM,EAAS,CAChC,IAAIC,EAAO,GAMX,GAJID,EAAQ,OACVC,GAAQD,EAAQ,MAGdA,EAAQ,UAAYA,EAAQ,OAAS,IACvC,QAAWE,KAASF,EAAQ,SAC1BC,GAAQP,EAAgBQ,CAAK,EAI7BF,EAAQ,OAAS,KAAOA,EAAQ,OAAS,oBAC3CC,EAAOA,EAAK,KAAK,EAAI;AAAA,GAGnBD,EAAQ,OAAS,oBACnBC,EAAOA,EAAK,KAAK,GAGfD,EAAQ,OAAS,OACnBC,EACE;AAAA,EACAA,EACG,MAAM;AAAA,CAAI,EACV,IAAI,CAACE,EAAMC,IAAWD,EAAO,GAAGC,EAAQ,CAAC,KAAKD,CAAI,GAAK,EAAG,EAC1D,KAAK;AAAA,CAAI,GAGZH,EAAQ,OAAS,OACnBC,EAAOA,EACJ,MAAM;AAAA,CAAI,EACV,IAAKE,GAAUA,EAAO,KAAKA,CAAI,GAAK,EAAG,EACvC,KAAK;AAAA,CAAI,GAGd,IAAIE,EAAU,GAEVL,EAAQ,OACVK,GAAW,KAGTL,EAAQ,SACVK,GAAW,KAGTL,EAAQ,YACVK,GAAW,KAGb,IAAIC,EAAgB,GAAGD,CAAO,GAAGJ,CAAI,GAAGI,EAAQ,MAAM,EAAE,EAAE,QAAQ,EAAE,KAAK,EAAE,CAAC,GAE5E,OAAIL,EAAQ,MACVM,EAAgBN,EAAQ,SAAS,CAAC,GAAG,KAAO,IAAIM,CAAa;AAAA,GAAON,EAAQ,GAAG,IAAM,GAAGA,EAAQ,GAAG,IAG9FM,CACT,CAEA,eAAeb,EACbd,EACAO,EACAE,EASAE,EACAC,EACAC,EACAE,EACAjB,EACA,CACA,QAAW8B,KAAWjB,EAAU,CAC9B,GAAIiB,EAAQ,OAAS,OAAQ,CAC3B,IAAID,EAAgB,GAEpB,QAAWE,KAAYD,EAAQ,QAAQ,SAAU,CAC/C,QAAWP,KAAWQ,EAAS,SAC7BF,GAAiBZ,EAAgBM,CAAO,EAE1CM,GAAiB;AAAA,CACnB,CAMA,GAJAA,EAAgBA,EAAc,QAAQ,QAAS,EAAE,EAAE,QAAQ,KAAM,EAAE,EAAE,QAAQ,KAAM,EAAE,EAAE,QAAQ,MAAO,EAAE,EAExGA,EAAgBA,EAAc,QAAQ,MAAO,EAAE,EAE3CA,EAAc,SAAS,QAAQ,EAAG,CACpC,IAAMG,EAAW,CACf,OAAQpB,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAO,GACP,YAAa,GACb,WAAY,GACZ,WAAY,GACZ,SAAU,CAAC,CACb,EAEMqB,EAAaJ,EAAc,MAAM,wCAAwC,EACzEK,EAAmBL,EAAc,MAAM,6CAA6C,EACpFM,EAAkBN,EAAc,MAAM,4CAA4C,EAClFO,EAAkBP,EAAc,MAAM,sCAAsC,EAE9EI,IAAYD,EAAS,MAAQC,EAAW,CAAC,EAAE,KAAK,GAChDC,IAAkBF,EAAS,YAAcE,EAAiB,CAAC,EAAE,KAAK,GAClEC,IAAiBH,EAAS,WAAaG,EAAgB,CAAC,EAAE,KAAK,GAC/DC,IAAiBJ,EAAS,WAAaI,EAAgB,CAAC,EAAE,KAAK,GAEnE,IAAMC,EAAcR,EAAc,MAAM,8BAA8B,IAAI,CAAC,EAC3E,GAAIQ,EAAa,CACf,IAAMC,EAAWD,EAAY,MAAM,gEAAgE,EAC/FC,GACFA,EAAS,QAASC,GAAY,CAC5B,IAAMC,EAAeD,EAAQ,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EAChEE,EAAOF,EAAQ,MAAM,kEAAkE,EAEvFG,EAAc,CAClB,MAAOF,EACP,KACEC,GAAM,IAAKE,KAAS,CAClB,MAAOA,GAAI,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EACpD,YAAaA,GAAI,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAChE,MAAOA,GAAI,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,CACtD,EAAE,GAAK,CAAC,CACZ,EAEAX,EAAS,SAAS,KAAKU,CAAW,CACpC,CAAC,CAEL,CAEA,MAAMxC,EAAS,YAAY8B,CAAQ,CACrC,SAAWH,EAAc,SAAS,WAAW,EAAG,CAC9C,IAAMe,EAAa,CACjB,OAAQhC,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,aAAc,OACd,MAAO,GACP,YAAa,GACb,OAAQ,GACR,QAAS,CAAC,CACZ,EAEMiC,EAAoBhB,EAAc,MAAM,yCAAyC,EACjFI,EAAaJ,EAAc,MAAM,wCAAwC,EACzEK,EAAmBL,EAAc,MAAM,yCAAyC,EAChFiB,EAAcjB,EAAc,MAAM,uDAAuD,EAE3FI,IAAYW,EAAW,MAAQX,EAAW,CAAC,EAAE,KAAK,GAClDY,IAAmBD,EAAW,aAAeC,EAAkB,CAAC,EAAE,KAAK,GACvEX,IAAkBU,EAAW,YAAcV,EAAiB,CAAC,EAAE,KAAK,GACpEY,IAAaF,EAAW,OAASE,EAAY,CAAC,EAAE,KAAK,GAEzD,IAAMC,EAAc,CAClB,MAAO,0DACP,IAAK,wDACL,KAAM,yDACN,KAAM,yDACN,IAAK,uDACP,EAEA,OAAW,CAACC,EAAMC,CAAO,IAAK,OAAO,QAAQF,CAAW,EAAG,CACzD,IAAIG,EACJ,MAAQA,EAAQD,EAAQ,KAAKpB,CAAa,KAAO,MAAM,CACrD,IAAMsB,EAAUD,EAAM,CAAC,EAAE,KAAK,EACxBE,EAAc,CAAE,KAAAJ,CAAK,EAE3B,OAAQA,EAAM,CACZ,IAAK,MACHI,EAAO,SAAWD,EAAQ,MAAM,yBAAyB,IAAI,CAAC,GAAG,KAAK,EACtEC,EAAO,KAAOD,EAAQ,MAAM,qBAAqB,IAAI,CAAC,GAAG,KAAK,EAC9DC,EAAO,QAAUD,EAAQ,MAAM,wBAAwB,IAAI,CAAC,GAAG,KAAK,EACpEC,EAAO,IAAMD,EAAQ,MAAM,oBAAoB,IAAI,CAAC,GAAG,KAAK,EAC5D,MAEF,IAAK,QACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,GAAKD,EAAQ,MAAM,mBAAmB,IAAI,CAAC,GAAG,KAAK,EAC1D,MAEF,IAAK,OACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,SAAWD,EAAQ,MAAM,yBAAyB,IAAI,CAAC,GAAG,KAAK,EACtE,MAEF,IAAK,OACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,YAAcD,EAAQ,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EACtE,MAEF,IAAK,MACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,IAAMD,EAAQ,MAAM,oBAAoB,IAAI,CAAC,GAAG,KAAK,EAC5D,KACJ,CAEI,OAAO,KAAKC,CAAM,EAAE,OAAS,GAC/BR,EAAW,QAAQ,KAAKQ,CAAM,CAElC,CACF,CAEA,MAAMlD,EAAS,cAAc0C,CAAU,CACzC,MACE,MAAM1C,EAAS,YACb,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOD,GAAU,cAAgB,IACjC,KAAMkB,CACR,EACA,EACF,EAGFwB,EAAc,mBAAmB,CACnC,CAEIvB,EAAQ,OAAS,UACnB,MAAM5B,EAAS,aACb,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOD,GAAU,cAAgB,IACjC,UAAW,QACX,MAAOmB,EAAQ,QAAQ,GACzB,EACA,KACA,EACF,EAEAuB,EAAc,oBAAoB,GAGhCvB,EAAQ,OAAS,UACnB,MAAM5B,EAAS,aACb,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOD,GAAU,cAAgB,IACjC,UAAW,QACX,MAAOmB,EAAQ,QAAQ,GACzB,EACA,KACA,EACF,EAEAuB,EAAc,oBAAoB,GAGhCvB,EAAQ,OAAS,UACnB,MAAM5B,EAAS,cACb,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOD,GAAU,cAAgB,IACjC,SAAU,GACV,MAAOmB,EAAQ,QAAQ,GACzB,EACA,EACF,EAEAuB,EAAc,4BAA4B,GAG5C,IAAMC,EAAOnC,EAA4BJ,EAAmBe,EAAQ,EAAE,EAElEwB,GACF,MAAM,IAAI,QAASC,GAAY,WAAWA,EAASD,EAAO,GAAI,CAAC,CAEnE,CAGA,GADA,QAAQ,IAAI,QAASxC,CAAK,EACtBA,EAAO,CACT,GAAIA,EAAM,OAAS,eAAgB,CACjC,IAAIe,EAAgB,GAEd2B,EAAQ1C,EAAM,MAEpB,QAAWQ,KAAQkC,EACjB3B,GAAiB,gBAAMP,EAAK,OAAO;AAAA,EAKrC,GAFAO,EAAgBA,EAAc,QAAQ,MAAO,EAAE,EAE3CA,EAAc,SAAS,QAAQ,EAAG,CACpC,IAAMG,EAAW,CACf,OAAQpB,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAO,GACP,YAAa,GACb,WAAY,GACZ,WAAY,GACZ,SAAU,CAAC,CACb,EAEMqB,EAAaJ,EAAc,MAAM,wCAAwC,EACzEK,EAAmBL,EAAc,MAAM,6CAA6C,EACpFM,EAAkBN,EAAc,MAAM,4CAA4C,EAClFO,EAAkBP,EAAc,MAAM,sCAAsC,EAE9EI,IAAYD,EAAS,MAAQC,EAAW,CAAC,EAAE,KAAK,GAChDC,IAAkBF,EAAS,YAAcE,EAAiB,CAAC,EAAE,KAAK,GAClEC,IAAiBH,EAAS,WAAaG,EAAgB,CAAC,EAAE,KAAK,GAC/DC,IAAiBJ,EAAS,WAAaI,EAAgB,CAAC,EAAE,KAAK,GAEnE,IAAMC,EAAcR,EAAc,MAAM,8BAA8B,IAAI,CAAC,EAC3E,GAAIQ,EAAa,CACf,IAAMC,EAAWD,EAAY,MAAM,gEAAgE,EAC/FC,GACFA,EAAS,QAASC,GAAY,CAC5B,IAAMC,EAAeD,EAAQ,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EAChEE,EAAOF,EAAQ,MAAM,kEAAkE,EAEvFG,EAAc,CAClB,MAAOF,EACP,KACEC,GAAM,IAAKE,IAAS,CAClB,MAAOA,EAAI,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EACpD,YAAaA,EAAI,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAChE,MAAOA,EAAI,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,CACtD,EAAE,GAAK,CAAC,CACZ,EAEAX,EAAS,SAAS,KAAKU,CAAW,CACpC,CAAC,CAEL,CAEA,MAAMxC,EAAS,YAAY8B,CAAQ,CACrC,SAAWH,EAAc,SAAS,WAAW,EAAG,CAC9C,IAAMe,EAAa,CACjB,OAAQhC,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,aAAc,OACd,MAAO,GACP,YAAa,GACb,OAAQ,GACR,QAAS,CAAC,CACZ,EAEMiC,EAAoBhB,EAAc,MAAM,yCAAyC,EACjFI,EAAaJ,EAAc,MAAM,wCAAwC,EACzEK,EAAmBL,EAAc,MAAM,yCAAyC,EAChFiB,EAAcjB,EAAc,MAAM,uDAAuD,EAE3FI,IAAYW,EAAW,MAAQX,EAAW,CAAC,EAAE,KAAK,GAClDY,IAAmBD,EAAW,aAAeC,EAAkB,CAAC,EAAE,KAAK,GACvEX,IAAkBU,EAAW,YAAcV,EAAiB,CAAC,EAAE,KAAK,GACpEY,IAAaF,EAAW,OAASE,EAAY,CAAC,EAAE,KAAK,GAEzD,IAAMC,EAAc,CAClB,MAAO,0DACP,IAAK,wDACL,KAAM,yDACN,KAAM,yDACN,IAAK,uDACP,EAEA,OAAW,CAACC,EAAMC,CAAO,IAAK,OAAO,QAAQF,CAAW,EAAG,CACzD,IAAIG,EACJ,MAAQA,EAAQD,EAAQ,KAAKpB,CAAa,KAAO,MAAM,CACrD,IAAMsB,EAAUD,EAAM,CAAC,EAAE,KAAK,EACxBE,EAAc,CAAE,KAAAJ,CAAK,EAE3B,OAAQA,EAAM,CACZ,IAAK,MACHI,EAAO,SAAWD,EAAQ,MAAM,yBAAyB,IAAI,CAAC,GAAG,KAAK,EACtEC,EAAO,KAAOD,EAAQ,MAAM,qBAAqB,IAAI,CAAC,GAAG,KAAK,EAC9DC,EAAO,QAAUD,EAAQ,MAAM,wBAAwB,IAAI,CAAC,GAAG,KAAK,EACpEC,EAAO,IAAMD,EAAQ,MAAM,oBAAoB,IAAI,CAAC,GAAG,KAAK,EAC5D,MAEF,IAAK,QACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,GAAKD,EAAQ,MAAM,mBAAmB,IAAI,CAAC,GAAG,KAAK,EAC1D,MAEF,IAAK,OACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,SAAWD,EAAQ,MAAM,yBAAyB,IAAI,CAAC,GAAG,KAAK,EACtE,MAEF,IAAK,OACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,YAAcD,EAAQ,MAAM,sBAAsB,IAAI,CAAC,GAAG,KAAK,EACtE,MAEF,IAAK,MACHC,EAAO,YAAcD,EAAQ,MAAM,4BAA4B,IAAI,CAAC,GAAG,KAAK,EAC5EC,EAAO,IAAMD,EAAQ,MAAM,oBAAoB,IAAI,CAAC,GAAG,KAAK,EAC5D,KACJ,CAEI,OAAO,KAAKC,CAAM,EAAE,OAAS,GAC/BR,EAAW,QAAQ,KAAKQ,CAAM,CAElC,CACF,CAEA,MAAMlD,EAAS,cAAc0C,CAAU,CACzC,MACE,MAAM1C,EAAS,YACb,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOD,GAAU,cAAgB,IACjC,KAAMkB,CACR,EACA,EACF,EAGFwB,EAAc,mBAAmB,CACnC,CAEA,MAAMrD,EAAiB,mBAAmB,OAAO,CAC/C,MAAO,CACL,GAAIS,EAAQ,EACd,EACA,KAAM,CACJ,UAAW,EACb,CACF,CAAC,CACH,MACOE,GAAU,SAOb,MAAMX,EAAiB,mBAAmB,OAAO,CAC/C,MAAO,CACL,GAAIS,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAbD,MAAMT,EAAiB,mBAAmB,WAAW,CACnD,MAAO,CACL,GAAIS,EAAQ,EACd,CACF,CAAC,CAYP,CACF,CAEA,MAAa,eACXP,EACAU,EACA6C,EACAhD,EACAiD,EACApD,EACAqD,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAf,EACAgB,EACA,CACA,GAAI1D,GAAWkD,GAAUA,EAAS,EAAG,CACnC,IAAMS,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAK5D,EAAQ,SAAS,EAAE,QAAQ,EAEvD6D,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7BX,EAAQ,CACtBO,EACF,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIzD,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOiD,EAAY,GACnB,UAAW9C,CACb,CACF,CAAC,EAGH,IAAMT,EAAO,MAAM,KAAK,iBAAiBD,EAAU,CACjD,QAASwD,GAAa,QACtB,IAAKpD,EACL,QAASsD,EACT,OAAQD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,UAAWpD,EACX,SAAU6C,EAAI,SACd,MAAOC,EAAY,GACnB,mBAAoBS,CACtB,CAAC,EAMD,GAJIhE,EAAK,UACPM,EAAUN,EAAK,SAGbA,EAAK,SAAS,SAAW,EAAG,CAC9B,IAAMgD,EAAUoB,GAAuBd,EAAI,OAAO,EAElD,GAAI,CAACN,EAAS,CACRY,IACF,KAAK,UAAU,YAAY7D,EAAS,IAAI,EAAE,YACxC,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOkD,GAAgB,IACvB,KAAMC,CACR,EACA,EACF,EAEAV,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAIQ,GAAiBV,EAAQ,YAAY,IAAMU,EAAc,YAAY,EAAG,CACtEK,EACF,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIzD,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOiD,EAAY,GACnB,UAAW9C,CACb,CACF,CAAC,EAEH,MACF,CAEA,GAAI,CACF,IAAMP,EAAU,KAAK,cAAc,IAAa,SAAS,EAAE,YACvDmE,EACAjE,EACAF,IAAY,UACdmE,EAAa,GAAGlE,CAAG,oBAAoBH,EAAK,SAAS,gBACrDI,EAAU,CACR,QAAS4C,CACX,IAEAqB,EAAa,GAAGlE,CAAG,sBACnBC,EAAU,CACR,QAAS4C,EACT,UAAWhD,EAAK,SAClB,GAGF,IAAMK,EAAU,MAAMZ,GAAM,KAAK4E,EAAYjE,CAAO,EAEpD,MAAM,KAAK,cACTL,EACAO,EACA,CACE,OAAQkD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAtD,EACAJ,EAAQ,KAAK,SACbA,EAAQ,KAAK,MACbA,EAAQ,KAAK,iBACf,CACF,OAASE,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEA,MAAM,KAAK,cACTR,EACAO,EACA,CACE,OAAQkD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAtD,EACAT,EAAK,SACLA,EAAK,MACLA,EAAK,iBACP,EAEA,MACF,CACF,CAEA,GAAIM,GAAWA,EAAQ,SAAW,SAChC,OAGF,GAAI,CAACA,EAAS,CACZ,IAAMN,EAAO,MAAM,KAAK,iBAAiBD,EAAU,CACjD,QAASwD,GAAa,QACtB,IAAKpD,EACL,QAASsD,EACT,OAAQD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,UAAWpD,EACX,SAAU6C,GAAK,SACf,MAAOC,EAAY,GACnB,mBAAoBS,CACtB,CAAC,EAwBD,GAtBIhE,GAAM,UACRM,EAAUN,EAAK,SAGjB,MAAM,KAAK,cACTD,EACAO,EACA,CACE,OAAQkD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAtD,EACAT,GAAM,SACNA,GAAM,MACNA,GAAM,iBACR,EAEIA,EAAK,SAAS,SAAW,EAAG,CAC9B,GAAI,CAACgD,EAAS,CACRY,IACF,KAAK,UAAU,YAAY7D,EAAS,IAAI,EAAE,YACxC,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOkD,GAAgB,IACvB,KAAMC,CACR,EACA,EACF,EAEAV,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAIQ,GAAiBV,EAAQ,YAAY,IAAMU,EAAc,YAAY,EAAG,CACtEK,EACF,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIzD,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOiD,EAAY,GACnB,UAAW9C,CACb,CACF,CAAC,EAGH,MACF,CAEA,IAAIJ,EACJ,GAAI,CACF,IAAMH,EAAU,KAAK,cAAc,IAAa,SAAS,EAAE,YACvDmE,EACAjE,EACAF,IAAY,UACdmE,EAAa,GAAGlE,CAAG,oBAAoBH,EAAK,SAAS,gBACrDI,EAAU,CACR,QAAS4C,CACX,IAEAqB,EAAa,GAAGlE,CAAG,sBACnBC,EAAU,CACR,QAAS4C,EACT,UAAWhD,EAAK,SAClB,GAEFK,EAAU,MAAMZ,GAAM,KAAK4E,EAAYjE,CAAO,EAE9C,MAAM,KAAK,cACTL,EACAO,EACA,CACE,OAAQkD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAtD,EACAJ,EAAQ,KAAK,SACbA,EAAQ,KAAK,MACbA,EAAQ,KAAK,iBACf,CACF,OAASE,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACA,MACF,CAYA,GAVA,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEG,CAAC0C,EAAS,CACRY,IACF,KAAK,UAAU,YAAY7D,EAAS,IAAI,EAAE,YACxC,CACE,OAAQU,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOkD,GAAgB,IACvB,KAAMC,CACR,EACA,EACF,EAEAV,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAIQ,GAAiBV,EAAQ,YAAY,IAAMU,EAAc,YAAY,EAAG,CACtEK,EACF,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIzD,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOiD,EAAY,GACnB,UAAW9C,CACb,CACF,CAAC,EAEH,MACF,CAEA,IAAMP,EAAU,KAAK,cAAc,IAAa,SAAS,EAAE,YACvDmE,EACAjE,EACAF,IAAY,UACdmE,EAAa,GAAGlE,CAAG,oBAAoBG,EAAQ,UAAU,MAAM,GAAG,EAAE,CAAC,CAAC,gBACtEF,EAAU,CACR,QAAS4C,CACX,IAEAqB,EAAa,GAAGlE,CAAG,sBACnBC,EAAU,CACR,QAAS4C,EACT,UAAW1C,EAAQ,UAAU,MAAM,GAAG,EAAE,CAAC,CAC3C,GAEF,IAAMD,EAAU,MAAMZ,GAAM,KAAK4E,EAAYjE,CAAO,EAEpD,MAAM,KAAK,cACTL,EACAO,EACA,CACE,OAAQkD,EACR,cAAeE,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAtD,EACAJ,GAAS,MAAM,SACfA,GAAS,MAAM,MACfA,GAAS,MAAM,iBACjB,CAGF,CACF,EC16BA,OAA2B,UAAAiE,OAAc,iBCbzC,SAASC,GAAmBC,EAAqB,CAC/C,IAAMC,EAAcD,EAAI,UAAU,EAAG,CAAC,EAEtC,OAAI,OAAOC,CAAW,IAAM,IAAM,OAAOA,CAAW,IAAM,KACpDD,EAAI,SAAW,GACFC,EAAcD,EAAI,UAAU,CAAC,EAMzCA,CACT,CAGA,SAASE,GAAeF,EAAa,CACnC,IAAMG,EAAS,IAAI,OAAO,8BAA8B,EACxD,GAAIA,EAAO,KAAKH,CAAG,EAAG,CACpB,IAAMI,EAAQD,EAAO,KAAKH,CAAG,EAC7B,GAAII,GAASA,EAAM,CAAC,IAAM,KAAM,CAC9B,IAAMC,EAAQ,OAAO,SAASD,EAAM,CAAC,EAAE,CAAC,CAAC,EACnCE,EAAM,OAAO,SAASF,EAAM,CAAC,CAAC,EACpC,OAAIC,EAAQ,GAAKC,EAAM,GACdF,EAAM,CAAC,EAETA,EAAM,CAAC,EAAIA,EAAM,CAAC,EAAIA,EAAM,CAAC,CACtC,CACA,OAAOJ,CACT,KACE,QAAOA,CAEX,CAEO,SAASO,EAAUC,EAAwB,CAOhD,OANAA,EAASA,EAAO,QAAQ,OAAQ,EAAE,EAE9BA,EAAO,SAAS,OAAO,GAAKA,EAAO,SAAS,iBAAiB,GAAKA,EAAO,SAAS,MAAM,GAIxFA,EAAO,SAAS,YAAY,EACvBA,GAGTA,EAASA,GACL,QAAQ,MAAO,EAAE,EAClB,QAAQ,MAAO,EAAE,EACjB,QAAQ,MAAO,EAAE,EACjB,QAAQ,MAAO,EAAE,EACjB,MAAM,GAAG,EAAE,CAAC,EACZ,MAAM,GAAG,EAAE,CAAC,EAEXA,EAAO,SAAS,GAAG,GAAKA,EAAO,QAAU,IAC3CA,EAASA,EAAO,QAAQ,UAAW,EAAE,EAC9B,GAAGA,CAAM,UAGlBA,EAASA,EAAO,QAAQ,MAAO,EAAE,EAE7BA,EAAO,QAAU,IACnBA,EAASA,EAAO,QAAQ,UAAW,EAAE,EAC9B,GAAGA,CAAM,UAGlBA,EAAST,GAAmBS,CAAM,EAElCA,EAASN,GAAeM,CAAM,EAEvB,GAAGA,CAAM,oBAClB,CDrDA,OAAS,WAAAC,OAAe,kBAMjB,IAAMC,GAAN,MAAMC,CAAsB,CACjC,YACkBC,EACAC,EACAC,EACAC,EAChB,CAJgB,mBAAAH,EACA,kBAAAC,EACA,sBAAAC,EACA,mBAAAC,EAGlB,KAAgB,OAAS,IAAIC,EAAO,uBAAuB,EAG3D,KAAgB,SAAwB,CAAC,EACzC,KAAgB,cAAkC,CAAC,EACnD,KAAgB,WAA4B,CAAC,EAC7C,KAAgB,cAAkC,CAAC,EACnD,KAAgB,aAAgC,CAAC,EAEjD,KAAO,gBAAkB,IAAIC,GAC3BC,EACA,KAAK,cACL,KAAK,iBACL,KAAK,aACP,EAEA,KAAO,eAAiB,IAAIC,GAAeD,EAAW,KAAK,cAAe,KAAK,gBAAgB,EAE/F,KAAO,cAAgB,IAAIE,GAAcF,EAAW,KAAK,cAAe,KAAK,gBAAgB,EAE7F,KAAO,YAAc,IAAIG,GAAYH,EAAW,KAAK,cAAe,KAAK,gBAAgB,CAtBtF,CAwBI,YAAYI,EAAuB,CACxC,KAAK,OAAO,YAAYA,EAAS,YAAY,EAE7C,KAAK,SAAS,KAAOA,EAAS,aAC9B,KAAK,SAAS,GAAKA,EAAS,WAC5B,KAAK,SAAS,YAAcA,EAAS,YACrC,KAAK,SAAS,OAASA,EAAS,OAChC,KAAK,SAAS,MAAQA,EAAS,MAC/B,KAAK,SAAS,WAAaA,EAAS,WAEhC,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,gCAEnB,CAAE,aAAc,KAAK,SAAS,IAAK,EACnC,CACE,SAAU,KAAK,SAAS,KACxB,OAAQ,SACV,CACF,CAEJ,CAEA,IAAW,aAAaC,EAAc,CAGpC,GAFA,KAAK,OAAO,YAAYA,CAAI,EAExB,CAACA,EAAM,CACT,KAAK,SAAS,KAAOC,EAAG,EACxB,MACF,CACA,KAAK,SAAS,KAAOD,CACvB,CAEA,IAAW,cAAe,CACxB,OAAO,KAAK,SAAS,IACvB,CAEA,IAAW,WAAWE,EAAY,CAChC,GAAI,CAACA,EAAI,CACP,KAAK,SAAS,GAAKD,EAAG,EACtB,MACF,CACA,KAAK,SAAS,GAAKC,CACrB,CAEA,IAAW,YAAa,CACtB,OAAO,KAAK,SAAS,EACvB,CAEA,IAAW,YAAYC,EAAqB,CAC1C,KAAK,SAAS,YAAcA,CAC9B,CAEA,IAAW,aAAc,CACvB,OAAO,KAAK,SAAS,WACvB,CAEA,IAAW,OAAOC,EAAgB,CAChC,KAAK,SAAS,OAASA,CACzB,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,SAAS,MACvB,CAEA,IAAW,MAAMC,EAAe,CAC9B,KAAK,SAAS,MAAQA,CACxB,CAEA,IAAW,OAAQ,CACjB,OAAO,KAAK,SAAS,KACvB,CAEA,IAAW,MAAO,CAChB,OAAO,KAAK,SAAS,IACvB,CAEA,MAAa,aAAc,CACzB,IAAMC,EAAO,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC1D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,KAAK,aAAa,QAAUA,GAAM,QAClC,KAAK,aAAa,cAAgBA,GAAM,aAC1C,CAEA,MAAa,cAAe,CAC1B,IAAMA,EAAO,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC1D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,KAAK,cAAc,WAAaA,GAAM,WACtC,KAAK,cAAc,QAAUA,GAAM,QACnC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,WAAaA,GAAM,WACtC,KAAK,cAAc,gBAAkBA,GAAM,gBAC3C,KAAK,cAAc,YAAcA,GAAM,WACzC,CAEA,MAAa,YAAYA,EAAmB,CAC1C,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CACL,WAAY,KAAK,UACnB,EACA,OAAQ,CACN,WAAYA,EAAK,WACjB,QAASA,EAAK,QACd,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,gBAAiBA,EAAK,gBACtB,YAAaA,EAAK,WACpB,EACA,OAAQ,CACN,WAAYA,EAAK,WACjB,QAASA,EAAK,QACd,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,gBAAiBA,EAAK,gBACtB,YAAaA,EAAK,YAClB,WAAY,KAAK,UACnB,CACF,CAAC,EAED,KAAK,cAAc,WAAaA,GAAM,WACtC,KAAK,cAAc,QAAUA,GAAM,QACnC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,aAAeA,GAAM,aACxC,KAAK,cAAc,WAAaA,GAAM,WACtC,KAAK,cAAc,gBAAkBA,GAAM,gBAC3C,KAAK,cAAc,YAAcA,GAAM,YAEnC,KAAK,cAAc,aAAe,KAAK,cAAc,YAAY,OAAS,IAC5E,KAAK,OAAO,GAAG,MAAM,EACrB,KAAK,OAAO,GAAG,QAAQ,EAE3B,CAEA,MAAa,cAAe,CAC1B,IAAMA,EAAO,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC1D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,OAAKA,EAIE,CACL,WAAYA,EAAK,WACjB,QAASA,EAAK,QACd,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,gBAAiBA,EAAK,gBACtB,YAAaA,EAAK,WACpB,EAZS,IAaX,CAEA,MAAa,cAAe,CAC1B,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAChD,OAGF,IAAMA,EAAO,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAC3D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,KAAK,cAAc,QAAUA,GAAM,QACnC,KAAK,cAAc,UAAYA,GAAM,UACrC,KAAK,cAAc,MAAQA,GAAM,MACjC,KAAK,cAAc,IAAMA,GAAM,IAC/B,KAAK,cAAc,UAAYA,GAAM,UACrC,KAAK,cAAc,QAAUA,GAAM,QACnC,KAAK,cAAc,cAAgBA,GAAM,cACzC,KAAK,cAAc,OAASA,GAAM,OAClC,KAAK,cAAc,mBAAqBA,GAAM,mBAC9C,KAAK,cAAc,oBAAsBA,GAAM,oBAC/C,KAAK,cAAc,oBAAsBA,GAAM,oBAC/C,KAAK,cAAc,eAAiBA,GAAM,eAC1C,KAAK,cAAc,eAAiBA,GAAM,eAC1C,KAAK,cAAc,wBAA0BA,GAAM,uBACrD,CAEA,MAAa,YAAYA,EAAmB,CAC1C,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAChD,OASF,GANiB,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAC/D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAEa,CACZ,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,MAAO,CACL,WAAY,KAAK,UACnB,EACA,KAAM,CACJ,QAASA,GAAM,QACf,UAAWA,EAAK,UAChB,MAAOA,EAAK,MACZ,IAAKA,EAAK,IACV,UAAWA,EAAK,UAChB,QAASA,EAAK,QACd,cAAeA,EAAK,QAAUA,EAAK,cAAgB,KACnD,OAAQA,EAAK,OACb,mBAAoBA,EAAK,mBACzB,oBAAqBA,EAAK,oBAC1B,oBAAqBA,EAAK,oBAC1B,eAAgBA,EAAK,eACrB,eAAgBA,EAAK,eACrB,wBAAyBA,EAAK,wBAC9B,aAAcA,EAAK,aACnB,KAAMA,EAAK,KACX,WAAYA,EAAK,UACnB,CACF,CAAC,EAED,OAAO,OAAO,KAAK,cAAe,CAAE,GAAGA,EAAM,cAAeA,EAAK,QAAUA,EAAK,cAAgB,IAAK,CAAC,EAEtG,KAAK,mBAAmB,EACxB,MACF,CAEA,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,KAAM,CACJ,QAASA,GAAM,QACf,UAAWA,EAAK,UAChB,MAAOA,EAAK,MACZ,IAAKA,EAAK,IACV,UAAWA,EAAK,UAChB,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,mBAAoBA,EAAK,mBACzB,oBAAqBA,EAAK,oBAC1B,oBAAqBA,EAAK,oBAC1B,eAAgBA,EAAK,eACrB,eAAgBA,EAAK,eACrB,wBAAyBA,EAAK,wBAC9B,aAAcA,EAAK,aACnB,KAAMA,EAAK,KACX,WAAYA,EAAK,WACjB,WAAY,KAAK,UACnB,CACF,CAAC,EAED,OAAO,OAAO,KAAK,cAAe,CAAE,GAAGA,EAAM,cAAeA,EAAK,QAAUA,EAAK,cAAgB,IAAK,CAAC,EAEtG,KAAK,mBAAmB,CAC1B,CAEA,MAAa,cAA4C,CACvD,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAChD,OAAO,KAGT,IAAMA,EAAO,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAC3D,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,GAAI,CAACA,EACH,OAAO,KAGT,IAAMC,EAAkB,MAAM,QAAQD,EAAK,UAAU,EAAIA,EAAK,WAAW,IAAKE,GAAU,OAAOA,CAAK,CAAC,EAAI,CAAC,EAE1G,MAAO,CACL,QAASF,GAAM,QACf,UAAWA,EAAK,UAChB,MAAOA,EAAK,MACZ,IAAKA,EAAK,IACV,UAAWA,EAAK,UAChB,QAASA,EAAK,QACd,cAAeA,EAAK,eAAiB,KACrC,mBAAoBA,EAAK,mBACzB,oBAAqBA,EAAK,oBAC1B,oBAAqBA,EAAK,oBAC1B,eAAgBA,EAAK,eACrB,eAAgBA,EAAK,eACrB,wBAAyBA,EAAK,wBAC9B,aAAcA,EAAK,aACnB,KAAMA,EAAK,KACX,WAAYC,CACd,CACF,CAEO,oBAAqB,CACtB,KAAK,eAAe,SACtB,KAAK,gBAAgB,SAAS,GAAG,UAAU,KAAK,YAAY,CAEhE,CAEA,MAAa,WAAY,CACvB,KAAK,WAAW,QAAU,GAEtB,QAAQ,IAAI,aACd,KAAK,WAAW,QAAU,GAC1B,KAAK,WAAW,KAAO,QAAQ,IAAI,WACnC,KAAK,WAAW,KAAO,QAAQ,IAAI,YAAc,KACjD,KAAK,WAAW,SAAW,QAAQ,IAAI,gBAAkB,OACzD,KAAK,WAAW,SAAW,QAAQ,IAAI,eACvC,KAAK,WAAW,SAAW,QAAQ,IAAI,gBAGzC,IAAMD,EAAO,MAAM,KAAK,iBAAiB,MAAM,WAAW,CACxD,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAEGA,GAAM,UACR,KAAK,WAAW,QAAU,GAC1B,KAAK,WAAW,KAAOA,GAAM,KAC7B,KAAK,WAAW,KAAOA,GAAM,KAC7B,KAAK,WAAW,SAAWA,GAAM,SACjC,KAAK,WAAW,SAAWA,GAAM,SACjC,KAAK,WAAW,SAAWA,GAAM,SAErC,CAEA,MAAa,SAASA,EAAgB,CACpC,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,MAAO,CACL,WAAY,KAAK,UACnB,EACA,OAAQ,CACN,QAASA,GAAM,QACf,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,SAAUA,EAAK,SACf,SAAUA,EAAK,SACf,SAAUA,EAAK,QACjB,EACA,OAAQ,CACN,QAASA,GAAM,QACf,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,SAAUA,EAAK,SACf,SAAUA,EAAK,SACf,SAAUA,EAAK,SACf,WAAY,KAAK,UACnB,CACF,CAAC,EAED,OAAO,OAAO,KAAK,WAAYA,CAAI,CACrC,CAEA,MAAa,WAAY,CACvB,IAAMA,EAAO,MAAM,KAAK,iBAAiB,MAAM,WAAW,CACxD,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,EAED,GAAI,CAACA,EACH,MAAM,IAAIG,EAAkB,iBAAiB,EAG/C,OAAOH,CACT,CAEA,MAAa,gBAAyBE,EAAeF,EAASI,EAAQ,GAAMP,EAAwB,CAClG,IAAMQ,EAAY,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACzDC,EAAW,IAAI,KAAK,EAAE,kBAAkB,EAAI,IAE5CC,EADe,IAAI,KAAK,KAAK,IAAI,EAAID,CAAQ,EAAE,YAAY,EAG3DE,EAAS,KAAK,cAAc,IAAU,gBAAgB,EAAE,0BAExDC,EAAiB,KAAK,OAAS,mBAErC,MAAMC,EAAa,KAAK,CACtB,aAAc,KAAK,SAAS,KAC5B,OAAQ5B,EAAsB,KAC9B,MAAAoB,EACA,KAAAF,EACA,UAAAK,EACA,SAAUE,EACV,OAAQ,KAAK,KACb,OAAQC,GAAUC,EAAiBA,EAAiB,KACpD,MAAAL,EACA,YAAAP,CACF,CAAC,CACH,CAGO,mBAAmBc,EAAqB,CAC7C,IAAMC,EAAcD,EAAI,UAAU,EAAG,CAAC,EAEtC,OAAI,OAAOC,CAAW,IAAM,IAAM,OAAOA,CAAW,IAAM,KACpDD,EAAI,SAAW,GACFC,EAAcD,EAAI,UAAU,CAAC,EAMzCA,CACT,CAGO,eAAeA,EAAa,CACjC,IAAME,EAAS,IAAI,OAAO,8BAA8B,EACxD,GAAIA,EAAO,KAAKF,CAAG,EAAG,CACpB,IAAMG,EAAQD,EAAO,KAAKF,CAAG,EAC7B,GAAIG,GAASA,EAAM,CAAC,IAAM,KAAM,CAC9B,IAAMC,EAAQ,OAAO,SAASD,EAAM,CAAC,EAAE,CAAC,CAAC,EACnCE,EAAM,OAAO,SAASF,EAAM,CAAC,CAAC,EACpC,OAAIC,EAAQ,GAAKC,EAAM,GACdF,EAAM,CAAC,EAETA,EAAM,CAAC,EAAIA,EAAM,CAAC,EAAIA,EAAM,CAAC,CACtC,CACA,OAAOH,CACT,KACE,QAAOA,CAEX,CAEA,MAAa,cAAcM,EAAuB,CAChD,IAAMC,EAAYD,GAAO,OAAO,UAC5BA,GAAO,OAAO,UAAU,SAAS,GAAG,EAClCA,EAAM,OAAO,UACbE,EAAUF,EAAM,OAAO,SAAS,EAClC,KAEEG,EAAQ,CACZ,WAAY,KAAK,UACnB,EAEA,OAAIF,IACFE,EAAM,UAAeF,GAGhB,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAClD,MAAAE,CACF,CAAC,CACH,CAEO,iBAAiBC,EAAc,CACpC,GAAI,CAACA,EAAS,OAAOA,EAErB,IAAMC,EAAiB,CAAE,GAAGD,CAAQ,EAE9BE,EAAWD,EAAe,QAAQ,SAExC,cAAOA,EAAe,QAAQ,OAE1BA,EAAe,UAEbA,EAAe,QAAQ,eACzBA,EAAe,QAAQ,aAAe,CACpC,QAASA,EAAe,QAAQ,aAAa,OAC/C,GAIEA,EAAe,QAAQ,eACzBA,EAAe,QAAQ,aAAe,CACpC,QAASA,EAAe,QAAQ,aAAa,OAC/C,GAIEA,EAAe,QAAQ,eACzBA,EAAe,QAAQ,aAAe,CACpC,QAASA,EAAe,QAAQ,aAAa,OAC/C,GAIEA,EAAe,QAAQ,iBACzBA,EAAe,QAAQ,eAAiB,CAAC,GAIvCA,EAAe,QAAQ,kBACzBA,EAAe,QAAQ,gBAAkB,CACvC,QAASA,EAAe,QAAQ,gBAAgB,QAChD,KAAMA,EAAe,QAAQ,gBAAgB,IAC/C,GAIEA,EAAe,QAAQ,6BACzBA,EAAe,QAAQ,2BAA6B,CAClD,QAASA,EAAe,QAAQ,2BAA2B,QAC3D,KAAMA,EAAe,QAAQ,2BAA2B,IAC1D,IAIAC,IAAUD,EAAe,QAAQ,SAAWC,GAEzCD,CACT,CAEA,MAAa,cAAcL,EAAuB,CAChD,IAAMO,EAAaP,GAAO,OAAO,IAO3BQ,EAAkB,CAAC,EACrBR,GAAO,OAAO,kBACZA,EAAM,MAAM,iBAAiB,KAAUA,EAAM,MAAM,iBAAiB,MACtEQ,EAAgB,iBAAsB,CACpC,IAAK,KAAK,MAAM,IAAI,KAAKR,EAAM,MAAM,iBAAiB,GAAM,EAAE,QAAQ,EAAI,GAAI,EAC9E,IAAK,KAAK,MAAM,IAAI,KAAKA,EAAM,MAAM,iBAAiB,GAAM,EAAE,QAAQ,EAAI,GAAI,CAChF,GAIJ,IAAMS,EAAQ,MAAM,KAAK,iBAAiB,QAAQ,MAAM,CACtD,MAAO,CACL,WAAY,KAAK,WACjB,GAAIT,GAAO,OAAO,GAClB,OAAQA,GAAO,OAAO,OACtB,YAAaA,GAAO,OAAO,YAC3B,GAAGQ,EACH,IAAK,CACHD,GAAY,GAAK,CAAE,IAAK,CAAE,KAAM,CAAC,IAAI,EAAG,OAAQA,GAAY,EAAG,CAAE,EAAI,CAAC,EACtEA,GAAY,OAAS,CAAE,IAAK,CAAE,KAAM,CAAC,QAAQ,EAAG,OAAQA,GAAY,MAAO,CAAE,EAAI,CAAC,EAClFA,GAAY,UAAY,CAAE,IAAK,CAAE,KAAM,CAAC,WAAW,EAAG,OAAQA,GAAY,SAAU,CAAE,EAAI,CAAC,EAC3FA,GAAY,aAAe,CAAE,IAAK,CAAE,KAAM,CAAC,cAAc,EAAG,OAAQA,GAAY,YAAa,CAAE,EAAI,CAAC,CACtG,CACF,CACF,CAAC,EAEIP,GAAO,SACVA,EAAM,OAAS,IAGZA,GAAO,OACVA,EAAM,KAAO,GAGf,IAAMU,EAAW,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC5D,MAAO,CACL,WAAY,KAAK,WACjB,GAAIV,GAAO,OAAO,GAClB,OAAQA,GAAO,OAAO,OACtB,YAAaA,GAAO,OAAO,YAC3B,GAAGQ,EACH,IAAK,CACHD,GAAY,GAAK,CAAE,IAAK,CAAE,KAAM,CAAC,IAAI,EAAG,OAAQA,GAAY,EAAG,CAAE,EAAI,CAAC,EACtEA,GAAY,OAAS,CAAE,IAAK,CAAE,KAAM,CAAC,QAAQ,EAAG,OAAQA,GAAY,MAAO,CAAE,EAAI,CAAC,EAClFA,GAAY,UAAY,CAAE,IAAK,CAAE,KAAM,CAAC,WAAW,EAAG,OAAQA,GAAY,SAAU,CAAE,EAAI,CAAC,EAC3FA,GAAY,aAAe,CAAE,IAAK,CAAE,KAAM,CAAC,cAAc,EAAG,OAAQA,GAAY,YAAa,CAAE,EAAI,CAAC,CACtG,CACF,EACA,QAAS,CACP,iBAAkB,MACpB,EACA,KAAMP,EAAM,QAAUA,GAAO,OAAS,EAAI,EAAKA,GAAO,KAAkB,GACxE,KAAMA,EAAM,OACZ,OAAQ,CACN,GAAI,GACJ,IAAK,GACL,SAAU,GACV,YAAa,GACb,QAAS,GACT,iBAAkB,GAClB,WAAY,GACZ,OAAQ,GACR,YAAa,GACb,cAAe,CACb,OAAQ,CACN,OAAQ,EACV,CACF,CACF,CACF,CAAC,EAED,MAAO,CACL,SAAU,CACR,MAAOS,EACP,MAAO,KAAK,KAAKA,EAAQT,EAAM,MAAM,EACrC,YAAaA,EAAM,KACnB,QAASU,CACX,CACF,CACF,CAEA,MAAa,mBAAmBV,EAAY,CAC1C,OAAO,MAAM,KAAK,iBAAiB,cAAc,SAAS,CACxD,MAAO,CACL,WAAY,KAAK,WACjB,UAAWA,EAAM,OAAO,UACxB,MAAOA,EAAM,OAAO,EACtB,EACA,KAAMA,EAAM,QAAUA,GAAO,OAAS,EAAI,EAAKA,GAAO,KAAkB,GACxE,KAAMA,EAAM,MACd,CAAC,CACH,CAEA,MAAa,WAAWA,EAAY,CAClC,IAAMC,EAAYD,GAAO,OAAO,UAC5BA,GAAO,OAAO,UAAU,SAAS,GAAG,EAClCA,EAAM,OAAO,UACbE,EAAUF,EAAM,OAAO,SAAS,EAClC,KAEEG,EAAQ,CACZ,WAAY,KAAK,UACnB,EAEIF,IACFE,EAAM,UAAeF,GAGvB,IAAMO,EACJR,GAAO,OAAO,kBAAkB,KAAOA,GAAO,OAAO,kBAAkB,IACnEW,GAAO;AAAA,gDAC+B,KAAK,MAAM,IAAI,KAAKX,EAAM,MAAM,iBAAiB,GAAG,EAAE,QAAQ,EAAI,GAAI,CAAC;AAAA,gDACvE,KAAK,MAAM,IAAI,KAAKA,EAAM,MAAM,iBAAiB,GAAG,EAAE,QAAQ,EAAI,GAAI,CAAC,GAC7GW,GAAO,MAEPC,EAAU,MAAM,KAAK,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uCAkCT,KAAK,UAAU;AAAA,2CACX,KAAK,UAAU;AAAA,cAC5CX,EAAYU,GAAO,kCAAkCV,CAAS,GAAKU,GAAO,KAAK;AAAA,cAC/EH,CAAe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MASzB,OAAII,GAAWC,GAAQD,CAAO,GAAKA,EAAQ,OAAS,EAC5BA,EAAQ,IAAKE,GAAY,CAC7C,IAAMC,EAAcD,EAAQ,cACxB,CACE,GAAIA,EAAQ,cACZ,IAAKA,EAAQ,eACb,SAAUA,EAAQ,oBAClB,YAAaA,EAAQ,uBACrB,YAAaA,EAAQ,uBACrB,QAASA,EAAQ,mBACjB,YAAaA,EAAQ,uBACrB,OAAQA,EAAQ,kBAChB,iBAAkBA,EAAQ,4BAC1B,WAAYA,EAAQ,sBACpB,UAAWA,EAAQ,qBACnB,OAAQA,EAAQ,iBAClB,EACA,OAEJ,MAAO,CACL,GAAIA,EAAQ,GACZ,UAAWA,EAAQ,UACnB,SAAUA,EAAQ,SAClB,cAAeA,EAAQ,cACvB,UAAWA,EAAQ,UACnB,YAAaA,EAAQ,YACrB,cAAeA,EAAQ,cACvB,aAAcA,EAAQ,aACtB,YAAaC,EAAc,KAAK,iBAAiBA,CAAW,EAAI,MAClE,CACF,CAAC,EAKI,CAAC,CACV,CACF,EEpvBA,OAAOC,OAAW,QAClB,OAAS,YAAAC,GAAU,SAAAC,OAAa,kBAEhC,OAAOC,OAAc,YACrB,OAAOC,OAAe,aACtB,OAAS,QAAAC,OAAY,OAGd,IAAMC,GAAN,cAAsCC,EAAsB,CACjE,YACkBC,EACAC,EACAC,EACAC,EACAC,EAChB,CACA,MAAMJ,EAAeC,EAAcC,EAAkBE,CAAa,EANlD,mBAAAJ,EACA,kBAAAC,EACA,sBAAAC,EACA,WAAAC,EACA,mBAAAC,EASlB,KAAO,gBAAsC,CAAE,MAAO,MAAO,EAL3D,KAAK,OAAS,IAChB,CASA,IAAW,kBAAmB,CAC5B,OAAO,KAAK,eACd,CAEA,MAAa,aAAc,CACzB,KAAK,gBAAkB,CAAE,MAAO,OAAQ,CAC1C,CAEA,IAAW,QAAoB,CAC7B,MAAO,CACL,YAAa,KAAK,SAAS,QAAQ,YACnC,KAAM,KAAK,SAAS,QAAQ,KAC5B,OAAQ,KAAK,SAAS,QAAQ,OAC9B,MAAO,KAAK,SAAS,QAAQ,KAC/B,CACF,CAEA,MAAa,gBAAiB,CAC5B,MAAM,KAAK,YAAY,CACzB,CAEO,YAAYC,EAAuB,CACxC,KAAK,OAAO,YAAYA,EAAS,UAAU,EAE3C,KAAK,SAAS,KAAOA,EAAS,aAC9B,KAAK,SAAS,GAAKA,EAAS,WAC5B,KAAK,SAAS,YAAcA,EAAS,YACrC,KAAK,SAAS,OAASA,EAAS,OAChC,KAAK,SAAS,MAAQA,EAAS,MAC/B,KAAK,SAAS,WAAaA,EAAS,WAEhC,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,gCAEnB,CACE,aAAc,KAAK,SAAS,KAC5B,WAAY,KAAK,SAAS,GAC1B,YAAaA,EAAS,WACxB,EACA,CACE,SAAU,KAAK,SAAS,KACxB,OAAQ,SACV,CACF,CAEJ,CAEA,MAAa,eAAeC,EAAgB,CAG1C,MAAO,CACL,KAHUC,EAAUD,CAAM,EAI1B,kBAAmB,IACrB,CACF,CAEA,MAAa,gBAAiB,CAC5B,OAAO,IACT,CAEA,MAAa,mBAAoB,CAC/B,OAAO,IACT,CAEA,MAAa,kBAAmB,CAC9B,OAAO,IACT,CAEA,MAAa,kBAAkBE,EAA0B,CACvD,GAAI,CAACA,EAAM,CACT,KAAK,aAAa,EAClB,MACF,CAEA,GAAI,CACF,KAAK,aAAaA,CAAI,CACxB,OAASC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIC,EAA6BD,GAAO,SAAS,CAAC,CAC1D,CACF,CAEA,MAAgB,aAAaE,EAAe,CAC1C,GAAI,CACF,IAAIC,EAEJ,GAAID,EAAS,QAAS,CAOpBC,EAAa,CACX,IAPU,CACV,GAAID,EAAS,IAAI,IAAME,EAAG,EAC1B,UAAWF,EAAS,IAAI,UACxB,OAAQA,EAAS,IAAI,OACrB,cAAeA,EAAS,aAC1B,EAGE,SAAUA,EAAS,SACnB,QAASA,EAAS,QAClB,YAAaA,EAAS,YACtB,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,OAAQ,UACR,WAAY,KAAK,UACnB,EAEA,IAAMG,EAAUH,GAAU,SAAS,aAEnC,GAAI,KAAK,cAAc,IAAY,QAAQ,EAAE,SAAWG,EAAS,CAC/D,IAAMC,EAAwB,MAAM,KAAK,iBAAiB,cAAc,UAAU,CAChF,MAAO,CACL,WAAY,KAAK,UACnB,EACA,QAAS,CACP,YAAa,EACf,CACF,CAAC,EAGCA,GACAA,EAAsB,eACtBA,EAAsB,cACtBJ,GAAU,SAAS,eAEnBC,EAAW,QAAQ,aAAe,MAAM,KAAK,cAAc,aACzDG,EAAsB,YACtBJ,EACA,KAAK,OAAO,kBACd,EAEJ,CAaA,GAXA,KAAK,OAAO,IAAIC,CAAU,EAE1B,KAAK,kCAAwCA,CAAU,EAEvD,MAAMI,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWJ,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,QACvB,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,QAAS,CACvF,IAAMK,EAAsB,MAAM,KAAK,gBAAgB,gCAErD,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChEL,CACF,EAEIK,GAAqB,KACvBL,EAAW,kBAAoBK,EAAoB,GACnDL,EAAW,gBAAkBK,EAAoB,GACjDL,EAAW,uBAAyBK,EAAoB,GAE5D,CAEA,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,KAAML,CACR,CAAC,EAED,MAAM,KAAK,cAAc,CACvB,UAAWA,EAAW,IAAI,UAC1B,SAAUA,EAAW,SACrB,cAAeD,EAAS,aAC1B,CAAC,CACH,CACF,OAASF,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAc,cAAcD,EAAwE,CAClG,IAAMU,EAAkB,CACtB,UAAWV,EAAK,UAChB,SAAUA,GAAM,SAChB,WAAY,KAAK,WACjB,cAAeA,GAAM,aACvB,EAEwB,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CACpE,MAAO,CACL,UAAWA,EAAK,UAChB,WAAY,KAAK,UACnB,CACF,CAAC,EAGC,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,UAAWA,EAAK,UAChB,WAAY,KAAK,UACnB,EACA,KAAMU,CACR,CAAC,EAED,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,KAAMA,CACR,CAAC,EAGH,KAAK,kCAAwCA,CAAU,EAEnD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,MAAM,KAAK,gBAAgB,gCAEzB,CACE,aAAc,KAAK,SAAS,KAC5B,WAAY,KAAK,WACjB,YAAa,KAAK,SAAS,WAC7B,EACAA,CACF,EAGF,IAAMC,EAAO,MAAM,KAAK,iBAAiB,KAAK,UAAU,CACtD,MAAO,CAAE,WAAY,KAAK,WAAY,UAAWX,EAAK,SAAU,CAClE,CAAC,EAED,GAAIW,EAAM,CACR,IAAMC,EAAe,CACnB,UAAWZ,EAAK,UAChB,WAAY,KAAK,UACnB,EAEA,KAAK,+BAAqCY,CAAO,EAEjD,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAC1C,MAAO,CAAE,UAAWD,EAAK,SAAU,EACnC,KAAMC,CACR,CAAC,CACH,CAEA,IAAMA,EAAe,CACnB,UAAWZ,EAAK,UAChB,WAAY,KAAK,UACnB,EAEA,KAAK,+BAAqCY,CAAO,EAEjD,MAAM,KAAK,iBAAiB,KAAK,OAAO,CACtC,KAAMA,CACR,CAAC,CACH,CAEA,MAAgB,sBACdd,EACAe,EACAC,EACAC,EACAC,EAAgB,GAChB,CACA,GAAI,CACF,IAAIC,EACAC,EAEJ,GAAIJ,GAAS,OAAQ,CAGnB,IAAMK,EAFIL,GAAS,QAEJ,IAEf,GAAI,CAACK,EACH,KAAM,oBAGRF,EAASE,CACX,CAEIL,EAAQ,OACV,MAAM,IAAI,QAASM,GAAY,WAAWA,EAASN,EAAQ,KAAK,CAAC,EAG/DA,GAAS,aACXI,EAAaJ,EAAQ,YAGvB,IAAIO,EAEEC,EAAYjB,EAAG,EAEjBD,EAmHJ,GAjHIS,GAAS,YAAc,QACzBT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,OAAQyB,GAASV,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OAClD,SAAUW,GAAMX,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OACjD,OAAAI,CACF,EACA,YAAa,eACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EACSL,GAAS,YAAc,QAChCT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,OAAQyB,GAASV,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OAClD,SAAUW,GAAMX,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OACjD,OAAAI,CACF,EACA,YAAa,eACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EACSL,GAAS,YAAc,SAChCT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,OAAQyB,GAASV,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OAClD,SAAUW,GAAMX,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OACjD,OAAAI,CACF,EACA,YAAa,eACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EAGAG,EAAY,CACV,OAFa,OAAO,KAAKR,EAAQ,MAAO,QAAQ,EAGhD,SAAU,YACV,aAAc,GAAGS,CAAS,MAC5B,GACST,GAAS,YAAc,WAChCT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,OAAQyB,GAASV,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OAClD,SAAUW,GAAMX,EAAQ,KAAK,EAAIA,EAAQ,MAAQ,OACjD,OAAAI,CACF,EACA,YAAa,kBACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EACSL,EAAQ,cACjBT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,GAAGe,EAAQ,cACX,QAASA,EAAQ,cAAc,QAC/B,OAAQA,EAAQ,cAAc,OAC9B,KAAMA,EAAQ,cAAc,KAC5B,OAAAI,CACF,EACA,YAAa,gBACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EACSL,EAAQ,YACjBT,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,GAAGe,EAAQ,YACX,OAAAI,CACF,EACA,YAAa,cACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EAEAd,EAAa,CACX,IAAK,CAAE,OAAQ,GAAM,GAAIkB,EAAW,UAAWxB,CAAO,EACtD,QAAS,CACP,GAAGe,EACH,OAAAI,CACF,EACA,YAAa,eACb,iBAAkB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EACxD,WAAAC,EACA,OAAQ,UACR,WAAY,KAAK,UACnB,EAGEd,EAAW,QAAQ,cACrBA,EAAW,YAAc,CACvB,GAAGA,EAAW,QAAQ,WACxB,GAGEA,EAAW,aAAa,SAAU,CACpC,IAAMqB,EAAW,CACf,GAAIrB,EAAW,YAAY,QAC7B,EAEMsB,EAAc,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAChE,MAAO,CACL,WAAY,KAAK,WACjB,IAAAD,CACF,CACF,CAAC,EAEGC,IACFtB,EAAW,YAAY,cAAgBsB,EAAY,QAEvD,CAEA,IAAMC,EAASvB,EAAW,QAAQ,OAGlC,GAFA,OAAOA,EAAW,QAAQ,QAEtBuB,GAAUZ,GAAQM,IAChB,KAAK,cAAc,IAAQ,IAAI,EAAE,OACnC,GAAI,CACF,IAAMO,EAAaP,GAAW,QAAUN,GAAM,OACxCc,EAASF,EAAS,OAAO,KAAKA,EAAQ,QAAQ,EAAIC,EAEpDE,EACAC,EAAWV,GAAW,UAAYN,EAAK,SAEvCX,EAAW,cAAgB,mBAC7B0B,EAAY,WACZC,EAAYA,GAAW,mBACd3B,EAAW,cAAgB,gBACpC0B,EAAY,QACZC,EAAYA,GAAW,aACd3B,EAAW,cAAgB,gBACpC0B,EAAY,QACZC,EAAYA,GAAW,aACd3B,EAAW,cAAgB,iBACpC0B,EAAY,QACZC,EAAYA,GAAW,aAGzB,IAAMC,EAAW,GAAG5B,EAAW,IAAI,EAAE,IAAI2B,EAAS,MAAM,GAAG,EAAE,CAAC,CAAC,GAEzDE,EAAOJ,EAAO,WAEdK,EAAWC,GAAK,GAAG,KAAK,SAAS,EAAE,GAAI/B,EAAW,IAAI,UAAW0B,EAAWE,CAAQ,EAE1F,MAAgBI,GAAWF,EAAUL,EAAQI,EAAM,CACjD,eAAgBF,CAClB,CAAC,EAED,IAAMM,EAAW,MAAgBC,GAAaJ,CAAQ,EAEtD9B,EAAW,QAAQ,SAAWiC,CAChC,OAASpC,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,gCAAiCA,GAAO,QAASA,GAAO,KAAK,CAAC,CACnF,CAIJ,YAAK,OAAO,IAAIG,CAAU,EAE1B,KAAK,+BAAqCA,CAAU,EAEhD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAW,CAACY,GAC1F,KAAK,gBAAgB,6BAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChEZ,CACF,EAGE,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAWY,GACzF,MAAMR,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWJ,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,QACvB,CAAC,EAEH,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,KAAMA,CACR,CAAC,EAEMA,CACT,OAASH,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIsC,EAAoBtC,EAAM,SAAS,CAAC,CAChD,CACF,CAEA,MAAa,YAAYD,EAAmBgB,EAAgB,GAAO,CAiBjE,OAhBY,MAAM,KAAK,sBACrBhB,EAAK,OACL,CACE,aAAcA,EAAK,IACrB,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACA,KACAgB,CACF,CAEF,CAEA,MAAgB,oBAAoBwB,EAA4B,CAC9D,GAAI,CACF,GAAIA,EAAa,YAAc,YAAc,CAACA,EAAa,SAAU,CAEnE,IAAMC,EADQ,IAAI,OAAO,aAAa,EACb,KAAKD,EAAa,KAAK,EAChDA,EAAa,SAAWC,EAAW,CAAC,CACtC,CAEID,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAGtBA,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAG1B,IAAIT,EAEEW,EAAoB,CACxB,QAASF,GAAc,QACvB,SAAUA,EAAa,SACvB,UAAWA,EAAa,UACxB,MAAOA,EAAa,MACpB,YAAa,EACf,EAEA,OAAIhB,GAAMgB,EAAa,KAAK,EAC1BT,EAAWY,GAAU,OAAOH,EAAa,KAAK,EAE9CT,EAAWY,GAAU,OAAOH,EAAa,QAAQ,EAGnDE,EAAa,SAAWX,EAEjBW,CACT,OAASzC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIC,EAA6BD,GAAO,SAAS,GAAKA,CAAK,CACnE,CACF,CAEA,MAAa,aAAaD,EAAoBe,EAAYC,EAAgB,GAAO,CAC/E,IAAM4B,EAA0B,CAAE,GAAG5C,CAAK,EAEtCe,IAAM6B,EAAU,MAAQ7B,EAAK,OAAO,SAAS,QAAQ,GAEzD,IAAMF,EAAU,MAAM,KAAK,oBAAoB+B,CAAS,EAiBxD,OAfkB,MAAM,KAAK,sBAC3B5C,EAAK,OACL,CAAE,GAAGa,CAAQ,EACb,CACE,MAAOb,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAe,EACAC,CACF,CAGF,CAEA,MAAa,aAAa6B,EAAe/C,EAAgBiB,EAAW,CAClEjB,EAASA,EAAO,QAAQ,MAAO,EAAE,EACjC,IAAMgD,EAAO,GAAGhD,CAAM,IAAI,IAAI,KAAK,EAAE,QAAQ,CAAC,GAE9C,GAAI,QAAQ,IAAI,oBACd,GAAI,CACF,KAAK,OAAO,QAAQ,2BAA2B,EAC/C,IAAMiD,EAAW,IAAIC,GAEjBjC,EACFgC,EAAS,OAAO,OAAQhC,EAAK,OAAQ,CACnC,SAAUA,EAAK,aACf,YAAaA,EAAK,QACpB,CAAC,EACQS,GAAMqB,CAAK,EACpBE,EAAS,OAAO,MAAOF,CAAK,EAE5BE,EAAS,OAAO,SAAUF,CAAK,EAGjCE,EAAS,OAAO,SAAU,KAAK,EAE/B,IAAME,EAAW,MAAMC,GAAM,KAAK,QAAQ,IAAI,oBAAqBH,EAAU,CAC3E,QAAS,CACP,GAAGA,EAAS,WAAW,EACvB,OAAQ,QAAQ,IAAI,uBACtB,CACF,CAAC,EAED,GAAI,CAACE,GAAU,MAAM,MACnB,MAAM,IAAI/C,EAA6B,yBAAyB,EAUlE,MAP0B,CACxB,SAAU,GAAG4C,CAAI,OACjB,UAAW,QACX,MAAOG,GAAU,MAAM,MACvB,SAAU,YACZ,CAGF,OAAShD,EAAO,CACd,WAAK,OAAO,MAAMA,GAAO,UAAU,MAAQA,CAAK,EAC1C,IAAIC,EAA6BD,GAAO,UAAU,MAAM,SAAWA,GAAO,SAAS,GAAKA,CAAK,CACrG,KACK,CACL,IAAI8B,EAEEW,EAAoB,CACxB,SAAU,GAAGI,CAAI,OACjB,UAAW,QACX,MAAOD,EACP,SAAU,YACZ,EAEA,OAAIrB,GAAMqB,CAAK,EACbd,EAAWY,GAAU,OAAOE,CAAK,EAAE,SAAS,EAE5Cd,EAAWY,GAAU,OAAOD,EAAa,QAAQ,EAAE,SAAS,EAG9DA,EAAa,SAAWX,EAEjBW,CACT,CACF,CAEA,MAAa,cAAc1C,EAAoBe,EAAYC,EAAgB,GAAO,CAChF,IAAM4B,EAA0B,CAAE,GAAG5C,CAAK,EAE1C,GAAIe,GAAM,OACR6B,EAAU,MAAQ7B,EAAK,OAAO,SAAS,QAAQ,MAE/C,eAAQ,MAAM,0DAAqD,EAC7D,IAAI,MAAM,8BAA8B,EAGhD,IAAMF,EAAU,MAAM,KAAK,aAAa+B,EAAU,MAAO5C,EAAK,OAAQe,CAAI,EAiB1E,OAfkB,MAAM,KAAK,sBAC3Bf,EAAK,OACL,CAAE,GAAGa,CAAQ,EACb,CACE,MAAOb,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAe,EACAC,CACF,CAGF,CAEA,MAAa,cAAchB,EAAsBgB,EAAgB,GAAO,CACtE,OAAO,MAAM,KAAK,sBAChBhB,EAAK,OACL,CACE,cAAe,CACb,MAAOA,EAAK,MACZ,YAAaA,EAAK,YAClB,OAAQA,EAAK,OACb,QAASA,EAAK,OAChB,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACA,KACAgB,CACF,CACF,CACA,MAAa,iBAAkB,CAC7B,MAAM,IAAIuB,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,iBAAkB,CAC7B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,iBAAkB,CAC7B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,2BAA4B,CACvC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,eAAgB,CAC3B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,eAAgB,CAC3B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,uBAAwB,CACnC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,qBAAsB,CACjC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,eAAgB,CAC3B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,wBAAyB,CACpC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,iBAAkB,CAC7B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACA,MAAa,UAAW,CACtB,MAAM,IAAIA,EAAoB,2CAA2C,CAC3E,CACF,EC92BO,IAAMY,GAA2C,CACtD,EAAG,QACH,EAAG,UACH,EAAG,aACH,EAAG,eACH,EAAG,OACH,EAAG,QACL,ECiBA,OAAOC,OAAW,QAClB,OAAS,eAAAC,GAAa,SAAAC,OAAa,kBAEnC,OAAOC,OAAc,YACrB,OAAS,oBAAAC,OAAwB,KACjC,OAAOC,OAAe,aACtB,OAAS,QAAAC,OAAY,OAEd,IAAMC,GAAN,cAAqCC,EAAsB,CAChE,YACkBC,EACAC,EACAC,EACAC,EACAC,EACAC,EACCC,EACjB,CACA,MAAMN,EAAeC,EAAcC,EAAkBE,CAAa,EARlD,mBAAAJ,EACA,kBAAAC,EACA,sBAAAC,EACA,WAAAC,EACA,mBAAAC,EACA,kBAAAC,EACC,mBAAAC,EAKnB,KAAO,gBAAsC,CAAE,MAAO,MAAO,CAF7D,CAOA,IAAW,kBAAmB,CAC5B,OAAO,KAAK,eACd,CAEA,MAAa,aAAc,CACzB,KAAK,gBAAkB,CAAE,MAAO,OAAQ,CAC1C,CAEA,IAAW,QAAoB,CAC7B,MAAO,CACL,YAAa,KAAK,SAAS,QAAQ,YACnC,KAAM,KAAK,SAAS,QAAQ,KAC5B,OAAQ,KAAK,SAAS,QAAQ,OAC9B,MAAO,KAAK,SAAS,QAAQ,KAC/B,CACF,CAEA,MAAa,gBAAiB,CAC5B,MAAM,KAAK,YAAY,CACzB,CAEQ,eAAeC,EAAc,CACnC,OAAOA,EAAQ,UAAYA,EAAQ,OAASA,EAAQ,OAASA,EAAQ,KACvE,CAEA,MAAc,KAAKA,EAAcC,EAAgB,CAC/C,GAAI,CACF,IAAIC,EAAY,KAAK,cAAc,IAAgB,aAAa,EAAE,IAC5DC,EAAU,KAAK,cAAc,IAAgB,aAAa,EAAE,QAClED,EAAY,GAAGA,CAAS,IAAIC,CAAO,IAAI,KAAK,MAAM,IAAIF,CAAM,GAC5D,IAAMG,EAAU,CAAE,eAAgB,mBAAoB,cAAe,UAAU,KAAK,KAAK,EAAG,EAE5F,OADe,MAAMpB,GAAM,KAAKkB,EAAWF,EAAS,CAAE,QAAAI,CAAQ,CAAC,GACjD,IAChB,OAASC,EAAG,CACV,OAAOA,EAAE,UAAU,MAAM,KAC3B,CACF,CAEA,MAAa,eAAeC,EAAgB,CAG1C,MAAO,CACL,KAHUC,EAAUD,CAAM,EAI1B,kBAAmB,IACrB,CACF,CAEA,MAAa,gBAAiB,CAC5B,OAAO,IACT,CAEA,MAAa,mBAAoB,CAC/B,OAAO,IACT,CAEA,MAAa,kBAAmB,CAC9B,OAAO,IACT,CAEA,MAAa,2BAA2BE,EAAoC,CAC1E,IAAMC,EAAU,CACd,kBAAmB,WACnB,MAAOD,EAAK,MACZ,QAASA,EAAK,QACd,YAAaA,EAAK,YAClB,SAAUA,EAAK,SACf,MAAOA,EAAK,MACZ,SAAUA,EAAK,SACf,uBAAwBA,EAAK,aAC/B,EACA,OAAO,MAAM,KAAK,KAAKC,EAAS,2BAA2B,CAC7D,CAEA,MAAa,kBAAkBD,EAA0B,CACvD,GAAI,CAACA,EAAM,OAEX,IAAMC,EAAUD,EAAK,MAAM,CAAC,EAAE,QAAQ,CAAC,EAAE,MAEzC,GAAI,CACF,KAAK,aAAa,EAElB,KAAK,aAAaC,CAAO,EAEzB,KAAK,YAAcF,EAAUE,EAAQ,SAAWA,EAAQ,SAAS,CAAC,EAAE,KAAOA,EAAQ,SAAS,CAAC,GAAG,YAAY,CAC9G,OAASC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIC,EAA6BD,GAAO,SAAS,CAAC,CAC1D,CACF,CAEA,MAAc,qBAAqBV,EAAc,CAC/C,GAAI,CACF,IAAMY,EAAKZ,EAAQA,EAAQ,IAAI,EAAE,GAC7BE,EAAY,KAAK,cAAc,IAAgB,aAAa,EAAE,IAC5DC,EAAU,KAAK,cAAc,IAAgB,aAAa,EAAE,QAClED,EAAY,GAAGA,CAAS,IAAIC,CAAO,IAAIS,CAAE,GACzC,IAAMR,EAAU,CAAE,eAAgB,mBAAoB,cAAe,UAAU,KAAK,KAAK,EAAG,EACxFS,EAAS,MAAM7B,GAAM,IAAIkB,EAAW,CAAE,QAAAE,CAAQ,CAAC,EACnD,OAAAS,EAAS,MAAM7B,GAAM,IAAI6B,EAAO,KAAK,IAAK,CAAE,QAAAT,EAAS,aAAc,aAAc,CAAC,EAC3ES,EAAO,IAChB,OAASR,EAAG,CACV,KAAK,OAAO,MAAMA,CAAC,CACrB,CACF,CAEQ,iBAAiBS,EAAe,CACtC,IAAMd,EAAUc,EAAS,SAAS,CAAC,EAC/BL,EAAeT,EAAQ,KAAO,UAClC,OAAAS,EAAU,CAAE,CAACA,CAAO,EAAGT,EAAQA,EAAQ,IAAI,CAAE,EAC7CA,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,GAClFS,CACT,CAEQ,uBAAuBK,EAAe,CAC5C,IAAMd,EAAUc,EAAS,SAAS,CAAC,EAC/BL,EAAe,CAAE,aAAcT,EAAQ,YAAYA,EAAQ,YAAY,IAAI,EAAE,KAAM,EACvF,OAAAA,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,GAClFS,CACT,CAEQ,kBAAkBK,EAAe,CACvC,IAAMd,EAAUc,EAAS,SAAS,CAAC,EAC/BL,EAAe,CAAE,aAAcK,EAAS,SAAS,CAAC,EAAE,QAAQ,IAAK,EACrE,OAAAd,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,GAClFS,CACT,CAEQ,oBAAoBK,EAAe,CACzC,IAAMd,EAAUc,EAAS,SAAS,CAAC,EAC/BL,EAAe,CACjB,gBAAiB,CACf,IAAK,CACH,GAAIT,EAAQ,SAAS,UACvB,EACA,KAAMA,EAAQ,SAAS,KACzB,CACF,EACA,OAAAA,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,GAClFS,CACT,CAEQ,gBAAgBK,EAAe,CACrC,IAAIL,EACET,EAAUc,EAAS,SAAS,CAAC,EACnC,OAAId,EAAQ,OAASc,EAAS,SAAS,iBACrCL,EAAU,CACR,oBAAqB,CAAE,KAAMT,EAAQ,KAAK,IAAK,CACjD,EACAA,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,KAEzFS,EAAU,CAAE,aAAcT,EAAQ,KAAK,IAAK,EAC5CA,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,IAEpFS,CACT,CAEQ,oBAAoBK,EAAe,CACzC,IAAMd,EAAUc,EAAS,SAAS,CAAC,EAC/BL,EAAe,CAAC,EAEdM,EAASC,GAAiB,CAC9B,IAAIH,EACF;AAAA;AAAA,IAEKG,EAAQ,KAAK,cAAc;AAAA,KAC1BA,EAAQ,KAAK,cAAc;AAAA,EAEnC,OAAIA,EAAQ,MACVH,GAAU,OAAOG,EAAQ,IAAI,OAAO;AAAA,GAGlCA,EAAQ,SACVH,GAAU,SAASG,EAAQ,OAAO,CAAC,EAAE,KAAK;AAAA,GAGxCA,EAAQ,OACVH,GAAU,OAAOG,EAAQ,KAAK,CAAC,EAAE,GAAG;AAAA,GAGjCA,EAAQ,OAAO,CAAC,GAAG,QACtBA,EAAQ,OAAO,CAAC,EAAE,MAAQT,EAAUS,EAAQ,OAAO,CAAC,EAAE,KAAK,GAG7DH,GACE,kBAAkBG,EAAQ,OAAO,CAAC,GAAG,KAAK,IAAIA,EAAQ,OAAO,CAAC,EAAE,KAAK;AAAA;AAAA,WAIhEH,CACT,EAEA,OAAIb,EAAQ,SAAS,SAAW,EAC9BS,EAAQ,eAAiB,CACvB,YAAaT,EAAQ,SAAS,CAAC,EAAE,KAAK,eACtC,MAAOe,EAAMf,EAAQ,SAAS,CAAC,CAAC,CAClC,EAEAS,EAAQ,qBAAuB,CAC7B,YAAa,GAAGT,EAAQ,MAAM,YAC9B,SAAUA,EAAQ,IAAKgB,IACd,CACL,YAAaA,EAAQ,KAAK,eAC1B,MAAOD,EAAMC,CAAO,CACtB,EACD,CACH,EAEFhB,EAAQ,UAAWS,EAAU,CAAE,GAAGA,EAAS,YAAa,CAAE,SAAUT,EAAQ,QAAQ,EAAG,CAAE,GAClFS,CACT,CAEQ,kBAAkBQ,EAAc,CACtC,IAAIC,EAEJ,OAAQD,EAAM,CACZ,IAAK,OACHC,EAAc,eACd,MACF,IAAK,QACHA,EAAc,eACd,MACF,IAAK,QACHA,EAAc,eACd,MACF,IAAK,QACHA,EAAc,eACd,MACF,IAAK,WACHA,EAAc,kBACd,MACF,IAAK,WACHA,EAAc,eACd,MACF,QACEA,EAAc,eACd,KACJ,CAEA,OAAOA,CACT,CAEA,MAAgB,cAAcJ,EAAeK,EAAoBC,EAAe,CAC9E,GAAI,CACF,IAAIC,EACAC,EAIJ,GAFIR,EAAS,WAAUQ,EAAWR,EAAS,SAAS,CAAC,EAAE,QAAQ,MAE3DA,EAAS,SAAU,CACrB,IAAMS,EAAM,CACV,GAAIT,EAAS,SAAS,CAAC,EAAE,GACzB,UAAW,KAAK,YAChB,OAAQA,EAAS,SAAS,CAAC,EAAE,OAASA,EAAS,SAAS,eAC1D,EACA,GAAI,KAAK,eAAeA,GAAU,SAAS,CAAC,CAAC,EAY3C,GAXAO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,KAAK,iBAAiBR,CAAQ,EACvC,YAAa,KAAK,iBAAiBA,CAAQ,GAAG,YAC9C,YAAa,KAAK,kBAAkBA,EAAS,SAAS,CAAC,EAAE,IAAI,EAC7D,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EAEI,KAAK,cAAc,IAAQ,IAAI,EAAE,OACnC,GAAI,CACF,IAAMd,EAAec,EAEfF,EAAKZ,EAAQ,SAAS,CAAC,EAAEA,EAAQ,SAAS,CAAC,EAAE,IAAI,EAAE,GACrDE,EAAY,KAAK,cAAc,IAAgB,aAAa,EAAE,IAC5DC,EAAU,KAAK,cAAc,IAAgB,aAAa,EAAE,QAClED,EAAY,GAAGA,CAAS,IAAIC,CAAO,IAAIS,CAAE,GACzC,IAAMR,EAAU,CAAE,eAAgB,mBAAoB,cAAe,UAAU,KAAK,KAAK,EAAG,EACtFS,EAAS,MAAM7B,GAAM,IAAIkB,EAAW,CAAE,QAAAE,CAAQ,CAAC,EAE/CoB,EAAS,MAAMxC,GAAM,IAAI6B,EAAO,KAAK,IAAK,CAAE,QAAAT,EAAS,aAAc,aAAc,CAAC,EAEpFqB,EAEAzB,EAAQ,SAAS,CAAC,EAAE,SACtByB,EAAY,WACHzB,EAAQ,SAAS,CAAC,EAAE,MAC7ByB,EAAY,QACHzB,EAAQ,SAAS,CAAC,EAAE,MAC7ByB,EAAY,QAEZA,EAAY,QAGd,IAAMC,EAAWb,EAAO,MAAM,WAAaA,EAAO,QAAQ,cAAc,EAElEc,EAAqBd,EAAO,QAAQ,qBAAqB,EAC3De,EAAW,GAAG5B,EAAQ,SAAS,CAAC,EAAE,EAAE,IAAI0B,EAAS,MAAM,GAAG,EAAE,CAAC,CAAC,GAClE,GAAIC,EAAoB,CACtB,IAAME,EAAQF,EAAmB,MAAM,kBAAkB,EACrDE,IACFD,EAAWC,EAAM,CAAC,EAEtB,CAEA,IAAMC,EAAOjB,EAAO,QAAQ,gBAAgB,GAAKW,EAAO,KAAK,WAEvDO,EAAWzC,GAAK,GAAG,KAAK,SAAS,EAAE,GAAIiC,EAAI,UAAWE,EAAWG,CAAQ,EAE/E,MAAgBI,GAAWD,EAAUP,EAAO,KAAMM,EAAM,CACtD,eAAgBJ,CAClB,CAAC,EAED,IAAMO,EAAiB,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CAChE,KAAMZ,CACR,CAAC,EAED,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,KAAM,CACJ,UAAWY,EAAe,GAC1B,WAAY,KAAK,WACjB,KAAMR,EACN,SAAUM,EACV,SAAAL,CACF,CACF,CAAC,EAED,IAAMQ,EAAW,MAAgBC,GAAaJ,CAAQ,EAEtDV,EAAW,QAAQ,SAAWa,EAC9Bb,EAAW,QAAQ,OAASG,EAAO,KAAK,SAAS,QAAQ,CAC3D,OAASd,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,gCAAiCA,GAAO,QAASA,GAAO,KAAK,CAAC,CACnF,KACK,CACL,IAAMc,EAAS,MAAM,KAAK,qBAAqBV,GAAU,SAAS,CAAC,CAAC,EAEpEO,EAAW,QAAQ,OAASG,EAAO,SAAS,QAAQ,CACtD,MACSV,GAAU,SAAS,CAAC,EAAE,YAC/BO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,CACP,GAAG,KAAK,uBAAuBR,CAAQ,CACzC,EACA,YAAa,KAAK,uBAAuBA,CAAQ,GAAG,YACpD,YAAa,qBACb,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EACSA,GAAU,SAAS,CAAC,EAAE,OAC/BO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,CACP,GAAG,KAAK,kBAAkBR,CAAQ,CACpC,EACA,YAAa,KAAK,kBAAkBA,CAAQ,GAAG,YAC/C,YAAa,gBACb,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EACSA,GAAU,SAAS,CAAC,EAAE,SAC/BO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,CACP,GAAG,KAAK,oBAAoBR,CAAQ,CACtC,EACA,YAAa,KAAK,oBAAoBA,CAAQ,GAAG,YACjD,YAAa,kBACb,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EACSA,GAAU,SAAS,CAAC,EAAE,SAC/BO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,CACP,GAAG,KAAK,oBAAoBR,CAAQ,CACtC,EACA,YAAa,KAAK,oBAAoBA,CAAQ,GAAG,YACjD,YAAa,iBACb,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EAEAO,EAAa,CACX,IAAAE,EACA,SAAAD,EACA,QAAS,KAAK,gBAAgBR,CAAQ,EACtC,YAAa,KAAK,gBAAgBA,CAAQ,GAAG,YAC7C,YAAa,KAAK,kBAAkBA,EAAS,SAAS,CAAC,EAAE,IAAI,EAC7D,iBAAkB,SAASA,EAAS,SAAS,CAAC,EAAE,SAAS,EACzD,OAAQ,UACR,WAAY,KAAK,UACnB,EAOF,GAJI,KAAK,cAAc,aAInB,KAAK,cAAc,IAAY,QAAQ,EAAE,QAAS,CACpD,IAAMsB,EAAwB,MAAM,KAAK,iBAAiB,cAAc,UAAU,CAChF,MAAO,CACL,WAAY,KAAK,UACnB,EACA,QAAS,CACP,YAAa,EACf,CACF,CAAC,EAEKC,EAAevB,GAAU,SAAS,CAAC,GAAG,MAG1CsB,GACAA,EAAsB,eACtBA,EAAsB,cACtBC,IAEAhB,EAAW,QAAQ,aAAe,MAAM,KAAK,cAAc,aACzDe,EAAsB,YACtB,CACE,QAAS,CACP,SAAUf,EAAW,QAAQ,SAC7B,GAAGA,CACL,CACF,EACA,IAAM,CAAC,CACT,EAEJ,CAaA,GAXA,KAAK,OAAO,IAAIA,CAAU,EAE1B,KAAK,kCAAwCA,CAAU,EAEvD,MAAMiB,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWjB,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,QACvB,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,QAAS,CACvF,IAAMkB,EAAsB,MAAM,KAAK,gBAAgB,gCAErD,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChElB,CACF,EAEIkB,GAAqB,KACvBlB,EAAW,kBAAoBkB,EAAoB,GACnDlB,EAAW,gBAAkBkB,EAAoB,GACjDlB,EAAW,uBAAyBkB,EAAoB,GAE5D,CAEK,KAAK,eAAezB,GAAU,SAAS,CAAC,CAAC,GAC5C,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,KAAMO,CACR,CAAC,EAGH,IAAML,EAAU,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC5D,MAAO,CAAE,WAAY,KAAK,WAAY,UAAWO,EAAI,SAAU,CACjE,CAAC,EAEKiB,EAAkB,CACtB,UAAW1B,EAAS,SAAS,CAAC,EAAE,QAAQ,MACxC,SAAAQ,EAEA,WAAY,KAAK,UACnB,EAEA,GAAIkB,EAAW,YAAc,mBAC3B,OAGF,GAAIxB,EAAS,CACX,IAAMwB,EAAkB,CACtB,UAAW1B,EAAS,SAAS,CAAC,EAAE,QAAQ,MACxC,SAAAQ,EAEA,WAAY,KAAK,UACnB,EAEA,KAAK,kCAAwCkB,CAAU,EAEnD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,MAAM,KAAK,gBAAgB,gCAEzB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChEA,CACF,EAGF,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CAAE,UAAWxB,EAAQ,SAAU,EACtC,KAAMwB,CACR,CAAC,EACD,MACF,CAEA,KAAK,kCAAwCA,CAAU,EAEvD,KAAK,iBAAiB,QAAQ,OAAO,CACnC,KAAMA,CACR,CAAC,CACH,CACA,GAAI1B,EAAS,SACX,cAAiB2B,KAAQ3B,EAAS,SAAU,CAC1C,IAAMS,EAAM,CACV,GAAIkB,EAAK,GACT,UAAW,KAAK,YAChB,OAAQ,KAAK,cAAgB3B,EAAS,SAAS,eACjD,EACA,GAAIM,GAAU,eAAiBG,EAAI,UAAU,SAAS,OAAO,EAC3D,OAEF,GAAIA,EAAI,YAAc,oBAAsB,CAACA,GAAK,WAAW,MAAM,QAAQ,EAAG,CAC5E,IAAMmB,EAAc,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAChE,MAAO,CACL,WAAY,KAAK,WACjB,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQnB,EAAI,EACd,CACF,CACF,CAAC,EAED,GAAI,CAACmB,EACH,OAGF,GAAID,EAAK,UAAY,MAAQA,EAAK,SAAW,OAAW,CACtD,KAAK,kCAAwClB,CAAG,EAEhD,IAAMvB,EAAe,CACnB,UAAW0C,EAAY,GACvB,MAAOnB,EAAI,GACX,UAAWA,EAAI,UACf,OAAQA,EAAI,OACZ,YAAaA,GAAK,UAClB,OAAQ,UACR,WAAY,KAAK,UACnB,EAEA,MAAM,KAAK,iBAAiB,cAAc,OAAO,CAC/C,KAAMvB,CACR,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,gCAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CAAE,IAAKuB,CAAI,CACb,EAGF,MACF,CAEA,IAAMvB,EAAe,CACnB,UAAW0C,EAAY,GACvB,MAAOnB,EAAI,GACX,UAAWA,EAAI,UACf,OAAQA,EAAI,OACZ,YAAaA,GAAK,UAClB,OAAQkB,EAAK,OAAO,YAAY,EAChC,WAAY,KAAK,UACnB,EAEA,KAAK,kCAAwCzC,CAAO,EAEpD,MAAM,KAAK,iBAAiB,cAAc,OAAO,CAC/C,KAAMA,CACR,CAAC,EAEG0C,EAAY,YACd,MAAM1D,GAAM,KAAK0D,EAAY,WAAY1C,CAAO,CAEpD,CACF,CAEJ,OAASU,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEQ,oBAAoBV,EAAcS,EAAc,CACtD,IAAIkC,EAEJ,OAAI3C,GAAS,aACPS,GAAS,SAAS,YACpBkC,EAAiB,CACf,GAAG3C,EACH,YAAa,CAAE,SAAUS,EAAQ,QAAQ,UAAW,CACtD,EACOkC,IAETA,EAAiB3C,EACV2C,GAGL3C,GAAS,YAAc,QACrBS,GAAS,SAAS,YACpBkC,EAAiB,CACf,aAAc3C,EACd,YAAa,CAAE,SAAUS,EAAQ,QAAQ,UAAW,CACtD,EACOkC,GAEF,CACL,aAAc3C,CAChB,EAGEA,GAAS,YAAc,QACrBS,GAAS,SAAS,YACpBkC,EAAiB,CACf,aAAc3C,EACd,YAAa,CAAE,SAAUS,EAAQ,QAAQ,UAAW,CACtD,EACOkC,GAEF,CACL,aAAc3C,CAChB,EAGEA,GAAS,YAAc,QACrBS,GAAS,SAAS,YACpBkC,EAAiB,CACf,aAAc3C,EACd,YAAa,CAAE,SAAUS,EAAQ,QAAQ,UAAW,CACtD,EACOkC,GAEF,CACL,aAAc3C,CAChB,EAGEA,GAAS,YAAc,WACrBS,GAAS,SAAS,YACpBkC,EAAiB,CACf,gBAAiB3C,EACjB,YAAa,CAAE,SAAUS,EAAQ,QAAQ,UAAW,CACtD,EACOkC,GAEF,CACL,gBAAiB3C,CACnB,EAGKA,CACT,CAEA,MAAgB,aAAaS,EAAc,CACzC,IAAMU,EAAW,KAAK,cAAc,IAAc,UAAU,EACtDC,EAAW,MAAM,KAAK,aAAa,EAEzC,KAAK,cAAcX,EAASU,EAAUC,CAAQ,CAChD,CAEA,MAAgB,sBAAsBd,EAAgBN,EAAc4C,EAAmBC,EAAgB,GAAO,CAC5G,GAAI,CACF,IAAIC,EACAC,EACEC,EAAcJ,GAAS,aAAe,GAAQ,OAAY,GAChE,GAAIA,GAAS,OAAQ,CAGnB,IAAMK,EAFIL,GAAS,QAEJ,IAEf,GAAI,CAACK,EACH,KAAM,oBAGRH,EAASG,CACX,CACIL,GAAS,aACXG,EAAaH,EAAQ,YAGvB,IAAInC,EACEyC,EAAc,MAAO,SAAY,CACrC,GAAIlD,EAAQ,gBACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAM,WACN,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,SAAU,CACR,WAAYN,EAAQ,gBAAmB,IAAO,GAC9C,MAAOA,EAAQ,gBAAmB,IACpC,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GAC7C,MAAM,KAAK,KAAKrC,EAAS,UAAU,EAE5C,GAAIT,EAAQ,gBACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAM,WACN,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,SAAU,CACR,UAAWN,EAAQ,gBAAmB,iBACtC,SAAUA,EAAQ,gBAAmB,gBACrC,KAAMA,EAAQ,gBAAmB,KACjC,QAASA,EAAQ,gBAAmB,OACtC,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GAC7C,MAAM,KAAK,KAAKrC,EAAS,UAAU,EAE5C,GAAIT,EAAQ,SACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAM,WACN,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,SAAUN,EAAQ,QACpB,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GACpD9C,EAAUA,EAAQ,QACX,MAAM,KAAK,KAAKS,EAAS,UAAU,EAE5C,GAAIT,EAAQ,aACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAM,OACN,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,KAAM,CACJ,KAAMN,EAAQ,aACd,YAAagD,CACf,CACF,EACAF,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GAC7C,MAAM,KAAK,KAAKrC,EAAS,UAAU,EAE5C,GAAIT,EAAQ,MAAU,CACpB,IAAMmD,EAAUnD,EAAQ,UAAa,WAAW,QAAQ,EAExD,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAMT,EAAQ,UACd,GAAIM,EAAO,QAAQ,MAAO,EAAE,EAC5B,CAACN,EAAQ,SAAY,EAAG,CACtB,CAACA,EAAQ,IAAO,EAAGA,EAAQ,GAC3B,YAAagD,EACb,GAAIhD,EAAQ,UAAe,CAACmD,GAAW,CAAE,SAAUnD,EAAQ,QAAY,EACvE,QAASA,EAAQ,OACnB,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GAC7C,MAAM,KAAK,KAAKrC,EAAS,UAAU,CAC5C,CACA,GAAIT,EAAQ,MACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,KAAM,QACN,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,MAAO,CACL,CAACN,EAAQ,IAAO,EAAGA,EAAQ,EAC7B,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GAC7C,MAAM,KAAK,KAAKrC,EAAS,UAAU,EAE5C,GAAIT,EAAQ,QAAY,CACtBS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,KAAM,cACN,YAAa,CACX,KAAM,SACN,KAAM,CACJ,KAAMN,EAAQ,MAAW,QAC3B,EACA,OAAQ,CACN,QAASA,EAAQ,OACnB,CACF,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GACpD,IAAIM,EAAgB,GACpB,QAAWX,KAAQzC,EAAQ,QACzBoD,GAAiB,gBAAMX,EAAK,OAAO,KAAK;AAAA,EAE1C,OAAAzC,EAAU,CAAE,aAAc,GAAGA,EAAQ,MAAW,QAAQ;AAAA,EAAOoD,CAAc,EACtE,MAAM,KAAK,KAAK3C,EAAS,UAAU,CAC5C,CACA,GAAIT,EAAQ,YAAgB,CAC1BS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,KAAM,cACN,YAAa,CACX,KAAM,OACN,OAAQ,CACN,KAAM,OACN,KAAMN,EAAQ,YAAe,KAC/B,EACA,KAAM,CACJ,KAAMA,EAAQ,YAAe,WAC/B,EACA,OAAQ,CACN,KAAMA,EAAQ,YAAe,UAC/B,EACA,OAAQ,CACN,OAAQA,EAAQ,YAAe,WAC/B,SAAUA,EAAQ,YAAe,QACnC,CACF,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GACpD,IAAIM,EAAgB,GACpB,QAAWC,KAAWrD,EAAQ,YAAe,SAAa,CACxDoD,GAAiB,GAAGC,GAAS,KAAK;AAAA,EAClC,QAAWC,KAAOD,EAAQ,KACxBD,GAAiB,GAAGE,GAAK,KAAK;AAAA,CAElC,CACA,OAAAtD,EAAU,CAAE,aAAc,GAAGA,EAAQ,YAAe,KAAQ;AAAA,EAAOoD,CAAc,EAC1E,MAAM,KAAK,KAAK3C,EAAS,UAAU,CAC5C,CACA,GAAIT,EAAQ,SACV,OAAAS,EAAU,CACR,kBAAmB,WACnB,eAAgB,aAChB,GAAIH,EAAO,QAAQ,MAAO,EAAE,EAC5B,KAAM,WACN,SAAU,CACR,KAAMN,EAAQ,SAAY,KAC1B,SAAU,CACR,KAAMA,EAAQ,SAAY,UAAe,OAC3C,EACA,WAAYA,EAAQ,SAAY,UAClC,CACF,EACA8C,IAAUrC,EAAQ,QAAU,CAAE,WAAYqC,EAAO,EAAG,GACpD9C,EAAU,CAAE,aAAc,eAAKA,EAAQ,SAAY,IAAO,cAAK,EACxD,MAAM,KAAK,KAAKS,EAAS,UAAU,CAE9C,GAAG,EAEH,GAAIyC,GAAa,WACf,YAAK,OAAO,MAAMA,CAAW,EACtBA,EAGT,IAAM7B,EAAkB,CACtB,IAAK,CAAE,OAAQ,GAAM,GAAI6B,GAAa,SAAS,CAAC,GAAG,GAAI,UAAW3C,EAAUD,CAAM,CAAE,EACpF,QAAS,KAAK,oBAAoBN,EAASS,CAAO,EAClD,YAAa,KAAK,kBAAkBA,EAAQ,IAAI,EAChD,iBAAmByC,GAAa,SAAS,CAAC,GAAG,WAAwB,KAAK,MAAM,IAAI,KAAK,EAAE,QAAQ,EAAI,GAAI,EAC3G,WAAY,KAAK,WACjB,WAAAH,EACA,OAAQQ,GAAO,CAAC,EAChB,OAAQ,SACV,EAEA,YAAK,OAAO,IAAIlC,CAAU,EAE1B,KAAK,+BAAqCA,CAAU,EAEhD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAW,CAACwB,GAC1F,KAAK,gBAAgB,6BAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChExB,CACF,EAGE,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAWwB,GACzF,MAAMP,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWjB,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,QACvB,CAAC,EAEH,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,KAAMA,CACR,CAAC,EAEMA,CACT,OAASX,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI8C,EAAoB9C,EAAM,SAAS,CAAC,CAChD,CACF,CAGA,MAAa,YAAYF,EAAmBqC,EAAgB,GAAO,CAgBjE,OAfY,MAAM,KAAK,sBACrBrC,EAAK,OACL,CACE,aAAcA,EAAK,IACrB,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAqC,CACF,CAEF,CAEA,MAAc,WAAWY,EAAmB,CAC1C,IAAMC,EAAW,IAAIvE,GAEfwE,EAAavE,GAAiBqE,EAAa,KAAK,EAEtDC,EAAS,OAAO,OAAQC,EAAY,CAAE,SAAU,QAAS,YAAaF,EAAa,QAAS,CAAC,EAC7FC,EAAS,OAAO,WAAYD,EAAa,QAAQ,EACjDC,EAAS,OAAO,oBAAqB,UAAU,EAS/C,IAAMtD,EAAU,CAAE,cAAe,UAAU,KAAK,KAAK,EAAG,EAMxD,OALY,MAAMpB,GAAM,KACtB,QAAQ,IAAI,QAAU,IAAM,QAAQ,IAAI,QAAU,IAAM,KAAK,OAAS,SACtE0E,EACA,CAAE,QAAAtD,CAAQ,CACZ,GACW,KAAK,EAClB,CAEA,MAAgB,oBAAoBqD,EAA4B,CAC9D,GAAI,CACF,GAAIA,EAAa,YAAc,YAAc,CAACA,EAAa,SAAU,CAEnE,IAAMG,EADQ,IAAI,OAAO,aAAa,EACb,KAAKH,EAAa,KAAK,EAChDA,EAAa,SAAWG,EAAW,CAAC,CACtC,CAEIH,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAGtBA,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAG1B,IAAI/B,EAEEmC,EAAoB,CACxB,QAASJ,GAAc,QACvB,SAAUA,EAAa,SACvB,UAAWA,EAAa,UACxB,MAAOA,EAAa,MACpB,YAAa,EACf,EAEA,GAAIvE,GAAMuE,EAAa,KAAK,EAC1B/B,EAAWrC,GAAU,OAAOoE,EAAa,KAAK,EAC9CI,EAAa,GAAKJ,EAAa,MAC/BI,EAAa,KAAO,WACf,CACLnC,EAAWrC,GAAU,OAAOoE,EAAa,QAAQ,EACjD,IAAM7C,EAAK,MAAM,KAAK,WAAWiD,CAAY,EAC7CA,EAAa,GAAKjD,EAClBiD,EAAa,KAAO,IACtB,CAEA,OAAAA,EAAa,SAAWnC,EAEjBmC,CACT,OAASnD,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIC,EAA6BD,GAAO,SAAS,GAAKA,CAAK,CACnE,CACF,CAEA,MAAa,aAAaF,EAAoBsD,EAAYjB,EAAgB,GAAO,CAC/E,IAAMkB,EAA0B,CAAE,GAAGvD,CAAK,EAEtCsD,IAAMC,EAAU,MAAQD,EAAK,OAAO,SAAS,QAAQ,GAEzD,IAAM9D,EAAU,MAAM,KAAK,oBAAoB+D,CAAS,EAgBxD,OAdkB,MAAM,KAAK,sBAC3BvD,EAAK,OACL,CAAE,GAAGR,CAAQ,EACb,CACE,MAAOQ,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAqC,CACF,CAGF,CAEA,MAAa,aAAamB,EAAe1D,EAAgB,CACvDA,EAASA,EAAO,QAAQ,MAAO,EAAE,EACjC,IAAM2D,EAAO,GAAG3D,CAAM,IAAI,IAAI,KAAK,EAAE,QAAQ,CAAC,GAE1CoB,EAEEmC,EAAoB,CACxB,SAAU,GAAGI,CAAI,OACjB,UAAW,QACX,MAAOD,CACT,EAEA,GAAI9E,GAAM8E,CAAK,EACbtC,EAAWrC,GAAU,OAAO2E,CAAK,EACjCH,EAAa,GAAKG,EAClBH,EAAa,KAAO,WACf,CACLnC,EAAWrC,GAAU,OAAOwE,EAAa,QAAQ,EACjD,IAAMjD,EAAK,MAAM,KAAK,WAAWiD,CAAY,EAC7CA,EAAa,GAAKjD,EAClBiD,EAAa,KAAO,IACtB,CAEA,OAAAA,EAAa,SAAWnC,EAEjBmC,CACT,CAEA,MAAa,cAAcrD,EAAoBsD,EAAYjB,EAAgB,GAAO,CAChF,IAAMkB,EAA0B,CAAE,GAAGvD,CAAK,EAE1C,GAAIsD,GAAM,OACRC,EAAU,MAAQD,EAAK,OAAO,SAAS,QAAQ,UACtC,CAAA5E,GAAM6E,EAAU,KAAK,EAI9B,cAAQ,MAAM,gDAAgD,EACxD,IAAI,MAAM,6BAA6B,EAG/C,IAAM/D,EAAU,MAAM,KAAK,aAAa+D,EAAU,MAAOvD,EAAK,MAAM,EAgBpE,OAdkB,MAAM,KAAK,sBAC3BA,EAAK,OACL,CAAE,GAAGR,CAAQ,EACb,CACE,MAAOQ,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAqC,CACF,CAGF,CAEA,MAAa,cAAcrC,EAAsB,CAC/C,IAAM0D,EAAqB,CAAC,EAEtBC,EAAW,CACf,KAAM3D,EAAK,QAAQ,IAAK4D,GAAQA,EAAI,WAAW,EAC/C,IAAK5D,EAAK,QAAQ,IAAK4D,GAAQA,EAAI,EAAE,CACvC,EAEA,GAAI,CAACnF,GAAYkF,EAAS,IAAI,GAAK,CAAClF,GAAYkF,EAAS,GAAG,EAC1D,MAAM,IAAIX,EAAoB,kCAAmC,gCAAgC,EAGnG,OAAO,MAAM,KAAK,sBAChBhD,EAAK,OACL,CACE,KAAO0D,GAAe,SAAwB,OAAb1D,EAAK,MACtC,QAASA,EAAK,QAAQ,IAAK6D,IAClB,CACL,KAAM,QACN,MAAO,CACL,MAAOA,EAAO,YACd,GAAIA,EAAO,EACb,CACF,EACD,EACD,CAACH,GAAe,QAAQ,EAAGA,GAAe,OAC5C,EACA,CACE,MAAO1D,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAa,gBAAgBA,EAAuB,CAClD,OAAO,MAAM,KAAK,sBAChBA,EAAK,OACL,CACE,gBAAiB,CACf,gBAAiBA,EAAK,SACtB,iBAAkBA,EAAK,UACvB,KAAMA,GAAM,KACZ,QAASA,GAAM,OACjB,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAa,YAAYA,EAAmB,CAC1C,IAAM8D,EAAgB,CACpB,MAAO9D,EAAK,SAAS,IAAK+D,GAASA,EAAK,KAAK,CAC/C,EAEA,GAAI,CAACtF,GAAYqF,EAAc,KAAK,EAClC,MAAM,IAAId,EAAoB,kCAAkC,EAGlE,IAAMgB,EAAgB,CACpB,YAAa,CACX,MAAOhE,EAAK,MACZ,YAAaA,EAAK,YAClB,WAAYA,GAAM,WAClB,WAAYA,GAAM,WAClB,SAAUA,EAAK,SAAS,IAAK6C,IACpB,CACL,MAAOA,EAAQ,MACf,KAAMA,EAAQ,KAAK,IAAKC,IACf,CACL,MAAOA,EAAI,MACX,YAAaA,EAAI,YAAY,UAAU,EAAG,EAAE,EAC5C,GAAIA,EAAI,KACV,EACD,CACH,EACD,CACH,CACF,EAEA,OAAO,MAAM,KAAK,sBAAsB9C,EAAK,OAAQgE,EAAU,CAC7D,MAAOhE,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CAAC,CACH,CAEA,MAAa,gBAAgBA,EAAuBqC,EAAgB,GAAO,CAqBzE,OApBY,MAAM,KAAK,sBACrBrC,EAAK,OACL,CACE,SAAU,CACR,KAAMA,EAAK,KACX,SAAUA,EAAK,SACf,WAAYA,EAAK,UACnB,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,UACjB,WAAYA,GAAM,UACpB,EACAqC,CACF,CAEF,CAEA,MAAa,eAAerC,EAAsB,CAChD,IAAMR,EAAe,CAAC,EAEhBe,EAASC,GAA4B,CACzC,IAAIH,EAAS;AAAA;AAAA,IAAyCG,EAAQ,QAAQ;AAAA,KAAaA,EAAQ,QAAQ;AAAA,EAEnG,OAAIA,EAAQ,eACVH,GAAU,OAAOG,EAAQ,YAAY;AAAA,GAGnCA,EAAQ,QACVH,GAAU,SAASG,EAAQ,KAAK;AAAA,GAG9BA,EAAQ,MACVH,GAAU,OAAOG,EAAQ,GAAG;AAAA,GAGzBA,EAAQ,OACXA,EAAQ,KAAOT,EAAUS,EAAQ,WAAW,GAG9CH,GAAU,kBAAkBG,EAAQ,IAAI,IAAIA,EAAQ,WAAW;AAAA;AAAA,WAExDH,CACT,EAEA,OAAIL,EAAK,QAAQ,SAAW,EAC1BR,EAAQ,QAAU,CAChB,YAAaQ,EAAK,QAAQ,CAAC,EAAE,SAC7B,MAAOO,EAAMP,EAAK,QAAQ,CAAC,CAAC,CAC9B,EAEAR,EAAQ,qBAAuB,CAC7B,YAAa,GAAGQ,EAAK,QAAQ,MAAM,YACnC,SAAUA,EAAK,QAAQ,IAAKQ,IACnB,CACL,YAAaA,EAAQ,SACrB,MAAOD,EAAMC,CAAO,CACtB,EACD,CACH,EAEK,MAAM,KAAK,sBAChBR,EAAK,OACL,CACE,SAAUA,EAAK,QAAQ,IAAKQ,IACnB,CACL,KAAM,CAAE,eAAgBA,EAAQ,SAAU,WAAYA,EAAQ,QAAS,EACvE,OAAQ,CAAC,CAAE,MAAOA,EAAQ,WAAY,CAAC,EACvC,KAAM,CAAC,CAAE,IAAKA,EAAQ,GAAI,CAAC,EAC3B,OAAQ,CAAC,CAAE,MAAOA,EAAQ,KAAM,CAAC,EACjC,IAAK,CAAE,QAASA,EAAQ,YAAa,CACvC,EACD,EACD,QAAAhB,CACF,EACA,CACE,MAAOQ,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAa,gBAAgBA,EAAuB,CAClD,OAAO,MAAM,KAAK,sBAAsBA,EAAK,IAAI,UAAW,CAC1D,gBAAiB,CACf,IAAKA,EAAK,IACV,KAAMA,EAAK,QACb,CACF,CAAC,CACH,CAEA,MAAa,0BAA0BA,EAAW,CAChD,GAAI,CACF,IAAMyC,EAAMzC,EAAK,QACXU,EAAc+B,EAAI,YAAY,SAAS,SAAS,EAAIA,EAAI,YAAcA,EAAI,YAAc,UACxFQ,EAAeR,EAAI,QAAQ/B,CAAW,EAE5C,MAAO,CACL,UAAW+B,EAAI,YACf,SAAUQ,GAAc,SACxB,QAASA,GAAc,QACvB,KAAM,CACJ,WAAYA,GAAc,WAC1B,OAAQA,GAAc,WACtB,MAAOA,GAAc,KACvB,EACA,SAAUA,GAAc,UACxB,OAAQR,EAAI,QAAQ,MACtB,CACF,OAASvC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI8C,EAAoB9C,EAAM,SAAS,CAAC,CAChD,CACF,CAEA,MAAa,eAAgB,CAC3B,MAAM,IAAI8C,EAAoB,+CAA+C,CAC/E,CAGA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,eAAgB,CAC3B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,cAAe,CAC1B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,uBAAwB,CACnC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,qBAAsB,CACjC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,sBAAuB,CAClC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,eAAgB,CAC3B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,wBAAyB,CACpC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,WAAY,CACvB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,kBAAmB,CAC9B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,oBAAqB,CAChC,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,gBAAiB,CAC5B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,iBAAkB,CAC7B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,YAAa,CACxB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,aAAc,CACzB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,mBAAoB,CAC/B,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACA,MAAa,UAAW,CACtB,MAAM,IAAIA,EAAoB,+CAA+C,CAC/E,CACF,ECp8CO,IAAMiB,GAAN,KAAoB,CACzB,YACkBC,EACAC,EACAC,EACAC,EAChB,CAJgB,SAAAH,EACA,YAAAC,EACA,YAAAC,EACA,UAAAC,CACf,CACL,EAEaC,GAAN,KAAmC,CAG1C,EAEaC,GAAN,KAAwB,CAE/B,EAEaC,GAAN,KAAgB,CAEvB,EAmBO,IAAMC,GAAN,KAAqB,CAE5B,EAEaC,GAAN,KAAuB,CAE9B,EAEaC,GAAN,KAAwB,CAI/B,EAOO,IAAMC,GAAN,KAAqB,CAE5B,EAOO,IAAMC,GAAN,KAAqB,CAI5B,EAEaC,GAAN,KAAwB,CAG/B,EAEaC,GAAN,KAAwB,CAO/B,EAEaC,GAAN,KAAoB,CAK3B,EAKA,IAAMC,GAAN,KAAqB,CAErB,EACaC,GAAN,cAAuBD,EAAe,CAE7C,EAEaE,GAAN,cAA8BD,EAAS,CAG9C,EAEaE,GAAN,cAA+BF,EAAS,CAI/C,EAEaG,GAAN,KAAmB,CAG1B,EC7HA,OAAS,cAAAC,OAAkB,UAEpB,IAAMC,GAAN,KAAmB,CAGxB,YAA6BC,EAAe,CAAf,WAAAA,EAF7B,KAAiB,OAAS,IAAIC,EAAO,cAAc,EAG7CD,EACF,KAAK,OAAO,QAAQ,4CAA4CA,EAAM,aAAa,IAAI,EAAE,EAEzF,KAAK,OAAO,QAAQ,uBAAuB,CAE/C,CAEA,MAAM,IAAIE,EAA2B,CACnC,GAAK,KAAK,MAGV,OAAO,KAAK,MAAM,IAAIA,CAAG,CAC3B,CAEA,MAAa,KAAKA,EAAaC,EAAe,CAC5C,GAAI,CAAC,KAAK,MACR,OAAO,KAET,GAAI,CACF,IAAMC,EAAO,MAAM,KAAK,MAAM,KAAKF,EAAKC,CAAK,EAE7C,OAAIC,EACK,KAAK,MAAMA,EAAMN,GAAW,OAAO,EAGrC,IACT,OAASO,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAChB,IACT,CACF,CAEA,MAAM,IAAIH,EAAaI,EAAYC,EAAc,CAC1C,KAAK,OAGV,KAAK,MAAM,IAAIL,EAAKI,EAAOC,CAAG,CAChC,CAEA,MAAa,KAAKL,EAAaC,EAAeG,EAAY,CACxD,GAAK,KAAK,MAGV,GAAI,CACF,IAAME,EAAO,KAAK,UAAUF,EAAOR,GAAW,QAAQ,EAEtD,MAAM,KAAK,MAAM,KAAKI,EAAKC,EAAOK,CAAI,CACxC,OAASH,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAM,IAAIH,EAAa,CACrB,GAAK,KAAK,MAGV,OAAO,KAAK,MAAM,IAAIA,CAAG,CAC3B,CAEA,MAAM,OAAOA,EAAa,CACxB,GAAK,KAAK,MAGV,OAAO,KAAK,MAAM,OAAOA,CAAG,CAC9B,CAEA,MAAM,QAAQA,EAAaC,EAAe,CACxC,GAAI,CAAC,KAAK,MACR,MAAO,GAET,GAAI,CACF,aAAM,KAAK,MAAM,QAAQD,EAAKC,CAAK,EAC5B,EACT,OAASE,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAChB,EACT,CACF,CAEA,MAAM,UAAUI,EAAyB,CACvC,GAAK,KAAK,MAGV,OAAO,KAAK,MAAM,UAAUA,CAAc,CAC5C,CAEA,MAAM,KAAKA,EAAyB,CAClC,GAAK,KAAK,MAGV,OAAO,KAAK,MAAM,KAAKA,CAAc,CACvC,CACF,ECxBA,OAAOC,OAAgB,2BAEvB,OAAS,YAAYC,OAAY,uBC5EjC,OAAOC,OAAW,QAElB,SAASC,GAAoBC,EAAmB,CAC9C,IAAMC,EAA6B,CAAC,EAEhCD,EAAU,WAAW,GAAG,IAC1BA,EAAYA,EAAU,MAAM,CAAC,GAG/B,GAAM,CAACE,EAAQC,CAAM,EAAIH,EAAU,MAAM,GAAG,EAG5C,GAAIA,EAAU,WAAW,IAAI,EAAG,CAC9B,IAAMI,EACJF,EAAO,MAAM,EAAG,CAAC,IAAM,KAAOA,EAAO,SAAW,GAAKA,EAAS,GAAGA,EAAO,MAAM,EAAG,CAAC,CAAC,IAAIA,EAAO,MAAM,CAAC,CAAC,GAClGG,EAAqBH,EAAO,SAAW,GAAKA,EAASA,EAAO,MAAM,EAAG,CAAC,EAAIA,EAAO,MAAM,CAAC,EAE9FD,EAAiB,KAAKG,CAAe,EACrCH,EAAiB,KAAKI,CAAkB,CAC1C,SAISH,EAAO,WAAW,IAAI,GAAKA,EAAO,WAAW,IAAI,EAAG,CAC3D,IAAII,EAAS,GACTJ,EAAO,WAAW,IAAI,IACxBI,EAAS,KAEPJ,EAAO,WAAW,IAAI,IACxBI,EAAS,KAGX,IAAMF,EACJF,EAAO,MAAM,EAAG,CAAC,IAAMI,GAAUJ,EAAO,SAAW,GAC/CA,EACA,GAAGA,EAAO,MAAM,EAAG,CAAC,CAAC,GAAGI,CAAM,GAAGJ,EAAO,MAAM,CAAC,CAAC,GAChDG,EAAqBH,EAAO,SAAW,GAAKA,EAASA,EAAO,MAAM,EAAG,CAAC,EAAIA,EAAO,MAAM,CAAC,EAE9FD,EAAiB,KAAKG,CAAe,EACrCH,EAAiB,KAAKI,CAAkB,CAC1C,MAIEJ,EAAiB,KAAKD,CAAS,EAGjC,OAAOC,EAAiB,IAAKC,GAAW,GAAGA,CAAM,IAAIC,CAAM,EAAE,CAC/D,CAKA,eAAsBI,GAAoBC,EAAoC,CAC5E,GAAIC,EAAc,IAAc,UAAU,EAAE,UAAU,eAAgB,CACpE,IAAMC,EAAeF,EAAK,IAAKG,GAAS,CACtC,IAAMX,EAAYW,EAAK,UAAU,WAAW,GAAG,EAAIA,EAAK,UAAU,MAAM,CAAC,EAAIA,EAAK,UAC5EV,EAAmBF,GAAoBC,CAAS,EAEtD,OAAOY,EAAiB,aAAa,OAAO,CAC1C,OAAQ,CAAE,UAAWZ,EAAW,WAAYC,EAAiB,KAAK,GAAG,CAAE,EACvE,OAAQ,CAAE,WAAYA,EAAiB,KAAK,GAAG,CAAE,EACjD,MAAO,CAAE,UAAWD,CAAU,CAChC,CAAC,CACH,CAAC,EAED,MAAMY,EAAiB,aAAaF,CAAY,CAClD,CACF,CAEA,eAAsBG,GAAmBC,EAAsB,CAC7D,IAAIC,EAIE,CAAC,EAEP,GAAIN,EAAc,IAAc,UAAU,EAAE,UAAU,eAAgB,CACpE,IAAMO,EAAwBF,EAAW,IAAKd,GAAcD,GAAoBC,CAAS,CAAC,EAAE,KAAK,EAWjGe,GATwB,MAAMH,EAAiB,aAAa,SAAS,CACnE,MAAO,CACL,GAAII,EAAsB,IAAKhB,IAAe,CAAE,WAAY,CAAE,SAAUA,CAAU,CAAE,EAAE,EACtF,UAAW,CACT,IAAKF,GAAM,EAAE,SAASW,EAAc,IAAc,UAAU,EAAE,UAAU,oBAAqB,MAAM,EAAE,OAAO,CAC9G,CACF,CACF,CAAC,GAEyB,IAAKE,IAAU,CACvC,UAAWA,EAAK,UAChB,OAAQA,EAAK,UAAU,MAAM,GAAG,EAAE,CAAC,EACnC,WAAYA,EAAK,WAAW,MAAM,GAAG,CACvC,EAAE,CACJ,CAEA,OAAOI,CACT,CCnGA,OAAS,QAAAE,OAAY,OAEd,IAAMC,GAAW,QAAQ,IAAI,EACvBC,GAAeF,GAAKC,GAAU,WAAW,EACzCE,GAAUH,GAAKC,GAAU,KAAK,EAC9BG,GAAWJ,GAAKC,GAAU,QAAS,MAAM,EACzCI,GAAYL,GAAKC,GAAU,OAAO,ECH/C,OAA8B,cAAAK,GAAY,iBAAAC,GAAe,WAAWC,OAAa,UACjF,OAAOC,OAAQ,cACf,OAAOC,OAAU,OAEjB,IAAMC,GAAeC,GACdA,EAGiBA,EAAK,QAAQ,MAAO,IAAI,EACV,QAAQ,KAAM,GAAG,EAHnD,OAOJ,eAAsBC,GAAUC,EAAiC,CAC/D,GAAI,CAEF,MAAO,CAAC,CADI,MAAMC,EAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,UAAWD,CAAU,CAAE,CAAC,CAE3F,MAAgB,CACd,MAAO,EACT,CACF,CAEA,eAAsBE,GAAQF,EAAmBG,EAA4B,CAC3E,IAAMC,EAAS,MAAML,GAAUC,CAAS,EACxC,GAAI,CACF,GAAI,CAACI,EACH,OAAO,MAAMH,EAAiB,QAAQ,OAAO,CAC3C,KAAM,CACJ,UAAWD,EACX,MAAO,KAAK,UAAUG,CAAO,CAC/B,CACF,CAAC,EACH,MAAMF,EAAiB,QAAQ,OAAO,CACpC,MAAO,CAAE,UAAWD,CAAU,EAC9B,KAAM,CAAE,MAAO,KAAK,UAAUG,CAAO,CAAE,CACzC,CAAC,CACH,MAAgB,CACd,OAAO,IACT,CACF,CAEA,eAAsBE,GAAWL,EAAiC,CAChE,GAAI,CAEF,GAAI,CADa,MAAMD,GAAUC,CAAS,EAC3B,OAAO,KACtB,IAAMM,EAAO,MAAML,EAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,UAAWD,CAAU,CAAE,CAAC,EAC1F,OAAO,KAAK,MAAMM,GAAM,KAAK,CAC/B,MAAgB,CACd,OAAO,IACT,CACF,CAEA,eAAeC,GAAcP,EAAiC,CAC5D,GAAI,CAEF,GAAI,CADa,MAAMD,GAAUC,CAAS,EAC3B,OACf,MAAMC,EAAiB,QAAQ,OAAO,CAAE,MAAO,CAAE,UAAWD,CAAU,CAAE,CAAC,CAC3E,MAAgB,CACd,MACF,CACF,CAEA,eAAeQ,GAAWV,EAA4B,CACpD,GAAI,CAEF,IADa,MAAMH,GAAG,KAAKG,CAAI,GACtB,OAAO,EAAG,MAAO,EAC5B,MAAgB,CACd,MACF,CACF,CAEA,eAAOW,GACLT,EACAU,EAIC,CACD,IAAMC,EAAcf,GAAK,KAAKgB,GAAcZ,CAAS,EAC/Ca,EAAaC,GAAgBlB,GAAK,KAAKe,EAAad,GAAYiB,CAAG,EAAI,OAAO,EACpF,MAAMnB,GAAG,MAAMgB,EAAa,CAAE,UAAW,EAAK,CAAC,EAE/C,eAAeI,EAAUC,EAAWF,EAA2B,CAC7D,IAAMG,EAAa,KAAK,UAAUD,EAAMxB,GAAW,QAAQ,EAE3D,GAAIsB,GAAO,QAAS,CAClB,GAAI,QAAQ,IAAI,sBAAwB,OACtC,OAAO,MAAMJ,EAAM,KAAKV,EAAWc,EAAKE,CAAI,EAE5C,MAAMrB,GAAG,UAAUkB,EAAUC,CAAG,EAAGG,CAAU,EAC7C,MAEJ,CACA,MAAMf,GAAQF,EAAWiB,CAAU,CAErC,CAEA,eAAeC,EAASJ,EAA2B,CACjD,GAAI,CACF,IAAIK,EAEJ,OAAIL,GAAO,QACL,QAAQ,IAAI,sBAAwB,OAC/B,MAAMJ,EAAM,KAAKV,EAAWc,CAAG,EAEhC,MAAMN,GAAWK,EAAUC,CAAG,CAAC,GACrCK,EAAU,MAAMxB,GAAG,SAASkB,EAAUC,CAAG,EAAG,CAAE,SAAU,OAAQ,CAAC,EAC1D,KAAK,MAAMK,EAAS3B,GAAW,OAAO,GAFG,MAKlD2B,EAAU,MAAMd,GAAWL,CAAS,EAGnB,KAAK,MAAMmB,EAAS3B,GAAW,OAAO,EAE3D,MAAgB,CACd,OAAO,IACT,CACF,CAEA,eAAe4B,EAAWN,EAA2B,CACnD,GAAI,CACF,GAAIA,GAAO,QAAS,CAClB,GAAI,QAAQ,IAAI,sBAAwB,OACtC,OAAO,MAAMJ,EAAM,QAAQV,EAAWc,CAAG,EAEzC,MAAMnB,GAAG,OAAOkB,EAAUC,CAAG,CAAC,CAElC,MACE,MAAMP,GAAcP,CAAS,CAEjC,MAAgB,CACd,MACF,CACF,CAEA,IAAIqB,EAAQ,MAAMH,EAAS,OAAO,EAClC,OAAKG,IACHA,EAAQ5B,GAAc,EACtB,MAAMsB,EAAUM,EAAO,OAAO,GAGzB,CACL,MAAO,CACL,MAAAA,EACA,KAAM,CACJ,IAAK,MAAOC,EAAMC,IAAQ,CACxB,IAAMP,EAAO,CAAC,EACd,aAAM,QAAQ,IACZO,EAAI,IAAI,MAAOC,GAAO,CACpB,IAAIC,EAAQ,MAAMP,EAAS,GAAGI,CAAI,IAAIE,CAAE,EAAE,EACtCF,IAAS,sBAAwBG,IACnCA,EAAQ/B,GAAM,QAAQ,oBAAoB,WAAW+B,CAAK,GAG5DT,EAAKQ,CAAE,EAAIC,CACb,CAAC,CACH,EACOT,CACT,EACA,IAAK,MAAOA,GAAS,CACnB,IAAMU,EAAQ,CAAC,EACf,QAAWC,KAAYX,EACrB,QAAWQ,KAAMR,EAAKW,CAAQ,EAAG,CAC/B,IAAMF,EAAQT,EAAKW,CAAQ,EAAEH,CAAE,EACzBV,EAAM,GAAGa,CAAQ,IAAIH,CAAE,GAE7BE,EAAM,KAAKD,EAAQV,EAAUU,EAAOX,CAAG,EAAIM,EAAWN,CAAG,CAAC,CAC5D,CAEF,MAAM,QAAQ,IAAIY,CAAK,CACzB,CACF,CACF,EACA,UAAW,IACFX,EAAUM,EAAO,OAAO,CAEnC,CACF,CC/IA,OAAmD,cAAAO,GAAY,iBAAAC,GAAe,SAAAC,OAAgC,UAC9G,OAAS,cAAAC,OAAkB,kBAIpB,IAAMC,GAAN,KAAwB,CAC7B,YAA6BC,EAA8B,CAA9B,mBAAAA,EAE7B,KAAiB,OAAS,IAAIC,EAAO,mBAAmB,CAFI,CAI5D,MAAa,kBAAkBC,EAAsC,CACnE,GAAM,CAAC,CAAEC,CAAK,EAAI,MAAM,KAAK,cAAc,OAAOD,CAAQ,EAC1D,GAAIC,EAAO,CACT,KAAK,OAAO,MAAM,CAAC,yCAA0CA,GAAO,QAASA,GAAO,KAAK,CAAC,EAC1F,MACF,CAEA,IAAMC,EAAY,MAAOC,EAAWC,IAA8B,CAChE,IAAMC,EAAO,KAAK,UAAUF,EAAMV,GAAW,QAAQ,EAC/C,CAACa,EAAUL,CAAK,EAAI,MAAM,KAAK,cAAc,MAAMD,EAAUI,EAAK,CACtE,KAAMC,CACR,CAAC,EACD,GAAI,CAAAJ,EAIJ,OAAOK,CACT,EAEMC,EAAW,MAAOH,GAA8B,CACpD,GAAM,CAACE,EAAUL,CAAK,EAAI,MAAM,KAAK,cAAc,KAAKD,EAAUI,CAAG,EACrE,GAAI,CAAAH,GAIAL,GAAWU,GAAU,IAAI,EAC3B,OAAO,KAAK,MAAM,KAAK,UAAUA,EAAS,IAAI,EAAGb,GAAW,OAAO,CAEvE,EAEMe,EAAa,MAAOJ,GAAgB,CACxC,GAAM,CAACE,EAAUL,CAAK,EAAI,MAAM,KAAK,cAAc,OAAOD,EAAUI,CAAG,EACvE,GAAI,CAAAH,EAKJ,OAAOK,CACT,EAEMG,EAA8B,MAAMF,EAAS,OAAO,GAAMb,GAAc,EAE9E,MAAO,CACL,MAAO,CACL,MAAAe,EACA,KAAM,CACJ,IAAK,MAAOC,EAAMC,IAAkB,CAGlC,IAAMR,EAAiD,CAAC,EACxD,aAAM,QAAQ,IACZQ,EAAI,IAAI,MAAOC,GAAO,CACpB,IAAIC,EAAQ,MAAMN,EAAS,GAAGG,CAAI,IAAIE,CAAE,EAAE,EACtCF,IAAS,sBAAwBG,IACnCA,EAAQlB,GAAM,QAAQ,oBAAoB,WAAWkB,CAAK,GAG5DV,EAAKS,CAAE,EAAIC,CACb,CAAC,CACH,EAEOV,CACT,EACA,IAAK,MAAOA,GAAc,CACxB,IAAMW,EAAyB,CAAC,EAChC,QAAWC,KAAYZ,EACrB,QAAWS,KAAMT,EAAKY,CAAQ,EAAG,CAC/B,IAAMF,EAAQV,EAAKY,CAAQ,EAAEH,CAAE,EACzBR,EAAM,GAAGW,CAAQ,IAAIH,CAAE,GAC7BE,EAAM,KAAKD,EAAQ,MAAMX,EAAUW,EAAOT,CAAG,EAAI,MAAMI,EAAWJ,CAAG,CAAC,CACxE,CAGF,MAAM,QAAQ,IAAIU,CAAK,CACzB,CACF,CACF,EACA,UAAW,SACF,MAAMZ,EAAUO,EAAO,OAAO,CAEzC,CACF,CACF,EChIA,OAAmD,iBAAAO,GAAe,SAAAC,OAAgC,UAElG,eAAsBC,GACpBC,EACAC,EAIC,CACD,IAAMC,EAAS,IAAIC,EAAO,8BAA8B,EAElDC,EAAY,MAAOC,EAAWC,IAA8B,CAChE,GAAI,CACF,OAAO,MAAML,EAAM,KAAKD,EAAcM,EAAKD,CAAI,CACjD,OAASE,EAAO,CACd,OAAOL,EAAO,MAAM,CAAE,WAAY,YAAa,MAAAK,CAAM,CAAC,CACxD,CACF,EAEMC,EAAW,MAAOF,GAA8B,CACpD,GAAI,CACF,OAAO,MAAML,EAAM,KAAKD,EAAcM,CAAG,CAC3C,OAASC,EAAO,CACdL,EAAO,MAAM,CAAE,WAAY,WAAY,MAAAK,CAAM,CAAC,EAC9C,MACF,CACF,EAEME,EAAa,MAAOH,GAAgB,CACxC,GAAI,CACF,OAAO,MAAML,EAAM,QAAQD,EAAcM,CAAG,CAC9C,OAASC,EAAO,CACdL,EAAO,MAAM,CAAE,SAAU,aAAc,MAAAK,CAAM,CAAC,CAChD,CACF,EAEMG,EAA8B,MAAMF,EAAS,OAAO,GAAMX,GAAc,EAE9E,MAAO,CACL,MAAO,CACL,MAAAa,EACA,KAAM,CACJ,IAAK,MAAOC,EAAMC,IAAkB,CAGlC,IAAMP,EAAiD,CAAC,EACxD,aAAM,QAAQ,IACZO,EAAI,IAAI,MAAOC,GAAO,CACpB,IAAIC,EAAQ,MAAMN,EAAS,GAAGG,CAAI,IAAIE,CAAE,EAAE,EACtCF,IAAS,sBAAwBG,IACnCA,EAAQhB,GAAM,QAAQ,oBAAoB,WAAWgB,CAAK,GAG5DT,EAAKQ,CAAE,EAAIC,CACb,CAAC,CACH,EAEOT,CACT,EACA,IAAK,MAAOA,GAAc,CACxB,IAAMU,EAAyB,CAAC,EAChC,QAAWC,KAAYX,EACrB,QAAWQ,KAAMR,EAAKW,CAAQ,EAAG,CAC/B,IAAMF,EAAQT,EAAKW,CAAQ,EAAEH,CAAE,EACzBP,EAAM,GAAGU,CAAQ,IAAIH,CAAE,GAC7BE,EAAM,KAAKD,EAAQ,MAAMV,EAAUU,EAAOR,CAAG,EAAI,MAAMG,EAAWH,CAAG,CAAC,CACxE,CAGF,MAAM,QAAQ,IAAIS,CAAK,CACzB,CACF,CACF,EACA,UAAW,SACF,MAAMX,EAAUM,EAAO,OAAO,CAEzC,CACF,CLQA,OAAOO,OAAW,QAClB,OAAOC,IAGL,cAAAC,GAKA,SAAAC,GACA,oBAAAC,GACA,wBAAAC,GACA,6BAAAC,GACA,gCAAAC,GACA,kCAAAC,GACA,kBAAAC,GACA,aAAAC,GAEA,kBAAAC,GACA,cAAAC,GACA,mBAAAC,GACA,aAAAC,GACA,+BAAAC,GAKA,yBAAAC,GACA,SAAAC,OAQK,UAGP,OAAS,SAAAC,OAAa,gBACtB,OAAS,WAAAC,GAAS,YAAAC,GAAU,SAAAC,OAAa,kBACzC,OAAS,eAAAC,OAAmB,SAE5B,OAAOC,OAAY,gBACnB,OAAOC,OAAc,YACrB,OAAS,gBAAAC,OAAoB,KAC7B,OAAOC,OAAU,OACjB,OAAOC,OAAe,aACtB,OAAOC,OAAe,aACtB,OAAOC,OAAU,YACjB,OAAS,WAAAC,OAAe,KACxB,OAAS,QAAAC,OAAY,OACrB,OAAOC,OAAO,OACd,OAAOC,OAAwC,SAC/C,OAAOC,OAAoB,kBAC3B,OAAOC,OAAW,QAClB,OAAS,eAAAC,GAAa,YAAAC,OAAgB,SM9ItC,OAAS,MAAAC,OAAkB,mBAI3B,IAAIC,GAA8C,QAErCC,GAAuB,MAClCC,EACAC,EACAC,EACAC,IACG,CACHL,GAA2BI,GAAU,QAErC,IAAME,EAA6DP,GAAG,qCAAsC,CAC1G,WAAY,CAAC,WAAW,EACxB,KAAM,IAAIG,CAAY,YACxB,CAAC,EAED,OAAAI,EAAO,GAAG,UAAW,IAAM,CACrBD,GAAQ,QAAQ,IAAI,yBAA0BC,EAAO,EAAE,EAE3DA,EAAO,KACL,OACAH,EAAa,UAAU,MAAM,GAC7BA,EAAa,UAAU,MAAM,QAC7BH,EACF,CACF,CAAC,EAEDM,EAAO,GAAG,aAAc,IAAM,CACxBD,GAAQ,QAAQ,IAAI,yBAAyB,CACnD,CAAC,EAEDC,EAAO,GAAG,gBAAkBC,GAAU,CAChCD,EAAO,OACLD,GACF,QAAQ,IACN,kGACAE,CACF,EAEEF,GAAQ,QAAQ,IAAI,gCAAiCE,EAAM,OAAO,CAE1E,CAAC,EAEDD,EAAO,GAAG,aAAc,MAAOE,EAAKC,IAAa,CAC/C,GAAI,CACF,IAAMC,EAAgB,MAAMP,EAAa,WAAWK,CAAG,EAEvDC,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,0CAA2CK,EAAUF,CAAG,CAClF,OAASD,EAAO,CACVF,GAAQ,QAAQ,MAAM,wCAAyCE,CAAK,CAC1E,CACF,CAAC,EAEDD,EAAO,GAAG,oBAAqB,MAAOE,EAAKG,EAAMC,EAAWH,IAAa,CACvE,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,kBAAkBK,EAAKG,EAAMC,CAAS,EAE1EH,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,iDAAkDK,CAAQ,CACpF,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,+CAAgDE,CAAK,CACjF,CACF,CAAC,EAEDD,EAAO,GAAG,iBAAkB,MAAOO,EAAMC,EAAOL,IAAa,CAC3D,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,eAAeU,EAAMC,CAAK,EAE9DL,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,8CAA+CK,CAAQ,CACjF,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,4CAA6CE,CAAK,CAC9E,CACF,CAAC,EAEDD,EAAO,GAAG,yBAA0B,MAAOO,EAAME,EAASC,EAAYP,IAAa,CACjF,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,uBAAuBU,EAAME,EAASC,CAAU,EAEpFP,EAASC,EAAU,EAAI,EAEnBL,GAAQ,QAAQ,IAAI,sDAAuDK,CAAQ,CACzF,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,oDAAqDE,CAAK,CACtF,CACF,CAAC,EAEDD,EAAO,GAAG,kBAAmB,MAAOO,EAAMI,EAAUC,EAAmBT,IAAa,CAClF,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,gBAAgBU,EAAMI,EAAUC,CAAiB,EAErFT,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,+CAAgDK,CAAQ,CAClF,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,6CAA8CE,CAAK,CAC/E,CACF,CAAC,EAEDD,EAAO,GAAG,qBAAsB,MAAOG,GAAa,CAClD,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,mBAAmB,EAEvDM,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,kDAAmDK,CAAQ,CACrF,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,gDAAiDE,CAAK,CAClF,CACF,CAAC,EAEDD,EAAO,GAAG,WAAY,MAAOa,EAAQV,IAAa,CAChD,GAAI,CACF,QAAQ,IAAI,WAAY,KAAK,UAAUU,CAAM,CAAC,EAC9C,IAAMT,EAAW,MAAMP,EAAa,SAASgB,CAAM,EAEnDV,EAAS,EAAI,EAETJ,GAAQ,QAAQ,IAAI,wCAAyCK,CAAQ,CAC3E,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,sCAAuCE,CAAK,CACxE,CACF,CAAC,EAEDD,EAAO,GAAG,kCAAmC,MAAOE,EAAKG,EAAMS,EAAYX,IAAa,CACtF,GAAI,CACF,IAAMC,EAAW,MAAMP,EAAa,iBAAiB,eAAe,CAClE,IAAKK,EACL,KAAMG,EACN,WAAYS,CACd,CAAC,EAEDX,EAASC,CAAQ,EAEbL,GAAQ,QAAQ,IAAI,+DAAgEK,CAAQ,CAClG,OAASH,EAAO,CACVF,GAAQ,QAAQ,MAAM,6DAA8DE,CAAK,CAC/F,CACF,CAAC,EAGDJ,EAAa,GAAG,GAAG,oBAAsBkB,GAAqC,CAC5E,GAAM,CAAE,WAAAC,CAAW,EAAID,EAEnBC,IACFtB,GAA2BsB,EAC3BhB,EACG,QAAQ,GAAI,EACZ,KACC,2BACAH,EAAa,UAAU,MAAM,GAC7BA,EAAa,UAAU,MAAM,QAC7BmB,CACF,GAGAD,EAAO,IACTf,EAAO,QAAQ,GAAI,EAAE,KAAK,uBAAwBe,EAAO,EAAE,CAE/D,CAAC,EAEDlB,EAAa,GAAG,GAAG,UAAYoB,GAAW,CACpClB,GAAQ,QAAQ,IAAI,uBAAuB,EAC/CC,EAAO,SAAS,QAAQ,GAAI,EAAE,KAAK,UAAWiB,CAAM,CACtD,CAAC,EAEDpB,EAAa,GAAG,GAAG,oBAAsBoB,GAAW,CAC9ClB,GAAQ,QAAQ,IAAI,2BAA2B,EACnDC,EAAO,SAAS,QAAQ,GAAI,EAAE,KAAK,oBAAqBiB,CAAM,CAChE,CAAC,EAEMjB,CACT,ENhCA,IAAMkB,GAAqB,IAAIC,GAAa,IAAIC,GAAYC,EAAe,QAAQ,EAAE,UAAU,CAAC,EAGhG,eAAeC,GAAiBC,EAAoD,CAClF,IAAMC,GAAoB,KAAM,QAAO,cAAc,GAAG,QAClDC,EAAY,MAAMD,EAAiB,CAAE,OAAQ,MAAO,CAAC,EAEvDE,EACAC,EAEJ,GAAI,OAAO,SAASJ,CAAK,EACvBG,EAAWH,EAAM,OACjBI,EAAY,MAAOC,EAAcC,IACxBN,EAAM,MAAMM,EAAQA,EAASD,CAAI,UAEjC,OAAOL,GAAU,SAAU,CACpC,IAAMO,EAAK,KAAM,QAAO,IAAI,EAE5BJ,GADa,MAAMI,EAAG,SAAS,KAAKP,CAAK,GACzB,KAChB,IAAMQ,EAAK,MAAMD,EAAG,SAAS,KAAKP,EAAO,GAAG,EAE5CI,EAAY,MAAOC,EAAcC,IAAoC,CACnE,IAAMG,EAAS,OAAO,MAAMJ,CAAI,EAChC,aAAMG,EAAG,KAAKC,EAAQ,EAAGJ,EAAMC,CAAM,EAC9BG,CACT,EAEA,GAAI,CACF,IAAMC,EAAS,MAAMR,EAAU,YAAY,IAAMC,EAAUC,CAAS,EAI9DO,EAHa,KAAK,MAAMD,CAAM,EAEJ,MAAM,MAAM,KAAME,GAAWA,EAAE,OAAO,IAAM,SAAS,EACvD,SAE9B,OAAO,KAAK,MAAM,WAAWD,CAAQ,CAAC,CACxC,QAAE,CACA,MAAMH,EAAG,MAAM,CACjB,CACF,SAAWR,aAAiBa,GAAU,CACpC,IAAMC,EAAmB,CAAC,EAC1B,cAAiBC,KAASf,EACxBc,EAAO,KAAKC,CAAK,EAEnB,IAAMC,EAAO,OAAO,OAAOF,CAAM,EACjCX,EAAWa,EAAK,OAEhBZ,EAAY,MAAOC,EAAcC,IACxBU,EAAK,MAAMV,EAAQA,EAASD,CAAI,CAE3C,KACE,OAAM,IAAI,MAAM,kCAA+B,EAGjD,IAAMK,EAAS,MAAMR,EAAU,YAAY,IAAMC,EAAUC,CAAS,EAI9DO,EAHa,KAAK,MAAMD,CAAM,EAEJ,MAAM,MAAM,KAAME,GAAWA,EAAE,OAAO,IAAM,SAAS,EACvD,SAE9B,OAAO,KAAK,MAAM,WAAWD,CAAQ,CAAC,CACxC,CAEO,IAAMM,GAAN,cAAoCC,EAAsB,CAC/D,YACkBpB,EACAqB,EACAC,EACAC,EACAC,EACAC,EACCC,EACjB,CACA,MAAM1B,EAAeqB,EAAcC,EAAkBE,CAAa,EARlD,mBAAAxB,EACA,kBAAAqB,EACA,sBAAAC,EACA,WAAAC,EACA,mBAAAC,EACA,kBAAAC,EACC,mBAAAC,EASnB,KAAiB,qBAAmC,IAAIC,GACxD,KAAiB,iBAA+B,IAAIA,GACpD,KAAQ,WAAa,GACrB,KAAQ,WAAa,KAAK,cAAc,IAAS,KAAK,EAAE,QAExD,KAAO,gBAAsC,CAAE,MAAO,OAAQ,EAogB9D,KAAiB,WAAa,CAC5B,eAAgB,MAAOC,GAAkB,CACvC,IAAMC,EAAkB,MAAM,KAAK,iBAAiB,KAAK,SAAS,CAChE,MAAO,CAAE,WAAY,KAAK,UAAW,EACrC,OAAQ,CAAE,UAAW,EAAK,CAC5B,CAAC,EAEKC,EAAoB,IAAI,IAAID,EAAgB,IAAKE,GAASA,EAAK,SAAS,CAAC,EAEzEC,EAAgBJ,EACnB,OAAQG,GAAS,CAACD,GAAmB,IAAIC,EAAK,EAAE,CAAC,EACjD,IAAKA,IAAU,CACd,UAAWA,EAAK,GAChB,WAAY,KAAK,WACjB,KAAMA,EAAK,KACX,eAAgBA,EAAK,cAAgB,OAAYA,EAAK,YAAc,CACtE,EAAE,EAEJ,KAAK,+BAAqCC,CAAa,EAEnDA,EAAc,OAAS,GACrB,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,OACzD,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAC1C,KAAMA,EACN,eAAgB,EAClB,CAAC,CAEP,EAEA,eAAgB,MACdJ,GAOG,CACH,IAAMK,EAAWL,EAAM,IAAKG,IACnB,CAAE,UAAWA,EAAK,GAAI,WAAY,KAAK,UAAW,EAC1D,EAED,KAAK,+BAAqCE,CAAQ,EAElD,QAAWF,KAAQH,EACjB,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAC1C,MAAO,CACL,WAAY,KAAK,WACjB,UAAWG,EAAK,GAChB,KAAMA,EAAK,IACb,EACA,KAAM,CAAE,UAAWA,EAAK,EAAG,CAC7B,CAAC,CAEL,EAEA,eAAgB,MAAOH,GAAoB,CACzCA,EAAM,QACJ,MAAOG,GACL,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAC1C,MAAO,CAAE,WAAY,KAAK,WAAY,UAAWA,CAAK,CACxD,CAAC,CACL,EAEA,KAAK,+BAAqC,CAAC,GAAGH,CAAK,CAAC,CACtD,CACF,EAEA,KAAiB,cAAgB,CAC/B,kBAAmB,MAAOM,GAAwB,CAChD,GAAI,CACF,IAAMC,EAAmBD,EAAS,IAAKE,IAAa,CAClD,UAAWA,EAAQ,GACnB,SAAUA,GAAS,MAAQA,GAAS,cAAgBA,EAAQ,GAAG,MAAM,GAAG,EAAE,CAAC,EAC3E,cAAe,KACf,WAAY,KAAK,UACnB,EAAE,EAEF,GAAID,EAAY,OAAS,EAAG,CAC1B,KAAK,kCAAwCA,CAAW,EAEpD,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,UACzD,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,KAAMA,EACN,eAAgB,EAClB,CAAC,EAEH,IAAME,EAAgBF,EAAY,OAAQG,GAAMA,EAAE,UAAU,SAAS,aAAa,CAAC,EAC/ED,GACF,MAAME,GAAoBF,EAAc,IAAKC,IAAO,CAAE,UAAWA,EAAE,SAAU,EAAE,CAAC,CAEpF,CAGE,KAAK,cAAc,IAAc,UAAU,EAAE,SAC7C,KAAK,eAAe,SACpB,KAAK,cAAc,gBACnBH,EAAY,SAEZ,KAAK,gBAAgB,mBACnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,SAAS,EAAG,EACjEA,CACF,EACAK,EAAe,sBACb,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,SAAS,EAAG,EACjE,KAAK,aACP,GAGF,IAAMC,EAAkB,MAAM,QAAQ,IACpCP,EAAS,IAAI,MAAOE,IAAa,CAC/B,UAAWA,EAAQ,GACnB,SAAUA,GAAS,MAAQA,GAAS,cAAgBA,EAAQ,GAAG,MAAM,GAAG,EAAE,CAAC,EAC3E,eAAgB,MAAM,KAAK,eAAeA,EAAQ,EAAE,GAAG,kBACvD,WAAY,KAAK,UACnB,EAAE,CACJ,EAEA,GAAIK,EAAgB,OAAS,EAAG,CAC9B,IAAMJ,EAAgBI,EAAgB,OAAQH,GAAMA,EAAE,UAAU,SAAS,aAAa,CAAC,EACnFD,GACF,MAAME,GAAoBF,EAAc,IAAKC,IAAO,CAAE,UAAWA,EAAE,SAAU,EAAE,CAAC,EAGlF,KAAK,kCAAwCG,CAAe,EAC5D,MAAM,QAAQ,IACZA,EAAgB,IAAI,MAAOL,GAAY,CACrC,IAAMM,EAAS,KAAK,iBAAiB,QAAQ,WAAW,CACtD,MAAO,CAAE,UAAWN,EAAQ,UAAW,WAAY,KAAK,UAAW,EACnE,KAAM,CACJ,cAAeA,EAAQ,aACzB,CACF,CAAC,EAED,GAAI,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,QAAS,CACvF,IAAMO,EAAW,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,SAAS,EAAG,EAE5EC,EAAkB,MAAM,KAAK,gBAAgB,YACjDD,EACAP,EAAQ,UAAU,MAAM,GAAG,EAAE,CAAC,CAChC,EAEA,GAAI,CAACQ,EACH,OAGF,KAAK,gBAAgB,cAAcD,EAAUC,EAAgB,GAAI,CAC/D,KAAMR,EAAQ,SACd,WAAYA,EAAQ,aACtB,CAAC,CACH,CAEA,OAAOM,CACT,CAAC,CACH,CACF,CACF,OAASG,EAAO,CACd,QAAQ,MAAMA,CAAK,EACnB,KAAK,OAAO,MAAM,UAAUA,EAAM,OAAO,EAAE,CAC7C,CACF,EAEA,kBAAmB,MAAOX,GAAiC,CACzD,IAAMC,EAKA,CAAC,EACP,cAAiBC,KAAWF,EAC1BC,EAAY,KAAK,CACf,UAAWC,EAAQ,GACnB,SAAUA,GAAS,MAAQA,GAAS,aACpC,eAAgB,MAAM,KAAK,eAAeA,EAAQ,EAAE,GAAG,kBACvD,WAAY,KAAK,UACnB,CAAC,EAGH,KAAK,kCAAwCD,CAAW,EAExD,IAAMW,EAAqBX,EAAY,IAAKC,GAC1C,KAAK,iBAAiB,QAAQ,OAAO,CACnC,MAAO,CAAE,qBAAsB,CAAE,UAAWA,EAAQ,UAAW,WAAYA,EAAQ,UAAW,CAAE,EAChG,OAAQA,EACR,OAAQA,CACV,CAAC,CACH,EACA,MAAM,KAAK,iBAAiB,aAAaU,CAAkB,EAE3D,IAAMT,EAAgBF,EAAY,OAAQG,GAAMA,EAAE,UAAU,SAAS,aAAa,CAAC,EAC/ED,GACF,MAAME,GAAoBF,EAAc,IAAKC,IAAO,CAAE,UAAWA,EAAE,SAAU,EAAE,CAAC,CAEpF,CACF,EAEA,KAAiB,cAAgB,CAC/B,wBAAyB,MAAO,CAC9B,SAAAS,EACA,MAAAnB,EACA,SAAAM,EACA,SAAAc,EACA,SAAAC,EACA,SAAAC,CACF,IAOM,CACJ,GAAI,CACEA,IAAaC,GAAM,YAAY,gBAAgB,WACjD,QAAQ,IAAI,6CAA8CJ,CAAQ,EAEpE,QAAQ,IACN,QAAQnB,EAAM,MAAM,WAAWM,EAAS,MAAM,cAAca,EAAS,MAAM,qBAAqBC,CAAQ,eAAeC,CAAQ,aAAaC,CAAQ,EACtJ,EAEA,IAAMP,EAAwB,CAAE,aAAc,KAAK,SAAS,IAAK,EAE7DS,EAAyB,KAE7B,GAAI,KAAK,cAAc,IAAc,UAAU,EAAE,QAAS,CACxD,IAAMC,EAAoB,KAAK,eAAe,QAAU,KAAK,cAAc,wBAA0B,IAE/FC,EAAO,IAAI,KAOjB,GANAF,EAAyB,IAAI,KAAKE,EAAK,QAAQA,EAAK,QAAQ,EAAID,CAAiB,CAAC,EAAE,QAAQ,EAAI,IAM5F,EAJsB,KAAK,IAAI,GAAGN,EAAS,IAAKQ,GAAYA,EAAQ,gBAA0B,CAAC,GAEzDH,GAGxC,MAEJ,CAEA,IAAMnB,EAAuE,CAAC,EACxEuB,EAAkB,IAAI,KAExB,MAAM,KAAK,iBAAiB,KAAK,SAAS,CACxC,MAAO,CAAE,WAAY,KAAK,UAAW,CACvC,CAAC,GACD,IAAKzB,GAASA,EAAK,SAAS,CAChC,EAEA,QAAWA,KAAQH,EACb4B,GAAiB,IAAIzB,EAAK,EAAE,GAIhCE,EAAS,KAAK,CACZ,UAAWF,EAAK,GAChB,WAAY,KAAK,WACjB,KAAMA,EAAK,IACb,CAAC,EAGH,KAAK,4BAAkCE,CAAQ,EAE3C,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,UACzD,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAC1C,KAAMA,EACN,eAAgB,EAClB,CAAC,EAGH,IAAMwB,EAAqB,CAAC,EAEtBC,EAAkC,IAAI,IAC1ClB,EAAe,2BAA2BG,CAAQ,IAE9C,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC3C,OAAQ,CAAE,IAAK,EAAK,EACpB,MAAO,CAAE,WAAY,KAAK,UAAW,CACvC,CAAC,GACD,IAAKY,GACOA,EAAQ,IAIT,EACZ,CACL,EAEIf,EAAe,2BAA2BG,CAAQ,IAAM,MAC1DH,EAAe,2BAA2BG,EAAUe,CAAkB,EAGxE,QAAW,KAAKX,EACV,CAAC,EAAE,SAAW,CAAC,EAAE,KAAO,CAAC,EAAE,mBAI3BY,GAAK,OAAO,GAAG,gBAAgB,IACjC,EAAE,iBAAmB,EAAE,kBAAkB,SAAS,GAGhD,OAAK,cAAc,IAAc,UAAU,EAAE,SAC3C,EAAE,kBAAoBP,KAKxBM,GAAoB,IAAI,EAAE,IAAI,EAAE,GAIpCD,EAAY,KAAK,KAAK,eAAe,CAAC,CAAC,IAGzC,KAAK,+BAAqC,CAAC,GAAGA,CAAW,CAAC,EAEtD,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,UACzD,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,KAAMA,EACN,eAAgB,EAClB,CAAC,EAID,KAAK,cAAc,IAAc,UAAU,EAAE,SAC7C,KAAK,eAAe,SACpB,KAAK,cAAc,gBACnBA,EAAY,OAAS,GAErB,KAAK,gBAAgB,mBACnBd,EACAc,EAAY,OAAQG,GAAQ,CAACpB,EAAe,oBAAoBoB,EAAI,KAAK,SAAS,CAAC,CACrF,EAGF,MAAM,KAAK,cAAc,iBAAiB,EACxC1B,EACG,OAAQI,GAAM,CAAC,CAACA,EAAE,QAAU,CAAC,CAACA,EAAE,IAAI,EACpC,IAAKA,IAAO,CACX,GAAIA,EAAE,GACN,KAAMA,EAAE,MAAQA,EAAE,MACpB,EAAE,CACN,EAEAJ,EAAW,OACXa,EAAW,OACXnB,EAAQ,MACV,OAASiB,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,EAEA,kBAAmB,MACjB,CACE,SAAAE,EACA,KAAAc,EACA,UAAAC,CACF,EAKAC,IACG,CACH,GAAI,CACF,QAAWC,KAAYjB,EAAU,CAC/B,GAAIiB,EAAS,SAAS,cAAgBA,EAAS,SAAS,qBAAqB,KAAM,CACjF,IAAMC,EAAOD,EAAS,SAAS,cAAgBA,EAAS,SAAS,qBAAqB,KAEtF,GAAIC,GAAQ,sBAAwB,CAACH,EAAW,CAC9C,IAAMI,EAAY,MAAM,KAAK,OAAO,yBAAyBF,EAAS,GAAG,EAEzE,QAAQ,IAAI,oCAAqCE,CAAS,CAC5D,MAAWJ,GACT,QAAQ,IAAI,mCAAoCA,EAAWE,CAAQ,EAGrE,GAAIC,GAAQ,mBAAoB,CAC9B,IAAMC,EAAY,MAAM,KAAK,OAAO,oBAAoB,GAAIF,EAAS,IAAKA,EAAS,gBAAiB,EACpG,QAAQ,IAAI,gCAAiCE,CAAS,CACxD,CACF,CAEA,GAAIF,EAAS,SAAS,iBAAiB,eAAiBA,EAAS,SAAS,eAAe,QAAS,CAChG,IAAMG,EACJH,EAAS,SAAS,iBAAmBA,EAAS,SAAS,eAAe,SAAS,gBAC7EG,IACE,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,cACnB,gBACA,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,SAAS,EAAG,EACjEA,CACF,EAEF,MAAM,KAAK,kCAAwCA,CAAa,EAEpE,CAEA,GAAIH,EAAS,uBAAyBA,EAAS,sBAAsB,CAAC,IAAM,2BAA4B,CACtG,KAAK,OAAO,KAAK,sCAAsCA,EAAS,IAAI,EAAE,EAAE,EAExE,MAAM,KAAK,aAAa,IAAIA,EAAS,IAAI,GAAI,CAC3C,QAASA,EACT,MAAO,CACT,CAAC,EAED,QACF,CAsBA,IApBoB,MAAM,KAAK,aAAa,IAAIA,EAAS,IAAI,EAAE,GAAM,QAGnE,KAAK,OAAO,KAAK,wBAAwB,EACzC,MAAM,KAAK,aAAa,OAAOA,EAAS,IAAI,EAAE,GAI7CH,IAAS,UAAYA,IAAS,UAC/BG,EAAS,SAAS,iBAClBA,EAAS,SAAS,mBAClB,CAACA,GAAU,UAKTL,GAAK,OAAOK,EAAS,gBAAgB,IACvCA,EAAS,iBAAmBA,EAAS,kBAAkB,SAAS,GAG9DD,GAAU,cAAgBC,EAAS,IAAI,UAAU,SAAS,OAAO,GACnE,SAEF,IAAMI,EAAe,MAAM,KAAK,iBAAiB,KAAK,UAAU,CAC9D,MAAO,CAAE,WAAY,KAAK,WAAY,UAAWJ,EAAS,IAAI,SAAU,EACxE,OAAQ,CAAE,GAAI,GAAM,KAAM,EAAK,CACjC,CAAC,EAED,GACEI,GACAJ,EAAS,UACTI,EAAa,OAASJ,EAAS,UAC/BA,EAAS,SAAS,KAAK,EAAE,OAAS,IAElC,KAAK,+BAAqC,CAAC,CAAE,GAAGI,EAAc,KAAMJ,EAAS,QAAS,CAAC,CAAC,EACpF,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,OACzD,GAAI,CACF,MAAM,KAAK,iBAAiB,KAAK,OAAO,CACtC,MAAO,CAAE,GAAII,EAAa,EAAG,EAC7B,KAAM,CAAE,KAAMJ,EAAS,QAAS,CAClC,CAAC,CACH,MAAgB,CACd,QAAQ,IAAI,+BAA+BA,EAAS,IAAI,SAAS,MAAM,KAAK,UAAU,EAAE,CAC1F,CAIJ,IAAMK,EAAa,KAAK,eAAeL,CAAQ,EAEzCM,EACJN,GAAU,SAAS,cACnBA,GAAU,SAAS,cACnBA,GAAU,SAAS,gBACnBA,GAAU,SAAS,iBACnBA,GAAU,SAAS,4BACnBA,GAAU,SAAS,YACnBA,GAAU,SAAS,aAUrB,GARI,KAAK,cAAc,cAAgBA,EAAS,IAAI,KAAO,oBACzD,MAAM,KAAK,OAAO,aAAa,CAACA,EAAS,GAAG,CAAC,EAG3C,KAAK,cAAc,YAAcA,EAAS,IAAI,KAAO,oBACvD,MAAM,KAAK,OAAO,aAAa,CAACA,EAAS,GAAG,CAAC,EAI7C,KAAK,cAAc,IAAc,UAAU,EAAE,SAC7C,KAAK,eAAe,SACpB,CAACA,EAAS,IAAI,GAAG,SAAS,YAAY,EACtC,CACA,IAAMO,EAAsB,MAAM,KAAK,gBAAgB,gCAErD,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,SAAS,EAAG,EACjEF,CACF,EAEIE,GAAqB,KACvBF,EAAW,kBAAoBE,EAAoB,GACnDF,EAAW,gBAAkBE,EAAoB,SACjDF,EAAW,uBAAyBE,EAAoB,gBAE5D,CAEA,GAAI,KAAK,cAAc,IAAY,QAAQ,EAAE,SAAWP,GAAU,SAAS,aAAc,CACvF,IAAMQ,EAAwB,MAAM,KAAK,iBAAiB,cAAc,UAAU,CAChF,MAAO,CACL,WAAY,KAAK,UACnB,EACA,QAAS,CACP,YAAa,EACf,CACF,CAAC,EAEGA,GAAyBA,EAAsB,eAAiBA,EAAsB,eACxFH,EAAW,QAAQ,aAAe,MAAM,KAAK,cAAc,aACzDG,EAAsB,YACtBR,EACA,KAAK,OAAO,kBACd,EAEJ,CAEA,GAAI,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,YAAa,CACtE,IAAMJ,EAAM,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACrD,KAAMS,CACR,CAAC,EAmBD,GAjBIL,EAAS,IAAI,SAAW,GACtBJ,EAAI,SAAWa,GAAO,CAAC,GACzB,KAAK,OAAO,IAAI,4BAA4BT,EAAS,IAAI,SAAS,EAAE,EAEpE,MAAM,KAAK,yBAAyBA,EAAS,IAAI,SAAS,GACjDJ,EAAI,SAAWa,GAAO,CAAC,IAChC,KAAK,OAAO,IAAI,0BAA0BT,EAAS,IAAI,SAAS,MAAMJ,EAAI,gBAAgB,EAAE,EAE5F,MAAM,KAAK,gCAAgCI,EAAS,IAAI,UAAWJ,EAAI,gBAAgB,IAIzF,KAAK,OAAO,IAAI,0BAA0BI,EAAS,IAAI,SAAS,MAAMJ,EAAI,gBAAgB,EAAE,EAE5F,MAAM,KAAK,gCAAgCI,EAAS,IAAI,UAAWJ,EAAI,gBAAgB,GAGrFU,GACE,KAAK,cAAc,IAAQ,IAAI,EAAE,OACnC,GAAI,CACF,IAAMf,EAAeS,EACfU,EAAQ,MAAM,KAAK,0BACvB,CACE,QAAAnB,CACF,EACA,EACF,EAEM,CAAE,OAAA5C,EAAQ,UAAAgE,EAAW,SAAAC,EAAU,KAAArE,CAAK,EAAImE,EACxCG,EAAWC,GAAU,OAAOF,CAAQ,EAAE,SAAS,EAC/CG,EAAWC,GAAK,GAAG,KAAK,SAAS,EAAE,GAAIhB,EAAS,IAAI,UAAWW,EAAWC,CAAQ,EACxF,MAAgBK,GAAWF,EAAUpE,EAAQJ,EAAK,YAAY,IAAK,CACjE,eAAgBsE,CAClB,CAAC,EAED,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,KAAM,CACJ,UAAWjB,EAAI,GACf,WAAY,KAAK,WACjB,KAAMe,EACN,SAAUI,EACV,SAAAF,CACF,CACF,CAAC,EAED,IAAMK,EAAW,MAAgBC,GAAaJ,CAAQ,EAEtDV,EAAW,QAAQ,SAAWa,EAE9B,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CAAE,GAAItB,EAAI,EAAG,EACpB,KAAMS,CACR,CAAC,CACH,OAASxB,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,gCAAiCA,GAAO,QAASA,GAAO,KAAK,CAAC,CACnF,CAGN,CAEA,GAAI,KAAK,aAAa,SAChByB,GAAW,KAAK,aAAa,cAC/B,GAAI,CACF,IAAM3D,EAAS,MAAMyE,GACnB,CAAE,IAAKpB,EAAS,IAAK,QAASA,GAAU,OAAQ,EAChD,SACA,CAAC,EACD,CACE,OAAQqB,GAAE,CAAE,MAAO,OAAQ,CAAC,EAC5B,gBAAiB,KAAK,OAAO,kBAC/B,CACF,EAEAhB,EAAW,QAAQ,OAAS1D,EAASA,EAAO,SAAS,QAAQ,EAAI,MACnE,OAASkC,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,mCAAoCA,GAAO,OAAO,CAAC,CACxE,CAIJ,KAAK,OAAO,IAAIwB,CAAU,EAE1B,KAAK,kCAAwCA,CAAU,EAEvD,MAAMiB,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWjB,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,QACvB,CAAC,EAED,IAAMjC,EAAU,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC5D,MAAO,CAAE,UAAW4B,EAAS,IAAI,UAAW,WAAY,KAAK,UAAW,CAC1E,CAAC,EAEKuB,EAAkG,CACtG,UAAWvB,EAAS,IAAI,UACxB,SAAUA,EAAS,IAAI,QAAcA,EAAS,IAAI,QAAU,KAA5B,GAAwCA,EAAS,SACjF,eAAgB,MAAM,KAAK,eAAeA,EAAS,IAAI,SAAS,GAAG,kBACnE,WAAY,KAAK,UACnB,EAEA,GAAIuB,EAAW,YAAc,mBAI7B,IAAInD,EAAS,CACX,KAAK,kCAAwCmD,CAAU,EAEnD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,MAAM,KAAK,gBAAgB,gCAEzB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChEA,CACF,EAGE,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,UACzD,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CAAE,qBAAsB,CAAE,UAAWA,EAAW,UAAW,WAAYA,EAAW,UAAW,CAAE,EACtG,OAAQA,EACR,OAAQA,CACV,CAAC,EAEH,QACF,CAEA,KAAK,kCAAwCA,CAAU,EAEnD,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,UACzD,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CACL,qBAAsB,CACpB,UAAWA,EAAW,UACtB,WAAYA,EAAW,UACzB,CACF,EACA,OAAQA,EACR,OAAQA,CACV,CAAC,EAECA,EAAW,UAAU,SAAS,aAAa,GAC7C,MAAMhD,GAAoB,CAAC,CAAE,UAAWgD,EAAW,SAAU,CAAC,CAAC,EAEnE,CACF,OAAS1C,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,EAEA,kBAAmB,MAAO2C,EAAyBzB,IAAkB,CACnE,KAAK,OAAO,IAAI,mBAAmB,KAAK,UAAUyB,EAAM,OAAW,CAAC,CAAC,EAAE,EAEvE,IAAMC,EAAyC,CAAC,EAEhD,aAAiB,CAAE,IAAAC,EAAK,OAAAhD,CAAO,IAAK8C,EAClC,GAAI,EAAAzB,GAAU,cAAgB2B,EAAI,WAAW,SAAS,OAAO,KAIzDjB,GAAO/B,EAAO,MAAM,IAAM,QAAUgD,EAAI,QACtC,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,cACnB,gBACA,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CAAE,IAAKA,CAAI,CACb,EAIAA,EAAI,YAAc,oBAAoB,CACxC,IAAIC,EAEJ,GAAIjD,EAAO,YAAa,CACtB,IAAMkD,EAAe,MAAM,KAAK,WAAWF,CAAG,EAE1CE,IACFD,EAAcE,GAA+B,CAC3C,QAASD,EACT,YAAalD,EAAO,WACtB,CAAC,EAEL,CAEA,IAAMoD,EAAc,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAChE,MAAO,CACL,WAAY,KAAK,WACjB,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQJ,EAAI,EACd,CACF,CACF,CAAC,EAED,GAAI,CAACI,EACH,SAGF,GAAIpD,EAAO,UAAY,MAAQA,EAAO,SAAW,OAAW,CAC1D,KAAK,kCAAwCgD,CAAG,EAEhD,IAAMnC,EAAe,CACnB,UAAWuC,EAAY,GACvB,MAAOJ,EAAI,GACX,UAAWA,EAAI,UACf,OAAQA,EAAI,OACZ,YAAaA,GAAK,UAClB,OAAQ,UACR,WAAY,KAAK,UACnB,EAEI,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,gBACzD,MAAM,KAAK,iBAAiB,cAAc,OAAO,CAC/C,KAAMnC,CACR,CAAC,EAEC,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,gCAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CAAE,IAAKmC,CAAI,CACb,EAGF,QACF,MAAWhD,EAAO,SAAW,QAAa+B,GAAO/B,EAAO,MAAM,IAAMoD,EAAY,SAC1E,CAACJ,EAAI,QAAUA,EAAI,YACrBD,EAAiBC,EAAI,SAAS,EAAI,GAE9BjB,GAAO/B,EAAO,MAAM,IAAM+B,GAAO,CAAC,IACpC,KAAK,OAAO,IAAI,kBAAkBiB,EAAI,SAAS,MAAMI,EAAY,gBAAgB,EAAE,EACnF,KAAK,gCAAgCJ,EAAI,UAAWI,EAAY,gBAAgB,IAIpF,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CAAE,GAAIA,EAAY,EAAG,EAC5B,KAAM,CAAE,OAAQrB,GAAO/B,EAAO,MAAM,CAAE,CACxC,CAAC,GAGH,IAAMa,EAAe,CACnB,UAAWuC,EAAY,GACvB,MAAOJ,EAAI,GACX,UAAWA,EAAI,UACf,OAAQA,EAAI,OACZ,YAAaA,GAAK,UAClB,OAAQjB,GAAO/B,EAAO,MAAM,EAC5B,YAAAiD,EACA,WAAY,KAAK,UACnB,EAEA,KAAK,kCAAwCpC,CAAO,EAEhD,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,gBACzD,MAAM,KAAK,iBAAiB,cAAc,OAAO,CAC/C,KAAMA,CACR,CAAC,EAEH,IAAMa,EAAe,MAAM,KAAK,iBAAiB,KAAK,UAAU,CAC9D,MAAO,CAAE,WAAY,KAAK,WAAY,UAAWb,EAAQ,SAAU,CACrE,CAAC,EAED,GAAIa,EAAc,CAChB,IAAM2B,EAAe,CACnB,UAAWxC,EAAQ,UACnB,WAAY,KAAK,WACjB,KAAMA,EAAQ,UAAY,GAC1B,eAAgB,CAClB,EAGA,GADA,KAAK,+BAAqC,CAACwC,CAAY,CAAC,EACpD,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,MACzD,GAAI,CACF,MAAM,KAAK,iBAAiB,KAAK,OAAO,CACtC,MAAO,CACL,GAAI3B,EAAa,EACnB,EACA,KAAM2B,CACR,CAAC,CACH,MAAgB,CACd,QAAQ,IAAI,+BAA+BA,EAAa,SAAS,MAAMA,EAAa,UAAU,EAAE,CAClG,CAEJ,CACF,CAGF,MAAM,QAAQ,IAAI,OAAO,KAAKN,CAAgB,EAAE,IAAKO,GAAc,KAAK,yBAAyBA,CAAS,CAAC,CAAC,CAC9G,CACF,EAEA,KAAiB,aAAe,CAC9B,gBAAkBC,GAAmC,CACnD,KAAK,gCAAsCA,CAAa,CAC1D,EAEA,gBAAkBC,GAAkD,CAClE,KAAK,gCAAsCA,CAAmB,EAE9DA,EAAoB,QAASC,GAAU,CACjCC,GAAWD,EAAM,EAAE,GACrB,KAAK,yBAAyBA,EAAM,EAAE,CAE1C,CAAC,CACH,EAEA,4BAA8BE,GAIxB,CACJ,KAAK,4CAAkDA,CAAkB,EAEzE,KAAK,yBAAyBA,EAAmB,EAAE,CACrD,CACF,EAEA,KAAiB,YAAc,CAC5B,cAAqB,MAAOC,GAAiB,CAC5C,KAAK,8BAAoC,CAAE,GAAGA,EAAO,SAAU,KAAK,SAAS,IAAK,CAAC,EAMnF,IAAMC,GAJmB,MAAM,KAAK,iBAAiB,MAAM,SAAS,CAClE,MAAO,CAAE,WAAY,KAAK,UAAW,CACvC,CAAC,GAEmC,KAAMC,GAAMA,EAAE,UAAYF,EAAM,EAAE,EACtE,GAAIA,EAAM,SAAWC,EAAY,CAC/B,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,MAAO,CAAE,mBAAoB,CAAE,WAAY,KAAK,WAAY,QAASD,EAAM,EAAG,CAAE,CAClF,CAAC,EACD,KAAK,8BAAoC,CAAE,GAAGA,EAAO,SAAU,KAAK,SAAS,IAAK,CAAC,EACnF,MACF,CAEA,IAAMG,EAAYH,EAAM,KAAK,QAAQ,gBAAiB,EAAE,EACxD,IAAI,CAACC,GAAcA,EAAW,QAAU,GAAGD,EAAM,KAAK,IAAMC,EAAW,OAASE,IAC1E,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,OAAQ,CACjE,IAAMC,EAAY,CAChB,MAAO,GAAGJ,EAAM,KAAK,GACrB,KAAMG,EACN,QAASH,EAAM,GACf,aAAcA,EAAM,aACpB,WAAY,KAAK,UACnB,EACA,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,MAAO,CACL,mBAAoB,CAClB,WAAYI,EAAU,WACtB,QAASA,EAAU,OACrB,CACF,EACA,OAAQA,EACR,OAAQA,CACV,CAAC,CACH,CAEJ,EAEC,qBAA4B,MAC3BxF,EACAyF,IACG,CAIH,GAHA,KAAK,OAAO,KACV,wBAAwBzF,GAAM,aAAa,MAAM,KAAKA,EAAK,IAAI,IAAIA,GAAM,aAAa,IAAI,MAAMA,GAAM,aAAa,OAAO,EAC5H,EACIyF,EAAS,UAAU,MAAO,CAC5B,IAAMC,EAAa,KAAK,WAClBC,EAAS3F,EAAK,YAAY,OAC1B4F,EAAU5F,EAAK,YAAY,QAE7BA,EAAK,OAAS,MAChB,MAAM,KAAK,SAAS4F,EAASF,EAAYC,CAAM,EACtC3F,EAAK,OAAS,UACvB,MAAM,KAAK,YAAY4F,EAASF,EAAYC,CAAM,CAEtD,CAEA,KAAK,qCAA2C,CAC9C,SAAU,KAAK,SAAS,KACxB,KAAM3F,EAAK,KACX,OAAQA,EAAK,YAAY,OACzB,QAASA,EAAK,YAAY,OAC5B,CAAC,CACH,CACF,EA23CA,KAAiB,QAAU,IAAI,IAAwB,CACrD,CAAC,QAAS,aAAa,EACvB,CAAC,OAAQ,UAAU,EACnB,CAAC,MAAO,SAAS,EACjB,CAAC,OAAQ,UAAU,EACnB,CAAC,MAAO,cAAc,CACxB,CAAC,EAED,KAAiB,WAAa,IAAI,IAAqB,CACrD,CAAC,QAAS,OAAO,EACjB,CAAC,QAAS,OAAO,EACjB,CAAC,MAAO,KAAK,EACb,CAAC,OAAQ,MAAM,EACf,CAAC,SAAU,KAAK,CAClB,CAAC,EA84BD,KAAQ,sBAAwB,MAAO6F,GAAqB,CAC1D,GAAI,CAACX,GAAWW,CAAQ,EAAG,OAAO,KAElC,IAAMC,EAAY,KAAK,cAAc,IAAe,OAAO,EAE3D,GAAKA,GAAW,OAAO,SAAWA,GAAW,OAAO,MAAQ,IAAOA,GAAW,OAAO,QAAS,CAC5F,GAAI,MAAMnH,IAAoB,IAAIkH,CAAQ,EAAG,CAC3C,QAAQ,IAAI,4BAA4BA,CAAQ,EAAE,EAClD,IAAME,EAAO,MAAMpH,GAAmB,IAAIkH,CAAQ,EAElD,OAAI,KAAK,IAAI,EAAIE,EAAK,UAAY,MAChC,MAAM,KAAK,yBAAyBF,CAAQ,EAGvCE,EAAK,IACd,CAEA,eAAQ,IAAI,4BAA4BF,CAAQ,cAAc,EACvD,MAAM,KAAK,yBAAyBA,CAAQ,CACrD,CAEA,OAAO,MAAM,KAAK,UAAU,CAAE,SAAAA,CAAS,EAAG,OAAO,CACnD,EAjsHE,KAAK,SAAS,OAAS,CAAE,MAAO,CAAE,EAElC,KAAK,kBAAoB,IAAIG,GAAkB,KAAK,aAAa,CACnE,CAYA,IAAW,kBAAmB,CAC5B,OAAO,KAAK,eACd,CAEA,MAAa,gBAAiB,CAC5B,MAAM,KAAK,QAAQ,OAAO,qBAAuB,KAAK,YAAY,EAElE,KAAK,QAAQ,IAAI,MAAM,EAED,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAClE,MAAO,CAAE,UAAW,KAAK,UAAW,CACtC,CAAC,GAEC,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CACL,UAAW,KAAK,UAClB,CACF,CAAC,CAEL,CAEA,MAAa,gBAAiB,CAC5B,IAAIC,EAAc,KAAK,OAAO,MAAM,MAAQ,KAAK,OAAO,MAAM,aAC9D,GAAI,CAACA,EAAa,CAChB,IAAMjG,EAAO,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC1D,MAAO,CAAE,UAAW,KAAK,UAAW,CACtC,CAAC,EAED,GAAIA,EAAM,CACR,IAAMkG,EAAQ,KAAK,MAAM,KAAK,UAAUlG,EAAK,KAAK,EAAGmG,GAAW,OAAO,EACvEF,EAAcC,EAAM,IAAI,MAAQA,EAAM,IAAI,YAC5C,CACF,CAEA,OAAOD,CACT,CAEA,MAAa,kBAAmB,CAG9B,OAFe,MAAM,KAAK,OAAO,YAAY,KAAK,SAAS,IAAI,GAEjD,CAAC,GAAG,MACpB,CAEA,IAAW,mBAAoB,CAC7B,OAAO,KAAK,SAAS,iBACvB,CAEA,IAAW,QAAoB,CAC7B,MAAO,CACL,YAAa,KAAK,SAAS,QAAQ,YACnC,KAAM,KAAK,SAAS,QAAQ,KAC5B,OAAQ,KAAK,SAAS,QAAQ,OAC9B,MAAO,KAAK,SAAS,QAAQ,KAC/B,CACF,CAEA,MAAc,iBAAiB,CAAE,GAAAG,EAAI,WAAAC,EAAY,eAAAC,CAAe,EAA6B,CAC3F,GAAIF,EAAI,CACN,GAAI,KAAK,SAAS,OAAO,QAAU,KAAK,cAAc,IAAY,QAAQ,EAAE,MAC1E,YAAK,iCAAuC,CAC1C,QAAS,4CACT,WAAYG,GAAiB,UAC/B,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,+BAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CACE,QAAS,4CACT,WAAYA,GAAiB,UAC/B,CACF,EAGF,KAAK,oCAA0C,CAC7C,SAAU,KAAK,SAAS,KACxB,MAAO,UACP,aAAcA,GAAiB,iBAC/B,KAAM,KAAK,SAAS,KACpB,YAAa,MAAM,KAAK,eAAe,EACvC,kBAAmB,KAAK,SAAS,iBACnC,CAAC,EAED,KAAK,WAAa,GAEX,KAAK,aAAa,KAAK,gBAAiB,KAAK,SAAS,IAAI,EAGnE,KAAK,SAAS,OAAO,QAIrB,IAAMC,EAAqC,CACzC,OAAQ,EACR,MAAO,EACP,qBAAsB,IACtB,MAAO,CAAE,MAAO,UAAW,KANf,KAAK,cAAc,IAAY,QAAQ,EAAE,KAMd,CACzC,EAEI,KAAK,aACP,MAAMC,GAAM,GAAI,EAChB,KAAK,SAAS,OAAO,YAAc,MAAM,KAAK,OAAO,mBAAmB,KAAK,WAAW,GAExF,KAAK,SAAS,OAAO,YAAc,KAGrCC,GAAO,UAAUN,EAAII,EAAY,CAAC7E,EAAOgF,IAAW,CAClD,GAAIhF,EAAO,CACT,KAAK,OAAO,MAAM,0BAA4BA,EAAM,SAAS,CAAC,EAC9D,MACF,CAEA,KAAK,SAAS,OAAO,OAASgF,EAC9B,KAAK,SAAS,OAAO,KAAOP,EAE5B,KAAK,iCAAuC,CAC1C,OAAQ,CACN,SAAU,KAAK,SAAS,KACxB,YAAa,KAAK,SAAS,OAAO,YAClC,KAAMA,EACN,OAAAO,CACF,CACF,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,+BAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CACE,OAAQ,CACN,SAAU,KAAK,SAAS,KACxB,YAAa,KAAK,SAAS,OAAO,YAClC,KAAMP,EACN,OAAAO,CACF,CACF,CACF,CAEJ,CAAC,EAEDC,GAAe,SAASR,EAAI,CAAE,MAAO,EAAK,EAAIM,GAC5C,KAAK,OAAO,IACV;AAAA,cAAiB,KAAK,SAAS,IAAI,iBAAiB,KAAK,SAAS,OAAO,WAAW,kBAAkB,KAAK,SAAS,OAAO,KAAK;AAAA,EAC9HA,CACJ,CACF,EAEA,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,MAAO,CAAE,GAAI,KAAK,UAAW,EAC7B,KAAM,CACJ,iBAAkB,YACpB,CACF,CAAC,CACH,CASA,GAPIL,IACF,KAAK,gBAAkB,CACrB,MAAOA,EACP,aAAeC,GAAgB,OAAgB,QAAQ,YAAc,GACvE,GAGED,IAAe,QAAS,CAC1B,IAAMQ,EAAcP,GAAgB,OAAgB,QAAQ,WAEpC,CADI,CAACC,GAAiB,UAAWA,GAAiB,UAAW,IAAK,GAAG,EAChD,SAASM,CAAU,EAE9D,MAAM,KAAK,kBAAkB,KAAK,WAAW,GAE7C,KAAK,kCAAwC,CAC3C,SAAU,KAAK,SAAS,KACxB,OAAQ,SACR,gBAAiB,IAAI,KACrB,wBAAyBA,EACzB,oBAAqB,KAAK,UAAUP,CAAc,CACpD,CAAC,EAED,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,MAAO,CAAE,GAAI,KAAK,UAAW,EAC7B,KAAM,CACJ,iBAAkB,QAClB,gBAAiB,IAAI,KACrB,wBAAyBO,EACzB,oBAAqB,KAAK,UAAUP,CAAc,CACpD,CACF,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAC9E,KAAK,gBAAgB,gCAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CACE,SAAU,KAAK,SAAS,KACxB,OAAQ,QACV,CACF,EAGF,KAAK,aAAa,KAAK,kBAAmB,KAAK,SAAS,KAAM,OAAO,EACrE,KAAK,QAAQ,IAAI,MAAM,EACvB,KAAK,OAAO,IAAI,IAAI,MAAM,kBAAkB,CAAC,EAE7C,KAAK,oCAA0C,CAC7C,SAAU,KAAK,SAAS,KACxB,GAAG,KAAK,eACV,CAAC,EAEL,CAEA,GAAID,IAAe,OAAQ,CACzB,KAAK,SAAS,KAAO,KAAK,OAAO,KAAK,GAAG,QAAQ,OAAQ,EAAE,EAC3D,GAAI,CACF,IAAMS,EAAa,MAAM,KAAK,eAAe,KAAK,SAAS,IAAI,EAC/D,KAAK,SAAS,kBAAoBA,EAAW,iBAC/C,MAAgB,CACd,KAAK,SAAS,kBAAoB,IACpC,CACA,IAAMC,EAAgB,KAAK,SAAS,KAAK,MAAM,GAAG,EAAE,CAAC,EAAE,OAAO,GAAI,GAAG,EAC/DC,EAAgB,KAAK,SAAS,KACpC,KAAK,OAAO,KACV;AAAA;AAAA;AAAA,0MAGkC,QAAQ,QAAS,IAAI,CACzD,EACA,KAAK,OAAO,KACV;AAAA,gBACQD,CAAa;AAAA,gBACbC,CAAa;AAAA,OAEvB,EAEA,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,MAAO,CAAE,GAAI,KAAK,UAAW,EAC7B,KAAM,CACJ,SAAU,KAAK,SAAS,KACxB,YAAc,MAAM,KAAK,eAAe,EACxC,cAAe,KAAK,SAAS,kBAC7B,iBAAkB,MACpB,CACF,CAAC,EAEG,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,UAC9E,KAAK,gBAAgB,kCAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChE,CACE,SAAU,KAAK,SAAS,KACxB,OAAQ,MACV,CACF,EACA,KAAK,yBAAyB,GAGhC,KAAK,oCAA0C,CAC7C,SAAU,KAAK,SAAS,KACxB,KAAM,KAAK,SAAS,KACpB,YAAa,MAAM,KAAK,eAAe,EACvC,kBAAmB,KAAK,SAAS,kBACjC,GAAG,KAAK,eACV,CAAC,CACH,CAEIX,IAAe,cACjB,KAAK,oCAA0C,CAC7C,SAAU,KAAK,SAAS,KACxB,GAAG,KAAK,eACV,CAAC,CAEL,CAEA,MAAc,WAAW7B,EAAwByC,EAAO,GAAO,CAC7D,GAAI,CACF,IAAMC,EAAkB,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CACnE,MAAO,CACL,WAAY,KAAK,WACjB,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQ1C,EAAI,EACd,CACF,CACF,CAAC,EACD,GAAIyC,EACF,OAAOC,EAAe,CAAC,EAEzB,GAAIA,EAAe,CAAC,EAAE,SAAS,oBAAqB,CAClD,IAAMC,EAAsBD,EAAe,CAAC,EAAE,SAAS,oBAAoB,cAE3E,GAAI,OAAOC,GAAwB,SAUjC,MAPY,CACV,mBAAoB,CAClB,cAJkB,OAAO,KAAKA,EAAqB,QAAQ,CAK7D,EACA,oBAAqBD,EAAe,CAAC,EAAE,SAAS,mBAClD,CAIJ,CAEA,OAAOA,EAAe,CAAC,EAAE,OAC3B,MAAgB,CACd,MAAO,CAAE,aAAc,EAAG,CAC5B,CACF,CAEA,MAAc,iBAAkB,CAC9B,IAAME,EAAK,KAAK,cAAc,IAAc,UAAU,EAChD/G,EAAQ,KAAK,cAAc,IAAe,OAAO,EAIvD,GAFiB,KAAK,cAAc,IAAqB,UAAU,GAErD,QACZ,OAAO,MAAM,KAAK,kBAAkB,kBAAkB,KAAK,SAAS,EAAE,EAGxE,GAAIA,GAAO,MAAM,SAAWA,GAAO,MAAM,eACvC,YAAK,OAAO,KAAK,eAAe,EACzB,MAAMgH,GAA6B,KAAK,SAAS,GAAI,KAAK,KAAK,EAGxE,GAAID,EAAG,UAAU,SACf,OAAO,MAAME,GAA4B,KAAK,SAAS,GAAI,KAAK,KAAK,CAEzE,CAEA,MAAc,aAAaC,EAAoC,CAC7D,KAAK,SAAS,UAAY,MAAM,KAAK,gBAAgB,EAErD,IAAMC,EAAU,KAAK,cAAc,IAAwB,sBAAsB,EAE7EC,EAAiB,CAAC,EAEtB,GAAIF,GAAU,KAAK,YACjB,KAAK,YAAcA,EAEnB,KAAK,OAAO,KAAK,iBAAiBA,CAAM,EAAE,MACrC,CACL,IAAMG,EAAgC,CAACF,EAAQ,OAAQA,EAAQ,KAAMG,GAAQ,CAAC,EAC9EF,EAAiB,CAAE,QAAAC,CAAQ,EAE3B,KAAK,OAAO,KAAK,YAAYA,CAAO,EAAE,CACxC,CAEA,IAAIE,EACAC,EAEAL,EAAQ,SACVI,EAAUJ,EAAQ,QAAQ,MAAM,GAAG,EACnCK,EAAM,wBAAwBD,CAAO,KAGrCA,GADuB,MAAME,GAA0B,GAC9B,QACzBD,EAAM,oBAAoBD,CAAO,IAGnC,KAAK,OAAO,KAAKC,CAAG,EAEpB,KAAK,OAAO,KAAK,iBAAiB,KAAK,cAAc,YAAY,EAAE,EAEnE,IAAIE,EAEJ,GAAI,KAAK,YAAY,QAGnB,GAFA,KAAK,OAAO,KAAK,kBAAoB,KAAK,YAAY,IAAI,EAEtD,KAAK,YAAY,MAAM,SAAS,aAAa,EAC/C,GAAI,CAGF,IAAMC,GAFW,MAAMC,GAAM,IAAI,KAAK,YAAY,IAAI,GAChC,KACC,MAAM;AAAA,CAAM,EAC7BC,EAAO,KAAK,MAAM,KAAK,OAAO,EAAI,KAAK,MAAMF,EAAU,MAAM,CAAC,EAC9DG,EAAW,UAAYH,EAAUE,CAAI,EAC3CH,EAAU,CACR,MAAOK,GAAeD,CAAQ,EAC9B,WAAYC,GAAeD,CAAQ,CACrC,CACF,MAAgB,CACd,KAAK,WAAW,QAAU,EAC5B,MAEAJ,EAAU,CACR,MAAOK,GAAe,CACpB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,EACD,WAAYA,GAAe,CACzB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,CACH,EAIJ,IAAMC,EAAuC,CAC3C,GAAGN,EACH,QAAAH,EACA,OAAQzD,GAAE,CAAE,MAAO,KAAK,UAAW,CAAC,EACpC,kBAAmB,GACnB,KAAM,CACJ,MAAO,KAAK,SAAS,UAAU,MAAM,MACrC,KAAMmE,GAA4B,KAAK,SAAS,UAAU,MAAM,KAAMnE,GAAE,CAAE,MAAO,OAAQ,CAAC,CAAQ,CACpG,EACA,qBAAsB,KAAK,qBAC3B,+BAAgC,GAChC,WAAY,MAAOK,GAAS,MAAM,KAAK,WAAWA,CAAG,EACrD,GAAGiD,EACH,oBAAqB,KAAK,cAAc,aACxC,oBAAqB,IACrB,iBAAkB,EAClB,gBAAiB,GACjB,iBAAkB,IAClB,oBAAqB,IACrB,UAAW,KACX,cAAe,GACf,gBAAkBc,GAAQ,CACxB,IAAMC,EAAa,KAAK,cAAc,cAAgBtD,GAAWqD,CAAG,EAC9DE,EAAc,CAAC,KAAK,cAAc,YAAcC,GAAeH,CAAG,EAClEI,EAAeC,GAAgBL,CAAG,EAExC,OAAOC,GAAcC,GAAeE,CACtC,EACA,gBAAiB,KAAK,cAAc,gBACpC,yBAA2BjG,GAClB,KAAK,wBAAwBA,CAAG,EAEzC,oBAAqB,KAAK,sBAC1B,iBAAkB,KAAK,iBACvB,gBAAiB,CAAE,iBAAkB,GAAI,oBAAqB,GAAK,EACnE,0BAA0BL,EAAS,CACjC,OACEA,EAAQ,mBAAmB,SAAS,aAAa,WAAaJ,GAAM,QAAQ,YAAY,SAAS,eAEjGI,EAAU,KAAK,MAAM,KAAK,UAAUA,CAAO,CAAC,EAE5CA,EAAQ,kBAAkB,QAAQ,YAAY,SAAWJ,GAAM,QAAQ,YAAY,SAAS,eAG1FI,EAAQ,aAAa,UAAYJ,GAAM,QAAQ,YAAY,SAAS,eACtEI,EAAU,KAAK,MAAM,KAAK,UAAUA,CAAO,CAAC,EAE5CA,EAAQ,YAAY,SAAWJ,GAAM,QAAQ,YAAY,SAAS,eAG7DI,CACT,CACF,EAEA,YAAK,WAAa,GAElB,KAAK,OAASwG,GAAaR,CAAY,EAEnC,KAAK,cAAc,aAAe,KAAK,cAAc,YAAY,OAAS,GAC5ES,GAAqB,KAAK,cAAc,YAAa,KAAK,OAAQ,KAAK,iBAAiB,MAAc,EAAI,EAG5G,KAAK,aAAa,EAElB,KAAK,OAAO,GAAG,GAAG,UAAYC,GAAW,CACvC,QAAQ,IAAI,UAAWA,CAAM,EAC7B,IAAMC,EAAU,CACd,MAAO,UACP,OAAQD,CACV,EACA,KAAK,uBAA6BC,EAAS,GAAM,CAAC,WAAW,CAAC,CAChE,CAAC,EAED,KAAK,OAAO,GAAG,GAAG,oBAAsBD,GAAW,CACjD,QAAQ,IAAI,oBAAqBA,CAAM,EACvC,IAAMC,EAAU,CACd,MAAO,oBACP,OAAQD,CACV,EACA,KAAK,uBAA6BC,EAAS,GAAM,CAAC,WAAW,CAAC,CAChE,CAAC,EAED,KAAK,YAAczB,EAEZ,KAAK,MACd,CAEA,MAAa,kBAAkBA,EAAoC,CACjE,GAAI,CACF,YAAK,aAAa,EAClB,KAAK,aAAa,EAClB,KAAK,YAAY,EACjB,KAAK,UAAU,EAER,MAAM,KAAK,aAAaA,CAAM,CACvC,OAAS5F,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIsH,EAA6BtH,GAAO,SAAS,CAAC,CAC1D,CACF,CAEA,MAAa,kBAAsC,CACjD,GAAI,CACF,OAAO,MAAM,KAAK,aAAa,KAAK,WAAW,CACjD,OAASA,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIsH,EAA6BtH,GAAO,SAAS,CAAC,CAC1D,CACF,CAy4BQ,cAAe,CACrB,KAAK,OAAO,GAAG,QAAQ,MAAOuH,GAAW,CACvC,GAAI,CAAC,KAAK,WAAY,CACpB,IAAMzD,EAAW,KAAK,cAAc,IAAc,UAAU,EACtD5C,EAAW,MAAM,KAAK,aAAa,EAEzC,GAAIqG,EAAO,KAAM,CACf,IAAMC,EAAOD,EAAO,KAAK,CAAC,EAM1B,GAJIrG,GAAU,YAAcsG,EAAK,QAAU,SACzC,KAAK,OAAO,WAAWA,EAAK,GAAIA,EAAK,IAAI,EAGvCtG,GAAU,SAAS,KAAK,EAAE,OAAS,GAAKsG,EAAK,QAAU,QAAS,CAClE,IAAMzG,EAAM,MAAM,KAAK,OAAO,YAAYyG,EAAK,KAAM,CACnD,KAAMtG,EAAS,OACjB,CAAC,EAED,KAAK,OAAO,GAAG,KAAK,kBAAmB,CACrC,SAAU,CAACH,CAAG,EACd,KAAM,QACR,CAAC,CACH,CAEA,KAAK,uBAA6ByG,CAAI,CACxC,CAUA,GARID,EAAO,mBAAmB,GAC5B,KAAK,iBAAiBA,EAAO,mBAAmB,CAAC,EAG/CA,EAAO,cAAc,GACvB,KAAK,SAAS,UAAU,UAAU,EAGhCA,EAAO,uBAAuB,EAAG,CACnC,IAAMF,EAAUE,EAAO,uBAAuB,EAC9C,KAAK,cAAc,uBAAuB,EAAEF,CAAO,CACrD,CAEA,GAAIE,EAAO,iBAAiB,EAAG,CAC7B,IAAMF,EAAUE,EAAO,iBAAiB,EACxC,KAAK,cAAc,iBAAiB,EAAEF,EAASnG,CAAQ,CACzD,CAEA,GAAIqG,EAAO,iBAAiB,EAAG,CAC7B,IAAMF,EAAUE,EAAO,iBAAiB,EACxC,KAAK,cAAc,iBAAiB,EAAEF,EAASnG,CAAQ,CACzD,CAEA,GAAIqG,EAAO,wBAAwB,EAAG,CACpC,IAAMF,EAAUE,EAAO,wBAAwB,EACzCE,EAAwC,CAAC,EAE/C,QAAWC,KAASL,EACd,OAAOK,EAAM,IAAI,WAAc,UAAY,OAAOA,EAAM,QAAQ,eAAkB,WACpFD,EAAcC,EAAM,IAAI,SAAS,EAAIA,EAAM,QAAQ,eAIvD,MAAM,QAAQ,IACZ,OAAO,KAAKD,CAAa,EAAE,IAAI,MAAOtE,GACpC,KAAK,gCAAgCA,EAAWsE,EAActE,CAAS,CAAC,CAC1E,CACF,CACF,CAEA,GAAIoE,EAAO,iBAAiB,EAAG,CAC7B,IAAMF,EAAUE,EAAO,iBAAiB,EAExC,GAAIrG,GAAU,cAAgBmG,EAAQ,GAAG,SAAS,OAAO,EACvD,OAGF,KAAK,kCAAwCA,CAAO,CACtD,CAEA,GAAI,CAACnG,GAAU,aAAc,CAC3B,GAAIqG,EAAO,eAAe,EAAG,CAC3B,IAAMF,EAAUE,EAAO,eAAe,EACtC,KAAK,aAAa,eAAe,EAAEF,CAAO,CAC5C,CAEA,GAAIE,EAAO,eAAe,EAAG,CAC3B,IAAMF,EAAUE,EAAO,eAAe,EACtC,KAAK,aAAa,eAAe,EAAEF,CAAO,CAC5C,CAEA,GAAIE,EAAO,2BAA2B,EAAG,CACvC,IAAMF,EAAUE,EAAO,2BAA2B,EAClD,KAAK,aAAa,2BAA2B,EAAEF,CAAO,CACxD,CACF,CAEA,GAAIE,EAAO,cAAc,EAAG,CAC1B,IAAMF,EAAUE,EAAO,cAAc,EACrC,KAAK,WAAW,cAAc,EAAEF,CAAO,CACzC,CAEA,GAAIE,EAAO,cAAc,EAAG,CAC1B,IAAMF,EAAUE,EAAO,cAAc,EACrC,KAAK,WAAW,cAAc,EAAEF,CAAO,CACzC,CAEA,GAAIE,EAAO,cAAc,EAAG,CAC1B,IAAMF,EAAUE,EAAO,cAAc,EACrC,KAAK,WAAW,cAAc,EAAEF,CAAO,CACzC,CAEA,GAAIE,EAAO,iBAAiB,EAAG,CAC7B,IAAMF,EAAUE,EAAO,iBAAiB,EACxC,KAAK,cAAc,iBAAiB,EAAEF,CAAO,CAC/C,CAEA,GAAIE,EAAO,iBAAiB,EAAG,CAC7B,IAAMF,EAAUE,EAAO,iBAAiB,EACxC,KAAK,cAAc,iBAAiB,EAAEF,CAAO,CAC/C,CAEA,GAAIE,sBAAgC,EAAG,CACrC,IAAMF,EAAUE,sBAAgC,EAChD,KAAK,gCAAqC,EAAEF,EAASvD,CAAQ,EAC7D,MACF,CAEA,GAAIyD,eAAyB,EAAG,CAC9B,IAAMF,EAAUE,eAAyB,EACzC,KAAK,yBAA8B,EAAEF,CAAO,EAC5C,MACF,CACF,CACF,CAAC,CACH,CAEQ,wBAAwBtG,EAA6C,CAC3E,IAAMjB,EAAwB,CAAE,aAAc,KAAK,SAAS,IAAK,EAEjE,OACE,KAAK,cAAc,IAAc,UAAU,EAAE,SAC7C,KAAK,eAAe,SACpB,KAAK,cAAc,gBACnB,KAAK,mCAAmCiB,CAAG,IAEvCA,EAAI,aAAe,GACrB,KAAK,gBAAgB,2BAA2BjB,CAAQ,EAGtDiB,EAAI,WAAa,KACnB,WAAW,IAAM,CACf,KAAK,gBAAgB,sBAAsBjB,CAAQ,CACrD,EAAG,GAAK,GAIL,EACT,CAEQ,mCAAmCiB,EAA6C,CACtF,OACG,KAAK,cAAc,iBAAmBA,GAAK,WAAa,GACxD,CAAC,KAAK,cAAc,iBAAmBA,GAAK,WAAa,CAE9D,CAEA,MAAa,eAAe6E,EAAgB,CAC1C,IAAMgB,EAAMe,EAAU/B,CAAM,EAE5B,GAAI,CACF,IAAMgC,EAAoB,MAAM,KAAK,OAAO,kBAAkBhB,EAAK,OAAO,EAE1E,MAAO,CACL,KAAMA,EACN,kBAAAgB,CACF,CACF,MAAgB,CACd,MAAO,CACL,KAAMhB,EACN,kBAAmB,IACrB,CACF,CACF,CAEA,MAAa,UAAUhB,EAAgB,CACrC,IAAMgB,EAAMe,EAAU/B,CAAM,EAE5B,GAAI,CACF,MAAO,CACL,KAAMgB,EACN,QAAS,MAAM,KAAK,OAAO,YAAYA,CAAG,GAAG,CAAC,GAAG,MACnD,CACF,MAAgB,CACd,MAAO,CACL,KAAMA,EACN,OAAQ,IACV,CACF,CACF,CAEA,MAAa,aAAaiB,EAAsBjC,EAAiB,CAC/D,IAAMgB,EAAMhB,EAAS+B,EAAU/B,CAAM,EAAI,KAAK,QAAQ,MAAM,GAEtDkC,GAAc,MAAM,KAAK,eAAe,CAAE,QAAS,CAAClB,CAAG,CAAE,CAAC,IAAI,MAAM,EAE1E,GAAI,CAACkB,EAAW,OACd,MAAM,IAAIC,EAAoBD,CAAU,EAG1C,GAAI,CACF,GAAIlC,EAAQ,CACV,IAAMoC,GAAQ,MAAM,KAAK,eAAe,CAAE,QAAS,CAACpB,CAAG,CAAE,CAAC,IAAI,MAAM,EAC9DqB,EAAU,MAAM,KAAK,eAAeD,GAAM,GAAG,EAC7CpG,EAAS,MAAM,KAAK,UAAUoG,GAAM,GAAG,EACvCE,EAAW,MAAM,KAAK,qBAAqBF,GAAM,GAAG,EAE1D,MAAO,CACL,KAAMA,GAAM,KAAOpB,EACnB,KAAMoB,GAAM,KACZ,aAAcA,GAAM,OACpB,QAASC,GAAS,kBAClB,OAAQrG,GAAQ,OAChB,WAAYsG,EAAS,WACrB,MAAOA,GAAU,MACjB,YAAaA,GAAU,YACvB,QAASA,GAAU,SAAS,MAAM,CACpC,CACF,KAAO,CACL,IAAMC,EAAgBN,EAAe,CAACA,CAAY,EAAI,KAChDG,EAAiB,MAAMI,EAAU,aAAaD,CAAa,EAC3DD,EAAW,MAAM,KAAK,qBAAqBtB,CAAG,EAEpD,MAAO,CACL,KAAMA,EACN,KAAMoB,GAAM,YACZ,aAAc,GACd,QAASA,GAAM,cACf,OAAQA,GAAM,iBACd,WAAYE,EAAS,WACrB,MAAOA,GAAU,MACjB,YAAaA,GAAU,YACvB,QAASA,GAAU,SAAS,MAAM,CACpC,CACF,CACF,MAAgB,CACd,MAAO,CACL,KAAMtB,EACN,KAAM,KACN,QAAS,KACT,OAAQ,KACR,GAAI,KACJ,WAAY,EACd,CACF,CACF,CAEA,MAAa,UAAU,CAAE,OAAAhB,EAAQ,QAAAyC,EAAS,aAAAC,CAAa,EAAiB,CACtE,IAAM1B,EAAMe,EAAU/B,CAAM,EAE5B,GAAI,CACF,IAAM4B,EAAO,MAAM,KAAK,OAAO,UAAUZ,EAAKyB,CAAO,EACrD,kBAAW,IAAM,KAAK,OAAO,cAAcb,EAAK,GAAIA,EAAK,EAAE,EAAGc,EAAe,GAAI,EAE1Ed,CACT,OAASxH,EAAO,CACd,OAAOA,CACT,CACF,CAEA,MAAc,YACZuI,EACA7H,EACA8H,EACAC,EACAC,EACArH,EACAsH,EAEA,CACAJ,EAASA,EAAO,YAAY,EAE5B,IAAMK,EAAc,CAClB,OAAAF,CACF,EAeA,GAbInF,GAAWgF,CAAM,IACnBK,EAAO,uBAAyB,IAO9BD,IAAqBC,EAAO,oBAAsBD,GAElDtH,EAAWuH,EAAO,UAAYvH,EAC7BuH,EAAO,UAAY,OAASC,GAAY,EAAE,EAAE,SAAS,KAAK,EAAE,YAAY,EAEzEnI,EAAQ,gBAAoB,CAC9B,IAAMoI,EAAIC,GAA6BR,EAAQ7H,EAAS,CACtD,UAAW,IAAI,KACf,QAAS,KAAK,SAAS,KACvB,UAAAW,EACA,OAAAqH,CACF,CAAC,EACKM,EAAK,MAAM,KAAK,OAAO,aAAaT,EAAQ7H,EAAS,CAAE,UAAAW,CAAU,CAAC,EACxEyH,EAAE,IAAM,CACN,GAAIE,EACJ,UAAWT,EACX,YAAaU,GAAUV,CAAM,EAAIA,EAAS,OAC1C,OAAQ,EACV,EACA,OAAW,CAAC1F,EAAKqG,CAAK,IAAK,OAAO,QAAQJ,CAAC,GACrC,CAACI,IAAUC,GAAQD,CAAK,GAAKA,EAAM,UAAY,IACjD,OAAOJ,EAAEjG,CAAG,EAGhB,OAAOiG,CACT,CAEA,GACE,CAACpI,EAAQ,OACT,CAACA,EAAQ,MACT,CAACA,EAAQ,SACT,CAACA,EAAQ,cACT6H,IAAW,oBAEP7H,EAAQ,gBACV,OAAO,MAAM,KAAK,OAAO,YACvB6H,EACA,CACE,MAAO,CACL,KAAM7H,EAAQ,gBAAmB,KACjC,IAAKA,EAAQ,gBAAmB,GAClC,CACF,EACAkI,CACF,EAIJ,GAAIlI,EAAQ,aACV,OAAO,MAAM,KAAK,OAAO,YACvB6H,EACA,CACE,KAAM7H,EAAQ,aACd,SAAA8H,EACA,YAAaC,CACf,EACAG,CACF,EAGF,GAAI,CAAClI,EAAQ,OAAY,CAACA,EAAQ,MAAW,CAACA,EAAQ,SAAc6H,GAAU,mBAC5E,OAAO,MAAM,KAAK,OAAO,YACvBA,EACA,CACE,QAAS,CACP,IAAK,CAAE,UAAW,KAAK,SAAS,KAAM,OAAQ,EAAK,EACnD,QAAA7H,CACF,EACA,SAAA8H,CACF,EACAI,CACF,EAGF,GAAIL,IAAW,mBAAoB,CACjC,IAAIa,EACA1I,EAAQ,OAAU,OAAO,YAY3B0I,GAXiB,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC5D,MAAO,CACL,WAAY,KAAK,WACjB,UAAW,CACT,IAAK,CACH,SAAU,OACZ,CACF,CACF,CACF,CAAC,GAEkB,IAAK7J,GAAYA,EAAQ,SAAS,EAErD6J,EAAU1I,EAAQ,OAAU,OAAO,cAGrC,IAAM2I,EAAY,GAEZC,EAAU,MAAM,KAAK,CAAE,OAAQ,KAAK,KAAKF,EAAQ,OAASC,CAAS,CAAE,EAAG,CAACE,EAAGC,IAChFJ,EAAQ,MAAMI,EAAIH,EAAWG,EAAIH,EAAYA,CAAS,CACxD,EAEII,EAAuB,KAEvBC,EAEEC,EAAaL,EAAQ,MAAM,EAgBjC,OAdIK,IACFD,EAAe,MAAM,KAAK,OAAO,YAC/BnB,EACA7H,EAAQ,OAAU,QAClB,CACE,gBAAiBA,EAAQ,OAAU,OAAO,gBAC1C,KAAMA,EAAQ,OAAU,OAAO,KAC/B,cAAeiJ,CACjB,CACF,EAEAF,EAAQC,EAAa,IAAI,IAGvBJ,EAAQ,SAAW,GAEvB,MAAM,QAAQ,WACZA,EAAQ,IAAI,MAAOM,GACG,MAAM,KAAK,OAAO,YACpCrB,EACA7H,EAAQ,OAAU,QAClB,CACE,gBAAiBA,EAAQ,OAAU,OAAO,gBAC1C,KAAMA,EAAQ,OAAU,OAAO,KAC/B,cAAekJ,EACf,UAAWH,CACb,CACF,CAGD,CACH,EAEOC,CACT,CAEA,OAAO,MAAM,KAAK,OAAO,YACvBnB,EACA7H,EACAkI,CACF,CACF,CAEA,MAAc,sBACZhD,EACAlF,EACA0F,EACAyD,EAAgB,GAChB,CACA,IAAMC,GAAQ,MAAM,KAAK,eAAe,CAAE,QAAS,CAAClE,CAAM,CAAE,CAAC,IAAI,MAAM,EAEvE,GAAI,CAACkE,EAAK,QAAU,CAACvG,GAAWuG,EAAK,GAAG,GAAK,CAACA,EAAK,IAAI,SAAS,YAAY,EAC1E,MAAM,IAAI/B,EAAoB+B,CAAI,EAGpC,IAAMvB,EAASuB,EAAK,IAAI,YAAY,EAEpC,KAAK,OAAO,QAAQ,sBAAsBvB,CAAM,EAAE,EAElD,GAAI,CACF,GAAInC,GAAS,MAEX,GADA,KAAK,OAAO,QAAQ,cAAcA,EAAQ,KAAK,SAASmC,CAAM,EAAE,EAC5DnC,EAAQ,MAAQ,IAAO,CACzB,IAAI2D,EAAiB3D,EAAQ,MAC7B,KAAO2D,EAAiB,KACtB,MAAM,KAAK,OAAO,kBAAkBxB,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBnC,EAAQ,UAA2B,YAAamC,CAAM,EAE5F,MAAMzD,GAAM,GAAK,EAEjB,MAAM,KAAK,OAAO,mBAAmB,SAAUyD,CAAM,EAErDwB,GAAkB,IAEhBA,EAAiB,IACnB,MAAM,KAAK,OAAO,kBAAkBxB,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBnC,EAAQ,UAA2B,YAAamC,CAAM,EAE5F,MAAMzD,GAAMiF,CAAc,EAE1B,MAAM,KAAK,OAAO,mBAAmB,SAAUxB,CAAM,EAEzD,MACE,MAAM,KAAK,OAAO,kBAAkBA,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBnC,EAAQ,UAA2B,YAAamC,CAAM,EAE5F,MAAMzD,GAAMsB,EAAQ,KAAK,EAEzB,MAAM,KAAK,OAAO,mBAAmB,SAAUmC,CAAM,EAIzD,IAAME,EAAcrC,GAAS,aAAe,GAAQ,OAAY,GAE5DsC,EAEJ,GAAItC,GAAS,OAAQ,CACnB,IAAM,EAAIA,GAAS,OAEbrF,EAAM,GAAG,QAAU,EAAM,MAAM,KAAK,WAAW,EAAE,IAAK,EAAI,EAE5DA,IACF2H,EAAS3H,EAEb,CAEA,IAAIiJ,EAEAxB,EACJ,GAAIjF,GAAWgF,CAAM,EAAG,CACtB,IAAIjF,EACJ,GAAI,CACF,IAAM5E,EAAQ,KAAK,cAAc,IAAe,OAAO,EACnD,CAACA,EAAM,MAAM,SAAW,CAACA,EAAM,MAAM,QAAS4E,EAAQ,MAAM,KAAK,UAAU,CAAE,SAAUiF,CAAO,EAAG,OAAO,EACvGjF,EAAQ,MAAM,KAAK,sBAAsBiF,CAAM,CAEtD,MAAgB,CACd,MAAM,IAAI0B,EAAkB,iBAAiB,CAC/C,CAEA,GAAI,CAAC3G,EACH,MAAM,IAAI2G,EAAkB,iBAAiB,EAG3C7D,GAAS,iBACXoC,EAAWlF,EAAM,aAAa,IAAK4G,GAAgBA,EAAY,EAAE,EACxD9D,GAAS,WAAW,SAC7BoC,EAAWpC,EAAQ,UAAU,IAAK+D,GAAY,CAC5C,IAAMvD,EAAMe,EAAUwC,CAAO,EAC7B,OAAI5G,GAAWqD,CAAG,EACT,KAEFA,CACT,CAAC,GAGHoD,EAAc,MAAM,KAAK,YACvBzB,EACA7H,EACA8H,EACAC,EACAC,EACA,KACApF,GAAO,iBAET,CACF,MACE0G,EAAc,MAAM,KAAK,YAAYzB,EAAQ7H,EAAS8H,EAAUC,EAAaC,CAAM,EAGjF5H,GAAK,OAAOkJ,GAAa,gBAAgB,IAC3CA,EAAY,iBAAmBA,EAAY,kBAAkB,SAAS,GAGxE,IAAMxI,EAAa,KAAK,eAAewI,CAAW,EAE5CvI,EACJuI,GAAa,SAAS,cACtBA,GAAa,SAAS,cACtBA,GAAa,SAAS,gBACtBA,GAAa,SAAS,YACtBA,GAAa,SAAS,iBACtBA,GAAa,SAAS,4BACtBA,GAAa,SAAS,YACtBA,GAAa,SAAS,aAUxB,GARI,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAW,CAACH,GAC1F,KAAK,gBAAgB,6BAEnB,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAChErI,CACF,EAGE,KAAK,cAAc,IAAY,QAAQ,EAAE,SAAWA,GAAY,SAAS,aAAc,CACzF,IAAMG,EAAwB,MAAM,KAAK,iBAAiB,cAAc,UAAU,CAChF,MAAO,CACL,WAAY,KAAK,UACnB,EACA,QAAS,CACP,YAAa,EACf,CACF,CAAC,EAEGA,GAAyBA,EAAsB,eAAiBA,EAAsB,eACxFH,EAAW,QAAQ,aAAe,MAAM,KAAK,cAAc,aACzDG,EAAsB,YACtBH,EACA,KAAK,OAAO,kBACd,EAEJ,CAEA,GAAI,KAAK,cAAc,IAAc,UAAU,EAAE,UAAU,YAAa,CACtE,IAAMT,EAAM,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACrD,KAAMS,CACR,CAAC,EAED,GAAIC,GAAW,KAAK,cAAc,IAAQ,IAAI,EAAE,OAC9C,GAAI,CACF,IAAMf,EAAec,EACfK,EAAQ,MAAM,KAAK,0BACvB,CACE,QAAAnB,CACF,EACA,EACF,EAEM,CAAE,OAAA5C,EAAQ,UAAAgE,EAAW,SAAAC,EAAU,KAAArE,CAAK,EAAImE,EAExCG,EAAWC,GAAU,OAAOF,CAAQ,EAAE,SAAS,EAE/CG,EAAWC,GACf,GAAG,KAAK,SAAS,EAAE,GACnBX,EAAW,IAAI,UACf,GAAGA,EAAW,IAAI,EAAE,GACpBM,EACAC,CACF,EAEA,MAAgBK,GAAWF,EAAUpE,EAAQJ,EAAK,YAAY,IAAK,CACjE,eAAgBsE,CAClB,CAAC,EAED,MAAM,KAAK,iBAAiB,MAAM,OAAO,CACvC,KAAM,CACJ,UAAWjB,EAAI,GACf,WAAY,KAAK,WACjB,KAAMe,EACN,SAAUI,EACV,SAAAF,CACF,CACF,CAAC,EAED,IAAMK,EAAW,MAAgBC,GAAaJ,CAAQ,EAEtDV,EAAW,QAAQ,SAAWa,EAE9B,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACzC,MAAO,CAAE,GAAItB,EAAI,EAAG,EACpB,KAAMS,CACR,CAAC,CACH,OAASxB,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,gCAAiCA,GAAO,QAASA,GAAO,KAAK,CAAC,CACnF,CAEJ,CAEA,GAAI,KAAK,aAAa,SAChByB,GAAW,KAAK,aAAa,cAC/B,GAAI,CACF,IAAM3D,EAAS,MAAMyE,GACnB,CAAE,IAAKf,EAAW,IAAK,QAASA,GAAY,OAAQ,EACpD,SACA,CAAC,EACD,CACE,OAAQgB,GAAE,CAAE,MAAO,OAAQ,CAAC,EAC5B,gBAAiB,KAAK,OAAO,kBAC/B,CACF,EAEAhB,EAAW,QAAQ,OAAS1D,EAASA,EAAO,SAAS,QAAQ,EAAI,MACnE,OAASkC,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,mCAAoCA,GAAO,OAAO,CAAC,CACxE,CAIJ,YAAK,OAAO,IAAIwB,CAAU,EAE1B,KAAK,+BAAqCA,CAAU,EAEhD,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,SAAWqI,GACzF,MAAMpH,GAAkB,KAAK,CAC3B,SAAU,CAAE,aAAc,KAAK,SAAS,KAAM,WAAY,KAAK,UAAW,EAC1E,UAAWjB,EAAW,IAAI,UAC1B,IAAKA,EACL,SAAUA,EAAW,SACrB,cAAAqI,CACF,CAAC,EAGIrI,CACT,OAASxB,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAGA,MAAa,aAAa3B,EAAuB,CAC/C,GAAI,CACF,GAAM,CAAE,OAAAuH,CAAO,EAAIvH,EAEbyL,GAAQ,MAAM,KAAK,eAAe,CAAE,QAAS,CAAClE,CAAM,CAAE,CAAC,IAAI,MAAM,EAEvE,GAAI,CAACkE,EAAK,QAAU,CAACvG,GAAWuG,EAAK,GAAG,GAAK,CAACA,EAAK,IAAI,SAAS,YAAY,EAC1E,MAAM,IAAI/B,EAAoB+B,CAAI,EAGpC,IAAMvB,EAASuB,EAAK,IAEpB,GAAIzL,GAAM,OAASA,GAAM,MAAQ,IAAO,CACtC,IAAI0L,EAAiB1L,GAAM,MAC3B,KAAO0L,EAAiB,KACtB,MAAM,KAAK,OAAO,kBAAkBxB,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBlK,GAAM,UAA2B,YAAakK,CAAM,EAE1F,MAAMzD,GAAM,GAAK,EAEjB,MAAM,KAAK,OAAO,mBAAmB,SAAUyD,CAAM,EAErDwB,GAAkB,IAEhBA,EAAiB,IACnB,MAAM,KAAK,OAAO,kBAAkBxB,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBlK,GAAM,UAA2B,YAAakK,CAAM,EAE1F,MAAMzD,GAAMiF,CAAc,EAE1B,MAAM,KAAK,OAAO,mBAAmB,SAAUxB,CAAM,EAEzD,MACE,MAAM,KAAK,OAAO,kBAAkBA,CAAM,EAE1C,MAAM,KAAK,OAAO,mBAAoBlK,GAAM,UAA2B,YAAakK,CAAM,EAE1F,MAAMzD,GAAMzG,GAAM,KAAK,EAEvB,MAAM,KAAK,OAAO,mBAAmB,SAAUkK,CAAM,EAGvD,MAAO,CAAE,SAAUlK,EAAK,QAAS,CACnC,OAAS2B,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAGA,MAAa,YAAY3B,EAAsB,CAC7C,GAAI,CACF,aAAM,KAAK,OAAO,mBAAmBA,EAAK,QAAQ,EAE3C,CAAE,SAAUA,EAAK,QAAS,CACnC,OAAS2B,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAGA,MAAa,YAAY3B,EAAmBwL,EAAgB,GAAO,CACjE,IAAMzI,EAAO/C,EAAK,KAElB,GAAI,CAAC+C,GAAQA,EAAK,KAAK,EAAE,SAAW,EAClC,MAAM,IAAI2G,EAAoB,kBAAkB,EAGlD,OAAO,MAAM,KAAK,sBAChB1J,EAAK,OACL,CACE,aAAcA,EAAK,IACrB,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAwL,CACF,CACF,CAEA,MAAa,YAAYxL,EAAmB,CAC1C,OAAO,MAAM,KAAK,sBAChBA,EAAK,OACL,CACE,KAAM,CACJ,KAAMA,EAAK,KACX,gBAAiBA,EAAK,gBACtB,OAAQA,EAAK,MACf,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,YAAaA,GAAM,YACnB,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAc,oBAAoBuD,EAAuB,CACvD,GAAI,CAACA,EAAO,KACV,MAAM,IAAImG,EAAoB,kBAAkB,EAGlD,GAAI,CAACnG,EAAO,QACV,MAAM,IAAImG,EAAoB,qBAAqB,EAGrD,GAAInG,EAAO,YAAa,CACtB,IAAMvC,EAAW,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC5D,MAAO,CAAE,WAAY,KAAK,UAAW,CACvC,CAAC,EAED,GAAI,CAACA,EAAS,OACZ,MAAM,IAAI0I,EAAoB,oBAAoB,EAGpDnG,EAAO,cAAgBvC,EAAS,OAAQE,GAAYA,EAAQ,QAAQ,EAAE,IAAKA,GAAYA,EAAQ,SAAS,CAC1G,CAEA,GAAI,CAACqC,EAAO,eAAe,QAAU,CAACA,EAAO,YAC3C,MAAM,IAAImG,EAAoB,2BAA2B,EAG3D,GAAInG,EAAO,OAAS,OAAQ,CAC1B,GAAI,CAACA,EAAO,gBACV,MAAM,IAAImG,EAAoB,8BAA8B,EAG9D,GAAI,CAACnG,EAAO,KACV,MAAM,IAAImG,EAAoB,kBAAkB,EAGlD,MAAO,CACL,QAAS,CACP,KAAMnG,EAAO,OACf,EACA,OAAQ,CACN,gBAAiBA,EAAO,gBACxB,KAAMA,EAAO,KACb,cAAeA,EAAO,aACxB,CACF,CACF,CACA,GAAIA,EAAO,OAAS,QAClB,MAAO,CACL,QAAS,CACP,MAAO,CACL,IAAKA,EAAO,OACd,EACA,QAASA,EAAO,OAClB,EACA,OAAQ,CACN,cAAeA,EAAO,aACxB,CACF,EAGF,GAAIA,EAAO,OAAS,QAClB,MAAO,CACL,QAAS,CACP,MAAO,CACL,IAAKA,EAAO,OACd,EACA,QAASA,EAAO,OAClB,EACA,OAAQ,CACN,cAAeA,EAAO,aACxB,CACF,EAGF,GAAIA,EAAO,OAAS,QAAS,CAC3B,IAAMwI,EAAU,MAAM,KAAK,gBAAgBxI,EAAO,OAAO,EACzD,GAAI,OAAO,SAASwI,CAAO,EAYzB,MAXe,CACb,QAAS,CACP,MAAOA,EACP,IAAK,GACL,SAAU,wBACZ,EACA,OAAQ,CACN,cAAexI,EAAO,aACxB,CACF,EAIA,MAAM,IAAI0F,EAA6B8C,CAAO,CAElD,CAEA,MAAM,IAAIrC,EAAoB,gBAAgB,CAChD,CAEA,MAAa,cAAc1J,EAAqBgM,EAAY,CAC1D,IAAMC,EAA2B,CAAE,GAAGjM,CAAK,EAEvCgM,IAAMC,EAAU,QAAUD,EAAK,OAAO,SAAS,QAAQ,GAE3D,IAAMzI,EAAS,MAAM,KAAK,oBAAoB0I,CAAS,EAMvD,OAJmB,MAAM,KAAK,sBAAsB,mBAAoB,CACtE,OAAA1I,CACF,CAAC,CAGH,CAEA,MAAc,oBAAoB2I,EAA4B,CAC5D,GAAI,CACF,IAAMvJ,EAAOuJ,EAAa,YAAc,MAAQ,QAAUA,EAAa,UAEjEC,EAAe,MAAMC,GACzB,CACE,CAACzJ,CAAI,EAAG0J,GAAMH,EAAa,KAAK,EAAI,CAAE,IAAKA,EAAa,KAAM,EAAI,OAAO,KAAKA,EAAa,MAAO,QAAQ,CAC5G,EACA,CAAE,OAAQ,KAAK,OAAO,gBAAiB,CACzC,EAEMzI,EAAYyI,EAAa,UAAY,UAE3C,GAAIA,EAAa,YAAc,YAAc,CAACA,EAAa,SAAU,CAEnE,IAAMI,EADQ,IAAI,OAAO,aAAa,EACb,KAAKJ,EAAa,KAAK,EAChDA,EAAa,SAAWI,EAAW,CAAC,CACtC,CAEIJ,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAGtBA,EAAa,YAAc,SAAW,CAACA,EAAa,WACtDA,EAAa,SAAW,aAG1B,IAAIvI,EAEJ,GAAIuI,EAAa,SACfvI,EAAWuI,EAAa,iBAExBvI,EAAWC,GAAU,OAAOsI,EAAa,QAAQ,EAE7C,CAACvI,GAAY0I,GAAMH,EAAa,KAAK,EAAG,CAC1C,IAAIK,EAAc,CAChB,aAAc,aAChB,EAEI,KAAK,YAAY,UACnBA,EAAS,CACP,GAAGA,EACH,WAAYnE,GAAe,CACzB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,CACH,GAKFzE,GAFiB,MAAMsE,GAAM,IAAIiE,EAAa,MAAOK,CAAM,GAEvC,QAAQ,cAAc,CAC5C,CAGF,GAAIL,EAAa,YAAc,MAAO,CAIpC,GAHAC,EAAa1I,CAAS,EAAI0I,EAAaxJ,EAAO,SAAS,EACvDgB,EAAW,YAEP,CAACwI,EAAa1I,CAAS,EACzB,MAAM,IAAI,MAAM,iCAAiC,EAGnD,GAAI,CACF,IAAI+I,EACJ,GAAIH,GAAMH,EAAa,KAAK,EAC1BM,EAAaN,EAAa,UACrB,CACL,IAAMO,EAAc,OAAO,KAAKP,EAAa,MAAO,QAAQ,EAC5D,GAAI,CAACO,GAAeA,EAAY,SAAW,EACzC,MAAM,IAAI,MAAM,sBAAsB,EAExCD,EAAaC,CACf,CAEA,IAAM9M,EAAW,MAAMZ,GAAiByN,CAAU,EAClD,GAAI,CAAC7M,GAAYA,GAAY,EAC3B,MAAM,IAAI,MAAM,wBAAwB,EAG1C,KAAK,OAAO,QAAQ,mBAAmBA,CAAQ,UAAU,EACzDwM,EAAa1I,CAAS,EAAE,QAAU9D,CACpC,OAASgC,EAAO,CACd,WAAK,OAAO,MAAM,+BAA+B,EACjD,KAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiCA,EAAM,OAAO,EAAE,CAClE,CACF,CAEA,OAAAwK,EAAa1I,CAAS,EAAE,QAAUyI,GAAc,QAChDC,EAAa1I,CAAS,EAAE,SAAWE,EACnCwI,EAAa1I,CAAS,EAAE,SAAWyI,EAAa,SAE5CA,EAAa,YAAc,UAC7BC,EAAa1I,CAAS,EAAE,cAAgB,WAAW,KACjDiJ,GAAa5I,GAAK,QAAQ,IAAI,EAAG,SAAU,SAAU,iBAAiB,CAAC,CACzE,EACAqI,EAAa1I,CAAS,EAAE,YAAc,IAGjCiH,GACL,GACA,CAAE,CAACjH,CAAS,EAAG,CAAE,GAAG0I,EAAa1I,CAAS,CAAE,CAAE,EAC9C,CAAE,QAAS,KAAK,SAAS,IAAK,CAChC,CACF,OAAS9B,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIsH,EAA6BtH,GAAO,SAAS,GAAKA,CAAK,CACnE,CACF,CAEA,MAAc,cAAcgL,EAAgC,CAC1D,GAAI,CACF,IAAIC,EAEJ,GAAIC,GAASF,CAAK,EAAG,CACnB,IAAMG,EAAaH,EAAM,QAAQ,sCAAuC,EAAE,EAC1EC,EAAc,OAAO,KAAKE,EAAY,QAAQ,CAChD,KAAO,CACL,IAAMC,EAAY,IAAI,KAAK,EAAE,QAAQ,EAC/BC,EAAM,GAAGL,CAAK,cAAcI,CAAS,GAEvCR,EAAc,CAChB,aAAc,aAChB,EAEI,KAAK,YAAY,UACnBA,EAAS,CACP,GAAGA,EACH,WAAYnE,GAAe,CACzB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,CACH,GAGF,IAAM6E,EAAW,MAAMhF,GAAM,IAAI+E,EAAKT,CAAM,EAC5CK,EAAc,OAAO,KAAKK,EAAS,KAAM,QAAQ,CACnD,CAIA,OAFmB,MAAMC,GAAMN,CAAW,EAAE,KAAK,EAAE,SAAS,CAG9D,OAASjL,EAAO,CACd,cAAQ,MAAM,wCAAyCA,CAAK,EACtDA,CACR,CACF,CAEA,MAAa,aAAa3B,EAAsBgM,EAAY,CAC1D,IAAMC,EAA4B,CAAE,GAAGjM,CAAK,EAExCgM,IAAMC,EAAU,QAAUD,EAAK,OAAO,SAAS,QAAQ,GAE3D,IAAMD,EAAU,MAAM,KAAK,cAAc/L,EAAK,OAAO,EAC/CmN,EAAcnN,EAAK,QAAQ,SAAS,MAAM,EAgBhD,OAfe,MAAM,KAAK,sBACxBA,EAAK,OACL,CACE,QAAS+L,EACT,YAAAoB,CACF,EACA,CACE,MAAOnN,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CAGF,CAEA,MAAa,aAAaA,EAAoBgM,EAAYR,EAAgB,GAAO,CAC/E,IAAMS,EAA0B,CAAE,GAAGjM,CAAK,EAEtCgM,IAAMC,EAAU,MAAQD,EAAK,OAAO,SAAS,QAAQ,GAEzD,IAAMoB,EAAW,MAAM,KAAK,oBAAoBnB,CAAS,EAezD,OAbkB,MAAM,KAAK,sBAC3BjM,EAAK,OACL,CAAE,GAAGoN,EAAS,OAAQ,EACtB,CACE,MAAOpN,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAwL,CACF,CAGF,CAEA,MAAa,WAAWxL,EAAkBgM,EAAYR,EAAgB,GAAO,CAC3E,IAAMS,EAA0B,CAC9B,OAAQjM,EAAK,OACb,MAAOA,EAAK,MACZ,UAAW,MACX,MAAOA,GAAM,MACb,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EAEIgM,IAAMC,EAAU,MAAQD,EAAK,OAAO,SAAS,QAAQ,GAEzD,IAAMoB,EAAW,MAAM,KAAK,oBAAoBnB,CAAS,EAezD,OAbkB,MAAM,KAAK,sBAC3BjM,EAAK,OACL,CAAE,GAAGoN,EAAS,OAAQ,EACtB,CACE,MAAOpN,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,EACAwL,CACF,CAGF,CAEA,MAAa,gBAAgB6B,EAAe,CAC1C,IAAIC,EAEJ,GAAIjB,GAAMgB,CAAK,EAEbC,GADiB,MAAMrF,GAAM,IAAIoF,EAAO,CAAE,aAAc,QAAS,CAAC,GAC3C,SAClB,CACL,IAAME,EAAc,OAAO,KAAKF,EAAO,QAAQ,EAC/CC,EAAc,IAAIE,GAClBF,EAAY,IAAIC,CAAW,CAC7B,CAEA,OAAO,IAAI,QAAgB,CAACE,EAASC,IAAW,CAC9C,IAAMC,EAAgBC,GAAMC,GAAW,KAAM,CAC3C,KACA,SACA,MACA,MACA,OACA,MACA,QACA,KACA,MACA,YACA,2BACA,QACF,CAAC,EAEKC,EAAyB,CAAC,EAC5BC,EAAa,GAEjBJ,EAAc,OAAO,GAAG,OAAS5N,GAAU,CACzC+N,EAAa,KAAK/N,CAAK,CACzB,CAAC,EAED4N,EAAc,OAAO,GAAG,OAAS3N,GAAS,CACxC+N,GAAc/N,EAAK,SAAS,EAC5B,KAAK,OAAO,QAAQ,kBAAkBA,CAAI,EAAE,CAC9C,CAAC,EAED2N,EAAc,GAAG,QAAUhM,GAAU,CACnC,QAAQ,MAAM,0BAA2BA,CAAK,EAC9C+L,EAAO/L,CAAK,CACd,CAAC,EAEDgM,EAAc,GAAG,QAAUK,GAAS,CAClC,GAAIA,IAAS,EAAG,CACd,KAAK,OAAO,QAAQ,wBAAwB,EAC5C,IAAMC,EAAe,OAAO,OAAOH,CAAY,EAC/CL,EAAQQ,CAAY,CACtB,MACE,KAAK,OAAO,MAAM,2BAA2BD,CAAI,EAAE,EACnD,KAAK,OAAO,MAAM,kBAAkBD,CAAU,EAAE,EAChDL,EAAO,IAAI,MAAM,2BAA2BM,CAAI,KAAKD,CAAU,EAAE,CAAC,CAEtE,CAAC,EAEDT,EAAY,KAAKK,EAAc,KAAK,EAEpCL,EAAY,GAAG,QAAUY,GAAQ,CAC/B,QAAQ,MAAM,uBAAwBA,CAAG,EACzCP,EAAc,MAAM,IAAI,EACxBD,EAAOQ,CAAG,CACZ,CAAC,CACH,CAAC,CACH,CAEA,MAAa,aAAab,EAAgC,CACxD,GAAI,QAAQ,IAAI,oBAAqB,CACnC,KAAK,OAAO,QAAQ,2BAA2B,EAC/C,IAAMc,EAAW,IAAIC,GAEjB/B,GAAMgB,CAAK,EACbc,EAAS,OAAO,MAAOd,CAAK,EAE5Bc,EAAS,OAAO,SAAUd,CAAK,EAGjC,GAAM,CAAE,KAAArN,CAAK,EAAI,MAAMiI,GAAM,KAAK,QAAQ,IAAI,oBAAqBkG,EAAU,CAC3E,QAAS,CACP,GAAGA,EAAS,WAAW,EACvB,OAAQ,QAAQ,IAAI,uBACtB,CACF,CAAC,EAED,GAAI,CAACnO,EAAK,MACR,MAAM,IAAIiJ,EAA6B,yBAAyB,EAGlE,YAAK,OAAO,QAAQ,iBAAiB,EAC9B,OAAO,KAAKjJ,EAAK,MAAO,QAAQ,CACzC,KAAO,CACL,IAAIqO,EAEJ,GAAIhC,GAAMgB,CAAK,EAAG,CAChB,IAAMN,EAAY,IAAI,KAAK,EAAE,QAAQ,EAC/BC,EAAM,GAAGK,CAAK,cAAcN,CAAS,GAErCR,EAAc,CAClB,aAAc,QAChB,EAGA8B,GADiB,MAAMpG,GAAM,IAAI+E,EAAKT,CAAM,GAChB,KAAK,KAAK,IAAIiB,EAAa,CACzD,KAAO,CACL,IAAMD,EAAc,OAAO,KAAKF,EAAO,QAAQ,EAC/CgB,EAAmB,IAAIb,GACvBa,EAAiB,IAAId,CAAW,CAClC,CAEA,OAAO,IAAI,QAAQ,CAACE,EAASC,IAAW,CACtC,IAAMY,EAAoB,IAAId,GACxB1N,EAAmB,CAAC,EAE1BwO,EAAkB,GAAG,OAASvO,GAAUD,EAAO,KAAKC,CAAK,CAAC,EAC1DuO,EAAkB,GAAG,MAAO,IAAM,CAChC,IAAML,EAAe,OAAO,OAAOnO,CAAM,EACzC2N,EAAQQ,CAAY,CACtB,CAAC,EAEDK,EAAkB,GAAG,QAAU3M,GAAU,CACvC,QAAQ,IAAI,QAASA,CAAK,EAC1B+L,EAAO/L,CAAK,CACd,CAAC,EAED4M,GAAO,cAAcV,GAAW,IAAI,EAEpCU,GAAOF,CAAgB,EACpB,aAAa,KAAK,EAClB,QAAQ,EACR,WAAW,SAAS,EACpB,iBAAiB,8BAA8B,EAC/C,cAAc,CAAC,EACf,KAAKC,EAAmB,CAAE,IAAK,EAAK,CAAC,EACrC,GAAG,QAAS,SAAU3M,EAAO,CAC5B,QAAQ,IAAI,QAASA,CAAK,EAC1B+L,EAAO/L,CAAK,CACd,CAAC,CACL,CAAC,CACH,CACF,CAEA,MAAa,cAAc3B,EAAoBgM,EAAYR,EAAgB,GAAO,CAChF,IAAMS,EAA0B,CAAE,GAAGjM,CAAK,EAE1C,GAAIgM,GAAM,OACRC,EAAU,MAAQD,EAAK,OAAO,SAAS,QAAQ,UACtC,CAACK,GAAMrM,EAAK,KAAK,GAAK,CAAC6M,GAAS7M,EAAK,KAAK,EACnD,cAAQ,MAAM,8BAA8B,EACtC,IAAI0J,EAAoB,+CAA+C,EAO/E,GAJI,CAAC1J,GAAM,UAAYA,GAAM,WAAa,KACxCA,EAAK,SAAW,IAGdA,GAAM,SAAU,CAClB,IAAM+L,EAAU,MAAM,KAAK,aAAaE,EAAU,KAAK,EAEvD,GAAI,OAAO,SAASF,CAAO,EAYzB,OAXe,KAAK,sBAClB/L,EAAK,OACL,CACE,MAAO+L,EACP,IAAK,GACL,SAAU,wBACZ,EACA,CAAE,SAAU,YAAa,MAAO/L,GAAM,KAAM,EAC5CwL,CACF,EAIA,MAAM,IAAIvC,EAA6B,yBAAyB,CAEpE,CAEA,OAAO,MAAM,KAAK,sBAChBjJ,EAAK,OACL,CACE,MAAOqM,GAAMrM,EAAK,KAAK,EAAI,CAAE,IAAKA,EAAK,KAAM,EAAI,OAAO,KAAKA,EAAK,MAAO,QAAQ,EACjF,IAAK,GACL,SAAU,wBACZ,EACA,CAAE,SAAU,YAAa,MAAOA,GAAM,KAAM,EAC5CwL,CACF,CACF,CAEQ,iBAAiBgD,EAAS,GAAI,CACpC,IAAMC,EAAa,uCACf/O,EAAS,GACb,QAASyL,EAAI,EAAGA,EAAIqD,EAAQrD,IAC1BzL,GAAU+O,EAAW,OAAO,KAAK,MAAM,KAAK,OAAO,EAAIA,EAAW,MAAM,CAAC,EAE3E,OAAO/O,CACT,CAEQ,aAAagP,EAAwB,CAC3C,IAAMC,EAAYC,GAAa,KAAK,UAAUA,CAAG,EAyDjD,MAvDa,CACX,KAAM,IAAMD,EAAS,CAAE,aAAcD,EAAO,YAAa,aAAcA,EAAO,WAAY,CAAC,EAC3F,MAAO,IAAMC,EAAS,CAAE,aAAcD,EAAO,YAAa,GAAIA,EAAO,EAAG,CAAC,EACzE,KAAM,IAAMC,EAAS,CAAE,aAAcD,EAAO,YAAa,UAAWA,EAAO,QAAS,CAAC,EACrF,IAAK,IACHC,EAAS,CACP,aAAcD,EAAO,YACrB,IAAKA,EAAO,IACZ,aAAcA,EAAO,GACvB,CAAC,EACH,IAAK,IACHC,EAAS,CACP,SAAUD,EAAO,SACjB,aAAc,CACZ,MAAO,EACP,OAAQ,GACV,EACA,aAAc,KAAK,iBAAiB,EACpC,KAAM,iBACN,MAAO,CACL,OAAQ,UACR,SAAU,CACR,MAAO,EACP,OAAQ,GACV,EACA,WAAY,QACZ,MAAO,CACL,CACE,KAAM,GACN,OAAQ,CACN,MAAO,EACP,OAAQ,GACV,EACA,SAAU,EACV,YAAa,CACX,MAAO,EACP,OAAQ,GACV,CACF,CACF,CACF,EACA,iBAAkB,CAChB,CACE,KAAM,kBACN,gBAAiB,CACf,cAAeA,EAAO,KACtB,IAAKA,EAAO,IACZ,SAAU,KAAK,WAAW,IAAIA,EAAO,OAAO,CAC9C,CACF,CACF,EACA,qBAAsB,EACxB,CAAC,CACL,EAEYA,EAAO,IAAI,IAAI,GAAK,EAClC,CAkBA,MAAa,cAAc1O,EAAsB,CAC/C,GAAIA,EAAK,QAAQ,SAAW,EAC1B,MAAM,IAAI0J,EAAoB,iCAAiC,EAGjE,IAAMmF,EAAkB7O,EAAK,QAAQ,KAAM8O,GAAQA,EAAI,OAAS,OAAO,EAEjEC,EAAe/O,EAAK,QAAQ,KAAM8O,GAAQA,EAAI,OAAS,KAAK,EAE5DE,EAAkBhP,EAAK,QAAQ,KAAM8O,GAAQA,EAAI,OAAS,SAAWA,EAAI,OAAS,KAAK,EAE7F,GAAID,EAAiB,CACnB,GAAI7O,EAAK,QAAQ,OAAS,EACxB,MAAM,IAAI0J,EAAoB,oCAAoC,EAEpE,GAAIsF,EACF,MAAM,IAAItF,EAAoB,uDAAuD,CAEzF,CAEA,GAAIqF,EAAc,CAChB,GAAI/O,EAAK,QAAQ,OAAS,EACxB,MAAM,IAAI0J,EAAoB,gCAAgC,EAEhE,GAAIsF,EACF,MAAM,IAAItF,EAAoB,oDAAoD,EAGpF,IAAMrH,EAA0B,CAC9B,gBAAiB,CACf,QAAS,CACP,mBAAoB,CAClB,kBAAmB,CACjB,QAAS,CACP,CACE,KAAM,KAAK,QAAQ,IAAI,KAAK,EAC5B,iBAAkB,KAAK,aAAarC,EAAK,QAAQ,CAAC,CAAC,CACrD,CACF,EACA,kBAAmB,KAAK,UAAU,CAChC,KAAM,MACN,WAAYiP,EAAG,CACjB,CAAC,CACH,CACF,CACF,CACF,CACF,EAEA,OAAO,MAAM,KAAK,sBAAsBjP,EAAK,OAAQqC,EAAS,CAC5D,MAAOrC,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CAAC,CACH,CAEA,IAAMoN,EAAW,MAAO,SAAY,CAClC,GAAIpN,GAAM,aACR,OAAO,MAAM,KAAK,oBAAoB,CACpC,UAAW,QACX,MAAOA,EAAK,YACd,CAAC,CAEL,GAAG,EAEGkP,EAAUlP,EAAK,QAAQ,IAAK6K,IACzB,CACL,KAAM,KAAK,QAAQ,IAAIA,EAAM,IAAI,EACjC,iBAAkB,KAAK,aAAaA,CAAK,CAC3C,EACD,EAEKxI,EAA0B,CAC9B,gBAAiB,CACf,QAAS,CACP,mBAAoB,CAClB,KAAM,CACJ,MAAO,IAAM,CACX,IAAIzC,EAAI,IAAMI,EAAK,MAAQ,IAC3B,OAAIA,GAAM,cACRJ,GAAK;AAAA;AAAA,EACLA,GAAKI,EAAK,YACVJ,GAAK;AAAA,GAEAA,CACT,GAAG,CACL,EACA,OAAQ,CACN,KAAMI,GAAM,MACd,EACA,QAAS,IAAM,CACb,GAAIoN,GAAU,SAAS,aACrB,MAAO,CACL,mBAAoB,CAAC,CAACA,EAAS,QAAQ,aACvC,aAAcA,EAAS,QAAQ,YACjC,CAEJ,GAAG,EACH,kBAAmB,CACjB,QAAS8B,EACT,kBAAmB,KAAK,UAAU,CAChC,KAAM,MACN,WAAYD,EAAG,CACjB,CAAC,CACH,CACF,CACF,CACF,CACF,EAEA,OAAO,MAAM,KAAK,sBAAsBjP,EAAK,OAAQqC,EAAS,CAC5D,MAAOrC,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CAAC,CACH,CAEA,MAAa,gBAAgBA,EAAuB,CAClD,OAAO,MAAM,KAAK,sBAChBA,EAAK,OACL,CACE,gBAAiB,CACf,gBAAiBA,EAAK,SACtB,iBAAkBA,EAAK,UACvB,KAAMA,GAAM,KACZ,QAASA,GAAM,OACjB,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAa,YAAYA,EAAmB,CAC1C,OAAO,MAAM,KAAK,sBAChBA,EAAK,OACL,CACE,YAAa,CACX,MAAOA,EAAK,MACZ,YAAaA,EAAK,YAClB,WAAYA,GAAM,WAClB,WAAYA,GAAM,WAClB,SAAUA,EAAK,SACf,SAAU,CACZ,CACF,EACA,CACE,MAAOA,GAAM,MACb,SAAU,YACV,OAAQA,GAAM,OACd,iBAAkBA,GAAM,iBACxB,UAAWA,GAAM,SACnB,CACF,CACF,CAEA,MAAa,eAAeA,EAAsB,CAChD,IAAMqC,EAA0B,CAAC,EAE3B8M,EAASjO,GAA4B,CACzC,IAAIxB,EAAS;AAAA;AAAA,IAAyCwB,EAAQ,QAAQ;AAAA,KAAaA,EAAQ,QAAQ;AAAA,EAEnG,OAAIA,EAAQ,eACVxB,GAAU,OAAOwB,EAAQ,YAAY;AAAA,GAGnCA,EAAQ,QACVxB,GAAU,SAASwB,EAAQ,KAAK;AAAA,GAG9BA,EAAQ,MACVxB,GAAU,OAAOwB,EAAQ,GAAG;AAAA,GAGzBA,EAAQ,OACXA,EAAQ,KAAOoI,EAAUpI,EAAQ,WAAW,GAG9CxB,GAAU,kBAAkBwB,EAAQ,IAAI,IAAIA,EAAQ,WAAW;AAAA;AAAA,WAExDxB,CACT,EAEA,OAAIM,EAAK,QAAQ,SAAW,EAC1BqC,EAAQ,eAAiB,CACvB,YAAarC,EAAK,QAAQ,CAAC,EAAE,SAC7B,MAAOmP,EAAMnP,EAAK,QAAQ,CAAC,CAAC,CAC9B,EAEAqC,EAAQ,qBAAuB,CAC7B,YAAa,GAAGrC,EAAK,QAAQ,MAAM,YACnC,SAAUA,EAAK,QAAQ,IAAKkB,IACnB,CACL,YAAaA,EAAQ,SACrB,MAAOiO,EAAMjO,CAAO,CACtB,EACD,CACH,EAGK,MAAM,KAAK,sBAAsBlB,EAAK,OAAQ,CAAE,GAAGqC,CAAQ,EAAG,CAAC,CAAC,CACzE,CAEA,MAAa,gBAAgBrC,EAAuB,CAClD,OAAO,MAAM,KAAK,sBAAsBA,EAAK,IAAI,UAAW,CAC1D,gBAAiB,CACf,IAAKA,EAAK,IACV,KAAMA,EAAK,QACb,CACF,CAAC,CACH,CAGA,MAAa,eAAeA,EAAyB,CACnD,IAAMoP,EAIF,CACF,OAAQ,CAAC,EACT,UAAW,CAAC,EACZ,MAAO,CAAC,CACV,EAEApP,EAAK,QAAQ,QAASuH,GAAW,CAC/B,IAAMgB,EAAMe,EAAU/B,CAAM,EAExBrC,GAAWqD,CAAG,EAChB6G,EAAK,OAAO,KAAK,CAAE,OAAA7H,EAAQ,IAAAgB,CAAI,CAAC,EACvBA,IAAQ,mBACjB6G,EAAK,UAAU,KAAK,CAAE,OAAA7H,EAAQ,IAAAgB,CAAI,CAAC,EAEnC6G,EAAK,MAAM,KAAK,CAAE,OAAA7H,EAAQ,IAAAgB,CAAI,CAAC,CAEnC,CAAC,EAED,IAAMkB,EAA8B,CAAC,EAGrCA,EAAW,KAAK,GAAG2F,EAAK,UAAU,IAAI,CAAC,CAAE,IAAA7G,EAAK,OAAAhB,CAAO,IAAM,IAAI8H,GAAc9G,EAAK,GAAOhB,CAAM,CAAC,CAAC,EAGjG,IAAM+H,EAAS,MAAM,QAAQ,IAC3BF,EAAK,OAAO,IAAI,MAAO,CAAE,IAAA7G,EAAK,OAAAhB,CAAO,IAAM,CACzC,IAAMtC,EAAQ,MAAM,KAAK,UAAU,CAAE,SAAUsD,CAAI,EAAG,OAAO,EAE7D,OAAKtD,GACH,IAAIoK,GAAc9G,EAAK,GAAOhB,CAAM,EAG/B,IAAI8H,GAAcpK,EAAM,GAAI,CAAC,CAACA,GAAO,GAAIsC,EAAQtC,GAAO,OAAO,CACxE,CAAC,CACH,EACAwE,EAAW,KAAK,GAAG6F,CAAM,EAGzB,IAAMtO,EAAkB,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CACnE,MAAO,CACL,WAAY,KAAK,WACjB,UAAW,CACT,GAAIoO,EAAK,MAAM,IAAI,CAAC,CAAE,IAAA7G,CAAI,IAAMA,CAAG,CACrC,CACF,CACF,CAAC,EAEKgH,EAAkBH,EAAK,MAAM,IAAI,CAAC,CAAE,IAAA7G,CAAI,IAAMA,EAAI,QAAQ,IAAK,EAAE,CAAC,EAElEiH,EAAgB,MAAMC,GAAmBF,CAAe,EACxDG,EAAkBH,EAAgB,OACrChH,GAAQ,CAACiH,EAAc,KAAMG,GAAWA,EAAO,WAAW,SAASpH,CAAG,CAAC,CAC1E,EAEMqH,EAAS,MAAM,KAAK,OAAO,WAAW,GAAGF,CAAe,EACxDG,EAAyB,MAAM,QAAQ,IAC3CT,EAAK,MAAM,IAAI,MAAOU,GAAS,CAC7B,IAAIC,EAA4C,KAE1CJ,EAASH,EAAc,KAAMG,GAAWA,EAAO,WAAW,SAASG,EAAK,IAAI,QAAQ,IAAK,EAAE,CAAC,CAAC,EACnG,GAAIH,EACF,MAAO,CACL,OAAQ,GACR,IAAKA,EAAO,UACZ,KAAM3O,EAAS,KAAMI,GAAMA,EAAE,YAAcuO,EAAO,SAAS,GAAG,SAC9D,OAAQG,EAAK,MACf,EAIF,GAAIA,EAAK,OAAO,WAAW,IAAI,EAAG,CAChC,IAAME,EACJF,EAAK,OAAO,MAAM,EAAG,CAAC,IAAM,KAAOA,EAAK,OAAO,SAAW,GACtDA,EAAK,OACL,GAAGA,EAAK,OAAO,MAAM,EAAG,CAAC,CAAC,IAAIA,EAAK,OAAO,MAAM,CAAC,CAAC,GAClDG,EACJH,EAAK,OAAO,SAAW,GAAKA,EAAK,OAASA,EAAK,OAAO,MAAM,EAAG,CAAC,EAAIA,EAAK,OAAO,MAAM,CAAC,EAEzFC,EAAiBH,EAAO,KACrBM,GAAMA,EAAE,MAAQ,GAAGF,CAAe,mBAAqBE,EAAE,MAAQ,GAAGD,CAAkB,iBACzF,CACF,CAIA,GAAI,CAACF,IAAmBD,EAAK,OAAO,WAAW,IAAI,GAAKA,EAAK,OAAO,WAAW,IAAI,GAAI,CACrF,IAAIK,EAAS,GACTL,EAAK,OAAO,WAAW,IAAI,IAC7BK,EAAS,IAEPL,EAAK,OAAO,WAAW,IAAI,IAC7BK,EAAS,KAGX,IAAMH,EACJF,EAAK,OAAO,MAAM,EAAG,CAAC,IAAMK,GAAUL,EAAK,OAAO,SAAW,GACzDA,EAAK,OACL,GAAGA,EAAK,OAAO,MAAM,EAAG,CAAC,CAAC,GAAGK,CAAM,GAAGL,EAAK,OAAO,MAAM,CAAC,CAAC,GAC1DG,EACJH,EAAK,OAAO,SAAW,GAAKA,EAAK,OAASA,EAAK,OAAO,MAAM,EAAG,CAAC,EAAIA,EAAK,OAAO,MAAM,CAAC,EAEzFC,EAAiBH,EAAO,KACrBM,GAAMA,EAAE,MAAQ,GAAGF,CAAe,mBAAqBE,EAAE,MAAQ,GAAGD,CAAkB,iBACzF,CACF,CAEKF,IACHA,EAAiBH,EAAO,KAAMM,GAAMA,EAAE,MAAQJ,EAAK,GAAG,GAGxD,IAAMM,EAAYL,GAAgB,KAAOD,EAAK,IAE9C,MAAO,CACL,OAAQ,CAAC,CAACC,GAAgB,OAC1B,IAAKK,EACL,KAAMpP,EAAS,KAAMI,GAAMA,EAAE,YAAcgP,CAAS,GAAG,SACvD,OAAQN,EAAK,MACf,CACF,CAAC,CACH,EAEA,aAAMzO,GAAoBwO,EAAM,OAAQC,GAASA,EAAK,MAAM,EAAE,IAAKA,IAAU,CAAE,UAAWA,EAAK,GAAI,EAAE,CAAC,EAEtGrG,EAAW,KAAK,GAAGoG,CAAK,EAEjBpG,CACT,CAEA,MAAa,kBAAkBzJ,EAAsB,CACnD,GAAI,CACF,IAAMqQ,EAA4B,CAAC,EACnC,OAAArQ,EAAK,aAAa,QAASsQ,GAAS,EAC9BpL,GAAWoL,EAAK,SAAS,GAAK1F,GAAU0F,EAAK,SAAS,IACxDD,EAAK,KAAK,CACR,UAAWC,EAAK,UAChB,OAAQA,EAAK,OACb,GAAIA,EAAK,EACX,CAAC,CAEL,CAAC,EACD,MAAM,KAAK,OAAO,aAAaD,CAAI,EAC5B,CAAE,QAAS,gBAAiB,KAAM,SAAU,CACrD,OAAS1O,EAAO,CACd,MAAM,IAAIsH,EAA6B,qBAAsBtH,EAAM,SAAS,CAAC,CAC/E,CACF,CAEA,MAAa,eAAe4F,EAAgB,CAC1C,IAAMgJ,EAAa,CACjB,IAAK,CACH,UAAWhJ,CACb,EACA,WAAY,KAAK,SAAS,EAC5B,EAEM1F,EAAW,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC5D,MAAA0O,EACA,QAAS,CACP,iBAAkB,MACpB,EACA,KAAM,CACR,CAAC,EAED,GAAI1O,EAAS,SAAW,EACtB,MAAM,IAAI+J,EAAkB,oBAAoB,EAGlD,IAAI4E,EAAc3O,EAAS,IAAI,EAE/B,QAAWQ,KAAWR,EAChBQ,EAAQ,kBAAoBmO,EAAY,mBAC1CA,EAAcnO,GAIlB,OAAOmO,CACT,CAEA,MAAa,YAAYxQ,EAAsB,CAC7C,GAAI,CACF,IAAIyQ,EAAezQ,EAAK,YACpBuH,EAASvH,EAAK,KAUlB,GARI,CAACyQ,GAAgBlJ,EACnBkJ,EAAe,MAAM,KAAK,eAAelJ,CAAM,GAE/CkJ,EAAezQ,EAAK,YACpByQ,EAAa,iBAAmBA,GAAc,kBAAoB,KAAK,IAAI,EAC3ElJ,EAASkJ,GAAc,KAAK,WAG1B,CAACA,GAAgB,OAAO,KAAKA,CAAY,EAAE,SAAW,EACxD,MAAM,IAAI7E,EAAkB,wBAAwB,EAGtD,aAAM,KAAK,OAAO,WAChB,CACE,QAAS5L,EAAK,QACd,aAAc,CAACyQ,CAAY,CAC7B,EACAnH,EAAU/B,CAAM,CAClB,EAEO,CACL,OAAQA,EACR,SAAU,EACZ,CACF,OAAS5F,EAAO,CACd,MAAM,IAAIsH,EAA6B,CACrC,SAAU,GACV,QAAS,CAAC,8DAA+DtH,EAAM,SAAS,CAAC,CAC3F,CAAC,CACH,CACF,CAEA,MAAa,eAAe3B,EAAyB,CACnD,GAAI,CACF,IAAIyQ,EAAezQ,EAAK,YACpBuH,EAASvH,EAAK,KAUlB,GARI,CAACyQ,GAAgBlJ,EACnBkJ,EAAe,MAAM,KAAK,eAAelJ,CAAM,GAE/CkJ,EAAezQ,EAAK,YACpByQ,EAAa,iBAAmBA,GAAc,kBAAoB,KAAK,IAAI,EAC3ElJ,EAASkJ,GAAc,KAAK,WAG1B,CAACA,GAAgB,OAAO,KAAKA,CAAY,EAAE,SAAW,EACxD,MAAM,IAAI7E,EAAkB,wBAAwB,EAGtD,aAAM,KAAK,OAAO,WAChB,CACE,SAAU,GACV,aAAc,CAAC6E,CAAY,CAC7B,EACAnH,EAAU/B,CAAM,CAClB,EAEO,CACL,OAAQA,EACR,iBAAkB,EACpB,CACF,OAAS5F,EAAO,CACd,MAAM,IAAIsH,EAA6B,CACrC,iBAAkB,GAClB,QAAS,CAAC,kEAAmEtH,EAAM,SAAS,CAAC,CAC/F,CAAC,CACH,CACF,CAEA,MAAa,cAAc+O,EAAoB,CAC7C,GAAI,CACF,IAAMzD,EAAW,MAAM,KAAK,OAAO,YAAYyD,EAAI,UAAW,CAAE,OAAQA,CAAI,CAAC,EAC7E,GAAIzD,EAAU,CACZ,IAAMjK,EAAYiK,EAAS,SAAS,iBAAiB,KAAK,GAC1D,GAAIjK,EAAW,CACb,IAAM2N,EAAmB7R,EAAc,IAAc,UAAU,EAAE,YAAY,uBACzEuD,EAAU,MAAM,KAAK,iBAAiB,QAAQ,UAAU,CAC1D,MAAO,CACL,IAAK,CACH,KAAM,CAAC,IAAI,EACX,OAAQW,CACV,CACF,CACF,CAAC,EACD,GAAI2N,EAAkB,CACpB,GAAI,CAACtO,EAAS,OAAO4K,EACrB,IAAM2D,EAAc,OAAOvO,GAAS,KAAQ,UAAYA,EAAQ,MAAQ,KAAOA,EAAQ,IAAM,CAAC,EAC9FA,EAAU,MAAM,KAAK,iBAAiB,QAAQ,OAAO,CACnD,MAAO,CAAE,GAAIA,EAAQ,EAAG,EACxB,KAAM,CACJ,IAAK,CACH,GAAGuO,EACH,QAAS,EACX,EACA,OAAQ,SACV,CACF,CAAC,CACH,MACE,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC7C,MAAO,CACL,GAAIvO,EAAQ,EACd,CACF,CAAC,EAEH,KAAK,kCAAwC,CAC3C,GAAIA,EAAQ,GACZ,WAAYA,EAAQ,WACpB,IAAKA,EAAQ,IACb,YAAaA,EAAQ,YACrB,OAAQ,UACR,OAAQA,EAAQ,OAChB,iBAAkBA,EAAQ,iBAC1B,SAAUA,EAAQ,SAClB,YAAaA,EAAQ,YACrB,QAASA,EAAQ,OACnB,CAAC,CACH,CACF,CAEA,OAAO4K,CACT,OAAStL,EAAO,CACd,MAAM,IAAIsH,EAA6B,4CAA6CtH,GAAO,SAAS,CAAC,CACvG,CACF,CAEA,MAAa,0BAA0B3B,EAAoC6Q,EAAY,GAAO,CAC5F,GAAI,CACF,IAAMpG,EAAIzK,GAAM,QACV8Q,EAAe9Q,GAAM,cAAgB,GAErC0C,EAAM+H,GAAG,QAAUA,EAAM,MAAM,KAAK,WAAWA,EAAE,IAAK,EAAI,EAEhE,GAAI,CAAC/H,EACH,KAAM,oBAGR,QAAWqO,KAAWC,GAChBtO,EAAI,QAAQqO,CAAO,IACrBrO,EAAI,QAAUA,EAAI,QAAQqO,CAAO,EAAE,SAIvC,IAAI7E,EACAzI,EAEJ,QAAWd,KAAQsO,GAEjB,GADA/E,EAAexJ,EAAI,QAAQC,CAAI,EAC3BuJ,EAAc,CAChBzI,EAAYd,EACZ,KACF,CAGF,GAAI,CAACuJ,EACH,KAAM,uCAGJ,OAAOA,EAAa,UAAgB,WACtCxJ,EAAI,QAAU,KAAK,MAAM,KAAK,UAAUA,EAAI,OAAO,CAAC,GAGtD,IAAMjD,EAAS,MAAMyE,GACnB,CAAE,IAAKxB,GAAK,IAAK,QAASA,GAAK,OAAQ,EACvC,SACA,CAAC,EACD,CACE,OAAQyB,GAAE,CAAE,MAAO,OAAQ,CAAC,EAC5B,gBAAiB,KAAK,OAAO,kBAC/B,CACF,EACM+M,EAAcC,GAAezO,EAAI,OAAO,EAExC0O,EAAMxN,GAAU,UAAUsI,GAAe,QAAW,EACpDxI,EAAWwI,GAAe,UAAe,GAAGxJ,EAAI,IAAI,EAAE,IAAI0O,CAAG,IAAM,GAAGnC,EAAG,CAAC,IAAImC,CAAG,GAEvF,GAAIN,GAAgBI,IAAgB,eAClC,GAAI,CACF,IAAMnF,EAAU,MAAM,KAAK,gBAAgBtM,EAAO,SAAS,QAAQ,CAAC,EAEpE,GAAI,OAAO,SAASsM,CAAO,EAezB,MAde,CACb,UAAAtI,EACA,SAAAC,EACA,QAASwI,EAAa,QACtB,KAAM,CACJ,WAAYA,EAAa,WACzB,OAAQA,EAAa,OACrB,MAAOA,EAAa,KACtB,EACA,SAAU,YACV,OAAQH,EAAQ,SAAS,QAAQ,EACjC,OAAQ8E,EAAY9E,EAAU,IAChC,CAIJ,OAASpK,EAAO,CACd,WAAK,OAAO,MAAM,gCAAgC,EAClD,KAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB,gCAAgC,CAChE,CAGF,MAAO,CACL,UAAAjG,EACA,SAAAC,EACA,QAASwI,EAAa,QACtB,KAAM,CACJ,WAAYA,EAAa,WACzB,OAAQA,EAAa,OACrB,MAAOA,EAAa,KACtB,EACA,SAAUA,EAAa,SACvB,OAAQzM,EAAO,SAAS,QAAQ,EAChC,OAAQoR,EAAYpR,EAAS,IAC/B,CACF,OAASkC,EAAO,CACd,WAAK,OAAO,MAAM,iCAAiC,EACnD,KAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAEA,MAAa,sBAAuB,CAClC,IAAM0P,EAAU,MAAM,KAAK,OAAO,qBAAqB,EAEvD,MAAO,CACL,aAAcA,EAAQ,aACtB,QAASA,EAAQ,QACjB,OAAQA,EAAQ,OAChB,OAAQA,EAAQ,OAChB,KAAMA,EAAQ,KACd,SAAUA,EAAQ,QACpB,CACF,CAEA,MAAa,sBAAsBxO,EAA6B,CAC9D,GAAI,CACF,aAAM,KAAK,OAAO,0BAA0BA,EAAS,YAAY,EACjE,MAAM,KAAK,OAAO,4BAA4BA,EAAS,OAAO,EAC9D,MAAM,KAAK,OAAO,oBAAoBA,EAAS,MAAM,EACrD,MAAM,KAAK,OAAO,oBAAoBA,EAAS,MAAM,EACrD,MAAM,KAAK,OAAO,sBAAsBA,EAAS,IAAI,EACrD,MAAM,KAAK,OAAO,uBAAuBA,EAAS,QAAQ,EAE1D,KAAK,iBAAiB,EAEf,CACL,OAAQ,UACR,KAAM,CACJ,aAAcA,EAAS,aACvB,QAASA,EAAS,QAClB,OAAQA,EAAS,OACjB,OAAQA,EAAS,OACjB,KAAMA,EAAS,KACf,SAAUA,EAAS,QACrB,CACF,CACF,OAASlB,EAAO,CACd,MAAM,IAAIsH,EAA6B,kCAAmCtH,EAAM,SAAS,CAAC,CAC5F,CACF,CAEA,MAAa,qBAAqB4F,EAAyC,CACzE,GAAI,CACF,IAAMgB,EAAMhB,EAAS+B,EAAU/B,CAAM,EAAI,KAAK,SAAS,KAEjD+J,EAAU,MAAM,KAAK,OAAO,mBAAmB/I,CAAG,EAExD,OAAK+I,EAUE,CACL,WAAY,GACZ,GAAGA,CACL,EAVS,CACL,WAAY,GACZ,QAAS,0BACT,IALW,MAAM,KAAK,eAAe,CAAE,QAAS,CAAC/I,CAAG,CAAE,CAAC,IAK9C,MAAM,CACjB,CAOJ,OAAS5G,EAAO,CACd,MAAM,IAAIsH,EAA6B,8BAA+BtH,EAAM,SAAS,CAAC,CACxF,CACF,CAEA,MAAa,kBAAkB4P,EAAc,CAC3C,GAAI,CACF,aAAM,KAAK,OAAO,kBAAkBA,CAAI,EAEjC,CAAE,OAAQ,SAAU,CAC7B,OAAS5P,EAAO,CACd,MAAM,IAAIsH,EAA6B,8BAA+BtH,EAAM,SAAS,CAAC,CACxF,CACF,CAEA,MAAa,oBAAoB4B,EAAgB,CAC/C,GAAI,CACF,aAAM,KAAK,OAAO,oBAAoBA,CAAM,EAErC,CAAE,OAAQ,SAAU,CAC7B,OAAS5B,EAAO,CACd,MAAM,IAAIsH,EAA6B,gCAAiCtH,EAAM,SAAS,CAAC,CAC1F,CACF,CAEA,MAAa,qBAAqBiI,EAAiB,CACjD,GAAI,CACF,IAAI4H,EACJ,GAAInF,GAAMzC,CAAO,EAAG,CAClB,IAAMmD,EAAY,IAAI,KAAK,EAAE,QAAQ,EAC/BC,EAAM,GAAGpD,CAAO,cAAcmD,CAAS,GAEzCR,EAAc,CAChB,aAAc,aAChB,EAEI,KAAK,YAAY,UACnBA,EAAS,CACP,GAAGA,EACH,WAAYnE,GAAe,CACzB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,CACH,GAGFoJ,GAAO,MAAMvJ,GAAM,IAAI+E,EAAKT,CAAM,GAAG,IACvC,SAAWM,GAASjD,CAAO,EACzB4H,EAAM,OAAO,KAAK5H,EAAS,QAAQ,MAEnC,OAAM,IAAIF,EAAoB,4CAA4C,EAG5E,aAAM,KAAK,OAAO,qBAAqB,KAAK,SAAS,KAAM8H,CAAG,EAE9D,KAAK,iBAAiB,EAEf,CAAE,OAAQ,SAAU,CAC7B,OAAS7P,EAAO,CACd,MAAM,IAAIsH,EAA6B,iCAAkCtH,EAAM,SAAS,CAAC,CAC3F,CACF,CAEA,MAAa,sBAAuB,CAClC,GAAI,CACF,aAAM,KAAK,OAAO,qBAAqB,KAAK,SAAS,IAAI,EAEzD,KAAK,iBAAiB,EAEf,CAAE,OAAQ,SAAU,CAC7B,OAASA,EAAO,CACd,MAAM,IAAIsH,EAA6B,iCAAkCtH,EAAM,SAAS,CAAC,CAC3F,CACF,CAEA,MAAa,UAAU3B,EAAoB,CACzC,GAAI,CACF,GAAM,CAAE,OAAAuH,CAAO,EAAIvH,EAEbyL,GAAQ,MAAM,KAAK,eAAe,CAAE,QAAS,CAAClE,CAAM,CAAE,CAAC,IAAI,MAAM,EAEvE,GAAI,CAACkE,EAAK,QAAU,CAACvG,GAAWuG,EAAK,GAAG,GAAK,CAACA,EAAK,IAAI,SAAS,YAAY,EAC1E,MAAM,IAAI/B,EAAoB+B,CAAI,EAGpC,IAAMvB,EAASuB,EAAK,IAEpB,aAAM,KAAK,OAAO,kBAAkBvB,EAAQlK,EAAK,MAAM,EAEhD,CAAE,MAAO,SAAU,CAC5B,OAAS2B,EAAO,CACd,MAAM,IAAIsH,EAA6B,sBAAuBtH,EAAM,SAAS,CAAC,CAChF,CACF,CAEA,MAAc,oBAAoB3B,EAAwB,CACxD,GAAI,CACF,IAAM0C,EAAW,MAAM,KAAK,WAAW1C,EAAK,IAAK,EAAI,EAErD,OAAI0C,GAAK,cAAgB,gBAAkBA,GAAK,cAAgB,sBACvD,CACL,KAAM1C,EAAK,IACb,EAGE0C,GAAK,cAAgB,eAChB,CACL,MAAOA,GAAK,SAAS,aACrB,QAAS1C,EAAK,IAChB,EAGE0C,GAAK,cAAgB,eAChB,CACL,MAAOA,GAAK,SAAS,aACrB,QAAS1C,EAAK,IAChB,EAGK,IACT,OAAS2B,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAEA,MAAa,cAAc3B,EAAwB,CACjD,IAAMuI,EAAMe,EAAUtJ,EAAK,MAAM,EAE3B+H,EAAU,MAAM,KAAK,oBAAoB/H,CAAI,EAEnD,GAAI,CAAC+H,EACH,WAAK,OAAO,MAAM,wBAAwB,EACpC,IAAI2B,EAAoB,wBAAwB,EAGxD,GAAI,CACF,OAAO,MAAM,KAAK,OAAO,YAAYnB,EAAK,CACxC,GAAIR,EACJ,KAAM/H,EAAK,GACb,CAAC,CACH,OAAS2B,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI+H,EAAoB/H,EAAM,SAAS,CAAC,CAChD,CACF,CAEA,MAAa,aAAmC,CAO9C,OANe,MAAM,KAAK,iBAAiB,MAAM,SAAS,CACxD,MAAO,CACL,WAAY,KAAK,UACnB,CACF,CAAC,GAEa,IAAKyD,IAAW,CAC5B,MAAOA,EAAM,MACb,KAAMA,EAAM,KACZ,GAAIA,EAAM,QACV,aAAcA,EAAM,YACtB,EAAE,CACJ,CAEA,MAAa,YAAYpF,EAAsB,CAC7C,IAAMyR,EAAkB,MAAM,KAAK,eAAe,CAAE,QAAS,CAACzR,EAAK,MAAM,CAAE,CAAC,EAC5E,GAAIyR,EAAgB,SAAW,EAC7B,MAAM,IAAI7F,EAAkB,kBAAkB,EAEhD,IAAM1K,EAAUuQ,EAAgB,CAAC,EACjC,GAAI,CAACvQ,EAAQ,OACX,MAAM,IAAI0K,EAAkB,2BAA2B,EAGzD,GAAI,CACF,GAAI5L,EAAK,SAAW,MAClB,aAAM,KAAK,OAAO,aAAakB,EAAQ,IAAKlB,EAAK,OAAO,EACxD,MAAM,KAAK,SAASA,EAAK,QAAS,KAAK,WAAYkB,EAAQ,GAAG,EAEvD,CAAE,UAAWA,EAAQ,IAAK,QAASlB,EAAK,QAAS,IAAK,EAAK,EAEpE,GAAIA,EAAK,SAAW,SAClB,aAAM,KAAK,OAAO,gBAAgBkB,EAAQ,IAAKlB,EAAK,OAAO,EAC3D,MAAM,KAAK,YAAYA,EAAK,QAAS,KAAK,WAAYkB,EAAQ,GAAG,EAE1D,CAAE,UAAWA,EAAQ,IAAK,QAASlB,EAAK,QAAS,OAAQ,EAAK,CAEzE,OAAS2B,EAAO,CACd,MAAM,IAAI+H,EAAoB,aAAa1J,EAAK,MAAM,iBAAkB2B,EAAM,SAAS,CAAC,CAC1F,CACF,CAGA,MAAc,yBAAyBkE,EAAkB,CACvD,GAAI,CACF,IAAME,EAAO,MAAM,KAAK,OAAO,cAAcF,CAAQ,EAE/CC,EAAY,KAAK,cAAc,IAAe,OAAO,EAE3D,OAAKA,GAAW,OAAO,SAAWA,GAAW,OAAO,MAAQ,IAAOA,GAAW,OAAO,WACnF,KAAK,OAAO,QAAQ,6BAA6BD,CAAQ,EAAE,EAC3D,MAAMlH,GAAmB,IAAIkH,EAAU,CACrC,UAAW,KAAK,IAAI,EACpB,KAAME,CACR,CAAC,GAGIA,CACT,OAASpE,EAAO,CACd,YAAK,OAAO,MAAMA,CAAK,EAChB,IACT,CACF,CA0BA,MAAa,YAAY+P,EAAwB,CAC/C,GAAI,CACF,IAAMC,GAAgB,MAAM,KAAK,eAAe,CAAE,QAASD,EAAO,YAAa,CAAC,GAC7E,OAAQ7F,GAAgBA,EAAY,MAAM,EAC1C,IAAKA,GAAgBA,EAAY,GAAG,EACjC,CAAE,GAAAlB,CAAG,EAAI,MAAM,KAAK,OAAO,YAAY+G,EAAO,QAASC,CAAY,EAEzE,OAAID,GAAQ,aACV,MAAM,KAAK,OAAO,uBAAuB/G,EAAI+G,EAAO,WAAW,EAG7DA,GAAQ,qBACV,MAAM,KAAK,mBAAmB,CAC5B,SAAU/G,EACV,OAAQ,UACR,aAAcgH,CAChB,CAAC,EAGW,MAAM,KAAK,OAAO,cAAchH,CAAE,CAGlD,OAAShJ,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAIsH,EAA6B,uBAAwBtH,EAAM,SAAS,CAAC,CACjF,CACF,CAEA,MAAa,mBAAmBiI,EAA0B,CACxD,GAAI,CACF,IAAI4H,EACJ,GAAInF,GAAMzC,EAAQ,KAAK,EAAG,CACxB,IAAMmD,EAAY,IAAI,KAAK,EAAE,QAAQ,EAC/BC,EAAM,GAAGpD,EAAQ,KAAK,cAAcmD,CAAS,GAE/CR,EAAc,CAChB,aAAc,aAChB,EAEI,KAAK,YAAY,UACnBA,EAAS,CACP,GAAGA,EACH,WAAYnE,GAAe,CACzB,KAAM,KAAK,WAAW,KACtB,KAAM,KAAK,WAAW,KACtB,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,SAC1B,SAAU,KAAK,WAAW,QAC5B,CAAC,CACH,GAGFoJ,GAAO,MAAMvJ,GAAM,IAAI+E,EAAKT,CAAM,GAAG,IACvC,SAAWM,GAASjD,EAAQ,KAAK,EAC/B4H,EAAM,OAAO,KAAK5H,EAAQ,MAAO,QAAQ,MAEzC,OAAM,IAAIF,EAAoB,4CAA4C,EAE5E,aAAM,KAAK,OAAO,qBAAqBE,EAAQ,SAAU4H,CAAG,EAErD,CAAE,OAAQ,SAAU,CAC7B,OAAS7P,EAAO,CACd,MAAM,IAAIsH,EAA6B,6BAA8BtH,EAAM,SAAS,CAAC,CACvF,CACF,CAEA,MAAa,mBAAmB3B,EAAuB,CACrD,GAAI,CACF,aAAM,KAAK,OAAO,mBAAmBA,EAAK,SAAUA,EAAK,OAAO,EAEzD,CAAE,OAAQ,SAAU,CAC7B,OAAS2B,EAAO,CACd,MAAM,IAAIsH,EAA6B,+BAAgCtH,EAAM,SAAS,CAAC,CACzF,CACF,CAEA,MAAa,uBAAuB3B,EAA2B,CAC7D,GAAI,CACF,aAAM,KAAK,OAAO,uBAAuBA,EAAK,SAAUA,EAAK,WAAW,EAEjE,CAAE,OAAQ,SAAU,CAC7B,OAAS2B,EAAO,CACd,MAAM,IAAIsH,EAA6B,mCAAoCtH,EAAM,SAAS,CAAC,CAC7F,CACF,CAEA,MAAa,UAAUgJ,EAAciH,EAAyB,MAAO,CACnE,GAAI,CACF,IAAM3M,EAAQ,MAAM,KAAK,OAAO,cAAc0F,EAAG,QAAQ,EAEzD,GAAI,CAAC1F,EACH,YAAK,OAAO,MAAM,iBAAiB,EAC5B,KAGT,IAAM2E,EAAU,MAAM,KAAK,eAAe3E,EAAM,EAAE,EAElD,MAAO,CACL,GAAIA,EAAM,GACV,QAASA,EAAM,QACf,aAAcA,EAAM,aACpB,YAAaA,EAAM,YACnB,WAAY2E,EAAQ,kBACpB,KAAM3E,EAAM,aAAa,OACzB,SAAUA,EAAM,SAChB,MAAOA,EAAM,MACb,KAAMA,EAAM,KACZ,OAAQA,EAAM,OACd,SAAUA,EAAM,SAChB,SAAUA,EAAM,SAChB,aAAcA,EAAM,aACpB,YAAaA,EAAM,YACnB,oBAAqBA,EAAM,oBAC3B,aAAcA,EAAM,YACtB,CACF,OAAStD,EAAO,CACd,GAAIiQ,IAAU,QACZ,OAEF,MAAM,IAAIhG,EAAkB,uBAAwBjK,EAAM,SAAS,CAAC,CACtE,CACF,CAEA,MAAa,eAAekQ,EAAiC,CAC3D,IAAMC,EAAQ,OAAO,OAAO,MAAM,MAAM,QAAQ,2BAA2B,CAAC,EAExExC,EAAS,CAAC,EACd,QAAWrK,KAAS6M,EAAO,CACzB,IAAMlI,EAAU,MAAM,KAAK,eAAe3E,EAAM,EAAE,EAE5CvF,EAAS,CACb,GAAIuF,EAAM,GACV,QAASA,EAAM,QACf,aAAcA,EAAM,aACpB,YAAaA,EAAM,YACnB,WAAY2E,GAAS,kBACrB,KAAM3E,EAAM,aAAa,OACzB,SAAUA,EAAM,SAChB,MAAOA,EAAM,MACb,KAAMA,EAAM,KACZ,OAAQA,EAAM,OACd,SAAUA,EAAM,SAChB,SAAUA,EAAM,SAChB,YAAaA,EAAM,YACnB,oBAAqBA,EAAM,oBAC3B,aAAcA,EAAM,YACtB,EAEI4M,EAAgB,iBAAmB,SACrCnS,EAAO,aAAkBuF,EAAM,cAGjCqK,EAAS,CAAC,GAAGA,EAAQ5P,CAAM,CAC7B,CAEA,OAAO4P,CACT,CAEA,MAAa,WAAW3E,EAAc,CACpC,GAAI,CACF,IAAMqD,EAAO,MAAM,KAAK,OAAO,gBAAgBrD,EAAG,QAAQ,EAC1D,MAAO,CAAE,UAAW,6BAA6BqD,CAAI,GAAI,WAAYA,CAAK,CAC5E,OAASrM,EAAO,CACd,MAAM,IAAIiK,EAAkB,iBAAkBjK,EAAM,SAAS,CAAC,CAChE,CACF,CAEA,MAAa,WAAWgJ,EAAiB,CACvC,GAAI,CACF,OAAO,MAAM,KAAK,OAAO,mBAAmBA,EAAG,UAAU,CAC3D,MAAgB,CACd,MAAM,IAAIiB,EAAkB,iBAAkBjB,EAAG,UAAU,CAC7D,CACF,CAEA,MAAa,WAAWA,EAAqB,CAC3C,GAAI,CAGF,IAAMoH,GAFa,MAAM,KAAK,WAAW,CAAE,SAAUpH,EAAG,QAAS,CAAC,GAErC,UAEvBqH,EAAUrH,EAAG,QAAQ,IAAKpD,GAAW+B,EAAU/B,CAAM,CAAC,EAKtDlF,EAAU,CACd,aAHU,GAFQsI,EAAG,aAAe,EAEZ;AAAA;AAAA,EAAOoH,CAAS,EAI1C,EAEA,cAAiBxK,KAAUyK,EACzB,MAAM,KAAK,sBAAsBzK,EAAQlF,CAAO,EAGlD,MAAO,CAAE,KAAM,GAAM,UAAA0P,CAAU,CACjC,MAAgB,CACd,MAAM,IAAInG,EAAkB,gBAAgB,CAC9C,CACF,CAEA,MAAa,iBAAiBjB,EAAuB,CACnD,GAAI,CAEF,MAAO,CAAE,SAAU,GAAM,SADR,MAAM,KAAK,OAAO,kBAAkBA,EAAG,UAAU,CACtB,CAC9C,OAAShJ,EAAO,CACd,MAAM,IAAIiK,EAAkB,sBAAuBjK,EAAM,SAAS,CAAC,CACrE,CACF,CAEA,MAAa,iBAAiBgJ,EAAc,CAC1C,GAAI,CAEF,MAAO,CAAE,QAAS,GAAM,WADL,MAAM,KAAK,OAAO,kBAAkBA,EAAG,QAAQ,CAC/B,CACrC,OAAShJ,EAAO,CACd,MAAM,IAAIiK,EAAkB,eAAgBjK,EAAM,SAAS,CAAC,CAC9D,CACF,CAEA,MAAa,iBAAiBgJ,EAAc,CAC1C,GAAI,CACF,IAAMgH,GAAgB,MAAM,KAAK,OAAO,cAAchH,EAAG,QAAQ,GAAG,aAC9D3J,EAAW,MAAM,KAAK,iBAAiB,QAAQ,SAAS,CAC5D,MAAO,CACL,WAAY,KAAK,WACjB,UAAW,CACT,GAAI2Q,EAAa,IAAKM,GAAMA,EAAE,EAAE,CAClC,CACF,CACF,CAAC,EACKC,EAAqBP,EAAa,IAAK9F,GAAgB,CAC3D,IAAM3K,EAAUF,EAAS,KAAM,GAAM,EAAE,YAAc6K,EAAY,EAAE,EACnE,MAAO,CACL,GAAGA,EACH,KAAMA,EAAY,MAAQ3K,GAAS,SACnC,OAAQ2K,EAAY,QAAU3K,GAAS,aACzC,CACF,CAAC,EAEKC,EAAgB+Q,EAAmB,OAAQ9Q,GAAMA,EAAE,GAAG,SAAS,aAAa,CAAC,EACnF,OAAID,GACF,MAAME,GAAoBF,EAAc,IAAKC,IAAO,CAAE,UAAWA,EAAE,EAAG,EAAE,CAAC,EAGpE,CAAE,aAAc8Q,CAAmB,CAC5C,OAASvQ,EAAO,CACd,cAAQ,MAAMA,CAAK,EACb,IAAIiK,EAAkB,kBAAmBjK,EAAM,SAAS,CAAC,CACjE,CACF,CAEA,MAAa,mBAAmBH,EAAmC,CACjE,GAAI,CACF,IAAMmQ,EAAenQ,EAAO,aAAa,IAAKyQ,GAAM3I,EAAU2I,CAAC,CAAC,EAMhE,MAAO,CAAE,mBALkB,MAAM,KAAK,OAAO,wBAC3CzQ,EAAO,SACPmQ,EACAnQ,EAAO,MACT,CACgD,CAClD,OAASG,EAAO,CACd,MAAM,IAAI+H,EAAoB,8BAA+B/H,EAAM,SAAS,CAAC,CAC/E,CACF,CAEA,MAAa,eAAeH,EAA+B,CACzD,GAAI,CAEF,MAAO,CAAE,cADa,MAAM,KAAK,OAAO,mBAAmBA,EAAO,SAAUA,EAAO,MAAM,CACnD,CACxC,OAASG,EAAO,CACd,MAAM,IAAI+H,EAAoB,yBAA0B/H,EAAM,SAAS,CAAC,CAC1E,CACF,CAEA,MAAa,gBAAgBH,EAAiC,CAC5D,GAAI,CACF,aAAM,KAAK,OAAO,qBAAqBA,EAAO,SAAUA,EAAO,UAAU,EAClE,CAAE,QAAS,EAAK,CACzB,OAASG,EAAO,CACd,MAAM,IAAI+H,EAAoB,yBAA0B/H,EAAM,SAAS,CAAC,CAC1E,CACF,CAEA,MAAa,WAAWgJ,EAAc,CACpC,GAAI,CACF,aAAM,KAAK,OAAO,WAAWA,EAAG,QAAQ,EACjC,CAAE,SAAUA,EAAG,SAAU,MAAO,EAAK,CAC9C,OAAShJ,EAAO,CACd,MAAM,IAAI+H,EAAoB,4BAA6B/H,EAAM,SAAS,CAAC,CAC7E,CACF,CAEA,MAAa,iBAAkB,CAC7B,MAAM,IAAI,MAAM,6CAA6C,CAC/D,CAEQ,eAAeU,EAAqC,CAC1D,IAAM8P,EAAchB,GAAe9O,EAAQ,OAAO,EAC5C+P,EAAa/P,GAAS,QAAQ8P,CAAW,EAEzChP,EAAa,CACjB,IAAKd,EAAQ,IACb,SAAUA,EAAQ,SAClB,OAAQkB,GAAOlB,EAAQ,MAAM,EAC7B,QAAS,CAAE,GAAGA,EAAQ,OAAQ,EAC9B,YAAa+P,GAAY,YACzB,YAAaD,GAAe,UAC5B,iBAAkB9P,EAAQ,iBAC1B,WAAY,KAAK,WACjB,OAAQgQ,GAAUhQ,EAAQ,IAAI,EAAE,CAClC,EAEI,CAACc,EAAW,QAAUd,EAAQ,IAAI,SAAW,KAC/Cc,EAAW,OAASI,GAAO,CAAC,GAG1BJ,EAAW,QAAQ,sBACrBA,EAAW,YAAc,eACzBA,EAAW,QAAQ,aAAeA,EAAW,QAAQ,oBAAoB,KACzE,OAAOA,EAAW,QAAQ,qBAGxBA,EAAW,QAAQ,6BACrBA,EAAW,YAAc,kBACzBA,EAAW,QAAQ,gBAAkBA,EAAW,QAAQ,2BAA2B,QAAQ,gBAC3F,OAAOA,EAAW,QAAQ,4BAG5B,IAAMmP,EAAgBnP,GAAY,aAAa,cAC/C,OAAImP,IACEA,EAAc,sBAChBA,EAAc,aAAeA,EAAc,oBAAoB,KAC/D,OAAOA,EAAc,qBAGnBA,EAAc,6BAChBA,EAAc,gBAAkBA,EAAc,2BAA2B,QAAQ,gBACjF,OAAOA,EAAc,6BAIlBnP,CACT,CAEA,MAAc,0BAA2B,CACvC,GAAI,KAAK,cAAc,IAAc,UAAU,EAAE,SAAW,KAAK,eAAe,QAAS,CACvF,IAAMoP,EAAiB,MAAM,KAAK,aAAa,EACzCC,EAAWnQ,GAAiB,KAAK,eAAeA,CAAO,EAC7D,KAAK,gBAAgB,iBAAiB,CAAE,aAAc,KAAK,SAAS,IAAK,EAAGkQ,EAAgBC,CAAO,EAEtFC,GAAK,SAAS,eAAgB,SAAY,CACrD,KAAK,gBAAgB,iBAAiB,CAAE,aAAc,KAAK,SAAS,IAAK,EAAGF,EAAgBC,CAAO,CACrG,CAAC,EACI,MAAM,CACb,CACF,CAEA,MAAc,gCAAgC1N,EAAmBiI,EAAqC,CACpG,GAA+BA,GAAc,KAAM,MAAO,GAE1D,IAAMrN,EAAS,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAC5D,MAAO,CACL,IAAK,CACH,CAAE,IAAK,CAAE,KAAM,CAAC,WAAW,EAAG,OAAQoF,CAAU,CAAE,EAClD,CAAE,IAAK,CAAE,KAAM,CAAC,QAAQ,EAAG,OAAQ,EAAM,CAAE,EAC3C,CAAE,iBAAkB,CAAE,IAAKiI,CAAU,CAAE,EACvC,CACE,GAAI,CAAC,CAAE,OAAQ,IAAK,EAAG,CAAE,OAAQxJ,GAAO,CAAC,CAAE,CAAC,CAC9C,CACF,CACF,EACA,KAAM,CAAE,OAAQA,GAAO,CAAC,CAAE,CAC5B,CAAC,EAED,OAAI7D,GACEA,EAAO,MAAQ,GACjB,KAAK,yBAAyBoF,CAAS,EAGlCpF,EAAO,OAGT,CACT,CAEA,MAAc,yBAAyBoF,EAAoC,CACzE,GAAM,CAACjE,EAAM6R,CAAc,EAAI,MAAM,QAAQ,IAAI,CAC/C,KAAK,iBAAiB,KAAK,UAAU,CAAE,MAAO,CAAE,UAAA5N,CAAU,CAAE,CAAC,EAC7D,KAAK,iBAAiB,QAAQ,MAAM,CAClC,MAAO,CACL,IAAK,CACH,CAAE,IAAK,CAAE,KAAM,CAAC,WAAW,EAAG,OAAQA,CAAU,CAAE,EAClD,CAAE,IAAK,CAAE,KAAM,CAAC,QAAQ,EAAG,OAAQ,EAAM,CAAE,EAC3C,CAAE,OAAQ,CAAE,OAAQvB,GAAO,CAAC,CAAE,CAAE,CAClC,CACF,CACF,CAAC,CACH,CAAC,EAED,OAAI1C,GAAQA,EAAK,iBAAmB6R,GAClC,MAAM,KAAK,iBAAiB,KAAK,OAAO,CACtC,MAAO,CAAE,GAAI7R,EAAK,EAAG,EACrB,KAAM,CAAE,eAAA6R,CAAe,CACzB,CAAC,EAGIA,CACT,CAEA,MAAc,SAAS9M,EAAiBF,EAAoBC,EAAgB,CAC1E,IAAMgF,EAAKgI,GAAK,EAEhB,MAAM,KAAK,iBAAiB,kBAC1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gCAaA/M,EACAF,EACAC,EACAgF,CACF,CACF,CAEA,MAAc,YAAY/E,EAAiBF,EAAoBC,EAAgB,CAC7E,IAAMgF,EAAKgI,GAAK,EAEhB,MAAM,KAAK,iBAAiB,kBAC1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gCAaA/M,EACAF,EACAC,EACAgF,CACF,CACF,CAEA,MAAa,kBAAkBpC,EAAa,CAG1C,OAFiB,MAAM,KAAK,OAAO,WAAWA,CAAG,CAGnD,CAEA,MAAa,yBAAyBA,EAAa5F,EAA2BiQ,EAAmB,CAG/F,OAFiB,MAAM,KAAK,OAAO,kBAAkBrK,EAAK5F,EAAMiQ,CAAS,CAG3E,CAEA,MAAa,sBAAsBxD,EAAgByD,EAAgB,CAGjE,OAFiB,MAAM,KAAK,OAAO,eAAezD,EAAMyD,CAAK,CAG/D,CAEA,MAAa,8BAA8BzD,EAAgB/M,EAAyByQ,EAAiB,CACnG,IAAM7F,EAAW,MAAM,KAAK,OAAO,uBAAuBmC,EAAM/M,EAASyQ,CAAU,EAanF,MAX0B,CACxB,GAAG7F,EACH,MAAOA,EAAS,MAAM,IAAK8F,IAAe,CACxC,GAAGA,EACH,QAASA,EAAK,SAAS,IAAK3R,IAAY,CACtC,GAAGA,EACH,QAASA,EAAE,mBAAmB,WAAa,OAAO,KAAKA,EAAE,OAAO,EAAE,SAAS,QAAQ,EAAIA,EAAE,OAC3F,EAAE,CACJ,EAAE,CACJ,CAGF,CAEA,MAAa,gBAAgB4R,EAAa,CACxC,eAAQ,IAAI,SAAU,KAAK,UAAUA,CAAM,CAAC,EAC3B,MAAM,KAAK,OAAO,SAASA,CAAM,CAGpD,CAEA,MAAa,uBAAuB5D,EAAgB6D,EAAmBC,EAA4B,CAGjG,OAFiB,MAAM,KAAK,OAAO,gBAAgB9D,EAAM6D,EAAUC,CAAiB,CAGtF,CAEA,MAAa,2BAA4B,CAGvC,OAFiB,MAAM,KAAK,OAAO,mBAAmB,CAGxD,CAEA,MAAa,sCAAsC3K,EAAa5F,EAAuBwQ,EAAoB,CACzG,GAAI,CACF,IAAMC,EAAmB,OAAO,KAAKD,EAAY,QAAQ,EAEnDlG,EAAW,MAAM,KAAK,OAAO,iBAAiB,eAAe,CACjE,IAAA1E,EACA,KAAA5F,EACA,WAAYyQ,CACd,CAAC,EAED,OAAOnG,aAAoB,WAAa,OAAO,KAAKA,CAAQ,EAAE,SAAS,QAAQ,EAAIA,CACrF,OAAStL,EAAO,CACd,WAAK,OAAO,MAAM,2BAA2B,EAC7C,KAAK,OAAO,MAAMA,CAAK,EACjBA,CACR,CACF,CAEA,MAAa,qBAAsB,CAMjC,MALiB,CACf,GAAI,KAAK,OAAO,UAAU,MAAM,GAChC,QAAS,KAAK,OAAO,UAAU,MAAM,OACvC,CAGF,CACF,EO55IO,IAAM0R,GAAN,KAAwB,CAI7B,YAAYC,EAAoCC,EAAgC,CAC9E,KAAK,OAASD,EACd,KAAK,QAAUC,CACjB,CAEA,IAAW,OAAOC,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEA,IAAW,QAAQD,EAAgC,CACjD,KAAK,UAAYA,CACnB,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,SACd,CAEO,KAAKE,EAA2BC,EAAuB,CAC5D,GAAI,CAACD,EAAa,OAASA,EAAa,cAAgBE,EAAY,kBAClE,MAAM,IAAIC,EAAoB,mBAAmB,EAGnD,OAAIH,EAAa,cAAgBE,EAAY,kBACpC,IAAIE,GACTH,EAAK,cACLA,EAAK,aACLA,EAAK,iBACLA,EAAK,MACLA,EAAK,cACLA,EAAK,aACLA,EAAK,aACP,EAGED,EAAa,cAAgBE,EAAY,UACpC,IAAIG,GACTJ,EAAK,cACLA,EAAK,aACLA,EAAK,iBACLA,EAAK,MACLA,EAAK,aACP,EAGED,EAAa,cAAgBE,EAAY,iBACpC,IAAII,GACTL,EAAK,cACLA,EAAK,aACLA,EAAK,iBACLA,EAAK,MACLA,EAAK,cACLA,EAAK,aACLA,EAAK,aACP,EAGK,IACT,CACF,ECxFO,IAAMM,GAAN,cAAkCC,EAAwD,CAG/F,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,CAAS,EAHnC,KAAiB,OAAS,IAAIC,EAAO,qBAAqB,CAI1D,CAIA,MAAa,eAAeC,EAAW,CACrC,IAAMC,EAAWD,EAAK,SAEtB,GAAI,CAACC,EAAU,CACb,KAAK,OAAO,MAAM,iEAAiE,EACnF,MACF,CAEA,IAAMC,EAAW,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAC9D,MAAO,CAAE,OAAQD,CAAS,CAC5B,CAAC,EAED,GAAI,CAACC,EAAU,CACb,KAAK,OAAO,MAAM,wDAAwD,EAC1E,MACF,CAEA,aAAM,KAAK,UAAU,YAAYA,EAAS,IAAI,EAAE,kBAAkBF,CAAI,EAE/D,CACL,OAAQ,SACV,CACF,CACF,ECnCA,OAAOG,OAAW,QAIX,IAAMC,GAAN,cAA6BC,EAAwD,CAG1F,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,CAAS,EAHnC,KAAiB,OAAS,IAAIC,EAAO,gBAAgB,CAIrD,CAIA,MAAa,eAAeC,EAAW,CACrC,GAAIA,EAAK,SAAW,4BAA6B,CAC/C,GAAIA,EAAK,MAAM,CAAC,GAAG,QAAQ,CAAC,GAAG,QAAU,iCAAkC,CACzE,IAAMC,EAAW,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAC9D,MAAO,CAAE,WAAY,GAAGD,EAAK,MAAM,CAAC,EAAE,QAAQ,CAAC,EAAE,MAAM,mBAAmB,EAAG,CAC/E,CAAC,EAED,GAAI,CAACC,EAAU,CACb,QAAQ,IAAI,oBAAoB,EAChC,MACF,CAEA,GAAM,CAAE,WAAAC,CAAW,EAAID,EAEvB,MAAME,GAAM,KAAKD,EAAYF,EAAK,MAAM,CAAC,EAAE,QAAQ,CAAC,EAAE,MAAO,CAC3D,QAAS,CACP,eAAgB,kBAClB,CACF,CAAC,EACD,MACF,CAEAA,EAAK,OAAO,QAAQ,MAAOI,GAAe,CACxC,IAAMC,EAAWD,EAAM,QAAQ,CAAC,EAAE,MAAM,SAAS,gBAEjD,GAAI,CAACC,EACH,YAAK,OAAO,MAAM,4DAA4D,EACvE,CACL,OAAQ,SACV,EAGF,IAAMC,EAAW,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAC9D,MAAO,CAAE,OAAQD,CAAS,CAC5B,CAAC,EAED,OAAKC,GAOL,MAAM,KAAK,UAAU,YAAYA,EAAS,IAAI,EAAE,kBAAkBN,CAAI,EAE/D,CACL,OAAQ,SACV,IAVE,KAAK,OAAO,MAAM,4DAA4D,EACvE,CACL,OAAQ,SACV,EAQJ,CAAC,CACH,CAEA,MAAO,CACL,OAAQ,SACV,CACF,CACF,ECpEO,IAAMO,GAAN,KAAwB,CAC7B,YAA6BC,EAAgC,CAAhC,eAAAA,CAAiC,CAE9D,MAAa,WAAW,CAAE,aAAAC,CAAa,EAAgBC,EAAW,CAGhE,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,kBAAkBC,GAAM,GAAG,CAC7C,CAEA,MAAa,kBAAkB,CAAE,aAAAD,CAAa,EAAgBC,EAAW,CAGvE,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,yBAAyBC,GAAM,IAAKA,GAAM,KAAMA,GAAM,SAAS,CACjF,CAEA,MAAa,eAAe,CAAE,aAAAD,CAAa,EAAgBC,EAAW,CAGpE,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,sBAAsBC,GAAM,KAAMA,GAAM,KAAK,CAC/D,CAEA,MAAa,uBAAuB,CAAE,aAAAD,CAAa,EAAgBC,EAAW,CAG5E,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,8BAA8BC,GAAM,KAAMA,GAAM,QAASA,GAAM,UAAU,CAC3F,CAEA,MAAa,gBAAgB,CAAE,aAAAD,CAAa,EAAgBC,EAAW,CAGrE,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,uBAAuBC,GAAM,KAAMA,GAAM,SAAUA,GAAM,iBAAiB,CAC5F,CAEA,MAAa,mBAAmB,CAAE,aAAAD,CAAa,EAAgB,CAG7D,OAFiB,KAAK,UAAU,YAAYA,CAAY,EAExC,0BAA0B,CAC5C,CAEA,MAAa,SAAS,CAAE,aAAAA,CAAa,EAAgBC,EAAW,CAG9D,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,gBAAgBC,GAAM,MAAM,CAC9C,CAEA,MAAa,+BAA+B,CAAE,aAAAD,CAAa,EAAgBC,EAAW,CAGpF,OAFiB,KAAK,UAAU,YAAYD,CAAY,EAExC,sCAAsCC,GAAM,IAAKA,GAAM,KAAMA,GAAM,UAAU,CAC/F,CAEA,MAAa,aAAa,CAAE,aAAAD,CAAa,EAAgB,CAGvD,OAFiB,KAAK,UAAU,YAAYA,CAAY,EAExC,oBAAoB,CACtC,CACF,EC3DA,SAASE,GAAgBC,EAAqB,CAC5C,OAAOA,EACJ,UAAU,KAAK,EACf,QAAQ,mBAAoB,EAAE,EAC9B,YAAY,CACjB,CAEO,SAASC,GAAwBC,EAAcC,EAAwB,CAC5E,IAAMC,EAAUD,EAAM,MAAM,GAAG,EAAE,OAAO,CAACE,EAA+BC,IAAW,CACjF,GAAM,CAACC,EAAU,GAAGC,CAAM,EAAIF,EAAO,MAAM,GAAG,EACxCG,EAAQD,EAAO,KAAK,GAAG,EAE7B,OAAKH,EAAIE,CAAQ,IACfF,EAAIE,CAAQ,EAAI,CAAC,GAEnBF,EAAIE,CAAQ,EAAE,KAAKE,CAAK,EACjBJ,CACT,EAAG,CAAC,CAAC,EAECK,EAAiBX,GAAgBG,CAAI,EAE3C,OAAO,OAAO,QAAQE,CAAO,EAAE,MAAM,CAAC,CAACG,EAAUC,CAAM,IAC9CA,EAAO,KAAMG,GACAA,EAAI,MAAM,GAAG,EACd,MAAOC,GAAW,CACjC,IAAMC,EAAmBd,GAAgBa,CAAM,EAE/C,OAAQL,EAAS,YAAY,EAAG,CAC9B,IAAK,WACH,OAAOG,EAAe,SAASG,CAAgB,EACjD,IAAK,cACH,MAAO,CAACH,EAAe,SAASG,CAAgB,EAClD,IAAK,aACH,OAAOH,EAAe,WAAWG,CAAgB,EACnD,IAAK,WACH,OAAOH,EAAe,SAASG,CAAgB,EACjD,IAAK,QACH,OAAOH,IAAmBG,EAC5B,QACE,MAAO,EACX,CACF,CAAC,CACF,CACF,CACH,CC1CO,IAAMC,GAAmB,MAAOC,EAAoBC,EAAiBC,IAAuB,CAEjG,IAAMC,EAAiB,MAAMH,EAAc,UAAU,CACnD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYE,CACd,CACF,CAAC,EAED,GAAIC,EAAgB,OAAOA,EAE3B,IAAMC,EAAsB,MAAMJ,EAAc,SAAS,CACvD,MAAO,CACL,QAAS,GACT,YAAa,WACb,WAAYE,CACd,CACF,CAAC,EACD,QAAWG,KAAYD,EACrB,GAAIE,GAAwBL,EAASI,EAAS,YAAY,EACxD,OAAOA,EAKX,IAAME,EAAoB,MAAMP,EAAc,UAAU,CACtD,MAAO,CACL,QAAS,GACT,YAAa,UACb,gBAAiB,SACjB,aAAcC,EACd,WAAYC,CACd,CACF,CAAC,EAED,GAAIK,EAAmB,OAAOA,EAG9B,IAAMC,EAAY,MAAMR,EAAc,SAAS,CAC7C,MAAO,CACL,QAAS,GACT,YAAa,UACb,gBAAiB,QACjB,WAAYE,CACd,CACF,CAAC,EAEGO,EAAmB,KAEvB,QAAWC,KAASF,EAGlB,GAFmB,IAAI,OAAOE,EAAM,YAAY,EAEjC,KAAKT,CAAO,EAAG,CAC5BQ,EAAmBC,EACnB,KACF,CAGF,GAAID,EAAkB,OAAOA,EAG7B,IAAME,EAAiB,MAAMX,EAAc,SAAS,CAClD,MAAO,CACL,QAAS,GACT,YAAa,UACb,gBAAiB,aACjB,WAAYE,CACd,CACF,CAAC,EAEGU,EAAwB,KAE5B,QAAWC,KAAcF,EACvB,GAAIV,EAAQ,WAAWY,EAAW,YAAY,EAAG,CAC/CD,EAAwBC,EACxB,KACF,CAGF,GAAID,EAAuB,OAAOA,EAGlC,IAAME,EAAe,MAAMd,EAAc,SAAS,CAChD,MAAO,CACL,QAAS,GACT,YAAa,UACb,gBAAiB,WACjB,WAAYE,CACd,CACF,CAAC,EAEGa,EAAsB,KAE1B,QAAWC,KAAYF,EACrB,GAAIb,EAAQ,SAASe,EAAS,YAAY,EAAG,CAC3CD,EAAsBC,EACtB,KACF,CAGF,GAAID,EAAqB,OAAOA,EAGhC,IAAME,EAAe,MAAMjB,EAAc,SAAS,CAChD,MAAO,CACL,QAAS,GACT,YAAa,UACb,gBAAiB,WACjB,WAAYE,CACd,CACF,CAAC,EAEGgB,EAAsB,KAE1B,QAAWC,KAAYF,EACrB,GAAIhB,EAAQ,SAASkB,EAAS,YAAY,EAAG,CAC3CD,EAAsBC,EACtB,KACF,CAGF,OAAID,GAEG,IACT,ECnFO,IAAME,GAAN,KAAwB,CAM7B,YAAYC,EAAoCC,EAAgC,CAFhF,KAAgB,OAAS,IAAIC,EAAO,mBAAmB,EAGrD,KAAK,OAASF,EACd,KAAK,QAAUC,CACjB,CAEA,IAAW,OAAOE,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEA,IAAW,QAAQF,EAAgC,CACjD,KAAK,UAAYA,CACnB,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,SACd,CAEA,MAAa,KAAK,CAChB,SAAAG,EACA,UAAAC,EACA,IAAAC,EACA,SAAAC,EACA,cAAAC,EAAgB,EAClB,EAMkB,CAChB,IAAMC,EAAW,CACf,SAAAL,EACA,UAAAC,EACA,IAAAC,EACA,SAAAC,EACA,cAAAC,CACF,EACA,MAAME,GAAuB,KAAKD,CAAQ,EAE1C,MAAME,GAAkB,KAAKF,CAAQ,EAErC,MAAMG,GAAiB,KAAKH,CAAQ,EAEpC,MAAMI,GAAe,KAAKJ,CAAQ,EAElC,MAAMK,GAAkB,KAAKL,CAAQ,CACvC,CAEO,gBACLM,EACAC,EACAX,EACAY,EACAC,EACA,CACIH,EAAoBV,CAAS,GAC/BU,EAAoBV,CAAS,EAAE,SAAW;AAAA,EAAKW,CAAO,GACtD,KAAK,OAAO,IAAI,sBAAwBD,EAAoBV,CAAS,EAAE,OAAO,EAC9E,aAAaU,EAAoBV,CAAS,EAAE,SAAS,GAErDU,EAAoBV,CAAS,EAAI,CAC/B,QAASW,EACT,UAAW,IACb,EAGFD,EAAoBV,CAAS,EAAE,UAAY,WAAW,IAAM,CAC1D,IAAMc,EAAaJ,EAAoBV,CAAS,EAAE,QAClD,KAAK,OAAO,IAAI,0CAA4Cc,CAAU,EAEtE,OAAOJ,EAAoBV,CAAS,EACpCa,EAASC,CAAU,CACrB,EAAGF,EAAe,GAAI,CACxB,CAEO,gBAAgBG,EAAiBf,EAAmB,CACzD,GAAIe,GAAcA,EAAW,OAAS,EAAG,CACvC,IAAIC,EAAe,GACfC,EAAiB,GAUrB,OARIF,EAAW,SAAS,OAAO,IAC7BC,EAAe,IAGbD,EAAW,SAAS,iBAAiB,IACvCE,EAAiB,IAGfD,GAAgBhB,EAAU,SAAS,OAAO,GAC5C,KAAK,OAAO,KAAK,gCAAkCA,CAAS,EACrD,IAGLiB,GAAkBjB,EAAU,SAAS,iBAAiB,GACxD,KAAK,OAAO,KAAK,kCAAoCA,CAAS,EACvD,IAGLe,EAAW,SAASf,CAAS,GAC/B,KAAK,OAAO,KAAK,8BAAgCA,CAAS,EACnD,IAGF,EACT,CAEA,MAAO,EACT,CAEA,MAAa,WAAWA,EAAmBD,EAAuB,CAChE,IAAImB,EAAU,MAAM,KAAK,iBAAiB,mBAAmB,UAAU,CACrE,MAAO,CACL,UAAWlB,EACX,WAAYD,EAAS,UACvB,EACA,QAAS,CAAE,UAAW,MAAO,CAC/B,CAAC,EAED,GAAImB,EACF,GAAIA,EAAQ,SAAW,UAAY,CAACA,EAAQ,MAAO,CACjD,KAAK,OAAO,KAAK,kDAAkD,EACnE,MACF,MAAYA,EAAQ,QAClBA,EAAU,MAId,OAAOA,CACT,CAEA,MAAa,eACXC,EACAR,EACAZ,EACAmB,EACA,CACA,IAAIE,EAEJ,GAAKF,EAOHE,EAAU,MAAMD,EAAc,UAAU,CACtC,MAAO,CACL,GAAID,EAAQ,KACd,CACF,CAAC,UAVDE,EAAU,MAAMC,GAAiBF,EAAeR,EAASZ,EAAS,UAAU,EAExE,CAACqB,EACH,OAUJ,OAAOA,CACT,CACF,ECvMA,OAAS,SAAAE,OAAa,kBAEf,IAAMC,GAAN,KAAyB,CAC9B,YACmBC,EACAC,EACAC,EACjB,CAHiB,qBAAAF,EACA,mBAAAC,EACA,sBAAAC,CAChB,CAEH,MAAa,eAAeC,EAAuBC,EAAmB,CACpE,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAAS,MAAM,IAAIC,EAAoB,sBAAsB,EAE/G,GAAID,GAAM,QAAS,CACjB,GAAI,CAACN,GAAMM,EAAK,IAAK,CAAE,YAAa,EAAM,CAAC,EACzC,MAAM,IAAIC,EAAoB,kBAAkB,EAGlD,GAAI,CAACD,EAAK,UACR,MAAM,IAAIC,EAAoB,uBAAuB,EAGvD,GAAI,CAACD,EAAK,MACR,MAAM,IAAIC,EAAoB,mBAAmB,EAGnD,GAAID,EAAK,UAAY,IAAQA,EAAK,UAAY,GAC5C,MAAM,IAAIC,EAAoB,qBAAqB,EAEjDD,EAAK,UAAY,KAAOA,EAAK,cAAgB,KACnD,EAEI,CAACA,EAAK,WAAaA,EAAK,YAAc,MACxCA,EAAK,UAAYD,EAAS,cAG5B,IAAMG,EAAS,MAAM,KAAK,gBAAgB,OAAOH,EAAUC,CAAI,EAEzDG,EAAY,KAAK,cAAc,IAAgB,QAAQ,EAAE,IAO/D,MALiB,CACf,GAAGD,EACH,YAAa,GAAGC,CAAS,qBAAqB,mBAAmBJ,EAAS,YAAY,CAAC,EACzF,CAGF,CAEA,MAAa,aAAaA,EAAuE,CAC/F,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAAS,MAAM,IAAIE,EAAoB,sBAAsB,EAE/G,IAAMC,EAAS,MAAM,KAAK,gBAAgB,KAAKH,CAAQ,EAEjDI,EAAY,KAAK,cAAc,IAAgB,QAAQ,EAAE,IAE/D,OAAI,OAAO,KAAKD,GAAU,CAAC,CAAC,EAAE,SAAW,EAChC,CACL,QAAS,GACT,IAAK,GACL,UAAW,GACX,MAAO,GACP,QAAS,GACT,UAAW,GACX,YAAa,EACf,EAGe,CACf,GAAGA,EACH,YAAa,GAAGC,CAAS,qBAAqB,mBAAmBJ,EAAS,YAAY,CAAC,EACzF,CAGF,CAEA,MAAa,eAAeA,EAAuBC,EAAW,CAC5D,GAAI,CAAC,KAAK,cAAc,IAAc,UAAU,EAAE,QAAS,MAAM,IAAIC,EAAoB,sBAAsB,EAE/G,IAAMG,EAAgB,IAAIC,GAAa,IAAIC,GAAY,KAAK,cAAeC,GAAgB,IAAI,EAAE,UAAU,CAAC,EAG5G,OAFwB,IAAIA,GAAgBC,EAAW,KAAK,cAAe,KAAK,iBAAkBJ,CAAa,EAExF,eAAeL,EAAUC,CAAI,CACtD,CACF,EC7EO,IAAMS,GAAN,cAA6BC,EAAwD,CAC1F,YACmBC,EACjBC,EACAC,EACA,CACA,MAAMD,EAAkBC,CAAS,EAJhB,iBAAAF,EAWnB,KAAgB,OAAS,IAAIG,EAAO,gBAAgB,EAEpD,wBAAqBC,EAAc,IAAU,MAAM,EAAE,QAIrD,yBAAyF,CAAC,EAXxF,KAAK,cAAgB,KAAK,iBAAiB,KAC3C,KAAK,mBAAqB,KAAK,iBAAiB,YAChD,KAAK,kBAAoB,KAAK,iBAAiB,kBACjD,CAWA,MAAa,UAAUC,EAAuBC,EAAe,CAC3D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,kBAAkB,EAE9E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GACE,CAACC,EAAK,QACN,CAACA,EAAK,eACN,CAACA,EAAK,cACN,CAACA,EAAK,gBACN,CAACA,EAAK,iBACN,CAACA,EAAK,eACN,CAACA,EAAK,UACN,CAACA,EAAK,cACN,CAACA,EAAK,YACN,CAACA,EAAK,eACN,CAACA,EAAK,YACN,CACA,IAAMG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYD,CACd,CACF,CAAC,GAEGF,EAAK,SAAW,QAAaA,EAAK,SAAW,QAAMA,EAAK,OAASG,EAAoB,SACrFH,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBG,EAAoB,gBACvCH,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeG,EAAoB,eACtCH,EAAK,iBAAmB,QAAaA,EAAK,iBAAmB,QAC/DA,EAAK,eAAiBG,EAAoB,iBACxCH,EAAK,kBAAoB,QAAaA,EAAK,kBAAoB,QACjEA,EAAK,gBAAkBG,EAAoB,kBACzCH,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBG,EAAoB,gBACvCH,EAAK,WAAa,QAAaA,EAAK,WAAa,QAAMA,EAAK,SAAWG,EAAoB,WAC3FH,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeG,EAAoB,eACtCH,EAAK,aAAe,QAAaA,EAAK,aAAe,QAAMA,EAAK,WAAaG,EAAoB,aACjGH,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBG,GAAqB,eAAiB,KACzDH,EAAK,cAAgB,QAAaA,EAAK,cAAgB,QACzDA,EAAK,YAAcG,GAAqB,aAAe,GAEpDA,GACH,MAAM,KAAK,SAASJ,EAAU,CAC5B,OAAQC,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CAAC,CAEL,CAUA,GARwB,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYE,CACd,CACF,CAAC,GAEsBF,EAAK,cAAgB,MAC1C,MAAM,IAAI,MAAM,6FAA6F,EAY/G,GATuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,WAAYE,EACZ,QAASF,EAAK,QACd,OAAQA,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,qBAAqB,EAGvC,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAW3D,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAU7C,GAPuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CA0BF,OAzBY,MAAM,KAAK,cAAc,OAAO,CAC1C,KAAM,CACJ,QAASF,GAAM,QACf,YAAaA,EAAK,YAClB,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYE,EACZ,YAAaF,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASI,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,qBAAqB,CACvC,CACF,CAEA,MAAa,QAAQL,EAAuB,CAC1C,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,kBAAkB,EAE9E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BM,EAAO,MAAM,KAAK,cAAc,SAAS,CAC7C,MAAO,CACL,WAAYH,CACd,CACF,CAAC,EAED,OAAKG,EAAK,OAIHA,EAHE,IAIX,CAEA,MAAa,SAASN,EAAuBO,EAAe,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIL,EAAoB,kBAAkB,EAE9E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,gBAAgB,EAGlC,OAAOK,CACT,CAEA,MAAa,UAAUR,EAAuBO,EAAeN,EAAe,CAC1E,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,kBAAkB,EAE9E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIF,EAAK,cAAgB,OACC,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,GAAI,CACF,IAAKM,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,6FAA6F,EAgBjH,GAZuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,GAAI,CACF,IAAKI,CACP,EACA,WAAYJ,EACZ,QAASF,EAAK,QACd,OAAQA,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,qBAAqB,EAGvC,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAY3D,GATuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKM,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAW7C,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKM,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CA6BF,OA5BY,MAAM,KAAK,cAAc,OAAO,CAC1C,MAAO,CACL,GAAII,CACN,EACA,KAAM,CACJ,QAASN,GAAM,QACf,YAAaA,EAAK,YAClB,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYE,EACZ,YAAaF,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASI,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,qBAAqB,CACvC,CACF,CAEA,MAAa,UAAUL,EAAuBO,EAAe,CAC3D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIL,EAAoB,kBAAkB,EAE9E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,gBAAgB,EAElC,GAAI,CACF,aAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOI,CACT,CACF,CAAC,EAED,MAAM,KAAK,cAAc,OAAO,CAC9B,MAAO,CACL,GAAIA,CACN,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,GAAIA,CAAM,CAAE,CAC9B,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAGA,MAAa,SAASL,EAAuBC,EAAW,CACtD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,kBAAkB,EAE9E,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAIM,EAAU,CACZ,IAAMC,EAAiB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAID,EAAS,EACf,EACA,KAAM,CACJ,OAAQR,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,OAAQS,EAAe,OACvB,cAAeA,EAAe,cAC9B,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,gBAAiBA,EAAe,gBAChC,cAAeA,EAAe,cAC9B,SAAUA,EAAe,SACzB,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,WAAYA,EAAe,WAC3B,cAAeA,EAAe,cAC9B,YAAaA,EAAe,WAC9B,CACF,CAEA,IAAMC,EAAe,MAAM,KAAK,mBAAmB,OAAO,CACxD,KAAM,CACJ,OAAQV,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,WAAYA,EAAK,WACjB,WAAYE,EACZ,cAAeF,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,OAAQU,EAAa,OACrB,cAAeA,EAAa,cAC5B,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,gBAAiBA,EAAa,gBAC9B,cAAeA,EAAa,cAC5B,SAAUA,EAAa,SACvB,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,WAAYA,EAAa,WACzB,cAAeA,EAAa,cAC5B,YAAaA,EAAa,WAC5B,CACF,OAASN,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,cAAcL,EAAuB,CAChD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,kBAAkB,EAE9E,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,EACA,QAAS,CACP,SAAU,EACZ,CACF,CAAC,EAED,OAAKM,EAiBE,CACL,OAAQA,EAAS,OACjB,cAAeA,EAAS,cACxB,aAAcA,EAAS,aACvB,eAAgBA,EAAS,eACzB,gBAAiBA,EAAS,gBAC1B,cAAeA,EAAS,cACxB,SAAUA,EAAS,SACnB,WAAYA,EAAS,WACrB,cAAeA,EAAS,cACxB,YAAaA,EAAS,YACtB,eAAgBA,EAAS,eACzB,SAAUA,EAAS,QACrB,EA7BS,CACL,OAAQ,EACR,cAAe,GACf,aAAc,EACd,eAAgB,GAChB,gBAAiB,GACjB,cAAe,GACf,SAAU,GACV,WAAY,CAAC,EACb,cAAe,GACf,YAAa,EACb,eAAgB,GAChB,SAAU,IACZ,CAiBJ,OAASJ,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiC,CACnD,CACF,CAGA,MAAa,aAAaL,EAAuBC,EAAW,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,kBAAkB,EAE9E,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BI,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAAD,CACF,CACF,CAAC,EAEKS,EAAYX,EAAK,UACjBY,EAASZ,EAAK,OAEpB,GAAIY,IAAW,SACb,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWD,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,UAAWA,EAAW,OAAQC,CAAO,CAAE,EAGzD,GAAIA,IAAW,SACb,OAAIT,GAAqB,SACvB,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWQ,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWA,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAGI,CAAE,IAAK,CAAE,GAAGZ,EAAU,IAAK,CAAE,UAAWY,EAAW,OAAQC,CAAO,CAAE,CAAE,EACxE,CACL,IAAMC,EAAU,MAAM,KAAK,kBAAkB,WAAW,CACtD,MAAO,CACL,WAAYX,EACZ,UAAWS,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQC,CACV,CACF,CAAC,EAQD,MAAO,CAAE,IAAK,CAAE,GAAGb,EAAU,IANb,CACd,UAAWY,EACX,OAAQC,EACR,QAAAC,CACF,CAE0C,CAAE,CAC9C,CACF,OAAST,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAEA,MAAa,cAAcL,EAAuBO,EAAeK,EAAoB,CACnF,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIV,EAAoB,kBAAkB,EAE9E,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAIC,GAAOA,EAAI,aAAeL,EAC5B,MAAM,IAAI,MAAM,gBAAgB,EAGlC,OAAO,MAAM,KAAK,kBAAkB,SAAS,CAC3C,MAAO,CACL,WAAYA,EACZ,UAAAS,EACA,MAAOJ,EAAMD,EAAQ,CAAE,IAAK,IAAK,EACjC,KAAM,MACR,CACF,CAAC,CACH,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAEA,MAAa,UAAUL,EAAuBC,EAAoB,CAChE,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,kBAAkB,EAE9E,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAI,CAACM,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,IAAIM,EAAkBN,GAAU,YAAc,CAAC,EAE/C,GAAIR,EAAK,SAAW,MAAO,CACzB,GAAIc,EAAW,SAASd,EAAK,SAAS,EAAG,MAAO,CAAE,WAAYc,CAAW,EAEzEA,EAAW,KAAKd,EAAK,SAAS,CAChC,MACEc,EAAaA,EAAW,OAAQC,GAAQA,IAAQf,EAAK,SAAS,EAYhE,MAAO,CACL,YAVqB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAIQ,EAAS,EACf,EACA,KAAM,CACJ,WAAYM,CACd,CACF,CAAC,GAG4B,UAC7B,CACF,OAASV,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAGA,MAAa,KAAK,CAAE,SAAAL,EAAU,UAAAY,EAAW,IAAAK,CAAI,EAAa,CACxD,GAAK,KAAK,mBAEV,GAAI,CACF,IAAMR,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYT,EAAS,UACvB,CACF,CAAC,EAED,GAAI,KAAK,gBAAgBS,GAAU,WAAYG,CAAS,EAAG,OAE3D,IAAME,EAAU,MAAM,KAAK,WAAWF,EAAWZ,CAAQ,EAEnDkB,EAAUC,GAAuBF,CAAG,EAEtCG,EAAW,MAAM,KAAK,eAAe,KAAK,cAAeF,EAASlB,EAAUc,CAAO,EAEvF,GAAI,CAACM,EAAS,CACZ,IAAMC,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYrB,EAAS,UACvB,CACF,CAAC,EAED,GAAIqB,GAAU,eAOZD,EANqB,MAAM,KAAK,cAAc,UAAU,CACtD,MAAO,CACL,GAAIC,EAAS,cACf,CACF,CAAC,MAID,OAEJ,CAEA,IAAIC,EAASF,GAAS,OAClBG,EAAgBH,GAAS,cACzBI,EAAeJ,GAAS,aACxBK,EAAiBL,GAAS,eAC1BM,EAAkBN,GAAS,gBAC3BO,EAAgBP,GAAS,cACzBQ,EAAWR,GAAS,SACpBS,EAAeT,GAAS,aACxBL,EAAaK,GAAS,WACtBU,EAAgBV,GAAS,cACzBW,EAAcX,GAAS,YAECE,GAAW,OAAMA,EAASb,EAAS,QAC5Bc,GAAkB,OAAMA,EAAgBd,EAAS,eAClDe,GAAiB,OAAMA,EAAef,EAAS,cAC7CgB,GAAmB,OAAMA,EAAiBhB,EAAS,gBAClDiB,GAAoB,OAAMA,EAAkBjB,EAAS,iBACvDkB,GAAkB,OAAMA,EAAgBlB,EAAS,eACtDmB,GAAa,OAAMA,EAAWnB,EAAS,UACnCoB,GAAiB,OAAMA,EAAepB,EAAS,cACjDM,GAAe,OAAMA,EAAaN,EAAS,YACxCqB,GAAkB,OAAMA,EAAgBrB,GAAU,eAAiB,IACrEsB,GAAgB,OAAMA,EAActB,GAAU,aAAe,GAE9F,IAAMuB,EAAMf,EAAI,IAOhB,GAAIU,GAAiBK,EAAI,QAAUlB,EAAS,CAC1C,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EACD,MACF,CAMA,GAJI,CAACY,GAAmBM,EAAI,QAIxBlB,GAAW,CAACA,EAAQ,UACtB,OAGEe,GAAgBA,EAAe,EACjC,KAAK,gBAAgB,KAAK,oBAAqBX,EAASN,EAAWiB,EAAc,MAAOI,GAAqB,CAC3G,MAAM,KAAK,YAAY,YACrB,KAAK,UAAU,YAAYjC,EAAS,YAAY,EAChDY,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAE,EACAhB,GAAK,QACP,CACF,CAAC,EAED,MAAM,KAAK,YAAY,YACrB,KAAK,UAAU,YAAYjB,EAAS,YAAY,EAChDY,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAb,EACAD,GAAK,QACP,EAGF,MACF,OAASZ,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACF,EC32BO,IAAM6B,GAAN,cAAqCC,EAAwD,CAClG,YACmBC,EACjBC,EACAC,EACA,CACA,MAAMD,EAAkBC,CAAS,EAJhB,yBAAAF,EAWnB,KAAgB,OAAS,IAAIG,EAAO,wBAAwB,EAM5D,yBAAyF,CAAC,EAXxF,KAAK,cAAgB,KAAK,iBAAiB,aAC3C,KAAK,mBAAqB,KAAK,iBAAiB,oBAChD,KAAK,kBAAoB,KAAK,iBAAiB,kBACjD,CAWA,MAAa,UAAUC,EAAuBC,EAAuB,CACnE,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GACE,CAACC,EAAK,QACN,CAACA,EAAK,eACN,CAACA,EAAK,cACN,CAACA,EAAK,gBACN,CAACA,EAAK,iBACN,CAACA,EAAK,eACN,CAACA,EAAK,UACN,CAACA,EAAK,cACN,CAACA,EAAK,YACN,CAACA,EAAK,eACN,CAACA,EAAK,YACN,CACA,IAAME,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYD,CACd,CACF,CAAC,GAEGD,EAAK,SAAW,QAAaA,EAAK,SAAW,QAAMA,EAAK,OAASE,EAAoB,SACrFF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,EAAoB,gBACvCF,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeE,EAAoB,eACtCF,EAAK,iBAAmB,QAAaA,EAAK,iBAAmB,QAC/DA,EAAK,eAAiBE,EAAoB,iBACxCF,EAAK,kBAAoB,QAAaA,EAAK,kBAAoB,QACjEA,EAAK,gBAAkBE,EAAoB,kBACzCF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,EAAoB,gBACvCF,EAAK,WAAa,QAAaA,EAAK,WAAa,QAAMA,EAAK,SAAWE,EAAoB,WAC3FF,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeE,EAAoB,eACtCF,EAAK,aAAe,QAAaA,EAAK,aAAe,QAAMA,EAAK,WAAaE,EAAoB,aACjGF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,GAAqB,eAAiB,KACzDF,EAAK,cAAgB,QAAaA,EAAK,cAAgB,QACzDA,EAAK,YAAcE,GAAqB,aAAe,GAEpDA,GACH,MAAM,KAAK,SAASH,EAAU,CAC5B,OAAQC,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CAAC,CAEL,CAUA,GARwB,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYC,CACd,CACF,CAAC,GAEsBD,EAAK,cAAgB,MAC1C,MAAM,IAAI,MAAM,6FAA6F,EAW/G,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,WAAYC,EACZ,OAAQD,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,qBAAqB,EAGvC,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAW3D,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYC,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAID,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAU7C,GAPuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,WAAYC,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAyBF,OAxBY,MAAM,KAAK,cAAc,OAAO,CAC1C,KAAM,CACJ,QAASD,GAAM,QACf,YAAaA,EAAK,YAClB,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYC,EACZ,YAAaD,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAEA,MAAa,QAAQJ,EAAuB,CAC1C,IAAME,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BK,EAAO,MAAM,KAAK,cAAc,SAAS,CAC7C,MAAO,CACL,WAAYH,CACd,CACF,CAAC,EAED,OAAKG,EAAK,OAIHA,EAHE,IAIX,CAEA,MAAa,SAASL,EAAuBM,EAAe,CAC1D,IAAMJ,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAGjC,OAAOK,CACT,CAEA,MAAa,UAAUP,EAAuBM,EAAeL,EAAuB,CAClF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAID,EAAK,cAAgB,OACC,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,GAAI,CACF,IAAKK,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,4FAA4F,EAehH,GAXuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,GAAI,CACF,IAAKI,CACP,EACA,WAAYJ,EACZ,OAAQD,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,oBAAoB,EAGtC,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAY3D,GATuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKK,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAID,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAW7C,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKK,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CA4BF,OA3BY,MAAM,KAAK,cAAc,OAAO,CAC1C,MAAO,CACL,GAAII,CACN,EACA,KAAM,CACJ,QAASL,GAAM,QACf,YAAaA,EAAK,YAClB,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYC,EACZ,YAAaD,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAEA,MAAa,UAAUJ,EAAuBM,EAAe,CAC3D,IAAMJ,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAEjC,GAAI,CACF,aAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOI,CACT,CACF,CAAC,EAED,MAAM,KAAK,cAAc,OAAO,CAC9B,MAAO,CACL,GAAIA,CACN,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,GAAIA,CAAM,CAAE,CAC9B,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAGA,MAAa,SAASJ,EAAuBC,EAAW,CACtD,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAIM,EAAU,CACZ,IAAMC,EAAiB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAID,EAAS,EACf,EACA,KAAM,CACJ,OAAQP,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,cAAeA,EAAK,cACpB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,OAAQQ,EAAe,OACvB,cAAeA,EAAe,cAC9B,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,gBAAiBA,EAAe,gBAChC,cAAeA,EAAe,cAC9B,SAAUA,EAAe,SACzB,aAAcA,EAAe,aAC7B,cAAeA,EAAe,cAC9B,WAAYA,EAAe,WAC3B,cAAeA,EAAe,cAC9B,YAAaA,EAAe,WAC9B,CACF,CAEA,IAAMC,EAAe,MAAM,KAAK,mBAAmB,OAAO,CACxD,KAAM,CACJ,OAAQT,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,cAAeA,EAAK,cACpB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,YAClB,WAAYC,CACd,CACF,CAAC,EAED,MAAO,CACL,OAAQQ,EAAa,OACrB,cAAeA,EAAa,cAC5B,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,gBAAiBA,EAAa,gBAC9B,cAAeA,EAAa,cAC5B,SAAUA,EAAa,SACvB,aAAcA,EAAa,aAC3B,cAAeA,EAAa,cAC5B,WAAYA,EAAa,WACzB,cAAeA,EAAa,cAC5B,YAAaA,EAAa,WAC5B,CACF,OAASN,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,cAAcJ,EAAuB,CAChD,GAAI,CACF,IAAME,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,EACA,QAAS,CACP,SAAU,EACZ,CACF,CAAC,EAED,OAAKM,EAiBE,CACL,OAAQA,EAAS,OACjB,cAAeA,EAAS,cACxB,aAAcA,EAAS,aACvB,eAAgBA,EAAS,eACzB,gBAAiBA,EAAS,gBAC1B,cAAeA,EAAS,cACxB,SAAUA,EAAS,SACnB,WAAYA,EAAS,WACrB,cAAeA,EAAS,cACxB,YAAaA,EAAS,YACtB,cAAeA,EAAS,cACxB,SAAUA,EAAS,QACrB,EA7BS,CACL,OAAQ,EACR,cAAe,GACf,aAAc,EACd,eAAgB,GAChB,gBAAiB,GACjB,cAAe,GACf,SAAU,GACV,WAAY,CAAC,EACb,cAAe,GACf,YAAa,EACb,cAAe,GACf,SAAU,IACZ,CAiBJ,OAASJ,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiC,CACnD,CACF,CAGA,MAAa,aAAaJ,EAAuBC,EAAW,CAC1D,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAAD,CACF,CACF,CAAC,EAEKS,EAAYV,EAAK,UACjBW,EAASX,EAAK,OAEpB,GAAIW,IAAW,SACb,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWD,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,UAAWA,EAAW,OAAQC,CAAO,CAAE,EAGzD,GAAIA,IAAW,SACb,OAAIT,GAAqB,SACvB,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWQ,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWA,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAGI,CAAE,IAAK,CAAE,GAAGX,EAAU,IAAK,CAAE,UAAWW,EAAW,OAAQC,CAAO,CAAE,CAAE,EACxE,CACL,IAAMC,EAAU,MAAM,KAAK,kBAAkB,WAAW,CACtD,MAAO,CACL,WAAYX,EACZ,UAAWS,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQC,CACV,CACF,CAAC,EAQD,MAAO,CAAE,IAAK,CAAE,GAAGZ,EAAU,IANb,CACd,UAAWW,EACX,OAAQC,EACR,QAAAC,CACF,CAE0C,CAAE,CAC9C,CACF,OAAST,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAEA,MAAa,cAAcJ,EAAuBM,EAAeK,EAAoB,CACnF,GAAI,CACF,IAAMT,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAIC,GAAOA,EAAI,aAAeL,EAC5B,MAAM,IAAI,MAAM,gBAAgB,EAGlC,OAAO,MAAM,KAAK,kBAAkB,SAAS,CAC3C,MAAO,CACL,WAAYA,EACZ,UAAAS,EACA,MAAOJ,EAAMD,EAAQ,CAAE,IAAK,IAAK,EACjC,KAAM,WACR,CACF,CAAC,CACH,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAEA,MAAa,UAAUJ,EAAuBC,EAAoB,CAChE,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAI,CAACM,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,IAAIM,EAAkBN,GAAU,YAAc,CAAC,EAE/C,GAAIP,EAAK,SAAW,MAAO,CACzB,GAAIa,EAAW,SAASb,EAAK,SAAS,EAAG,MAAO,CAAE,WAAYa,CAAW,EAEzEA,EAAW,KAAKb,EAAK,SAAS,CAChC,MACEa,EAAaA,EAAW,OAAQC,GAAQA,IAAQd,EAAK,SAAS,EAYhE,MAAO,CACL,YAVqB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAIO,EAAS,EACf,EACA,KAAM,CACJ,WAAYM,CACd,CACF,CAAC,GAG4B,UAC7B,CACF,OAASV,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAGA,MAAa,KAAK,CAAE,SAAAJ,EAAU,UAAAW,EAAW,IAAAK,CAAI,EAAa,CACxD,GAAI,CACF,IAAMR,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYR,EAAS,UACvB,CACF,CAAC,EAED,GAAI,KAAK,gBAAgBQ,GAAU,WAAYG,CAAS,EAAG,OAE3D,IAAME,EAAU,MAAM,KAAK,WAAWF,EAAWX,CAAQ,EAEnDiB,EAAUC,GAAuBF,CAAG,EAEtCG,EAAW,MAAM,KAAK,eAAe,KAAK,cAAeF,EAASjB,EAAUa,CAAO,EAEvF,GAAI,CAACM,EAAS,CACZ,IAAMC,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYpB,EAAS,UACvB,CACF,CAAC,EAED,GAAIoB,GAAU,cAOZD,EANqB,MAAM,KAAK,cAAc,UAAU,CACtD,MAAO,CACL,GAAIC,EAAS,aACf,CACF,CAAC,MAID,OAEJ,CAEA,IAAIC,EAASF,GAAS,OAClBG,EAAgBH,GAAS,cACzBI,EAAeJ,GAAS,aACxBK,EAAiBL,GAAS,eAC1BM,EAAkBN,GAAS,gBAC3BO,EAAgBP,GAAS,cACzBQ,EAAWR,GAAS,SACpBS,EAAeT,GAAS,aACxBL,EAAaK,GAAS,WACtBU,EAAgBV,GAAS,cACzBW,EAAcX,GAAS,YAECE,GAAW,OAAMA,EAASb,EAAS,QAC5Bc,GAAkB,OAAMA,EAAgBd,EAAS,eAClDe,GAAiB,OAAMA,EAAef,EAAS,cAC7CgB,GAAmB,OAAMA,EAAiBhB,EAAS,gBAClDiB,GAAoB,OAAMA,EAAkBjB,EAAS,iBACvDkB,GAAkB,OAAMA,EAAgBlB,EAAS,eACtDmB,GAAa,OAAMA,EAAWnB,EAAS,UACnCoB,GAAiB,OAAMA,EAAepB,EAAS,cACjDM,GAAe,OAAMA,EAAaN,EAAS,YACxCqB,GAAkB,OAAMA,EAAgBrB,GAAU,eAAiB,IACrEsB,GAAgB,OAAMA,EAActB,GAAU,aAAe,GAE9F,IAAMuB,EAAMf,EAAI,IAOhB,GAAIU,GAAiBK,EAAI,QAAUlB,EAAS,CAC1C,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EACD,MACF,CAMA,GAJI,CAACY,GAAmBM,EAAI,QAIxBlB,GAAW,CAACA,EAAQ,UACtB,OAGEe,GAAgBA,EAAe,EACjC,KAAK,gBAAgB,KAAK,oBAAqBX,EAASN,EAAWiB,EAAc,MAAOI,GAAqB,CAC3G,MAAM,KAAK,oBAAoB,WAC7B,KAAK,UAAU,YAAYhC,EAAS,YAAY,EAChDW,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAE,EACAhB,GAAK,QACP,CACF,CAAC,EAED,MAAM,KAAK,oBAAoB,WAC7B,KAAK,UAAU,YAAYhB,EAAS,YAAY,EAChDW,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAb,EACAD,GAAK,QACP,EAGF,MACF,OAASZ,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACF,ECl1BA,OAAO6B,OAAW,QAEX,IAAMC,GAAN,KAA0B,CAC/B,YACmBC,EACAC,EACAC,EACjB,CAHiB,eAAAF,EACA,mBAAAC,EACA,sBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,qBAAqB,CAFvD,CAIH,MAAa,iBAAiBC,EAAuBC,EAAW,CAC9D,GAAI,CAcF,MAAO,CAAE,QAbO,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpE,KAAM,CACJ,UAAWA,EAAK,UAChB,SAAUA,EAAK,SACf,UAAWA,EAAK,UAChB,OAAQ,SACR,UAAW,GACX,MAAOA,EAAK,MACZ,WAAYD,EAAS,WACrB,KAAM,WACR,CACF,CAAC,CAEgB,CACnB,OAASE,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEQ,eAAeC,EAAiB,CACtC,OAAOA,EAAQ,SAAS,cAAc,CACxC,CAEA,MAAc,iBACZH,EACAI,EACAC,EACAC,EACAC,EACAJ,EACA,CACA,IAAMK,EAAe,CACnB,OAAQ,CACN,UAAWJ,EAAQ,GACnB,UAAWE,EACX,SAAUC,EACV,aAAcP,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,EACA,MAAOG,EACP,gBAAiBC,EAAQ,YAAcE,EAAY,OAAYF,EAAQ,UACvE,KAAME,CACR,EAEA,GAAI,KAAK,eAAeH,CAAO,EAAG,CAChC,IAAMM,EAAeN,EAAQ,MAAM,GAAG,EAEtCK,EAAQ,MAAQ,CACd,CACE,KAAM,QACN,IAAKC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,CACnC,CACF,EACAD,EAAQ,MAAQC,EAAa,CAAC,GAAKN,CACrC,CAEIH,EAAS,cAAgBU,EAAY,mBACvC,MAAMV,EAAS,OAAO,kBAAkBM,CAAS,EACjD,MAAMN,EAAS,OAAO,mBAAmB,YAAaM,CAAS,GAGjE,IAAIK,EAAe,CACjB,eAAgB,kBAClB,EAEIN,EAAI,SACNM,EAAU,CACR,GAAGA,EACH,cAAe,UAAUN,EAAI,MAAM,EACrC,GAGF,IAAMO,EAAW,MAAMlB,GAAM,KAAKW,EAAI,OAAQG,EAAS,CACrD,QAAAG,CACF,CAAC,EAED,OAAIX,EAAS,cAAgBU,EAAY,kBACvC,MAAMV,EAAS,OAAO,mBAAmB,SAAUM,CAAS,EAE9CM,GAAU,MAAM,OAGlC,CAEA,MAAc,oBACZZ,EACAM,EACAF,EACAS,EACAC,EACA,CACA,IAAMC,EAAY,0BAEdC,EAAa,GACbC,EAAY,EAEZC,EAEEC,EAAgBC,GAA+B,CACnD,IAAMC,EAAYD,EAAI,MAAM,GAAG,EAAE,IAAI,GAAG,YAAY,EAC9CE,EAAkB,CAAC,MAAO,OAAQ,MAAO,MAAO,MAAO,MAAM,EAC7DC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAqB,CAAC,MAAO,MAAO,OAAQ,MAAO,OAAQ,MAAO,OAAQ,KAAK,EAErF,OAAIH,EAAgB,SAASD,GAAa,EAAE,EAAU,QAClDE,EAAgB,SAASF,GAAa,EAAE,EAAU,QAClDG,EAAgB,SAASH,GAAa,EAAE,EAAU,QAClDI,EAAmB,SAASJ,GAAa,EAAE,EAAU,WAClD,IACT,EAEA,MAAQH,EAAQH,EAAU,KAAKD,CAAO,KAAO,MAAM,CACjD,GAAM,CAACY,EAAWC,EAAUC,EAASR,CAAG,EAAIF,EACtCW,EAAYV,EAAaC,CAAG,EAE5BU,EAAahB,EAAQ,MAAMG,EAAWC,EAAM,KAAK,EAKvD,GAJIY,IACFd,GAAcc,GAGZD,EAAW,CACb,IAAME,EAAgBlB,EAAS,eAAiB,GAC1CmB,EAAcnB,EAAS,aAAe,EACtCoB,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAAG,CACrB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMtB,EAAUqB,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAIvB,EAAQ,OAASkB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7ElC,EAAS,cAAgBU,EAAY,mBACvC,MAAMV,EAAS,OAAO,kBAAkBM,CAAS,EACjD,MAAMN,EAAS,OAAO,mBAAmB,YAAaM,CAAS,GAGjE,MAAM,IAAI,QAAegC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAMtC,EAAS,YACb,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,KAAMC,CACR,EACA,EACF,EACAwB,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEGrC,EAAS,cAAgBU,EAAY,kBACvC,MAAMV,EAAS,OAAO,mBAAmB,SAAUM,CAAS,CAEhE,CACF,MACE,MAAMN,EAAS,YACb,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,KAAMG,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEIa,IAAc,QAChB,MAAM7B,EAAS,cAAc,CAC3B,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,MAAOO,EACP,QAASQ,CACX,CAAC,EAED,MAAM5B,EAAS,aACb,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,UAAWgB,EACX,MAAOT,EACP,QAASQ,CACX,EACA,KACA,EACF,CAEJ,MACEZ,GAAc,IAAIY,CAAO,KAAKR,CAAG,IAGnCH,EAAYF,EAAU,SACxB,CAEA,GAAIE,EAAYH,EAAQ,OAAQ,CAC9B,IAAMyB,EAAgBzB,EAAQ,MAAMG,CAAS,EACzCsB,EAAc,KAAK,IACrBvB,GAAcuB,EAElB,CAEA,IAAMR,EAAgBlB,EAAS,eAAiB,GAC1CmB,EAAcnB,EAAS,aAAe,EACtCoB,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAAG,CACrB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMtB,EAAUqB,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAIvB,EAAQ,OAASkB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7ElC,EAAS,cAAgBU,EAAY,mBACvC,MAAMV,EAAS,OAAO,kBAAkBM,CAAS,EACjD,MAAMN,EAAS,OAAO,mBAAmB,YAAaM,CAAS,GAGjE,MAAM,IAAI,QAAegC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAMtC,EAAS,YACb,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,KAAMC,CACR,EACA,EACF,EACAwB,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEGrC,EAAS,cAAgBU,EAAY,kBACvC,MAAMV,EAAS,OAAO,mBAAmB,SAAUM,CAAS,CAEhE,CACF,MACE,MAAMN,EAAS,YACb,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,GAAU,cAAgB,IACjC,KAAMG,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEAwB,EAAc,mBAAmB,EAEjC,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIpC,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,CACH,CAEA,MAAc,eACZJ,EACAM,EACAD,EACAQ,EACAT,EACAD,EACAI,EACA,CACA,IAAMN,EAAO,MAAM,KAAK,iBAAiBD,EAAU,CACjD,UAAAM,EACA,SAAAC,EACA,MAAOF,EAAI,EACb,CAAC,EAEGJ,EAAK,UACPG,EAAUH,EAAK,SAGjB,IAAMa,EAAU,MAAM,KAAK,iBAAiBd,EAAUI,EAASC,EAAKC,EAAWC,EAAUJ,CAAO,EAE3FW,GAEL,MAAM,KAAK,oBAAoBd,EAAUM,EAAWF,EAASS,EAAUC,CAAO,CAGhF,CAEA,MAAa,WACXd,EACAM,EACAD,EACAD,EACAS,EACAV,EACAI,EACA,CACA,GAAIH,GAAWA,EAAQ,SAAW,SAChC,OAGF,GAAIA,GAAWS,EAAS,QAAUA,EAAS,OAAS,EAAG,CACrD,IAAM4B,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAKtC,EAAQ,SAAS,EAAE,QAAQ,EAEvDuC,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7B9B,EAAS,OAAQ,CAC/BA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIT,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOC,EAAI,GACX,UAAWC,CACb,CACF,CAAC,EAGH,MAAM,KAAK,eAAeN,EAAUM,EAAWD,EAAKQ,EAAUT,EAASD,EAASI,CAAQ,EACxF,MACF,CACF,CAEA,GAAI,CAACH,EAAS,CACZ,MAAM,KAAK,eAAeJ,EAAUM,EAAWD,EAAKQ,EAAUT,EAASD,EAASI,CAAQ,EACxF,MACF,CAYA,GAVA,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIH,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEG,CAACD,EAAS,CACRU,EAAS,iBACX,KAAK,UAAU,YAAYb,EAAS,YAAY,EAAE,YAChD,CACE,OAAQM,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOO,EAAS,cAAgB,IAChC,KAAMA,EAAS,cACjB,EACA,EACF,EAEA2B,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAI3B,EAAS,eAAiBV,EAAQ,YAAY,IAAMU,EAAS,cAAc,YAAY,EAAG,CACxFA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIT,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOC,EAAI,GACX,UAAWC,CACb,CACF,CAAC,EAEH,MACF,CAEA,IAAMQ,EAAU,MAAM,KAAK,iBAAiBd,EAAUI,EAASC,EAAKC,EAAWC,EAAUJ,CAAO,EAE3FW,GAEL,MAAM,KAAK,oBAAoBd,EAAUM,EAAWF,EAASS,EAAUC,CAAO,CAGhF,CACF,EC/ZO,IAAM8B,GAAN,cAAgCC,EAAwD,CAC7F,YACmBC,EACjBC,EACAC,EACA,CACA,MAAMD,EAAkBC,CAAS,EAJhB,oBAAAF,EAWnB,KAAgB,OAAS,IAAIG,EAAO,mBAAmB,EAMvD,yBAAyF,CAAC,EAXxF,KAAK,cAAgB,KAAK,iBAAiB,QAC3C,KAAK,mBAAqB,KAAK,iBAAiB,eAChD,KAAK,kBAAoB,KAAK,iBAAiB,kBACjD,CAWA,MAAa,UAAUC,EAAuBC,EAAkB,CAC9D,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GACE,CAACC,EAAK,QACN,CAACA,EAAK,eACN,CAACA,EAAK,cACN,CAACA,EAAK,gBACN,CAACA,EAAK,iBACN,CAACA,EAAK,eACN,CAACA,EAAK,UACN,CAACA,EAAK,cACN,CAACA,EAAK,YACN,CAACA,EAAK,eACN,CAACA,EAAK,YACN,CACA,IAAME,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYD,CACd,CACF,CAAC,GAEGD,EAAK,SAAW,QAAaA,EAAK,SAAW,QAAMA,EAAK,OAASE,EAAoB,SACrFF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,EAAoB,gBACvCF,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeE,EAAoB,eACtCF,EAAK,iBAAmB,QAAaA,EAAK,iBAAmB,QAC/DA,EAAK,eAAiBE,EAAoB,iBACxCF,EAAK,kBAAoB,QAAaA,EAAK,kBAAoB,QACjEA,EAAK,gBAAkBE,EAAoB,kBACzCF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,EAAoB,gBACvCF,EAAK,WAAa,QAAaA,EAAK,WAAa,QAAMA,EAAK,SAAWE,EAAoB,WAC3FF,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeE,EAAoB,eACtCF,EAAK,aAAe,QAAaA,EAAK,aAAe,QAAMA,EAAK,WAAaE,EAAoB,aACjGF,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBE,GAAqB,eAAiB,KACzDF,EAAK,cAAgB,QAAaA,EAAK,cAAgB,QACzDA,EAAK,YAAcE,GAAqB,aAAe,GAEpDA,GACH,MAAM,KAAK,SAASH,EAAU,CAC5B,OAAQC,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CAAC,CAEL,CAUA,GARwB,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYC,CACd,CACF,CAAC,GAEsBD,EAAK,cAAgB,MAC1C,MAAM,IAAI,MAAM,gGAAgG,EAWlH,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,WAAYC,EACZ,OAAQD,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAW3D,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYC,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAID,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAU7C,GAPuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,WAAYC,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAyBF,OAxBY,MAAM,KAAK,cAAc,OAAO,CAC1C,KAAM,CACJ,QAASD,GAAM,QACf,YAAaA,EAAK,YAClB,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYC,EACZ,YAAaD,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAEA,MAAa,QAAQJ,EAAuB,CAC1C,IAAME,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BK,EAAO,MAAM,KAAK,cAAc,SAAS,CAC7C,MAAO,CACL,WAAYH,CACd,CACF,CAAC,EAED,OAAKG,EAAK,OAIHA,EAHE,IAIX,CAEA,MAAa,SAASL,EAAuBM,EAAe,CAC1D,IAAMJ,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAGjC,OAAOK,CACT,CAEA,MAAa,UAAUP,EAAuBM,EAAeL,EAAkB,CAC7E,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAID,EAAK,cAAgB,OACC,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,GAAI,CACF,IAAKK,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,4FAA4F,EAehH,GAXuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,GAAI,CACF,IAAKI,CACP,EACA,WAAYJ,EACZ,OAAQD,EAAK,OACb,OAAQA,EAAK,MACf,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,oBAAoB,EAGtC,GAAIA,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAY3D,GATuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKK,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAID,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAW7C,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKK,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CA4BF,OA3BY,MAAM,KAAK,cAAc,OAAO,CAC1C,MAAO,CACL,GAAII,CACN,EACA,KAAM,CACJ,QAASL,GAAM,QACf,YAAaA,EAAK,YAClB,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYC,EACZ,YAAaD,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAEA,MAAa,UAAUJ,EAAuBM,EAAe,CAC3D,IAAMJ,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,eAAe,EAGjC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,eAAe,EAEjC,GAAI,CACF,aAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOI,CACT,CACF,CAAC,EAED,MAAM,KAAK,cAAc,OAAO,CAC9B,MAAO,CACL,GAAIA,CACN,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,GAAIA,CAAM,CAAE,CAC9B,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,oBAAoB,CACtC,CACF,CAGA,MAAa,SAASJ,EAAuBC,EAAW,CACtD,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAIM,EAAU,CACZ,IAAMC,EAAiB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAID,EAAS,EACf,EACA,KAAM,CACJ,OAAQP,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,kBAAmBA,EAAK,kBACxB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,OAAQQ,EAAe,OACvB,cAAeA,EAAe,cAC9B,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,gBAAiBA,EAAe,gBAChC,cAAeA,EAAe,cAC9B,SAAUA,EAAe,SACzB,aAAcA,EAAe,aAC7B,kBAAmBA,EAAe,kBAClC,WAAYA,EAAe,WAC3B,cAAeA,EAAe,cAC9B,YAAaA,EAAe,WAC9B,CACF,CAEA,IAAMC,EAAe,MAAM,KAAK,mBAAmB,OAAO,CACxD,KAAM,CACJ,OAAQT,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,kBAAmBA,EAAK,kBACxB,WAAYA,EAAK,WACjB,WAAYC,EACZ,cAAeD,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,OAAQS,EAAa,OACrB,cAAeA,EAAa,cAC5B,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,gBAAiBA,EAAa,gBAC9B,cAAeA,EAAa,cAC5B,SAAUA,EAAa,SACvB,aAAcA,EAAa,aAC3B,kBAAmBA,EAAa,kBAChC,WAAYA,EAAa,WACzB,cAAeA,EAAa,cAC5B,YAAaA,EAAa,WAC5B,CACF,OAASN,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,cAAcJ,EAAuB,CAChD,GAAI,CACF,IAAME,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,EACA,QAAS,CACP,SAAU,EACZ,CACF,CAAC,EAED,OAAKM,EAiBE,CACL,OAAQA,EAAS,OACjB,cAAeA,EAAS,cACxB,aAAcA,EAAS,aACvB,eAAgBA,EAAS,eACzB,gBAAiBA,EAAS,gBAC1B,cAAeA,EAAS,cACxB,SAAUA,EAAS,SACnB,WAAYA,EAAS,WACrB,cAAeA,EAAS,cACxB,YAAaA,EAAS,YACtB,kBAAmBA,EAAS,kBAC5B,SAAUA,EAAS,QACrB,EA7BS,CACL,OAAQ,EACR,cAAe,GACf,aAAc,EACd,eAAgB,GAChB,gBAAiB,GACjB,cAAe,GACf,SAAU,GACV,WAAY,CAAC,EACb,cAAe,GACf,YAAa,EACb,kBAAmB,GACnB,SAAU,IACZ,CAiBJ,OAASJ,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiC,CACnD,CACF,CAGA,MAAa,aAAaJ,EAAuBC,EAAW,CAC1D,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAAD,CACF,CACF,CAAC,EAEKS,EAAYV,EAAK,UACjBW,EAASX,EAAK,OAEpB,GAAIW,IAAW,SACb,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWD,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,UAAWA,EAAW,OAAQC,CAAO,CAAE,EAGzD,GAAIA,IAAW,SACb,OAAIT,GAAqB,SACvB,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWQ,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWA,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAGI,CAAE,IAAK,CAAE,GAAGX,EAAU,IAAK,CAAE,UAAWW,EAAW,OAAQC,CAAO,CAAE,CAAE,EACxE,CACL,IAAMC,EAAU,MAAM,KAAK,kBAAkB,WAAW,CACtD,MAAO,CACL,WAAYX,EACZ,UAAWS,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQC,CACV,CACF,CAAC,EAQD,MAAO,CAAE,IAAK,CAAE,GAAGZ,EAAU,IANb,CACd,UAAWW,EACX,OAAQC,EACR,QAAAC,CACF,CAE0C,CAAE,CAC9C,CACF,OAAST,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAEA,MAAa,cAAcJ,EAAuBM,EAAeK,EAAoB,CACnF,GAAI,CACF,IAAMT,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BO,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAIC,GAAOA,EAAI,aAAeL,EAC5B,MAAM,IAAI,MAAM,gBAAgB,EAGlC,OAAO,MAAM,KAAK,kBAAkB,SAAS,CAC3C,MAAO,CACL,WAAYA,EACZ,UAAAS,EACA,MAAOJ,EAAMD,EAAQ,CAAE,IAAK,IAAK,EACjC,KAAM,SACR,CACF,CAAC,CACH,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAEA,MAAa,UAAUJ,EAAuBC,EAAoB,CAChE,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMF,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYN,CACd,CACF,CAAC,EAED,GAAI,CAACM,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,IAAIM,EAAkBN,GAAU,YAAc,CAAC,EAE/C,GAAIP,EAAK,SAAW,MAAO,CACzB,GAAIa,EAAW,SAASb,EAAK,SAAS,EAAG,MAAO,CAAE,WAAYa,CAAW,EAEzEA,EAAW,KAAKb,EAAK,SAAS,CAChC,MACEa,EAAaA,EAAW,OAAQC,GAAQA,IAAQd,EAAK,SAAS,EAYhE,MAAO,CACL,YAVqB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAIO,EAAS,EACf,EACA,KAAM,CACJ,WAAYM,CACd,CACF,CAAC,GAG4B,UAC7B,CACF,OAASV,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAGA,MAAa,KAAK,CAAE,SAAAJ,EAAU,UAAAW,EAAW,IAAAK,CAAI,EAAa,CACxD,GAAI,CACF,IAAMR,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYR,EAAS,UACvB,CACF,CAAC,EAED,GAAI,KAAK,gBAAgBQ,GAAU,WAAYG,CAAS,EAAG,OAE3D,IAAME,EAAU,MAAM,KAAK,WAAWF,EAAWX,CAAQ,EAEnDiB,EAAUC,GAAuBF,CAAG,EAEtCG,EAAW,MAAM,KAAK,eAAe,KAAK,cAAeF,EAASjB,EAAUa,CAAO,EAEvF,GAAI,CAACM,EAAS,CACZ,IAAMC,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYpB,EAAS,UACvB,CACF,CAAC,EAED,GAAIoB,GAAU,kBAOZD,EANqB,MAAM,KAAK,cAAc,UAAU,CACtD,MAAO,CACL,GAAIC,EAAS,iBACf,CACF,CAAC,MAID,OAEJ,CAEA,IAAIC,EAASF,GAAS,OAClBG,EAAgBH,GAAS,cACzBI,EAAeJ,GAAS,aACxBK,EAAiBL,GAAS,eAC1BM,EAAkBN,GAAS,gBAC3BO,EAAgBP,GAAS,cACzBQ,EAAWR,GAAS,SACpBS,EAAeT,GAAS,aACxBL,EAAaK,GAAS,WACtBU,EAAgBV,GAAS,cACzBW,EAAcX,GAAS,YAECE,GAAW,OAAMA,EAASb,EAAS,QAC5Bc,GAAkB,OAAMA,EAAgBd,EAAS,eAClDe,GAAiB,OAAMA,EAAef,EAAS,cAC7CgB,GAAmB,OAAMA,EAAiBhB,EAAS,gBAClDiB,GAAoB,OAAMA,EAAkBjB,EAAS,iBACvDkB,GAAkB,OAAMA,EAAgBlB,EAAS,eACtDmB,GAAa,OAAMA,EAAWnB,EAAS,UACnCoB,GAAiB,OAAMA,EAAepB,EAAS,cACjDM,GAAe,OAAMA,EAAaN,EAAS,YACxCqB,GAAkB,OAAMA,EAAgBrB,GAAU,eAAiB,IACrEsB,GAAgB,OAAMA,EAActB,GAAU,aAAe,GAE9F,IAAMuB,EAAMf,EAAI,IAOhB,GAAIU,GAAiBK,EAAI,QAAUlB,EAAS,CAC1C,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EACD,MACF,CAMA,GAJI,CAACY,GAAmBM,EAAI,QAIxBlB,GAAW,CAACA,EAAQ,UACtB,OAGEe,GAAgBA,EAAe,EACjC,KAAK,gBAAgB,KAAK,oBAAqBX,EAASN,EAAWiB,EAAc,MAAOI,GAAqB,CAC3G,MAAM,KAAK,eAAe,WACxB,KAAK,UAAU,YAAYhC,EAAS,YAAY,EAChDW,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAE,EACAhB,GAAK,QACP,CACF,CAAC,EAED,MAAM,KAAK,eAAe,WACxB,KAAK,UAAU,YAAYhB,EAAS,YAAY,EAChDW,EACAQ,EACAN,EACA,CACE,GAAGL,EACH,OAAAa,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAd,EACA,cAAAe,EACA,YAAAC,CACF,EACAb,EACAD,GAAK,QACP,EAGF,MACF,OAASZ,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACF,ECl1BA,OAAO6B,OAAW,QAEX,IAAMC,GAAN,KAAqB,CAC1B,YACmBC,EACAC,EACAC,EACjB,CAHiB,eAAAF,EACA,mBAAAC,EACA,sBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,gBAAgB,CAFlD,CAIH,MAAa,iBAAiBC,EAAuBC,EAAW,CAC9D,GAAI,CAcF,MAAO,CAAE,QAbO,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpE,KAAM,CACJ,UAAWA,EAAK,UAChB,SAAUA,EAAK,SACf,UAAWA,EAAK,UAChB,OAAQ,SACR,UAAW,GACX,MAAOA,EAAK,MACZ,WAAYD,EAAS,WACrB,KAAM,SACR,CACF,CAAC,CAEgB,CACnB,OAASE,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEQ,eAAeC,EAAiB,CACtC,OAAOA,EAAQ,SAAS,cAAc,CACxC,CAEA,MAAc,iBAAiBH,EAAeI,EAAcC,EAAmBC,EAAkBH,EAAiB,CAChH,IAAMI,EAAe,CACnB,SAAUJ,EACV,eAAgB,CACd,UAAWE,EACX,KAAM,CACJ,UAAWA,EACX,SAAUC,EACV,aAAcN,EAAS,aACvB,UAAW,KAAK,cAAc,IAAgB,QAAQ,EAAE,IACxD,OAAQ,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GACjE,CACF,CACF,EAEA,GAAI,KAAK,eAAeG,CAAO,EAAG,CAChC,IAAMK,EAAeL,EAAQ,MAAM,GAAG,EAEtCI,EAAQ,QAAU,CAChB,CACE,KAAMC,EAAa,CAAC,EAAE,MAAM,GAAG,EAAE,CAAC,EAClC,KAAM,MACN,KAAM,cACN,KAAM,WACR,CACF,EACAD,EAAQ,SAAWC,EAAa,CAAC,GAAKL,CACxC,CAEIH,EAAS,cAAgBS,EAAY,mBACvC,MAAMT,EAAS,OAAO,kBAAkBK,CAAS,EACjD,MAAML,EAAS,OAAO,mBAAmB,YAAaK,CAAS,GAGjE,IAAIK,EAAe,CACjB,eAAgB,kBAClB,EAEIN,EAAI,SACNM,EAAU,CACR,GAAGA,EACH,cAAe,UAAUN,EAAI,MAAM,EACrC,GAGF,IAAMO,EAAWP,EAAI,OAErB,GAAI,CAACO,EAAU,OAAO,KAEtB,IAAMC,EAAW,MAAMlB,GAAM,KAAKiB,EAAUJ,EAAS,CACnD,QAAAG,CACF,CAAC,EAED,OAAIV,EAAS,cAAgBS,EAAY,kBACvC,MAAMT,EAAS,OAAO,mBAAmB,SAAUK,CAAS,EAE9CO,GAAU,MAAM,IAGlC,CAEA,MAAc,oBACZZ,EACAK,EACAQ,EACAC,EACAC,EACA,CACA,IAAMC,EAAY,0BAEdC,EAAa,GACbC,EAAY,EAEZC,EAEEC,EAAgBC,GAA+B,CACnD,IAAMC,EAAYD,EAAI,MAAM,GAAG,EAAE,IAAI,GAAG,YAAY,EAC9CE,EAAkB,CAAC,MAAO,OAAQ,MAAO,MAAO,MAAO,MAAM,EAC7DC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAkB,CAAC,MAAO,MAAO,MAAO,KAAK,EAC7CC,EAAqB,CAAC,MAAO,MAAO,OAAQ,MAAO,OAAQ,MAAO,OAAQ,KAAK,EAErF,OAAIH,EAAgB,SAASD,GAAa,EAAE,EAAU,QAClDE,EAAgB,SAASF,GAAa,EAAE,EAAU,QAClDG,EAAgB,SAASH,GAAa,EAAE,EAAU,QAClDI,EAAmB,SAASJ,GAAa,EAAE,EAAU,WAClD,IACT,EAEA,MAAQH,EAAQH,EAAU,KAAKD,CAAO,KAAO,MAAM,CACjD,GAAM,CAACY,EAAWC,EAAUC,EAASR,CAAG,EAAIF,EACtCW,EAAYV,EAAaC,CAAG,EAE5BU,EAAahB,EAAQ,MAAMG,EAAWC,EAAM,KAAK,EAKvD,GAJIY,IACFd,GAAcc,GAGZD,EAAW,CACb,IAAME,EAAgBlB,EAAS,eAAiB,GAC1CmB,EAAcnB,EAAS,aAAe,EACtCoB,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAAG,CACrB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMtB,EAAUqB,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAIvB,EAAQ,OAASkB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7EnC,EAAS,cAAgBS,EAAY,mBACvC,MAAMT,EAAS,OAAO,kBAAkBK,CAAS,EACjD,MAAML,EAAS,OAAO,mBAAmB,YAAaK,CAAS,GAGjE,MAAM,IAAI,QAAekC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAMvC,EAAS,YACb,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,KAAMC,CACR,EACA,EACF,EACAwB,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEGtC,EAAS,cAAgBS,EAAY,kBACvC,MAAMT,EAAS,OAAO,mBAAmB,SAAUK,CAAS,CAEhE,CACF,MACE,MAAML,EAAS,YACb,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,KAAMG,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEIa,IAAc,QAChB,MAAM9B,EAAS,cAAc,CAC3B,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,MAAOO,EACP,QAASQ,CACX,CAAC,EAED,MAAM7B,EAAS,aACb,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,UAAWgB,EACX,MAAOT,EACP,QAASQ,CACX,EACA,KACA,EACF,CAEJ,MACEZ,GAAc,IAAIY,CAAO,KAAKR,CAAG,IAGnCH,EAAYF,EAAU,SACxB,CAEA,GAAIE,EAAYH,EAAQ,OAAQ,CAC9B,IAAMyB,EAAgBzB,EAAQ,MAAMG,CAAS,EACzCsB,EAAc,KAAK,IACrBvB,GAAcuB,EAElB,CAEA,IAAMR,EAAgBlB,EAAS,eAAiB,GAC1CmB,EAAcnB,EAAS,aAAe,EACtCoB,EAAW,IACXC,EAAW,IAEjB,GAAIlB,EAAW,KAAK,EAAG,CACrB,GAAIe,EAAe,CACjB,IAAMI,EAAmBnB,EAAW,KAAK,EAAE,MAAM;AAAA;AAAA,CAAM,EAEvD,QAASoB,EAAQ,EAAGA,EAAQD,EAAiB,OAAQC,IAAS,CAC5D,IAAMtB,EAAUqB,EAAiBC,CAAK,EAEhCC,EAAQ,KAAK,IAAI,KAAK,IAAIvB,EAAQ,OAASkB,EAAaC,CAAQ,EAAGC,CAAQ,EAE7EnC,EAAS,cAAgBS,EAAY,mBACvC,MAAMT,EAAS,OAAO,kBAAkBK,CAAS,EACjD,MAAML,EAAS,OAAO,mBAAmB,YAAaK,CAAS,GAGjE,MAAM,IAAI,QAAekC,GAAY,CACnC,WAAW,SAAY,CACrB,MAAMvC,EAAS,YACb,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,KAAMC,CACR,EACA,EACF,EACAwB,EAAQ,CACV,EAAGD,CAAK,CACV,CAAC,EAEGtC,EAAS,cAAgBS,EAAY,kBACvC,MAAMT,EAAS,OAAO,mBAAmB,SAAUK,CAAS,CAEhE,CACF,MACE,MAAML,EAAS,YACb,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,GAAU,cAAgB,IACjC,KAAMG,EAAW,KAAK,CACxB,EACA,EACF,EAEFA,EAAa,EACf,CAEAwB,EAAc,mBAAmB,EAEjC,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAI5B,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,CAGH,CAEA,MAAc,eACZb,EACAK,EACAD,EACAU,EACAD,EACAV,EACAG,EACA,CACA,IAAML,EAAO,MAAM,KAAK,iBAAiBD,EAAU,CACjD,UAAAK,EACA,SAAAC,EACA,MAAOF,EAAI,EACb,CAAC,EAEGH,EAAK,UACPY,EAAUZ,EAAK,SAGjB,IAAMc,EAAU,MAAM,KAAK,iBAAiBf,EAAUI,EAAKC,EAAWC,EAAUH,CAAO,EAEvF,MAAM,KAAK,oBAAoBH,EAAUK,EAAWQ,EAASC,EAAUC,CAAO,CAGhF,CAEA,MAAa,WACXf,EACAK,EACAD,EACAS,EACAC,EACAX,EACAG,EACA,CACA,GAAIO,GAAWA,EAAQ,SAAW,SAChC,OAGF,GAAIA,GAAWC,EAAS,QAAUA,EAAS,OAAS,EAAG,CACrD,IAAM4B,EAAM,KAAK,IAAI,EAEfC,EAAmB,IAAI,KAAK9B,EAAQ,SAAS,EAAE,QAAQ,EAEvD+B,EAAOF,EAAMC,EAInB,GAFsB,KAAK,MAAMC,EAAO,IAAO,EAAE,EAE7B9B,EAAS,OAAQ,CAC/BA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOT,EAAI,GACX,UAAWC,CACb,CACF,CAAC,EAGH,MAAM,KAAK,eAAeL,EAAUK,EAAWD,EAAKU,EAAUD,EAASV,EAASG,CAAQ,EACxF,MACF,CACF,CAEA,GAAI,CAACO,EAAS,CACZ,MAAM,KAAK,eAAeb,EAAUK,EAAWD,EAAKU,EAAUD,EAASV,EAASG,CAAQ,EACxF,MACF,CAYA,GAVA,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAIO,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,SACR,UAAW,EACb,CACF,CAAC,EAEG,CAACV,EAAS,CACRW,EAAS,iBACX,KAAK,UAAU,YAAYd,EAAS,YAAY,EAAE,YAChD,CACE,OAAQK,EAAU,MAAM,GAAG,EAAE,CAAC,EAC9B,MAAOS,EAAS,cAAgB,IAChC,KAAMA,EAAS,cACjB,EACA,EACF,EAEA2B,EAAc,mBAAmB,GAEnC,MACF,CAEA,GAAI3B,EAAS,eAAiBX,EAAQ,YAAY,IAAMW,EAAS,cAAc,YAAY,EAAG,CACxFA,EAAS,SACX,MAAM,KAAK,iBAAiB,mBAAmB,OAAO,CACpD,MAAO,CACL,GAAID,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOT,EAAI,GACX,UAAWC,CACb,CACF,CAAC,EAEH,MACF,CAEA,IAAMU,EAAU,MAAM,KAAK,iBAAiBf,EAAUI,EAAKC,EAAWC,EAAUH,CAAO,EAEvF,MAAM,KAAK,oBAAoBH,EAAUK,EAAWQ,EAASC,EAAUC,CAAO,CAGhF,CACF,EC7ZA,OAAO8B,OAAY,SAIZ,IAAMC,GAAN,cAA+BC,EAAwD,CAC5F,YACmBC,EACjBC,EACAC,EACA,CACA,MAAMD,EAAkBC,CAAS,EAJhB,mBAAAF,EAYnB,KAAgB,OAAS,IAAIG,EAAO,kBAAkB,EAEtD,wBAAqBC,EAAc,IAAY,QAAQ,EAAE,QAIzD,yBAAyF,CAAC,EAZxF,KAAK,cAAgB,KAAK,iBAAiB,UAC3C,KAAK,mBAAqB,KAAK,iBAAiB,cAChD,KAAK,kBAAoB,KAAK,iBAAiB,mBAC/C,KAAK,gBAAkB,KAAK,iBAAiB,WAC/C,CAaA,MAAa,kBAAkBC,EAAuBC,EAAsB,CAC1E,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GAAI,CAACC,EAAK,OAAQ,MAAM,IAAI,MAAM,qBAAqB,EACvD,GAAI,CAACA,EAAK,KAAM,MAAM,IAAI,MAAM,kBAAkB,EAElD,GAAI,CASF,OARc,MAAM,KAAK,gBAAgB,OAAO,CAC9C,KAAM,CACJ,KAAMA,EAAK,KACX,OAAQA,EAAK,OACb,WAAYE,CACd,CACF,CAAC,CAGH,OAASC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,6BAA6B,CAC/C,CACF,CAEA,MAAa,gBAAgBJ,EAAuB,CAClD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAWjC,OATc,MAAM,KAAK,gBAAgB,SAAS,CAChD,MAAO,CACL,WAAYG,CACd,EACA,QAAS,CACP,gBAAiB,EACnB,CACF,CAAC,CAGH,CAEA,MAAa,YAAYH,EAAuBK,EAAuB,CACrE,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIH,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BM,EAAQ,MAAM,KAAK,gBAAgB,UAAU,CACjD,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAIA,EAAM,aAAeH,EACvB,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAI,CACF,aAAM,KAAK,gBAAgB,OAAO,CAChC,MAAO,CACL,GAAIE,CACN,CACF,CAAC,EAEM,CAAE,YAAa,CAAE,GAAIA,CAAc,CAAE,CAC9C,OAASD,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,6BAA6B,CAC/C,CACF,CAGA,MAAa,UAAUJ,EAAuB,CAC5C,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GAAI,CAACG,EAAY,MAAM,IAAI,MAAM,oBAAoB,EAErD,IAAMI,EAAkB,MAAM,KAAK,mBAAmB,UAAU,CAC9D,MAAO,CACL,WAAYJ,CACd,EACA,QAAS,CACP,YAAa,EACf,CACF,CAAC,EAED,GAAI,CAACI,EAAiB,MAAM,IAAI,MAAM,oBAAoB,EAE1D,GAAM,CAAE,OAAAC,CAAO,EAAID,EAAgB,YAEnC,GAAI,CACF,YAAK,OAAS,IAAIE,GAAO,CAAE,OAAAD,CAAO,CAAC,GAEf,MAAM,KAAK,OAAO,OAAO,KAAK,IAEnC,MAAM,IACvB,OAASJ,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAGA,MAAa,UAAUJ,EAAuBC,EAAiB,CAC7D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GACE,CAACC,EAAK,eACN,CAACA,EAAK,QACN,CAACA,EAAK,eACN,CAACA,EAAK,cACN,CAACA,EAAK,gBACN,CAACA,EAAK,iBACN,CAACA,EAAK,eACN,CAACA,EAAK,UACN,CAACA,EAAK,cACN,CAACA,EAAK,YACN,CAACA,EAAK,eACN,CAACA,EAAK,YACN,CACA,IAAMS,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYP,CACd,CACF,CAAC,EAsBD,IApBIF,EAAK,SAAW,QAAaA,EAAK,SAAW,QAAMA,EAAK,OAASS,EAAoB,SACrFT,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBS,EAAoB,gBACvCT,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeS,EAAoB,eACtCT,EAAK,iBAAmB,QAAaA,EAAK,iBAAmB,QAC/DA,EAAK,eAAiBS,EAAoB,iBACxCT,EAAK,kBAAoB,QAAaA,EAAK,kBAAoB,QACjEA,EAAK,gBAAkBS,EAAoB,kBACzCT,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBS,EAAoB,gBACvCT,EAAK,WAAa,QAAaA,EAAK,WAAa,QAAMA,EAAK,SAAWS,EAAoB,WAC3FT,EAAK,eAAiB,QAAaA,EAAK,eAAiB,QAC3DA,EAAK,aAAeS,EAAoB,eACtCT,EAAK,aAAe,QAAaA,EAAK,aAAe,QAAMA,EAAK,WAAaS,EAAoB,aACjGT,EAAK,gBAAkB,QAAaA,EAAK,gBAAkB,QAC7DA,EAAK,cAAgBS,GAAqB,eAAiB,KACzDT,EAAK,cAAgB,QAAaA,EAAK,cAAgB,QACzDA,EAAK,YAAcS,GAAqB,aAAe,GAErD,CAACT,EAAK,cACR,MAAM,IAAI,MAAM,6BAA6B,EAG1CS,GACH,MAAM,KAAK,SAASV,EAAU,CAC5B,cAAeC,EAAK,cACpB,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CAAC,CAEL,CAUA,GARwB,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYE,CACd,CACF,CAAC,GAEsBF,EAAK,cAAgB,MAC1C,MAAM,IAAI,MAAM,+FAA+F,EAGjH,IAAIU,EAAwB,CAC1B,WAAYR,CACd,EAEA,GAAIF,EAAK,UAAY,YAAa,CAChC,GAAI,CAACA,EAAK,YAAa,MAAM,IAAI,MAAM,0BAA0B,EAEjEU,EAAmB,CACjB,GAAGA,EACH,YAAaV,EAAK,YAClB,QAASA,EAAK,OAChB,CACF,SAAWA,EAAK,UAAY,iBAAkB,CAC5C,GAAI,CAACA,EAAK,MAAO,MAAM,IAAI,MAAM,mBAAmB,EACpD,GAAI,CAACA,EAAK,UAAW,MAAM,IAAI,MAAM,wBAAwB,EAE7DU,EAAmB,CACjB,GAAGA,EACH,MAAOV,EAAK,MACZ,UAAWA,EAAK,UAChB,QAASA,EAAK,OAChB,CACF,KACE,OAAM,IAAI,MAAM,sBAAsB,EAOxC,GAJuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAOU,CACT,CAAC,EAGC,MAAM,IAAI,MAAM,2BAA2B,EAG7C,GAAIV,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAW3D,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAU7C,GAPuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAgCF,OA/BY,MAAM,KAAK,cAAc,OAAO,CAC1C,KAAM,CACJ,QAASF,GAAM,QACf,YAAaA,EAAK,YAClB,cAAeA,EAAK,cACpB,QAASA,EAAK,QACd,YAAaA,EAAK,YAClB,YAAaA,EAAK,YAClB,MAAOA,EAAK,MACZ,eAAgBA,EAAK,eACrB,kBAAmBA,EAAK,kBACxB,aAAcA,EAAK,aACnB,UAAWA,EAAK,UAChB,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYE,EACZ,YAAaF,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,2BAA2B,CAC7C,CACF,CAEA,MAAa,QAAQJ,EAAuB,CAC1C,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BY,EAAO,MAAM,KAAK,cAAc,SAAS,CAC7C,MAAO,CACL,WAAAT,CACF,CACF,CAAC,EAED,OAAKS,EAAK,OAIHA,EAHE,IAIX,CAEA,MAAa,SAASZ,EAAuBa,EAAe,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIX,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Bc,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,sBAAsB,EAGxC,GAAIA,EAAI,aAAeX,EACrB,MAAM,IAAI,MAAM,sBAAsB,EAGxC,OAAOW,CACT,CAEA,MAAa,UAAUd,EAAuBa,EAAeZ,EAAiB,CAC5E,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Bc,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,sBAAsB,EAGxC,GAAIA,EAAI,aAAeX,EACrB,MAAM,IAAI,MAAM,sBAAsB,EAGxC,GAAIF,EAAK,cAAgB,OACC,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,GAAI,CACF,IAAKY,CACP,EACA,WAAYV,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MACR,mGACF,EAIJ,IAAIQ,EAAwB,CAC1B,GAAI,CACF,IAAKE,CACP,EACA,WAAYV,CACd,EAEA,GAAIF,EAAK,UAAY,YAAa,CAChC,GAAI,CAACA,EAAK,YAAa,MAAM,IAAI,MAAM,0BAA0B,EAEjEU,EAAmB,CACjB,GAAGA,EACH,YAAaV,EAAK,WACpB,CACF,SAAWA,EAAK,UAAY,iBAAkB,CAC5C,GAAI,CAACA,EAAK,MAAO,MAAM,IAAI,MAAM,mBAAmB,EACpD,GAAI,CAACA,EAAK,UAAW,MAAM,IAAI,MAAM,wBAAwB,EAE7DU,EAAmB,CACjB,GAAGA,EACH,MAAOV,EAAK,MACZ,UAAWA,EAAK,SAClB,CACF,KACE,OAAM,IAAI,MAAM,sBAAsB,EAOxC,GAJuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAOU,CACT,CAAC,EAGC,MAAM,IAAI,MAAM,2BAA2B,EAG7C,GAAIV,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAY3D,GATuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKY,CAAM,EACjB,WAAYV,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAW7C,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKY,CAAM,EACjB,WAAYV,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAmCF,OAlCY,MAAM,KAAK,cAAc,OAAO,CAC1C,MAAO,CACL,GAAIU,CACN,EACA,KAAM,CACJ,QAASZ,GAAM,QACf,YAAaA,EAAK,YAClB,cAAeA,EAAK,cACpB,QAASA,EAAK,QACd,YAAaA,EAAK,YAClB,YAAaA,EAAK,YAClB,MAAOA,EAAK,MACZ,eAAgBA,EAAK,eACrB,kBAAmBA,EAAK,kBACxB,aAAcA,EAAK,aACnB,UAAWA,EAAK,UAChB,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYE,EACZ,YAAaF,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,CAGH,OAASG,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,2BAA2B,CAC7C,CACF,CAEA,MAAa,UAAUJ,EAAuBa,EAAe,CAC3D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIX,EAAoB,oBAAoB,EAEhF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Bc,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,sBAAsB,EAGxC,GAAIA,EAAI,aAAeX,EACrB,MAAM,IAAI,MAAM,sBAAsB,EAExC,GAAI,CACF,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,MAAOU,CACT,CACF,CAAC,EAED,MAAM,KAAK,cAAc,OAAO,CAC9B,MAAO,CACL,GAAIA,CACN,CACF,CAAC,EAEM,CAAE,IAAK,CAAE,GAAIA,CAAM,CAAE,CAC9B,OAAST,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,2BAA2B,CAC7C,CACF,CAGA,MAAa,SAASJ,EAAuBC,EAAW,CACtD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Be,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYZ,CACd,CACF,CAAC,EAED,GAAIY,EAAU,CACZ,IAAMC,EAAiB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAID,EAAS,EACf,EACA,KAAM,CACJ,cAAed,EAAK,cACpB,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,iBAAkBA,EAAK,iBACvB,WAAYA,EAAK,WACjB,cAAeA,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,cAAee,EAAe,cAC9B,OAAQA,EAAe,OACvB,cAAeA,EAAe,cAC9B,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,gBAAiBA,EAAe,gBAChC,cAAeA,EAAe,cAC9B,SAAUA,EAAe,SACzB,aAAcA,EAAe,aAC7B,aAAcA,EAAe,aAC7B,iBAAkBA,EAAe,iBACjC,WAAYA,EAAe,WAC3B,cAAeA,EAAe,cAC9B,YAAaA,EAAe,WAC9B,CACF,CAEA,IAAMC,EAAe,MAAM,KAAK,mBAAmB,OAAO,CACxD,KAAM,CACJ,cAAehB,EAAK,cACpB,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,iBAAkBA,EAAK,iBACvB,WAAYA,EAAK,WACjB,aAAcA,EAAK,aACnB,WAAYE,EACZ,cAAeF,EAAK,cACpB,YAAaA,EAAK,WACpB,CACF,CAAC,EAED,MAAO,CACL,cAAegB,EAAa,cAC5B,OAAQA,EAAa,OACrB,cAAeA,EAAa,cAC5B,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,gBAAiBA,EAAa,gBAC9B,cAAeA,EAAa,cAC5B,SAAUA,EAAa,SACvB,aAAcA,EAAa,aAC3B,iBAAkBA,EAAa,iBAC/B,WAAYA,EAAa,WACzB,aAAcA,EAAa,aAC3B,cAAeA,EAAa,cAC5B,YAAaA,EAAa,WAC5B,CACF,OAASb,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,cAAcJ,EAAuB,CAChD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,oBAAoB,EAEhF,GAAI,CACF,IAAMC,GACJ,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAC7C,OAAQ,CAAE,GAAI,EAAK,EACnB,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,IACA,GAEGe,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYZ,CACd,EACA,QAAS,CACP,SAAU,EACZ,CACF,CAAC,EAED,OAAKY,EAmBE,CACL,cAAeA,EAAS,cACxB,OAAQA,EAAS,OACjB,cAAeA,EAAS,cACxB,aAAcA,EAAS,aACvB,eAAgBA,EAAS,eACzB,gBAAiBA,EAAS,gBAC1B,cAAeA,EAAS,cACxB,SAAUA,EAAS,SACnB,WAAYA,EAAS,WACrB,cAAeA,EAAS,cACxB,YAAaA,EAAS,YACtB,iBAAkBA,EAAS,iBAC3B,aAAcA,EAAS,aACvB,SAAUA,EAAS,QACrB,EAjCS,CACL,cAAe,KACf,OAAQ,EACR,cAAe,GACf,aAAc,EACd,eAAgB,GAChB,gBAAiB,GACjB,cAAe,GACf,SAAU,GACV,WAAY,CAAC,EACb,cAAe,GACf,YAAa,EACb,iBAAkB,KAClB,aAAc,GACd,SAAU,IACZ,CAmBJ,OAASX,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiC,CACnD,CACF,CAGA,MAAa,aAAaJ,EAAuBC,EAAW,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BU,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAAP,CACF,CACF,CAAC,EAEKe,EAAYjB,EAAK,UACjBkB,EAASlB,EAAK,OAEpB,GAAIkB,IAAW,SACb,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWD,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAEM,CAAE,OAAQ,CAAE,UAAWA,EAAW,OAAQC,CAAO,CAAE,EAG5D,GAAIA,IAAW,SACb,OAAIT,GAAqB,SACvB,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWQ,EACX,MAAO,CAAE,IAAK,IAAK,EACnB,OAAQ,CAAE,IAAK,QAAS,CAC1B,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EAED,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWA,CACb,CACF,CAAC,EAGI,CAAE,OAAQ,CAAE,GAAGlB,EAAU,OAAQ,CAAE,UAAWkB,EAAW,OAAQC,CAAO,CAAE,CAAE,EAC9E,CACL,IAAMC,EAAU,MAAM,KAAK,kBAAkB,WAAW,CACtD,MAAO,CACL,WAAYjB,EACZ,UAAWe,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQC,CACV,CACF,CAAC,EAQD,MAAO,CAAE,OAAQ,CAAE,GAAGnB,EAAU,OANb,CACjB,UAAWkB,EACX,OAAQC,EACR,QAAAC,CACF,CAEmD,CAAE,CACvD,CACF,OAAShB,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAEA,MAAa,cAAcJ,EAAuBa,EAAeK,EAAoB,CACnF,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIhB,EAAoB,oBAAoB,EAEhF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BqB,EAAY,MAAM,KAAK,cAAc,UAAU,CACnD,MAAO,CACL,GAAIR,CACN,CACF,CAAC,EAED,GAAIQ,GAAaA,EAAU,aAAelB,EACxC,MAAM,IAAI,MAAM,sBAAsB,EAGxC,OAAO,MAAM,KAAK,kBAAkB,SAAS,CAC3C,MAAO,CACL,WAAYA,EACZ,UAAAe,EACA,MAAOG,EAAYR,EAAQ,CAAE,IAAK,IAAK,EACvC,KAAM,QACR,CACF,CAAC,CACH,OAAST,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAEA,MAAa,UAAUJ,EAAuBC,EAAoB,CAChE,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,oBAAoB,EAEhF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Be,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYZ,CACd,CACF,CAAC,EAED,GAAI,CAACY,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,IAAIO,EAAkBP,GAAU,YAAc,CAAC,EAE/C,GAAId,EAAK,SAAW,MAAO,CACzB,GAAIqB,EAAW,SAASrB,EAAK,SAAS,EAAG,MAAO,CAAE,WAAYqB,CAAW,EAEzEA,EAAW,KAAKrB,EAAK,SAAS,CAChC,MACEqB,EAAaA,EAAW,OAAQC,GAAQA,IAAQtB,EAAK,SAAS,EAYhE,MAAO,CACL,YAVqB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAIc,EAAS,EACf,EACA,KAAM,CACJ,WAAYO,CACd,CACF,CAAC,GAG4B,UAC7B,CACF,OAASlB,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAGA,MAAa,KAAK,CAAE,SAAAJ,EAAU,UAAAkB,EAAW,IAAAM,EAAK,SAAAC,CAAS,EAAa,CAClE,GAAK,KAAK,mBAEV,GAAI,CACF,IAAMV,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYf,EAAS,UACvB,CACF,CAAC,EAED,GAAI,KAAK,gBAAgBe,GAAU,WAAYG,CAAS,EAAG,OAE3D,IAAIE,EAAU,MAAM,KAAK,WAAWF,EAAWlB,CAAQ,EAEjD0B,EAAUC,GAAuBH,CAAG,EAEtCI,EAAW,MAAM,KAAK,eAAe,KAAK,cAAeF,EAAS1B,EAAUoB,CAAO,EAEvF,GAAI,CAACQ,EAAS,CACZ,IAAMC,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAY7B,EAAS,UACvB,CACF,CAAC,EAED,GAAI6B,GAAU,iBAOZD,EANqB,MAAM,KAAK,cAAc,UAAU,CACtD,MAAO,CACL,GAAIC,EAAS,gBACf,CACF,CAAC,MAID,OAEJ,CAEA,IAAIC,EAASF,GAAS,OAClBG,EAAgBH,GAAS,cACzBI,EAAeJ,GAAS,aACxBK,EAAiBL,GAAS,eAC1BM,EAAkBN,GAAS,gBAC3BO,EAAgBP,GAAS,cACzBQ,EAAWR,GAAS,SACpBS,EAAeT,GAAS,aACxBN,EAAaM,GAAS,WACtBU,EAAgBV,GAAS,cACzBW,EAAcX,GAAS,YAECE,GAAW,OAAMA,EAASf,EAAS,QAC5BgB,GAAkB,OAAMA,EAAgBhB,EAAS,eAClDiB,GAAiB,OAAMA,EAAejB,EAAS,cAC7CkB,GAAmB,OAAMA,EAAiBlB,EAAS,gBAClDmB,GAAoB,OAAMA,EAAkBnB,EAAS,iBACvDoB,GAAkB,OAAMA,EAAgBpB,EAAS,eACtDqB,GAAa,OAAMA,EAAWrB,EAAS,UACnCsB,GAAiB,OAAMA,EAAetB,EAAS,cACjDO,GAAe,OAAMA,EAAaP,EAAS,YACxCuB,GAAkB,OAAMA,EAAgBvB,GAAU,eAAiB,IACrEwB,GAAgB,OAAMA,EAAcxB,GAAU,aAAe,GAE9F,IAAMyB,EAAMhB,EAAI,IAsBhB,GAfIW,GAAiBK,EAAI,QAAUpB,IACjCA,EAAU,MAAM,KAAK,kBAAkB,OAAO,CAC5C,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,GAGC,CAACc,GAAmBM,EAAI,QAIxBpB,GAAW,CAACA,EAAQ,UACtB,OAGEiB,GAAgBA,EAAe,EACjC,KAAK,gBAAgB,KAAK,oBAAqBX,EAASR,EAAWmB,EAAc,MAAOI,GAAqB,CACvGb,EAAQ,UAAY,aACtB,MAAM,KAAK,cAAc,uBACvB,KAAK,UAAU,YAAY5B,EAAS,YAAY,EAChDkB,EACAO,EACAe,EAAI,OACJZ,EACAR,EACA,CACE,GAAGL,EACH,OAAAe,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAf,EACA,cAAAgB,EACA,YAAAC,CACF,EACAE,CACF,EAGEb,EAAQ,UAAY,kBACtB,MAAM,KAAK,cAAc,4BACvB,KAAK,UAAU,YAAY5B,EAAS,YAAY,EAChDkB,EACAO,EACAG,EACAR,EACA,CACE,GAAGL,EACH,OAAAe,EACA,cAAAC,EACA,aAAAC,EACA,eAAAC,EACA,gBAAAC,EACA,cAAAC,EACA,SAAAC,EACA,aAAAC,EACA,WAAAf,EACA,cAAAgB,EACA,YAAAC,CACF,EACAE,CACF,CAEJ,CAAC,GAEGb,EAAQ,UAAY,aACtB,MAAM,KAAK,cAAc,uBACvB,KAAK,UAAU,YAAY5B,EAAS,YAAY,EAChDkB,EACAO,EACAe,EAAI,OACJZ,EACAR,EACAL,EACAW,CACF,EAGEE,EAAQ,UAAY,kBACtB,MAAM,KAAK,cAAc,4BACvB,KAAK,UAAU,YAAY5B,EAAS,YAAY,EAChDkB,EACAO,EACAG,EACAR,EACAL,EACAW,CACF,GAIJ,MACF,OAAStB,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACF,ECzlCA,OAAOsC,OAAW,QAIX,IAAMC,GAAN,cAAgCC,EAAwD,CAC7F,YACmBC,EACjBC,EACAC,EACA,CACA,MAAMD,EAAkBC,CAAS,EAJhB,oBAAAF,EAWnB,KAAgB,OAAS,IAAIG,EAAO,mBAAmB,EAEvD,wBAAqBC,EAAc,IAAa,SAAS,EAAE,QAI3D,yBAAyF,CAAC,EAXxF,KAAK,cAAgB,KAAK,iBAAiB,QAC3C,KAAK,mBAAqB,KAAK,iBAAiB,eAChD,KAAK,kBAAoB,KAAK,iBAAiB,kBACjD,CAWA,MAAa,UAAUC,EAAuBC,EAAkB,CAC9D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAEjC,GACE,CAACC,EAAK,QACN,CAACA,EAAK,eACN,CAACA,EAAK,cACN,CAACA,EAAK,gBACN,CAACA,EAAK,iBACN,CAACA,EAAK,eACN,CAACA,EAAK,UACN,CAACA,EAAK,cACN,CAACA,EAAK,WACN,CACA,IAAMG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYD,CACd,CACF,CAAC,EAEIF,EAAK,SAAQA,EAAK,OAASG,GAAqB,QAAU,GAC1DH,EAAK,gBAAeA,EAAK,cAAgBG,GAAqB,eAAiB,SAC/EH,EAAK,eAAcA,EAAK,aAAeG,GAAqB,cAAgB,KAC5EH,EAAK,iBAAgBA,EAAK,eAAiBG,GAAqB,gBAAkB,4BAClFH,EAAK,kBAAiBA,EAAK,gBAAkBG,GAAqB,iBAAmB,IACrFH,EAAK,gBAAeA,EAAK,cAAgBG,GAAqB,eAAiB,IAC/EH,EAAK,WAAUA,EAAK,SAAWG,GAAqB,UAAY,IAChEH,EAAK,eAAcA,EAAK,aAAeG,GAAqB,cAAgB,GAC5EH,EAAK,aAAYA,EAAK,WAAaG,GAAqB,YAAc,CAAC,GAEvEA,GACH,MAAM,KAAK,SAASJ,EAAU,CAC5B,OAAQC,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYA,EAAK,UACnB,CAAC,CAEL,CAUA,GARwB,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,WAAYE,CACd,CACF,CAAC,GAEsBF,EAAK,cAAgB,MAC1C,MAAM,IAAI,MAAM,gGAAgG,EAWlH,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,IAAKA,EAAK,IACV,QAASA,EAAK,QACd,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAIF,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAW3D,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAU7C,GAPuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,WAAYE,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAuBF,OAtBY,MAAM,KAAK,cAAc,OAAO,CAC1C,KAAM,CACJ,QAASF,GAAM,QACf,YAAaA,EAAK,YAClB,IAAKA,EAAK,IACV,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,WAAYE,EACZ,YAAaF,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,UACnB,CACF,CAAC,CAGH,OAASI,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,wBAAwB,CAC1C,CACF,CAEA,MAAa,QAAQL,EAAuB,CAC1C,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,qBAAqB,EAEjF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BM,EAAO,MAAM,KAAK,cAAc,SAAS,CAC7C,MAAO,CACL,WAAYH,CACd,CACF,CAAC,EAED,OAAKG,EAAK,OAIHA,EAHE,IAIX,CAEA,MAAa,SAASN,EAAuBO,EAAe,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIL,EAAoB,qBAAqB,EAEjF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BQ,EAAM,MAAM,KAAK,cAAc,UAAU,CAC7C,MAAO,CACL,GAAID,CACN,CACF,CAAC,EAED,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,mBAAmB,EAGrC,GAAIA,EAAI,aAAeL,EACrB,MAAM,IAAI,MAAM,mBAAmB,EAGrC,OAAOK,CACT,CAEA,MAAa,UAAUR,EAAuBO,EAAeN,EAAkB,CAC7E,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAU,MAAM,KAAK,cAAc,UAAU,CACjD,MAAO,CACL,GAAIF,CACN,CACF,CAAC,EAED,GAAI,CAACE,EACH,MAAM,IAAI,MAAM,mBAAmB,EAGrC,GAAIA,EAAQ,aAAeN,EACzB,MAAM,IAAI,MAAM,mBAAmB,EAGrC,GAAIF,EAAK,cAAgB,OACC,MAAM,KAAK,cAAc,UAAU,CACzD,MAAO,CACL,QAAS,GACT,YAAa,MACb,GAAI,CACF,IAAKM,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MACR,gGACF,EAeJ,GAXuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,IAAKF,EAAK,IACV,QAASA,EAAK,QACd,GAAI,CACF,IAAKM,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAIF,EAAK,cAAgB,UAAW,CAClC,GAAI,CAACA,EAAK,iBAAmB,CAACA,EAAK,aACjC,MAAM,IAAI,MAAM,yCAAyC,EAc3D,GAXuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,GAAI,CACF,IAAKM,CACP,EACA,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAIF,EAAK,cAAgB,WAAY,CACnC,GAAI,CAACA,EAAK,aACR,MAAM,IAAI,MAAM,2BAA2B,EAW7C,GARuB,MAAM,KAAK,cAAc,UAAU,CACxD,MAAO,CACL,aAAcA,EAAK,aACnB,GAAI,CAAE,IAAKM,CAAM,EACjB,WAAYJ,CACd,CACF,CAAC,EAGC,MAAM,IAAI,MAAM,wBAAwB,CAE5C,CAEA,GAAI,CAyBF,OAxBY,MAAM,KAAK,cAAc,OAAO,CAC1C,MAAO,CACL,GAAII,CACN,EACA,KAAM,CACJ,QAASN,GAAM,QACf,YAAaA,EAAK,YAClB,IAAKA,EAAK,IACV,QAASA,EAAK,QACd,OAAQA,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,YAAaA,EAAK,YAClB,gBAAiBA,EAAK,gBACtB,aAAcA,EAAK,aACnB,WAAYA,EAAK,UACnB,CACF,CAAC,CAGH,OAASI,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,wBAAwB,CAC1C,CACF,CAEA,MAAa,UAAUL,EAAuBO,EAAe,CAC3D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIL,EAAoB,qBAAqB,EAEjF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAU,MAAM,KAAK,cAAc,UAAU,CACjD,MAAO,CACL,GAAIF,CACN,CACF,CAAC,EAED,GAAI,CAACE,EACH,MAAM,IAAI,MAAM,mBAAmB,EAGrC,GAAIA,EAAQ,aAAeN,EACzB,MAAM,IAAI,MAAM,mBAAmB,EAErC,GAAI,CACF,aAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,MAAOI,CACT,CACF,CAAC,EAED,MAAM,KAAK,cAAc,OAAO,CAC9B,MAAO,CACL,GAAIA,CACN,CACF,CAAC,EAEM,CAAE,QAAS,CAAE,GAAIA,CAAM,CAAE,CAClC,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,wBAAwB,CAC1C,CACF,CAGA,MAAa,SAASL,EAAuBC,EAAW,CACtD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BU,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYP,CACd,CACF,CAAC,EAED,GAAIO,EAAU,CACZ,IAAMC,EAAiB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAID,EAAS,EACf,EACA,KAAM,CACJ,OAAQT,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,kBAAmBA,EAAK,kBACxB,WAAYA,EAAK,UACnB,CACF,CAAC,EAED,MAAO,CACL,OAAQU,EAAe,OACvB,cAAeA,EAAe,cAC9B,aAAcA,EAAe,aAC7B,eAAgBA,EAAe,eAC/B,gBAAiBA,EAAe,gBAChC,cAAeA,EAAe,cAC9B,SAAUA,EAAe,SACzB,aAAcA,EAAe,aAC7B,kBAAmBA,EAAe,kBAClC,WAAYA,EAAe,UAC7B,CACF,CAEA,IAAMC,EAAe,MAAM,KAAK,mBAAmB,OAAO,CACxD,KAAM,CACJ,OAAQX,EAAK,OACb,cAAeA,EAAK,cACpB,aAAcA,EAAK,aACnB,eAAgBA,EAAK,eACrB,gBAAiBA,EAAK,gBACtB,cAAeA,EAAK,cACpB,SAAUA,EAAK,SACf,aAAcA,EAAK,aACnB,kBAAmBA,EAAK,kBACxB,WAAYA,EAAK,WACjB,WAAYE,CACd,CACF,CAAC,EAED,MAAO,CACL,OAAQS,EAAa,OACrB,cAAeA,EAAa,cAC5B,aAAcA,EAAa,aAC3B,eAAgBA,EAAa,eAC7B,gBAAiBA,EAAa,gBAC9B,cAAeA,EAAa,cAC5B,SAAUA,EAAa,SACvB,aAAcA,EAAa,aAC3B,kBAAmBA,EAAa,kBAChC,WAAYA,EAAa,UAC3B,CACF,OAASP,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,cAAcL,EAAuB,CAChD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIE,EAAoB,qBAAqB,EAEjF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BU,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYP,CACd,EACA,QAAS,CACP,SAAU,EACZ,CACF,CAAC,EAED,OAAKO,EAeE,CACL,OAAQA,EAAS,OACjB,cAAeA,EAAS,cACxB,aAAcA,EAAS,aACvB,eAAgBA,EAAS,eACzB,gBAAiBA,EAAS,gBAC1B,cAAeA,EAAS,cACxB,SAAUA,EAAS,SACnB,WAAYA,EAAS,WACrB,kBAAmBA,EAAS,kBAC5B,SAAUA,EAAS,QACrB,EAzBS,CACL,OAAQ,EACR,cAAe,GACf,aAAc,EACd,eAAgB,GAChB,gBAAiB,GACjB,cAAe,GACf,SAAU,GACV,WAAY,CAAC,EACb,kBAAmB,KACnB,SAAU,IACZ,CAeJ,OAASL,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,iCAAiC,CACnD,CACF,CAGA,MAAa,SAASL,EAAuBC,EAAW,CACtD,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,GAAID,EAAK,YAAc,mBAAoB,OAE3C,IAAMY,EAAe,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAClE,MAAO,CACL,KAAMb,EAAS,YACjB,CACF,CAAC,EAED,GAAI,CAACa,EAAc,MAAM,IAAI,MAAM,oBAAoB,EAEvD,IAAMC,EAAYb,EAAK,UACjBc,EAAMd,EAAK,IACXQ,EAAUR,EAAK,QACfe,EAAef,EAAK,aACpBgB,EAAYhB,EAAK,UACnBiB,EAASjB,GAAM,SAAS,OACxBkB,EAAgBlB,GAAM,SAAS,cAC/BmB,EAAenB,GAAM,SAAS,aAC9BoB,EAAiBpB,GAAM,SAAS,eAChCqB,EAAkBrB,GAAM,SAAS,gBACjCsB,EAAgBtB,GAAM,SAAS,cAC/BuB,EAAWvB,GAAM,SAAS,SAC1BwB,EAAexB,GAAM,SAAS,aAC9ByB,EAAazB,GAAM,SAAS,WAE1BG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAYS,EAAa,EAC3B,CACF,CAAC,EAED,GAAI,KAAK,gBAAgBT,GAAqB,WAAYU,CAAS,EAAG,MAAM,IAAI,MAAM,iBAAiB,GAGrG,CAACI,GACD,CAACC,GACD,CAACC,GACD,CAACC,GACD,CAACC,GACD,CAACC,GACD,CAACC,GACD,CAACC,GACD,CAACC,KAE2BR,GAAW,OAAMA,EAASd,EAAoB,QACvCe,GAAkB,OAAMA,EAAgBf,EAAoB,eAC7DgB,GAAiB,OAAMA,EAAehB,EAAoB,cACxDiB,GAAmB,OAAMA,EAAiBjB,EAAoB,gBAC7DkB,GAAoB,OACvDA,EAAkBlB,EAAoB,iBACLmB,GAAkB,OAAMA,EAAgBnB,EAAoB,eACjEoB,GAAa,OAAMA,EAAWpB,EAAoB,UAC9CqB,GAAiB,OAAMA,EAAerB,EAAoB,cAC5DsB,GAAe,OAAMA,EAAatB,EAAoB,YAEjFA,GACH,MAAM,KAAK,SAASJ,EAAU,CAC5B,OAAQkB,EACR,cAAeC,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,EACV,aAAcC,EACd,WAAYC,CACd,CAAC,GAIL,IAAMC,EAA0B,CAAC,EAQjC,GANIV,GAAW,QACbA,EAAU,QAASW,GAAuD,CACxED,EAAmBC,EAAS,IAAI,EAAIA,EAAS,KAC/C,CAAC,EAGCZ,EAAc,CAChB,IAAIa,EAAe,MAAM,KAAK,cAAc,UAAU,CACpD,MAAO,CACL,IAAKd,EACL,QAASN,EACT,WAAYI,EAAa,EAC3B,CACF,CAAC,EAEIgB,IACHA,EAAU,MAAM,KAAK,cAAc,OAAO,CACxC,KAAM,CACJ,QAAS,GACT,IAAKd,EACL,QAASN,EACT,WAAYI,EAAa,GACzB,OAAQK,EACR,cAAeC,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,CACF,CAAC,GAGH,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CACxD,MAAO,CACL,UAAWV,EACX,WAAYD,EAAa,GACzB,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAED,MAAM,KAAK,eAAe,eACxBA,EACAC,EACA,KACA,KACAe,EACAd,EACAG,EACAT,EACAU,EACAC,EACAC,EACAC,EACAC,EACAC,EACA,OACAG,CACF,CACF,KAAO,CACL,IAAMG,EAAK,KAAK,MAAM,KAAK,OAAO,EAAI,IAAW,EAAE,SAAS,EAE5D,GAAI,CACF,IAAMC,EAAUhC,EAAc,IAAa,SAAS,EAAE,YAClDgB,EACAiB,EACAD,IAAY,UACdhB,EAAM,GAAGd,EAAK,GAAG,oBAAoBA,EAAK,OAAO,aAEjD+B,EAAU,CACR,mBAAoBL,CACtB,IAEAZ,EAAM,GAAGd,EAAK,GAAG,sBAEjB+B,EAAU,CACR,YAAa,CACX,SAAU/B,EAAK,QACf,mBAAoB0B,CACtB,CACF,GAEF,IAAMM,EAAU,MAAMC,GAAM,KAAKnB,EAAKiB,CAAO,EAE7C,MAAM,KAAK,eAAe,cACxBnB,EACA,KACA,CACE,OAAQK,EACR,cAAeC,EACf,aAAcC,EACd,eAAgBC,EAChB,gBAAiBC,EACjB,cAAeC,EACf,SAAUC,CACZ,EACAV,EACAmB,EAAQ,KAAK,SACbA,EAAQ,KAAK,MACbA,EAAQ,KAAK,iBACf,EAEA,KAAK,UAAU,YAAYjC,EAAS,YAAY,EAAE,gCAAsC,CACtF,UAAWc,EACX,IAAKC,EACL,QAASN,EACT,UAAWQ,EACX,UAAWa,CACb,CAAC,CACH,OAASzB,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CAEA,MAAO,CACL,QAAS,CACP,GAAGL,EACH,QAAS,CACP,IAAKe,EACL,UAAWD,EACX,QAASL,EACT,mBAAoBkB,CACtB,CACF,CACF,CACF,CAEA,MAAa,aAAa3B,EAAuBC,EAAW,CAC1D,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3Bc,EAAYb,EAAK,UACjBkC,EAASlC,EAAK,OAEdG,EAAsB,MAAM,KAAK,mBAAmB,UAAU,CAClE,MAAO,CACL,WAAAD,CACF,CACF,CAAC,EAED,GAAIgC,IAAW,SACb,aAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWrB,EACX,WAAYX,EACZ,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAEM,CAAE,QAAS,CAAE,GAAGH,EAAU,QAAS,CAAE,UAAWc,EAAW,OAAQqB,CAAO,CAAE,CAAE,EAGvF,GAAIA,IAAW,SACb,OAAI/B,GAAqB,SACvB,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,WAAYD,EACZ,UAAWW,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQqB,CACV,CACF,CAAC,EAED,MAAM,KAAK,kBAAkB,WAAW,CACtC,MAAO,CACL,UAAWrB,EACX,WAAYX,EACZ,MAAO,CAAE,IAAK,IAAK,CACrB,CACF,CAAC,EAGI,CAAE,QAAS,CAAE,GAAGH,EAAU,QAAS,CAAE,UAAWc,EAAW,OAAQqB,CAAO,CAAE,CAAE,EAGvF,IAAMC,EAAU,MAAM,KAAK,kBAAkB,WAAW,CACtD,MAAO,CACL,WAAYjC,EACZ,UAAWW,EACX,MAAO,CAAE,IAAK,IAAK,CACrB,EACA,KAAM,CACJ,OAAQqB,CACV,CACF,CAAC,EAEKE,EAAc,CAClB,UAAWvB,EACX,OAAQqB,EACR,QAAAC,CACF,EAEA,YAAK,UAAU,YAAYpC,EAAS,YAAY,EAAE,wCAA8CqC,CAAW,EAEpG,CAAE,QAAS,CAAE,GAAGrC,EAAU,QAASqC,CAAY,CAAE,CAC1D,OAAShC,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,uBAAuB,CACzC,CACF,CAEA,MAAa,cAAcL,EAAuBO,EAAeO,EAAoB,CACnF,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIZ,EAAoB,qBAAqB,EAEjF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BS,EAAU,MAAM,KAAK,cAAc,UAAU,CACjD,MAAO,CACL,GAAIF,CACN,CACF,CAAC,EAED,GAAIE,GAAWA,EAAQ,aAAeN,EACpC,MAAM,IAAI,MAAM,mBAAmB,EAGrC,OAAO,MAAM,KAAK,kBAAkB,SAAS,CAC3C,MAAO,CACL,WAAYA,EACZ,UAAAW,EACA,MAAOP,GAAS,CAAE,IAAK,IAAK,EAC5B,KAAM,SACR,CACF,CAAC,CACH,OAASF,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,yBAAyB,CAC3C,CACF,CAEA,MAAa,UAAUL,EAAuBC,EAAoB,CAChE,GAAI,CAAC,KAAK,mBAAoB,MAAM,IAAIC,EAAoB,qBAAqB,EAEjF,GAAI,CACF,IAAMC,EAAa,MAAM,KAAK,iBAAiB,SAC5C,UAAU,CACT,MAAO,CACL,KAAMH,EAAS,YACjB,CACF,CAAC,EACA,KAAMA,GAAaA,EAAS,EAAE,EAE3BU,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAYP,CACd,CACF,CAAC,EAED,GAAI,CAACO,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,IAAIgB,EAAkBhB,GAAU,YAAc,CAAC,EAE/C,GAAIT,EAAK,SAAW,MAAO,CACzB,GAAIyB,EAAW,SAASzB,EAAK,SAAS,EAAG,MAAO,CAAE,WAAYyB,CAAW,EAEzEA,EAAW,KAAKzB,EAAK,SAAS,CAChC,MACEyB,EAAaA,EAAW,OAAQY,GAAQA,IAAQrC,EAAK,SAAS,EAYhE,MAAO,CACL,YAVqB,MAAM,KAAK,mBAAmB,OAAO,CAC1D,MAAO,CACL,GAAIS,EAAS,EACf,EACA,KAAM,CACJ,WAAYgB,CACd,CACF,CAAC,GAG4B,UAC7B,CACF,OAASrB,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,gCAAgC,CAClD,CACF,CAEA,MAAa,KAAK,CAChB,SAAAL,EACA,UAAAc,EACA,IAAAyB,CACF,EAKG,CACD,GAAK,KAAK,mBAEV,GAAI,CACF,IAAM1B,EAAe,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAClE,MAAO,CACL,KAAMb,EAAS,YACjB,CACF,CAAC,EAED,GAAI,CAACa,EAAc,MAAM,IAAI,MAAM,oBAAoB,EAEvD,IAAMuB,EAAU,MAAM,KAAK,WAAWtB,EAAWd,CAAQ,EAEnDwC,EAAUC,GAAuBF,CAAG,EAEtCV,EAAW,MAAM,KAAK,eAAe,KAAK,cAAeW,EAASxC,EAAUoC,CAAO,EAEvF,GAAI,CAACP,EAAS,CACZ,IAAMa,EAAW,MAAM,KAAK,mBAAmB,UAAU,CACvD,MAAO,CACL,WAAY1C,EAAS,UACvB,CACF,CAAC,EAED,GAAI0C,GAAU,kBAOZb,EANqB,MAAM,KAAK,cAAc,UAAU,CACtD,MAAO,CACL,GAAIa,EAAS,iBACf,CACF,CAAC,MAID,OAEJ,CAEA,IAAMhC,EAAW,MAAM,KAAK,iBAAiB,eAAe,UAAU,CACpE,MAAO,CACL,WAAYV,EAAS,UACvB,CACF,CAAC,EAEKe,EAAMc,GAAS,IACfpB,EAAUoB,GAAS,QACrBX,EAASW,GAAS,OAClBV,EAAgBU,GAAS,cACzBT,EAAeS,GAAS,aACxBR,EAAiBQ,GAAS,eAC1BP,EAAkBO,GAAS,gBAC3BN,EAAgBM,GAAS,cACzBL,EAAWK,GAAS,SACpBJ,EAAeI,GAAS,aACxBH,EAAaG,GAAS,WAY1B,GAV4BX,GAAW,OAAMA,EAASR,EAAS,QAC5BS,GAAkB,OAAMA,EAAgBT,EAAS,eAClDU,GAAiB,OAAMA,EAAeV,EAAS,cAC7CW,GAAmB,OAAMA,EAAiBX,EAAS,gBAClDY,GAAoB,OAAMA,EAAkBZ,EAAS,iBACvDa,GAAkB,OAAMA,EAAgBb,EAAS,eACtDc,GAAa,OAAMA,EAAWd,EAAS,UACnCe,GAAiB,OAAMA,EAAef,EAAS,cACjDgB,GAAe,OAAMA,EAAahB,EAAS,YAEvE,KAAK,gBAAgBgB,EAAYZ,CAAS,EAAG,OAEjD,IAAM6B,EAAMJ,EAAI,IAOhB,GAAIhB,GAAiBoB,EAAI,QAAUP,EAAS,CAC1C,MAAM,KAAK,kBAAkB,OAAO,CAClC,MAAO,CACL,GAAIA,EAAQ,EACd,EACA,KAAM,CACJ,OAAQ,QACV,CACF,CAAC,EACD,MACF,CAkDA,GAhDI,CAACd,GAAmBqB,EAAI,QAIxBP,GAAW,CAACA,EAAQ,YAIpBX,GAAgBA,EAAe,EACjC,KAAK,gBAAgB,KAAK,oBAAqBe,EAAS1B,EAAWW,EAAc,MAAOmB,GAAqB,CAC3G,MAAM,KAAK,eAAe,eACxB/B,EACAC,EACAyB,EACAH,EACAP,EACAd,EACAG,EACAT,EACAU,EACAC,EACAC,EACAC,EACAC,EACAC,EACAoB,CACF,CACF,CAAC,EAED,MAAM,KAAK,eAAe,eACxB/B,EACAC,EACAyB,EACAH,EACAP,EACAd,EACAG,EACAT,EACAU,EACAC,EACAC,EACAC,EACAC,EACAC,EACAgB,CACF,EAGEJ,GAAW,CAACA,EAAQ,WAAW,MACrC,OAAS/B,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,EACvB,MACF,CACF,CACF,ECxiCA,OAAOwC,OAAY,SCkBZ,IAAMC,GAAN,MAAMA,EAAgB,CAM3B,YACEC,EACAC,EACAC,EACAC,EACA,CACA,KAAK,OAASH,EACd,KAAK,QAAUC,EACf,KAAK,OAASC,EACd,KAAK,KAAOC,CACd,CAEA,IAAW,OAAOC,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEA,IAAW,QAAQH,EAAgC,CACjD,KAAK,UAAYA,CACnB,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,SACd,CAEA,IAAW,KAAKI,EAAc,CAC5B,KAAK,gBAAkBA,CACzB,CAEA,IAAW,MAAO,CAChB,OAAO,KAAK,eACd,CAEA,IAAW,OAAOC,EAAiB,CACjC,KAAK,kBAAoBA,CAC3B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,iBACd,CAEA,MAAa,IAAIC,EAAsBC,EAAwC,CAC7E,GAAK,KAAK,OAIV,OAAKA,EAAK,KAAK,IAAI,GAAG,QAGVA,EAAK,KAAK,IAAI,EAAE,OAAO,SAA7B,IACFA,EAAK,KAAK,IAAI,EAAE,OAAST,GAAgB,QAH3CS,EAAK,KAAK,IAAI,EAAE,OAAS,CAAC,EAOrB,KAAK,OAAO,KAAK,IAAI,EAAE,OAAO,CACnC,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,EACA,OAAQ,CACN,QAASC,EAAK,KAAK,IAAI,GAAG,QAC1B,OAAQA,EAAK,KAAK,IAAI,EAAE,MAC1B,EACA,OAAQ,CACN,QAASA,EAAK,KAAK,IAAI,GAAG,QAC1B,OAAQA,EAAK,KAAK,IAAI,EAAE,OACxB,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,CACF,CAAC,CACH,CAEA,MAAa,IAAIA,EAA8C,CAC7D,GAAI,CAAC,KAAK,OACR,OAGF,GAAkB,KAAK,QAAQ,YAAYA,CAAY,IAAnD,OACF,OAAO,KAGT,IAAMC,EAAO,MAAM,KAAK,OAAO,KAAK,IAAI,EAAE,WAAW,CACnD,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,CACF,CAAC,EAED,OAAKC,GACI,IAIX,CA+BF,EAlIaT,GAqGY,OAAS,CAC9B,sBACA,iBACA,eACA,kBACA,kBACA,kBACA,kBACA,eACA,eACA,kBACA,kBACA,kBACA,YACA,eACA,eACA,eACA,gBACA,eACA,4BACA,oBACA,cACA,qBACA,OACA,gBACA,wBACA,kBACA,iBACF,EAjIK,IAAMU,EAANV,GDfA,IAAMW,GAAN,cAA+BC,CAAoD,CAKxF,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,EAAWC,EAAc,IAAkB,QAAQ,GAAG,QAAS,QAAQ,EALjG,KAAiB,OAAS,IAAIC,EAAO,kBAAkB,EACvD,KAAQ,cAAoD,CAAC,EAC7D,KAAQ,mBAAoC,KAC5C,KAAQ,aAA6BD,EAAc,IAAkB,QAAQ,EAG3E,KAAK,KAAK,CACZ,CACA,MAAa,MAAsB,CACjC,GAAI,CAAC,KAAK,OACR,OAEF,GAAI,KAAK,aAAa,QAAQ,QAAS,CACrC,GAAM,CAAE,OAAAE,EAAQ,IAAAC,EAAK,OAAAC,EAAQ,QAAAC,EAAS,QAAAC,CAAQ,EAAI,KAAK,aAAa,OAChEJ,GAAUC,GAAOC,GAAUC,IAC7B,KAAK,mBAAqB,IAAIE,GAAO,CACnC,MAAOL,EACP,IAAKC,EACL,OAAQC,EACR,QAASC,EACT,OAAQC,CACV,CAAC,EACD,KAAK,OAAO,KAAK,kCAAkC,EAEvD,EACkB,MAAM,KAAK,iBAAiB,SAAS,SAAS,CAC9D,MAAO,CACL,OAAQ,CACN,MAAO,IACT,CACF,EACA,QAAS,CACP,OAAQ,EACV,CACF,CAAC,GACS,QAASE,GAAa,CAE5BA,EAAS,OAAO,SAChBA,EAAS,OAAO,OAChBA,EAAS,OAAO,KAChBA,EAAS,OAAO,QAChBA,EAAS,OAAO,SAEhB,KAAK,cAAcA,EAAS,IAAI,EAAI,IAAID,GAAO,CAC7C,MAAOC,EAAS,OAAO,MACvB,IAAKA,EAAS,OAAO,IACrB,OAAQA,EAAS,OAAO,OACxB,QAASA,EAAS,OAAO,QACzB,OAAQA,EAAS,OAAO,MAC1B,CAAC,EACD,KAAK,OAAO,KAAK,0CAA0CA,EAAS,IAAI,EAAE,IAE1E,OAAO,KAAK,cAAcA,EAAS,IAAI,EACvC,KAAK,OAAO,KAAK,wDAAwDA,EAAS,IAAI,EAAE,EAE5F,CAAC,CACH,CACA,MAAe,IAAIC,EAAsBC,EAAyC,CAC3EA,EAAK,QAAQ,QAEPA,EAAK,OAAO,OAAO,SAAW,IACvCA,EAAK,OAAO,OAASb,EAAgB,QAFrCa,EAAK,OAAO,OAAS,CAAC,EAIxB,IAAMF,EAAW,MAAM,KAAK,OAAO,OAAO,OAAO,CAC/C,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYC,CAAY,EAAE,UACrD,EACA,OAAQ,CACN,QAASC,EAAK,OAAO,QACrB,OAAQA,EAAK,OAAO,OACpB,MAAOA,EAAK,OAAO,MACnB,IAAKA,EAAK,OAAO,IACjB,OAAQA,EAAK,OAAO,OACpB,QAASA,EAAK,OAAO,QACrB,OAAQA,EAAK,OAAO,MACtB,EACA,OAAQ,CACN,QAASA,EAAK,OAAO,QACrB,OAAQA,EAAK,OAAO,OACpB,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,WACnD,MAAOC,EAAK,OAAO,MACnB,IAAKA,EAAK,OAAO,IACjB,OAAQA,EAAK,OAAO,OACpB,QAASA,EAAK,OAAO,QACrB,OAAQA,EAAK,OAAO,MACtB,CACF,CAAC,EACD,OAAIF,EAAS,SAAWA,EAAS,OAASA,EAAS,KAAOA,EAAS,QAAUA,EAAS,SACpF,KAAK,cAAcC,CAAY,EAAI,IAAIF,GAAO,CAC5C,MAAOC,EAAS,MAChB,IAAKA,EAAS,IACd,OAAQA,EAAS,OACjB,QAASA,EAAS,QAClB,OAAQA,EAAS,MACnB,CAAC,EACD,KAAK,OAAO,KAAK,0CAA0CC,CAAY,EAAE,IAEzE,OAAO,KAAK,cAAcA,CAAY,EACtC,KAAK,OAAO,KAAK,wDAAwDA,CAAY,EAAE,GAElFD,CACT,CACA,MAAa,KAAK,CAChB,aAAAC,EACA,OAAAE,EACA,MAAAC,EACA,KAAAF,EACA,UAAAG,EACA,SAAAC,EACA,OAAAC,EACA,OAAAC,EACA,MAAAC,EACA,YAAAC,CACF,EAA4B,CAI1B,GAHIA,GAAe,CAACA,EAAY,SAAS,QAAQ,GAG7C,CAAC,KAAK,OACR,OAEF,IAAMV,EAAY,MAAM,KAAK,IAAIC,CAAY,EACvCU,EAAKP,EAAM,QAAQ,SAAU,GAAG,EAAE,YAAY,EAC9CQ,EAAapB,EAAc,IAAS,KAAK,EAAE,MAAM,SAAS,UAAU,EACpEqB,EAAYT,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,EACjDU,EAAa,CACjB,MAAAV,EACA,SAAUH,EACV,KAAAC,EACA,YAAaF,GAAU,OAAS,KAAK,aAAa,QAAQ,OAC1D,UAAWM,EACX,OAAAC,EACA,WAAYF,EACZ,OAAQG,CACV,EACIJ,GAAS,kBACX,OAAOU,EAAW,KAAK,OAAO,OAEhC,IAAMC,EAAU,KAAK,UAAUD,CAAU,EACnCE,EAAc,OAAO,WAAWD,EAAS,MAAM,EAErD,GAAIC,EADa,MACW,CAC1B,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGb,CAAM,mBAChB,QAAS,oCACT,MAAAC,EACA,aAAAH,EACA,YAAAe,CACF,CAAC,EACD,MACF,CACA,GAAIP,GAAST,GAAYA,EAAS,QAAS,CACzC,IAAMiB,EAAoBjB,EAAS,OACnC,GAAI,MAAM,QAAQiB,CAAiB,GAAKA,EAAkB,SAASN,CAAE,EAAG,CAClEC,GACF,KAAK,OAAO,IAAI,CACd,MAAO,GAAGT,CAAM,mBAChB,MAAOH,EAAS,MAChB,GAAGc,CACL,CAAC,EAEH,GAAI,CACF,IAAMI,EAAS,KAAK,cAAcjB,CAAY,EAC1CiB,EACFA,EAAO,QAAQjB,EAAcY,EAAWC,CAAU,EAElD,KAAK,OAAO,MAAM,wCAAwCb,CAAY,EAAE,CAE5E,OAASkB,EAAO,CACd,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGhB,CAAM,mBAChB,QAASgB,GAAO,QAChB,MAAAA,CACF,CAAC,CACH,CACF,CACF,CACA,GAAI,KAAK,aAAa,QAAQ,SACP,KAAK,aAAa,OACtBR,CAAE,EAAG,CAChBC,GACF,KAAK,OAAO,IAAI,CACd,MAAO,GAAGT,CAAM,0BAChB,MAAO,KAAK,aAAa,QAAQ,OACjC,GAAGW,CACL,CAAC,EAEH,GAAI,CACE,KAAK,mBACP,KAAK,mBAAmB,QAAQb,EAAcY,EAAWC,CAAU,EAEnE,KAAK,OAAO,MAAM,sCAAsC,CAE5D,OAASK,EAAO,CACd,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGhB,CAAM,0BAChB,QAASgB,GAAO,QAChB,MAAAA,CACF,CAAC,CACH,CACF,CAEJ,CACF,EEhNA,UAAYC,OAAU,uBAIf,IAAMC,GAAN,cAAiCC,CAAoD,CAI1F,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,EAAWC,EAAc,IAAc,UAAU,GAAG,QAAS,UAAU,EAJjG,KAAO,YAAmC,KAC1C,KAAiB,OAAS,IAAIC,EAAO,oBAAoB,CAIzD,CAEA,MAAa,MAAsB,CAC5B,KAAK,QAIV,MAAM,IAAI,QAAc,CAACC,EAASC,IAAW,CAC3C,IAAMC,EAAMJ,EAAc,IAAc,UAAU,EAAE,IAC9CK,EAAuBL,EAAc,IAAc,UAAU,EAAE,cAEhE,WAAQI,EAAK,CAACE,EAAOC,IAAe,CACvC,GAAID,EAAO,CACTH,EAAOG,CAAK,EAEZ,MACF,CAEAC,EAAW,cAAc,CAACC,EAAcC,IAAY,CAClD,GAAID,EAAc,CAChBL,EAAOK,CAAY,EAEnB,MACF,CAEA,IAAME,EAAeL,EAErBI,EAAQ,eAAeC,EAAc,QAAS,CAC5C,QAAS,GACT,WAAY,EACd,CAAC,EAED,KAAK,YAAcD,EAEnB,KAAK,OAAO,KAAK,kBAAkB,EAEnCP,EAAQ,CACV,CAAC,CACH,CAAC,CACH,CAAC,EAAE,KAAK,IAAM,CACRF,EAAc,IAAc,UAAU,GAAG,gBAAgB,KAAK,iBAAiB,CACrF,CAAC,CACH,CAEA,IAAY,QAAQS,EAAuB,CACzC,KAAK,YAAcA,CACrB,CAEA,IAAW,SAAwB,CACjC,OAAO,KAAK,WACd,CAEA,MAAa,KAAK,CAChB,aAAAE,EACA,OAAAC,EACA,MAAAC,EACA,KAAAC,EACA,UAAAC,EACA,SAAAC,EACA,OAAAC,EACA,OAAAC,EACA,YAAAC,CACF,EAA4B,CAK1B,GAJIA,GAAe,CAACA,EAAY,SAAS,UAAU,GAI/C,CAAC,KAAK,OACR,OAGF,IAAMC,EAAmB,MAAM,KAAK,IAAIT,CAAY,EAC9CU,EAAgBD,GAAkB,OAClCE,EAAiBtB,EAAc,IAAc,UAAU,EAAE,eACzDuB,EAAiBvB,EAAc,IAAc,UAAU,EAAE,OACzDwB,EAAYxB,EAAc,IAAc,UAAU,EAAE,WACpDK,EAAuBL,EAAc,IAAc,UAAU,EAAE,cAC/DyB,EAAKZ,EAAM,QAAQ,SAAU,GAAG,EAAE,YAAY,EAC9Ca,EAAa1B,EAAc,IAAS,KAAK,EAAE,MAAM,SAAS,UAAU,EAEpE2B,EAAU,CACd,MAAAd,EACA,SAAUF,EACV,KAAAG,EACA,WAAYC,EACZ,UAAWC,EACX,OAAAC,EACA,OAAQC,CACV,EAEA,GAAIE,GAAkB,SAAW,KAAK,aAChC,MAAM,QAAQC,CAAa,GAAKA,EAAc,SAASI,CAAE,EAAG,CAC9D,IAAMf,EAAeC,GAAgBN,EAEjCuB,EAAQ,EAEZ,KAAOA,EAAQ,GACb,GAAI,CACF,MAAM,KAAK,YAAY,eAAelB,EAAc,QAAS,CAC3D,QAAS,GACT,WAAY,EACd,CAAC,EAED,IAAMmB,EAAYhB,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,EAEjDiB,EAAY,GAAGnB,CAAY,IAAIkB,CAAS,GAc9C,GAZA,MAAM,KAAK,YAAY,YAAYC,EAAW,CAC5C,QAAS,GACT,WAAY,GACZ,UAAW,CACT,eAAgB,QAClB,CACF,CAAC,EAED,MAAM,KAAK,YAAY,UAAUA,EAAWpB,EAAcmB,CAAS,EAEnE,MAAM,KAAK,YAAY,QAAQnB,EAAcG,EAAO,OAAO,KAAK,KAAK,UAAUc,CAAO,CAAC,CAAC,EAEpFD,EAAY,CACd,IAAMK,EAAU,CACd,MAAO,GAAGnB,CAAM,qBAChB,GAAGe,CACL,EAEA,KAAK,OAAO,IAAII,CAAO,CACzB,CAEA,KACF,MAAgB,CACdH,GACF,CAEJ,CAGF,GAAIN,GAAkBC,EAAeE,CAAE,GAAK,KAAK,YAAa,CAC5D,IAAMf,EAAeL,EAEjBuB,EAAQ,EAEZ,KAAOA,EAAQ,GACb,GAAI,CACF,MAAM,KAAK,YAAY,eAAelB,EAAc,QAAS,CAC3D,QAAS,GACT,WAAY,EACd,CAAC,EAED,IAAMoB,EAAYN,EACd,GAAGA,CAAS,IAAIX,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,CAAC,GACtDA,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,EAczC,GAZA,MAAM,KAAK,YAAY,YAAYiB,EAAW,CAC5C,QAAS,GACT,WAAY,GACZ,UAAW,CACT,eAAgB,QAClB,CACF,CAAC,EAED,MAAM,KAAK,YAAY,UAAUA,EAAWpB,EAAcG,CAAK,EAE/D,MAAM,KAAK,YAAY,QAAQH,EAAcG,EAAO,OAAO,KAAK,KAAK,UAAUc,CAAO,CAAC,CAAC,EAEpFD,EAAY,CACd,IAAMK,EAAU,CACd,MAAO,GAAGnB,CAAM,4BAChB,GAAGe,CACL,EAEA,KAAK,OAAO,IAAII,CAAO,CACzB,CAEA,KACF,MAAgB,CACdH,GACF,CAEJ,CACF,CAEA,MAAc,kBAAkC,CAC9C,KAAK,OAAO,KAAK,4BAA4B,EAE7C,IAAMvB,EAAuBL,EAAc,IAAc,UAAU,EAAE,cAC/DgC,EAAShC,EAAc,IAAc,UAAU,EAAE,OACjDwB,EAAYxB,EAAc,IAAc,UAAU,EAAE,WAE1D,GAAI,CAACgC,EAAQ,CACX,KAAK,OAAO,KAAK,iCAAiC,EAElD,MACF,CAEkB,OAAO,KAAKA,CAAM,EAE1B,QAASnB,GAAU,CAC3B,GAAImB,EAAOnB,CAAK,IAAM,GAAO,OAE7B,IAAMiB,EACJN,IAAc,GACV,GAAGA,CAAS,IAAIX,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,CAAC,GACtD,GAAGA,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,CAAC,GACzCH,EAAeL,EAErB,KAAK,YAAY,eAAeK,EAAc,QAAS,CACrD,QAAS,GACT,WAAY,EACd,CAAC,EAED,KAAK,YAAY,YAAYoB,EAAW,CACtC,QAAS,GACT,WAAY,GACZ,UAAW,CACT,eAAgB,QAClB,CACF,CAAC,EAED,KAAK,YAAY,UAAUA,EAAWpB,EAAcG,CAAK,CAC3D,CAAC,CACH,CACF,ECzOA,OAAS,OAAAoB,OAAW,sBAMb,IAAMC,GAAN,cAA4BC,CAAoD,CAIrF,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,EAAWC,EAAc,IAAS,KAAK,GAAG,QAAS,KAAK,EAHlF,KAAiB,OAAS,IAAIC,EAAO,eAAe,CAIpD,CAEO,MAAa,CACb,KAAK,QAIV,IAAI,QAAeC,GAAY,CAC7B,IAAMC,EAAYH,EAAc,IAAS,KAAK,EAE9C,KAAK,IAAM,IAAII,GAAI,CACjB,YAAa,CACX,YAAaD,EAAU,cACvB,gBAAiBA,EAAU,iBAC7B,EAEA,OAAQA,EAAU,MACpB,CAAC,EAED,KAAK,OAAO,KAAK,iBAAiB,EAElCD,EAAQ,CACV,CAAC,CACH,CAEA,IAAY,QAAQG,EAAU,CAC5B,KAAK,IAAMA,CACb,CAEA,IAAW,SAAe,CACxB,OAAO,KAAK,GACd,CAEA,MAAa,KAAK,CAChB,aAAAC,EACA,OAAAC,EACA,MAAAC,EACA,KAAAC,EACA,UAAAC,EACA,SAAAC,EACA,OAAAC,EACA,OAAAC,EACA,YAAAC,CACF,EAA4B,CAK1B,GAJIA,GAAe,CAACA,EAAY,SAAS,KAAK,GAI1C,CAAC,KAAK,OACR,OAGF,IAAMC,EAAc,MAAM,KAAK,IAAIT,CAAY,EACzCU,EAAWD,GAAa,OACxBE,EAAKT,EAAM,QAAQ,SAAU,GAAG,EAAE,YAAY,EAEpD,GAAIO,GAAa,SACX,KAAK,KACH,MAAM,QAAQC,CAAQ,GAAKA,EAAS,SAASC,CAAE,EAAG,CACpD,IAAMC,EAAiB,GAAGV,EAAM,QAAQ,IAAK,GAAG,EAAE,YAAY,CAAC,GACzDW,EAAY,GAAGb,CAAY,IAAIY,CAAc,QAC7CE,EAAYpB,EAAc,IAAS,KAAK,EACxCqB,EAAS,eAAeD,EAAU,MAAM,kBAAkBA,EAAU,UAAU,IAAID,CAAS,GAE3FG,EAAU,CACd,MAAAd,EACA,SAAUF,EACV,KAAAG,EACA,WAAYC,EACZ,UAAWC,EACX,OAAAC,EACA,OAAQC,CACV,EAEMU,EAAS,CACb,YAAa,KAAK,UAAUD,CAAO,EACnC,eAAgB,YAChB,uBAAwB,GAAGhB,CAAY,IAAIY,CAAc,IAAI,KAAK,IAAI,CAAC,GACvE,SAAUG,CACZ,EAEA,KAAK,IAAI,YAAYE,EAASC,GAAQ,CACpC,GAAIA,EACF,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGjB,CAAM,gBAChB,QAASiB,GAAK,QACd,SAAUA,GAAK,SACf,KAAMA,GAAK,KACX,MAAOA,GAAK,MACZ,KAAMA,GAAK,KACX,IAAKL,EACL,WAAYT,CACd,CAAC,UAEGV,EAAc,IAAS,KAAK,EAAE,MAAM,SAAS,UAAU,EAAG,CAC5D,IAAMyB,EAAU,CACd,MAAO,GAAGlB,CAAM,gBAChB,GAAGe,CACL,EAEA,KAAK,OAAO,IAAIG,CAAO,CACzB,CAEJ,CAAC,CACH,CAGN,CAEA,MAAa,WAAWnB,EAAsBoB,EAAkB,CAC9D,GAAI,CAACA,GAAU,CAACA,EAAO,OAAQ,OAEhBA,EAAO,IAAKlB,GAClB,GAAGA,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,CAAC,EACjD,EAEM,QAASA,GAAU,CACxB,IAAMW,EAAY,GAAGb,CAAY,IAAIE,CAAK,QAE1C,KAAK,IAAI,YACP,CACE,UAAWW,EACX,WAAY,CACV,UAAW,MACb,CACF,EACA,CAACK,EAAKf,IAAS,CACTe,EACF,KAAK,OAAO,MAAM,wBAAwBL,CAAS,KAAKK,EAAI,OAAO,EAAE,EAErE,KAAK,OAAO,KAAK,SAASL,CAAS,aAAaV,EAAK,QAAQ,EAAE,CAEnE,CACF,CACF,CAAC,CACH,CAEA,MAAa,aAAaH,EAAsBoB,EAAa,CAC3D,IAAMC,EAAc,MAAM,QAAQD,CAAM,EAAIA,EAAO,IAAKlB,GAAU,OAAOA,CAAK,CAAC,EAAI,CAAC,EACpF,GAAI,CAACkB,GAAU,CAACC,EAAY,OAAQ,OAErBA,EAAY,IAAKnB,GACvB,GAAGA,EAAM,QAAQ,KAAM,GAAG,EAAE,YAAY,CAAC,EACjD,EAEM,QAASA,GAAU,CACxB,IAAMW,EAAY,GAAGb,CAAY,IAAIE,CAAK,QAE1C,KAAK,IAAI,YACP,CACE,UAAWW,CACb,EACA,CAACK,EAAKf,IAAS,CACb,GAAIe,EACF,KAAK,OAAO,MAAM,+BAA+BL,CAAS,KAAKK,EAAI,OAAO,EAAE,MACvE,CACL,IAAMI,EAAWnB,EAAK,SAEtB,KAAK,IAAI,YACP,CACE,SAAUmB,CACZ,EACCC,GAAc,CACTA,EACF,KAAK,OAAO,MAAM,wBAAwBV,CAAS,KAAKU,EAAU,OAAO,EAAE,EAE3E,KAAK,OAAO,KAAK,SAASV,CAAS,UAAU,CAEjD,CACF,CACF,CACF,CACF,CACF,CAAC,CACH,CACF,ECtLA,OAAOW,OAA8B,QACrC,OAAS,SAAAC,OAAa,kBAIf,IAAMC,GAAN,cAAgCC,CAAoD,CAGzF,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,EAAW,GAAM,SAAS,EAHpD,KAAiB,OAAS,IAAIC,EAAO,mBAAmB,CAIxD,CAEA,MAAe,IAAIC,EAAsBC,EAA0C,CACjF,GAAI,CAACC,GAAMD,EAAK,QAAQ,IAAK,CAAE,YAAa,EAAM,CAAC,EACjD,MAAM,IAAIE,EAAoB,wBAAwB,EAGxD,OAAKF,EAAK,SAAS,QAGPA,EAAK,QAAQ,OAAO,SAA1B,IACFA,EAAK,QAAQ,OAASL,EAAgB,QAHxCK,EAAK,QAAQ,OAAS,CAAC,EAOlB,KAAK,OAAO,QAAQ,OAAO,CAChC,MAAO,CACL,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,UACrD,EACA,OAAQ,CACN,QAASC,EAAK,SAAS,QACvB,OAAQA,EAAK,SAAS,OACtB,IAAKA,EAAK,SAAS,IACnB,QAASA,EAAK,SAAS,QACvB,cAAeA,EAAK,QAAQ,OAC5B,gBAAiBA,EAAK,QAAQ,QAChC,EACA,OAAQ,CACN,QAASA,EAAK,SAAS,QACvB,OAAQA,EAAK,SAAS,OACtB,WAAY,KAAK,QAAQ,YAAYD,CAAY,EAAE,WACnD,IAAKC,EAAK,SAAS,IACnB,QAASA,EAAK,SAAS,QACvB,cAAeA,EAAK,QAAQ,OAC5B,gBAAiBA,EAAK,QAAQ,QAChC,CACF,CAAC,CACH,CAEA,MAAa,KAAK,CAChB,aAAAD,EACA,OAAAI,EACA,MAAAC,EACA,KAAAJ,EACA,UAAAK,EACA,SAAAC,EACA,OAAAC,EACA,OAAAC,EACA,MAAAC,EACA,YAAAC,CACF,EAA4B,CAC1B,GAAIA,GAAe,CAACA,EAAY,SAAS,SAAS,EAChD,OAGF,IAAMC,EAAY,MAAM,KAAK,IAAIZ,CAAY,EAEvCa,EAAgBC,EAAc,IAAa,SAAS,EACpDC,EAAeH,GAAU,OACzBI,EAAiBJ,GAAU,QAC3BK,EAAKZ,EAAM,QAAQ,SAAU,GAAG,EAAE,YAAY,EAC9Ca,EAAgBD,EAAG,QAAQ,MAAO,GAAG,EAAE,YAAY,EACnDE,EAAaL,EAAc,IAAS,KAAK,EAAE,MAAM,SAAS,UAAU,EAEpEM,EAAc,CAClB,MAAAf,EACA,SAAUL,EACV,KAAAC,EACA,YAAaW,GAAU,KAAO,GAAGC,EAAc,OAAO,GAAG,IAAIK,CAAa,GAC1E,UAAWX,EACX,OAAAC,EACA,WAAYF,EACZ,OAAQG,CACV,EAEA,GAAIC,GAASE,GAAU,SACjB,MAAM,QAAQG,CAAY,GAAKA,EAAa,SAASE,CAAE,EAAG,CAC5D,IAAII,EAQJ,GANIT,GAAU,gBACZS,EAAU,GAAGT,GAAU,GAAG,IAAIM,CAAa,GAE3CG,EAAUT,GAAU,IAGlBO,EAAY,CACd,IAAMG,EAAU,CACd,MAAO,GAAGlB,CAAM,oBAChB,IAAKiB,EACL,GAAGD,CACL,EAEA,KAAK,OAAO,IAAIE,CAAO,CACzB,CAEA,GAAI,CACF,GAAIV,GAAU,SAAWV,GAAMU,EAAS,IAAK,CAAE,YAAa,EAAM,CAAC,EAAG,CACpE,IAAMW,EAAcC,GAAM,OAAO,CAC/B,QAAAH,EACA,QAASL,CACX,CAAC,EAED,MAAM,KAAK,oBAAoBO,EAAaH,EAAa,GAAGhB,CAAM,oBAAqBiB,EAASf,CAAS,CAC3G,CACF,OAASmB,EAAO,CACd,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGrB,CAAM,oBAChB,QAAS,iCAAiCqB,GAAO,OAAO,GACxD,SAAUA,GAAO,SACjB,QAASA,GAAO,QAChB,KAAMA,GAAO,KACb,MAAOA,GAAO,MACd,MAAOA,GAAO,MACd,KAAMA,GAAO,KACb,IAAKJ,EACL,WAAYf,CACd,CAAC,CACH,CACF,CAGF,GAAIO,EAAc,QAAQ,SACpBA,EAAc,OAAOI,CAAE,EAAG,CAC5B,IAAIS,EAAYb,EAAc,OAAO,IAMrC,GAJIA,EAAc,OAAO,oBACvBa,EAAY,GAAGA,CAAS,IAAIR,CAAa,IAGvCC,EAAY,CACd,IAAMG,EAAU,CACd,MAAO,GAAGlB,CAAM,2BAChB,IAAKsB,EACL,GAAGN,CACL,EAEA,KAAK,OAAO,IAAIE,CAAO,CACzB,CAEA,GAAI,CACF,GAAIpB,GAAMwB,CAAS,EAAG,CACpB,IAAMH,EAAcC,GAAM,OAAO,CAAE,QAASE,CAAU,CAAC,EAEvD,MAAM,KAAK,oBACTH,EACAH,EACA,GAAGhB,CAAM,2BACTsB,EACApB,CACF,CACF,CACF,OAASmB,EAAO,CACd,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGrB,CAAM,2BAChB,QAAS,iCAAiCqB,GAAO,OAAO,GACxD,SAAUA,GAAO,SACjB,QAASA,GAAO,QAChB,KAAMA,GAAO,KACb,MAAOA,GAAO,MACd,MAAOA,GAAO,MACd,KAAMA,GAAO,KACb,IAAKC,EACL,WAAYpB,CACd,CAAC,CACH,CACF,CAEJ,CAEA,MAAc,oBACZiB,EACAH,EACAhB,EACAiB,EACAf,EACAqB,EAAa,GACbC,EAAe,GACA,CACf,IAAIC,EAAW,EAEf,KAAOA,EAAWF,GAChB,GAAI,CACF,MAAMJ,EAAY,KAAK,GAAIH,CAAW,EAClCS,EAAW,GACb,KAAK,OAAO,IAAI,CACd,MAAO,GAAGzB,CAAM,GAChB,QAAS,4BAAyByB,EAAW,CAAC,cAC9C,IAAKR,CACP,CAAC,EAEH,MACF,OAASI,EAAO,CAgBd,GAfAI,IAEA,KAAK,OAAO,MAAM,CAChB,MAAO,GAAGzB,CAAM,GAChB,QAAS,aAAayB,CAAQ,IAAIF,CAAU,YAAYF,GAAO,OAAO,GACtE,SAAUA,GAAO,SACjB,QAASA,GAAO,QAChB,KAAMA,GAAO,KACb,MAAOA,GAAO,MACd,MAAOA,GAAO,MACd,KAAMA,GAAO,KACb,IAAKJ,EACL,WAAYf,CACd,CAAC,EAEGuB,IAAaF,EACf,MAAMF,EAGR,MAAM,IAAI,QAASK,GAAY,WAAWA,EAASF,EAAe,GAAI,CAAC,CACzE,CAEJ,CACF,ECnOA,OAAS,UAAUG,OAAgB,YAI5B,IAAMC,GAAN,cAAkCC,CAAoD,CAK3F,YAAYC,EAAoCC,EAAgC,CAC9E,MAAMD,EAAkBC,EAAWC,EAAc,IAAe,WAAW,GAAG,QAAS,WAAW,EAHpG,KAAiB,OAAS,IAAIC,EAAO,qBAAqB,EAKxD,KAAK,KAAOD,EAAc,IAAU,MAAM,EAAE,MAC9C,CAEO,KAAKE,EAA0B,CAC/B,KAAK,SAIV,KAAK,OAAS,IAAIC,GAASD,EAAY,CACrC,KAAM,CACJ,OAAQ,KAAK,IACf,CACF,CAAC,EAED,KAAK,OAAO,GAAG,aAAeE,GAAW,CACvC,KAAK,OAAO,KAAK,gBAAgB,EAEjCA,EAAO,GAAG,aAAc,IAAM,CAC5B,KAAK,OAAO,KAAK,mBAAmB,CACtC,CAAC,EAEDA,EAAO,GAAG,WAAY,MAAOC,GAAS,CACpC,GAAI,CACF,MAAM,KAAK,UAAU,YAAYA,EAAK,UAAU,EAAE,gBAAgBA,EAAK,MAAM,EAC7E,KAAK,OAAO,KAAK,wBAAwB,CAC3C,OAASC,EAAO,CACd,KAAK,OAAO,MAAM,qBAAqB,EACvC,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAAC,CACH,CAAC,EAED,KAAK,OAAO,KAAK,uBAAuB,EAC1C,CAEA,IAAY,KAAKC,EAAkB,CACjC,KAAK,WAAaA,CACpB,CAEA,IAAY,MAA4B,CACtC,OAAO,KAAK,YAAY,SAAS,GAAG,EAAI,IAAM,KAAK,UACrD,CAEA,IAAY,OAAOH,EAAkB,CACnC,KAAK,GAAKA,CACZ,CAEA,IAAW,QAAmB,CAC5B,OAAO,KAAK,EACd,CAEA,MAAa,KAAK,CAChB,aAAAI,EACA,OAAAC,EACA,MAAAC,EACA,KAAAL,EACA,UAAAM,EACA,SAAAC,EACA,OAAAC,EACA,OAAAC,EACA,YAAAC,CACF,EAA4B,CAK1B,GAJIA,GAAe,CAACA,EAAY,SAAS,WAAW,GAIhD,CAAC,KAAK,OACR,OAGF,IAAMC,EAAWN,EAAM,QAAQ,SAAU,GAAG,EAAE,YAAY,EACpDO,EAAajB,EAAc,IAAS,KAAK,EAAE,MAAM,SAAS,WAAW,EACrEkB,EAAU,CACd,MAAAR,EACA,SAAUF,EACV,KAAAH,EACA,WAAYM,EACZ,UAAWC,EACX,OAAAC,EACA,OAAQC,CACV,EAEId,EAAc,IAAe,WAAW,GAAG,gBAC7C,KAAK,OAAO,KAAKU,EAAOQ,CAAO,EAE3BD,GACF,KAAK,OAAO,IAAI,CACd,MAAO,GAAGR,CAAM,4BAChB,GAAGS,CACL,CAAC,GAIL,GAAI,CACF,IAAMC,EAAW,MAAM,KAAK,IAAIX,CAAY,EAE5C,GAAI,CAACW,GAAU,QACb,OAGE,MAAM,QAAQA,GAAU,MAAM,GAAKA,GAAU,OAAO,SAASH,CAAQ,IACvE,KAAK,OAAO,GAAG,IAAIR,CAAY,EAAE,EAAE,KAAKE,EAAOQ,CAAO,EAElDD,GACF,KAAK,OAAO,IAAI,CACd,MAAO,GAAGR,CAAM,sBAChB,GAAGS,CACL,CAAC,EAGP,OAASE,EAAK,CACRH,GACF,KAAK,OAAO,IAAIG,CAAG,CAEvB,CACF,CACF,EC5HO,IAAMC,GAAN,KAAmB,CASxB,YAAYC,EAAoCC,EAAgC,CAC9E,KAAK,OAASD,EACd,KAAK,QAAUC,EAEf,KAAK,UAAY,IAAIC,GAAoBF,EAAkBC,CAAS,EACpE,KAAK,QAAU,IAAIE,GAAkBH,EAAkBC,CAAS,EAChE,KAAK,SAAW,IAAIG,GAAmBJ,EAAkBC,CAAS,EAClE,KAAK,IAAM,IAAII,GAAcL,EAAkBC,CAAS,EACxD,KAAK,OAAS,IAAIK,GAAiBN,EAAkBC,CAAS,CAChE,CAEA,IAAW,OAAOM,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CAEA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEA,IAAW,QAAQN,EAAgC,CACjD,KAAK,UAAYA,CACnB,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,SACd,CAEA,IAAW,UAAUO,EAAgC,CACnD,KAAK,oBAAsBA,CAC7B,CAEA,IAAW,WAAY,CACrB,OAAO,KAAK,mBACd,CAEA,IAAW,QAAQC,EAA4B,CAC7C,KAAK,kBAAoBA,CAC3B,CAEA,IAAW,SAAU,CACnB,OAAO,KAAK,iBACd,CAEA,IAAW,SAASC,EAA8B,CAChD,KAAK,mBAAqBA,CAC5B,CAEA,IAAW,UAAW,CACpB,OAAO,KAAK,kBACd,CAEA,IAAW,IAAIC,EAAoB,CACjC,KAAK,cAAgBA,CACvB,CAEA,IAAW,KAAM,CACf,OAAO,KAAK,aACd,CAEA,IAAW,OAAOC,EAA0B,CAC1C,KAAK,iBAAmBA,CAC1B,CACA,IAAW,QAAS,CAClB,OAAO,KAAK,gBACd,CAEO,KAAKC,EAA0B,CACpC,KAAK,UAAU,KAAKA,CAAU,EAC9B,KAAK,SAAS,KAAK,EACnB,KAAK,IAAI,KAAK,EACd,KAAK,OAAO,KAAK,CACnB,CAEA,MAAa,KAAKC,EAWA,CAChB,MAAM,KAAK,UAAU,KAAKA,CAAS,EACnC,MAAM,KAAK,SAAS,KAAKA,CAAS,EAClC,MAAM,KAAK,IAAI,KAAKA,CAAS,EAC7B,MAAM,KAAK,QAAQ,KAAKA,CAAS,EACjC,MAAM,KAAK,OAAO,KAAKA,CAAS,CAClC,CAEA,MAAa,YAAYC,EAAsBC,EAAyB,CAClEA,EAAK,WACP,MAAM,KAAK,UAAU,IAAID,EAAc,CACrC,UAAW,CACT,QAAS,GACT,OAAQC,EAAK,WAAW,MAC1B,CACF,CAAC,EAECA,EAAK,UACP,MAAM,KAAK,SAAS,IAAID,EAAc,CACpC,SAAU,CACR,QAAS,GACT,OAAQC,EAAK,UAAU,MACzB,CACF,CAAC,EAECA,EAAK,KACP,MAAM,KAAK,IAAI,IAAID,EAAc,CAC/B,IAAK,CACH,QAAS,GACT,OAAQC,EAAK,KAAK,MACpB,CACF,CAAC,EAECA,EAAK,SACP,MAAM,KAAK,QAAQ,IAAID,EAAc,CACnC,QAAS,CACP,QAAS,GACT,OAAQC,EAAK,SAAS,OACtB,IAAKA,EAAK,SAAS,IACnB,QAASA,EAAK,SAAS,QACvB,OAAQA,EAAK,SAAS,OACtB,SAAUA,EAAK,SAAS,QAC1B,CACF,CAAC,EAECA,EAAK,QACP,MAAM,KAAK,OAAO,IAAID,EAAc,CAClC,OAAQ,CACN,QAAS,GACT,OAAQC,EAAK,QAAQ,OACrB,MAAOA,EAAK,QAAQ,MACpB,IAAKA,EAAK,QAAQ,IAClB,OAAQA,EAAK,QAAQ,OACrB,QAASA,EAAK,QAAQ,QACtB,OAAQA,EAAK,QAAQ,MACvB,CACF,CAAC,CACL,CACF,EC5JO,IAAMC,GAAN,KAAmB,CACxB,YAA6BC,EAAsB,CAAtB,eAAAA,CAAuB,CAEpD,MAAa,SAASC,EAAuBC,EAAgB,CAC3D,OAAO,KAAK,UAAU,SAASD,EAAUC,CAAI,CAC/C,CAEA,MAAa,YAAYD,EAAuBC,EAAgB,CAC9D,OAAO,KAAK,UAAU,YAAYD,EAAUC,CAAI,CAClD,CACF,ECPO,IAAMC,GAAN,KAAgB,CACrB,YAA6BC,EAAoC,CAApC,sBAAAA,EAE7B,KAAiB,OAAS,IAAIC,EAAO,WAAW,CAFkB,CAIlE,MAAa,SAASC,EAAuBC,EAAkB,CAC7D,GAAI,CACF,IAAMC,EAAa,CACjB,WAAYF,EAAS,WACrB,GAAGC,CACL,EAEME,EAAQ,MAAM,KAAK,iBAAiB,MAAM,SAAS,CACvD,MAAAD,EACA,OAAQ,CACN,GAAI,GACJ,SAAU,GACV,KAAM,GACN,SAAU,GACV,UAAW,GACX,QAAS,EACX,CACF,CAAC,EAED,GAAI,CAACC,GAASA,EAAM,SAAW,EAC7B,KAAM,kBAGR,OAAOA,CACT,OAASC,EAAO,CACd,MAAM,IAAIC,EAAoBD,CAAK,CACrC,CACF,CAEA,MAAa,YAAYJ,EAAuBM,EAAgB,CAC9D,IAAMH,GAAS,MAAM,KAAK,SAASH,EAAU,CAAE,GAAIM,EAAK,EAAG,CAAC,GAAG,CAAC,EAEhE,MAAO,CACL,SAFe,MAAMC,GAAaJ,EAAM,SAAUG,EAAK,MAAM,EAG7D,GAAGH,CACL,CACF,CACF,EC/CA,OAAOK,OAAW,QAClB,OAAS,YAAAC,OAAgB,gBAKlB,IAAMC,GAAN,KAAoB,CACzB,YAA6BC,EAA8B,CAA9B,mBAAAA,EAK7B,KAAiB,OAAS,IAAIC,EAAO,eAAe,EAKpD,KAAiB,OAAS,OAAO,OAAO,KAAK,cAAc,IAAqB,UAAU,CAAC,EATzF,KAAK,QAAU,UAAU,KAAK,OAAO,IAAI,IAAI,KAAK,OAAO,IAAI,YAAY,KAAK,OAAO,MAAM,GAC3F,KAAK,eAAiB,KAAK,cAAc,IAAU,gBAAgB,EAAE,QAAQ,GAC/E,CASA,IAAI,WAAY,CACd,MAAO,CAAC,CAAC,KAAK,QAAQ,OACxB,CAEA,MAAa,cAAe,CAC1B,GAAI,KAAK,OAAO,QAAS,CACvB,IAAMC,EAAM,UAAU,KAAK,OAAO,IAAI,IAAI,KAAK,OAAO,IAAI,GAC1D,GAAI,CAEF,IADiB,MAAML,GAAM,QAAQK,EAAM,OAAO,IACpC,MAAQ,OACpB,MAAM,IAAI,MAAM,wBAAwB,EAG1C,MAAML,GAAM,KAAK,GAAGK,CAAG,WAAY,CAAE,MAAO,KAAK,OAAO,MAAO,EAAG,CAAE,QAAS,CAAE,OAAQ,KAAK,cAAe,CAAE,CAAC,CAChH,OAASC,EAAO,CACd,KAAK,OAAO,MAAM,CAAC,uCAAwCA,GAAO,QAASA,GAAO,KAAK,CAAC,EACxF,IAAMC,EAAM,QAAQ,IACpBN,GAAS,WAAWM,CAAG,EAAE,CAC3B,CACF,CACF,CAEA,MAAa,iBAAkB,CAE/B,CAEA,MAAa,OAAOC,EAAoC,CACtD,GAAI,CACF,IAAMC,EAAW,MAAMT,GAAM,KAC3B,GAAG,KAAK,OAAO,GACf,CACE,SAAAQ,CACF,EACA,CAAE,QAAS,CAAE,OAAQ,KAAK,cAAe,CAAE,CAC7C,EACA,MAAO,CAAC,CAAE,OAAQC,EAAS,OAAQ,KAAMA,GAAU,IAAK,CAAC,CAC3D,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CAEA,MAAa,MAAME,EAAkBE,EAAaC,EAA6B,CAC7E,GAAI,CACF,IAAMF,EAAW,MAAMT,GAAM,KAAK,GAAG,KAAK,OAAO,IAAIQ,CAAQ,IAAIE,CAAG,GAAIC,EAAM,CAC5E,QAAS,CAAE,OAAQ,KAAK,cAAe,CACzC,CAAC,EACD,MAAO,CAAC,CAAE,OAAQF,EAAS,OAAQ,KAAMA,GAAU,IAAK,CAAC,CAC3D,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CAEA,MAAa,KAAKE,EAAkBE,EAA+B,CACjE,GAAI,CACF,IAAMD,EAAW,MAAMT,GAAM,IAAI,GAAG,KAAK,OAAO,IAAIQ,CAAQ,IAAIE,CAAG,GAAI,CACrE,QAAS,CAAE,OAAQ,KAAK,cAAe,CACzC,CAAC,EACD,MAAO,CAAC,CAAE,OAAQD,EAAS,OAAQ,KAAMA,GAAU,IAAK,CAAC,CAC3D,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CAEA,MAAa,OAAOE,EAAkBE,EAA+B,CACnE,GAAI,CACF,IAAMD,EAAW,MAAMT,GAAM,OAAO,GAAG,KAAK,OAAO,IAAIQ,CAAQ,IAAIE,CAAG,GAAI,CACxE,QAAS,CAAE,OAAQ,KAAK,cAAe,CACzC,CAAC,EACD,MAAO,CAAC,CAAE,OAAQD,EAAS,OAAQ,KAAMA,GAAU,IAAK,CAAC,CAC3D,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CAEA,MAAa,cAAiC,CAC5C,GAAI,CACF,IAAMG,EAAW,MAAMT,GAAM,IAAI,GAAG,KAAK,OAAO,kBAAmB,CAAE,QAAS,CAAE,OAAQ,KAAK,cAAe,CAAE,CAAC,EAC/G,MAAO,CAAC,CAAE,OAAQS,EAAS,OAAQ,KAAMA,GAAU,IAAiB,CAAC,CACvE,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CAEA,MAAa,cAAcE,EAAoC,CAC7D,GAAI,CACF,IAAMC,EAAW,MAAMT,GAAM,OAAO,GAAG,KAAK,OAAO,IAAIQ,CAAQ,GAAI,CAAE,QAAS,CAAE,OAAQ,KAAK,cAAe,CAAE,CAAC,EAC/G,MAAO,CAAC,CAAE,OAAQC,EAAS,OAAQ,KAAMA,GAAU,IAAK,CAAC,CAC3D,OAASH,EAAO,CACd,MAAO,CACL,CACE,OAAQA,GAAO,UAAU,OACzB,KAAMA,GAAO,UAAU,IACzB,EACAA,CACF,CACF,CACF,CACF,EClJA,OAAS,gBAAAM,OAAoB,iBAEtB,IAAMC,GAAN,KAAe,CAKtB,EAEaC,GAAN,cAA+BF,EAAa,CACjD,YAA6BG,EAA8B,CACzD,MAAM,EADqB,mBAAAA,EAI7B,KAAiB,OAAS,IAAIC,EAAO,kBAAkB,CAFvD,CAIA,MAAa,cAAe,CAC1B,MAAM,KAAK,SAAS,EACpB,KAAK,OAAO,KAAK,wBAAwB,CAC3C,CAEA,MAAa,iBAAkB,CAC7B,MAAM,KAAK,YAAY,EACvB,KAAK,OAAO,KAAK,yBAAyB,CAC5C,CACF,EClBA,OAAS,YAAAC,OAAgB,gBAEzB,OAAS,UAAAC,OAAc,KACvB,OAAS,QAAAC,OAAY,OAId,IAAMC,GAAN,KAA0B,CAC/B,YACmBC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACjB,CAPiB,kBAAAN,EACA,mBAAAC,EACA,sBAAAC,EACA,mBAAAC,EACA,WAAAC,EACA,mBAAAC,EACA,kBAAAC,EASnB,KAAiB,GAAwB,CAAC,EAC1C,KAAiB,MAA4B,CAAC,EAE9C,KAAiB,OAAS,IAAIC,EAAO,qBAAqB,EAC1D,KAAgB,YAAmC,CAAC,EAEpD,KAAiB,gBAAkB,OAAO,OAAO,KAAK,cAAc,IAAqB,UAAU,CAAC,EAblG,KAAK,eAAe,EACpB,KAAK,aAAa,EAElB,OAAO,OAAO,KAAK,GAAIN,EAAc,IAAc,UAAU,CAAC,EAC9D,OAAO,OAAO,KAAK,MAAOA,EAAc,IAAe,OAAO,CAAC,CACjE,CAUO,gBAAgBO,EAAkB,CACvC,IAAMC,EAAO,KAAK,cAAc,IAAiB,cAAc,EAC3D,OAAOA,GAAS,UAAYA,EAAO,GACrC,WACE,SAAY,CACN,KAAK,YAAYD,CAAQ,GAAG,kBAAkB,QAAU,SACtD,KAAK,YAAYA,CAAQ,GAAG,kBAAkB,QAAU,cACrD,MAAM,KAAK,YAAYA,CAAQ,EAAE,cAAiBE,EAAY,mBACjE,MAAM,KAAK,YAAYF,CAAQ,GAAG,QAAQ,OAAO,qBAAuBA,CAAQ,EAChF,KAAK,YAAYA,CAAQ,GAAG,QAAQ,IAAI,MAAM,EAC9C,KAAK,YAAYA,CAAQ,GAAG,QAAQ,IAAI,MAAS,GAEnD,KAAK,aAAa,KAAK,kBAAmBA,EAAU,OAAO,GAE3D,KAAK,aAAa,KAAK,kBAAmBA,EAAU,OAAO,EAGjE,EACA,IAAO,GAAKC,CACd,CAEJ,CAEA,MAAa,aAAaE,EAAwC,CAChE,GAAIA,GAAiBA,EAAc,OAAS,EAAG,CAC7C,IAAMC,EAAsBD,EAAgBA,EAAc,OAAQH,GAAa,CAAC,KAAK,YAAYA,CAAQ,CAAC,EAAI,CAAC,EAE/G,GAAII,EAAoB,OAAS,EAC/B,MAAM,IAAIC,EACR,WAAWD,EAAoB,OAAS,EAAI,IAAM,EAAE,KAAKA,EAAoB,KAAK,IAAI,CAAC,aACzF,CAEJ,CAEA,IAAME,EAAa,KAAK,cAAc,IAAc,UAAU,EAAE,WAAW,YAErEC,EACJJ,GAAiBA,EAAc,OAAS,EACpC,CACE,KAAM,CACJ,GAAIA,CACN,EACA,WAAAG,CACF,EACA,CAAE,WAAAA,CAAW,EAqBnB,OAnBkB,MAAM,KAAK,iBAAiB,SAAS,SAAS,CAC9D,MAAAC,EACA,QAAS,CACP,SAAU,GACV,MAAO,GACP,SAAU,GACV,IAAK,GACL,UAAW,GACX,QAAS,GACT,OAAQ,CACN,OAAQ,CACN,QAAS,GACT,QAAS,GACT,KAAM,EACR,CACF,CACF,CACF,CAAC,CAGH,CAEA,MAAa,iBAAiBC,EAAqBC,EAAiB,CAClE,IAAIC,EACJ,GAAIF,GAEF,GADAE,EAAe,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAAE,MAAO,CAAE,GAAIF,CAAW,CAAE,CAAC,EAAE,KAAMG,GAAMA,GAAG,IAAI,EAC5G,CAACD,EACH,MAAM,IAAIL,EAAkB,aAAaG,CAAU,aAAa,UAEzDC,IACTC,EAAe,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAAE,MAAO,CAAE,OAAAD,CAAO,CAAE,CAAC,EAAE,KAAME,GAAMA,GAAG,IAAI,EACpG,CAACD,GACH,MAAM,IAAIL,EAAkB,aAAaI,CAAM,aAAa,EAIhE,GAAI,CAACC,EACH,MAAM,IAAIL,EAAkB,aAAaG,CAAU,aAAa,EAGlE,GAAIE,GAAgB,CAAC,KAAK,YAAYA,CAAY,EAChD,MAAM,IAAIL,EAAkB,aAAaK,CAAY,aAAa,EAGpE,IAAMP,EAAgBO,EAAe,CAACA,CAAY,EAAI,KAEtD,OAAO,KAAK,aAAaP,CAAa,CACxC,CAEA,MAAa,WAAWO,EAAsB,CAC5C,IAAIE,EACJ,GAAI,KAAK,GAAG,UAAU,UACC,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAClE,MAAO,CAAE,KAAMF,CAAa,CAC9B,CAAC,EAEiB,CAChB,IAAMV,EAAW,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC3D,MAAO,CAAE,KAAMU,CAAa,EAC5B,KAAM,CAAE,iBAAkB,OAAQ,CACpC,CAAC,EAEDrB,GAAOC,GAAKuB,GAAcb,EAAS,EAAE,EAAG,CAAE,UAAW,GAAM,MAAO,EAAK,CAAC,EAExEY,EAAeZ,EAAS,GACxB,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,UAAWA,EAAS,EAAG,CAAE,CAAC,CACtF,CAGE,KAAK,MAAM,MAAM,SAAW,KAAK,MAAM,MAAM,iBAC/C,MAAM,KAAK,MAAM,OAAOU,CAAY,EAChCE,GACF,MAAM,KAAK,MAAM,OAAOA,CAAY,GAIpC,KAAK,iBAAiB,SACxB,MAAM,KAAK,cAAc,cAAcF,CAAY,CAEvD,CAEA,MAAa,kBAAkBA,EAAsB,CAC/C,KAAK,cAAc,IAAc,UAAU,EAAE,SAC/CtB,GAAS,UAAUE,GAAKwB,GAAW,WAAYJ,EAAe,GAAG,CAAC,EAAE,EAGtE,IAAMV,EAAW,MAAM,KAAK,iBAAiB,SAAS,UAAU,CAC9D,MAAO,CAAE,KAAMU,CAAa,CAC9B,CAAC,EAEIV,IAELX,GAAOC,GAAKuB,GAAcb,EAAS,EAAE,EAAG,CAAE,UAAW,GAAM,MAAO,EAAK,CAAC,EAExE,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,UAAWA,EAAS,EAAG,CAAE,CAAC,EAEpF,MAAM,KAAK,iBAAiB,KAAK,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EAClF,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACrF,MAAM,KAAK,iBAAiB,cAAc,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EAC3F,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EAErF,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACrF,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACtF,MAAM,KAAK,iBAAiB,MAAM,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACnF,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACtF,MAAM,KAAK,iBAAiB,IAAI,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACjF,MAAM,KAAK,iBAAiB,mBAAmB,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EAChG,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACrF,MAAM,KAAK,iBAAiB,UAAU,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACvF,MAAM,KAAK,iBAAiB,QAAQ,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EACrF,MAAM,KAAK,iBAAiB,MAAM,WAAW,CAAE,MAAO,CAAE,WAAYA,EAAS,EAAG,CAAE,CAAC,EAEnF,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAAE,MAAO,CAAE,KAAMU,CAAa,CAAE,CAAC,EAC/E,CAEA,MAAa,cAAe,CAC1B,GAAI,CACE,KAAK,iBAAiB,QACxB,MAAM,KAAK,0BAA0B,EAC5B,KAAK,GAAG,UAAU,SAC3B,MAAM,KAAK,kCAAkC,EACpC,KAAK,MAAM,MAAM,SAAW,KAAK,MAAM,MAAM,gBACtD,MAAM,KAAK,uBAAuB,CAEtC,OAASK,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAa,aAAaC,EAAW,CACnC,GAAI,CACF,IAAMV,EAAa,MAAM,KAAK,cAAc,IAAc,UAAU,EAAE,WAAW,YACjF,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC1C,KAAM,CACJ,GAAIU,EAAK,WACT,KAAMA,EAAK,aACX,SAAUA,EAAK,SACf,YAAaA,EAAK,YAClB,cAAeA,EAAK,cACpB,iBACEA,EAAK,aAAeA,EAAK,cAAgBd,EAAY,iBAAmB,QAAWc,EAAK,QAAU,OACpG,OAAQA,EAAK,OACb,YAAaA,EAAK,aAAed,EAAY,iBAC7C,MAAOc,EAAK,KACZ,WAAYV,EACZ,WAAYU,EAAK,UACnB,CACF,CAAC,CACH,OAASD,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEO,eAAeL,EAAsB,CAC1C,GAAI,CACF,KAAK,aAAa,KAAK,kBAAmBA,EAAc,OAAO,CACjE,OAASK,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAEA,MAAc,YAAYE,EAA2B,CACnD,IAAMjB,EAAWkB,GAAkB,KAAKD,EAAc,CACpD,cAAe,KAAK,cACpB,aAAc,KAAK,aACnB,iBAAkB,KAAK,iBACvB,MAAO,KAAK,MACZ,cAAe,KAAK,cACpB,aAAc,KAAK,aACnB,cAAe,KAAK,aACtB,CAAC,EAEIjB,IAELA,EAAS,YAAY,CACnB,WAAYiB,EAAa,WACzB,aAAcA,EAAa,aAC3B,YAAaA,EAAa,YAC1B,MAAOA,EAAa,MACpB,OAAQA,EAAa,OACrB,WAAYA,EAAa,UAC3B,CAAC,EAED,MAAMjB,EAAS,kBAAkB,EAEjC,KAAK,YAAYiB,EAAa,YAAY,EAAIjB,EAChD,CAEA,MAAc,wBAAyB,CACrC,IAAMmB,EAAO,MAAM,KAAK,MAAM,KAAK,EAE/BA,GAAM,OAAS,GACjB,MAAM,QAAQ,IACZA,EAAK,IAAI,MAAOC,GAAM,CACpB,IAAMH,EAAe,MAAM,KAAK,iBAAiB,SAAS,WAAW,CACnE,MAAO,CAAE,GAAIG,EAAE,MAAM,GAAG,EAAE,CAAC,CAAE,CAC/B,CAAC,EAED,GAAI,CAACH,EACH,OAGF,IAAMjB,EAAW,CACf,WAAYoB,EAAE,MAAM,GAAG,EAAE,CAAC,EAC1B,aAAcA,EAAE,MAAM,GAAG,EAAE,CAAC,EAC5B,YAAaH,EAAa,YAC1B,MAAOA,EAAa,MACpB,OAAQA,EAAa,OACrB,WAAYA,EAAa,UAC3B,EAEA,KAAK,YAAYjB,CAAQ,CAC3B,CAAC,CACH,CAEJ,CAEA,MAAc,mCAAoC,CAChD,IAAMM,EAAa,MAAM,KAAK,cAAc,IAAc,UAAU,EAAE,WAAW,YAE3Ee,EAAY,MAAM,KAAK,iBAAiB,SAAS,SAAS,CAC9D,MAAO,CAAE,WAAYf,CAAW,CAClC,CAAC,EAEGe,EAAU,SAAW,GAIzB,MAAM,QAAQ,IACZA,EAAU,IAAI,MAAOrB,GAAa,CAChC,KAAK,YAAY,CACf,WAAYA,EAAS,GACrB,aAAcA,EAAS,KACvB,YAAaA,EAAS,YACtB,MAAOA,EAAS,MAChB,OAAQA,EAAS,OACjB,WAAYA,EAAS,UACvB,CAAC,CACH,CAAC,CACH,CACF,CAEA,MAAc,2BAA4B,CACxC,GAAM,CAACqB,CAAS,EAAI,MAAM,KAAK,cAAc,aAAa,EAErDA,GAAW,MAIhB,MAAM,QAAQ,IACZA,GAAW,MAAM,IAAI,MAAOb,GAAuB,CACjD,IAAMR,EAAW,MAAM,KAAK,iBAAiB,SAAS,WAAW,CAC/D,MAAO,CAAE,GAAIQ,CAAW,CAC1B,CAAC,EAED,KAAK,YAAY,CACf,WAAYR,EAAS,GACrB,aAAcA,EAAS,KACvB,YAAaA,EAAS,YACtB,MAAOA,EAAS,MAChB,WAAYA,EAAS,UACvB,CAAC,CACH,CAAC,CACH,CACF,CAEQ,gBAAiB,CACvB,KAAK,aAAa,GAAG,kBAAmB,MAAOU,GAAyB,CACtE,GAAI,CACF,MAAM,KAAK,YAAYA,CAAY,GAAG,kCAAwC,IAAI,EAElF,KAAK,WAAWA,CAAY,EAC5B,KAAK,kBAAkBA,CAAY,CACrC,QAAE,CACA,KAAK,OAAO,KAAK,aAAaA,CAAY,aAAa,CACzD,CAEA,GAAI,CACF,OAAO,KAAK,YAAYA,CAAY,CACtC,OAASK,EAAO,CACd,KAAK,OAAO,MAAMA,CAAK,CACzB,CACF,CAAC,EACD,KAAK,aAAa,GAAG,kBAAmB,MAAOL,GAAyB,CACtE,GAAI,CACF,MAAM,KAAK,YAAYA,CAAY,GAAG,kCAAwC,IAAI,EAE9E,KAAK,cAAc,IAAc,UAAU,EAAE,SAC/C,KAAK,YAAYA,CAAY,GAAG,mBAAmB,EAGrD,KAAK,WAAWA,CAAY,CAC9B,QAAE,CACA,KAAK,OAAO,KAAK,aAAaA,CAAY,YAAY,CACxD,CACF,CAAC,CACH,CAEQ,cAAe,CACrB,KAAK,aAAa,GAAG,gBAAiB,MAAOA,GAAiB,CAC5D,GAAI,CACF,MAAM,KAAK,YAAYA,CAAY,GAAG,QAAQ,OAAO,qBAAuBA,CAAY,EAExF,KAAK,YAAYA,CAAY,GAAG,QAAQ,IAAI,MAAM,EAElD,KAAK,YAAYA,CAAY,EAAE,SAAS,OAAS,CAAE,MAAO,CAAE,EAC5D,KAAK,YAAYA,CAAY,EAAE,gBAAgB,MAAQ,OACzD,OAASK,EAAO,CACd,KAAK,OAAO,MAAM,CAChB,WAAY,eACZ,KAAM,uCACN,MAAAA,CACF,CAAC,CACH,QAAE,CACA,KAAK,OAAO,KAAK,aAAaL,CAAY,oBAAoB,CAChE,CACF,CAAC,CACH,CACF,EC9YO,IAAMY,GAAN,KAAmB,CACxB,YAA6BC,EAAgC,CAAhC,eAAAA,EAE7B,KAAiB,OAAS,IAAIC,EAAO,cAAc,CAFW,CAIvD,OAAOC,EAAuBC,EAAgB,CACnD,YAAK,UAAU,YAAYD,EAAS,YAAY,EAAE,SAASC,CAAI,EAExD,CAAE,MAAO,CAAE,GAAGD,EAAU,MAAOC,CAAK,CAAE,CAC/C,CAEA,MAAa,KAAKD,EAAuC,CACvD,GAAI,CACF,IAAME,EAAS,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,UAAU,EAEjF,GAAI,OAAO,KAAKE,CAAM,EAAE,SAAW,EACjC,MAAM,IAAI,MAAM,iBAAiB,EAGnC,OAAOA,CACT,MAAgB,CACd,OAAO,IACT,CACF,CACF,ECzBO,IAAMC,GAAN,KAAsB,CAC3B,YAA6BC,EAAgC,CAAhC,eAAAA,EAE7B,KAAiB,OAAS,IAAIC,EAAO,iBAAiB,CAFQ,CAI9D,MAAa,OAAOC,EAAuBC,EAAmB,CAC5D,aAAM,KAAK,UAAU,YAAYD,EAAS,YAAY,EAAE,YAAYC,CAAI,EAEjE,CAAE,SAAU,CAAE,GAAGD,EAAU,SAAUC,CAAK,CAAE,CACrD,CAEA,MAAa,KAAKD,EAA6C,CAC7D,GAAI,CACF,IAAME,EAAS,MAAM,KAAK,UAAU,YAAYF,EAAS,YAAY,EAAE,aAAa,EAEpF,GAAI,OAAO,KAAKE,CAAM,EAAE,SAAW,EACjC,MAAM,IAAI,MAAM,oBAAoB,EAGtC,OAAOA,CACT,MAAgB,CACd,OAAO,IACT,CACF,CACF,ECzBA,OAAOC,OAAW,QAIX,IAAMC,GAAN,KAAsB,CAC3B,YACmBC,EACDC,EACCC,EACjB,CAHiB,eAAAF,EACD,sBAAAC,EACC,mBAAAC,EAGnB,KAAiB,OAAS,IAAIC,EAAO,iBAAiB,CAFnD,CAOH,MAAa,KAAKC,EAAuB,CACvC,IAAMC,EAAc,MAAM,KAAK,UAAU,YAAYD,EAAS,YAAY,EAAE,SAE5E,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,KAAK,WAAaA,EAAY,WAC9B,KAAK,MAAQA,EAAY,MAEzB,IAAMC,EAAW,MAAM,KAAK,gBAAgB,CAAC,EAAG,KAAK,EAErD,GAAI,CAACA,EACH,MAAM,IAAI,MAAM,0BAA0B,EAG5C,OAAOA,EAAS,IAClB,CAEA,MAAa,OAAOF,EAAuBG,EAAmB,CAC5D,GAAI,CACF,IAAMF,EAAc,MAAM,KAAK,UAAU,YAAYD,EAAS,YAAY,EAAE,SAE5E,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,KAAK,WAAaA,EAAY,WAC9B,KAAK,MAAQA,EAAY,MAEzB,IAAMG,EAAW,CACf,KAAMD,EAAK,KACX,SAAUA,EAAK,SACf,sBAAuBA,EAAK,oBAC5B,SAAUA,EAAK,SACf,WAAYA,EAAK,UACnB,EAEMD,EAAW,MAAM,KAAK,gBAAgBE,EAAU,MAAM,EAE5D,GAAI,CAACF,GAAYA,EAAS,MACxB,MAAM,IAAI,MAAM,0BAA0B,EAa5C,OAViB,MAAM,KAAK,iBAAiB,SAAS,OAAO,CAC3D,KAAM,CACJ,WAAYA,EAAS,GACrB,KAAMC,EAAK,KACX,SAAUD,EACV,WAAYC,EAAK,WACjB,WAAYF,EAAY,EAC1B,CACF,CAAC,CAGH,OAASI,EAAO,CACd,WAAK,OAAO,MAAMA,CAAK,EACjB,IAAI,MAAM,0BAA0B,CAC5C,CACF,CAEA,MAAc,gBAAgBF,EAAWG,EAAgB,CACvD,GAAI,CACF,IAAIC,EAAY,KAAK,cAAc,IAAgB,aAAa,EAAE,IAC5DC,EAAU,KAAK,cAAc,IAAgB,aAAa,EAAE,QAClED,EAAY,GAAGA,CAAS,IAAIC,CAAO,IAAI,KAAK,UAAU,qBACtD,IAAMC,EAAU,CAAE,eAAgB,mBAAoB,cAAe,UAAU,KAAK,KAAK,EAAG,EAC5F,GAAIH,IAAW,MAEb,OADe,MAAMZ,GAAM,IAAIa,EAAW,CAAE,QAAAE,CAAQ,CAAC,GACvC,KACT,GAAIH,IAAW,OAEpB,OADe,MAAMZ,GAAM,KAAKa,EAAWJ,EAAM,CAAE,QAAAM,CAAQ,CAAC,GAC9C,IAElB,OAASC,EAAG,CACV,YAAK,OAAO,MAAMA,EAAE,SAAS,IAAI,EAC1BA,EAAE,SAAS,KAAK,KACzB,CACF,CACF,EC1DA,IAAMC,GAAS,IAAIC,EAAO,WAAW,EAEjCC,GAA8B,KAC9BC,EAAc,IAAc,UAAU,EAAE,UAC1CD,GAAgB,IAAIE,GAAa,IAAIC,GAAYF,EAAeG,GAAgB,IAAI,EAAE,UAAU,CAAC,GAG5F,IAAMC,GAAQ,IAAIH,GAAa,IAAIC,GAAYF,EAAe,UAAU,EAAE,UAAU,CAAC,EACtFK,GAAe,IAAIJ,GAAa,IAAIC,GAAYF,EAAe,SAAS,EAAE,UAAU,CAAC,EAEvFM,GAA+B,KAC/BN,EAAc,IAAqB,UAAU,EAAE,UACjDM,GAAgB,IAAIC,GAAcP,CAAa,GAG1C,IAAMQ,EAAmB,IAAIC,GAAiBT,CAAa,EAErDU,EAAY,IAAIC,GAC3BC,GACAZ,EACAQ,EACAF,GACAF,GACAL,GACAM,EACF,EAEMQ,GAAY,IAAIC,GAAUN,CAAgB,EACnCO,GAAe,IAAIC,GAAaH,EAAS,EAEhDI,GAAkB,IAAIC,GAAgBR,EAAWF,EAAkBR,CAAa,EACzEmB,GAAqB,IAAIC,GAAmBH,EAAe,EAElEI,GAAe,IAAIC,GAAaZ,CAAS,EAClCa,GAAkB,IAAIC,GAAgBH,GAAcX,CAAS,EAEpEe,GAAkB,IAAItB,GAAgBO,EAAWV,EAAeQ,EAAkBT,EAAa,EACxF2B,GAAqB,IAAIC,GAAmBF,GAAiBzB,EAAeQ,CAAgB,EAEnGoB,GAAkB,IAAIC,GAAgBnB,CAAS,EACxCoB,GAAqB,IAAIC,GAAmBH,EAAe,EAE3DI,GAAqB,IAAIC,GACpCvB,EACAV,EACAQ,EACAI,GACAa,GACAG,GACAL,GACAnB,GACAL,GACAM,GACAC,EACF,EACa4B,GAAwB,IAAIC,GAAsBzB,CAAS,EAC3D0B,GAAiB,IAAIC,GAAe3B,CAAS,EAC7C4B,EAAiB,IAAIC,GAAe7B,CAAS,EAC7C8B,GAAkB,IAAIC,GAAgB/B,CAAS,EAC/CgC,GAAkB,IAAIC,GAAgBjC,CAAS,EAE/CkC,EAAe,IAAIC,GAAarC,EAAkBE,CAAS,EAC3DoC,GAAoB,IAAIC,GAAkBvC,EAAkBE,CAAS,EACrEsC,GAAoB,IAAIC,GAAkBzC,EAAkBE,CAAS,EAGrEwC,GAAsB,IAAIC,GAAoB3C,EAAkBE,CAAS,EACzE0C,GAAiB,IAAIC,GAAe7C,EAAkBE,CAAS,EAC/D4C,GAAoB,IAAIC,GAAkB7C,CAAS,EAE1D8C,GAAiB,IAAIC,GAAe/C,EAAWV,EAAeQ,CAAgB,EACvEkD,GAAoB,IAAIC,GAAkBH,GAAgBhD,EAAkBE,CAAS,EAE5FkD,GAAgB,IAAIC,GAAcnD,EAAWV,EAAeQ,CAAgB,EACrEsD,GAAmB,IAAIC,GAAiBH,GAAepD,EAAkBE,CAAS,EAEzFsD,GAAc,IAAIC,GAAYvD,EAAWV,EAAeQ,CAAgB,EACjE0D,GAAiB,IAAIC,GAAeH,GAAaxD,EAAkBE,CAAS,EAEnF0D,GAAsB,IAAIC,GAAoB3D,EAAWV,EAAeQ,CAAgB,EACjF8D,GAAyB,IAAIC,GAAuBH,GAAqB5D,EAAkBE,CAAS,EAE3G8D,GAAiB,IAAIC,GAAe/D,EAAWV,EAAeQ,CAAgB,EACvEkE,GAAoB,IAAIC,GAAkBH,GAAgBhE,EAAkBE,CAAS,EAElGb,GAAO,KAAK,aAAa,ECxHzB,IAAM+E,GAAS,IAAIC,EAAO,OAAO,EAEjC,eAAeC,GAAOC,EAAcC,EAAaC,EAAoB,CACnE,IAAMC,EAAMC,EAAc,IAAU,gBAAgB,EAAE,QAChDC,EAAML,EAAI,IAAI,QAAQ,EACtBM,EAAKF,EAAc,IAAc,UAAU,EAEjD,GAAI,CAACC,EACH,MAAM,IAAIE,GAGZ,GAAIJ,EAAI,MAAQE,EACd,OAAOH,EAAK,EAGd,IAAKF,EAAI,YAAY,SAAS,kBAAkB,GAAKA,EAAI,YAAY,SAAS,0BAA0B,IAAM,CAACK,EAC7G,MAAM,IAAIG,GAAmB,yBAA0B,gCAAgC,EAEzF,IAAMC,EAAQT,EAAI,OAElB,GAAI,CACF,GAAIS,GAAO,cAIT,IAHiB,MAAMC,EAAiB,SAAS,WAAW,CAC1D,MAAO,CAAE,KAAMD,EAAM,YAAa,CACpC,CAAC,GACY,QAAUJ,EACrB,OAAOH,EAAK,UAGVF,EAAI,YAAY,SAAS,0BAA0B,GAAKM,EAAG,UAAU,UACjD,MAAMI,EAAiB,SAAS,UAAU,CAC9D,MAAO,CAAE,MAAOL,CAAI,CACtB,CAAC,EAEC,OAAOH,EAAK,CAIpB,OAASS,EAAO,CACdd,GAAO,MAAMc,CAAK,CACpB,CAEA,MAAM,IAAIJ,EACZ,CAEO,IAAMK,GAAY,CAAE,OAAAb,EAAO,EC9ClC,eAAec,GAAYC,EAAsB,CAC/C,GAAI,CACF,IAAMC,EAAYC,EAAc,IAAe,OAAO,EAEhDC,EAAS,CAAC,CAACC,EAAU,YAAYJ,CAAY,EAEnD,GAAIC,EAAU,MAAM,SAAWA,EAAU,MAAM,eAAgB,CAC7D,IAAMI,EAAY,MAAMC,GAAM,IAAIN,CAAY,EAE9C,OAAOG,GAAUE,CACnB,CAEA,OAAOF,IAAW,MAAMI,EAAiB,SAAS,SAAS,CAAE,MAAO,CAAE,KAAMP,CAAa,CAAE,CAAC,GAAG,OAAS,CAC1G,OAASQ,EAAO,CACd,MAAM,IAAIC,EAA6BD,GAAO,SAAS,CAAC,CAC1D,CACF,CAEA,eAAsBE,GAAoBC,EAAcC,EAAaC,EAAoB,CACvF,GAAIF,EAAI,YAAY,SAAS,kBAAkB,GAAKA,EAAI,YAAY,SAAS,0BAA0B,EACrG,OAAOE,EAAK,EAGd,IAAMC,EAAQH,EAAI,OAClB,GAAI,CAACG,GAAO,aACV,MAAM,IAAIC,EAAoB,8BAA8B,EAG9D,GAAI,CAAE,MAAMhB,GAAYe,EAAM,YAAY,EACxC,MAAM,IAAIE,EAAkB,QAAQF,EAAM,YAAY,2BAA2B,EAGnFD,EAAK,CACP,CAEA,eAAsBI,GAAoBN,EAAcC,EAAaC,EAAoB,CACvF,GAAIF,EAAI,YAAY,SAAS,kBAAkB,EAAG,CAChD,IAAMO,EAAWP,EAAI,KACrB,GAAI,MAAMZ,GAAYmB,EAAS,YAAY,EACzC,MAAM,IAAIC,GAAmB,cAAcD,EAAS,YAAY,sBAAsB,EAGpFd,EAAU,YAAYc,EAAS,YAAY,GAC7C,OAAOd,EAAU,YAAYc,EAAS,YAAY,CAEtD,CAEAL,EAAK,CACP,CCnDA,IAAMO,GAAN,KAAgB,CACP,iBAAiBC,EAAcC,EAAeC,EAA0B,CAC7EC,EAAcH,EAAI,IAAI,EAEtBE,EAAK,CACP,CACF,EAEOE,GAAQL,GCXf,OAAS,UAAAM,OAAc,UCGvB,OAAS,UAAAC,OAAc,UAEhB,IAAMC,GAAN,cAA8BC,CAAa,CAChD,YAAqBC,EAA8B,CACjD,MAAM,EADa,mBAAAA,EAUrB,KAAgB,OAAiBH,GAAO,EARtC,KAAK,OAAO,KAAK,KAAK,WAAW,oBAAqB,EAAK,EAAG,MAAOI,EAAKC,IAAQ,CAChF,GAAM,CAAE,KAAAC,CAAK,EAAIF,EACXG,EAAW,MAAMC,GAAoB,eAAeF,CAAI,EAE9D,OAAOD,EAAI,OAAO,GAAG,EAAE,KAAKE,CAAQ,CACtC,CAAC,CACH,CAGF,ECdA,OAAS,UAAAE,OAAc,UAEhB,IAAMC,GAAN,cAAyBC,CAAa,CAC3C,YAAqBC,EAA8B,CACjD,MAAM,EADa,mBAAAA,EAgBrB,KAAgB,OAAiBH,GAAO,EAdtC,KAAK,OACF,IAAI,KAAK,WAAW,eAAgB,EAAK,EAAG,MAAOI,EAAKC,IAAQ,CAC3DD,EAAI,MAAM,kBAAkB,IAAMD,EAAc,IAAgB,aAAa,EAAE,cACjFE,EAAI,KAAKD,EAAI,MAAM,eAAe,CAAC,EAChCC,EAAI,KAAK,+BAA+B,CAC/C,CAAC,EACA,KAAK,KAAK,WAAW,eAAgB,EAAK,EAAG,MAAOD,EAAKC,IAAQ,CAChE,GAAM,CAAE,KAAAC,CAAK,EAAIF,EACXG,EAAW,MAAMC,GAAe,eAAeF,CAAI,EAEzD,OAAOD,EAAI,OAAO,GAAG,EAAE,KAAKE,CAAQ,CACtC,CAAC,CACL,CAGF,ECrBO,IAAME,GAAN,KAAkB,CAmBzB,EAEO,SAASC,GAAiDC,EAAa,CAC5E,OAAO,cAAcA,CAAK,CAe1B,CACF,CCrCO,IAAMC,GAAN,KAAe,CAkCtB,EAEO,SAASC,GAA8CC,EAAa,CACzE,OAAO,cAAcA,CAAK,CAkC1B,CACF,CCtEO,IAAMC,GAAN,cAA6BC,GAAmBC,GAAsB,KAAM,CAAC,CAAC,CAAC,CAAE,CAAC,ECDlF,IAAMC,EAAN,cAA0BC,EAAe,CAiDhD,EAEaC,GAAN,KAAqB,CAE5B,ECrDA,IAAMC,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,EAA8B,CACzC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CAEV,aAAc,CAAE,KAAM,QAAS,EAC/B,MAAO,CAAE,KAAM,QAAS,EACxB,OAAQ,CAAE,KAAM,SAAU,QAAS,kBAAmB,EACtD,WAAY,CAAE,KAAM,QAAS,EAC7B,OAAQ,CAAE,KAAM,SAAU,EAC1B,YAAa,CACX,KAAM,SACN,KAAM,OAAO,OAAOC,CAAW,CACjC,EAEA,WAAY,CAAE,KAAM,SAAU,EAC9B,QAAS,CAAE,KAAM,QAAS,EAC1B,aAAc,CAAE,KAAM,SAAU,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,SAAU,EAC9B,gBAAiB,CAAE,KAAM,SAAU,EACnC,YAAa,CAAE,KAAM,QAAS,EAE9B,UAAW,CAAE,KAAM,QAAS,EAC5B,UAAW,CAAE,KAAM,QAAS,EAC5B,cAAe,CAAE,KAAM,QAAS,EAChC,cAAe,CAAE,KAAM,QAAS,EAChC,cAAe,CAAE,KAAM,QAAS,EAEhC,WAAY,CAAE,KAAM,QAAS,EAC7B,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,cAAe,CACb,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAM,CACJ,sBACA,iBACA,eACA,kBACA,kBACA,kBACA,kBACA,eACA,eACA,kBACA,kBACA,kBACA,YACA,eACA,eACA,eACA,gBACA,eACA,4BACA,oBACA,cACA,qBACA,OACA,gBACA,uBACF,CACF,CACF,EAEA,gBAAiB,CAAE,KAAM,SAAU,EACnC,eAAgB,CACd,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAM,CACJ,sBACA,iBACA,eACA,kBACA,kBACA,kBACA,kBACA,eACA,eACA,kBACA,kBACA,kBACA,YACA,eACA,eACA,eACA,gBACA,eACA,4BACA,oBACA,cACA,qBACA,OACA,gBACA,uBACF,CACF,CACF,EAEA,WAAY,CAAE,KAAM,SAAU,EAC9B,UAAW,CACT,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAM,CACJ,sBACA,iBACA,eACA,kBACA,kBACA,kBACA,kBACA,eACA,eACA,kBACA,kBACA,kBACA,YACA,eACA,eACA,eACA,gBACA,eACA,4BACA,oBACA,cACA,qBACA,OACA,gBACA,uBACF,CACF,CACF,EAEA,kBAAmB,CAAE,KAAM,QAAS,EACpC,cAAe,CAAE,KAAM,QAAS,EAChC,YAAa,CAAE,KAAM,QAAS,EAC9B,gBAAiB,CAAE,KAAM,SAAU,EACnC,2BAA4B,CAAE,KAAM,SAAU,EAC9C,4BAA6B,CAAE,KAAM,SAAU,EAC/C,uBAAwB,CAAE,KAAM,SAAU,EAC1C,kBAAmB,CAAE,KAAM,QAAS,EACpC,4BAA6B,CAAE,KAAM,SAAU,EAC/C,uBAAwB,CAAE,KAAM,SAAU,EAC1C,gCAAiC,CAAE,KAAM,QAAS,CACpD,EACA,GAAGN,GAAW,cAAc,CAC9B,EAEaO,GAAkC,CAC7C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CACR,KAAM,SACN,KAAM,CAAC,cAAe,YAAa,YAAa,YAAa,QAAQ,CACvE,CACF,EACA,SAAU,CAAC,UAAU,CACvB,ECvLA,OAAyB,UAAAG,OAAc,UAEhC,IAAMC,GAAN,cAA4BC,CAAa,CAC9C,eAAeC,EAA0B,CACvC,MAAM,EA8FR,KAAgB,OAAiBH,GAAO,EA7FtC,KAAK,OACF,KAAK,KAAK,WAAW,YAAY,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAClE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,WAAWD,EAAUL,EAAI,IAAI,CACxE,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,kBAAkBD,EAAUL,EAAI,IAAI,CAC/E,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,gBAAgB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACtE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,eAAeD,EAAUL,EAAI,IAAI,CAC5E,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,wBAAwB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC9E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,uBAAuBD,EAAUL,EAAI,IAAI,CACpF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,iBAAiB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,gBAAgBD,EAAUL,EAAI,IAAI,CAC7E,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,oBAAoB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC1E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,mBAAmBD,CAAQ,CACtE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,SAASD,EAAUL,EAAI,IAAI,CACtE,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,gCAAgC,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACtF,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,+BAA+BD,EAAUL,EAAI,IAAI,CAC5F,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAkB,aAAaD,CAAQ,CAChE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ERlGO,IAAMK,GAAN,KAAoB,CAGzB,YAAYC,KAAuBC,EAAe,CAChD,KAAK,OAASC,GAAO,EAErB,KAAK,OAAO,IAAI,IAAK,IAAIC,GAAgBH,CAAa,EAAE,MAAM,EAC9D,KAAK,OAAO,IAAI,IAAK,IAAII,GAAWJ,CAAa,EAAE,MAAM,EACzD,KAAK,OAAO,IAAI,WAAY,IAAIK,GAAc,GAAGJ,CAAM,EAAE,MAAM,CACjE,CACF,ESbA,IAAMK,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEME,GAA0C,CAC9C,KAAM,SACN,YAAa,gBACf,EAEaC,GAAoC,CAC/C,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CACP,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,YAAa,+CACf,CACF,CACF,CACF,EAEaC,GAAiC,CAC5C,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,aAAc,CACZ,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC/C,UAAW,CAAE,KAAM,QAAS,CAC9B,EACA,SAAU,CAAC,KAAM,SAAU,WAAW,EACtC,GAAGN,GAAW,KAAM,WAAW,CACjC,CACF,CACF,EACA,SAAU,CAAC,cAAc,CAC3B,EAEaQ,GAAiC,CAC5C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,EACvB,YAAa,CACX,KAAM,SACN,WAAY,CACV,IAAK,CACH,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,EACA,SAAU,CAAC,KAAM,SAAU,WAAW,EACtC,GAAGN,GAAW,KAAM,WAAW,CACjC,EACA,iBAAkB,CAAE,KAAM,UAAW,UAAW,CAAE,CACpD,EACA,SAAU,CAAC,KAAK,EAChB,GAAGA,GAAW,kBAAkB,CAClC,EACA,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CAClD,EACA,SAAU,CAAC,SAAS,CACtB,EAEaS,GAAoC,CAC/C,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,EACvB,YAAa,CACX,KAAM,SACN,WAAY,CACV,IAAK,CACH,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,EACA,SAAU,CAAC,KAAM,SAAU,WAAW,EACtC,GAAGN,GAAW,KAAM,WAAW,CACjC,EACA,iBAAkB,CAAE,KAAM,UAAW,UAAW,CAAE,CACpD,EACA,SAAU,CAAC,KAAK,EAChB,GAAGA,GAAW,kBAAkB,CAClC,CACF,EACA,SAAU,CAAC,aAAa,CAC1B,EAEaU,GAAmC,CAC9C,IAAKJ,EAAG,EACR,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC/C,UAAW,CAAE,KAAM,QAAS,EAC5B,YAAa,CAAE,KAAM,QAAS,CAChC,EACA,SAAU,CAAC,KAAM,SAAU,WAAW,EACtC,GAAGN,GAAW,KAAM,YAAa,aAAa,CAChD,EAEaW,GAAoC,CAC/C,IAAKL,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,QAAS,EACzB,QAAS,CAAE,KAAM,QAAS,CAC5B,CACF,EAEaM,GAAmC,CAC9C,IAAKN,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,QAAS,EACzB,KAAM,CAAE,KAAM,QAAS,EACvB,IAAK,CACH,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,EACA,SAAU,CAAC,KAAM,SAAU,WAAW,EACtC,GAAGN,GAAW,KAAM,WAAW,CACjC,CACF,EACA,GAAGA,GAAW,SAAU,OAAQ,KAAK,CACvC,EAEaa,GAA8B,CACzC,IAAKP,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,MAAO,CAAE,KAAM,QAAS,EACxB,SAAU,CACR,KAAM,SACN,KAAM,CAAC,cAAe,YAAa,YAAa,YAAa,QAAQ,CACvE,CACF,EACA,SAAU,CAAC,SAAU,WAAY,OAAO,CAC1C,EAEaU,GAA+B,CAC1C,IAAKR,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,QAAS,EACzB,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,QAAS,SAAS,CAAE,CACvD,EACA,SAAU,CAAC,SAAU,QAAQ,EAC7B,GAAGN,GAAW,SAAU,QAAQ,CAClC,EAEae,GAAqC,CAChD,IAAKT,EAAG,EACR,KAAM,SACN,WAAY,CACV,MAAO,CACL,KAAM,SACN,WAAY,CACV,IAAK,CAAE,KAAM,SAAU,UAAW,CAAE,EACpC,SAAU,CAAE,KAAM,SAAU,UAAW,CAAE,EACzC,GAAI,CAAE,KAAM,SAAU,UAAW,CAAE,CACrC,EACA,GAAGN,GAAW,MAAO,KAAM,UAAU,CACvC,CACF,CACF,EAEagB,GAAqC,CAChD,IAAKV,EAAG,EACR,KAAM,SACN,WAAY,CACV,MAAO,CACL,KAAM,SACN,WAAY,CACV,IAAK,CAAE,KAAM,SAAU,UAAW,CAAE,EACpC,IAAK,CACH,KAAM,SACN,GAAI,CACF,cAAe,CACb,KAAM,CAAC,SAAU,YAAa,IAAI,CACpC,CACF,EACA,KAAM,CACJ,WAAY,CACV,UAAW,CACT,KAAM,SACN,UAAW,EACX,YAAa,8BACf,EACA,GAAI,CACF,KAAM,SACN,UAAW,EACX,YAAa,8BACf,EACA,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,CACF,CACF,EACA,QAAS,CAAE,KAAM,QAAS,CAC5B,EACA,GAAGN,GAAW,KAAK,CACrB,EACA,MAAO,CAAE,KAAM,SAAU,CAC3B,CACF,EAEaiB,GAA+B,CAC1C,IAAKX,EAAG,EACR,KAAM,SACN,WAAY,CACV,MAAO,CACL,KAAM,SACN,WAAY,CACV,IAAK,CAAE,KAAM,QAAS,EACtB,UAAW,CAAE,KAAM,QAAS,EAC5B,GAAI,CAAE,KAAM,QAAS,EACrB,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC/C,YAAa,CAAE,KAAM,QAAS,EAC9B,OAAQ,CACN,KAAM,SACN,KAAM,CAAC,QAAS,UAAW,aAAc,eAAgB,OAAQ,QAAQ,CAC3E,CACF,EACA,GAAGN,GAAW,MAAO,YAAa,KAAM,QAAQ,CAClD,EACA,MAAO,CAAE,KAAM,SAAU,CAC3B,CACF,EAEakB,GAAqC,CAChD,IAAKZ,EAAG,EACR,KAAM,SACN,WAAY,CACV,aAAc,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,MAAM,CAAE,EACtD,QAAS,CACP,KAAM,SACN,KAAM,CAAC,MAAO,WAAY,oBAAqB,MAAM,CACvD,EACA,OAAQ,CACN,KAAM,SACN,KAAM,CAAC,MAAO,WAAY,oBAAqB,MAAM,CACvD,EACA,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,iBAAiB,CAAE,EAC3D,KAAM,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,WAAY,oBAAqB,MAAM,CAAE,EAC/E,SAAU,CACR,KAAM,SACN,KAAM,CAAC,MAAO,WAAY,oBAAqB,MAAM,CACvD,CACF,EACA,SAAU,CAAC,eAAgB,UAAW,SAAU,SAAU,OAAQ,UAAU,EAC5E,GAAGN,GAAW,eAAgB,UAAW,SAAU,SAAU,OAAQ,UAAU,CACjF,EAEamB,GAAiC,CAC5C,IAAKb,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,CACzB,EACA,GAAGN,GAAW,MAAM,CACtB,EAEaoB,GAAmC,CAC9C,IAAKd,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,QAAS,CAC3B,EACA,GAAGN,GAAW,QAAQ,CACxB,EAEaqB,GAA6B,CACxC,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,EACvB,KAAM,CAAE,KAAM,QAAS,EACvB,QAAS,CAAE,KAAM,QAAS,EAC1B,OAAQ,CAAE,KAAM,QAAS,EACzB,WAAY,CAAE,KAAM,SAAU,CAChC,CACF,ECzTA,IAAMC,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAAiC,CAC5C,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,QAAS,EAC1B,YAAa,CAAE,KAAM,QAAS,EAC9B,eAAgB,CAAE,KAAM,QAAS,EACjC,oBAAqB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC5D,aAAc,CACZ,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,UAAW,GACX,QAAS,OACT,YAAa,oDACf,CACF,CACF,EACA,SAAU,CAAC,UAAW,cAAc,EACpC,GAAGL,GAAW,UAAW,cAAe,gBAAgB,CAC1D,EAEaM,GAA8B,CACzC,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,SAAU,QAAS,gBAAiB,CACxD,EACA,SAAU,CAAC,UAAU,EACrB,GAAGL,GAAW,UAAU,CAC1B,EAEaO,GAAqC,CAChD,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,OAAQ,OAAO,CAAE,CAC7D,EACA,SAAU,CAAC,iBAAiB,EAC5B,GAAGL,GAAW,iBAAiB,CACjC,EAEaQ,GAAqC,CAChD,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,QAAS,CACP,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,UAAW,GACX,QAAS,OACT,YAAa,+CACf,CACF,CACF,EACA,SAAU,CAAC,WAAY,cAAe,SAAS,EAC/C,GAAGL,GAAW,WAAY,cAAe,SAAS,CACpD,EAEaS,GAAiC,CAC5C,IAAKJ,EAAG,EACR,KAAM,SACN,WAAY,CACV,WAAY,CAAE,KAAM,SAAU,QAAS,mBAAoB,CAC7D,EACA,SAAU,CAAC,YAAY,EACvB,GAAGL,GAAW,YAAY,CAC5B,EAEaU,GAAuC,CAClD,IAAKL,EAAG,EACR,KAAM,SACN,WAAY,CACV,WAAY,CAAE,KAAM,SAAU,QAAS,mBAAoB,CAC7D,EACA,SAAU,CAAC,YAAY,EACvB,GAAGL,GAAW,YAAY,CAC5B,EAEaW,GAAwC,CACnD,IAAKN,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,OAAQ,CACN,KAAM,SACN,KAAM,CAAC,MAAO,SAAU,UAAW,QAAQ,CAC7C,EACA,aAAc,CACZ,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,UAAW,GACX,QAAS,OACT,YAAa,oDACf,CACF,CACF,EACA,SAAU,CAAC,WAAY,SAAU,cAAc,EAC/C,GAAGL,GAAW,WAAY,QAAQ,CACpC,EAEaY,GAAoC,CAC/C,IAAKP,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,OAAQ,CACN,KAAM,SACN,KAAM,CAAC,eAAgB,mBAAoB,SAAU,UAAU,CACjE,CACF,EACA,SAAU,CAAC,WAAY,QAAQ,EAC/B,GAAGL,GAAW,WAAY,QAAQ,CACpC,EAEaa,GAAqC,CAChD,IAAKR,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,WAAY,CACV,KAAM,SACN,KAAM,CAAC,EAAG,MAAO,OAAQ,MAAO,CAClC,CACF,EACA,SAAU,CAAC,WAAY,YAAY,EACnC,GAAGL,GAAW,WAAY,YAAY,CACxC,EAEac,GAAwC,CACnD,IAAKT,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,MAAO,CAAE,KAAM,QAAS,CAC1B,EACA,SAAU,CAAC,WAAY,OAAO,EAC9B,GAAGL,GAAW,WAAY,OAAO,CACnC,EAEae,GAAwC,CACnD,IAAKV,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,QAAS,CAAE,KAAM,QAAS,CAC5B,EACA,SAAU,CAAC,WAAY,SAAS,EAChC,GAAGL,GAAW,WAAY,SAAS,CACrC,EAEagB,GAA4C,CACvD,IAAKX,EAAG,EACR,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,YAAa,CAAE,KAAM,QAAS,CAChC,EACA,SAAU,CAAC,WAAY,aAAa,EACpC,GAAGL,GAAW,WAAY,aAAa,CACzC,EC7LA,IAAMiB,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEME,GAA0C,CAC9C,KAAM,SACN,YAAa,gBACf,EAEaC,GAAiC,CAC5C,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,QAAS,CAAE,KAAM,QAAS,EAC1B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,SAAU,UAAW,QAAQ,EACxC,GAAGJ,GAAW,SAAU,UAAW,QAAQ,CAC7C,EClCA,IAAMO,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEME,GAA0C,CAC9C,KAAM,SACN,YAAa,gBACf,EAEaC,GAAqC,CAChD,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,KAAM,CAAE,KAAM,QAAS,EACvB,SAAU,CAAE,KAAM,QAAS,EAC3B,WAAY,CAAE,KAAM,OAAQ,EAC5B,WAAY,CAAE,KAAM,QAAS,CAC/B,EACA,SAAU,CAAC,OAAQ,UAAU,CAC/B,EAEMG,GAAmC,CACvC,WAAY,CACV,IAAK,CACH,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,EACA,SAAU,CAAC,IAAI,EACf,GAAGP,GAAW,IAAI,CACpB,EACA,QAAS,CAAE,KAAM,QAAS,CAC5B,CACF,EAEaQ,GAA+B,CAC1C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAChD,aAAc,CAAE,KAAM,UAAW,QAAS,EAAG,QAAS,EAAG,CAC3D,EACA,SAAU,CAAC,SAAU,cAAc,CACrC,EAEaK,GAAiC,CAC5C,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,KAAM,CAAE,KAAM,QAAS,EACvB,YAAa,CAAE,KAAM,SAAU,EAC/B,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,SAAU,MAAM,CAC7B,EAEaG,GAAkC,CAC7C,IAAKJ,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,UAAW,CAAE,KAAM,SAAU,KAAM,CAAC,QAAS,WAAY,QAAS,OAAO,CAAE,EAC3E,SAAU,CAAE,KAAM,QAAS,EAC3B,MAAO,CAAE,KAAM,QAAS,EACxB,SAAU,CAAE,KAAM,QAAS,EAC3B,QAAS,CAAE,KAAM,QAAS,EAC1B,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,SAAU,WAAW,CAClC,EAEaI,GAAgC,CAC3C,IAAKL,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,MAAO,CAAE,KAAM,QAAS,EACxB,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,QAAQ,CACrB,EAEaK,GAAkC,CAC7C,IAAKN,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,MAAO,CAAE,KAAM,QAAS,EACxB,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,QAAQ,CACrB,EAEaM,GAAmC,CAC9C,IAAKP,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,SAAU,KAAM,CAAC,OAAQ,QAAS,QAAS,OAAO,CAAE,EAClE,QAAS,CAAE,KAAM,QAAS,EAC1B,QAAS,CAAE,KAAM,QAAS,EAC1B,gBAAiB,CAAE,KAAM,QAAS,EAClC,KAAM,CAAE,KAAM,UAAW,QAAS,EAAG,QAAS,CAAE,EAChD,cAAe,CACb,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,qDACf,CACF,EACA,YAAa,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACtD,EACA,SAAU,CAAC,MAAM,CACnB,EAEaQ,GAAoC,CAC/C,IAAKR,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,QAAS,CAAE,KAAM,QAAS,EAC1B,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,QAAQ,CACrB,EAEaQ,GAAqC,CAChD,IAAKT,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,SAAU,CAAE,KAAM,QAAS,EAC3B,UAAW,CAAE,KAAM,QAAS,EAC5B,KAAM,CAAE,KAAM,QAAS,EACvB,QAAS,CAAE,KAAM,QAAS,EAC1B,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,SAAU,WAAY,YAAa,OAAQ,SAAS,CACjE,EAEaS,GAAoC,CAC/C,IAAKV,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,QAAS,CACP,KAAM,QACN,MAAO,CACL,KAAM,SACN,WAAY,CACV,SAAU,CAAE,KAAM,QAAS,EAC3B,KAAM,CACJ,KAAM,SACN,UAAW,GACX,QAAS,OACT,YAAa,iCACf,EACA,YAAa,CAAE,KAAM,SAAU,UAAW,EAAG,EAC7C,aAAc,CAAE,KAAM,QAAS,EAC/B,MAAO,CAAE,KAAM,QAAS,EACxB,IAAK,CAAE,KAAM,QAAS,CACxB,EACA,SAAU,CAAC,WAAY,aAAa,EACpC,GAAGJ,GAAW,UAAU,CAC1B,EACA,SAAU,EACV,YAAa,EACf,CACF,EACA,SAAU,CAAC,SAAU,SAAS,CAChC,EAEaiB,GAAqC,CAChD,IAAKX,EAAG,EACR,KAAM,SACN,WAAY,CACV,IAAK,CACH,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,CACjD,EACA,SAAU,CAAC,KAAM,YAAa,QAAQ,EACtC,GAAGN,GAAW,KAAM,WAAW,CACjC,EACA,SAAU,CAAE,KAAM,QAAS,CAC7B,EACA,SAAU,CAAC,MAAO,UAAU,CAC9B,EAEakB,GAAiC,CAC5C,IAAKZ,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,KAAM,CAAE,KAAM,QAAS,EACvB,gBAAiB,CAAE,KAAM,UAAW,QAAS,EAAG,QAAS,EAAG,EAC5D,OAAQ,CACN,KAAM,QACN,SAAU,EACV,SAAU,GACV,YAAa,GACb,MAAO,CACL,KAAM,QACR,CACF,EACA,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGG,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,SAAU,OAAQ,kBAAmB,QAAQ,CAC1D,EAEaY,GAAiC,CAC5C,IAAKb,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,MAAO,CAAE,KAAM,QAAS,EACxB,YAAa,CAAE,KAAM,QAAS,EAC9B,WAAY,CAAE,KAAM,QAAS,EAC7B,WAAY,CAAE,KAAM,QAAS,EAC7B,SAAU,CACR,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,WAAY,CACV,MAAO,CAAE,KAAM,QAAS,EACxB,KAAM,CACJ,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,WAAY,CACV,MAAO,CAAE,KAAM,QAAS,EACxB,YAAa,CAAE,KAAM,QAAS,EAC9B,MAAO,CAAE,KAAM,QAAS,CAC1B,EACA,SAAU,CAAC,QAAS,OAAO,EAC3B,GAAGJ,GAAW,QAAS,cAAe,OAAO,CAC/C,CACF,CACF,EACA,SAAU,CAAC,QAAS,MAAM,EAC1B,GAAGA,GAAW,OAAO,CACvB,CACF,EACA,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGO,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,SAAU,QAAS,aAAc,aAAc,UAAU,CACtE,EAEaa,GAAoC,CAC/C,IAAKd,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,GAAGF,EAAiB,EAC9B,aAAc,CAAE,KAAM,QAAS,EAC/B,MAAO,CAAE,KAAM,QAAS,EACxB,YAAa,CAAE,KAAM,QAAS,EAC9B,OAAQ,CAAE,KAAM,QAAS,EACzB,QAAS,CACP,KAAM,QACN,MAAO,CACL,KAAM,SACN,WAAY,CACV,KAAM,CACJ,KAAM,SACN,KAAM,CAAC,QAAS,OAAQ,MAAO,OAAQ,KAAK,CAC9C,EACA,YAAa,CAAE,KAAM,QAAS,EAC9B,GAAI,CAAE,KAAM,QAAS,EACrB,IAAK,CAAE,KAAM,QAAS,EACtB,YAAa,CAAE,KAAM,QAAS,EAC9B,SAAU,CAAE,KAAM,QAAS,EAC3B,KAAM,CAAE,KAAM,QAAS,EACvB,QAAS,CAAE,KAAM,SAAU,KAAM,CAAC,QAAS,QAAS,MAAO,OAAQ,QAAQ,CAAE,EAC7E,IAAK,CAAE,KAAM,QAAS,CACxB,EACA,SAAU,CAAC,MAAM,EACjB,GAAGJ,GAAW,KAAM,MAAO,aAAa,CAC1C,CACF,EACA,MAAO,CACL,KAAM,UACN,YAAa,+BACf,EACA,OAAQ,CAAE,GAAGO,EAAoB,EACjC,SAAU,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACjD,UAAW,CACT,KAAM,QACN,SAAU,EACV,YAAa,GACb,MAAO,CACL,KAAM,SACN,QAAS,QACT,YAAa,iDACf,CACF,CACF,EACA,SAAU,CAAC,QAAQ,CACrB,EC7bA,IAAMc,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA2B,CACtC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAChD,KAAM,CAAE,KAAM,QAAS,EACvB,KAAM,CAAE,KAAM,QAAS,EACvB,SAAU,CAAE,KAAM,QAAS,EAC3B,SAAU,CAAE,KAAM,QAAS,EAC3B,SAAU,CAAE,KAAM,QAAS,CAC7B,EACA,SAAU,CAAC,UAAW,OAAQ,OAAQ,UAAU,EAChD,GAAGL,GAAW,UAAW,OAAQ,OAAQ,UAAU,CACrD,EChCA,IAAMM,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA8B,CACzC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,WAAY,CAAE,KAAM,SAAU,EAC9B,QAAS,CAAE,KAAM,QAAS,EAC1B,aAAc,CAAE,KAAM,SAAU,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,SAAU,EAC9B,gBAAiB,CAAE,KAAM,SAAU,EACnC,YAAa,CAAE,KAAM,QAAS,CAChC,EACA,SAAU,CAAC,aAAc,eAAgB,eAAgB,eAAgB,aAAc,iBAAiB,EACxG,GAAGL,GAAW,aAAc,eAAgB,eAAgB,eAAgB,aAAc,iBAAiB,CAC7G,EClCA,IAAMM,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA8B,CACzC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,EACvB,SAAU,CAAE,KAAM,SAAU,KAAM,CAAC,iBAAkB,YAAa,SAAS,CAAE,EAC7E,oBAAqB,CAAE,KAAM,SAAU,EACvC,SAAU,CAAE,KAAM,QAAS,EAC3B,WAAY,CAAE,KAAM,OAAQ,EAC5B,WAAY,CAAE,KAAM,QAAS,CAC/B,EACA,SAAU,CAAC,OAAQ,WAAY,WAAY,YAAY,EACvD,GAAGL,GAAW,OAAQ,WAAY,WAAY,YAAY,CAC5D,EChCA,IAAMM,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA8B,CACzC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAChD,UAAW,CAAE,KAAM,QAAS,EAC5B,MAAO,CAAE,KAAM,QAAS,EACxB,IAAK,CAAE,KAAM,QAAS,EACtB,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAChD,cAAe,CAAE,KAAM,CAAC,SAAU,MAAM,CAAE,EAC1C,UAAW,CAAE,KAAM,CAAC,SAAU,MAAM,CAAE,EACtC,mBAAoB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC3D,oBAAqB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC5D,WAAY,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACnD,eAAgB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACvD,oBAAqB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAC5D,eAAgB,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EACvD,wBAAyB,CAAE,KAAM,QAAS,EAC1C,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,CACzD,EACA,SAAU,CAAC,UAAW,YAAa,QAAS,MAAO,UAAW,qBAAsB,qBAAqB,EACzG,GAAGL,GAAW,UAAW,YAAa,QAAS,MAAO,UAAW,qBAAsB,qBAAqB,CAC9G,ECzCA,IAAMM,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA0B,CACrC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,QAAS,CAAE,KAAM,SAAU,KAAM,CAAC,UAAW,gBAAiB,QAAS,UAAU,CAAE,EACnF,OAAQ,CAAE,KAAM,QAAS,EACzB,OAAQ,CAAE,KAAM,QAAS,EACzB,YAAa,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,UAAW,OAAQ,UAAU,CAAE,EAC5E,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,WAAY,aAAc,WAAY,OAAO,CAAE,EACnG,aAAc,CAAE,KAAM,QAAS,EAC/B,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,cAAe,CAAE,KAAM,SAAU,EACjC,YAAa,CAAE,KAAM,SAAU,CACjC,EACA,SAAU,CAAC,UAAW,UAAW,aAAa,EAC9C,GAAGL,GAAW,UAAW,UAAW,aAAa,CACnD,EAEaM,GAAgC,CAC3C,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,SAAU,SAAU,QAAQ,CAAE,CAC3E,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EAEaO,GAAiC,CAC5C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,eAAgB,CAAE,KAAM,QAAS,EACjC,cAAe,CAAE,KAAM,SAAU,EACjC,YAAa,CAAE,KAAM,SAAU,CACjC,EACA,SAAU,CACR,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,aACA,gBACA,aACF,EACA,GAAGL,GACD,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,aACA,gBACA,aACF,CACF,EAEaQ,GAAmC,CAC9C,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EChHA,IAAMS,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAAkC,CAC7C,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,OAAQ,CAAE,KAAM,QAAS,EACzB,OAAQ,CAAE,KAAM,QAAS,EACzB,YAAa,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,UAAW,OAAQ,UAAU,CAAE,EAC5E,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,WAAY,aAAc,WAAY,OAAO,CAAE,EACnG,aAAc,CAAE,KAAM,QAAS,EAC/B,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,cAAe,CAAE,KAAM,SAAU,EACjC,YAAa,CAAE,KAAM,SAAU,CACjC,EACA,SAAU,CAAC,UAAW,SAAU,aAAa,EAC7C,GAAGL,GAAW,UAAW,SAAU,aAAa,CAClD,EAEaM,GAAwC,CACnD,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,SAAU,SAAU,QAAQ,CAAE,CAC3E,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EAEaO,GAAyC,CACpD,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,cAAe,CAAE,KAAM,QAAS,EAChC,cAAe,CAAE,KAAM,SAAU,EACjC,YAAa,CAAE,KAAM,SAAU,CACjC,EACA,SAAU,CACR,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,aACA,gBACA,aACF,EACA,GAAGL,GACD,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,aACA,gBACA,aACF,CACF,EAEaQ,GAA2C,CACtD,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EC/GA,IAAMS,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA6B,CACxC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,OAAQ,CAAE,KAAM,QAAS,EACzB,OAAQ,CAAE,KAAM,QAAS,EACzB,YAAa,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,UAAW,OAAQ,UAAU,CAAE,EAC5E,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,WAAY,aAAc,WAAY,OAAO,CAAE,EACnG,aAAc,CAAE,KAAM,QAAS,EAC/B,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,CACzD,EACA,SAAU,CAAC,UAAW,SAAU,aAAa,EAC7C,GAAGL,GAAW,UAAW,SAAU,aAAa,CAClD,EAEaM,GAAmC,CAC9C,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,SAAU,SAAU,QAAQ,CAAE,CAC3E,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EAEaO,GAAoC,CAC/C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,cAAe,CAAE,KAAM,QAAS,CAClC,EACA,SAAU,CACR,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,YACF,EACA,GAAGL,GACD,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,YACF,CACF,EAEaQ,GAAsC,CACjD,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,ECvGA,IAAMS,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA4B,CACvC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,cAAe,CAAE,KAAM,QAAS,EAChC,QAAS,CAAE,KAAM,SAAU,KAAM,CAAC,YAAa,gBAAgB,CAAE,EACjE,YAAa,CAAE,KAAM,QAAS,EAC9B,YAAa,CAAE,KAAM,QAAS,EAC9B,MAAO,CAAE,KAAM,QAAS,EACxB,eAAgB,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EAC3D,kBAAmB,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EAC9D,aAAc,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACzD,UAAW,CAAE,KAAM,SAAU,EAC7B,YAAa,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,UAAW,OAAQ,UAAU,CAAE,EAC5E,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,WAAY,aAAc,WAAY,OAAO,CAAE,EACnG,aAAc,CAAE,KAAM,QAAS,EAC/B,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,CACzD,EACA,SAAU,CAAC,UAAW,gBAAiB,UAAW,aAAa,EAC/D,GAAGL,GAAW,UAAW,gBAAiB,UAAW,aAAa,CACpE,EAEaM,GAAiC,CAC5C,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,KAAM,CAAE,KAAM,QAAS,EACvB,OAAQ,CAAE,KAAM,QAAS,CAC3B,EACA,SAAU,CAAC,OAAQ,QAAQ,EAC3B,GAAGL,GAAW,OAAQ,QAAQ,CAChC,EAEaO,GAAkC,CAC7C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,SAAU,SAAU,QAAQ,CAAE,CAC3E,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EAEaQ,GAAmC,CAC9C,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,cAAe,CAAE,KAAM,QAAS,EAChC,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,EACvD,iBAAkB,CAAE,KAAM,QAAS,CACrC,EACA,SAAU,CACR,gBACA,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,YACF,EACA,GAAGL,GACD,gBACA,SACA,gBACA,eACA,iBACA,kBACA,gBACA,WACA,eACA,YACF,CACF,EAEaS,GAAqC,CAChD,IAAKJ,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EC7HA,IAAMU,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA6B,CACxC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,YAAa,CAAE,KAAM,QAAS,EAC9B,IAAK,CAAE,KAAM,QAAS,EACtB,QAAS,CAAE,KAAM,QAAS,EAC1B,YAAa,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,UAAW,OAAQ,UAAU,CAAE,EAC5E,gBAAiB,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,WAAY,aAAc,WAAY,OAAO,CAAE,EACnG,aAAc,CAAE,KAAM,QAAS,EAC/B,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,CACzD,EACA,SAAU,CAAC,UAAW,MAAO,UAAW,aAAa,EACrD,GAAGL,GAAW,UAAW,MAAO,UAAW,aAAa,CAC1D,EAEaM,GAAmC,CAC9C,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,SAAU,SAAU,SAAU,QAAQ,CAAE,CAC3E,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EAEaO,GAAkC,CAC7C,IAAKF,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,IAAK,CAAE,KAAM,QAAS,EACtB,QAAS,CAAE,KAAM,QAAS,CAC5B,EACA,SAAU,CAAC,YAAa,MAAO,SAAS,EACxC,GAAGL,GAAW,YAAa,MAAO,SAAS,CAC7C,EAEaQ,GAAoC,CAC/C,IAAKH,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CAAE,KAAM,SAAU,EAC1B,cAAe,CAAE,KAAM,QAAS,EAChC,aAAc,CAAE,KAAM,SAAU,EAChC,eAAgB,CAAE,KAAM,QAAS,EACjC,gBAAiB,CAAE,KAAM,SAAU,EACnC,cAAe,CAAE,KAAM,SAAU,EACjC,SAAU,CAAE,KAAM,SAAU,EAC5B,aAAc,CAAE,KAAM,SAAU,EAChC,kBAAmB,CAAE,KAAM,QAAS,EACpC,WAAY,CAAE,KAAM,QAAS,MAAO,CAAE,KAAM,QAAS,CAAE,CACzD,EACA,SAAU,CAAC,SAAU,gBAAiB,eAAgB,iBAAkB,kBAAmB,eAAe,EAC1G,GAAGL,GAAW,SAAU,gBAAiB,eAAgB,iBAAkB,kBAAmB,eAAe,CAC/G,EAEaS,GAAsC,CACjD,IAAKJ,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CAAE,KAAM,QAAS,EAC5B,OAAQ,CAAE,KAAM,SAAU,KAAM,CAAC,MAAO,QAAQ,CAAE,CACpD,EACA,SAAU,CAAC,YAAa,QAAQ,EAChC,GAAGL,GAAW,YAAa,QAAQ,CACrC,EC5FA,IAAMU,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EACaE,GAA4B,CACvC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,OAAQ,CACN,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,MAAO,CAAE,KAAM,QAAS,EACxB,IAAK,CAAE,KAAM,QAAS,EACtB,OAAQ,CAAE,KAAM,QAAS,EACzB,QAAS,CAAE,KAAM,QAAS,EAC1B,OAAQ,CAAE,KAAM,SAAU,EAC1B,OAAQ,CACN,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAMC,EAAgB,MACxB,CACF,CACF,EACA,SAAU,CAAC,UAAW,QAAS,MAAO,SAAU,UAAW,QAAQ,EACnE,GAAGN,GAAW,UAAW,QAAS,MAAO,SAAU,UAAW,QAAQ,CACxE,CACF,EACA,SAAU,CAAC,QAAQ,CACrB,EC5CA,IAAMO,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAA6B,CACxC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,QAAS,CACP,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,SAAU,EAC3B,IAAK,CAAE,KAAM,QAAS,EACtB,QAAS,CAAE,KAAM,QAAS,EAC1B,SAAU,CAAE,KAAM,SAAU,EAC5B,OAAQ,CAAE,KAAM,SAAU,EAC1B,OAAQ,CACN,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAMC,EAAgB,MACxB,CACF,CACF,EACA,SAAU,CAAC,UAAW,KAAK,EAC3B,GAAGN,GAAW,UAAW,KAAK,CAChC,CACF,EACA,SAAU,CAAC,SAAS,CACtB,EC1CO,IAAMO,GAA2B,CACtC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,UAAW,CACT,KAAM,eACR,EACA,SAAU,CACR,KAAM,eACR,EACA,IAAK,CACH,KAAM,eACR,CACF,EACA,MAAO,CACL,MAAO,CACL,KAAM,SACN,WAAY,CACV,QAAS,CAAE,KAAM,UAAW,KAAM,CAAC,GAAM,EAAK,CAAE,EAChD,OAAQ,CACN,KAAM,QACN,SAAU,EACV,MAAO,CACL,KAAM,SACN,KAAMC,EAAgB,MACxB,CACF,CACF,EACA,SAAU,CAAC,SAAS,CACtB,CACF,CACF,ECjCA,OAAyB,UAAAC,OAAc,UAEhC,IAAMC,GAAN,cAA6BC,CAAa,CAC/C,eAAeC,EAA0B,CACvC,MAAM,EAkCR,KAAgB,OAAiBH,GAAO,EAjCtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAmB,eAAeF,EAAUC,CAAI,CAC/E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAmB,aAAaF,CAAQ,CACjE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,SAAS,EAAG,MAAOF,EAAKC,IAAQ,CACpD,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAmB,eAAeF,EAAUC,CAAI,CAC/E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECrCO,IAAMQ,GAAN,KAAmB,CAG1B,ECTO,IAAMC,GAAN,KAAc,CAoBrB,EAEaC,GAAN,KAAqB,CAa5B,ECxBA,OAAyB,UAAAC,OAAc,UAEhC,IAAMC,GAAN,cAAyBC,CAAa,CAC3C,eAAeC,EAA0B,CACvC,MAAM,EAwGR,KAAgB,OAAiBH,GAAO,EAvGtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAAsB,CAChD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAe,UAAUF,EAAUC,CAAI,CACtE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAe,QAAQF,CAAQ,CACxD,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAe,SAASF,EAAUL,EAAI,OAAO,MAAM,CAC5E,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,gBAAgB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACrE,IAAMC,EAAW,MAAM,KAAK,aAAsB,CAChD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAe,UAAUF,EAAUL,EAAI,OAAO,OAAQM,CAAI,CACzF,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,gBAAgB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACxE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAe,UAAUF,EAAUL,EAAI,OAAO,MAAM,CAC7E,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAe,SAASF,EAAUC,CAAI,CACrE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAe,cAAcF,CAAQ,CAC9D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQY,GACR,SAAUH,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAe,aAAaF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,uBAAuB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC5E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAe,cAAcF,EAAUL,EAAI,OAAO,MAAM,CACjF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQa,GACR,SAAUC,GACV,QAAS,CAACT,EAAUC,IAASC,GAAe,UAAUF,EAAUC,CAAI,CACtE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECxHO,IAAMa,GAAN,KAAqB,CAG5B,EAEaC,GAAN,KAAgB,CA0BvB,EAEaC,GAAN,KAAuB,CAe9B,ECpCA,OAAyB,UAAAC,OAAc,UAEhC,IAAMC,GAAN,cAA2BC,CAAa,CAC7C,eAAeC,EAA0B,CACvC,MAAM,EAgJR,KAAgB,OAAiBH,GAAO,EA/ItC,KAAK,OACF,KAAK,KAAK,WAAW,OAAO,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC7D,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAiB,kBAAkBF,EAAUC,CAAI,CAChF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,OAAO,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC5D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,gBAAgBF,CAAQ,CAClE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,sBAAsB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC9E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,YAAYF,EAAUL,EAAI,OAAO,aAAa,CACxF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAAwB,CAClD,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAiB,UAAUF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,QAAQF,CAAQ,CAC1D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,oBAAoB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,SAASF,EAAUL,EAAI,OAAO,WAAW,CACnF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,qBAAqB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC1E,IAAMC,EAAW,MAAM,KAAK,aAAwB,CAClD,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAiB,UAAUF,EAAUL,EAAI,OAAO,YAAaM,CAAI,CAChG,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,qBAAqB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC7E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,UAAUF,EAAUL,EAAI,OAAO,WAAW,CACpF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA+B,CACzD,QAASF,EACT,OAAQY,GACR,SAAUC,GACV,QAAS,CAACR,EAAUC,IAASC,GAAiB,SAASF,EAAUC,CAAI,CACvE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,cAAcF,CAAQ,CAChE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQc,GACR,SAAUL,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAiB,aAAaF,EAAUC,CAAI,CAC3E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,4BAA4B,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACjF,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,cAAcF,EAAUL,EAAI,OAAO,WAAW,CACxF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQe,GACR,SAAUC,GACV,QAAS,CAACX,EAAUC,IAASC,GAAiB,UAAUF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,WAAW,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAiB,UAAUF,CAAQ,CAC5D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EC1JO,IAAMe,GAAN,KAAiB,CAiBxB,EAEaC,GAAN,KAAwB,CAW/B,ECzBA,OAAyB,UAAAC,OAAc,UAEhC,IAAMC,GAAN,cAA4BC,CAAa,CAC9C,eAAeC,EAA0B,CACvC,MAAM,EAkHR,KAAgB,OAAiBH,GAAO,EAjHtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAAyB,CACnD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAkB,UAAUF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,QAAQF,CAAQ,CAC3D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,kBAAkB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,SAASF,EAAUL,EAAI,OAAO,SAAS,CAClF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,mBAAmB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACxE,IAAMC,EAAW,MAAM,KAAK,aAAyB,CACnD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAkB,UAAUF,EAAUL,EAAI,OAAO,UAAWM,CAAI,CAC/F,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,mBAAmB,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,UAAUF,EAAUL,EAAI,OAAO,SAAS,CACnF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAkB,SAASF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,cAAcF,CAAQ,CACjE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,OAAO,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC7D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQY,GACR,SAAUH,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAkB,SAASF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQa,GACR,SAAUJ,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAkB,aAAaF,EAAUC,CAAI,CAC5E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,0BAA0B,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC/E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,cAAcF,EAAUL,EAAI,OAAO,SAAS,CACvF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,GAAkB,UAAUF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECjIA,OAAS,UAAAc,OAAc,UCEvB,OAAyB,UAAAC,OAAc,UCJhC,IAAMC,GAAN,KAAsB,CAmB7B,EAEaC,GAAN,KAA6B,CAapC,EDpBO,IAAMC,GAAN,cAAiCC,CAAa,CACnD,eAAeC,EAA0B,CACvC,MAAM,EAwGR,KAAgB,OAAiBC,GAAO,EAvGtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAA8B,CACxD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAuB,UAAUF,EAAUC,CAAI,CAC9E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAuB,QAAQF,CAAQ,CAChE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,uBAAuB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC5E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAuB,SAASF,EAAUL,EAAI,OAAO,cAAc,CAC5F,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,wBAAwB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC7E,IAAMC,EAAW,MAAM,KAAK,aAA8B,CACxD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAuB,UAAUF,EAAUL,EAAI,OAAO,eAAgBM,CAAI,CACzG,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,wBAAwB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChF,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAuB,UAAUF,EAAUL,EAAI,OAAO,cAAc,CAC7F,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAAqC,CAC/D,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAuB,SAASF,EAAUC,CAAI,CAC7E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAuB,cAAcF,CAAQ,CACtE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQY,GACR,SAAUH,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAuB,aAAaF,EAAUC,CAAI,CACjF,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,+BAA+B,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpF,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAuB,cAAcF,EAAUL,EAAI,OAAO,cAAc,CACjG,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQa,GACR,SAAUC,GACV,QAAS,CAACT,EAAUC,IAASC,GAAuB,UAAUF,EAAUC,CAAI,CAC9E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EErHA,OAAyB,UAAAa,OAAc,UCJhC,IAAMC,GAAN,KAAiB,CAmBxB,EAEaC,GAAN,KAAwB,CAa/B,EDpBO,IAAMC,GAAN,cAA4BC,CAAa,CAC9C,eAAeC,EAA0B,CACvC,MAAM,EAwGR,KAAgB,OAAiBC,GAAO,EAvGtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAAyB,CACnD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAkB,UAAUF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,QAAQF,CAAQ,CAC3D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,kBAAkB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,SAASF,EAAUL,EAAI,OAAO,SAAS,CAClF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACxE,IAAMC,EAAW,MAAM,KAAK,aAAyB,CACnD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAkB,UAAUF,EAAUL,EAAI,OAAO,UAAWM,CAAI,CAC/F,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,OAAO,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,UAAUF,EAAUL,EAAI,OAAO,SAAS,CACnF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAkB,SAASF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,eAAe,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,cAAcF,CAAQ,CACjE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQY,GACR,SAAUH,EACV,QAAS,CAACJ,EAAUC,IAASC,GAAkB,aAAaF,EAAUC,CAAI,CAC5E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,0BAA0B,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC/E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAkB,cAAcF,EAAUL,EAAI,OAAO,SAAS,CACvF,CAAC,EAEDC,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQa,GACR,SAAUC,GACV,QAAS,CAACT,EAAUC,IAASC,GAAkB,UAAUF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EHlHO,IAAMa,GAAN,KAAoB,CAGzB,eAAeC,EAAe,CAC5B,KAAK,OAASC,GAAO,EAErB,KAAK,OAAO,IAAI,gBAAiB,IAAIC,GAAmB,GAAGF,CAAM,EAAE,MAAM,EACzE,KAAK,OAAO,IAAI,YAAa,IAAIG,GAAe,GAAGH,CAAM,EAAE,MAAM,EACjE,KAAK,OAAO,IAAI,WAAY,IAAII,GAAc,GAAGJ,CAAM,EAAE,MAAM,EAC/D,KAAK,OAAO,IAAI,UAAW,IAAIK,GAAa,GAAGL,CAAM,EAAE,MAAM,EAC7D,KAAK,OAAO,IAAI,QAAS,IAAIM,GAAW,GAAGN,CAAM,EAAE,MAAM,EACzD,KAAK,OAAO,IAAI,WAAY,IAAIO,GAAc,GAAGP,CAAM,EAAE,MAAM,CACjE,CACF,EKhBA,OAAyB,UAAAQ,OAAc,UAChC,IAAMC,GAAN,cAA2BC,CAAa,CAC7C,eAAeC,EAA0B,CACvC,MAAM,EAqBR,KAAgB,OAAiBH,GAAO,EApBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAa,OAAO,IAAIF,EAAS,aAAcC,CAAI,CAClF,CAAC,EACDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,EAAa,OAAO,IAAIF,EAAS,YAAY,CACtE,CAAC,EACDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAEF,ECzBA,OAAyB,UAAAQ,OAAc,UAEhC,IAAMC,GAAN,cAA6BC,CAAa,CAC/C,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBH,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAa,SAAS,IAAIF,EAAS,aAAcC,CAAI,CACpF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,EAAa,SAAS,IAAIF,EAAS,YAAY,CACxE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EC7BA,OAAyB,UAAAQ,OAAc,UAEhC,IAAMC,GAAN,cAAwBC,CAAa,CAC1C,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBH,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAa,IAAI,IAAIF,EAAS,aAAcC,CAAI,CAC/E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,EAAa,IAAI,IAAIF,EAAS,YAAY,CACnE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EC5BA,OAAyB,UAAAQ,OAAc,UAEhC,IAAMC,GAAN,cAA4BC,CAAa,CAC9C,YACWC,KACNC,EACH,CACA,MAAM,EAHG,mBAAAD,EA2BX,KAAgB,OAAiBH,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGI,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAa,QAAQ,IAAIF,EAAS,aAAcC,CAAI,CACnF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,EAAa,QAAQ,IAAIF,EAAS,YAAY,CACvE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECjCA,OAAyB,UAAAQ,OAAc,UAEhC,IAAMC,GAAN,cAA8BC,CAAa,CAChD,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBH,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAa,UAAU,IAAIF,EAAS,aAAcC,CAAI,CACrF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,EAAa,UAAU,IAAIF,EAAS,YAAY,CACzE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,EC9BA,OAAS,UAAAQ,OAAc,UAEhB,IAAMC,GAAN,KAAkB,CAGvB,YAAYC,KAAuBC,EAAe,CAChD,KAAK,OAASH,GAAO,EAErB,KAAK,OAAO,IAAI,WAAY,IAAII,GAAcF,EAAe,GAAGC,CAAM,EAAE,MAAM,EAC9E,KAAK,OAAO,IAAI,aAAc,IAAIE,GAAgB,GAAGF,CAAM,EAAE,MAAM,EACnE,KAAK,OAAO,IAAI,YAAa,IAAIG,GAAe,GAAGH,CAAM,EAAE,MAAM,EACjE,KAAK,OAAO,IAAI,UAAW,IAAII,GAAa,GAAGJ,CAAM,EAAE,MAAM,EAC7D,KAAK,OAAO,IAAI,OAAQ,IAAIK,GAAU,GAAGL,CAAM,EAAE,MAAM,CACzD,CACF,EClBA,OAAS,UAAAM,OAAc,UAEhB,IAAMC,GAAN,KAAoB,CAGzB,eAAeC,EAAe,CAC5B,KAAK,OAASF,GAAO,EAErB,KAAK,OAAO,IAAI,MAAO,IAAIG,GAAS,GAAGD,CAAM,EAAE,MAAM,CACvD,CACF,ECHA,OAAS,UAAAE,OAAc,UACvB,OAAOC,OAAQ,KACf,OAAOC,OAAe,aACtB,OAAOC,OAAU,OCXV,IAAMC,GAAN,KAAe,CAEtB,EAEaC,GAAN,cAA2BD,EAAS,CAG3C,ECHA,OAAyB,UAAAE,OAAc,UAIhC,IAAMC,GAAN,cAAyBC,CAAa,CAC3C,eAAeC,EAA0B,CACvC,MAAM,EAaR,KAAgB,OAAiBC,GAAO,EAZtC,KAAK,OAAO,KAAK,KAAK,WAAW,OAAO,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CACxE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAe,UAAUF,EAAUC,CAAI,CACtE,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,CACH,CAGF,ECeA,OAAyB,UAAAM,OAAc,UAIhC,IAAMC,GAAN,cAAyBC,CAAa,CAC3C,eAAeC,EAA0B,CACvC,MAAM,EAmOR,KAAgB,OAAiBC,GAAO,EAlOtC,KAAK,OACF,KAAK,KAAK,WAAW,iBAAiB,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,EAAe,eAAeF,EAAUC,CAAI,CAC3E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQQ,GACR,SAAUC,GACV,QAAS,CAACJ,EAAUC,IAASC,EAAe,YAAYF,EAAUC,CAAI,CACxE,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,EAAe,YAAYF,EAAUC,CAAI,CACxE,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,gBAAgB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACtE,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQY,GACR,SAAUC,GACV,QAAS,CAACR,EAAUC,IAASC,EAAe,eAAeF,EAAUC,CAAI,CAC3E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,OAAO,KAAK,WAAW,0BAA0B,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAClF,IAAMC,EAAW,MAAM,KAAK,aAA4B,CACtD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,EAAe,cAAcF,EAAUC,CAAI,CAC1E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,wBAAwB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC9E,IAAMC,EAAW,MAAM,KAAK,aAAwB,CAClD,QAASF,EACT,OAAQgB,GACR,SAAUC,GACV,QAAS,CAACZ,EAAUC,IAASC,EAAe,oBAAoBF,EAAUC,CAAI,CAChF,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,2BAA2B,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjF,IAAMC,EAAW,MAAM,KAAK,aAA2C,CACrE,QAASF,EACT,OAAQ,KACR,SAAUkB,GACV,QAAS,CAACb,EAAUC,IAASC,EAAe,0BAA0BF,EAAUC,CAAI,CACtF,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EAEA,KAAK,KAAK,WAAW,eAAe,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACrE,IAAMC,EAAW,MAAM,KAAK,aAA+B,CACzD,QAASF,EACT,OAAQmB,GACR,SAAUC,GACV,QAAS,CAACf,EAAUC,IAASC,EAAe,cAAcF,EAAUC,CAAI,CAC1E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAAmB,CAC7C,QAASF,EACT,OAAQqB,GACR,SAAUC,GACV,QAAS,CAACjB,EAAUC,IAASC,EAAe,aAAaF,EAAUC,CAAI,CACzE,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQuB,GACR,SAAUC,GACV,QAAS,CAACnB,EAAUC,IAASC,EAAe,UAAUF,EAAUC,CAAI,CACtE,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQyB,GACR,SAAUC,GACV,QAAS,CAACrB,EAAUC,IAASC,EAAe,cAAcF,EAAUC,CAAI,CAC1E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQ2B,GACR,SAAUD,GACV,QAAS,CAACrB,EAAUC,IAASC,EAAe,cAAcF,EAAUC,CAAI,CAC1E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAAmC,CAC7D,QAASF,EACT,OAAQ4B,GACR,SAAUF,GACV,QAAS,CAACrB,EAAUC,IAASC,EAAe,mBAAmBF,EAAUC,CAAI,CAC/E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQyB,GACR,SAAUC,GACV,QAAS,CAACrB,EAAUC,IAASC,EAAe,WAAWF,EAAUC,CAAI,CACvE,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EAEA,KAAK,KAAK,WAAW,sBAAsB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC5E,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQgB,GACR,SAAUa,GACV,QAAS,CAACxB,EAAUC,IAASC,EAAe,qBAAqBF,EAAUC,CAAI,CACjF,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAAwB,CAClD,QAASF,EACT,OAAQ8B,GACR,SAAUb,GACV,QAAS,CAACZ,EAAUC,IAASC,EAAe,aAAaF,EAAUC,CAAI,CACzE,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EAEA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQ+B,GACR,SAAUC,GACV,QAAS,CAAC3B,EAAUC,IAASC,EAAe,kBAAkBF,EAAUC,CAAI,CAC9E,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,qBAAqB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3E,IAAMC,EAAW,MAAM,KAAK,aAA+B,CACzD,QAASF,EACT,OAAQiC,GACR,SAAUC,GACV,QAAS,CAAC7B,EAAUC,IAASC,EAAe,oBAAoBF,EAAUC,CAAI,CAChF,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,sBAAsB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC5E,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQgB,GACR,SAAUa,GACV,QAAS,CAACxB,EAAUC,IAASC,EAAe,qBAAqBF,EAAUC,CAAI,CACjF,CAAC,EAED,OAAOL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,OAAO,KAAK,WAAW,sBAAsB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC9E,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQgB,GACR,SAAUa,GACV,QAAUxB,GAAaE,EAAe,qBAAqBF,CAAQ,CACrE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,IAAI,KAAK,WAAW,sBAAsB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3E,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUmC,EACV,QAAU9B,GAAaE,EAAe,qBAAqBF,CAAQ,CACrE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,uBAAuB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC7E,IAAMC,EAAW,MAAM,KAAK,aAAgC,CAC1D,QAASF,EACT,OAAQoC,GACR,SAAUC,GACV,QAAS,CAAChC,EAAUC,IAASC,EAAe,sBAAsBF,EAAUC,CAAI,CAClF,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,CACL,CAGF,ECjRO,IAAMoC,GAAN,KAAqB,CAK5B,EAEaC,GAAN,KAAsB,CAG7B,EAEaC,GAAN,KAAsB,CAG7B,EAEaC,GAAN,KAA0B,CAGjC,EAEaC,GAAN,KAAe,CAEtB,EAEaC,GAAN,KAAqB,CAE5B,EAEaC,GAAN,KAAkB,CAEzB,EAEaC,GAAN,KAAwB,CAE/B,EAEaC,GAAN,KAAsB,CAI7B,EAEaC,GAAN,cAAwCL,EAAS,CAGxD,EAEaM,GAAN,cAAoCN,EAAS,CAEpD,EAEaO,GAAN,cAAsCP,EAAS,CAEtD,ECzBA,OAAyB,UAAAQ,OAAc,UAIhC,IAAMC,GAAN,cAA0BC,CAAa,CAC5C,eAAeC,EAA0B,CACvC,MAAM,EAoKR,KAAgB,OAAiBC,GAAO,EAnKtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAgB,YAAYF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,oBAAoB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC1E,IAAMC,EAAW,MAAM,KAAK,cAA+B,CACzD,QAASF,EACT,OAAQQ,GACR,SAAUC,GACV,QAAS,CAACJ,EAAUC,IAASC,GAAgB,mBAAmBF,EAAUC,CAAI,CAChF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,oBAAoB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC1E,IAAMC,EAAW,MAAM,KAAK,cAA+B,CACzD,QAASF,EACT,OAAQU,GACR,SAAUC,GACV,QAAS,CAACN,EAAUC,IAASC,GAAgB,mBAAmBF,EAAUC,CAAI,CAChF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,wBAAwB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC9E,IAAMC,EAAW,MAAM,KAAK,cAAmC,CAC7D,QAASF,EACT,OAAQY,GACR,SAAUC,GACV,QAAS,CAACR,EAAUC,IAASC,GAAgB,uBAAuBF,EAAUC,CAAI,CACpF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,gBAAgB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACrE,IAAMC,EAAW,MAAM,KAAK,cAAwB,CAClD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,GAAgB,cAAcF,EAAUC,CAAI,CAC3E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,gBAAgB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACrE,IAAMC,EAAW,MAAM,KAAK,wBAAwC,CAClE,QAASF,EACT,OAAQgB,GACR,SAAUC,GACV,QAAS,CAACZ,EAAUC,IAASC,GAAgB,eAAeF,EAAUC,CAAI,CAC5E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,cAAwB,CAClD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,GAAgB,iBAAiBF,EAAUC,CAAI,CAC9E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,YAAY,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,cAAwB,CAClD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,GAAgB,WAAWF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,YAAY,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,mBAAgC,CAC1D,QAASF,EACT,OAAQkB,GACR,SAAUC,GACV,QAAS,CAACd,EAAUC,IAASC,GAAgB,WAAWF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,IAAI,KAAK,WAAW,kBAAkB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,mBAAsC,CAChE,QAASF,EACT,OAAQoB,GACR,SAAUC,GACV,QAAS,CAAChB,EAAUC,IAASC,GAAgB,iBAAiBF,EAAUC,CAAI,CAC9E,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,YAAY,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAClE,IAAMC,EAAW,MAAM,KAAK,gBAAiC,CAC3D,QAASF,EACT,OAAQsB,GACR,SAAUC,GACV,QAAS,CAAClB,EAAUC,IAASC,GAAgB,WAAWF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,EACA,KAAK,KAAK,WAAW,kBAAkB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACxE,IAAMC,EAAW,MAAM,KAAK,cAAwB,CAClD,QAASF,EACT,OAAQc,GACR,SAAUC,GACV,QAAS,CAACV,EAAUC,IAASC,GAAgB,iBAAiBF,EAAUC,CAAI,CAC9E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACzE,IAAMC,EAAW,MAAM,KAAK,cAAyC,CACnE,QAASF,EACT,OAAQwB,GACR,SAAUC,GACV,QAAS,CAACpB,EAAUC,IAASC,GAAgB,mBAAmBF,EAAUC,CAAI,CAChF,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,eAAe,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACrE,IAAMC,EAAW,MAAM,KAAK,cAAqC,CAC/D,QAASF,EACT,OAAQ0B,GACR,SAAUC,GACV,QAAS,CAACtB,EAAUC,IAASC,GAAgB,eAAeF,EAAUC,CAAI,CAC5E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,iBAAiB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACvE,IAAMC,EAAW,MAAM,KAAK,cAAuC,CACjE,QAASF,EACT,OAAQ4B,GACR,SAAUC,GACV,QAAS,CAACxB,EAAUC,IAASC,GAAgB,gBAAgBF,EAAUC,CAAI,CAC7E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,OAAO,KAAK,WAAW,YAAY,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,cAAwB,CAClD,QAASF,EACT,OAAQ,CAAC,EACT,SAAUe,GACV,QAAS,CAACV,EAAUC,IAASC,GAAgB,WAAWF,EAAUC,CAAI,CACxE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECpMA,OAAyB,UAAA4B,OAAc,UAIhC,IAAMC,GAAN,cAA6BC,CAAa,CAC/C,YACWC,KACNC,EACH,CACA,MAAM,EAHG,mBAAAD,EA0FX,KAAgB,OAAiBE,GAAO,EAtFtC,KAAK,OACF,KAAK,UAAW,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC9C,QAAQ,IAAI,kBAAmBD,EAAI,IAAI,EACvC,IAAME,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,EACR,SAAUC,EACV,QAAUC,GAAaC,GAAmB,eAAeD,CAAQ,CACnE,CAAC,EAED,OAAOJ,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,SAAS,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC/D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,gBAAgBD,CAAQ,CACpE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,IAAI,KAAK,WAAW,SAAS,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,kBAAkBD,CAAQ,CACtE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,IAAI,KAAK,WAAW,iBAAiB,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACtE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,gBAAgBD,CAAQ,CACpE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,IAAI,KAAK,WAAW,iBAAkB,EAAK,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC5E,IAAMM,EAAMP,EAAI,IAAI,QAAQ,EAEtBE,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,eAAeD,EAAUE,CAAG,CACxE,CAAC,EAED,OAAON,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAAmB,CAC7C,QAASF,EACT,OAAQQ,GACR,SAAUC,GACV,QAAS,CAACJ,EAAUK,IAASJ,GAAmB,YAAYD,EAAUK,CAAI,CAC5E,CAAC,EAED,OAAOT,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,OAAO,KAAK,WAAW,QAAQ,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,OAAOD,CAAQ,CAC3D,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,OAAO,KAAK,WAAW,QAAQ,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUI,EACV,QAAUC,GAAaC,GAAmB,eAAeD,CAAQ,CACnE,CAAC,EAED,OAAOJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,CACL,CAGF,ECtGO,IAAMS,GAAN,KAAe,CAKtB,EAEaC,GAAN,KAAqB,CAI5B,ECPA,OAAyB,UAAAC,OAAc,UAIhC,IAAMC,GAAN,cAA0BC,CAAa,CAC5C,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBC,GAAO,EAvBtC,KAAK,OACF,IAAI,KAAK,WAAW,YAAY,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CACjE,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQ,KACR,SAAUG,GACV,QAAUC,GAAaC,GAAgB,YAAYD,CAAQ,CAC7D,CAAC,EAED,OAAOH,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQM,GACR,SAAUC,GACV,QAAS,CAACH,EAAUI,IAASH,GAAgB,YAAYD,EAAUI,CAAI,CACzE,CAAC,EAED,OAAOP,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CAChD,CAAC,CACL,CAGF,ECnCO,IAAMO,GAAN,KAAe,CAOtB,ECFA,OAAyB,UAAAC,OAAc,UAIhC,IAAMC,GAAN,cAA0BC,CAAa,CAC5C,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBC,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAgB,YAAYF,EAAUC,CAAI,CACzE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAgB,UAAUF,CAAQ,CAC3D,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECEO,IAAMQ,GAAN,KAAe,CAQtB,EAEaC,GAAN,cAA0BD,EAAS,CAE1C,EAKO,IAAME,GAAN,cAA4BC,EAAS,CAQ5C,EAEaC,GAAN,cAA0BD,EAAS,CAK1C,EAIaE,GAAN,cAA2BF,EAAS,CAQ3C,EAEaG,GAAN,cAAyBH,EAAS,CAEzC,EAEaI,GAAN,cAA6BJ,EAAS,CAE7C,EAuBO,IAAMK,GAAN,cAA6BC,EAAS,CAM7C,EAEaC,GAAN,cAA8BD,EAAS,CAK9C,EAWO,IAAME,GAAN,cAA0BC,EAAS,CAM1C,EAWO,IAAMC,GAAN,cAA8BC,EAAS,CAK9C,EACaC,GAAN,cAA6BD,EAAS,CAE7C,EAEaE,GAAN,KAAsB,CAG7B,ECvIA,OAAyB,UAAAC,OAAc,UACvC,OAAOC,OAAY,SAInB,IAAMC,GAASC,GAAO,CAAE,QAASA,GAAO,cAAc,CAAE,CAAC,EAE5CC,GAAN,cAA4BC,CAAa,CAC9C,eAAeC,EAA0B,CACvC,MAAM,EAiJR,KAAgB,OAAiBC,GAAO,EAhJtC,KAAK,OACF,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA8B,CACxD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAsB,aAAaF,EAAUC,CAAI,CAChF,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,GACR,SAAUC,GACV,QAAS,CAACJ,EAAUC,IAASC,GAAsB,SAASF,EAAUC,CAAI,CAC5E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,WAAW,EAAG,GAAGJ,EAAQJ,GAAO,OAAO,MAAM,EAAG,MAAOM,EAAKC,IAAQ,CACxF,IAAMS,EAAWV,EAAI,KAEfE,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQW,GACR,SAAUC,GACV,QAAUP,GAAaE,GAAsB,UAAUF,EAAUK,EAAUV,EAAI,IAAW,CAC5F,CAAC,EAED,OAAOC,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,SAAS,EAAG,GAAGJ,EAAQJ,GAAO,OAAO,MAAM,EAAG,MAAOM,EAAKC,IAAQ,CACtF,IAAMS,EAAWV,EAAI,KAEfE,EAAW,MAAM,KAAK,aAAyB,CACnD,QAASF,EACT,OAAQa,GACR,SAAUC,GACV,QAAUT,GAAaE,GAAsB,QAAQF,EAAUK,EAAUV,EAAI,IAAW,CAC1F,CAAC,EAED,OAAOC,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,mBAAmB,EAAG,GAAGJ,EAAQJ,GAAO,OAAO,MAAM,EAAG,MAAOM,EAAKC,IAAQ,CAChG,IAAMS,EAAWV,EAAI,KAEfE,EAAW,MAAM,KAAK,aAA2B,CACrD,QAASF,EACT,OAAQe,GACR,SAAUH,GACV,QAAUP,GAAaE,GAAsB,kBAAkBF,EAAUK,EAAUV,EAAI,IAAW,CACpG,CAAC,EAED,OAAOC,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EAEA,KAAK,KAAK,WAAW,YAAY,EAAG,GAAGJ,EAAQJ,GAAO,OAAO,MAAM,EAAG,MAAOM,EAAKC,IAAQ,CACzF,IAAMS,EAAWV,EAAI,KAEfE,EAAW,MAAM,KAAK,aAA4B,CACtD,QAASF,EACT,OAAQgB,GACR,SAAUC,GACV,QAAUZ,GAAaE,GAAsB,WAAWF,EAAUK,EAAUV,EAAI,IAAW,CAC7F,CAAC,EAED,OAAOC,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQJ,GAAO,OAAO,MAAM,EAAG,MAAOM,EAAKC,IAAQ,CAC1F,IAAMS,EAAWV,EAAI,KAEfE,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQkB,GACR,SAAUC,GACV,QAAUd,GAAaE,GAAsB,YAAYF,EAAUK,EAAUV,EAAI,IAAW,CAC9F,CAAC,EAED,OAAOC,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA8B,CACxD,QAASF,EACT,OAAQoB,GACR,SAAUC,GACV,QAAS,CAAChB,EAAUC,IAASC,GAAsB,aAAaF,EAAUC,CAAI,CAChF,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQsB,GACR,SAAUC,GACV,QAAS,CAAClB,EAAUC,IAASC,GAAsB,YAAYF,EAAUC,CAAI,CAC/E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,cAAc,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACpE,IAAMC,EAAW,MAAM,KAAK,aAA8B,CACxD,QAASF,EACT,OAAQwB,GACR,SAAUC,GACV,QAAS,CAACpB,EAAUC,IAASC,GAAsB,aAAaF,EAAUC,CAAI,CAChF,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ0B,GACR,SAAUC,GACV,QAAS,CAACtB,EAAUC,IAASC,GAAsB,SAASF,EAAUC,CAAI,CAC5E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ4B,GACR,SAAUC,GACV,QAAS,CAACxB,EAAUC,IAASC,GAAsB,SAASF,EAAUC,CAAI,CAC5E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAA6B,CACvD,QAASF,EACT,OAAQ8B,GACR,SAAUC,GACV,QAAS,CAAC1B,EAAUC,IAASC,GAAsB,YAAYF,EAAUC,CAAI,CAC/E,CAAC,EAED,OAAOL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CACrD,CAAC,CACL,CAGF,EC3LO,IAAM8B,GAAN,KAAkB,CASzB,ECJA,OAAyB,UAAAC,OAAc,UAIhC,IAAMC,GAAN,cAA6BC,CAAa,CAC/C,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBC,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,KAAK,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAmB,eAAeF,EAAUC,CAAI,CAC/E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQ,KACR,SAAUQ,EACV,QAAUH,GAAaE,GAAmB,aAAaF,CAAQ,CACjE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECpCO,IAAMO,GAAN,KAAkB,CAOzB,ECDA,OAAyB,UAAAC,OAAc,UAIhC,IAAMC,GAAN,cAA6BC,CAAa,CAC/C,YACWC,KACNC,EACH,CACA,MAAM,EAHG,mBAAAD,EA2BX,KAAgB,OAAiBE,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,QAAQ,EAAG,GAAGD,EAAQ,MAAOE,EAAKC,IAAQ,CAC9D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAmB,eAAeF,EAAUC,CAAI,CAC/E,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,IAAI,KAAK,WAAW,MAAM,EAAG,GAAGJ,EAAQ,MAAOE,EAAKC,IAAQ,CAC3D,IAAMC,EAAW,MAAM,KAAK,aAA0B,CACpD,QAASF,EACT,OAAQQ,EACR,SAAUC,EACV,QAAUJ,GAAaE,GAAmB,aAAaF,CAAQ,CACjE,CAAC,EAEDJ,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF,ECvCA,OAAOQ,IAAW,UAAAC,OAAc,UAChC,OAAOC,OAAU,OAEV,IAAMC,GAAN,cAA0BC,CAAa,CAG5C,aAAc,CACZ,MAAM,EACN,KAAK,OAASH,GAAO,EAErB,IAAMI,EAAWH,GAAK,KAAK,QAAQ,IAAI,EAAG,UAAW,MAAM,EACrDI,EAAYJ,GAAK,KAAKG,EAAU,YAAY,EAElD,KAAK,OAAO,IAAIL,GAAQ,OAAOK,CAAQ,CAAC,EAExC,KAAK,OAAO,IAAI,IAAK,CAACE,EAAKC,IAAQ,CACjCA,EAAI,SAASF,CAAS,CACxB,CAAC,CACH,CACF,EjBcA,IAAMG,GAAiBC,GAAO,EACxBC,GAAeC,EAAc,IAAI,QAAQ,EACzCC,GAAS,CAACC,GAAqBC,GAAqBC,GAAU,MAAS,EAEvEC,GAAY,IAAIC,GAEhBC,GAAc,KAAK,MAAMC,GAAG,aAAa,iBAAkB,MAAM,CAAC,EAEnET,GAAa,iBAAiBF,GAAO,IAAI,WAAY,IAAIY,GAAY,EAAE,MAAM,EAElFZ,GAAO,IAAI,YAAa,CAACa,EAAKC,IAAQ,CACpC,IAAMC,EAAWF,EAAI,OAAO,CAAC,EACvBG,EAAWC,GAAK,KAAK,QAAQ,IAAI,EAAG,UAAW,MAAM,EAErDC,EAAWD,GAAK,KAAKD,EAAU,UAAWD,CAAQ,EAEpDJ,GAAG,WAAWO,CAAQ,GACxBJ,EAAI,IAAI,eAAgBK,GAAU,OAAOD,CAAQ,GAAK,UAAU,EAChEJ,EAAI,KAAKH,GAAG,aAAaO,CAAQ,CAAC,GAElCJ,EAAI,OAAO,GAAG,EAAE,KAAK,gBAAgB,CAEzC,CAAC,EAEDd,GACG,IAAI,CAACa,EAAKC,EAAKM,IAASZ,GAAU,iBAAiBK,EAAKC,EAAKM,CAAI,CAAC,EAElE,IAAI,IAAK,CAACP,EAAKC,IAAQ,CACtBA,EAAI,OAAO,GAAa,EAAE,KAAK,CAC7B,OAAQ,IACR,QAAS,+CACT,QAASJ,GAAY,QACrB,WAAY,QAAQ,IAAI,gCACxB,QAAUR,GAAa,gBAAmE,OAAjD,GAAGW,EAAI,QAAQ,MAAMA,EAAI,IAAI,MAAM,CAAC,WAC7E,cAAe,+BACjB,CAAC,CACH,CAAC,EACA,KAAK,gBAAiBN,GAAU,OAAW,MAAOM,EAAKC,IAC/CA,EAAI,OAAO,GAAa,EAAE,KAAK,CACpC,OAAQ,IACR,QAAS,wBACT,cAAe,QAAQ,IAAI,gBAC3B,iBAAkB,QAAQ,IAAI,mBAC9B,kBAAmB,QAAQ,IAAI,mBACjC,CAAC,CACF,EACA,IAAI,YAAa,IAAIO,GAAelB,EAAe,GAAGC,EAAM,EAAE,MAAM,EACpE,IAAI,WAAY,IAAIkB,GAAc,GAAGlB,EAAM,EAAE,MAAM,EACnD,IAAI,QAAS,IAAImB,GAAW,GAAGnB,EAAM,EAAE,MAAM,EAC7C,IAAI,QAAS,IAAIoB,GAAW,GAAGpB,EAAM,EAAE,MAAM,EAC7C,IAAI,SAAU,IAAIqB,GAAY,GAAGrB,EAAM,EAAE,MAAM,EAC/C,IAAI,YAAa,IAAIsB,GAAevB,EAAe,GAAGC,EAAM,EAAE,MAAM,EACpE,IAAI,YAAa,IAAIuB,GAAe,GAAGvB,EAAM,EAAE,MAAM,EACrD,IAAI,SAAU,IAAIwB,GAAY,GAAGxB,EAAM,EAAE,MAAM,EAC/C,IAAI,SAAU,IAAIyB,GAAY,GAAGzB,EAAM,EAAE,MAAM,EAC/C,IAAI,GAAI,IAAI0B,GAAc3B,EAAe,GAAGC,EAAM,EAAE,MAAM,EAC1D,IAAI,GAAI,IAAI2B,GAAY5B,EAAe,GAAGC,EAAM,EAAE,MAAM,EACxD,IAAI,GAAI,IAAI4B,GAAc,GAAG5B,EAAM,EAAE,MAAM,EAC3C,IAAI,GAAI,IAAI6B,GAAc,GAAG7B,EAAM,EAAE,MAAM,EkB1FvC,IAAM8B,EAAN,KAA0B,CAC/B,eAAeC,EAAoB,CACjC,KAAM,CACJ,WACA,MAAO,cACP,QAASA,EAAY,OAAS,EAAIA,EAAc,MAClD,CACF,CACF,ECRO,IAAMC,GAAN,KAA4B,CACjC,eAAeC,EAAoB,CACjC,KAAM,CACJ,WACA,MAAO,eACP,QAASA,EAAY,OAAS,EAAIA,EAAc,cAClD,CACF,CACF,ECRO,IAAMC,GAAN,KAAyB,CAC9B,eAAeC,EAAoB,CACjC,KAAM,CACJ,WACA,MAAO,YACP,QAASA,EAAY,OAAS,EAAIA,EAAc,MAClD,CACF,CACF,ECRO,IAAMC,EAAN,KAAwB,CAC7B,eAAeC,EAAoB,CACjC,KAAM,CACJ,WACA,MAAO,YACP,QAASA,EAAY,OAAS,EAAIA,EAAc,MAClD,CACF,CACF,ECRO,IAAMC,EAAN,KAAmC,CACxC,eAAeC,EAAoB,CACjC,KAAM,CACJ,WACA,MAAO,wBACP,QAASA,EAAY,OAAS,EAAIA,EAAc,MAClD,CACF,CACF,EpJFA,OAAS,YAAAC,OAAgB,aASzB,IAAMC,GAAS,IAAIC,EAAO,UAAU,EAEdC,EAAf,KAA4B,CACjC,aAAc,CAAC,CACR,WAAWC,EAAcC,EAAQ,GAAM,CAC5C,IAAIC,EAAQ,IAAMF,EAClB,OAAAC,IAASC,GAAS,kBAEXA,CACT,CAEA,MAAa,aAAgBC,EAAuB,CAClD,GAAM,CAAE,QAAAC,EAAS,OAAAC,EAAQ,SAAAC,EAAU,QAAAC,CAAQ,EAAIJ,EAEzCK,EAAM,IAAIF,EACVG,EAAOL,EAAQ,KACfM,EAAWN,EAAQ,OAErBA,GAAS,OAAS,OAAO,KAAKA,EAAQ,KAAK,EAAE,OAAS,GACxD,OAAO,OAAOM,EAAUN,EAAQ,KAAK,EAGnCA,EAAQ,YAAY,SAAS,kBAAkB,GACjD,OAAO,OAAOM,EAAUD,CAAI,EAG9B,OAAO,OAAOD,EAAKC,CAAI,EAEvB,IAAME,EAAIN,EAAST,GAASY,EAAKH,CAAM,EAAI,CAAE,MAAO,GAAM,OAAQ,CAAC,CAAE,EAErE,GAAI,CAACM,EAAE,MAAO,CACZ,IAAMC,EAAiBD,EAAE,OAAO,IAAI,CAAC,CAAE,MAAAE,EAAO,OAAAR,CAAO,IAAM,CACzD,IAAIO,EACJ,OAAIP,EAAO,YACTO,EAAUP,EAAO,YAEjBO,EAAUC,EAAM,QAAQ,YAAa,EAAE,EAElCD,CACT,CAAC,EACD,MAAAf,GAAO,MAAMe,CAAO,EACd,IAAIE,EAAoBF,CAAO,CACvC,CAEA,OAAO,MAAML,EAAQG,EAAUF,CAAG,CACpC,CAEA,MAAa,gBAAmBL,EAAuB,CACrD,GAAM,CAAE,QAAAC,EAAS,SAAAE,EAAU,OAAAD,EAAQ,QAAAE,CAAQ,EAAIJ,EAEzCO,EAAWN,EAAQ,OAEnBI,EAAM,IAAIF,EAEhB,OAAO,OAAOE,EAAKJ,EAAQ,IAAI,EAE/B,IAAMO,EAAIf,GAASY,EAAKH,CAAM,EAE9B,GAAI,CAACM,EAAE,MAAO,CACZ,IAAMC,EAAiBD,EAAE,OAAO,IAAI,CAAC,CAAE,SAAAI,EAAU,MAAAF,EAAO,OAAAR,CAAO,IAAM,CACnE,IAAIO,EACJ,OAAIP,EAAO,YACTO,EAAUP,EAAO,YAEjBO,EAAUC,EAAM,QAAQ,YAAa,EAAE,EAElC,CACL,SAAUE,EAAS,QAAQ,YAAa,EAAE,EAC1C,QAAAH,CACF,CACF,CAAC,EACD,MAAAf,GAAO,MAAM,CAAC,GAAGe,CAAO,CAAC,EACnB,IAAIE,EAAoB,GAAGF,CAAO,CAC1C,CAEA,OAAO,MAAML,EAAQG,EAAUF,CAAG,CACpC,CAEA,MAAa,cAAiBL,EAAuB,CACnD,GAAM,CAAE,QAAAC,EAAS,SAAAE,EAAU,OAAAD,EAAQ,QAAAE,CAAQ,EAAIJ,EAEzCO,EAAWN,EAAQ,OACnBK,EAAOL,EAAQ,KAEjBY,EAAWP,GAAM,SAErB,GAAI,CAACO,EACH,GAAIZ,EAAQ,OAAO,SACjBY,EAAWZ,EAAQ,MAAM,aAEzB,OAAM,IAAIU,EAAoB,iDAAkD,4BAA4B,EAI3GE,EAAS,SAAS,OAAO,IAC5BA,EAAWA,EAAW,SAGxB,OAAO,OAAOP,EAAM,CAClB,SAAUO,CACZ,CAAC,EAED,IAAMR,EAAM,IAAIF,EAEhB,OAAO,OAAOE,EAAKC,CAAI,EAEvB,IAAME,EAAIf,GAASY,EAAKH,CAAM,EAE9B,GAAI,CAACM,EAAE,MAAO,CACZ,IAAMC,EAAiBD,EAAE,OAAO,IAAI,CAAC,CAAE,SAAAI,EAAU,MAAAF,EAAO,OAAAR,CAAO,IAAM,CACnE,IAAIO,EACJ,OAAIP,EAAO,YACTO,EAAUP,EAAO,YAEjBO,EAAUC,EAAM,QAAQ,YAAa,EAAE,EAElC,CACL,SAAUE,EAAS,QAAQ,YAAa,EAAE,EAC1C,QAAAH,CACF,CACF,CAAC,EACD,MAAAf,GAAO,MAAM,CAAC,GAAGe,CAAO,CAAC,EACnB,IAAIE,EAAoB,GAAGF,CAAO,CAC1C,CAEA,OAAO,MAAML,EAAQG,EAAUF,CAAG,CACpC,CAEA,MAAa,mBAAsBL,EAAuB,CACxD,GAAM,CAAE,QAAAC,EAAS,SAAAE,EAAU,OAAAD,EAAQ,QAAAE,CAAQ,EAAIJ,EAEzCc,EAAab,EAAQ,MAE3B,GAAI,CAACa,GAAY,WACf,MAAM,IAAIH,EACR,6DACA,yEACF,EAGF,IAAMJ,EAAWN,EAAQ,OACnBK,EAAOL,EAAQ,KAEfI,EAAM,IAAIF,EAEhB,OAAO,OAAOG,EAAMQ,CAAU,EAC9B,OAAO,OAAOT,EAAKC,CAAI,EAEvB,IAAME,EAAIf,GAASY,EAAKH,CAAM,EAE9B,GAAI,CAACM,EAAE,MAAO,CACZ,IAAMC,EAAiBD,EAAE,OAAO,IAAI,CAAC,CAAE,SAAAI,EAAU,MAAAF,EAAO,OAAAR,CAAO,IAAM,CACnE,IAAIO,EACJ,OAAIP,EAAO,YACTO,EAAUP,EAAO,YAEjBO,EAAUC,EAAM,QAAQ,YAAa,EAAE,EAElC,CACL,SAAUE,EAAS,QAAQ,YAAa,EAAE,EAC1C,QAAAH,CACF,CACF,CAAC,EACD,MAAAf,GAAO,MAAM,CAAC,GAAGe,CAAO,CAAC,EACnB,IAAIE,EAAoB,GAAGF,CAAO,CAC1C,CAEA,OAAO,MAAML,EAAQG,EAAUF,CAAG,CACpC,CAEA,MAAa,wBAA2BL,EAAuB,CAC7D,GAAM,CAAE,QAAAC,EAAS,SAAAE,EAAU,OAAAD,EAAQ,QAAAE,CAAQ,EAAIJ,EAEzCe,EAAkBd,EAAQ,MAEhC,GAAI,CAACc,GAAiB,gBACpB,MAAM,IAAIJ,EAAoB,uDAAuD,EAGvF,IAAMJ,EAAWN,EAAQ,OACnBK,EAAOL,EAAQ,KAEfI,EAAM,IAAIF,EAEhB,OAAO,OAAOG,EAAMS,CAAe,EACnC,OAAO,OAAOV,EAAKC,CAAI,EAEvB,IAAME,EAAIf,GAASY,EAAKH,CAAM,EAE9B,GAAI,CAACM,EAAE,MAAO,CACZ,IAAMC,EAAiBD,EAAE,OAAO,IAAI,CAAC,CAAE,SAAAI,EAAU,MAAAF,EAAO,OAAAR,CAAO,IAAM,CACnE,IAAIO,EACJ,OAAIP,EAAO,YACTO,EAAUP,EAAO,YAEjBO,EAAUC,EAAM,QAAQ,YAAa,EAAE,EAElC,CACL,SAAUE,EAAS,QAAQ,YAAa,EAAE,EAC1C,QAAAH,CACF,CACF,CAAC,EACD,MAAAf,GAAO,MAAM,CAAC,GAAGe,CAAO,CAAC,EACnB,IAAIE,EAAoB,GAAGF,CAAO,CAC1C,CAEA,OAAO,MAAML,EAAQG,EAAUF,CAAG,CACpC,CACF,EqJjOO,IAAMW,GAAN,KAAe,CAKtB,ECFA,IAAMC,GAAa,IAAIC,IAAyC,CAC9D,IAAMC,EAAa,CAAC,EACpB,OAAAD,EAAc,QACXE,GACED,EAAWC,CAAQ,EAAI,CACtB,UAAW,EACX,YAAa,QAAQA,CAAQ,mBAC/B,CACJ,EACO,CACL,GAAI,CACF,cAAe,CACb,KAAM,CAAC,GAAGF,CAAa,CACzB,CACF,EACA,KAAM,CAAE,WAAAC,CAAW,CACrB,CACF,EAEaE,GAAwB,CACnC,IAAKC,EAAG,EACR,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,QAAS,EACrB,KAAM,CAAE,KAAM,QAAS,EACvB,UAAW,CAAE,KAAM,SAAU,CAC/B,EACA,GAAGL,GAAW,KAAM,OAAQ,WAAW,CACzC,EAEaM,GAA2B,CACtC,IAAKD,EAAG,EACR,KAAM,SACN,WAAY,CACV,GAAI,CAAE,KAAM,SAAU,QAAS,OAAQ,UAAW,CAAE,EACpD,OAAQ,CAAE,KAAM,SAAU,QAAS,OAAQ,UAAW,CAAE,CAC1D,EACA,GAAGL,GAAW,IAAI,EAClB,SAAU,CAAC,IAAI,CACjB,ECrCA,OAAyB,UAAAO,OAAc,UAEhC,IAAMC,GAAN,cAAuBC,CAAa,CACzC,eAAeC,EAA0B,CACvC,MAAM,EAwBR,KAAgB,OAAiBH,GAAO,EAvBtC,KAAK,OACF,KAAK,KAAK,WAAW,UAAU,EAAG,GAAGG,EAAQ,MAAOC,EAAKC,IAAQ,CAChE,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQG,GACR,SAAUC,GACV,QAAS,CAACC,EAAUC,IAASC,GAAa,SAASF,EAAUC,CAAI,CACnE,CAAC,EAEDL,EAAI,UAAyB,EAAE,KAAKC,CAAQ,CAC9C,CAAC,EACA,KAAK,KAAK,WAAW,aAAa,EAAG,GAAGH,EAAQ,MAAOC,EAAKC,IAAQ,CACnE,IAAMC,EAAW,MAAM,KAAK,aAAuB,CACjD,QAASF,EACT,OAAQQ,GACR,SAAUJ,GACV,QAAS,CAACC,EAAUC,IAASC,GAAa,YAAYF,EAAUC,CAAI,CACtE,CAAC,EAEDL,EAAI,UAAoB,EAAE,KAAKC,CAAQ,CACzC,CAAC,CACL,CAGF","names":["dayjs","fs","isBooleanString","dotenv","ConfigService","key","configService","packageJson","fs","formatDateLog","timestamp","dayjs","Color","Level","Type","Background","Logger","context","configService","value","type","types","level","typeValue","Color","packageJson","formatDateLog","BufferJSON","NodeCache","_LocalCache","configService","module","Logger","key","value","ttl","appendCriteria","keys","filter","field","data","error","json","hash","LocalCache","BufferJSON","createClient","Redis","Logger","configService","e","redisClient","RedisCache","configService","module","Logger","redisClient","key","error","field","data","BufferJSON","value","ttl","json","appendCriteria","keys","match","logger","Logger","CacheEngine","configService","module","cacheConf","RedisCache","LocalCache","EventEmitter2","maxListeners","eventEmitter","CallController","waMonitor","instanceName","data","ChatController","waMonitor","instanceName","data","query","GroupController","waMonitor","instance","create","update","groupJid","getPaticipants","inviteCode","data","TypeMediaMessage","MessageSubtype","Integration","delay","isArray","isURL","crypto","rnds8Pool","poolPtr","rng","byteToHex","i","unsafeStringify","arr","offset","crypto","native_default","v4","options","buf","offset","native_default","rnds","rng","i","unsafeStringify","v4_default","InstanceController","waMonitor","configService","prismaRepository","eventEmitter","chatwootService","settingsService","proxyService","cache","chatwootCache","baileysCache","providerFiles","Logger","instanceData","instance","channelController","BadRequestException","instanceId","v4_default","hash","eventManager","settings","webhookWaBusiness","accessTokenWaBusiness","Integration","getQrcode","delay","isURL","urlServer","error","isArray","instanceName","number","state","key","instancesByKey","names","UnauthorizedException","instanceNames","data","InternalServerErrorException","waInstances","LabelController","waMonitor","instanceName","data","HttpsProxyAgent","makeProxyAgent","proxy","host","password","port","protocol","username","proxyUrl","axios","logger","Logger","ProxyController","proxyService","waMonitor","instance","data","NotFoundException","BadRequestException","proxy","serverIp","makeProxyAgent","error","isBase64","isURL","SendMessageController","waMonitor","instanceName","data","file","BadRequestException","SettingsController","settingsService","instance","data","TemplateController","templateService","instance","data","MinIo","join","logger","Logger","BUCKET","ConfigService","minioClient","bucketName","bucketExists","bucket","setBucketPolicy","policy","createBucket","error","uploadFile","fileName","file","size","metadata","objectName","getObjectUrl","expiry","BadRequestException","postgresql","Pool","Postgres","Logger","connectionString","uri","configService","postgresClient","ChatwootImport","Logger","instance","repositoryMessagesCache","messagesRaw","actualValue","contactsRaw","provider","pgClient","postgresClient","totalContactsImported","contacts","contactsChunk","labelSql","labelId","sqlLabel","sqlInsert","bindInsert","contact","bindName","bindPhoneNumber","bindIdentifier","sqlTags","tagId","sqlTag","sqlInsertLabel","bindTaggableId","error","sourceIds","existingSourceIdsSet","formattedSourceIds","sourceId","result","row","chatwootService","inbox","chatwootUser","totalMessagesImported","messagesOrdered","a","b","aKey","bKey","aMessageTimestamp","bMessageTimestamp","allMessagesMappedByPhoneNumber","phoneNumbersWithTimestamp","messages","phoneNumber","existingSourceIds","message","batchSize","messagesChunk","messagesByPhoneNumber","fksByNumber","sqlInsertMsg","bindInsertMsg","fksChatwoot","contentMessage","bindContent","bindConversationId","bindMessageType","bindSenderType","bindSenderId","bindSourceId","bindmessageTimestamp","providerData","event","bindValues","sqlFromChatwoot","phoneNumberTimestamp","bindStr","fksFromChatwoot","item","acc","key","phoneNumberPlus","limit","msg","configService","types","arr","chunkSize","remoteJid","messageId","chatwootImport","ChatwootClient","chatwootRequest","fs","i18next","path","languages","translationsPath","path","configService","ConfigService","resources","language","languagePath","fs","__require","i18next","i18n_default","axios","fs","packageJson","sendTelemetry","route","telemetry","url","axios","dayjs","FormData","Jimp","Long","mimeTypes","path","Readable","ChatwootService","waMonitor","configService","prismaRepository","cache","Logger","postgresClient","instance","cacheKey","provider","ChatwootClient","data","urlServer","id","client","contact","inboxName","webhookUrl","qrcode","number","organization","logo","findInbox","checkDuplicate","inbox","inboxId","contactId","conversation","contentMsg","phoneNumber","isGroup","name","avatar_url","jid","nameInbox","tagData","tagId","taggingsCount","query","chatwootRequest","contacts","phoneNumbers","searchableFields","phone","savedNumber","contact_with9","field","numbers","withoutNine","withNine","filterPayload","fieldsToSearch","index1","index2","queryOperator","body","conversationId","conversationExists","error","chatId","nameContact","filterInbox","group","picture_url","findParticipant","waProfilePictureFile","chatwootProfilePictureFile","pictureNeedsUpdate","nameNeedsUpdate","v","contactConversations","findByName","content","messageType","privateMessage","attachments","messageBody","sourceId","quotedMsg","replyToIds","sourceReplyId","message","fileStream","fileName","messageAlreadySaved","chatwootImport","config","waInstance","media","caption","options","parsedMedia","mimeType","parts","type","sendTelemetry","i18n_default","resolve","keyToDelete","messageReceived","senderName","key","cwBotContact","command","state","msgLogout","formatText","formattedDelimiter","textToConcat","attachment","messageSent","lastMessage","updateMessage","chatwootMessageIds","keyId","msg","inReplyTo","inReplyToExternalId","types","typeKey","result","latitude","longitude","locationName","locationAddress","vCardData","contactInfo","line","value","formattedContact","numberCount","listTitle","listDescription","listFooter","formattedList","section","sectionIndex","row","rowIndex","responseTitle","responseDescription","responseRowId","event","ignoreJids","ignoreGroups","ignoreContacts","originalMessage","bodyMessage","quotedId","isMedia","adsMessage","reactionMessage","getConversation","downloadBase64","nameFile","originalFilename","parsedFile","fileData","participantName","rawPhoneNumber","phoneMatch","formattedPhoneNumber","send","imgBuffer","extension","img","processedBuffer","truncStr","str","len","title","description","editedText","contactInboxSourceId","url","msgStatus","msgConnection","erroQRcode","msgQrCode","remoteJid","uri","messagesRaw","contactsRaw","totalMessagesImported","limitContacts","recentContacts","contactIdentifiers","identifier","contactsWithProfilePicture","acc","chatwootConfig","prepareMessage","sqlMessages","ids","filteredMessages","m","axios","DifyService","waMonitor","configService","prismaRepository","Logger","instance","data","error","content","str","session","settings","dify","remoteJid","pushName","endpoint","payload","contentSplit","Integration","response","message","conversationId","answer","events","line","eventString","event","linkRegex","textBuffer","lastIndex","match","getMediaType","url","extension","imageExtensions","audioExtensions","videoExtensions","documentExtensions","fullMatch","exclMark","altText","mediaType","beforeText","splitMessages","timePerChar","minDelay","maxDelay","multipleMessages","index","delay","resolve","remainingText","sendTelemetry","now","sessionUpdatedAt","diff","axios","downloadMediaMessage","FormData","OpenAI","P","OpenaiService","waMonitor","configService","prismaRepository","Logger","instance","openaiBot","remoteJid","content","messagesSystem","message","messagesAssistant","messagesUser","messageData","contentSplit","url","messages","Integration","completions","pushName","fromMe","threadId","sendTelemetry","runAssistant","response","session","settings","linkRegex","textBuffer","lastIndex","match","getMediaType","extension","imageExtensions","audioExtensions","videoExtensions","documentExtensions","fullMatch","exclMark","altText","mediaType","beforeText","splitMessages","timePerChar","minDelay","maxDelay","multipleMessages","index","delay","resolve","remainingText","data","creds","error","str","runId","functionUrl","getRun","toolCalls","toolCall","id","functionName","functionArgument","output","now","sessionUpdatedAt","diff","msg","updateMediaMessage","audio","lang","formData","getTypeMessage","msg","mediaId","configService","types","messageType","key","getMessageContent","typeKey","result","getConversationMessage","axios","TypebotService","waMonitor","configService","prismaRepository","Logger","instance","data","id","version","url","reqData","request","session","error","settings","remoteJid","messages","input","clientSideActions","processMessages","applyFormatting","err","findItemAndGetSecondsToWait","array","targetId","item","element","text","child","line","index","formats","formattedText","message","richText","listJson","titleMatch","descriptionMatch","buttonTextMatch","footerTextMatch","menuContent","sections","section","sectionTitle","rows","sectionData","row","buttonJson","thumbnailUrlMatch","footerMatch","buttonTypes","type","pattern","match","content","button","sendTelemetry","wait","resolve","items","msg","findTypebot","expire","typebot","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","prefilledVariables","now","sessionUpdatedAt","diff","getConversationMessage","urlTypebot","Prisma","formatMXOrARNumber","jid","countryCode","formatBRNumber","regexp","match","joker","ddd","createJid","number","isArray","ChannelStartupService","_ChannelStartupService","configService","eventEmitter","prismaRepository","chatwootCache","Logger","ChatwootService","waMonitor","TypebotService","OpenaiService","DifyService","instance","name","v4_default","id","integration","number","token","data","ignoreJidsArray","event","NotFoundException","local","serverUrl","tzoffset","now","expose","instanceApikey","eventManager","jid","countryCode","regexp","match","joker","ddd","query","remoteJid","createJid","where","message","cleanedMessage","mediaUrl","keyFilters","timestampFilter","count","messages","Prisma","results","isArray","contact","lastMessage","axios","isBase64","isURL","FormData","mimeTypes","join","EvolutionStartupService","ChannelStartupService","configService","eventEmitter","prismaRepository","cache","chatwootCache","instance","number","createJid","data","error","InternalServerErrorException","received","messageRaw","v4_default","isAudio","openAiDefaultSettings","chatbotController","chatwootSentMessage","contactRaw","chat","chatRaw","message","options","file","isIntegration","quoted","webhookUrl","msg","resolve","audioFile","messageId","isBase64","isURL","key","findMessage","base64","fileBuffer","buffer","mediaType","mimetype","fileName","size","fullName","join","uploadFile","mediaUrl","getObjectUrl","BadRequestException","mediaMessage","arrayMatch","prepareMedia","mimeTypes","mediaData","audio","hash","formData","FormData","response","axios","status","axios","arrayUnique","isURL","FormData","createReadStream","mimeTypes","join","BusinessStartupService","ChannelStartupService","configService","eventEmitter","prismaRepository","cache","chatwootCache","baileysCache","providerFiles","message","params","urlServer","version","headers","e","number","createJid","data","content","error","InternalServerErrorException","id","result","received","vcard","contact","type","messageType","database","settings","messageRaw","pushName","key","buffer","mediaType","mimetype","contentDisposition","fileName","match","size","fullName","uploadFile","createdMessage","mediaUrl","getObjectUrl","openAiDefaultSettings","audioMessage","chatbotController","chatwootSentMessage","contactRaw","item","findMessage","convertMessage","options","isIntegration","quoted","webhookUrl","linkPreview","msg","messageSent","isImage","formattedText","section","row","status","BadRequestException","mediaMessage","formData","fileStream","arrayMatch","prepareMedia","file","mediaData","audio","hash","embeddedMedia","btnItems","btn","button","sectionsItems","list","sendData","OnWhatsAppDto","jid","exists","number","name","getBase64FromMediaMessageDto","WhatsAppNumberDto","NumberDto","ProfileNameDto","ProfileStatusDto","ProfilePictureDto","ReadMessageDto","ArchiveChatDto","MarkChatUnreadDto","PrivacySettingDto","DeleteMessage","OptionsMessage","Metadata","SendPresenceDto","UpdateMessageDto","BlockUserDto","BufferJSON","CacheService","cache","Logger","key","field","data","error","value","ttl","json","appendCriteria","ffmpegPath","cuid","dayjs","getAvailableNumbers","remoteJid","numbersAvailable","number","domain","numberWithDigit","numberWithoutDigit","prefix","saveOnWhatsappCache","data","configService","upsertsQuery","item","prismaRepository","getOnWhatsappCache","remoteJids","results","remoteJidsWithoutPlus","join","ROOT_DIR","INSTANCE_DIR","SRC_DIR","AUTH_DIR","STORE_DIR","BufferJSON","initAuthCreds","proto","fs","path","fixFileName","file","keyExists","sessionId","prismaRepository","saveKey","keyJson","exists","getAuthKey","auth","deleteAuthKey","fileExists","useMultiFileAuthStatePrisma","cache","localFolder","INSTANCE_DIR","localFile","key","writeData","data","dataString","readData","rawData","removeData","creds","type","ids","id","value","tasks","category","BufferJSON","initAuthCreds","proto","isNotEmpty","AuthStateProvider","providerFiles","Logger","instance","error","writeData","data","key","json","response","readData","removeData","creds","type","ids","id","value","tasks","category","initAuthCreds","proto","useMultiFileAuthStateRedisDb","instanceName","cache","logger","Logger","writeData","data","key","error","readData","removeData","creds","type","ids","id","value","tasks","category","axios","makeWASocket","BufferJSON","delay","DisconnectReason","downloadMediaMessage","fetchLatestBaileysVersion","generateWAMessageFromContent","getAggregateVotesInPollMessage","getContentType","getDevice","isJidBroadcast","isJidGroup","isJidNewsletter","isJidUser","makeCacheableSignalKeyStore","prepareWAMessageMedia","proto","spawn","isArray","isBase64","isURL","randomBytes","ffmpeg","FormData","readFileSync","Long","mimeTypes","NodeCache","cron","release","join","P","qrcode","qrcodeTerminal","sharp","PassThrough","Readable","io","baileys_connection_state","useVoiceCallsBaileys","wavoip_token","baileys_sock","status","logger","socket","error","jid","callback","response","type","timeoutMs","jids","force","message","extraAttrs","useCache","ignoreZeroDevices","stanza","ciphertext","update","connection","packet","groupMetadataCache","CacheService","CacheEngine","configService","getVideoDuration","input","MediaInfoFactory","mediainfo","fileSize","readChunk","size","offset","fs","fd","buffer","result","duration","t","Readable","chunks","chunk","data","BaileysStartupService","ChannelStartupService","eventEmitter","prismaRepository","cache","chatwootCache","baileysCache","providerFiles","NodeCache","chats","existingChatIds","existingChatIdSet","chat","chatsToInsert","chatsRaw","contacts","contactsRaw","contact","usersContacts","c","saveOnWhatsappCache","chatwootImport","updatedContacts","update","instance","findParticipant","error","updateTransactions","messages","isLatest","progress","syncType","proto","timestampLimitToImport","daysLimitToImport","date","message","chatsRepository","messagesRaw","messagesRepository","Long","msg","type","requestId","settings","received","text","messageId","editedMessage","existingChat","messageRaw","isMedia","chatwootSentMessage","openAiDefaultSettings","status","media","mediaType","fileName","mimetype","mimeTypes","fullName","join","uploadFile","mediaUrl","getObjectUrl","downloadMediaMessage","P","chatbotController","contactRaw","args","readChatToUpdate","key","pollUpdates","pollCreation","getAggregateVotesInPollMessage","findMessage","chatToInsert","remoteJid","groupMetadata","groupMetadataUpdate","group","isJidGroup","participantsUpdate","label","savedLabel","l","labelName","labelData","database","instanceId","chatId","labelId","groupJid","cacheConf","meta","AuthStateProvider","profileName","creds","BufferJSON","qr","connection","lastDisconnect","DisconnectReason","optsQrcode","delay","qrcode","base64","qrcodeTerminal","statusCode","profilePic","formattedWuid","formattedName","full","webMessageInfo","messageSecretBase64","db","useMultiFileAuthStateRedisDb","useMultiFileAuthStatePrisma","number","session","browserOptions","browser","release","version","log","fetchLatestBaileysVersion","options","proxyUrls","axios","rand","proxyUrl","makeProxyAgent","socketConfig","makeCacheableSignalKeyStore","jid","isGroupJid","isBroadcast","isJidBroadcast","isNewsletter","isJidNewsletter","makeWASocket","useVoiceCallsBaileys","packet","payload","InternalServerErrorException","events","call","remotesJidMap","event","createJid","profilePictureUrl","instanceName","onWhatsapp","BadRequestException","info","picture","business","instanceNames","waMonitor","isVideo","callDuration","sender","mentions","linkPreview","quoted","ephemeralExpiration","option","randomBytes","m","generateWAMessageFromContent","id","isJidUser","value","isArray","jidList","batchSize","batches","_","i","msgId","firstMessage","firstBatch","batch","isIntegration","isWA","remainingDelay","messageSent","NotFoundException","participant","mention","convert","file","mediaData","mediaMessage","prepareMedia","prepareWAMessageMedia","isURL","arrayMatch","config","mediaInput","mediaBuffer","readFileSync","image","imageBuffer","isBase64","base64Data","timestamp","url","response","sharp","gifPlayback","generate","audio","inputStream","audioBuffer","PassThrough","resolve","reject","ffmpegProcess","spawn","ffmpegPath","outputChunks","stderrData","code","outputBuffer","err","formData","FormData","inputAudioStream","outputAudioStream","ffmpeg","length","characters","button","toString","obj","hasReplyButtons","btn","hasPixButton","hasOtherButtons","v4_default","buttons","vcard","jids","OnWhatsAppDto","groups","numbersToVerify","cachedNumbers","getOnWhatsappCache","filteredNumbers","cached","verify","users","user","numberVerified","numberWithDigit","numberWithoutDigit","v","prefix","numberJid","keys","read","where","lastMessage","last_message","del","isLogicalDeleted","existingKey","getBuffer","convertToMp4","subtype","MessageSubtype","TypeMediaMessage","typeMessage","getContentType","ext","privacy","profile","name","pic","whatsappContact","create","participants","reply","getParticipants","fetch","inviteUrl","numbers","p","parsedParticipants","contentType","contentMsg","getDevice","quotedMessage","chatwootConfig","prepare","cron","unreadMessages","cuid","timeoutMs","force","extraAttrs","node","stanza","useCache","ignoreZeroDevices","ciphertext","ciphertextBuffer","ChannelController","prismaRepository","waMonitor","prisma","instanceData","data","Integration","BadRequestException","BusinessStartupService","EvolutionStartupService","BaileysStartupService","EvolutionController","ChannelController","prismaRepository","waMonitor","Logger","data","numberId","instance","axios","MetaController","ChannelController","prismaRepository","waMonitor","Logger","data","template","webhookUrl","axios","entry","numberId","instance","BaileysController","waMonitor","instanceName","body","normalizeString","str","advancedOperatorsSearch","data","query","filters","acc","filter","operator","values","value","normalizedItem","val","subVal","normalizedSubVal","findBotByTrigger","botRepository","content","instanceId","findTriggerAll","findTriggerAdvanced","advanced","advancedOperatorsSearch","findTriggerEquals","findRegex","findTriggerRegex","regex","findStartsWith","findTriggerStartsWith","startsWith","findEndsWith","findTriggerEndsWith","endsWith","findContains","findTriggerContains","contains","ChatbotController","prismaRepository","waMonitor","Logger","prisma","instance","remoteJid","msg","pushName","isIntegration","emitData","evolutionBotController","typebotController","openaiController","difyController","flowiseController","userMessageDebounce","content","debounceTime","callback","myQuestion","ignoreJids","ignoreGroups","ignoreContacts","session","botRepository","findBot","findBotByTrigger","isURL","ChatwootController","chatwootService","configService","prismaRepository","instance","data","BadRequestException","result","urlServer","chatwootCache","CacheService","CacheEngine","ChatwootService","waMonitor","DifyController","ChatbotController","difyService","prismaRepository","waMonitor","Logger","configService","instance","data","BadRequestException","instanceId","defaultSettingCheck","error","bots","botId","bot","settings","updateSettings","newSetttings","remoteJid","status","session","ignoreJids","jid","msg","content","getConversationMessage","findBot","fallback","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","splitMessages","timePerChar","key","debouncedContent","EvolutionBotController","ChatbotController","evolutionBotService","prismaRepository","waMonitor","Logger","instance","data","instanceId","defaultSettingCheck","error","bots","botId","bot","settings","updateSettings","newSetttings","remoteJid","status","session","ignoreJids","jid","msg","content","getConversationMessage","findBot","fallback","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","splitMessages","timePerChar","key","debouncedContent","axios","EvolutionBotService","waMonitor","configService","prismaRepository","Logger","instance","data","error","content","session","bot","remoteJid","pushName","payload","contentSplit","Integration","headers","response","settings","message","linkRegex","textBuffer","lastIndex","match","getMediaType","url","extension","imageExtensions","audioExtensions","videoExtensions","documentExtensions","fullMatch","exclMark","altText","mediaType","beforeText","splitMessages","timePerChar","minDelay","maxDelay","multipleMessages","index","delay","resolve","remainingText","sendTelemetry","now","sessionUpdatedAt","diff","FlowiseController","ChatbotController","flowiseService","prismaRepository","waMonitor","Logger","instance","data","instanceId","defaultSettingCheck","error","bots","botId","bot","settings","updateSettings","newSetttings","remoteJid","status","session","ignoreJids","jid","msg","content","getConversationMessage","findBot","fallback","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","splitMessages","timePerChar","key","debouncedContent","axios","FlowiseService","waMonitor","configService","prismaRepository","Logger","instance","data","error","content","bot","remoteJid","pushName","payload","contentSplit","Integration","headers","endpoint","response","session","settings","message","linkRegex","textBuffer","lastIndex","match","getMediaType","url","extension","imageExtensions","audioExtensions","videoExtensions","documentExtensions","fullMatch","exclMark","altText","mediaType","beforeText","splitMessages","timePerChar","minDelay","maxDelay","multipleMessages","index","delay","resolve","remainingText","sendTelemetry","now","sessionUpdatedAt","diff","OpenAI","OpenaiController","ChatbotController","openaiService","prismaRepository","waMonitor","Logger","configService","instance","data","BadRequestException","instanceId","error","openaiCredsId","creds","defaultSettings","apiKey","OpenAI","defaultSettingCheck","whereDuplication","bots","botId","bot","settings","updateSettings","newSetttings","remoteJid","status","session","openaiBot","ignoreJids","jid","msg","pushName","content","getConversationMessage","findBot","fallback","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","splitMessages","timePerChar","key","debouncedContent","axios","TypebotController","ChatbotController","typebotService","prismaRepository","waMonitor","Logger","configService","instance","data","BadRequestException","instanceId","defaultSettingCheck","error","bots","botId","bot","typebot","settings","updateSettings","newSetttings","instanceData","remoteJid","url","startSession","variables","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids","prefilledVariables","variable","findBot","id","version","reqData","request","axios","status","session","typebotData","jid","msg","content","getConversationMessage","fallback","key","debouncedContent","Pusher","_EventController","prismaRepository","waMonitor","integrationStatus","integrationName","prisma","name","status","instanceName","data","EventController","PusherController","EventController","prismaRepository","waMonitor","configService","Logger","APP_ID","KEY","SECRET","CLUSTER","USE_TLS","Pusher","instance","instanceName","data","origin","event","serverUrl","dateTime","sender","apiKey","local","integration","we","enabledLog","eventName","pusherData","payload","payloadSize","pusherLocalEvents","pusher","error","amqp","RabbitmqController","EventController","prismaRepository","waMonitor","configService","Logger","resolve","reject","uri","rabbitmqExchangeName","error","connection","channelError","channel","exchangeName","instanceName","origin","event","data","serverUrl","dateTime","sender","apiKey","integration","instanceRabbitmq","rabbitmqLocal","rabbitmqGlobal","rabbitmqEvents","prefixKey","we","logEnabled","message","retry","eventName","queueName","logData","events","SQS","SqsController","EventController","prismaRepository","waMonitor","configService","Logger","resolve","awsConfig","SQS","sqs","instanceName","origin","event","data","serverUrl","dateTime","sender","apiKey","integration","instanceSqs","sqsLocal","we","eventFormatted","queueName","sqsConfig","sqsUrl","message","params","err","logData","events","eventsArray","queueUrl","deleteErr","axios","isURL","WebhookController","EventController","prismaRepository","waMonitor","Logger","instanceName","data","isURL","BadRequestException","origin","event","serverUrl","dateTime","sender","apiKey","local","integration","instance","webhookConfig","configService","webhookLocal","webhookHeaders","we","transformedWe","enabledLog","webhookData","baseURL","logData","httpService","axios","error","globalURL","maxRetries","delaySeconds","attempts","resolve","SocketIO","WebsocketController","EventController","prismaRepository","waMonitor","configService","Logger","httpServer","SocketIO","socket","data","error","cors","instanceName","origin","event","serverUrl","dateTime","sender","apiKey","integration","configEv","logEnabled","message","instance","err","EventManager","prismaRepository","waMonitor","WebsocketController","WebhookController","RabbitmqController","SqsController","PusherController","prisma","websocket","webhook","rabbitmq","sqs","pusher","httpServer","eventData","instanceName","data","S3Controller","s3Service","instance","data","S3Service","prismaRepository","Logger","instance","query","where","media","error","BadRequestException","data","getObjectUrl","axios","execSync","ProviderFiles","configService","Logger","url","error","pid","instance","response","key","data","PrismaClient","Query","PrismaRepository","configService","Logger","execSync","rmSync","join","WAMonitoringService","eventEmitter","configService","prismaRepository","providerFiles","cache","chatwootCache","baileysCache","Logger","instance","time","Integration","instanceNames","inexistentInstances","NotFoundException","clientName","where","instanceId","number","instanceName","r","instanceDbId","INSTANCE_DIR","STORE_DIR","error","data","instanceData","channelController","keys","k","instances","ProxyService","waMonitor","Logger","instance","data","result","SettingsService","waMonitor","Logger","instance","data","result","axios","TemplateService","waMonitor","prismaRepository","configService","Logger","instance","getInstance","response","data","postData","error","method","urlServer","version","headers","e","logger","Logger","chatwootCache","configService","CacheService","CacheEngine","ChatwootService","cache","baileysCache","providerFiles","ProviderFiles","prismaRepository","PrismaRepository","waMonitor","WAMonitoringService","eventEmitter","s3Service","S3Service","s3Controller","S3Controller","templateService","TemplateService","templateController","TemplateController","proxyService","ProxyService","proxyController","ProxyController","chatwootService","chatwootController","ChatwootController","settingsService","SettingsService","settingsController","SettingsController","instanceController","InstanceController","sendMessageController","SendMessageController","callController","CallController","chatController","ChatController","groupController","GroupController","labelController","LabelController","eventManager","EventManager","chatbotController","ChatbotController","channelController","ChannelController","evolutionController","EvolutionController","metaController","MetaController","baileysController","BaileysController","typebotService","TypebotService","typebotController","TypebotController","openaiService","OpenaiService","openaiController","OpenaiController","difyService","DifyService","difyController","DifyController","evolutionBotService","EvolutionBotService","evolutionBotController","EvolutionBotController","flowiseService","FlowiseService","flowiseController","FlowiseController","logger","Logger","apikey","req","_","next","env","configService","key","db","UnauthorizedException","ForbiddenException","param","prismaRepository","error","authGuard","getInstance","instanceName","cacheConf","configService","exists","waMonitor","keyExists","cache","prismaRepository","error","InternalServerErrorException","instanceExistsGuard","req","_","next","param","BadRequestException","NotFoundException","instanceLoggedGuard","instance","ForbiddenException","Telemetry","req","res","next","sendTelemetry","telemetry_guard_default","Router","Router","EvolutionRouter","RouterBroker","configService","req","res","body","response","evolutionController","Router","MetaRouter","RouterBroker","configService","req","res","body","response","metaController","ChatwootDto","ChatwootInstanceMixin","Base","EventDto","EventInstanceMixin","Base","IntegrationDto","EventInstanceMixin","ChatwootInstanceMixin","InstanceDto","IntegrationDto","SetPresenceDto","isNotEmpty","propertyNames","properties","property","instanceSchema","v4_default","Integration","presenceOnlySchema","Router","BaileysRouter","RouterBroker","guards","req","res","response","instanceSchema","InstanceDto","instance","baileysController","ChannelRouter","configService","guards","Router","EvolutionRouter","MetaRouter","BaileysRouter","isNotEmpty","propertyNames","properties","property","numberDefinition","whatsappNumberSchema","v4_default","readMessageSchema","archiveChatSchema","markChatUnreadSchema","deleteMessageSchema","profilePictureSchema","updateMessageSchema","presenceSchema","blockUserSchema","contactValidateSchema","messageValidateSchema","messageUpSchema","privacySettingsSchema","profileNameSchema","profileStatusSchema","profileSchema","isNotEmpty","propertyNames","properties","property","createGroupSchema","v4_default","groupJidSchema","getParticipantsSchema","groupSendInviteSchema","groupInviteSchema","AcceptGroupInviteSchema","updateParticipantsSchema","updateSettingsSchema","toggleEphemeralSchema","updateGroupPictureSchema","updateGroupSubjectSchema","updateGroupDescriptionSchema","isNotEmpty","propertyNames","properties","property","numberDefinition","handleLabelSchema","v4_default","isNotEmpty","propertyNames","properties","property","numberDefinition","templateMessageSchema","v4_default","quotedOptionsSchema","offerCallSchema","textMessageSchema","mediaMessageSchema","ptvMessageSchema","audioMessageSchema","statusMessageSchema","stickerMessageSchema","locationMessageSchema","contactMessageSchema","reactionMessageSchema","pollMessageSchema","listMessageSchema","buttonsMessageSchema","isNotEmpty","propertyNames","properties","property","proxySchema","v4_default","isNotEmpty","propertyNames","properties","property","settingsSchema","v4_default","isNotEmpty","propertyNames","properties","property","templateSchema","v4_default","isNotEmpty","propertyNames","properties","property","chatwootSchema","v4_default","isNotEmpty","propertyNames","properties","property","difySchema","v4_default","difyStatusSchema","difySettingSchema","difyIgnoreJidSchema","isNotEmpty","propertyNames","properties","property","evolutionBotSchema","v4_default","evolutionBotStatusSchema","evolutionBotSettingSchema","evolutionBotIgnoreJidSchema","isNotEmpty","propertyNames","properties","property","flowiseSchema","v4_default","flowiseStatusSchema","flowiseSettingSchema","flowiseIgnoreJidSchema","isNotEmpty","propertyNames","properties","property","openaiSchema","v4_default","openaiCredsSchema","openaiStatusSchema","openaiSettingSchema","openaiIgnoreJidSchema","isNotEmpty","propertyNames","properties","property","typebotSchema","v4_default","typebotStatusSchema","typebotStartSchema","typebotSettingSchema","typebotIgnoreJidSchema","isNotEmpty","propertyNames","properties","property","pusherSchema","v4_default","EventController","isNotEmpty","propertyNames","properties","property","webhookSchema","v4_default","EventController","eventSchema","v4_default","EventController","Router","ChatwootRouter","RouterBroker","guards","req","res","response","chatwootSchema","ChatwootDto","instance","data","chatwootController","instanceSchema","InstanceDto","IgnoreJidDto","DifyDto","DifySettingDto","Router","DifyRouter","RouterBroker","guards","req","res","response","difySchema","DifyDto","instance","data","difyController","instanceSchema","InstanceDto","difySettingSchema","DifySettingDto","difyStatusSchema","difyIgnoreJidSchema","IgnoreJidDto","OpenaiCredsDto","OpenaiDto","OpenaiSettingDto","Router","OpenaiRouter","RouterBroker","guards","req","res","response","openaiCredsSchema","OpenaiCredsDto","instance","data","openaiController","instanceSchema","InstanceDto","openaiSchema","OpenaiDto","openaiSettingSchema","OpenaiSettingDto","openaiStatusSchema","openaiIgnoreJidSchema","IgnoreJidDto","TypebotDto","TypebotSettingDto","Router","TypebotRouter","RouterBroker","guards","req","res","response","typebotSchema","TypebotDto","instance","data","typebotController","instanceSchema","InstanceDto","typebotSettingSchema","TypebotSettingDto","typebotStartSchema","typebotStatusSchema","typebotIgnoreJidSchema","IgnoreJidDto","Router","Router","EvolutionBotDto","EvolutionBotSettingDto","EvolutionBotRouter","RouterBroker","guards","Router","req","res","response","evolutionBotSchema","EvolutionBotDto","instance","data","evolutionBotController","instanceSchema","InstanceDto","evolutionBotSettingSchema","EvolutionBotSettingDto","evolutionBotStatusSchema","evolutionBotIgnoreJidSchema","IgnoreJidDto","Router","FlowiseDto","FlowiseSettingDto","FlowiseRouter","RouterBroker","guards","Router","req","res","response","flowiseSchema","FlowiseDto","instance","data","flowiseController","instanceSchema","InstanceDto","flowiseSettingSchema","FlowiseSettingDto","flowiseStatusSchema","flowiseIgnoreJidSchema","IgnoreJidDto","ChatbotRouter","guards","Router","EvolutionBotRouter","ChatwootRouter","TypebotRouter","OpenaiRouter","DifyRouter","FlowiseRouter","Router","PusherRouter","RouterBroker","guards","req","res","response","pusherSchema","EventDto","instance","data","eventManager","instanceSchema","InstanceDto","Router","RabbitmqRouter","RouterBroker","guards","req","res","response","eventSchema","EventDto","instance","data","eventManager","instanceSchema","InstanceDto","Router","SqsRouter","RouterBroker","guards","req","res","response","eventSchema","EventDto","instance","data","eventManager","instanceSchema","InstanceDto","Router","WebhookRouter","RouterBroker","configService","guards","req","res","response","webhookSchema","EventDto","instance","data","eventManager","instanceSchema","InstanceDto","Router","WebsocketRouter","RouterBroker","guards","req","res","response","eventSchema","EventDto","instance","data","eventManager","instanceSchema","InstanceDto","Router","EventRouter","configService","guards","WebhookRouter","WebsocketRouter","RabbitmqRouter","PusherRouter","SqsRouter","Router","StorageRouter","guards","S3Router","Router","fs","mimeTypes","path","Metadata","OfferCallDto","Router","CallRouter","RouterBroker","guards","Router","req","res","response","offerCallSchema","OfferCallDto","instance","data","callController","Router","ChatRouter","RouterBroker","guards","Router","req","res","response","whatsappNumberSchema","WhatsAppNumberDto","instance","data","chatController","readMessageSchema","ReadMessageDto","archiveChatSchema","ArchiveChatDto","markChatUnreadSchema","MarkChatUnreadDto","deleteMessageSchema","DeleteMessage","profilePictureSchema","NumberDto","getBase64FromMediaMessageDto","updateMessageSchema","UpdateMessageDto","presenceSchema","SendPresenceDto","blockUserSchema","BlockUserDto","contactValidateSchema","Query","messageValidateSchema","messageUpSchema","ProfilePictureDto","profileSchema","profileNameSchema","ProfileNameDto","profileStatusSchema","ProfileStatusDto","InstanceDto","privacySettingsSchema","PrivacySettingDto","CreateGroupDto","GroupPictureDto","GroupSubjectDto","GroupDescriptionDto","GroupJid","GetParticipant","GroupInvite","AcceptGroupInvite","GroupSendInvite","GroupUpdateParticipantDto","GroupUpdateSettingDto","GroupToggleEphemeralDto","Router","GroupRouter","RouterBroker","guards","Router","req","res","response","createGroupSchema","CreateGroupDto","instance","data","groupController","updateGroupSubjectSchema","GroupSubjectDto","updateGroupPictureSchema","GroupPictureDto","updateGroupDescriptionSchema","GroupDescriptionDto","groupJidSchema","GroupJid","getParticipantsSchema","GetParticipant","groupInviteSchema","GroupInvite","AcceptGroupInviteSchema","AcceptGroupInvite","groupSendInviteSchema","GroupSendInvite","updateParticipantsSchema","GroupUpdateParticipantDto","updateSettingsSchema","GroupUpdateSettingDto","toggleEphemeralSchema","GroupToggleEphemeralDto","Router","InstanceRouter","RouterBroker","configService","guards","Router","req","res","response","instanceSchema","InstanceDto","instance","instanceController","key","presenceOnlySchema","SetPresenceDto","data","LabelDto","HandleLabelDto","Router","LabelRouter","RouterBroker","guards","Router","req","res","response","LabelDto","instance","labelController","handleLabelSchema","HandleLabelDto","data","ProxyDto","Router","ProxyRouter","RouterBroker","guards","Router","req","res","response","proxySchema","ProxyDto","instance","data","proxyController","instanceSchema","InstanceDto","Metadata","SendTextDto","SendStatusDto","Metadata","SendPollDto","SendMediaDto","SendPtvDto","SendStickerDto","SendButtonsDto","Metadata","SendLocationDto","SendListDto","Metadata","SendTemplateDto","Metadata","SendContactDto","SendReactionDto","Router","multer","upload","multer","MessageRouter","RouterBroker","guards","Router","req","res","response","templateMessageSchema","SendTemplateDto","instance","data","sendMessageController","textMessageSchema","SendTextDto","bodyData","mediaMessageSchema","SendMediaDto","ptvMessageSchema","SendPtvDto","audioMessageSchema","statusMessageSchema","SendStatusDto","stickerMessageSchema","SendStickerDto","locationMessageSchema","SendLocationDto","contactMessageSchema","SendContactDto","reactionMessageSchema","SendReactionDto","pollMessageSchema","SendPollDto","listMessageSchema","SendListDto","buttonsMessageSchema","SendButtonsDto","SettingsDto","Router","SettingsRouter","RouterBroker","guards","Router","req","res","response","settingsSchema","SettingsDto","instance","data","settingsController","InstanceDto","TemplateDto","Router","TemplateRouter","RouterBroker","configService","guards","Router","req","res","response","templateSchema","TemplateDto","instance","data","templateController","instanceSchema","InstanceDto","express","Router","path","ViewsRouter","RouterBroker","basePath","indexPath","req","res","router","Router","serverConfig","configService","guards","instanceExistsGuard","instanceLoggedGuard","authGuard","telemetry","telemetry_guard_default","packageJson","fs","ViewsRouter","req","res","fileName","basePath","path","filePath","mimeTypes","next","InstanceRouter","MessageRouter","CallRouter","ChatRouter","GroupRouter","TemplateRouter","SettingsRouter","ProxyRouter","LabelRouter","ChannelRouter","EventRouter","ChatbotRouter","StorageRouter","BadRequestException","objectError","UnauthorizedException","objectError","ForbiddenException","objectError","NotFoundException","objectError","InternalServerErrorException","objectError","validate","logger","Logger","RouterBroker","path","param","route","args","request","schema","ClassRef","execute","ref","body","instance","v","message","stack","BadRequestException","property","groupJid","inviteCode","getParticipants","MediaDto","isNotEmpty","propertyNames","properties","property","s3Schema","v4_default","s3UrlSchema","Router","S3Router","RouterBroker","guards","req","res","response","s3Schema","MediaDto","instance","data","s3Controller","s3UrlSchema"]}